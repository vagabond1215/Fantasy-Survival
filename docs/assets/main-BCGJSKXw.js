import{g as Mr,a as Yd,b as Ia,c as Xd}from"./biomeWildlife-mBoYh2ch.js";const el="survey";function Gd(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;if(e instanceof Date){const t=e.getTime();return Number.isFinite(t)?t:null}if(typeof e=="string"&&e.trim()){const t=Date.parse(e);return Number.isFinite(t)?t:null}return null}function Da(e,t){const n=t&&typeof t=="object"?t:{},r=e||n.id?String(e||n.id):null;if(!r)return null;const o=n.unlocked===!0||n.status==="unlocked"||!("unlocked"in n)&&!!(n.discovered||n.name),i=n.discovered===!0||o,a=Number.isFinite(n.progress)?Math.min(1,Math.max(0,n.progress)):o?1:0,d=n.label||n.name||r,l=Gd(n.unlockedAt??n.completedAt??null),c=typeof n.notes=="string"&&n.notes.trim()?n.notes:null;return{id:r,unlocked:o,discovered:i,progress:a,unlockedAt:l,label:d,notes:c}}function Br(e){return e?e instanceof Map?[...e.entries()]:Array.isArray(e)?e:typeof e=="object"?Object.entries(e):[]:[]}class Vd{constructor(){this.buildings=new Map,this.people=new Map,this.inventory=new Map,this.craftTargets=new Map,this.locations=new Map,this.technologies=new Map,this.proficiencies=new Map,this.player={locationId:null,x:0,y:0,jobId:el},this.time={day:1,month:1,year:410,hour:6,season:"Thawbound",weather:"Clear"},this.difficulty="normal",this.jobs={},this.orders=[],this.eventLog=[],this.orderSeq=0,this.unlockedBuildings=new Set,this.research=new Set,this.buildingSeq=0,this.gatherNodes=new Map,this.discoveredFauna=new Map,this.discoveredFlora=new Map,this.jobSettings={},this.jobDaily={},this.buildQueue=0,this.haulQueue=0,this.worldSettings=null}addItem(t,n){const r=n.id;if(!r){console.warn(`Missing id for ${t} item`,n);return}this[t].has(r)?console.warn(`Duplicate ${t} id ${r} ignored.`):this[t].set(r,n)}updateItem(t,n){const r=n.id;if(this[t].has(r)){const o=this[t].get(r);this[t].set(r,{...o,...n})}else console.warn(`Cannot update missing ${t} id ${r}.`)}getItem(t,n){return this[t].get(n)}serialize(){const t=[...this.technologies.entries()].map(([n,r])=>{const o=Da(n,r);return o?[o.id,o]:null}).filter(Boolean);return{buildings:[...this.buildings.entries()],people:[...this.people.entries()],inventory:[...this.inventory.entries()],craftTargets:[...this.craftTargets.entries()],locations:[...this.locations.entries()],technologies:t,proficiencies:[...this.proficiencies.entries()],player:{...this.player},time:this.time,difficulty:this.difficulty,jobs:this.jobs,orders:this.orders,eventLog:this.eventLog,orderSeq:this.orderSeq,unlockedBuildings:[...this.unlockedBuildings],research:[...this.research],buildingSeq:this.buildingSeq,gatherNodes:[...this.gatherNodes.entries()],discoveredFauna:[...this.discoveredFauna.entries()].map(([n,r])=>[n,[...r]]),discoveredFlora:[...this.discoveredFlora.entries()].map(([n,r])=>[n,[...r]]),jobSettings:this.jobSettings,jobDaily:this.jobDaily,worldSettings:this.worldSettings}}deserialize(t){this.buildings=new Map(Br(t.buildings)),this.people=new Map(Br(t.people)),this.inventory=new Map(Br(t.inventory)),this.craftTargets=new Map(Br(t.craftTargets)),this.locations=new Map(Br(t.locations));const r=(Array.isArray(t.technologies)?t.technologies:t.technologies&&typeof t.technologies=="object"?Object.entries(t.technologies):[]).map(l=>{if(Array.isArray(l)&&l.length>=2){const c=Da(l[0],l[1]);return c?[c.id,c]:null}if(l&&typeof l=="object"){const c=Da(l.id,l);return c?[c.id,c]:null}return null}).filter(Boolean);this.technologies=new Map(r),this.proficiencies=new Map(Br(t.proficiencies));const o=t.player||{};this.player={locationId:o.locationId??null,x:Number.isFinite(o.x)?Math.trunc(o.x):0,y:Number.isFinite(o.y)?Math.trunc(o.y):0,jobId:typeof o.jobId=="string"&&o.jobId?o.jobId:el};const i=t.time||{};this.time={day:1,month:1,year:410,hour:6,season:"Thawbound",weather:"Clear",...i},this.difficulty=t.difficulty||"normal",this.jobs=t.jobs||{},this.orders=t.orders||[],this.eventLog=t.eventLog||[],this.orderSeq=t.orderSeq||0,this.unlockedBuildings=new Set(t.unlockedBuildings||[]),this.research=new Set(t.research||[]),this.buildingSeq=t.buildingSeq||0,this.gatherNodes=new Map(Br(t.gatherNodes)),this.jobSettings=t.jobSettings||{},this.jobDaily=t.jobDaily||{},this.worldSettings=t.worldSettings||null;const a=Array.isArray(t.discoveredFauna)?t.discoveredFauna:Object.entries(t.discoveredFauna||{});this.discoveredFauna=new Map(a.map(l=>{const[c,f]=l||[];return[c,new Set(f||[])]}));const d=Array.isArray(t.discoveredFlora)?t.discoveredFlora:Object.entries(t.discoveredFlora||{});this.discoveredFlora=new Map(d.map(l=>{const[c,f]=l||[];return[c,new Set(f||[])]}))}}const Kd="WORLD_CONFIG_CHANGED",_t={biome:null,season:null,seed:null,difficulty:null,worldParameters:null},Ja=new Set;function ic(e){if(!e||typeof e!="object")return null;const{advanced:t,...n}=e;return{...n,advanced:t&&typeof t=="object"?{...t}:t??null}}function Zd(e,t){if(e===t)return!0;if(!e||!t)return!e&&!t;const n=new Set([...Object.keys(e),...Object.keys(t)]);for(const a of n)if(a!=="advanced"&&(e[a]??null)!==(t[a]??null))return!1;const r=e.advanced&&typeof e.advanced=="object"?e.advanced:{},o=t.advanced&&typeof t.advanced=="object"?t.advanced:{},i=new Set([...Object.keys(r),...Object.keys(o)]);for(const a of i)if((r[a]??null)!==(o[a]??null))return!1;return!0}function Mo(){return{biome:_t.biome,season:_t.season,seed:_t.seed,difficulty:_t.difficulty,worldParameters:_t.worldParameters?ic(_t.worldParameters):null}}function Jd(){const e=Mo();Ja.forEach(t=>{try{t(e)}catch(n){console.error("Error in world config listener",n)}}),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent(Kd,{detail:e}))}function Qd(e,t={}){if(typeof e!="function")return()=>{};if(Ja.add(e),t!=null&&t.immediate)try{e(Mo())}catch(n){console.error("Error in immediate world config listener",n)}return()=>Ja.delete(e)}function qn(e={},t={}){if(!e||typeof e!="object")return Mo();const{silent:n=!1,force:r=!1}=t;let o=!1;if("biome"in e&&e.biome!==_t.biome&&(_t.biome=e.biome??null,o=!0),"season"in e&&e.season!==_t.season&&(_t.season=e.season??null,o=!0),"seed"in e&&e.seed!==_t.seed&&(_t.seed=e.seed??null,o=!0),"difficulty"in e&&e.difficulty!==_t.difficulty&&(_t.difficulty=e.difficulty??null,o=!0),"worldParameters"in e){const i=e.worldParameters?ic(e.worldParameters):null;Zd(_t.worldParameters,i)||(_t.worldParameters=i,o=!0)}return(o||r)&&!n&&Jd(),Mo()}const C=new Vd,eu={primitive:"Primitive",bronze:"Bronze",iron:"Iron",steel:"Steel"};function tl(e=""){return String(e).split(/[^a-zA-Z0-9]+/).filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function tu(e){return Array.isArray(e)?e.map(t=>{if(!t)return null;if(typeof t=="string")return{item:t,quantity:1};if(typeof t=="object"){const n=t.item||t.id||t.name;if(!n)return null;const r=Number.isFinite(t.quantity)&&t.quantity>0?t.quantity:1;return{item:String(n),quantity:r}}return null}).filter(Boolean):[]}function jt(e){if(!e||!e.id)throw new Error("Equipment entries must include an id.");const t=e.tier||"primitive",n=e.label||e.name||tl(e.id),r=e.tierLabel||eu[t]||tl(t);return Object.freeze({id:String(e.id),label:n,category:e.category||"tool",role:e.role||e.type||null,tier:t,tierLabel:r,icon:e.icon||"🎒",stats:e.stats||{},materials:tu(e.materials),durability:Number.isFinite(e.durability)?Math.max(1,Math.round(e.durability)):null,requiredTech:e.requiredTech||null})}const ys=[jt({id:"stone knife",label:"Stone Knife",category:"weapon",role:"blade",tier:"primitive",icon:"🔪",stats:{damage:3,utility:2},materials:["sharpened stone","cord","straight branch"],durability:25,requiredTech:"basic-tools"}),jt({id:"wooden hammer",label:"Wooden Hammer",category:"tool",role:"hammer",tier:"primitive",icon:"🔨",stats:{damage:1,utility:3},materials:["seasoned wood","cord"],durability:40,requiredTech:"basic-tools"}),jt({id:"stone hand axe",label:"Stone Hand Axe",category:"tool",role:"axe",tier:"primitive",icon:"🪓",stats:{damage:4,utility:3},materials:["sturdy haft stick","cord","sharpened stone"],durability:45,requiredTech:"basic-tools"}),jt({id:"stone pick",label:"Stone Pick",category:"tool",role:"pick",tier:"primitive",icon:"⛏️",stats:{damage:3,utility:4},materials:["sturdy haft stick","cord","sharpened stone"],durability:40,requiredTech:"basic-tools"}),jt({id:"bow",label:"Self Bow",category:"weapon",role:"bow",tier:"primitive",icon:"🏹",stats:{damage:5},materials:["seasoned wood","cord","plant fibers"],durability:55,requiredTech:"basic-tools"}),jt({id:"wooden arrow",label:"Wooden Arrows",category:"weapon",role:"ammunition",tier:"primitive",icon:"🪶",stats:{damage:2},materials:["straight branch","stone knife","plant fibers"],durability:5,requiredTech:"basic-tools"}),jt({id:"leather armor",label:"Leather Armor",category:"armor",role:"light-armor",tier:"primitive",icon:"🥋",stats:{protection:4},materials:["prepared hides","cord"],durability:65,requiredTech:"basic-tools"}),jt({id:"bronze axe",label:"Bronze Axe",category:"tool",role:"axe",tier:"bronze",icon:"🪓",stats:{damage:6,utility:5},materials:[{item:"bronze ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:70,requiredTech:"bronze-smithing"}),jt({id:"bronze pick",label:"Bronze Pick",category:"tool",role:"pick",tier:"bronze",icon:"⛏️",stats:{damage:5,utility:6},materials:[{item:"bronze ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:75,requiredTech:"bronze-smithing"}),jt({id:"bronze scale armor",label:"Bronze Scale Armor",category:"armor",role:"medium-armor",tier:"bronze",icon:"🛡️",stats:{protection:7},materials:[{item:"bronze ingot",quantity:3},{item:"prepared hides",quantity:2},{item:"cord",quantity:1}],durability:90,requiredTech:"bronze-smithing"}),jt({id:"iron axe",label:"Iron Axe",category:"tool",role:"axe",tier:"iron",icon:"🪓",stats:{damage:7,utility:7},materials:[{item:"iron ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:90,requiredTech:"iron-smithing"}),jt({id:"iron pick",label:"Iron Pick",category:"tool",role:"pick",tier:"iron",icon:"⛏️",stats:{damage:6,utility:8},materials:[{item:"iron ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:95,requiredTech:"iron-smithing"}),jt({id:"iron chainmail",label:"Iron Chainmail",category:"armor",role:"medium-armor",tier:"iron",icon:"🛡️",stats:{protection:10},materials:[{item:"iron ingot",quantity:4},{item:"prepared hides",quantity:2}],durability:120,requiredTech:"iron-smithing"}),jt({id:"steel axe",label:"Steel Axe",category:"tool",role:"axe",tier:"steel",icon:"🪓",stats:{damage:8,utility:9},materials:[{item:"steel ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:110,requiredTech:"steel-smithing"}),jt({id:"steel pick",label:"Steel Pick",category:"tool",role:"pick",tier:"steel",icon:"⛏️",stats:{damage:7,utility:10},materials:[{item:"steel ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:115,requiredTech:"steel-smithing"}),jt({id:"steel plate",label:"Steel Plate Armor",category:"armor",role:"heavy-armor",tier:"steel",icon:"🛡️",stats:{protection:14},materials:[{item:"steel ingot",quantity:5},{item:"leather armor",quantity:1}],durability:160,requiredTech:"steel-smithing"})],nu=new Map(ys.map(e=>[e.id,e]));function ru(e={}){const{category:t,tier:n}=e||{};return ys.filter(r=>!(t&&r.category!==t||n&&r.tier!==n))}function wa(e){return e&&nu.get(String(e))||null}Object.freeze(Array.from(new Set(ys.map(e=>e.tier))));function Qa(e=""){return String(e).split(/\s+/).filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function ac(e){const t=String(e);return{id:t,label:Qa(t),quantity:0,demand:0,supply:0,expectedChange:0,isEquipment:!1,category:"resource",tier:null,tierLabel:null,quality:null,qualityLabel:null,durability:null,stats:null,requiredTech:null}}function ti(e){if(!e)return e;const t=wa(e.id),n={...e};return t?(n.label=t.label||n.label||Qa(n.id),n.isEquipment=!0,n.category=t.category||"equipment",n.tier=t.tier||null,n.tierLabel=t.tierLabel||null,n.quality=t.tier||null,n.qualityLabel=t.tierLabel||null,n.durability=t.durability??n.durability??null,n.stats=t.stats||n.stats||null,n.requiredTech=t.requiredTech||n.requiredTech||null):(n.label=n.label||Qa(n.id),n.isEquipment=!1,n.category="resource",n.tier=null,n.tierLabel=null,n.quality=null,n.qualityLabel=null,n.durability=null,n.stats=null,n.requiredTech=null),n}function sc(e){const t=C.getItem("inventory",e.id);t?C.updateItem("inventory",{...t,...e}):C.addItem("inventory",e)}function lc(e){const t=C.getItem("inventory",e);return ti(t?{...t}:ac(e))}function cc(e){const t=Number.isFinite(e.supply)?e.supply:0,n=Number.isFinite(e.demand)?e.demand:0;e.expectedChange=Math.round((t-n)*100)/100,e.supply=t,e.demand=n}function Qi(e,t=0){const n=lc(e);n.quantity=Math.max(0,(n.quantity||0)+t),cc(n),sc(n)}function oi(e){const t=C.getItem("inventory",e);return ti(t?{...t}:ac(e))}function ou(e,{supply:t=0,demand:n=0}={}){const r=lc(e);r.supply=t,r.demand=n,cc(r),sc(r)}function dc(){return Array.from(C.inventory.values()).map(e=>ti({...e}))}const uc=[{id:"basic-tools",name:"Basic Tools",category:"Woodworking",order:10,description:"Stone and bone implements along with cordage techniques that let settlers work timber and hides reliably.",prerequisites:[],cost:{research:25,materials:{"plant fibers":12,cord:6,"sharpened stone":4}},effects:{description:"Unlocks foundational woodworking structures, recipes, and primitive gear.",unlocks:{buildings:["drying-rack","hunter-blind","workshop","smokehouse","longhouse","watchtower"],recipes:["cord","sharpened-stone","prepared-hides","seasoned-wood","rendered-tallow","grain-flour","hearty-stew","traveler-flatbread","herbal-porridge","smoke-cured-provisions","pickled-vegetables","aromatic-sachets","herbal-poultice","restorative-tonic","soothing-salve","arrow-bundle","stone-hand-axe","stone-pick"],equipment:["stone knife","wooden hammer","stone hand axe","stone pick","bow","wooden arrow","leather armor"],technologies:[]}}},{id:"metalworking-basics",name:"Metalworking Basics",category:"Metalworking",order:20,description:"Clay forges, bellows, and charcoal production that allow smiths to shape soft metals.",prerequisites:["basic-tools"],cost:{research:80,materials:{charcoal:12,clay:10,"crafted goods":4}},effects:{description:"Opens the path toward bronze alloys and improved forging stations.",unlocks:{technologies:["bronze-smithing"],recipes:[],buildings:[],equipment:[]}}},{id:"bronze-smithing",name:"Bronze Smithing",category:"Metalworking",order:30,description:"Copper and tin alloys hammered into resilient edges and scales.",prerequisites:["metalworking-basics"],cost:{research:120,materials:{"bronze ingot":4,charcoal:8}},effects:{description:"Enables bronze tools, armor, and the knowledge required to tackle harder metals.",unlocks:{technologies:["iron-smithing"],recipes:["bronze-ingot","bronze-axe","bronze-pick"],buildings:[],equipment:["bronze axe","bronze pick","bronze scale armor"]}}},{id:"iron-smithing",name:"Iron Smithing",category:"Metalworking",order:40,description:"Bloom refining, quenching, and tempering techniques for wrought iron.",prerequisites:["bronze-smithing"],cost:{research:160,materials:{"iron ingot":4,charcoal:12}},effects:{description:"Unlocks ironwork recipes and arms the settlement with tougher implements.",unlocks:{technologies:["steel-smithing"],recipes:["iron-ingot","iron-axe","iron-pick"],buildings:[],equipment:["iron axe","iron pick","iron chainmail"]}}},{id:"steel-smithing",name:"Steel Smithing",category:"Metalworking",order:50,description:"High-heat furnaces, folding, and oil quenching that create elite steel arms and armor.",prerequisites:["iron-smithing"],cost:{research:220,materials:{"steel ingot":4,charcoal:16}},effects:{description:"Completes the smithing ladder with access to superior weapons and armor.",unlocks:{technologies:[],recipes:["steel-ingot","steel-axe","steel-pick"],buildings:[],equipment:["steel axe","steel pick","steel plate"]}}},{id:"defense-drills",name:"Defense Drills",category:"Fortifications",order:60,description:"Coordinated watches, signal calls, and militia routines to hold the palisade.",prerequisites:["basic-tools"],cost:{research:100,materials:{"crafted goods":6,firewood:40}},effects:{description:"Strengthens vigilance and readies the village for broader alliances.",unlocks:{technologies:["regional-alliance"],recipes:[],buildings:[],equipment:[]}}},{id:"regional-alliance",name:"Regional Alliance",category:"Fortifications",order:70,description:"Treaties, signal braziers, and trade obligations with neighboring strongholds.",prerequisites:["defense-drills"],cost:{research:180,materials:{"crafted goods":8,preservedFood:20}},effects:{description:"Broadens diplomacy, bringing aid and prestige to the settlement.",unlocks:{technologies:[],recipes:[],buildings:[],equipment:[]}}}];function iu(){return uc.map(e=>({...e}))}function au(e){if(!e&&e!==0)return null;const t=String(e);return uc.find(n=>n.id===t)||null}const Yr=new Map;let nl=!1;function fc(){const e=C.technologies;return e instanceof Map?e:Array.isArray(e)?(C.technologies=new Map(e),C.technologies):e&&typeof e=="object"?(C.technologies=new Map(Object.entries(e)),C.technologies):(C.technologies=new Map,C.technologies)}function pc(e){return!Number.isFinite(e)||e<=0?0:e>=1?1:e}function mc(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;if(e instanceof Date){const t=e.getTime();return Number.isFinite(t)?t:null}if(typeof e=="string"&&e.trim()){const t=Date.parse(e);return Number.isFinite(t)?t:null}return null}function ws(e){var a,d;if(!(e!=null&&e.id))return null;const t=String(e.id);if(Yr.has(t))return Yr.get(t);const n=Array.isArray(e.prerequisites)?e.prerequisites.filter(Boolean).map(l=>String(l)):[],r=e.cost?{research:Number.isFinite(e.cost.research)?Math.max(0,e.cost.research):null,materials:e.cost.materials?{...e.cost.materials}:{}}:null,o=((a=e.effects)==null?void 0:a.unlocks)||{},i={id:t,name:e.name||t,category:e.category||null,description:e.description||"",order:Number.isFinite(e.order)?e.order:0,prerequisites:n,cost:r,effects:{description:((d=e.effects)==null?void 0:d.description)||"",unlocks:{technologies:Array.isArray(o.technologies)?o.technologies.map(l=>String(l)):[],recipes:Array.isArray(o.recipes)?o.recipes.map(l=>String(l)):[],buildings:Array.isArray(o.buildings)?o.buildings.map(l=>String(l)):[],equipment:Array.isArray(o.equipment)?o.equipment.map(l=>String(l)):[]}}};return Yr.set(t,i),i}function xs(e,t={}){const n=t&&typeof t=="object"?t:{},r=n.unlocked===!0,o=n.discovered===!0||r,i=pc(Number.isFinite(n.progress)?n.progress:r?1:0),a=typeof n.label=="string"&&n.label.trim()?n.label:typeof n.name=="string"&&n.name.trim()?n.name:e.name,d=mc(n.unlockedAt),l=typeof n.notes=="string"&&n.notes.trim()?n.notes:null;return{id:e.id,unlocked:r,discovered:o,progress:i,unlockedAt:d,label:a,notes:l}}function vs(e,t={}){const n=t&&typeof t=="object"?t:{},r=n.unlocked===!0||!("unlocked"in n)&&!!n.name,o=n.discovered===!0||r,i=pc(Number.isFinite(n.progress)?n.progress:r?1:0),a=typeof n.label=="string"&&n.label.trim()?n.label:typeof n.name=="string"&&n.name.trim()?n.name:String(e),d=mc(n.unlockedAt),l=typeof n.notes=="string"&&n.notes.trim()?n.notes:null;return{id:String(e),unlocked:r,discovered:o,progress:i,unlockedAt:d,label:a,notes:l}}function su(){const e=fc(),t=new Map;Yr.forEach(n=>{const r=e.get(n.id),o=xs(n,r||{id:n.id});t.set(n.id,o)}),e.forEach((n,r)=>{if(t.has(r))return;const o=vs(r,n||{id:r});t.set(r,o)}),e.clear(),t.forEach((n,r)=>{e.set(r,n)})}function Jr(){nl||(iu().forEach(e=>{ws(e)}),nl=!0),su()}function xa(e){if(!e&&e!==0)return null;const t=String(e);if(Yr.has(t))return Yr.get(t);const n=au(t);return n?ws(n):null}function va(e){const t=String(e),n=fc();if(!n.has(t)){const r=xa(t),o=r?xs(r,{}):vs(t,{id:t});n.set(t,o)}return n.get(t)}function hc(e,t={}){Jr();const n=typeof e=="string"||typeof e=="number"?e:e==null?void 0:e.id;if(!n&&n!==0)return null;const r=String(n),o=xa(r)||(typeof e=="object"?ws(e):null),i=va(r),a=Number.isFinite(t.unlockedAt)?t.unlockedAt:Date.now(),d={...i,...typeof e=="object"?e:{},id:r,unlocked:!0,discovered:!0,progress:1,unlockedAt:(i==null?void 0:i.unlockedAt)??a,label:typeof e=="object"&&(e==null?void 0:e.name)||(i==null?void 0:i.label)||(o==null?void 0:o.name)||r},l=o?xs(o,d):vs(r,d);return l.unlocked=!0,l.discovered=!0,l.progress=1,l.unlockedAt||(l.unlockedAt=a),C.technologies.set(r,l),l}function yn(e){if(!e&&e!==0)return!1;Jr();const t=va(e);return!!(t!=null&&t.unlocked)}function lu(e){if(!e&&e!==0)return null;Jr();const t=String(e),n=xa(t),r=va(t),o=(n==null?void 0:n.prerequisites)||[],i=o.filter(a=>!yn(a));return{id:t,definition:n||null,state:r,unlocked:!!(r!=null&&r.unlocked),discovered:!!(r!=null&&r.discovered),prerequisites:o,missingPrerequisites:i,available:!!(r&&!r.unlocked&&i.length===0)}}function cu(){Jr();const e=[];return Yr.forEach(t=>{const n=va(t.id),r=t.prerequisites.filter(o=>!yn(o));e.push({id:t.id,definition:t,state:n,unlocked:!!(n!=null&&n.unlocked),discovered:!!(n!=null&&n.discovered),available:!(n!=null&&n.unlocked)&&r.length===0,prerequisites:[...t.prerequisites],missingPrerequisites:r})}),e.sort((t,n)=>{const r=Number.isFinite(t.definition.order)?t.definition.order:0,o=Number.isFinite(n.definition.order)?n.definition.order:0;return r!==o?r-o:t.definition.name.localeCompare(n.definition.name)})}function ea(e){if(!e&&e!==0)return"";const t=String(e),n=xa(t);if(n!=null&&n.name)return n.name;const r=C.technologies instanceof Map?C.technologies.get(t):null;return r!=null&&r.label?r.label:t.split(/[-_]/).filter(Boolean).map(o=>o.charAt(0).toUpperCase()+o.slice(1)).join(" ")}Jr();const gc=Object.freeze(["open","grassland","plains","savanna","tundra","taiga","desert","sand","wetland","coast","temperate","tropical","rainforest","jungle","alpine"]),du=new Set(gc);function wr(e){return e?du.has(String(e).toLowerCase()):!1}function bc(e){if(!e)return"open";const t=typeof e.openTerrainId=="string"?e.openTerrainId.toLowerCase():"";return t&&wr(t)?t:"open"}function uu(e=[]){if(!Array.isArray(e)||!e.length)return e;const t=e.map(o=>String(o||"").toLowerCase());if(!t.includes("open"))return e;const n=gc.filter(o=>o!=="open"),r=new Set;return t.forEach(o=>{o&&o!=="open"&&r.add(o)}),n.forEach(o=>r.add(o)),r.add("open"),Array.from(r)}const fu=[{id:"lean-to",name:"Lean-to Shelter",icon:"⛺",category:"Shelter",description:"A quick shelter made from flexible saplings and a sloped roof. Offers basic protection from the elements.",allowMultiple:!0,unlock:{always:!0},requirements:{minBuilders:1,locationTags:["forest","grove"],site:{category:"forest",dimensions:{width:3.6,depth:2.1},accessClearance:{front:2.4,back:.6,left:.6,right:.6}},craftedGoods:{cord:8}},effects:{occupancy:2,comfort:1,survivability:1,demand:{firewood:-.1}},components:[{id:"foundation",name:"Ground Preparation",description:"Clear debris and level the sleeping surface, laying a base of small stones for drainage.",laborHours:4,minBuilders:1,resources:{"small stones":12,pebbles:20}},{id:"main-supports",name:"Ridge Frame & Lashings",description:"Raise forked poles and lash the ridge beam that anchors the shelter.",laborHours:6,minBuilders:1,isCore:!0,resources:{firewood:28,"plant fibers":12,cord:4}},{id:"roof",name:"Weather Shed Cover",description:"Lay overlapping boughs down the leeward slope and extend a front overhang for access.",laborHours:5,minBuilders:1,resources:{firewood:18,"plant fibers":16,cord:4}}],addons:[{id:"windbreak",name:"Windbreak Walls",description:"Add woven branch walls to shield against prevailing winds.",effects:{comfort:1,demand:{firewood:-.05}},laborHours:3,minBuilders:1,resources:{firewood:12,"plant fibers":8,cord:2}},{id:"raised-bed",name:"Raised Sleeping Platform",description:"Lift sleepers off damp ground using a lashed frame.",effects:{comfort:1},laborHours:4,minBuilders:1,resources:{firewood:10,"plant fibers":6,cord:2,"crafted goods":1}}]},{id:"crop-field",name:"Tended Crop Field",icon:"🌾",category:"Agriculture",description:"Tilled plots bordered by windbreaks and irrigation furrows that turn open ground into dependable harvests.",allowMultiple:!0,unlock:{buildings:[{id:"fire-pit",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["meadow","grassland","open"],site:{category:"cleared",dimensions:{width:12,depth:18},accessClearance:{front:3,back:2,left:2,right:2}},craftedGoods:{cord:18,"crafted goods":4}},effects:{supply:{grain:6,"root vegetables":4,herbs:1},demand:{"crafted goods":.6},jobs:{farm:3}},components:[{id:"clearing",name:"Brush Clearing & Stumping",description:"Pull stones, roots, and brush then mound field borders against erosion.",laborHours:10,minBuilders:3,isCore:!0,resources:{firewood:80,"small stones":40,pebbles:60,"plant fibers":24,cord:8}},{id:"furrows",name:"Tilling & Furrows",description:"Turn the topsoil, lay drainage trenches, and stake crop rows.",laborHours:9,minBuilders:2,resources:{firewood:36,pebbles:30,"plant fibers":20,cord:6,"crafted goods":2}},{id:"irrigation",name:"Irrigation Channels",description:"Line feeder ditches with stone and wattle spillways for steady watering.",laborHours:8,minBuilders:2,resources:{"small stones":50,pebbles:70,firewood:24,"plant fibers":18,cord:4}},{id:"windbreaks",name:"Windbreak Fencing",description:"Plant woven hurdles and saplings along the prevailing wind edge.",laborHours:6,minBuilders:2,resources:{firewood:48,"plant fibers":22,cord:6}}],addons:[{id:"seed-house",name:"Seed Shelter",description:"Add a small covered bin to keep seed stores dry and pest free.",effects:{storage:{grain:80,seeds:40}},laborHours:4,minBuilders:1,resources:{firewood:24,"small stones":20,"plant fibers":12,cord:4,"crafted goods":1}}]},{id:"animal-pen",name:"Timber Animal Pen",icon:"🐑",category:"Agriculture",description:"Fenced paddock with troughs and lean-tos for managing herds or work beasts.",allowMultiple:!0,unlock:{buildings:[{id:"crop-field",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["meadow","grassland","open"],site:{category:"cleared",dimensions:{width:10,depth:14},accessClearance:{front:3,back:2,left:2,right:2}},craftedGoods:{cord:22,"crafted goods":3}},effects:{supply:{food:3,hides:.8,"animal fat":.4},demand:{grain:1.5,water:2},jobs:{herd:2}},components:[{id:"postholes",name:"Postholes & Stone Footings",description:"Auger postholes and tamp stone collars to keep the fence upright.",laborHours:8,minBuilders:3,isCore:!0,resources:{"small stones":60,pebbles:70,firewood:40,"plant fibers":16,cord:6}},{id:"fencing",name:"Woven Fencing",description:"Weave rails and saplings into tight hurdles and double gates.",laborHours:9,minBuilders:2,resources:{firewood:96,"plant fibers":40,cord:12}},{id:"shelters",name:"Lean-to Shelters",description:"Raise timber sheds with thatched roofs for sick bays and shade.",laborHours:7,minBuilders:2,resources:{firewood:84,"plant fibers":32,cord:10,"crafted goods":2}},{id:"watering",name:"Troughs & Drainage",description:"Carve log troughs, stone the muddiest ground, and drain wallows.",laborHours:5,minBuilders:1,resources:{firewood:24,"small stones":30,pebbles:40,"crafted goods":1}}],addons:[{id:"milking-bay",name:"Milking Bay",description:"Build a narrow chute and stanchions for safer milking.",effects:{supply:{food:1,milk:1}},laborHours:4,minBuilders:1,resources:{firewood:28,"plant fibers":14,cord:4,"crafted goods":1}}]},{id:"granary",name:"Raised Granary",icon:"🏚️",category:"Storage",description:"Elevated grain house with ventilation floors that guards stores from damp and vermin.",allowMultiple:!0,unlock:{buildings:[{id:"crop-field",count:2}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["meadow","hill","open"],site:{category:"cleared",dimensions:{width:6,depth:8},accessClearance:{front:2.5,back:2,left:2,right:2}},craftedGoods:{cord:20,"crafted goods":5}},effects:{survivability:2,demand:{"crafted goods":.3},storage:{grain:400,food:120,seeds:80}},components:[{id:"footings",name:"Stone Piers",description:"Set squat stone pillars and pad stones to lift the floor clear of pests.",laborHours:7,minBuilders:3,isCore:!0,resources:{"small stones":90,pebbles:100,"crafted goods":1}},{id:"floor",name:"Slatted Subfloor",description:"Lay tight slats and woven reed mats that breathe without spilling grain.",laborHours:6,minBuilders:2,resources:{firewood:70,"plant fibers":34,cord:10,"crafted goods":2}},{id:"walls",name:"Boarded Walls",description:"Raise plank walls with rat guards and shingled ventilation shutters.",laborHours:7,minBuilders:2,resources:{firewood:90,"plant fibers":28,cord:8,"crafted goods":1}},{id:"roof",name:"Steep Thatch Roof",description:"Build a steep pitch roof and ridge vent to shed rain and heat.",laborHours:6,minBuilders:2,resources:{firewood:60,"plant fibers":40,cord:8}}],addons:[{id:"drying-floor",name:"Drying Loft",description:"Suspend removable lattice floors for drying herbs and seed heads.",effects:{supply:{preservedFood:1},storage:{herbs:60}},laborHours:4,minBuilders:1,resources:{firewood:32,"plant fibers":18,cord:4}}]},{id:"fire-pit",name:"Stone Fire Pit",icon:"🔥",category:"Utility",description:"Central hearth used for cooking and warmth. Concentrates heat and reduces smoke drift.",allowMultiple:!1,unlock:{always:!0},requirements:{minBuilders:1,locationTags:["forest","grove","meadow","open"],site:{categories:["forest","cleared"],dimensions:{width:1.8,depth:1.8},accessClearance:{front:1.8,back:1.8,left:1.8,right:1.8}},craftedGoods:{"crafted goods":2}},effects:{comfort:1,supply:{cookedMeals:1.5,"hearty meal":1,"bone broth":.5,"comfort meal":.5},demand:{food:-.5,grain:-.2,"root vegetables":-.2,salt:-.1,spices:-.05},survivability:1},components:[{id:"foundation",name:"Fire Ring Base",description:"Excavate a shallow basin and line it with gravel for drainage.",laborHours:3,minBuilders:1,isCore:!0,resources:{pebbles:30}},{id:"walls",name:"Stone Ring",description:"Stack fist-sized stones to contain the fire.",laborHours:4,minBuilders:1,resources:{"small stones":40}},{id:"fireplace",name:"Cooking Grate",description:"Fashion a simple grate for pots and skewers.",laborHours:2,minBuilders:1,resources:{"crafted goods":2}}],addons:[{id:"smoke-hood",name:"Smoke Hood",description:"Channel smoke upward using lashed poles and hides.",effects:{comfort:1},laborHours:3,minBuilders:1,resources:{firewood:12,"plant fibers":6,cord:2,hides:1}},{id:"stone-benches",name:"Stone Benches",description:"Arrange stone seats around the fire for gathering.",effects:{appeal:1},laborHours:2,minBuilders:1,resources:{"small stones":16}}]},{id:"drying-rack",name:"Drying Rack",icon:"🪵",category:"Production",description:"Elevated framework to dry hides, herbs, and meat, reducing spoilage.",allowMultiple:!0,unlock:{technologies:["basic-tools"]},requirements:{minBuilders:1,locationTags:["meadow","shore","open"],site:{category:"cleared",dimensions:{width:3,depth:1.8},accessClearance:{front:1.2,back:1.2,left:1,right:1}},craftedGoods:{cord:9,"crafted goods":1}},effects:{supply:{preservedFood:1,hides:.5,"smoked provisions":1,"preserved vegetables":.5,"herbal poultice":.3,"aromatic sachet":.2},demand:{food:-.2,salt:-.2,spices:-.1,herbs:-.1},capacity:{storage:40}},components:[{id:"stilts",name:"Support Stilts",description:"Set four sturdy posts to lift the rack clear of pests.",laborHours:4,minBuilders:1,isCore:!0,resources:{firewood:22,"plant fibers":8,cord:3}},{id:"crossbeams",name:"Crossbeams & Lashings",description:"Lash horizontal beams and lattice for hanging materials.",laborHours:5,minBuilders:1,resources:{firewood:16,"plant fibers":12,cord:4,"crafted goods":1}},{id:"roof",name:"Rain Cover",description:"Stretch hides or woven mats as a simple roof.",laborHours:3,minBuilders:1,resources:{hides:1,firewood:6,"plant fibers":10,cord:2}}],addons:[{id:"smoke-channel",name:"Smoke Channel",description:"Direct smoke from a nearby fire to improve preservation.",effects:{supply:{preservedFood:.5}},laborHours:2,minBuilders:1,resources:{firewood:8,"plant fibers":6,cord:2,"crafted goods":1}}]},{id:"hunter-blind",name:"Hunter's Blind",icon:"🏹",category:"Production",description:"Concealed elevated post to improve hunting success and safety.",allowMultiple:!0,unlock:{technologies:["basic-tools"],buildings:[{id:"lean-to",count:1}]},requirements:{minBuilders:2,locationTags:["forest"],site:{category:"forest",dimensions:{width:2.4,depth:2.4},accessClearance:{front:1.8,back:1.2,left:1.5,right:1.5}},craftedGoods:{cord:14,"crafted goods":2}},effects:{supply:{food:1.5,hides:.5},survivability:1,appeal:1},components:[{id:"foundation",name:"Footings & Bracing",description:"Drive support poles deep and brace against sway.",laborHours:6,minBuilders:2,isCore:!0,resources:{firewood:36,"small stones":12,"plant fibers":10,cord:4}},{id:"floor",name:"Platform Floor",description:"Lay planks and lashings to create a stable perch.",laborHours:5,minBuilders:2,resources:{firewood:24,"plant fibers":12,cord:4,"crafted goods":2}},{id:"walls",name:"Camouflaged Walls",description:"Weave brush and hides for concealment.",laborHours:4,minBuilders:1,resources:{hides:1,firewood:12,"plant fibers":14,cord:4}},{id:"roof",name:"Weatherproof Roof",description:"Slope the roof to shed rain and snow.",laborHours:3,minBuilders:1,resources:{firewood:10,"plant fibers":8,cord:2}}],addons:[{id:"ladder",name:"Reinforced Ladder",description:"Add a safer, sturdier ladder for quick access.",effects:{safety:1},laborHours:2,minBuilders:1,resources:{firewood:10,"plant fibers":6,cord:2}}]},{id:"workshop",name:"Crafter's Workshop",icon:"🛠️",category:"Production",description:"Covered workspace with benches and tool storage that boosts crafting output.",allowMultiple:!0,unlock:{buildings:[{id:"fire-pit",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["meadow","open"],site:{category:"cleared",dimensions:{width:6,depth:8},accessClearance:{front:2.5,back:2,left:1.5,right:1.5}},craftedGoods:{cord:16,"crafted goods":7}},effects:{supply:{"crafted goods":2},comfort:1,maxWorkers:2},components:[{id:"foundation",name:"Leveled Pad",description:"Lay compacted earth and stone to level the workspace.",laborHours:6,minBuilders:2,isCore:!0,resources:{"small stones":30,pebbles:40}},{id:"main-supports",name:"Timber Frame",description:"Raise sturdy posts and beams to support the roof.",laborHours:8,minBuilders:3,resources:{firewood:70,"plant fibers":24,cord:6,"crafted goods":4}},{id:"walls",name:"Half Walls & Storage",description:"Add waist-high walls with shelving and tool pegs.",laborHours:6,minBuilders:2,resources:{firewood:48,"plant fibers":20,cord:6,"crafted goods":3}},{id:"roof",name:"Shingled Roof",description:"Install a plank and bark roof to keep workers dry.",laborHours:7,minBuilders:2,resources:{firewood:36,"plant fibers":16,cord:4}}],addons:[{id:"forge",name:"Charcoal Forge",description:"Adds a clay-lined forge for metalworking research.",effects:{unlocks:["metalworking-basics"],supply:{"crafted goods":1}},laborHours:6,minBuilders:2,resources:{"small stones":24,firewood:36,"plant fibers":10,cord:4,"crafted goods":3}}]},{id:"cookhouse",name:"Communal Cookhouse",icon:"🍲",category:"Food Production",description:"Ventilated kitchen with racks, smoke flues, and work tables for preserving harvests at scale.",allowMultiple:!0,unlock:{buildings:[{id:"fire-pit",count:1},{id:"drying-rack",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["river","lake","shore","meadow","open"],site:{category:"cleared",dimensions:{width:6,depth:10},accessClearance:{front:3,back:2,left:2,right:2}},craftedGoods:{cord:26,"crafted goods":6}},effects:{supply:{cookedMeals:4,"hearty meal":2,"comfort meal":1,preservedFood:1},demand:{food:6,firewood:3,herbs:1,salt:.6,spices:.3},jobs:{cook:2}},components:[{id:"foundation",name:"Stone Hearth Floor",description:"Lay a mortared stone pad with drainage trenches to contain spills.",laborHours:8,minBuilders:3,isCore:!0,resources:{"small stones":120,pebbles:120,clay:30}},{id:"smokehall",name:"Smoke Hall Framing",description:"Raise stout posts and beams with smoke baffles and storage lofts.",laborHours:9,minBuilders:3,resources:{firewood:140,"plant fibers":48,cord:12,"crafted goods":3}},{id:"prep-benches",name:"Prep Benches & Racks",description:"Install butcher blocks, hanging hooks, and sloped drying racks.",laborHours:7,minBuilders:2,resources:{firewood:80,"plant fibers":26,cord:6,"crafted goods":2}},{id:"chimney",name:"Chimney & Ventilation",description:"Build a clay flue, smoke hoods, and shutters to control draft.",laborHours:6,minBuilders:2,resources:{clay:24,"small stones":60,pebbles:80,"crafted goods":2}}],addons:[{id:"cellar",name:"Cold Cellar",description:"Dig a root cellar with plank shelving beneath the cookhouse.",effects:{storage:{food:160,preservedFood:120},survivability:1},laborHours:6,minBuilders:2,resources:{"small stones":90,pebbles:100,firewood:40,"crafted goods":2}}]},{id:"smithy",name:"Charcoal Smithy",icon:"⚒️",category:"Production",description:"Forge house with bellows, anvils, and quenching troughs for shaping bronze and iron.",allowMultiple:!0,unlock:{buildings:[{id:"workshop",count:1}],technologies:["metalworking-basics"]},requirements:{minBuilders:4,locationTags:["stone","ore","cliff","ridge"],site:{category:"cleared",dimensions:{width:7,depth:9},accessClearance:{front:3,back:2.5,left:2,right:2}},craftedGoods:{cord:28,"crafted goods":8}},effects:{supply:{"crafted goods":3,"bronze ingot":1},demand:{"raw ore":2,charcoal:2,firewood:1},jobs:{smith:2},storage:{"raw ore":160,charcoal:120}},components:[{id:"foundation",name:"Stone Forge Pad",description:"Excavate and lay a heatproof stone slab with drainage and slag pit.",laborHours:9,minBuilders:4,isCore:!0,resources:{"small stones":140,pebbles:160,clay:40}},{id:"forge",name:"Forge & Chimney",description:"Brick a double forge, install tuyères, and build a high draft chimney.",laborHours:10,minBuilders:3,resources:{clay:60,"small stones":80,pebbles:120,charcoal:40,"crafted goods":4}},{id:"workbay",name:"Work Bays & Anvils",description:"Set heavy timbers, hanging racks, quench troughs, and tool chests.",laborHours:8,minBuilders:3,resources:{firewood:120,"plant fibers":36,cord:10,"crafted goods":4}},{id:"roof",name:"Ventilated Roof",description:"Raise a steep roof with smoke shutters and weatherproof shakes.",laborHours:7,minBuilders:2,resources:{firewood:90,"plant fibers":30,cord:8}}],addons:[{id:"bellows",name:"Twin Bellows",description:"Install counterweighted bellows and crank shafts for constant airflow.",effects:{supply:{"crafted goods":1}},laborHours:5,minBuilders:2,resources:{firewood:36,"plant fibers":18,cord:6,"crafted goods":2}}]},{id:"smokehouse",name:"Smokehouse",icon:"🍖",category:"Production",description:"Enclosed smoking hut that preserves large batches of meat and fish.",allowMultiple:!0,unlock:{buildings:[{id:"drying-rack",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["river","lake","shore","open"],site:{category:"cleared",dimensions:{width:4.2,depth:4.2},accessClearance:{front:3,back:1.5,left:1.5,right:1.5}},craftedGoods:{cord:15,"crafted goods":4}},effects:{supply:{preservedFood:4},demand:{food:-1,firewood:.5},comfort:1},components:[{id:"foundation",name:"Stone Footing",description:"Create a sealed stone base to contain smoke.",laborHours:8,minBuilders:3,isCore:!0,resources:{"small stones":60,pebbles:60}},{id:"walls",name:"Log Walls",description:"Stack logs and seal gaps with mud and moss.",laborHours:9,minBuilders:3,resources:{firewood:140,"plant fibers":30,cord:8}},{id:"roof",name:"Conical Vent Roof",description:"Construct a vented roof to draw smoke upward.",laborHours:7,minBuilders:2,resources:{firewood:46,"plant fibers":20,cord:4}},{id:"fireplace",name:"Fire Chamber & Racks",description:"Build a separate fire chamber and install hanging racks.",laborHours:6,minBuilders:2,resources:{firewood:24,"plant fibers":10,cord:3,"crafted goods":4}}],addons:[{id:"salt-bins",name:"Salt Storage Bins",description:"Add sealed bins for brining meats before smoking.",effects:{supply:{preservedFood:1},storage:{salt:50}},laborHours:4,minBuilders:1,resources:{firewood:16,"plant fibers":8,cord:2,"crafted goods":1}}]},{id:"longhouse",name:"Longhouse",icon:"🏠",category:"Shelter",description:"Large communal dwelling with raised bunks, central hearth, and smoke vents.",allowMultiple:!0,unlock:{buildings:[{id:"lean-to",count:2},{id:"fire-pit",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:4,locationTags:["meadow","open"],site:{category:"cleared",dimensions:{width:8,depth:24},accessClearance:{front:3,back:3,left:2.5,right:2.5}},craftedGoods:{cord:66,"crafted goods":13}},effects:{occupancy:12,comfort:3,survivability:2,demand:{firewood:-.5},maxWorkers:2},components:[{id:"foundation",name:"Raised Timber Floor",description:"Set heavy sills on stone footings to lift the structure.",laborHours:12,minBuilders:4,isCore:!0,resources:{firewood:200,"small stones":40,"plant fibers":40,cord:12}},{id:"main-supports",name:"Central Beams & Arches",description:"Erect tall arches and ridge poles for the expansive roof.",laborHours:14,minBuilders:4,resources:{firewood:240,"plant fibers":60,cord:16,"crafted goods":6}},{id:"walls",name:"Planked Walls & Doors",description:"Install plank walls, smoke shutters, and wide doors.",laborHours:12,minBuilders:3,resources:{firewood:180,"plant fibers":55,cord:14,"crafted goods":4}},{id:"roof",name:"Thatch & Beam Roof",description:"Layer thatch over beams with adjustable smoke vents.",laborHours:11,minBuilders:3,resources:{firewood:120,"plant fibers":80,cord:20,"crafted goods":3}},{id:"fireplace",name:"Central Hearths",description:"Construct two large hearths with stone surrounds.",laborHours:8,minBuilders:2,resources:{"small stones":80,pebbles:120,firewood:40,"plant fibers":10,cord:4}}],addons:[{id:"privacy-screens",name:"Privacy Screens",description:"Hang woven partitions for family spaces.",effects:{comfort:1,appeal:1},laborHours:4,minBuilders:1,resources:{firewood:24,"plant fibers":36,cord:10,"crafted goods":2}},{id:"insulated-roof",name:"Insulated Roof Layer",description:"Add moss and hides above the rafters to retain heat.",effects:{survivability:1,demand:{firewood:-.5}},laborHours:6,minBuilders:2,resources:{firewood:40,hides:3,"plant fibers":20,cord:6}}]},{id:"watchtower",name:"Watchtower",icon:"🛡️",category:"Defense",description:"Tall lookout tower providing advance warning of threats.",allowMultiple:!0,unlock:{buildings:[{id:"workshop",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["cliff","ridge","hill","high"],site:{category:"cleared",dimensions:{width:4,depth:4},accessClearance:{front:3,back:3,left:3,right:3}},craftedGoods:{cord:38,"crafted goods":8}},effects:{survivability:3,appeal:1,unlocks:["defense-drills"]},components:[{id:"foundation",name:"Anchored Footings",description:"Dig deep footings and backfill with stone for stability.",laborHours:10,minBuilders:3,isCore:!0,resources:{"small stones":70,pebbles:80,firewood:60,"plant fibers":20,cord:6}},{id:"main-supports",name:"Tapered Supports",description:"Raise heavy supports braced with diagonal timbers.",laborHours:12,minBuilders:3,resources:{firewood:180,"plant fibers":50,cord:14,"crafted goods":4}},{id:"floor",name:"Observation Deck",description:"Lay planked flooring with railing.",laborHours:6,minBuilders:2,resources:{firewood:80,"plant fibers":24,cord:6,"crafted goods":2}},{id:"roof",name:"Lookout Roof",description:"Add a small roof and signal brazier platform.",laborHours:5,minBuilders:2,resources:{firewood:45,"plant fibers":18,cord:4}},{id:"access",name:"Spiral Stairs",description:"Construct a spiral stair for rapid ascent.",laborHours:7,minBuilders:2,resources:{firewood:90,"plant fibers":26,cord:8,"crafted goods":2}}],addons:[{id:"signal-braziers",name:"Signal Braziers",description:"Install braziers for signaling neighboring settlements.",effects:{unlocks:["regional-alliance"]},laborHours:3,minBuilders:1,resources:{"small stones":20,firewood:24,"plant fibers":8,cord:2}}]},{id:"palisade",name:"Perimeter Palisade",icon:"🪵",category:"Defense",description:"Encircling wall of sharpened logs with fighting walkways and a reinforced gate.",allowMultiple:!1,unlock:{buildings:[{id:"watchtower",count:1}],technologies:["defense-drills"]},requirements:{minBuilders:5,locationTags:["meadow","forest","open"],site:{category:"cleared",dimensions:{width:24,depth:24},accessClearance:{front:4,back:4,left:4,right:4}},craftedGoods:{cord:60,"crafted goods":10}},effects:{survivability:4,safety:3,demand:{firewood:2,"crafted goods":1}},components:[{id:"ditch",name:"Ditch & Berm",description:"Excavate an outer ditch and throw up an inner berm for the log curtain.",laborHours:16,minBuilders:5,isCore:!0,resources:{pebbles:260,"small stones":160,firewood:120}},{id:"walls",name:"Log Curtain",description:"Set sharpened trunks shoulder to shoulder and bind them with heavy wales.",laborHours:18,minBuilders:4,resources:{firewood:420,"plant fibers":120,cord:36,"crafted goods":6}},{id:"walkway",name:"Fighting Walkway",description:"Lay interior catwalks with railing and ladder access for sentries.",laborHours:12,minBuilders:3,resources:{firewood:180,"plant fibers":48,cord:12,"crafted goods":4}},{id:"gate",name:"Reinforced Gatehouse",description:"Build a double-door gate with drop bar, murder holes, and flanking platforms.",laborHours:14,minBuilders:3,resources:{firewood:220,"plant fibers":60,cord:18,"small stones":80,"crafted goods":6}}],addons:[{id:"chevaux-de-frise",name:"Chevaux-de-frise",description:"Deploy portable spiked barriers outside the gate to break charges.",effects:{safety:1},laborHours:6,minBuilders:2,resources:{firewood:120,"plant fibers":40,cord:12}}]}],pu=fu.map(e=>{var n;if(!((n=e==null?void 0:e.requirements)!=null&&n.locationTags))return e;const t=uu(e.requirements.locationTags);return t===e.requirements.locationTags?e:{...e,requirements:{...e.requirements,locationTags:t}}}),oo=[{id:"easy",name:"Easy"},{id:"normal",name:"Medium"},{id:"hard",name:"Hard"}],ni={oreDensity:55,waterTable:50,temperature:50,rainfall:50,mountains:50,rivers100:45,lakes100:35,advanced:{elevationBase:50,elevationVariance:50,elevationScale:50,vegetationScale:50,oreNoiseScale:50,oreThresholdOffset:50,waterGuaranteeRadius:50,waterFlowMultiplier:50}};function fr(e){const t=Number.isFinite(e)?e:0;return t<0?0:t>100?100:Math.round(t)}function mu(e={}){const t={...ni.advanced,...e};return Object.fromEntries(Object.entries(t).map(([n,r])=>[n,fr(r)]))}function xr(e={}){const t={...ni,...e,advanced:mu(e.advanced)};return{...t,oreDensity:fr(t.oreDensity),waterTable:fr(t.waterTable),temperature:fr(t.temperature),rainfall:fr(t.rainfall),mountains:fr(t.mountains),rivers100:fr(t.rivers100),lakes100:fr(t.lakes100)}}const rl={easy:{people:9,foodDays:7,firewoodDays:7,tools:{"stone hand axe":1,"stone knife":1,bow:1,"wooden arrow":10,"wooden shovel":1,"wooden hammer":1}},normal:{people:7,foodDays:3,firewoodDays:3,tools:{"stone hand axe":1,"stone knife":1}},hard:{people:5,foodDays:0,firewoodDays:0,tools:{}}},cr={oreDensity:-8,waterTable:-6,temperature:-5,rainfall:-4,mountains:7,rivers100:-3,lakes100:-2,advanced:{elevationVariance:3,elevationScale:2,vegetationScale:-1,oreNoiseScale:2,oreThresholdOffset:-3,waterGuaranteeRadius:-2,waterFlowMultiplier:-2}};function hu(e={}){const t=xr(e);let n=50;const r=(i,a)=>{const d=(i-50)/50;n+=d*a};r(t.oreDensity,cr.oreDensity),r(t.waterTable,cr.waterTable),r(t.temperature,cr.temperature),r(t.rainfall,cr.rainfall),r(t.mountains,cr.mountains),r(t.rivers100,cr.rivers100),r(t.lakes100,cr.lakes100);const o=cr.advanced;return Object.entries(o).forEach(([i,a])=>{i in t.advanced&&r(t.advanced[i],a)}),Math.round(Math.min(100,Math.max(1,n)))}function yi(e,t={}){const n=rl[e]||rl.normal;return{start:{...n,tools:{...n.tools}},world:xr(t)}}const Eo={easy:yi("easy",{oreDensity:78,waterTable:70,temperature:65,rainfall:62,mountains:35,rivers100:72,lakes100:68,advanced:{vegetationScale:62,oreThresholdOffset:68,waterGuaranteeRadius:70,waterFlowMultiplier:45}}),normal:yi("normal",{oreDensity:55,waterTable:50,temperature:50,rainfall:50,mountains:50,rivers100:45,lakes100:35}),hard:yi("hard",{oreDensity:38,waterTable:40,temperature:42,rainfall:38,mountains:68,rivers100:32,lakes100:28,advanced:{elevationVariance:68,elevationScale:64,oreNoiseScale:62,oreThresholdOffset:38,waterGuaranteeRadius:32,waterFlowMultiplier:62}}),custom:yi("normal")};function wi(e="normal"){return Eo[e]||Eo.normal}function gu(e=[]){C.people instanceof Map?C.people.clear():C.people=new Map,e.forEach(t=>{t!=null&&t.id&&C.people.set(t.id,{...t})}),yc()}function yc(){const e=[...C.people.values()],t=e.length,n=e.filter(l=>(l.age??0)>=16).length,r=t-n,o=e.filter(l=>l.job).length,i=t-o,a=e.filter(l=>l.home).length,d=t-a;C.peopleStats={total:t,adults:n,children:r,employed:o,unemployed:i,housed:a,homeless:d}}function wc(){yc()}function xc(){return C.peopleStats||{total:0,adults:0,children:0,employed:0,unemployed:0,housed:0,homeless:0}}const Or=new Map;let es=!1,Ko=null,Zo=!1,ol=!1;function Di(e){ol||(console.warn("Local storage is unavailable; using in-memory storage instead.",e),ol=!0)}function bu(){if(typeof window<"u"&&window&&"localStorage"in window)try{return window.localStorage}catch(e){return Di(e),null}if(typeof globalThis<"u"&&"localStorage"in globalThis)try{return globalThis.localStorage}catch(e){return Di(e),null}try{if(typeof localStorage<"u")return localStorage}catch(e){Di(e)}return null}function Sa(e){e&&Di(e),Ko=null,Zo=!1,es=!0}function Ss(){if(es)return Zo?Ko:null;es=!0,Zo=!1,Ko=null;const e=bu();if(!e)return null;try{const t="__fantasy-survival-storage-test__";e.setItem(t,t),e.removeItem(t),Ko=e,Zo=!0}catch(t){Sa(t)}return Zo?Ko:null}function ks(e){const t=Ss();if(t)try{const n=t.getItem(e);return n==null?(Or.delete(e),null):(Or.set(e,n),n)}catch(n){Sa(n)}return Or.has(e)?Or.get(e):null}function ta(e,t){const n=Ss();if(n)try{return n.setItem(e,t),Or.set(e,t),!0}catch(r){Sa(r)}return Or.set(e,t),!1}function yu(e){const t=Ss();if(t)try{t.removeItem(e)}catch(n){Sa(n)}Or.delete(e)}const Cs="fantasy-survival-save";function Er(){try{const e=C.serialize();ta(Cs,JSON.stringify(e))}catch(e){console.error("Failed to save game",e)}}function wu(){var e,t,n,r,o,i;try{const a=ks(Cs);if(!a)return!1;C.deserialize(JSON.parse(a)),Jr();for(const d of C.locations.values()){let l=d.worldSettings;if(!l&&((e=d.map)!=null&&e.worldSettings)&&(l=d.map.worldSettings),!d.map||!d.map.tiles){d.map=Cr(d.biome,void 0,void 0,void 0,void 0,void 0,C.time.season,void 0,void 0,l,!1),(t=d.map)!=null&&t.worldSettings&&!d.worldSettings&&(d.worldSettings=d.map.worldSettings);continue}d.map.seed||(d.map.seed=Date.now());const c=((r=(n=d.map.tiles)==null?void 0:n[0])==null?void 0:r.length)||Zr,f=((o=d.map.tiles)==null?void 0:o.length)||Ea,{xStart:u,yStart:p}=Ta(c,f);Number.isFinite(d.map.xStart)||(d.map.xStart=u),Number.isFinite(d.map.yStart)||(d.map.yStart=p);const h=d.map.xStart===0&&d.map.yStart===0;(!d.map.types||h)&&(d.map=Cr(d.biome,d.map.seed,h?u:d.map.xStart,h?p:d.map.yStart,c,f,d.map.season??C.time.season,d.map.waterLevel,d.map.viewport,l,!1)),!d.worldSettings&&((i=d.map)!=null&&i.worldSettings)&&(d.worldSettings=d.map.worldSettings),!C.worldSettings&&l&&(C.worldSettings=l)}return wc(),Aa(),!0}catch(a){return console.error("Failed to load game",a),!1}}function xu(){try{yu(Cs)}catch(e){console.warn("Failed to clear saved game data.",e)}}const ii=[{id:"hunting",name:"Hunting",description:"Tracking, stalking, and harvesting wild game.",baseRate:1.1,defaultComplexity:45,diminishing:.9,startLevel:5},{id:"tracking",name:"Tracking",description:"Reading prints, scat, and disturbances to follow prey or intruders.",baseRate:1,defaultComplexity:40,diminishing:.85,startLevel:5},{id:"foraging",name:"Foraging",description:"Identifying edible and medicinal plants in the wild.",baseRate:.95,defaultComplexity:32,diminishing:.75,startLevel:5},{id:"gathering",name:"Gathering",description:"Collecting loose resources such as branches, stone, and salvage.",baseRate:.9,defaultComplexity:24,diminishing:.7,startLevel:5},{id:"fishing",name:"Fishing",description:"Casting nets, setting lines, and harvesting aquatic life.",baseRate:.96,defaultComplexity:34,diminishing:.82,startLevel:5},{id:"agriculture",name:"Agriculture",description:"Cultivating crops, tending soil, and rotating fields for food security.",baseRate:.94,defaultComplexity:42,diminishing:.8,startLevel:5},{id:"herbalism",name:"Herbalism",description:"Harvesting, preparing, and preserving medicinal plants.",baseRate:.92,defaultComplexity:36,diminishing:.78,startLevel:5},{id:"woodcutting",name:"Tree Felling",description:"Cutting timber, pruning, and shaping wood.",baseRate:1,defaultComplexity:40,diminishing:.95,startLevel:5},{id:"carpentry",name:"Carpentry",description:"Working seasoned lumber into beams, furniture, and fittings.",baseRate:.98,defaultComplexity:44,diminishing:.9,startLevel:5},{id:"masonry",name:"Stone Masonry",description:"Shaping, laying, and mortaring stone for durable structures.",baseRate:.92,defaultComplexity:50,diminishing:.88,startLevel:5},{id:"mining",name:"Mining",description:"Extracting ore, stone, and minerals safely from the earth.",baseRate:.9,defaultComplexity:52,diminishing:.95,startLevel:5},{id:"smelting",name:"Smelting",description:"Refining ore in a furnace to produce workable metals.",baseRate:.88,defaultComplexity:56,diminishing:.9,startLevel:5},{id:"smithing",name:"Smithing",description:"Forging, shaping, and tempering metal tools and weapons.",baseRate:.9,defaultComplexity:58,diminishing:.92,startLevel:5},{id:"leatherworking",name:"Leatherworking",description:"Tanning hides and sewing them into garments, armor, and goods.",baseRate:.9,defaultComplexity:40,diminishing:.82,startLevel:5},{id:"weaving",name:"Weaving",description:"Spinning fibers and weaving textiles for clothing and trade.",baseRate:.92,defaultComplexity:42,diminishing:.8,startLevel:5},{id:"pottery",name:"Pottery",description:"Forming clay vessels and firing them for storage and trade.",baseRate:.88,defaultComplexity:46,diminishing:.85,startLevel:5},{id:"crafting",name:"General Crafting",description:"Hand crafting tools, garments, and trade goods.",baseRate:.92,defaultComplexity:36,diminishing:.85,startLevel:5},{id:"cooking",name:"Cooking",description:"Preparing meals, preserving food, and balancing flavours.",baseRate:.94,defaultComplexity:30,diminishing:.76,startLevel:5},{id:"swimming",name:"Swimming",description:"Crossing rivers, lakes, and flooded ground without aid.",baseRate:.8,defaultComplexity:38,diminishing:1.2,startLevel:1},{id:"construction",name:"Construction",description:"Coordinating and executing building projects.",baseRate:.9,defaultComplexity:44,diminishing:1,startLevel:5},{id:"combat",name:"Combat Readiness",description:"Armed drills, patrol discipline, and tactical awareness.",baseRate:1.05,defaultComplexity:55,diminishing:1.1,startLevel:5}],vu=new Map(ii.map(e=>[e.id,e])),Su={hunting:"hunting",gathering:"gathering",farming:"agriculture",herding:"agriculture",crafting:"crafting",cooking:"cooking",smithing:"smithing",building:"construction",combat:"combat"};function vc(){return C.proficiencies instanceof Map||(C.proficiencies=new Map),ii.forEach(e=>{C.proficiencies.has(e.id)||C.proficiencies.set(e.id,{id:e.id,level:e.startLevel??1,lastComplexity:e.defaultComplexity,lastUpdated:Date.now()})}),C.proficiencies}function Sc(e){const t=vc(),n=vu.get(e),r=t.get(e);return n?{id:n.id,name:n.name,description:n.description,level:(r==null?void 0:r.level)??n.startLevel??1,lastComplexity:(r==null?void 0:r.lastComplexity)??n.defaultComplexity}:{id:e,name:e,level:(r==null?void 0:r.level)??1,lastComplexity:(r==null?void 0:r.lastComplexity)??0}}function kc(e){return Sc(e).level}function ku(){return vc(),ii.map(e=>Sc(e.id))}function Cu(e){return Su[e]||null}const Mu=new Map(ii.map(e=>[e.id,e])),na=["Alden","Bram","Cedric","Doran","Eamon","Gareth","Hadrian","Ivor","Lysander","Marek","Niall","Oren","Percival","Quentin","Rowan","Silas","Theron","Ulric","Varek","Wystan"],ra=["Aislin","Bria","Celes","Daphne","Elowen","Fiora","Gwyn","Helena","Isolde","Junia","Kaela","Lira","Mira","Nerine","Odette","Petra","Quilla","Rhosyn","Selene","Thalia","Vessa","Wren"],il=["Amberfall","Blackbriar","Coppervein","Dawnbreak","Eldercrest","Frostmere","Galehart","Hawthorne","Ironwood","Lakeshore","Moonridge","Nightbloom","Oakenshield","Riversong","Stormwatch","Thornfield","Umberlyn","Valewind","Wilderose","Yarwick"],Eu={hunting:"spent adolescence shadowing veteran hunters through the border woods",tracking:"learned to read faint trails while running long scouting patrols",foraging:"studied plant lore from a kindly travelling herbalist",gathering:"knows how to comb the wilds for every loose branch or stone",fishing:"worked the riverboats casting nets since childhood",agriculture:"tended terraced fields with extended kin back home",herbalism:"apprenticed under a village apothecary drying roots and leaves",woodcutting:"was raised among timber camps and swung an axe before dawn each day",carpentry:"served as a carpenter’s apprentice crafting beams and joints",masonry:"helped raise keep walls from painstakingly cut stone",mining:"hauled carts through narrow mines for many seasons",smelting:"kept smoky bloomery furnaces stoked for a merchant caravan",smithing:"apprenticed under a travelling blacksmith at a roaring forge",leatherworking:"kept tannery vats bubbling and pliable back in town",weaving:"learned the rhythm of the loom from a patient aunt",pottery:"spent years at the wheel shaping clay for market stalls",crafting:"keeps nimble hands busy fashioning useful trinkets",cooking:"ran a crowded cookfire for a mercenary band",swimming:"ferried messages by swimming swift rivers unassisted",construction:"coordinated work crews to raise palisades and scaffolds",combat:"trained relentlessly with the militia in formation drills"},Tu={hunting:"has an aversion to gore and drawn-out chases",tracking:"struggles to focus on faint signs in the underbrush",foraging:"mixes up similar herbs unless closely guided",gathering:"tires quickly hauling loose salvage",fishing:"gets seasick even on placid waters",agriculture:"suffers from pollen that blankets the spring fields",herbalism:"sneezes constantly around drying herbs",woodcutting:"worries about misjudging a tree’s fall",carpentry:"fumbles with precise joinery and measurements",masonry:"finds hefting stone exhausting after a short while",mining:"feels uneasy deep underground",smelting:"coughs in the heavy furnace smoke",smithing:"wilts in the forge heat",leatherworking:"never got used to the tannery stench",weaving:"grows impatient at the loom",pottery:"dislikes the feel of wet clay under their nails",crafting:"prefers not to fuss with fine details",cooking:"second-guesses seasoning and timing",swimming:"still remembers nearly drowning as a child",construction:"struggles with heights and scaffolding",combat:"hesitates when blades are drawn"},Au={hunting:"keeps a journal of animal movements around camp",tracking:"enjoys mapping the prints discovered near the settlement",foraging:"collects unusual berries and edible roots for fun",fishing:"mends nets and whittles floats during downtime",agriculture:"experiments with seed rows in spare plots",herbalism:"presses herbs into journals to study them later",carpentry:"carves small keepsakes from leftover lumber",masonry:"sketches arch designs on scrap parchment",smithing:"tinkers with broken tools to see how they are made",cooking:"tries new spice blends at the communal hearth",weaving:"braids cordage into intricate patterns",pottery:"shapes clay charms and beads to trade with others",leatherworking:"crafts small pouches for friends and family",combat:"keeps weapon drills sharp even after duties end"},Nu={male:{subject:"He",object:"him",possessive:"his"},female:{subject:"She",object:"her",possessive:"her"}};let Cc=1;function Lu(e){if(e==null)return Math.random;let t=typeof e=="number"?e:0;if(Number.isNaN(t)&&(t=0),typeof e=="string")for(let n=0;n<e.length;n++)t=t+e.charCodeAt(n)*13>>>0;return t=(t||Date.now())>>>0,function(){t+=1831565813;let r=t;return r=Math.imul(r^r>>>15,r|1),r^=r+Math.imul(r^r>>>7,r|61),((r^r>>>14)>>>0)/4294967296}}function xi(e,t,n){const r=Math.ceil(t),o=Math.floor(n);return Math.floor(e()*(o-r+1))+r}function Bu(e,t,n){const r=e==="female"?n.female:n.male;r.available.length===0&&(r.available=[...r.source]);const o=Math.floor(t()*r.available.length),[i]=r.available.splice(o,1);return i}function Fu(e=[]){const t=e.filter(Boolean);if(!t.length)return"";if(t.length===1)return t[0];if(t.length===2)return`${t[0]} and ${t[1]}`;const n=t.slice(0,-1).join(", "),r=t[t.length-1];return`${n}, and ${r}`}function Sr(e){var t;return((t=Mu.get(e))==null?void 0:t.name)||e}function Ru(e){return Eu[e]||`has a knack for ${Sr(e).toLowerCase()}`}function $u(e){return Tu[e]||`struggles with ${Sr(e).toLowerCase()}`}function Hu(e){return Au[e]||`enjoys practising ${Sr(e).toLowerCase()} during quiet moments`}function Iu(e){const t={},n=ii.map(p=>p.id);n.forEach(p=>{t[p]=30+Math.round(e()*20)});const r=[...n],o=(p,h=new Set)=>{const g=r.filter(S=>!h.has(S)),b=[];for(let S=0;S<p&&g.length;S++){const x=Math.floor(e()*g.length),[k]=g.splice(x,1);h.add(k),b.push(k)}return b},i=new Set,a=o(2,i),d=o(1,i);a.forEach(p=>{t[p]=70+Math.round(e()*20)}),d.forEach(p=>{t[p]=10+Math.round(e()*12)});const l=new Set(a);e()>.4&&o(1,new Set([...i,...l])).forEach(h=>l.add(h));const c=a.map(p=>({id:p,name:Sr(p),level:t[p],reason:Ru(p)})),f=d.map(p=>({id:p,name:Sr(p),level:t[p],reason:$u(p)})),u=Array.from(l).filter(p=>!d.includes(p)).map(p=>({id:p,label:Sr(p),reason:Hu(p)}));return{skillRatings:t,talents:c,deficiencies:f,interests:u}}function zr({sex:e,age:t,surname:n,householdId:r,rng:o}){const i=zr.namePools||{male:{available:[...na],source:na},female:{available:[...ra],source:ra}};zr.namePools=i;const a=Bu(e,o,i),d=`pop-${String(Cc++).padStart(3,"0")}`,{skillRatings:l,talents:c,deficiencies:f,interests:u}=Iu(o);return{id:d,givenName:a,surname:n,name:`${a} ${n}`,age:t,sex:e,householdId:r,relationships:[],family:[],interests:u,talents:c,deficiencies:f,skillRatings:l,backstory:"",job:null,assignment:null}}function al(e,t,n,r){e.relationships.some(o=>o.id===t.id&&o.relation===n)||e.relationships.push({id:t.id,relation:n}),t.relationships.some(o=>o.id===e.id&&o.relation===r)||t.relationships.push({id:e.id,relation:r})}function Du(e,t){if(!e.length)return"";const n=e.map(r=>{var o,i;return((o=t.get(r.id))==null?void 0:o.givenName)||((i=t.get(r.id))==null?void 0:i.name)}).filter(Boolean);return n.length?n.length===1?n[0]:`${n.length} children (${n.join(", ")})`:""}function Ou(e){const t=new Map(e.map(n=>[n.id,n]));e.forEach(n=>{var k,T;const r=Nu[n.sex]||{subject:"They",possessive:"their"},o=n.relationships.find(A=>A.relation==="spouse"),i=n.relationships.filter(A=>A.relation==="parent"),a=n.relationships.filter(A=>A.relation==="child"),d=o?((k=t.get(o.id))==null?void 0:k.givenName)||((T=t.get(o.id))==null?void 0:T.name):null,l=i.map(A=>{var L,R;return((L=t.get(A.id))==null?void 0:L.givenName)||((R=t.get(A.id))==null?void 0:R.name)}).filter(Boolean),c=Du(a,t),f=n.talents[0],u=n.deficiencies[0],p=n.interests[0],h=[];l.length&&h.push(`grew up learning from ${Fu(l)}`),d&&h.push(`now shares a home with ${d}`),c&&h.push(`looks after ${c}`),h.length||h.push("carved out a life on the frontier with little help");const g=f?`${r.subject} ${f.reason}, honing ${r.possessive} ${f.name.toLowerCase()} talents.`:`${r.subject} applies a steady hand to any task at hand.`,b=u?`However, ${r.subject.toLowerCase()} ${u.reason}, so ${r.subject.toLowerCase()} prefers others handle ${u.name.toLowerCase()} when possible.`:"",S=p?`In quieter moments, ${r.subject.toLowerCase()} ${p.reason}.`:"",x=`${n.name} ${h.join(" and ")}. ${g} ${b} ${S}`.replace(/\s+/g," ").trim();n.backstory=x,n.family=n.relationships.map(A=>({...A}))})}function zu(e,t){const n=[],r=[],o=[...il],i=()=>{o.length||o.push(...il);const l=Math.floor(t()*o.length);return o.splice(l,1)[0]},a=Math.max(1,Math.min(Math.floor(e/3),Math.floor(e/2)));for(let l=0;l<a&&n.length+2<=e;l++){const c=i(),f=`household-${l+1}`,u=zr({sex:"male",age:xi(t,20,45),surname:c,householdId:f,rng:t}),p=zr({sex:"female",age:xi(t,18,42),surname:c,householdId:f,rng:t});r.push({id:f,surname:c,adults:[u,p],children:[]}),n.push(u,p)}let d=r.length;for(;n.length<e;)if(r.length&&t()<.7){const c=r[Math.floor(t()*r.length)],f=t()<.5?"male":"female",u=xi(t,14,Math.min(22,45)),p=zr({sex:f,age:u,surname:c.surname,householdId:c.id,rng:t});c.children.push(p),n.push(p)}else{const c=i(),f=`household-${++d}`,u=t()<.5?"male":"female",p=xi(t,18,45),h=zr({sex:u,age:p,surname:c,householdId:f,rng:t});r.push({id:f,surname:c,adults:[h],children:[]}),n.push(h)}return r.forEach(l=>{if(l.adults.length>=2){const[c,f]=l.adults;al(c,f,"spouse","spouse")}l.children.forEach(c=>{l.adults.forEach(f=>{al(f,c,"parent","child")})})}),n}function Pu(e,t={}){const n=Math.max(1,Math.trunc(Number(e)||0)),r=Lu(t.seed);Cc=1,zr.namePools={male:{available:[...na],source:na},female:{available:[...ra],source:ra}};const o=zu(n,r);return Ou(o),gu(o),o}function ju(e,t={}){var f;const n=Array.isArray(t.preferredSkills)&&t.preferredSkills.length?t.preferredSkills:[t.id];let r=n[0],o=Number.MIN_SAFE_INTEGER;n.forEach(u=>{var h;const p=Number((h=e.skillRatings)==null?void 0:h[u]);Number.isFinite(p)&&p>o&&(r=u,o=p)}),Number.isFinite(o)||(o=Number((f=e.skillRatings)==null?void 0:f[r])||0);let i=o;const a=(e.talents||[]).some(u=>u.id===r),d=(e.interests||[]).some(u=>u.id===r),l=(e.deficiencies||[]).some(u=>u.id===r);a&&(i+=7),d&&(i+=5),l&&(i-=12);const c=Math.min(6,Math.max(0,(e.age||0)-20)*.3);return i=Math.max(0,i+c),{score:i,focusSkill:r}}function Mc(e={},t=[]){C.people instanceof Map||(C.people=new Map);const n=Array.isArray(t)?t:[],r={},o=[],i=new Set;return C.people.forEach(a=>{a&&(a.job=null,a.assignment&&delete a.assignment,!Array.isArray(a.relationships)&&Array.isArray(a.family)&&(a.relationships=[...a.family]),(a.age||0)>=16&&o.push(a))}),n.forEach(a=>{const d=Math.max(0,Math.trunc(Number((e==null?void 0:e[a.id])??0)));if(!d){r[a.id]=[],e&&(e[a.id]=0);return}const c=o.filter(f=>!i.has(f.id)).map(f=>({person:f,...ju(f,a)})).sort((f,u)=>u.score!==f.score?u.score-f.score:u.person.age!==f.person.age?u.person.age-f.person.age:f.person.name.localeCompare(u.person.name)).slice(0,d);r[a.id]=[],c.forEach(f=>{const{person:u,score:p,focusSkill:h}=f;u.job=a.id,u.assignment={jobId:a.id,score:p,focusSkill:h},i.add(u.id),r[a.id].push({id:u.id,name:u.name,age:u.age,sex:u.sex,score:Math.round(p*10)/10,focusSkill:h,focusSkillName:Sr(h)})}),e&&(e[a.id]=r[a.id].length)}),C.people.forEach((a,d)=>{const l=Array.isArray(a.relationships)?a.relationships:Array.isArray(a.family)?[...a.family]:[];C.people.set(d,{...a,relationships:l,family:l,assignment:a.job?a.assignment:null})}),wc(),r}function _u(){if(!(C.people instanceof Map))return{};const e={};return C.people.forEach(t=>{if(!(t!=null&&t.job))return;e[t.job]||(e[t.job]=[]);const n=t.assignment||{};e[t.job].push({id:t.id,name:t.name,age:t.age,sex:t.sex,score:n.score!=null?Math.round(n.score*10)/10:null,focusSkill:n.focusSkill||null,focusSkillName:n.focusSkill?Sr(n.focusSkill):null})}),Object.values(e).forEach(t=>{t.sort((n,r)=>{const o=n.score??0,i=r.score??0;return i!==o?i-o:n.name.localeCompare(r.name)})}),e}const Kr=[{id:"gather",label:"Gatherers",description:"Collect forage, firewood, and loose materials from the surrounding area.",preferredSkills:["foraging","gathering","herbalism","agriculture","woodcutting","mining"]},{id:"hunt",label:"Hunters",description:"Track game to keep the settlement supplied with meat and hides.",preferredSkills:["hunting","tracking","fishing","swimming"]},{id:"farm",label:"Farmers",description:"Tend crop fields, manage irrigation, and rotate plantings for steady harvests.",preferredSkills:["agriculture","herbalism","gathering"]},{id:"herd",label:"Herders",description:"Raise livestock, muck pens, and keep breeding stock healthy.",preferredSkills:["agriculture","hunting","herbalism"]},{id:"craft",label:"Crafters",description:"Maintain tools, weave cordage, and assemble needed goods.",preferredSkills:["crafting","carpentry","smithing","weaving","pottery","leatherworking","cooking","smelting"]},{id:"cook",label:"Cooks",description:"Prepare meals, smoke provisions, and keep communal kitchens stocked.",preferredSkills:["cooking","herbalism","crafting"]},{id:"smith",label:"Smiths",description:"Work the forge to shape metal fittings, tools, and weapons.",preferredSkills:["smithing","smelting","crafting"]},{id:"build",label:"Builders",description:"Raise new structures and shore up existing shelters.",preferredSkills:["construction","carpentry","masonry","smithing"]},{id:"guard",label:"Guards",description:"Keep watch for danger and respond to hostile threats.",preferredSkills:["combat","hunting","tracking"]}];function qu(){if((!C.jobs||typeof C.jobs!="object")&&(C.jobs={}),Object.prototype.hasOwnProperty.call(C.jobs,"scavenge")){const e=Math.max(0,Number(C.jobs.scavenge)||0);C.jobs.gather=Math.max(0,(C.jobs.gather||0)+e),delete C.jobs.scavenge}}function Ms(){(!C.jobSettings||typeof C.jobSettings!="object")&&(C.jobSettings={}),Kr.forEach(e=>{const t=C.jobSettings[e.id],n=Number.isFinite(t==null?void 0:t.workdayHours)?t.workdayHours:10;C.jobSettings[e.id]={workdayHours:Math.max(1,Math.round(n))}})}function Ec(){qu(),Ms(),Kr.forEach(e=>{const t=Number(C.jobs[e.id]);C.jobs[e.id]=Number.isFinite(t)&&t>0?Math.trunc(t):0})}function Tc(){return Kr.map(e=>({...e}))}function ka(){Ec();const e=Mc(C.jobs,Kr)||{},t=xc().adults||0,n=Kr.map(i=>({...i,assigned:C.jobs[i.id]||0,workdayHours:Es(i.id),roster:e[i.id]||[]})),r=n.reduce((i,a)=>i+a.assigned,0),o=Math.max(0,t-r);return{assignments:n,adults:t,assigned:r,laborer:o}}function Wu(){const e=ka(),t={};return e.assignments.forEach(n=>{t[n.id]=n.assigned}),t.laborer=e.laborer,t}function Uu(e,t){if(Ec(),e==="laborer")return;const n=xc().adults||0,r=Object.entries(C.jobs).filter(([a])=>a!==e).reduce((a,[,d])=>a+d,0),o=Math.max(0,n-r),i=Math.max(0,Math.trunc(Number.isFinite(t)?t:0));C.jobs[e]=Math.max(0,Math.min(i,o)),Mc(C.jobs,Kr),Er()}function Es(e){var r;Ms();const t=(r=C.jobSettings)==null?void 0:r[e],n=Number.isFinite(t==null?void 0:t.workdayHours)?t.workdayHours:10;return Math.max(1,Math.round(n))}function Yu(e,t){if(Ms(),!Kr.find(r=>r.id===e))return;const n=Math.max(4,Math.min(16,Math.round(Number.isFinite(t)?t:10)));C.jobSettings[e]={workdayHours:n},Er()}const Xu={"stone-hand-axe":300,"bronze-axe":800,"iron-axe":1500};function Gu(e=0,t="temperate-deciduous"){var i;let n="stone-hand-axe";yn("bronze-tools")&&(n="bronze-axe"),yn("iron-tools")&&(n="iron-axe");const r=Xu[n]||0,o=((i=Mr(t))==null?void 0:i.woodMod)??1;return e*r*o}const Vu=50,Ku=.8,Zu=Vu*Ku,Ju=[{name:"firewood",weight:5},{name:"food",weight:1},{name:"small stones",weight:2},{name:"pebbles",weight:1}],Qu={firewood:.25,food:.4,"small stones":.2,pebbles:.15},ef=.95,tf=3,nf=.35,rf=.5,of=.5,af=.3;function sf(e){const t=Ju.find(n=>n.name===e);return t?t.weight:1}function lf(e,t){const n={};return Object.entries(e).forEach(([r,o])=>{n[r]=o*t}),n}function cf(e,t){return e[t]||(e[t]={supply:0,demand:0}),e[t]}function Ac(e,t,n){if(!Number.isFinite(n)||n===0)return;const r=cf(e,t);n>0?r.supply+=n:r.demand+=Math.abs(n)}const df={gather:"gathering",hunt:"hunting",farm:"farming",herd:"herding",craft:"crafting",cook:"cooking",smith:"smithing"},uf={gather:"gathering",hunt:"hunting",farm:"agriculture",herd:"agriculture",craft:"crafting",cook:"cooking",smith:"smithing"};function ts(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,e)):t}function ff(e){const n=Number.isFinite(e)?Math.max(0,e):50;if(n>=50){const o=(n-50)/50;return 1+ts(o,0,1.6)*.6}const r=(50-n)/50;return ts(1-r*.6,.4,1)}function pf(e){if(!e)return 1;const t=kc(e);return Number.isFinite(t)?.55+ts(t,1,100)/90:1}function mf(e,t,n){if(t!=null&&t.focusSkill)return t.focusSkill;if(n){const r=Cu(n);if(r)return r}return uf[e]||n||null}function hf(e){const t=_u();Object.entries(t).forEach(([n,r])=>{if(!Array.isArray(r)||r.length===0)return;const o=df[n];if(!o)return;const i=Es(n);if(!Number.isFinite(i)||i<=0)return;let a=0;if(r.forEach(c=>{const f=mf(n,c,o),u=ff(c==null?void 0:c.score)*pf(f);Number.isFinite(u)&&u>0&&(a+=u)}),!Number.isFinite(a)||a<=0)return;const d=Ts({type:o,workers:a,assigned:r.length}),l=Object.entries(d||{}).filter(([,c])=>Number.isFinite(c)&&c!==0);l.length&&l.forEach(([c,f])=>{const u=f*i;Ac(e,c,u)})})}function gf(e){const t=er({statuses:["completed"]});let n=0;return t.forEach(r=>{var d,l;const o=an(r.typeId),i=(l=(d=o==null?void 0:o.effects)==null?void 0:d.jobs)==null?void 0:l[e],a=Number(i)||0;a>0&&(n+=a)}),n}const bf={grain:.2,"root vegetables":.1333,herbs:.0333},yf={"crafted goods":.02},wf={food:.15,hides:.04,"animal fat":.02},xf={grain:.075,water:.1},vf={cookedMeals:.2,"hearty meal":.1,"comfort meal":.05,preservedFood:.05},Sf={food:.3,firewood:.15,herbs:.05,salt:.03,spices:.015},kf={"crafted goods":.15,"bronze ingot":.05},Cf={"raw ore":.1,charcoal:.1,firewood:.05};function Ca(e,t=0,n=0){if(!Number.isFinite(t)||t<=0)return 0;const r=gf(e);if(r<=0)return 0;const o=Math.min(Math.max(0,n),r);return o<=0?0:Math.min(t,o)}function Mf(e=0){const t=Zu*ef/8,n={};return Object.entries(Qu).forEach(([r,o])=>{const i=t*o;n[r]=i/sf(r)*e}),n}function Ef(e={}){const{people:t=0,foodDays:n=0,firewoodDays:r=0,tools:o={}}=e,i={},a=1;return t>0&&n>0&&(i.food=t*n*a),t>0&&r>0&&(i.firewood=t*r),Object.entries(o).forEach(([d,l])=>{l&&(i[d]=(i[d]||0)+l)}),i}function Tf(e){const t=(e==null?void 0:e.workers)||0;return{food:t*tf,hides:t*nf}}function Af(e){const t=(e==null?void 0:e.workers)||0;return{"crafted goods":t*rf,firewood:-t*of}}function Nf(e){const t=Ca("farm",(e==null?void 0:e.workers)||0,(e==null?void 0:e.assigned)||0);if(!t)return{};const n={};return Object.entries(bf).forEach(([r,o])=>{n[r]=(n[r]||0)+o*t}),Object.entries(yf).forEach(([r,o])=>{n[r]=(n[r]||0)-o*t}),n}function Lf(e){const t=Ca("herd",(e==null?void 0:e.workers)||0,(e==null?void 0:e.assigned)||0);if(!t)return{};const n={};return Object.entries(wf).forEach(([r,o])=>{n[r]=(n[r]||0)+o*t}),Object.entries(xf).forEach(([r,o])=>{n[r]=(n[r]||0)-o*t}),n}function Bf(e){const t=Ca("cook",(e==null?void 0:e.workers)||0,(e==null?void 0:e.assigned)||0);if(!t)return{};const n={};return Object.entries(vf).forEach(([r,o])=>{n[r]=(n[r]||0)+o*t}),Object.entries(Sf).forEach(([r,o])=>{n[r]=(n[r]||0)-o*t}),n}function Ff(e){const t=Ca("smith",(e==null?void 0:e.workers)||0,(e==null?void 0:e.assigned)||0);if(!t)return{};const n={};return Object.entries(kf).forEach(([r,o])=>{n[r]=(n[r]||0)+o*t}),Object.entries(Cf).forEach(([r,o])=>{n[r]=(n[r]||0)-o*t}),n}function Rf(e){var i,a;const t=(e==null?void 0:e.workers)||0,n={},r=((i=e==null?void 0:e.metadata)==null?void 0:i.perWorkerHourResources)||{};Object.entries(r).forEach(([d,l])=>{l&&(n[d]=-l*t)});const o=((a=e==null?void 0:e.metadata)==null?void 0:a.progressPerWorkerHour)??af;return n["construction progress"]=t*o,n}function Ts(e){if(!e)return{};switch(e.type){case"gathering":return Mf(e.workers);case"hunting":return Tf(e);case"farming":return Nf(e);case"herding":return Lf(e);case"crafting":return Af(e);case"cooking":return Bf(e);case"smithing":return Ff(e);case"building":return Rf(e);case"combat":default:return{}}}function $f(e,t=1){if(!e||t<=0)return{};const n=Ts(e);return lf(n,t)}function Hf(e=[]){const t={};return e.filter(n=>n.status==="pending"||n.status==="active").forEach(n=>{const r=n.status==="pending"?n.durationHours:n.remainingHours,o=$f(n,r);Object.entries(o).forEach(([i,a])=>{Ac(t,i,a)})}),hf(t),t}const If={gather:"gathering",hunt:"hunting",craft:"crafting"};function Df(e,t){(!C.jobDaily||typeof C.jobDaily!="object")&&(C.jobDaily={});const n=C.jobDaily[e];return(!n||n.dayStamp!==t)&&(C.jobDaily[e]={dayStamp:t,workedHours:0,idleHours:0}),C.jobDaily[e]}function Of(e,t){Object.entries(e||{}).forEach(([n,r])=>{if(!r)return;const o=r*t;o&&Qi(n,o)})}function zf(e,t,n){var a;const r=If[e];if(!r||t<=0||n<=0)return 0;const o=Ts({type:r,workers:t});if(!o)return 0;let i=n;if(r==="crafting"){const d=Math.abs(o.firewood||0);if(d>0){const l=Math.max(0,((a=oi("firewood"))==null?void 0:a.quantity)||0),c=l>0?l/d:0;i=Math.min(n,c)}}return i<=0?0:(Of(o,i),i)}function Pf(e,t,n){if(!e||t<=0)return 0;const r=Math.max(1,e.totalLaborHours||1),o=e.requiredResources||{},i=e.consumedResources||{};let a=t;return Object.entries(o).forEach(([d,l])=>{var S;if(!Number.isFinite(l)||l<=0)return;const c=l/r;if(c<=0)return;const f=c*n;if(f<=0)return;const u=i[d]||0,p=Math.max(0,l-u);if(p<=0){a=Math.min(a,0);return}const h=Math.max(0,((S=oi(d))==null?void 0:S.quantity)||0),b=Math.min(p,h)/f;a=Math.min(a,b)}),Math.max(0,a)}function jf(e,t){if(t<=0)return;const n=Math.max(1,e.totalLaborHours||1),r=e.requiredResources||{};if(!Object.keys(r).length)return;const o={};Object.entries(r).forEach(([i,a])=>{if(!Number.isFinite(a)||a<=0)return;const d=a/n;if(d<=0)return;const l=d*t;l&&(o[i]=l,Qi(i,-l))}),Object.keys(o).length&&pm(e.id,o)}function _f(e,t){if(e<=0||t<=0)return 0;const n=er({statuses:["under-construction"]});if(!n.length)return 0;let r=e*t,o=0;return n.some(i=>{if(r<=0)return!0;const a=Math.max(1,i.assignedWorkers||1),d=Math.max(1,i.totalLaborHours||1),l=Math.ceil(d/a),c=Math.max(a*l,d),f=d/c,u=Math.max(0,d-(i.progressHours||0));if(u<=0)return!1;const p=u/f;if(p<=0)return!1;const h=Math.min(r,p);if(h<=0)return!1;const g=Pf(i,h,f);if(g<=0)return!1;const b=g*f;return b<=0||(jf(i,b),fm(i.id,b),r-=g,o+=g,Math.min(d,(i.progressHours||0)+b)>=d&&mm(i.id)),!1}),o}function qf(e,{dayStamp:t}={}){if(!Number.isFinite(e)||e<=0)return;const n=Wu();Object.entries(n).forEach(([r,o])=>{if(r==="laborer")return;const i=Math.max(0,Number(o)||0);if(i<=0)return;const a=Df(r,t),d=Es(r),l=Math.max(0,d-a.workedHours);if(l<=0)return;const c=Math.min(e,l);if(c<=0)return;let f=0;r==="build"?(f=_f(i,c),f>0&&(f/=Math.max(1,i))):f=zf(r,i,c),f>0?(a.workedHours+=f,f<c&&(a.idleHours+=c-f)):a.idleHours+=c})}function sl(e){if(!C.jobDaily||typeof C.jobDaily!="object"){C.jobDaily={};return}Object.entries(C.jobDaily).forEach(([t,n])=>{!n||n.dayStamp===e||(C.jobDaily[t]={dayStamp:e,workedHours:0,idleHours:0})})}const ns=28,ko=24,Nc=6,Qo={min:410,max:987};function Wf(){const e=Qo.max-Qo.min+1;return Qo.min+Math.floor(Math.random()*e)}const ai=[{name:"Frostmelt",season:"Thawbound"},{name:"Dawnforge",season:"Thawbound"},{name:"Seedwane",season:"Thawbound"},{name:"Raincall",season:"Sunheight"},{name:"Suncrest",season:"Sunheight"},{name:"Highember",season:"Sunheight"},{name:"Harvestgale",season:"Emberwane"},{name:"Emberfall",season:"Emberwane"},{name:"Gloamreach",season:"Emberwane"},{name:"Stormwrack",season:"Frostshroud"},{name:"Nightveil",season:"Frostshroud"},{name:"Deepfrost",season:"Frostshroud"},{name:"Ghostmoon",season:"Frostshroud"}],on=ai.length,Uf=ai.map(e=>e.name),Ma={Thawbound:{icon:"🌿",months:[]},Sunheight:{icon:"🔥",months:[]},Emberwane:{icon:"🍂",months:[]},Frostshroud:{icon:"❄️",months:[]}};ai.forEach((e,t)=>{const n=Ma[e.season];n&&n.months.push(t+1)});Object.values(Ma).forEach(e=>{e.months.sort((t,n)=>t-n)});const Lc=[{name:"Clear",icon:"☀️",weights:{Thawbound:3,Sunheight:4,Emberwane:3,Frostshroud:2}},{name:"Cloudy",icon:"☁️",weights:{Thawbound:2,Sunheight:2,Emberwane:3,Frostshroud:3}},{name:"Rain",icon:"🌧️",weights:{Thawbound:3,Sunheight:3,Emberwane:2,Frostshroud:1}},{name:"Storm",icon:"⛈️",weights:{Thawbound:1,Sunheight:2,Emberwane:1,Frostshroud:1}},{name:"Snow",icon:"❄️",weights:{Thawbound:0,Sunheight:0,Emberwane:1,Frostshroud:4}},{name:"Fog",icon:"🌫️",weights:{Thawbound:1,Sunheight:1,Emberwane:2,Frostshroud:2}}],ll=[{key:"night",label:"Night",icon:"🌙",start:0,end:4},{key:"dawn",label:"Dawn",icon:"🌅",start:4,end:7},{key:"day",label:"Day",icon:"☀️",start:7,end:18},{key:"dusk",label:"Dusk",icon:"🌇",start:18,end:21},{key:"night",label:"Night",icon:"🌙",start:21,end:24}];function Yf(e=0){return((Number.isFinite(e)?e:0)%ko+ko)%ko}function si(){return C.time||(C.time={}),(!Number.isFinite(C.time.day)||C.time.day<1)&&(C.time.day=1),Number.isFinite(C.time.month)?C.time.month<1?C.time.month=1:C.time.month>on&&(C.time.month=(Math.floor(C.time.month)-1)%on+1):C.time.month=1,!Number.isFinite(C.time.year)||C.time.year<Qo.min?C.time.year=Qo.min:C.time.year=Math.floor(C.time.year),Number.isFinite(C.time.hour)||(C.time.hour=Nc),C.time.season=As(C.time.month),C.time.weather||(C.time.weather="Clear"),C.time}function Oa(e=si()){const t=Number.isFinite(e.year)?Math.floor(e.year):0,n=Number.isFinite(e.month)?Math.floor(e.month):1,r=Number.isFinite(e.day)?Math.floor(e.day):1,o=((n-1)%on+on)%on;return t*on*ns+o*ns+(r-1)}function As(e=1){var r;const n=(((Number.isFinite(e)?Math.floor(e):1)-1)%on+on)%on;return((r=ai[n])==null?void 0:r.season)||Object.keys(Ma)[0]}function Ns(e=1){var r;const n=(((Number.isFinite(e)?Math.floor(e):1)-1)%on+on)%on;return((r=ai[n])==null?void 0:r.name)||Uf[0]}function Xf(e,t){const n=Lc.map(i=>{var a;return{name:i.name,icon:i.icon,weight:((a=i.weights)==null?void 0:a[e])??0}}).filter(i=>i.weight>0);if(!n.length)return t||"Clear";if(t){const i=n.find(a=>a.name===t);i&&(i.weight+=1.5)}const r=n.reduce((i,a)=>i+a.weight,0);if(r<=0)return t||n[0].name;let o=Math.random()*r;for(const i of n)if(o-=i.weight,o<=0)return i.name;return n[n.length-1].name}function Bc(e){const t=e||"Unknown",n=Ma[t];return n?{name:t,icon:n.icon,months:[...n.months]}:{name:t,icon:"❔",months:[]}}function Gf(e){const t=Lc.find(n=>n.name===e);return t?{name:t.name,icon:t.icon}:{name:e||"Unknown",icon:"❔"}}function Vf(e=(t=>(t=C.time)==null?void 0:t.hour)()){const n=Yf(e),r=ll.find(o=>n>=o.start&&n<o.end)||ll[0];return{key:r.key,label:r.label,icon:r.icon,start:r.start,end:r.end}}function Fc(){const e=si();e.day+=1,e.day>ns&&(e.day=1,e.month+=1,e.month>on&&(e.month=1,e.year+=1)),e.season=As(e.month),e.weather=Xf(e.season,e.weather)}function Rc(e=1){const t=si(),n=Math.max(0,Number.isFinite(e)?e:0);if(n<=0)return;sl(Oa(t));let r=n;for(;r>0;){const o=Oa(t),i=ko-t.hour,a=Math.min(r,i);a>0?(qf(a,{dayStamp:o}),t.hour+=a,r-=a):(t.hour+=r,r=0),t.hour>=ko-1e-9&&(t.hour-=ko,Fc(),sl(Oa(t)))}}function sn(){const e=si();return{...e,monthName:Ns(e.month)}}function $c(){const e=si();e.hour=Nc}const rs="sanity-check-notification";let vi=null;const Kf=5e3;let cl=null;function Zf(){return Array.isArray(C.eventLog)||(C.eventLog=[]),C.eventLog}function Jf(e){const t=typeof sn=="function"?sn():null;return{id:`sanity-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,message:e,day:(t==null?void 0:t.day)??null,month:(t==null?void 0:t.month)??null,year:(t==null?void 0:t.year)??null,hour:(t==null?void 0:t.hour)??null,season:(t==null?void 0:t.season)??null,weather:(t==null?void 0:t.weather)??null}}function Qf(){if(vi||typeof document>"u")return vi;const e=document.createElement("div");return e.className="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","false"),document.body.appendChild(e),vi=e,vi}function ep(e,t={}){if(typeof document>"u")return;const n=Qf();if(!n)return;const r=document.createElement("div");r.className="toast",t!=null&&t.type&&r.classList.add(`toast--${t.type}`),r.textContent=typeof e=="string"?e:"",n.appendChild(r),requestAnimationFrame(()=>{r.classList.add("is-visible")});const o=Number.isFinite(t==null?void 0:t.duration)?Math.max(0,t.duration):Kf;window.setTimeout(()=>{r.classList.remove("is-visible"),window.setTimeout(()=>{r.parentElement===n&&n.removeChild(r)},300)},o)}function tp(e,t={}){const n=typeof e=="string"&&e.trim()?e.trim():"Sanity check adjustment applied.",r=n.startsWith("[sanity-check]")?n:`[sanity-check] ${n}`,o=Zf();if(o.unshift(Jf(r)),o.length>30&&(o.length=30),typeof document<"u"&&typeof document.dispatchEvent=="function")try{document.dispatchEvent(new CustomEvent(rs,{detail:{message:r,...t}}))}catch(i){console.error("Failed to dispatch sanity check notification",i)}return r}function np(e){if(typeof e!="function")return()=>{};if(typeof document>"u"||typeof document.addEventListener!="function")return()=>{};const t=n=>{try{e(n.detail||{})}catch(r){console.error("Error in sanity check listener",r)}};return document.addEventListener(rs,t),()=>document.removeEventListener(rs,t)}function Hc(){cl||typeof document>"u"||(cl=np(e=>{!e||typeof e.message!="string"||ep(e.message,{type:e.type??"info"})}))}class rp{constructor({parameters:t={},evaluate:n,regenerate:r,maxIterations:o=5,chunkSize:i=16,chunkRows:a=1,chunkColumns:d=1,gridWidth:l=0,gridHeight:c=0}={}){this.parameters={...t},this.evaluate=typeof n=="function"?n:()=>null,this.regenerate=typeof r=="function"?r:()=>null,this.maxIterations=Math.max(1,Math.trunc(o)),this.chunkSize=Math.max(1,Math.trunc(i)),this.chunkRows=Math.max(1,Math.trunc(a)),this.chunkColumns=Math.max(1,Math.trunc(d)),this.gridWidth=Math.max(0,Math.trunc(l)),this.gridHeight=Math.max(0,Math.trunc(c)),this.metricsHistory=[],this.messages=[],this.fullRerender=!1,this.dirtyChunks=new Set,this.bestSolution=null}markAllDirty(){this.fullRerender=!0,this.dirtyChunks.clear()}markChunkDirty(t,n){if(this.fullRerender)return;const r=Math.trunc(t),o=Math.trunc(n);Number.isNaN(r)||Number.isNaN(o)||r<0||o<0||r>=this.chunkRows||o>=this.chunkColumns||this.dirtyChunks.add(`${r}:${o}`)}markTileDirty(t,n){if(this.fullRerender)return;const r=Math.trunc(t),o=Math.trunc(n);if(Number.isNaN(r)||Number.isNaN(o)||r<0||o<0||r>=this.gridWidth||o>=this.gridHeight)return;const i=Math.floor(o/this.chunkSize),a=Math.floor(r/this.chunkSize);this.markChunkDirty(i,a)}addMessage(t){if(!t||typeof t!="string")return;const n=t.trim();n&&this.messages.push(n)}computeScore(t){var i;if(!t)return Number.NEGATIVE_INFINITY;if(Number.isFinite(t.score))return t.score;const n=Number.isFinite(t.landRatio)?t.landRatio:0,r=Number.isFinite(t.oreRatio)?t.oreRatio:0,o=(i=t.origin)!=null&&i.isWater?.25:0;return n-r*.2-o}getDirtyChunks(){if(this.fullRerender)return[];const t=[];for(const n of this.dirtyChunks){const[r,o]=n.split(":").map(i=>Number.parseInt(i,10));Number.isFinite(r)&&Number.isFinite(o)&&t.push({row:r,column:o})}return t}solve(t={}){var l,c,f;const n={...t,solver:this};let r=null,o=0,i={...this.parameters},a=null;for(;o<this.maxIterations;o++){const u={...this.parameters};if(r=this.evaluate({parameters:u,iteration:o,context:n}),!r)break;const p=this.computeScore(r);r.score=p,this.metricsHistory.push(r);const h=this.bestSolution,g=r.satisfied===!0;if(!h||g&&((l=h.metrics)==null?void 0:l.satisfied)!==!0||g===(((c=h.metrics)==null?void 0:c.satisfied)===!0)&&p>h.score){const x={...r,origin:r.origin?{...r.origin}:r.origin,stats:r.stats?{...r.stats}:r.stats};this.bestSolution={score:p,metrics:x,parameters:u}}if(i=u,a=r,r.satisfied===!0)break;const S=this.regenerate({parameters:{...this.parameters},metrics:r,iteration:o,context:n});if(!S||(S.parameters&&typeof S.parameters=="object"&&(this.parameters={...this.parameters,...S.parameters}),Array.isArray(S.messages)&&S.messages.forEach(x=>this.addMessage(x)),S.message&&this.addMessage(S.message),S.markAllDirty&&this.markAllDirty(),Array.isArray(S.markTiles)&&S.markTiles.forEach(x=>{x&&Number.isFinite(x.x)&&Number.isFinite(x.y)&&this.markTileDirty(x.x,x.y)}),Array.isArray(S.markChunks)&&S.markChunks.forEach(x=>{x&&Number.isFinite(x.row)&&Number.isFinite(x.column)&&this.markChunkDirty(x.row,x.column)}),S.stop===!0))break}let d=!1;if(this.bestSolution){const u=this.computeScore(a),p=this.bestSolution;if(!a||!a.satisfied||((f=p.metrics)==null?void 0:f.satisfied)===!0||p.score>u){i={...p.parameters},a=p.metrics;const g=this.parameters;(!g||g.xStart!==i.xStart||g.yStart!==i.yStart||(g.originShiftX||0)!==(i.originShiftX||0)||(g.originShiftY||0)!==(i.originShiftY||0))&&(this.markAllDirty(),d=!0)}}return this.parameters={...i},{parameters:{...this.parameters},metrics:a,history:this.metricsHistory.slice(),messages:this.messages.slice(),iterations:this.metricsHistory.length,dirty:{full:this.fullRerender||d,chunks:this.getDirtyChunks()}}}}function op(e){const t=typeof e=="string"?e:String(e??"");let n=1779033703^t.length;for(let r=0;r<t.length;r+=1)n=Math.imul(n^t.charCodeAt(r),3432918353),n=n<<13|n>>>19;return n=Math.imul(n^n>>>16,2246822507),n=Math.imul(n^n>>>13,3266489909),(n^=n>>>16)>>>0}function ip(e){let t=e>>>0;return()=>{t+=1831565813;let n=Math.imul(t^t>>>15,t|1);return n^=n+Math.imul(n^n>>>7,n|61),((n^n>>>14)>>>0)/4294967296}}const ap=.5*(Math.sqrt(3)-1),qo=(3-Math.sqrt(3))/6;function Hn(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}const za=[[1,1],[-1,1],[1,-1],[-1,-1],[1,0],[-1,0],[1,0],[-1,0],[0,1],[0,-1],[0,1],[0,-1]];class dl{constructor(t){const n=ip(op(t)),r=new Uint8Array(256);for(let o=0;o<256;o+=1)r[o]=o;for(let o=255;o>0;o-=1){const i=Math.floor(n()*(o+1)),a=r[o];r[o]=r[i],r[i]=a}this.perm=new Uint8Array(512);for(let o=0;o<512;o+=1)this.perm[o]=r[o&255]}noise2D(t,n){let r=0,o=0,i=0;const a=(t+n)*ap,d=Math.floor(t+a),l=Math.floor(n+a),c=(d+l)*qo,f=d-c,u=l-c,p=t-f,h=n-u;let g=0,b=0;p>h?g=1:b=1;const S=p-g+qo,x=h-b+qo,k=p-1+2*qo,T=h-1+2*qo,A=d&255,L=l&255,R=this.perm[A+this.perm[L]]%12,z=this.perm[A+g+this.perm[L+b]]%12,H=this.perm[A+1+this.perm[L+1]]%12;let _=.5-p*p-h*h;if(_>=0){_*=_;const F=za[R];r=_*_*(F[0]*p+F[1]*h)}let I=.5-S*S-x*x;if(I>=0){I*=I;const F=za[z];o=I*I*(F[0]*S+F[1]*x)}let s=.5-k*k-T*T;if(s>=0){s*=s;const F=za[H];i=s*s*(F[0]*k+F[1]*T)}return 70*(r+o+i)}}function sp(e,t,n,r,o,i){const a=Math.max(24,r),d=t/a,l=n/a,c=Hn(1-Math.hypot(d,l),0,1),f=e.noise2D(d*.7+11.3,l*.7-7.1)*.5+.5,u=e.noise2D(d*1.8-3.7,l*1.8+5.9)*.5+.5,p=c*(.65+.35*f)+u*.12,h=p*(1-o)+Math.pow(p,1.5)*o;return Hn(h+i,0,1)}function lp(e,t={}){const n=new dl(`${e}:elev`),r=new dl(`${e}:mask`),o=Hn(t.base??.5,.01,.99),i=Hn(t.variance??.5,.01,2),a=Math.max(4,t.scale??64),d=Math.max(a,t.worldScale??a*4),l=Math.max(1,Math.trunc(t.octaves??5)),c=Hn(t.persistence??.5,.25,.85),f=Hn(t.lacunarity??2.1,1.2,3.6),u=Hn(t.maskStrength??.55,0,1),p=Hn(t.maskBias??0,-.3,.3),h=1/a,g=Math.sqrt(d/64);return{sample(b,S){let x=1,k=1,T=0,A=0;for(let _=0;_<l;_+=1){const I=(b+_*17.31)*h*k/g,s=(S-_*11.17)*h*k/g,F=n.noise2D(I,s)*.5+.5;T+=F*x,A+=x,x*=c,k*=f}const L=A>0?T/A:.5,R=sp(r,b,S,d,u,p),z=Hn(L*(.6+.4*R)+R*.18,0,1),H=o+(z-.5)*2*i;return Hn(H,0,1)}}}function Gt(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function Wo(e,t){return Number.isFinite(e)?Gt(Math.round(e),0,100):t}function cp(e){return .25+Gt(Number.isFinite(e)?e:50,0,100)/100*1.5}function dp(e){var n;const t=((n=e==null?void 0:e.features)==null?void 0:n.join(" ").toLowerCase())??"";return/marsh|bog|swamp|delta|mangrove|wetland|flood/i.test(t)}function up(e,t,n,r){var Xe,Ve;const o=Wo(t==null?void 0:t.rainfall,50),i=Wo(t==null?void 0:t.waterTable,50),a=Wo(t==null?void 0:t.mountains,50),d=Wo(t==null?void 0:t.rivers100,45),l=Wo(t==null?void 0:t.lakes100,35),c=(o-50)/100,f=(i-50)/100,u=(a-50)/100,p=(d-50)/100,h=(l-50)/100,g=((Xe=e==null?void 0:e.elevation)==null?void 0:Xe.waterLevel)??.28,b=Gt(g+f*.1+c*.06-u*.08,.04,.8),S=cp((Ve=t==null?void 0:t.advanced)==null?void 0:Ve.waterFlowMultiplier),x=Math.max(16,n*r),k=Gt(p*.45+c*.35+f*.25,-.6,.9),T=x*Gt(.0025+k*.0018,.0012,.0075),A=Math.max(12,T/S),L=Math.max(6,A*.45),R=A*1.35,z=dp(e)?.4:0,H=Gt(c*.5+h*.35+z,0,1),_=H>.35?2:1,s=Gt(.03+c*.03+h*.02,.01,.16)/Math.max(.75,S*.85),F=Gt(h+c*.4,-.5,1.2),Y=Math.max(4,Math.round(6+F*8)),Z=Gt(5e-4+h*15e-5,2e-4,.001),re=Gt(Math.round(4+(f+c)*6),3,12),ke=Gt(Math.round(2+p*1.2+c*.8),2,4),ye=Gt(ke+1+Math.round(z*2),ke,6),We=Gt(.04+c*.03+f*.04,.02,.12),Ye=Gt(Math.round(re*.6+p*2),2,re);return{seaLevel:b,flowMultiplier:S,riverFlowThreshold:A,tributaryThreshold:L,mouthExpansionThreshold:R,lakeMinDepth:s,lakeMinArea:Y,marshRingWidth:_,marshiness:H,maxSingletonFraction:Z,estuaryRadius:re,distributaryMin:ke,distributaryMax:ye,estuaryWideningDepth:We,confluenceRadius:Ye}}class Ic{constructor(){this.heap=[]}push(t){this.heap.push(t),this.bubbleUp(this.heap.length-1)}pop(){if(!this.heap.length)return null;const t=this.heap[0],n=this.heap.pop();return this.heap.length&&(this.heap[0]=n,this.bubbleDown(0)),t}bubbleUp(t){let n=t;for(;n>0;){const r=Math.floor((n-1)/2);if(this.heap[r].value<=this.heap[n].value)break;[this.heap[r],this.heap[n]]=[this.heap[n],this.heap[r]],n=r}}bubbleDown(t){let n=t;const r=this.heap.length;for(;n<r;){const o=n*2+1,i=n*2+2;let a=n;if(o<r&&this.heap[o].value<this.heap[a].value&&(a=o),i<r&&this.heap[i].value<this.heap[a].value&&(a=i),a===n)break;[this.heap[n],this.heap[a]]=[this.heap[a],this.heap[n]],n=a}}}const je=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];function fp(e,t){for(let n=0;n<je.length;n+=1)if(je[n][0]===e&&je[n][1]===t)return n;return-1}function Bn(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function os(e,t){const n=`${e}:${t}`;let r=1779033703^n.length;for(let o=0;o<n.length;o+=1)r=Math.imul(r^n.charCodeAt(o),3432918353),r=r<<13|r>>>19;return r=Math.imul(r^r>>>16,2246822507),r=Math.imul(r^r>>>13,3266489909),(r^=r>>>16)>>>0}function pp(e,t,n,r){const o=e*t,i=new Float64Array(o);i.fill(Number.POSITIVE_INFINITY);const a=new Uint8Array(o),d=new Ic;for(let l=0;l<t;l+=1)for(let c=0;c<e;c+=1)if(l===0||c===0||l===t-1||c===e-1){const f=l*e+c,u=Math.max(n[f],r);i[f]=u,a[f]=1,d.push({index:f,value:u})}for(let l=d.pop();l;l=d.pop()){const{index:c,value:f}=l,u=c%e,p=Math.floor(c/e);for(let h=0;h<je.length;h+=1){const g=je[h][0],b=je[h][1],S=u+g,x=p+b;if(S<0||x<0||S>=e||x>=t)continue;const k=x*e+S;if(a[k])continue;a[k]=1;const T=Math.max(n[k],f);i[k]=T,d.push({index:k,value:T})}}return i}function Pa(e,t,n){const r=[];for(let o=0;o<t;o+=1){const i=[];for(let a=0;a<e;a+=1)i.push(n[o*e+a]);r.push(i)}return r}function mp(e,t,n,r,o,i){const a=e*t,d=new Array(a).fill("land"),l=new Float64Array(a);l.set(r);const c=new Uint8Array(a),f=1e-5,u=[],p=i.lakeMinDepth,h=i.lakeMinArea,g=Math.max(p*.6,.006);for(let x=0;x<a;x+=1){if(c[x])continue;const k=r[x]-n[x];if(r[x]<=o+f||k<g)continue;const T=[x],A=[];let L=k,R=0;const z=r[x];for(;T.length;){const H=T.pop();if(c[H])continue;c[H]=1;const _=r[H]-n[H];if(r[H]-z>f||_<g)continue;A.push(H),R+=1,_>L&&(L=_);const I=H%e,s=Math.floor(H/e);for(let F=0;F<je.length;F+=1){const Y=I+je[F][0],Z=s+je[F][1];if(Y<0||Z<0||Y>=e||Z>=t)continue;const re=Z*e+Y;c[re]||T.push(re)}}if(A.length&&(R>=h||L>=p*1.35)){for(const H of A)d[H]="lake";u.push(...A)}}const b=new Uint8Array(a),S=[];for(let x=0;x<e;x+=1){const k=x,T=(t-1)*e+x;r[k]<=o+f&&(S.push(k),b[k]=1,d[k]="ocean"),r[T]<=o+f&&(S.push(T),b[T]=1,d[T]="ocean")}for(let x=0;x<t;x+=1){const k=x*e,T=k+e-1;r[k]<=o+f&&!b[k]&&(S.push(k),b[k]=1,d[k]="ocean"),r[T]<=o+f&&!b[T]&&(S.push(T),b[T]=1,d[T]="ocean")}for(;S.length;){const x=S.shift(),k=x%e,T=Math.floor(x/e);for(let A=0;A<je.length;A+=1){const L=k+je[A][0],R=T+je[A][1];if(L<0||R<0||L>=e||R>=t)continue;const z=R*e+L;b[z]||r[z]<=o+f&&d[z]!=="lake"&&(d[z]="ocean",b[z]=1,S.push(z))}}return{types:d,spill:l}}function hp(e,t,n,r,o,i){const a=e*t,d=new Int8Array(a);d.fill(-1);const l=1e-6;for(let c=0;c<a;c+=1){if(o[c]==="ocean")continue;const f=c%e,u=Math.floor(c/e);let p=-1,h=-1/0,g=n[c];for(let b=0;b<je.length;b+=1){const S=f+je[b][0],x=u+je[b][1];if(S<0||x<0||S>=e||x>=t)continue;const k=x*e+S,T=r[c]-r[k];T>h+l?(h=T,p=b,g=n[k]):Math.abs(T-h)<=l&&T>-l&&(n[k]<g-l?(p=b,g=n[k]):Math.abs(n[k]-g)<=l&&(os(i,c*31+b)&1||(p=b,g=n[k])))}if(p===-1){let b=r[c];for(let S=0;S<je.length;S+=1){const x=f+je[S][0],k=u+je[S][1];if(x<0||k<0||x>=e||k>=t)continue;const T=k*e+x,A=r[T];A<b-l&&(b=A,p=S)}}d[c]=p}return d}function gp(e,t,n,r,o){const i=e*t,a=Array.from({length:i},(l,c)=>c);a.sort((l,c)=>o[l]-o[c]);const d=new Float64Array(i);d.fill(1);for(const l of a){const c=n[l];if(c<0)continue;const f=l%e,u=Math.floor(l/e),p=f+je[c][0],h=u+je[c][1];if(p<0||h<0||p>=e||h>=t)continue;const g=h*e+p;d[g]+=d[l]}return d}function bp(e,t,n){const r=e*t,o=Array.from({length:r},()=>[]);for(let i=0;i<r;i+=1){const a=n[i];if(a<0)continue;const d=i%e,l=Math.floor(i/e),c=d+je[a][0],f=l+je[a][1];if(c<0||f<0||c>=e||f>=t)continue;const u=f*e+c;o[u].push(i)}return o}function yp(e,t,n,r,o,i,a){const d=e*t,l=a.riverFlowThreshold*a.flowMultiplier,c=a.tributaryThreshold*a.flowMultiplier,f=a.mouthExpansionThreshold*a.flowMultiplier,u=[];for(let b=0;b<d;b+=1)n[b]==="land"&&r[b]>=l&&(n[b]="river",u.push(b));for(;u.length;){const b=u.pop(),S=o[b];if(S>=0){const x=b%e,k=Math.floor(b/e),T=x+je[S][0],A=k+je[S][1];if(T>=0&&A>=0&&T<e&&A<t){const L=A*e+T;n[L]==="land"&&r[L]>=c&&(n[L]="river",u.push(L))}}for(const x of i[b])n[x]==="land"&&r[x]>=c&&(n[x]="river",u.push(x))}const p=[];for(let b=0;b<d;b+=1){if(n[b]!=="river")continue;const S=o[b];if(S<0)continue;const x=b%e,k=Math.floor(b/e),T=x+je[S][0],A=k+je[S][1];if(T<0||A<0||T>=e||A>=t)continue;const L=A*e+T;(n[L]==="ocean"||n[L]==="lake")&&p.push(b)}const h=new Uint8Array(d),g=4;for(;p.length;){const S=[{idx:p.shift(),depth:0}];for(;S.length;){const{idx:x,depth:k}=S.shift();if(!h[x]&&(h[x]=1,r[x]>=f*Math.max(.25,1-k*.2))){n[x]="river";const T=x%e,A=Math.floor(x/e);for(let L=0;L<4;L+=1){const[R,z]=je[L*2],H=T+R,_=A+z;if(H<0||_<0||H>=e||_>=t)continue;const I=_*e+H;n[I]==="land"&&r[I]>=c*.6&&(n[I]="river",S.push({idx:I,depth:k+1}))}if(k<g)for(const L of i[x])!h[L]&&n[L]==="land"&&S.push({idx:L,depth:k+1})}}}}function wp(e,t,n,r,o,i,a,d){const l=e*t;let c=-1,f=-1/0;const u=a+Math.max(.03,d.estuaryWideningDepth??.05);for(let p=0;p<l;p+=1){const h=n[p];if(h!=="land"&&h!=="river"&&h!=="marsh")continue;const g=p%e,b=Math.floor(p/e);let S=!1;for(const[H,_]of je){const I=g+H,s=b+_;if(!(I<0||s<0||I>=e||s>=t)&&n[s*e+I]==="ocean"){S=!0;break}}if(!S)continue;const x=r[p],k=o[p],T=Math.max(0,u-x),A=Math.max(0,a+.08-k),L=i[p],R=(h==="river"?1.15:1)+(h==="marsh"?.1:0),z=L*(1+T*5)*R+A*150;z>f&&(f=z,c=p)}return c}function xp(e,t,n,r,o){if(e<0)return[];const i=new Uint8Array(t.length),a=[{idx:e,depth:0}];i[e]=1;const d=Math.max(r.riverFlowThreshold,r.tributaryThreshold)*r.flowMultiplier*.8,l=[];for(;a.length;){const f=a.shift();for(const u of t[f.idx]){if(i[u])continue;i[u]=1;const p=f.depth+1,h=n[u];h>=d&&l.push({idx:u,acc:h,depth:p}),a.push({idx:u,depth:p})}}l.sort((f,u)=>u.acc!==f.acc?u.acc-f.acc:u.depth-f.depth);const c=[];for(const f of l)if(c.push(f.idx),c.length>=o)break;return c}function Dc(e,t,n,r,o,i,a){var _,I;if(n===r)return[n];const d=e*t,l=new Ic,c=new Float64Array(d),f=new Uint8Array(d),u=new Int32Array(d);c.fill(Number.POSITIVE_INFINITY),u.fill(-1);const p=a.slopeWeight??35,h=a.heuristicWeight??1,g=a.radiusWeight??1.5,b=a.elevationWeight??40,S=a.avoidOcean??!1,x=r%e,k=Math.floor(r/e),T=((_=a.confluenceCenter)==null?void 0:_.x)??x,A=((I=a.confluenceCenter)==null?void 0:I.y)??k,L=Math.max(0,a.confluenceRadius??0),R=a.maxElevation??Number.POSITIVE_INFINITY;c[n]=0,l.push({index:n,value:0});for(let s=l.pop();s;s=l.pop()){const{index:F,value:Y}=s;if(Y>c[F])continue;if(F===r)break;if(f[F])continue;f[F]=1;const Z=F%e,re=Math.floor(F/e);for(let ke=0;ke<je.length;ke+=1){const ye=je[ke][0],We=je[ke][1],Ye=Z+ye,Xe=re+We;if(Ye<0||Xe<0||Ye>=e||Xe>=t)continue;const Ve=Xe*e+Ye;if(S&&i[Ve]==="ocean"&&Ve!==r)continue;const ve=ke%2===0?1:Math.SQRT2,Ge=Math.max(0,o[Ve]-o[F])*p,xt=Math.hypot(Ye-T,Xe-A),Ft=xt>L?(xt-L)*g:0,Ke=o[Ve]>R?(o[Ve]-R)*b:0,Rt=Ge+Ft+Ke,Qe=c[F]+ve+Rt;if(Qe>=c[Ve])continue;c[Ve]=Qe,u[Ve]=F;const mt=Math.hypot(Ye-x,Xe-k)*h;l.push({index:Ve,value:Qe+mt})}}if(u[r]===-1)return null;const z=[r];let H=r;for(;H!==n;){if(H=u[H],H===-1)return null;z.push(H)}return z.reverse(),z}function Oc(e,t,n,r,o,i={}){if(!e||e.length===0)return 0;const d=i.skipLast??!1?e.length-1:e.length;for(let l=0;l<d;l+=1){const c=e[l];t[c]!=="ocean"&&t[c]!=="lake"&&(t[c]="river")}for(let l=0;l<e.length-1;l+=1){const c=e[l],f=e[l+1],u=c%r,p=Math.floor(c/r),h=f%r,g=Math.floor(f/r),b=fp(h-u,g-p);b>=0&&(n[c]=b)}return d}function vp(e,t,n,r,o,i,a){if(!n||!n.length)return;const d=Math.max(.01,a??.05);for(const l of n){const c=o[l];if(c>i+d)continue;const f=i+d-c,u=Math.min(3,Math.max(1,Math.round(1+f/d))),p=l%e,h=Math.floor(l/e);for(let g=-u;g<=u;g+=1)for(let b=-u;b<=u;b+=1){const S=p+b,x=h+g;if(S<0||x<0||S>=e||x>=t||Math.hypot(b,g)>u+.25)continue;const k=x*e+S;r[k]==="ocean"||r[k]==="lake"||(r[k]="river")}}}function Sp(e,t,n,r,o,i,a,d,l){if(n<0)return 0;const c=Math.max(1,d.distributaryMin??2),f=Math.max(c,d.distributaryMax??c),u=f-c+1,p=n%e,h=Math.floor(n/e),g=Math.max(2,d.estuaryRadius??4),b=g*g,S=[];for(let H=Math.max(0,h-g);H<=Math.min(t-1,h+g);H+=1)for(let _=Math.max(0,p-g);_<=Math.min(e-1,p+g);_+=1){const I=_-p,s=H-h;if(I*I+s*s>b)continue;const F=H*e+_;r[F]==="ocean"&&S.push(F)}if(!S.length)return 0;const x=os(l??0,n),k=c+(u>0?x%u:0),T=Math.min(f,Math.max(c,k));let A=0;const L=new Set;let R=0;const z=S.length*4;for(;A<T&&R<z;){const H=os(l??0,n*131+A*17+R+1),_=S[H%S.length];if(R+=1,L.has(_))continue;const I=Dc(e,t,n,_,i,r,{slopeWeight:30,heuristicWeight:.9,radiusWeight:1.2,confluenceCenter:{x:p,y:h},confluenceRadius:g,maxElevation:a+(d.estuaryWideningDepth??.06)*1.4,elevationWeight:90,avoidOcean:!1});!I||I.length<2||(Oc(I,r,o,e,t,{skipLast:r[I[I.length-1]]==="ocean"}),L.add(_),A+=1)}return A}function kp(e,t,n,r,o){if(n<0||o<=0)return;const i=n%e,a=Math.floor(n/e),d=o*o,l=[],c=[];for(let f=Math.max(0,a-o);f<=Math.min(t-1,a+o);f+=1)for(let u=Math.max(0,i-o);u<=Math.min(e-1,i+o);u+=1){const p=u-i,h=f-a;if(p*p+h*h>d)continue;const g=f*e+u;if(r[g]!=="land")continue;let b=0,S=0;for(const[x,k]of je){const T=u+x,A=f+k;if(T<0||A<0||T>=e||A>=t)continue;const L=r[A*e+T];L!=="land"&&(b+=1,L==="ocean"&&(S+=1))}S>=3||b>=5?l.push(g):b>=3&&c.push(g)}for(const f of l)r[f]="ocean";for(const f of c)r[f]==="land"&&(r[f]="marsh")}function Cp({width:e,height:t,types:n,flow:r,accumulation:o,upstream:i,filled:a,rules:d,seed:l,seaLevel:c,elevations:f}){const u={mainChannels:0,tributaries:0,distributaries:0},p=wp(e,t,n,f,a,o,c,d);if(p<0)return u;const h=Math.max(2,d.distributaryMax??3),g=xp(p,i,o,d,h);if(!g.length)return u;const b={x:p%e,y:Math.floor(p/e)},S=Math.max(2,d.confluenceRadius??Math.round((d.estuaryRadius??4)*.75));let x=[];for(let T=0;T<g.length;T+=1){const A=g[T],L=Dc(e,t,A,p,a,n,{slopeWeight:45,heuristicWeight:1,radiusWeight:2,confluenceCenter:b,confluenceRadius:S,maxElevation:c+(d.estuaryWideningDepth??.06)*1.25,elevationWeight:70,avoidOcean:!0});!L||L.length<2||(Oc(L,n,r,e,t,{skipLast:!1}),L.length>x.length&&(x=L))}if(!x.length)return n[p]==="land"&&(n[p]="river"),u;u.mainChannels=x.length,u.tributaries=Math.max(0,g.length-1),vp(e,t,x,n,a,c,d.estuaryWideningDepth);const k=Sp(e,t,p,n,r,a,c,d,l);return u.distributaries=k,kp(e,t,p,n,Math.round(d.estuaryRadius??4)),u}function Mp(e,t,n,r){if(r.marshiness<=0)return;const o=e*t,i=r.marshiness,a=Math.max(1,Math.trunc(r.marshRingWidth)),d=new Uint8Array(o);for(let l=0;l<o;l+=1){if(n[l]!=="lake"&&n[l]!=="river"&&n[l]!=="ocean")continue;const c=l%e,f=Math.floor(l/e);for(let u=-a;u<=a;u+=1)for(let p=-a;p<=a;p+=1){if(p===0&&u===0)continue;const h=c+p,g=f+u;if(h<0||g<0||h>=e||g>=t)continue;const b=g*e+h;if(n[b]!=="land")continue;const S=Math.hypot(p,u);Math.max(0,1-S/(a+.5))*i>=.4&&(d[b]=1)}}for(let l=0;l<o;l+=1)d[l]&&(n[l]="marsh")}function Ep(e,t,n){const r=e*t,o=i=>i!=="land";for(let i=0;i<r;i+=1){if(n[i]!=="land")continue;const a=i%e,d=Math.floor(i/e),l=[[[-1,-1],[1,1]],[[-1,1],[1,-1]]];for(const c of l){const[f,u]=c,p=a+f[0],h=d+f[1],g=a+u[0],b=d+u[1];if(p<0||h<0||p>=e||h>=t||g<0||b<0||g>=e||b>=t)continue;const S=h*e+p,x=b*e+g;if(o(n[S])&&o(n[x])){n[i]="marsh";break}}}}function Tp(e,t,n){const r=e*t,o=[];for(let p=0;p<r;p+=1){if(n[p]!=="land")continue;const h=p%e,g=Math.floor(p/e);je.some(([S,x])=>{const k=h+S,T=g+x;return k<0||T<0||k>=e||T>=t?!1:n[T*e+k]==="ocean"})&&o.push(p)}if(!o.length)return;const i=new Uint8Array(r);let a=0;const d=new Set,l=[],c=[];for(const p of o){if(i[p])continue;l.length=0,l.push(p),i[p]=1;const h=[];for(;l.length;){const g=l.shift();h.push(g);const b=g%e,S=Math.floor(g/e);for(const[x,k]of je){const T=b+x,A=S+k;if(T<0||A<0||T>=e||A>=t)continue;const L=A*e+T;i[L]||n[L]!=="land"||!je.some(([z,H])=>{const _=T+z,I=A+H;return _<0||I<0||_>=e||I>=t?!1:n[I*e+_]==="ocean"})||(i[L]=1,l.push(L))}}h.length>a&&(a=h.length,d.clear(),h.forEach(g=>d.add(g))),c.push(h)}if(!d.size||d.size===o.length)return;const f=new Set,u=[];c.forEach(p=>{if(!(!p.length||d.has(p[0])))for(p.forEach(h=>{f.has(h)||(u.push(h),f.add(h))});u.length;){const h=u.pop();n[h]="ocean";const g=h%e,b=Math.floor(h/e);for(const[S,x]of je){const k=g+S,T=b+x;if(k<0||T<0||k>=e||T>=t)continue;const A=T*e+k;n[A]==="land"&&(d.has(A)||f.has(A)||(f.add(A),u.push(A)))}}})}function Ap(e,t,n,r,o){const i=e*t,a=[],d=je;for(let c=0;c<i;c+=1){if(n[c]==="land")continue;const f=c%e,u=Math.floor(c/e);let p=0;for(let h=0;h<d.length;h+=1){const g=f+d[h][0],b=u+d[h][1];if(g<0||b<0||g>=e||b>=t)continue;const S=b*e+g;if(n[S]!=="land"&&(p+=1,p>0))break}p===0&&a.push({idx:c,priority:r[c]})}const l=Math.max(0,Math.floor(i*o));if(!(a.length<=l)){a.sort((c,f)=>c.priority-f.priority);for(let c=0;c<a.length-l;c+=1)n[a[c].idx]="land"}}const Np=new Set(["water","ocean","lake","river","marsh","mangrove"]);function ul(e,t,n,r,o,i){const a=e*t,d=1e-4,l=1e-6;let c=0;for(let f=0;f<a;f+=1){const u=n[f],p=r[f]-o[f];if(o[f]<=i+l||Np.has(u)){c+=1;continue}p>d&&u==="lake"&&(c+=1)}return c/a}function fl(e,t){let n=0;for(let r=0;r<e.length;r+=1)e[r]<=t&&(n+=1);return n/Math.max(1,e.length)}function pl({width:e,height:t,elevationGrid:n,rules:r,seed:o,seaLevel:i}){const a=pp(e,t,n,i),{types:d,spill:l}=mp(e,t,n,a,i,r),c=hp(e,t,n,a,d,o),f=gp(e,t,c,d,a),u=bp(e,t,c);yp(e,t,d,f,c,u,r);const p=Cp({width:e,height:t,types:d,flow:c,accumulation:f,upstream:u,filled:a,rules:r,seed:o,seaLevel:i,elevations:n});return Lp(e,t,d,c),Mp(e,t,d,r),Ep(e,t,d),Tp(e,t,d),Ap(e,t,d,l,r.maxSingletonFraction),{filled:a,types:d,spill:l,flow:c,accumulation:f,riverStats:p}}function Lp(e,t,n,r){const o=e*t,i=je,a=new Uint8Array(o);for(let d=0;d<o;d+=1){if(n[d]!=="river"||a[d])continue;const l=[d],c=[];let f=!1;for(;l.length;){const u=l.pop();if(a[u])continue;a[u]=1,c.push(u);const p=u%e,h=Math.floor(u/e);if(n[u]==="lake"||n[u]==="ocean"){f=!0;continue}const g=r[u];if(g>=0){const b=p+i[g][0],S=h+i[g][1];if(b>=0&&S>=0&&b<e&&S<t){const x=S*e+b;a[x]||l.push(x)}}for(let b=0;b<i.length;b+=1){const S=p+i[b][0],x=h+i[b][1];if(S<0||x<0||S>=e||x>=t)continue;const k=x*e+S;(n[k]==="lake"||n[k]==="ocean")&&(f=!0),n[k]==="river"&&!a[k]&&l.push(k)}}if(!f)for(const u of c)n[u]="land",r[u]=-1}}function Bp(e){const{width:t,height:n,elevations:r,seed:o,biome:i,world:a}=e,d=up(i,a,t,n),l=t*n,c=new Float64Array(l);for(let ve=0;ve<n;ve+=1){const nt=r[ve]||[];for(let Ge=0;Ge<t;Ge+=1)c[ve*t+Ge]=Bn(nt[Ge]??0,0,1)}const f=.32,u=.05,p=6,h=.012;let g=Bn(d.seaLevel,.02,.95),b=null;const S=[];let x=null,k=null,T=null,A=null,L=g;const R=.02;for(let ve=0;ve<p;ve+=1){const nt=pl({width:t,height:n,elevationGrid:c,rules:d,seed:o,seaLevel:g}),Ge=fl(c,g),xt=ul(t,n,nt.types,nt.filled,c,g),Ft=Math.abs(Ge-f);let Ke=0;for(let Qe=0;Qe<nt.types.length;Qe+=1)nt.types[Qe]==="ocean"&&(Ke+=1);const Rt=Ke/l;if(S.push({iteration:ve+1,seaLevel:g,coverage:Ge,surfaceCoverage:xt}),(!b||Ft<b.delta)&&(Rt>=R||!b)&&(b={...nt,coverage:Ge,surfaceCoverage:xt,delta:Ft,seaLevel:g,iterations:ve+1,oceanFraction:Rt}),Ft<=u&&Rt>=R)break;if(Ge>f)if(k=g,A=Ge,x!==null){const Qe=A-T;if(Qe>1e-6){const mt=x+(f-T)/Qe*(k-x),ht=Bn(mt,.02,.98);Math.abs(ht-g)>1e-5?g=ht:g=Bn((x+k)/2,.02,.98)}else g=Bn((x+k)/2,.02,.98)}else g=Bn(g-h,.02,.98);else if(x=g,T=Ge,k!==null){const Qe=A-T;if(Qe>1e-6){const mt=x+(f-T)/Qe*(k-x),ht=Bn(mt,.02,.98);Math.abs(ht-g)>1e-5?g=ht:g=Bn((x+k)/2,.02,.98)}else g=Bn((x+k)/2,.02,.98)}else g=Bn(g+h,.02,.98);if(Math.abs(g-L)<1e-5&&x!==null&&k!==null)break;L=g}const z=b??pl({width:t,height:n,elevationGrid:c,rules:d,seed:o,seaLevel:g}),H=z.seaLevel??g,_=z.coverage??fl(c,H),I=z.surfaceCoverage??ul(t,n,z.types,z.filled,c,H),s=z.iterations??p,F=Pa(t,n,z.filled),Y=Pa(t,n,z.types),Z=[],re=Pa(t,n,z.accumulation);for(let ve=0;ve<n;ve+=1){const nt=[];for(let Ge=0;Ge<t;Ge+=1){const xt=z.flow[ve*t+Ge];xt<0?nt.push(null):nt.push({dx:je[xt][0],dy:je[xt][1]})}Z.push(nt)}const ke=F,ye={...d,seaLevel:H},We=z.riverStats??{mainChannels:0,tributaries:0,distributaries:0},Ye=(_*100).toFixed(2),Xe=(I*100).toFixed(2),Ve=H.toFixed(3);return typeof console<"u"&&typeof console.debug=="function"&&console.debug(`[hydrology] water coverage ${Ye}% (surface ${Xe}%) after ${s} pass(es) (seaLevel=${Ve}) | rivers main=${We.mainChannels} trib=${We.tributaries} dist=${We.distributaries}`),{types:Y,flowDirections:Z,flowAccumulation:re,filledElevation:ke,waterTable:ke,rules:ye,seaLevel:H,waterCoverage:_,surfaceWaterCoverage:I,waterAdjustmentHistory:S,riverStats:We}}const Jn=[[1,0],[-1,0],[0,1],[0,-1]],oa=new Set(["water","ocean","lake","river","marsh","mangrove"]);function ja(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function Fp(e="mangrove"){let t=1779033703^String(e).length;for(let n=0;n<String(e).length;n+=1)t=Math.imul(t^String(e).charCodeAt(n),3432918353),t=t<<13|t>>>19;return(n,r,o="")=>{let i=t;const a=`${e}:${n}:${r}:${o}`;for(let d=0;d<a.length;d+=1)i=Math.imul(i^a.charCodeAt(d),3432918353),i=i<<13|i>>>19;return i=Math.imul(i^i>>>16,2246822507),i=Math.imul(i^i>>>13,3266489909),i=(i^=i>>>16)>>>0,(i>>>0)/4294967295}}function Rp(e){var a;const t=Array.isArray(e)?e.length:0,n=t&&((a=e[0])==null?void 0:a.length)||0,r=Array.from({length:t},()=>new Array(n).fill(1/0));if(!t||!n)return r;const o=[];let i=0;for(let d=0;d<t;d+=1){const l=e[d];if(l)for(let c=0;c<n;c+=1){const f=l[c];oa.has(f)||(r[d][c]=0,o.push({x:c,y:d}))}}for(;i<o.length;){const d=o[i++],{x:l,y:c}=d,f=r[c][l];for(let u=0;u<Jn.length;u+=1){const p=Jn[u][0],h=Jn[u][1],g=l+p,b=c+h;g<0||b<0||g>=n||b>=t||r[b][g]<=f+1||(r[b][g]=f+1,o.push({x:g,y:b}))}}return r}function _a(e,t,n){var d,l;const r=e.length,o=((d=e[0])==null?void 0:d.length)||0;let i=!1,a=!1;for(let c=0;c<Jn.length;c+=1){const f=Jn[c][0],u=Jn[c][1],p=t+f,h=n+u;if(p<0||h<0||p>=o||h>=r)continue;const g=(l=e[h])==null?void 0:l[p];oa.has(g)?g==="river"&&(a=!0):i=!0}return{touchesLand:i,touchesRiver:a}}function $p({hydrology:e,elevations:t,random:n,seed:r,maxDistance:o=3,maxDepth:i=.12,surfaceAllowance:a=.05}={}){var T,A,L,R,z,H,_,I;if(!((T=e==null?void 0:e.types)!=null&&T.length))return{placed:0,expanded:0,invalidNeighbors:0};const d=e.types,l=d.length,c=((A=d[0])==null?void 0:A.length)||0;if(!c)return{placed:0,expanded:0,invalidNeighbors:0};const f=typeof n=="function"?n:Fp(r??e.seed??"mangrove"),u=Rp(d),p=Number.isFinite(e==null?void 0:e.seaLevel)?e.seaLevel:0,h=(e==null?void 0:e.waterTable)||(e==null?void 0:e.filledElevation)||null,g=[],b=Array.from({length:l},()=>new Array(c).fill(0));for(let s=0;s<l;s+=1){const F=d[s];if(F)for(let Y=0;Y<c;Y+=1){const Z=F[Y];if(!Z||Z==="river"||!oa.has(Z)||Z==="mangrove")continue;const re=(L=u[s])==null?void 0:L[Y];if(!Number.isFinite(re)||re>o)continue;const{touchesLand:ke,touchesRiver:ye}=_a(d,Y,s);if(!ke&&!ye)continue;const We=(R=t==null?void 0:t[s])==null?void 0:R[Y],Ye=(z=h==null?void 0:h[s])==null?void 0:z[Y],Xe=Number.isFinite(Ye)?Ye:p;if(!Number.isFinite(Xe))continue;const Ve=Math.max(0,Xe-(Number.isFinite(We)?We:Xe));if(Ve>i||Xe>p+a)continue;const ve=ja(1-Ve/Math.max(i,1e-6),0,1),nt=ja(1-re/(o+.5),0,1),Ge=ye?.15:0,xt=ke?.05:0,Ft=ja(.3+nt*.35+ve*.3+Ge+xt,.12,.85);f(Y,s,"mangrove-base")<=Ft&&(g.push({x:Y,y:s}),b[s][Y]=1)}}let S=0;for(let s=0;s<l;s+=1)for(let F=0;F<c;F+=1){if(b[s][F])continue;const Y=(H=d[s])==null?void 0:H[F];if(!Y||Y==="river"||!oa.has(Y))continue;const Z=(_=u[s])==null?void 0:_[F];if(!Number.isFinite(Z)||Z>o+1)continue;const{touchesLand:re,touchesRiver:ke}=_a(d,F,s);if(!re&&!ke)continue;let ye=0;for(let We=0;We<Jn.length;We+=1){const Ye=Jn[We][0],Xe=Jn[We][1],Ve=F+Ye,ve=s+Xe;Ve<0||ve<0||Ve>=c||ve>=l||(I=b[ve])!=null&&I[Ve]&&(ye+=1)}ye>=2&&f(F,s,"mangrove-growth")<.55&&(b[s][F]=1,g.push({x:F,y:s}),S+=1)}let x=0,k=0;for(let s=0;s<g.length;s+=1){const{x:F,y:Y}=g[s],{touchesLand:Z,touchesRiver:re}=_a(d,F,Y);if(!Z&&!re){x+=1;continue}d[Y][F]="mangrove",k+=1}return typeof console<"u"&&typeof console.debug=="function"&&console.debug(`[mangrove] placed ${k} tile(s) with ${S} expansion pass placements; invalid neighbors: ${x}`),{placed:k,expanded:S,invalidNeighbors:x}}const To=100,zc=64,Zr=zc,Ea=zc,Pc={water:"💧",ocean:"🌊",lake:"🟦",river:"〰️",marsh:"🪴",mangrove:"🪷",open:"🌾",grassland:"🌿",plains:"🌾",savanna:"🌾",tundra:"❄️",taiga:"🌲",desert:"🏜️",sand:"🏖️",wetland:"🪴",coast:"🏖️",temperate:"🌱",tropical:"🌴",rainforest:"🌿",jungle:"🌴",alpine:"🏔️",swamp:"🪵",island:"🏝️",mountain:"⛰️",volcanic:"🌋",forest:"🌲",ore:"⛏️",stone:"🪨"},fo=Object.freeze({water:"#2d7ff9",ocean:"#2563eb",lake:"#38bdf8",river:"#0ea5e9",marsh:"#4ade80",mangrove:"#065f46",open:"#facc15",grassland:"#a3e635",forest:"#16a34a",ore:"#f97316",stone:"#94a3b8",desert:"#f4b76b",tundra:"#9ac5ff",taiga:"#2f6b2a",savanna:"#f59e0b",rainforest:"#047857",jungle:"#0f766e",swamp:"#14532d",wetland:"#22c55e",sand:"#fcd34d",coast:"#0ea5e9",island:"#38bdf8",mountain:"#64748b",alpine:"#60a5fa",volcanic:"#ea580c",temperate:"#4ade80",tropical:"#10b981",plains:"#facc15"}),Hp=Object.freeze({water:"--legend-water",ocean:"--legend-ocean",lake:"--legend-lake",river:"--legend-river",marsh:"--legend-marsh",mangrove:"--legend-mangrove",open:"--legend-open",grassland:"--legend-grassland",forest:"--legend-forest",ore:"--legend-ore",stone:"--legend-stone",desert:"--legend-desert",tundra:"--legend-tundra",taiga:"--legend-taiga",savanna:"--legend-savanna",rainforest:"--legend-rainforest",jungle:"--legend-jungle",swamp:"--legend-swamp",wetland:"--legend-wetland",sand:"--legend-sand",coast:"--legend-coast",island:"--legend-island",mountain:"--legend-mountain",alpine:"--legend-alpine",volcanic:"--legend-volcanic",temperate:"--legend-temperate",tropical:"--legend-tropical",plains:"--legend-plains"});let Si=null;function Ip(e,t){if(!e||typeof e.getPropertyValue!="function")return"";try{return e.getPropertyValue(t)||""}catch{return""}}function Dp(){let e=null;if(typeof document<"u"&&document.documentElement)try{e=getComputedStyle(document.documentElement)}catch{e=null}const t={};for(const[n,r]of Object.entries(Hp)){const o=fo[n],i=Ip(e,r).trim();t[n]=i||o}return t}function ml({forceRefresh:e=!1}={}){if(e&&(Si=null),Si)return{...Si};const t=Dp();return Si=t,{...t}}new Proxy({},{get(e,t){if(typeof t=="string"){const n=ml();if(Object.prototype.hasOwnProperty.call(n,t))return n[t];if(Object.prototype.hasOwnProperty.call(fo,t))return fo[t]}},has(e,t){return Object.prototype.hasOwnProperty.call(fo,t)},ownKeys(){return Reflect.ownKeys(fo)},getOwnPropertyDescriptor(e,t){if(Object.prototype.hasOwnProperty.call(fo,t))return{configurable:!0,enumerable:!0,value:ml()[t],writable:!1}}});const jc=new Set(["water","ocean","lake","river","marsh","mangrove"]);function Tn(e){return e?jc.has(e):!1}function Ta(e=Zr,t=Ea,n=0,r=0){const o=Math.max(1,Math.trunc(e)),i=Math.max(1,Math.trunc(t)),a=Math.floor(o/2),d=Math.floor(i/2);return{xStart:Math.round(n)-a,yStart:Math.round(r)-d}}function Op(e){let t=1779033703^e.length;for(let n=0;n<e.length;n++)t=Math.imul(t^e.charCodeAt(n),3432918353),t=t<<13|t>>>19;return function(){return t=Math.imul(t^t>>>16,2246822507),t=Math.imul(t^t>>>13,3266489909),(t^=t>>>16)>>>0}}function zp(e){return function(){let t=e+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function Jo(e,t,n,r=""){return zp(Op(`${e}:${t}:${n}:${r}`)())()}function Ao(e,t,n,r=""){return Jo(e,t,n,r)}function Ct(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function qa(e,t,n){return e+(t-e)*n}function Pp(e,t,n,r=0,o=0,i=100){if(!Array.isArray(e)||e.length===0)return{total:0,land:0,water:0,ore:0,usable:0};const a=i*i,d={total:0,land:0,water:0,ore:0,usable:0};for(let l=0;l<e.length;l++){const c=e[l];if(!c)continue;const u=n+l-o;if(!(u*u>a))for(let p=0;p<c.length;p++){const h=c[p];if(!h)continue;const b=t+p-r;if(!(b*b+u*u>a)){if(d.total++,Tn(h)){d.water++;continue}d.land++,h==="ore"?d.ore++:d.usable++}}}return d}function is(e,t,n,r=0,o=0,i=100,a={minLand:.5,maxOre:.4}){const d=Pp(e,t,n,r,o,i),l=Math.max(1,d.total),c=Math.max(1,d.usable),f=Ct(d.land/l,0,1),u=Ct(d.ore/c,0,1),p=Number.isFinite(a==null?void 0:a.minLand)?a.minLand:.5,h=Number.isFinite(a==null?void 0:a.maxOre)?a.maxOre:.4;return{stats:d,landRatio:f,oreRatio:u,meetsLand:f>=p,meetsOre:u<=h}}function jp(e,t){return Math.round(Math.hypot(e,t))}const _c=16;function _p({width:e,height:t,tiles:n,terrainTypes:r,chunkSize:o=_c}){const i=Math.max(1,Math.trunc(o)),a=Math.ceil(Math.max(1,Math.trunc(e))/i),d=Math.ceil(Math.max(1,Math.trunc(t))/i);function l(u,p){const h=u*i,g=p*i;for(let b=0;b<i;b++){const S=h+b;if(S>=t)break;const x=r[S],k=n[S];if(!(!x||!k))for(let T=0;T<i;T++){const A=g+T;if(A>=e)break;const L=x[A];k[A]=Pc[L]||"?"}}}function c(){for(let u=0;u<d;u++)for(let p=0;p<a;p++)l(u,p)}function f({full:u=!1,chunks:p=[]}={}){if(u){c();return}!Array.isArray(p)||p.length===0||p.forEach(h=>{if(!h)return;const g=Math.trunc(h.row),b=Math.trunc(h.column);Number.isNaN(g)||Number.isNaN(b)||g<0||b<0||g>=d||b>=a||l(g,b)})}return{chunkSize:i,chunkRows:d,chunkColumns:a,renderAll:c,renderDirty:f,renderChunk:l}}function qp(e,t,n,r=100,o={minLand:.5,maxOre:.4},i={}){if(!Array.isArray(e)||e.length===0)return null;const a=(i==null?void 0:i.centerX)??0,d=(i==null?void 0:i.centerY)??0,l=Ct(Math.trunc((i==null?void 0:i.limit)??200),1,2e3),c=[];for(let p=0;p<e.length;p++){const h=e[p];if(h)for(let g=0;g<h.length;g++){const b=h[g];if(!b||Tn(b))continue;const S=t+g,x=n+p,k=Math.hypot(S-a,x-d);c.push({row:p,col:g,worldX:S,worldY:x,distance:k})}}c.sort((p,h)=>p.distance!==h.distance?p.distance-h.distance:p.worldY!==h.worldY?p.worldY-h.worldY:p.worldX-h.worldX);let f=null;const u=Math.min(l,c.length);for(let p=0;p<u;p++){const h=c[p],g=is(e,t,n,h.worldX,h.worldY,r,o),b=g.landRatio-g.oreRatio*.2,S={...h,validation:g,score:b};if(g.meetsLand&&g.meetsOre)return S;(!f||S.score>f.score)&&(f=S)}return f}function qc(e,t,n,r,o){const i=t/r,a=n/r,d=Math.floor(i),l=Math.floor(a),c=d+1,f=l+1,u=i-d,p=a-l,h=Jo(e,d,l,o),g=Jo(e,c,l,o),b=Jo(e,d,f,o),S=Jo(e,c,f,o),x=qa(h,g,u),k=qa(b,S,u);return qa(x,k,p)}function Wp(e,t,n,r){return qc(e,t,n,r,"veg")}function Up(e,t,n,r){return qc(e,t,n,r,"ore")}function Cr(e,t=Date.now(),n=null,r=null,o=Zr,i=o,a=C.time.season,d,l=null,c=null,f=!1){var Ue,Me,vt,St;const u=Math.max(1,Math.trunc(o)),p=Math.max(1,Math.trunc(i??o??Zr)),{xStart:h,yStart:g}=Ta(u,p);let b=Number.isFinite(n)?Math.trunc(n):h,S=Number.isFinite(r)?Math.trunc(r):g;const x=b,k=S,T=Mr(e),A=bc(T),L=xr(c||{}),R=L.advanced||{},z=(L.rainfall-50)/100,H=(L.temperature-50)/100,_=(L.mountains-50)/100,I=(L.waterTable-50)/100;(L.rivers100-50)/100,(L.lakes100-50)/100;let s=(T==null?void 0:T.openLand)??.5;s+=H*.18,s-=z*.22,s-=Math.max(0,_)*.12,s=Ct(s,.1,.9);const F=Ct(20+s*80,10,140),Y=Ct(F+((R.vegetationScale??50)-50)/50*25,8,160),Z=((Ue=T==null?void 0:T.elevation)==null?void 0:Ue.base)??.5,re=((Me=T==null?void 0:T.elevation)==null?void 0:Me.variance)??.5,ke=((vt=T==null?void 0:T.elevation)==null?void 0:vt.scale)??50,ye={base:Ct(Z+I*-.12+z*-.08+_*.05+((R.elevationBase??50)-50)/100*.3,.05,.95),variance:Ct(re+_*.45+((R.elevationVariance??50)-50)/100*.5,.05,1.5),scale:Ct(ke+_*40+((R.elevationScale??50)-50)/100*70,12,200)},We=Ct(.95-L.oreDensity/100*.35,.55,.98),Ye=Ct(We-((R.oreThresholdOffset??50)-50)/100*.2,.5,.98),Xe=Ct(10+(R.oreNoiseScale??50)/100*24,6,40),Ve=Array.from({length:p},()=>Array(u).fill("?")),ve=Array.from({length:p},()=>new Array(u)),nt=Array.from({length:p},()=>new Array(u)),Ge=[],xt=Math.max(u,p)*1.2,Ft=lp(t,{base:ye.base,variance:ye.variance,scale:ye.scale,worldScale:xt,maskStrength:Ct(.5+_*.2-I*.1,.25,.85),maskBias:Ct((I+z)*-.08,-.25,.2)});for(let Ee=0;Ee<p;Ee++){const le=[];for(let te=0;te<u;te++){const Te=x+te,Ae=k+Ee,Oe=Ft.sample(Te,Ae);le.push(Oe)}Ge.push(le)}const Ke=Bp({seed:t,width:u,height:p,elevations:Ge,biome:T?{id:T.id,features:T.features,elevation:T.elevation}:null,world:L}),Rt=$p({hydrology:Ke,elevations:Ge,seed:t,random:(Ee,le,te="")=>Ao(t,x+Ee,k+le,`mangrove:${te}`)});Rt&&(Ke.mangroveStats=Rt);const Qe=Ke.waterTable??Ke.filledElevation;let mt=0;const ht=Ke.types.map(Ee=>Ee.slice());function Ne(Ee){var fe,ie,W,Le,Se,ge;const le=Ct(Ee,0,1);Ke.seaLevel=le,Ke.rules&&(Ke.rules.seaLevel=le);const te=Array.from({length:p},()=>new Array(u).fill(0)),Te=Ct(Ye-.08,.3,.92),Ae=[],Oe=Array.from({length:p},()=>new Array(u));for(let U=0;U<p;U++)for(let ae=0;ae<u;ae++){const Fe=Ge[U][ae];let K=((fe=ht[U])==null?void 0:fe[ae])??"land"??"land";K==="ocean"||K==="lake"?Fe>=le&&(K="land"):(K==="land"||K==="coast"||K==="marsh")&&Fe<le&&(K="ocean"),Oe[U][ae]=K}const at=[[-1,0],[1,0],[0,-1],[0,1]],me=(U,ae,Fe)=>{var we;let J=!1,K=!1;for(let de=0;de<at.length;de+=1){const he=at[de][0],ne=at[de][1],Re=ae+he,Mt=Fe+ne;if(Re<0||Mt<0||Re>=u||Mt>=p)continue;const cn=(we=U[Mt])==null?void 0:we[Re];if(jc.has(cn)?cn==="river"&&(K=!0):J=!0,J&&K)break}return{touchesLand:J,touchesRiver:K}};for(let U=0;U<p;U++)for(let ae=0;ae<u;ae++){if(((ie=ht[U])==null?void 0:ie[ae])!=="mangrove")continue;if(Ge[U][ae]<le){Oe[U][ae]="ocean";continue}const{touchesLand:J,touchesRiver:K}=me(Oe,ae,U);!J&&!K&&(Oe[U][ae]="ocean")}for(let U=0;U<p;U++){const ae=ve[U],Fe=nt[U],J=te[U];for(let K=0;K<u;K++){const we=x+K,de=k+U,he=((W=Oe[U])==null?void 0:W[K])??"land";Ke.types[U][K]=he;let ne,Re=0;he&&he!=="land"?ne=he:(ne=Wp(t,we,de,Y)<s?A:"forest",Re=Up(t,we,de,Xe)),Fe[K]=ne,ae[K]=ne,J[K]=Re}}for(let U=0;U<p;U++){const ae=ve[U],Fe=nt[U];for(let J=0;J<u;J++)Ke.types[U][J]==="land"&&(Ge[U][J]<le||te[U][J]<=Te||(Fe[J]="stone",ae[J]!=="ore"&&(ae[J]="stone")))}for(let U=0;U<p;U++){const ae=ve[U],Fe=nt[U];for(let J=0;J<u;J++)Ke.types[U][J]==="land"&&(Ge[U][J]<le||te[U][J]<=Ye||(Fe[J]="stone",ae[J]="ore",Ae.push([J,U])))}if(Ae.length){const U=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(const[ae,Fe]of Ae)if(((Le=ve[Fe])==null?void 0:Le[ae])==="ore")for(const[J,K]of U){const we=ae+J,de=Fe+K;if(we<0||de<0||we>=u||de>=p)continue;const he=ve[de],ne=nt[de];!he||!ne||he[we]!=="ore"&&(Tn(he[we])||(ne[we]="stone",he[we]="stone"))}for(const[ae,Fe]of Ae){if(((Se=ve[Fe])==null?void 0:Se[ae])!=="ore"||U.some(([de,he])=>{var Mt;const ne=ae+de,Re=Fe+he;return ne<0||Re<0||ne>=u||Re>=p?!1:((Mt=ve[Re])==null?void 0:Mt[ne])==="stone"}))continue;let K=null,we=1/0;for(const[de,he]of U){const ne=ae+de,Re=Fe+he;if(ne<0||Re<0||ne>=u||Re>=p)continue;const Mt=ve[Re],cn=nt[Re];if(!Mt||!cn)continue;const rr=Mt[ne];if(Tn(rr))continue;if(rr!=="ore"){K={nx:ne,ny:Re},we=-1;break}const Ie=(ge=te[Re])==null?void 0:ge[ne];Number.isFinite(Ie)&&Ie<we&&(we=Ie,K={nx:ne,ny:Re})}if(K){const{nx:de,ny:he}=K,ne=ve[he],Re=nt[he];ne&&Re&&(Re[de]="stone",ne[de]="stone")}}}}Ne(Ke.seaLevel);const At=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];function rt({includeClusters:Ee=!1}={}){var fe;const le=[];for(let ie=0;ie<p;ie++)for(let W=0;W<u;W++){const Le=(fe=ve[ie])==null?void 0:fe[W];if(!Le||Tn(Le))continue;At.some(([ge,U])=>{var J;const ae=W+ge,Fe=ie+U;return ae<0||Fe<0||ae>=u||Fe>=p?!1:((J=Ke.types[Fe])==null?void 0:J[ae])==="ocean"})&&le.push([W,ie])}if(!le.length)return{length:0,largest:0,ratio:1,clusters:[],largestIndex:-1};const te=new Set,Te=new Set(le.map(([ie,W])=>W*u+ie));let Ae=0,Oe=-1;const at=Ee?[]:null;let me=0;for(const[ie,W]of le){const Le=W*u+ie;if(te.has(Le))continue;const Se=[[ie,W]];te.add(Le);let ge=0;const U=Ee?[]:null;for(;Se.length;){const[ae,Fe]=Se.shift();ge+=1,U&&U.push([ae,Fe]);for(const[J,K]of At){const we=ae+J,de=Fe+K;if(we<0||de<0||we>=u||de>=p)continue;const he=de*u+we;!Te.has(he)||te.has(he)||(te.add(he),Se.push([we,de]))}}ge>Ae&&(Ae=ge,Oe=me),U&&(at.push({size:ge,tiles:U}),me+=1)}return{length:le.length,largest:Ae,ratio:Ae/le.length,clusters:at??[],largestIndex:Oe}}const Q=_p({width:u,height:p,tiles:Ve,terrainTypes:ve,chunkSize:_c});Q.renderAll();const _e=Ke.seaLevel;function xn(Ee){const le=Ct(Ee,-.2,.2);return Math.abs(le-mt)<1e-6?!1:(mt=le,Ne(_e+mt),Q.renderAll(),!0)}function vn(){var me;const Ee=rt({includeClusters:!0});if(!Ee.clusters.length||Ee.largestIndex<0)return!1;const le=Ee.clusters[Ee.largestIndex];if(!le||!((me=le.tiles)!=null&&me.length))return!1;const te=new Set,Te=(fe,ie)=>{if(fe<0||ie<0||fe>=u||ie>=p)return;const W=Math.floor(ie/Q.chunkSize),Le=Math.floor(fe/Q.chunkSize);W<0||Le<0||W>=Q.chunkRows||Le>=Q.chunkColumns||te.add(`${W}:${Le}`)},Ae=(fe,ie)=>{if(fe<0||ie<0||fe>=u||ie>=p)return!1;const W=ve[ie],Le=Ke.types[ie];if(!W||!Le)return!1;let Se=!1;const ge=W[fe];return(!ge||Tn(ge))&&(W[fe]=A,Se=!0),Le[fe]!=="land"&&(Le[fe]="land",Se=!0),Se&&Te(fe,ie),Se},Oe=(fe,ie,W,Le)=>{const Se=[];let ge=Math.trunc(fe),U=Math.trunc(ie);const ae=Math.trunc(W),Fe=Math.trunc(Le);let J=Math.abs(ae-ge),K=Math.abs(Fe-U);const we=ge<ae?1:-1,de=U<Fe?1:-1;let he=J-K;for(;ge!==ae||U!==Fe;){Se.push([ge,U]);const ne=he*2;ne>-K&&(he-=K,ge+=we),ne<J&&(he+=J,U+=de)}return Se.push([ge,U]),Se};let at=!1;if(Ee.clusters.forEach((fe,ie)=>{var U;if(!((U=fe==null?void 0:fe.tiles)!=null&&U.length)||ie===Ee.largestIndex)return;let W=null,Le=1/0;for(const[ae,Fe]of fe.tiles)for(const[J,K]of le.tiles){const we=ae-J,de=Fe-K,he=we*we+de*de;he<Le&&(Le=he,W={from:[ae,Fe],to:[J,K]})}if(!W)return;const Se=Oe(W.from[0],W.from[1],W.to[0],W.to[1]);let ge=!1;for(let ae=1;ae<Se.length-1;ae++){const[Fe,J]=Se[ae];ge=Ae(Fe,J)||ge}ge&&(at=!0)}),at){const fe=Array.from(te).map(ie=>{const[W,Le]=ie.split(":").map(Se=>Number.parseInt(Se,10));return{row:W,column:Le}});Q.renderDirty({chunks:fe,full:!1})}return at}const $t=()=>Ke.seaLevel+1e-5,He=(Ee,le)=>{var Oe;const te=(Oe=ve[Ee])==null?void 0:Oe[le];if(te&&Tn(te))return!0;const Te=Qe==null?void 0:Qe[Ee];if(!Te)return!1;const Ae=Te[le];return Number.isFinite(Ae)&&Ae<=$t()};function gt(Ee,le){let te=null;for(let Te=0;Te<p;Te++)if(ve[Te])for(let Oe=0;Oe<u;Oe++){if(He(Te,Oe))continue;const at=Ee+Oe,me=le+Te,fe=Math.hypot(at,me);(!te||fe<te.distance||fe===te.distance&&(Math.abs(me)<Math.abs(te.worldY)||Math.abs(me)===Math.abs(te.worldY)&&Math.abs(at)<Math.abs(te.worldX)))&&(te={worldX:at,worldY:me,distance:fe})}return te}let Ot=Number.isFinite(d)?Ct(d,0,1):Ke.seaLevel,Ze=0,st=0;const ft={minLand:.5,maxOre:.4},lt=100,ln=(c==null?void 0:c.seed)??t;let ce=null,Qt=[];if(!f){ce=new rp({parameters:{xStart:b,yStart:S,originShiftX:Ze,originShiftY:st,seaLevelAdjustment:mt},maxIterations:6,chunkSize:Q.chunkSize,chunkRows:Q.chunkRows,chunkColumns:Q.chunkColumns,gridWidth:u,gridHeight:p,evaluate:({parameters:te})=>{const Te=te.originShiftX||0,Ae=te.originShiftY||0,Oe=te.xStart-Te,at=te.yStart-Ae,me=is(ve,Oe,at,0,0,lt,ft),fe=rt(),ie=-Oe,W=-at,Le=ie>=0&&ie<u&&W>=0&&W<p,Se=Le&&He(W,ie),ge=fe.ratio>=.95,U=me.landRatio-me.oreRatio*.2-(Se?.25:0);return{...me,satisfied:me.meetsLand&&me.meetsOre&&!Se&&ge,xStart:Oe,yStart:at,originShiftX:te.originShiftX,originShiftY:te.originShiftY,seaLevelAdjustment:te.seaLevelAdjustment||0,coastline:fe,coastlineSatisfied:ge,coastlineRatio:fe.ratio,origin:{col:ie,row:W,inBounds:Le,isWater:Se},thresholds:ft,radius:lt,seed:ln,baseXStart:te.xStart,baseYStart:te.yStart,score:U}},regenerate:({parameters:te,metrics:Te,context:Ae})=>{var Le,Se,ge,U,ae,Fe;if(!Te)return null;const Oe=Ae==null?void 0:Ae.solver,at=(J,K)=>{Oe&&(!Number.isFinite(J)||!Number.isFinite(K)||Oe.markTileDirty(J,K))},me=te.originShiftX||0,fe=te.originShiftY||0,ie=te.xStart-me,W=te.yStart-fe;if((Le=Te.origin)!=null&&Le.isWater){const J=gt(ie,W);if(J){at(Te.origin.col,Te.origin.row);const K={originShiftX:me+J.worldX,originShiftY:fe+J.worldY,seaLevelAdjustment:te.seaLevelAdjustment||0},we=te.xStart-K.originShiftX,de=te.yStart-K.originShiftY;at(-we,-de);const he=jp(J.worldX,J.worldY),ne=he>0?`Shifted the landing ${he} tiles to escape flooded ground.`:"Shifted the landing away from flooded ground.";return{parameters:K,message:ne}}}if(!Te.meetsLand){const J=te.seaLevelAdjustment||0,K=Ct(J-.02,-.3,.2);if(K!==J&&((Se=Ae.applySeaLevelAdjustment)==null?void 0:Se.call(Ae,K)))return{parameters:{xStart:te.xStart,yStart:te.yStart,originShiftX:me,originShiftY:fe,seaLevelAdjustment:K},message:"Lowered the sea level to reveal additional shoreline.",markAllDirty:!0}}if(!Te.meetsLand||!Te.meetsOre){const J=qp(ve,ie,W,lt,ft,{limit:400}),K=J==null?void 0:J.validation;if(J&&(K!=null&&K.meetsLand)&&(K!=null&&K.meetsOre)&&!((ge=K.origin)!=null&&ge.isWater)&&(J.worldX!==0||J.worldY!==0)){at((U=Te.origin)==null?void 0:U.col,(ae=Te.origin)==null?void 0:ae.row);const we={originShiftX:me+J.worldX,originShiftY:fe+J.worldY,seaLevelAdjustment:te.seaLevelAdjustment||0},de=te.xStart-we.originShiftX,he=te.yStart-we.originShiftY;at(-de,-he);const ne=J.distance>0?`Relocated the landing ${J.distance} tiles for better terrain.`:"Relocated the landing for improved terrain.";return{parameters:we,message:ne}}}if(!Te.meetsOre)return{parameters:{originShiftX:me,originShiftY:fe,seaLevelAdjustment:te.seaLevelAdjustment||0},message:"Expanded the survey radius to balance nearby resources."};if(Number.isFinite(Te.coastlineRatio)&&Te.coastlineRatio<.95){const J=te.seaLevelAdjustment||0,K=Ct(J+.02,-.3,.3);if(K!==J&&((Fe=Ae.applySeaLevelAdjustment)==null?void 0:Fe.call(Ae,K)))return{parameters:{xStart:te.xStart,yStart:te.yStart,originShiftX:me,originShiftY:fe,seaLevelAdjustment:K},message:"Raised the sea level to smooth the coastline.",markAllDirty:!0}}return{stop:!0}}}).solve({applySeaLevelAdjustment:xn}),Qt=ce!=null&&ce.messages?[...ce.messages]:[],ce!=null&&ce.dirty&&Q.renderDirty(ce.dirty);let le=!1;for(let te=0;te<6&&!(!vn()||(le=!0,rt().ratio>=.95));te+=1);le&&Qt.push("Smoothed minor coastline fragments for continuity."),ce!=null&&ce.parameters&&(Ze=ce.parameters.originShiftX||0,st=ce.parameters.originShiftY||0,b=ce.parameters.xStart-Ze,S=ce.parameters.yStart-st)}Number.isFinite(d)||(Ot=Ke.seaLevel);const Sn=rt(),kn=is(ve,b,S,0,0,lt,ft),nr=-b,Nt=-S,Je=nr>=0&&nr<u&&Nt>=0&&Nt<p,ue=Je&&He(Nt,nr),ct={...kn,xStart:b,yStart:S,originShiftX:Ze,originShiftY:st,seaLevelAdjustment:((St=ce==null?void 0:ce.parameters)==null?void 0:St.seaLevelAdjustment)||0,coastline:Sn,coastlineRatio:Sn.ratio,coastlineSatisfied:Sn.ratio>=.95,origin:{col:nr,row:Nt,inBounds:Je,isWater:ue},satisfied:kn.meetsLand&&kn.meetsOre&&!ue&&Sn.ratio>=.95};if(!f&&Qt.length){const Ee=ct?` (land ${Math.round(ct.landRatio*100)}% • ore ${Math.round(ct.oreRatio*100)}% of usable land)`:"",le=Qt.join(" ");tp(`Adjusted landing zone for fairness: ${le}${Ee}`,{metrics:ct,history:ce.history,iterations:ce.iterations})}const Ut=l?{xStart:Number.isFinite(l.xStart)?Math.trunc(l.xStart-Ze):b,yStart:Number.isFinite(l.yStart)?Math.trunc(l.yStart-st):S,width:Math.max(1,Math.trunc(l.width??u)),height:Math.max(1,Math.trunc(l.height??p))}:{xStart:b,yStart:S,width:u,height:p};return{scale:100,seed:t,xStart:b,yStart:S,width:u,height:p,tiles:Ve,types:ve,substrateTypes:nt,elevations:Ge,season:a,waterLevel:Ot,hydrology:Ke,solver:{metrics:ct,history:(ce==null?void 0:ce.history)??[],iterations:(ce==null?void 0:ce.iterations)??0,messages:Qt},worldSettings:L,viewport:Ut,openTerrainType:A}}const Yp=new Set(["ore","stone"]);function Xp(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}function Wc(e){if(!e||!Array.isArray(e.types))return{forest:0,cleared:0};const t=Xp(To)**2||0;let n=0,r=0;return e.types.forEach(o=>{o.forEach(i=>{i==="forest"?n+=1:(Yp.has(i)||wr(i))&&(r+=1)})}),{forest:n*t,cleared:r*t}}function as(e){if(!e||e.siteCapacities&&typeof e.siteCapacities=="object")return e;const t=Wc(e.map);return e.siteCapacities=t,e.id&&C.updateItem("locations",{id:e.id,siteCapacities:t}),e}function hl(e,t,n=C.time.season,r=Date.now(),o=null){var g;const i=((g=Mr(t))==null?void 0:g.features)||[],a=Yd(t),d=Zr,l=Ea,{xStart:c,yStart:f}=Ta(d,l),u=Cr(t,r,c,f,d,l,n,void 0,void 0,o,!1),p=Wc(u),h={id:e,biome:t,features:i,pointsOfInterest:a,map:u,siteCapacities:p,worldSettings:u.worldSettings};return C.addItem("locations",h),h}function Bo(){return[...C.locations.values()].map(e=>as(e))}function Gp(e){if(!e){const n=Bo()[0];return n&&as(n).siteCapacities||{forest:0,cleared:0}}const t=C.getItem("locations",e);return t?as(t).siteCapacities||{forest:0,cleared:0}:{forest:0,cleared:0}}const Qn=new Map;function li(){if(!(C.unlockedBuildings instanceof Set)){const e=Array.isArray(C.unlockedBuildings)?C.unlockedBuildings:[];C.unlockedBuildings=new Set(e)}if(!(C.research instanceof Set)){const e=Array.isArray(C.research)?C.research:[];C.research=new Set(e)}typeof C.buildingSeq!="number"&&(C.buildingSeq=0)}function Vp(e,t={}){return Object.entries(t).forEach(([n,r])=>{!Number.isFinite(r)||r===0||(e[n]=(e[n]||0)+r)}),e}function Ir(e={}){return Object.fromEntries(Object.entries(e).map(([t,n])=>[t,n]))}function dr(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}function Kp(e={}){if(!e)return null;const t=[];if(Array.isArray(e.categories)&&e.categories.forEach(f=>{if(!f&&f!==0)return;const u=String(f).trim().toLowerCase();u&&t.push(u)}),e.category){const f=String(e.category).trim().toLowerCase();f&&t.push(f)}const n=[...new Set(t)];if(!n.length)return null;const r=e.dimensions||{},o=dr(r.width),i=dr(r.depth),a=e.accessClearance||{},d=dr(a.side),l={front:dr(a.front),back:dr(a.back),left:dr(a.left)||d,right:dr(a.right)||d};let c=dr(e.surfaceArea);if(!c){const f=o+l.left+l.right,u=i+l.front+l.back;f>0&&u>0&&(c=f*u)}return{categories:n,primaryCategory:n[0],surfaceArea:c,dimensions:{width:o,depth:i},accessClearance:l,raw:{...e}}}function Zp(){return Bo()[0]||null}function Jp(e,t){if(!e||!t)return 0;Tr();const n=String(t).toLowerCase();let r=0;return C.buildings.forEach(o=>{var l;if(o.locationId!==e)return;const i=Qn.get(o.typeId),a=(l=i==null?void 0:i.stats)==null?void 0:l.site;!a||!a.surfaceArea||String(o.siteCategory||a.primaryCategory||"").toLowerCase()!==n||(r+=a.surfaceArea||0)}),r}function Qp(e,t){var l,c;const n=(l=e==null?void 0:e.stats)==null?void 0:l.site;if(!n||!n.surfaceArea||!((c=n.categories)!=null&&c.length))return{siteOk:!0,status:null};if(!t){const f=n.categories.map(u=>({category:u,capacity:0,usage:0,remaining:0}));return{siteOk:!1,status:{categories:f,selected:f[0]||null}}}const r=Gp(t.id),o=n.categories.map(f=>{const u=(r==null?void 0:r[f])??0,p=Jp(t.id,f),h=u-p;return{category:f,capacity:u,usage:p,remaining:h}}),i=n.surfaceArea||0;let a=o.find(f=>f.remaining>=i-1e-6);return!a&&o.length&&(a=o[0]),{siteOk:!!(a&&a.remaining>=i-1e-6),status:{categories:o,selected:a||null}}}function em(e={}){var r,o;const t=Kp((r=e.requirements)==null?void 0:r.site),n={totalLaborHours:0,minBuilders:Math.max(1,((o=e.requirements)==null?void 0:o.minBuilders)||1),totalResources:{},components:[],addons:[],site:t,coreComponent:null,coreResources:{},coreLaborHours:0};if((e.components||[]).forEach((i,a)=>{const d=Math.max(0,i.laborHours||0),l=Math.max(1,i.minBuilders||1);n.totalLaborHours+=d,n.minBuilders=Math.max(n.minBuilders,l);const c=Ir(i.resources||{});Vp(n.totalResources,c);const f=!!i.isCore||!n.coreComponent&&a===0,u={...i,isCore:f,laborHours:d,minBuilders:l,resources:c};n.components.push(u),f&&!n.coreComponent&&(n.coreComponent=u,n.coreResources=Ir(c),n.coreLaborHours=d)}),!n.coreComponent&&n.components.length){const i=n.components[0];i.isCore=!0,n.coreComponent=i,n.coreResources=Ir(i.resources||{}),n.coreLaborHours=i.laborHours||0}return(e.addons||[]).forEach(i=>{const a=Math.max(0,i.laborHours||0),d=Math.max(1,i.minBuilders||1),l=Ir(i.resources||{});n.addons.push({...i,laborHours:a,minBuilders:d,resources:l,totals:{laborHours:a,resources:Ir(l)}})}),n.totalLaborHours<=0&&(n.totalLaborHours=n.minBuilders),n}function tm(e){if(!(e!=null&&e.id)||Qn.has(e.id))return;const t=em(e);Qn.set(e.id,{...e,stats:t})}function nm(e=[],t=""){if(!t)return!0;const n=t.toLowerCase();return e.some(r=>r.toLowerCase().includes(n))}function rm(e,t=null){var a,d;const n=((a=e.requirements)==null?void 0:a.locationTags)||[];if(!n.length)return!0;const r=n.map(l=>String(l||"").toLowerCase());if(r.some(l=>l==="open"||l==="any"))return!0;const o=t?[t]:Bo();if(!o.length)return!1;const i=(((d=o[0])==null?void 0:d.features)||[]).map(l=>l.toLowerCase());return r.some(l=>nm(i,l))}function gl(e){return li(),C.research.has(e)}function io(e){return!e&&e!==0?[]:Array.isArray(e)?e:[e]}function bl(e){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number")return{id:String(e),count:1};if(e&&typeof e=="object"){const t=e.id??e.building??e.type;if(!t&&t!==0)return null;const n=Number.isFinite(e.count)?Math.max(1,e.count):Number.isFinite(e.required)?Math.max(1,e.required):1;return{id:String(t),count:n}}return null}function Uc(e={}){if(!e)return{ok:!1,missing:null};if(e.always)return{ok:!0,missing:null};let t=!0;const n={technologies:[],anyTechnology:[],research:[],anyResearch:[],buildings:[],anyBuilding:[],resources:[],custom:!1};if(e.custom&&typeof e.custom=="function")try{e.custom(C)||(t=!1,n.custom=!0)}catch(c){console.warn("Building unlock custom check failed",c),t=!1,n.custom=!0}const r=io(e.technologies).map(c=>c||c===0?String(c):null).filter(Boolean);if(r.length){const c=r.filter(f=>!yn(f));c.length&&(t=!1,n.technologies=[...new Set(c)])}const o=io(e.anyTechnology).map(c=>c||c===0?String(c):null).filter(Boolean);o.length&&(o.some(f=>yn(f))||(t=!1,n.anyTechnology=[...new Set(o)]));const i=io(e.research).map(c=>c||c===0?String(c):null).filter(Boolean);if(i.length){const c=i.filter(f=>!gl(f));c.length&&(t=!1,n.research=[...new Set(c)])}const a=io(e.anyResearch).map(c=>c||c===0?String(c):null).filter(Boolean);a.length&&(a.some(f=>gl(f))||(t=!1,n.anyResearch=[...new Set(a)]));const d=io(e.buildings).map(bl).filter(Boolean);if(d.length){const c=[];d.forEach(f=>{const u=Oi(f.id,{statuses:["completed"]});u<f.count&&c.push({id:f.id,required:f.count,current:u})}),c.length&&(t=!1,n.buildings=c)}const l=io(e.anyBuilding).map(bl).filter(Boolean);if(l.length&&(l.some(f=>Oi(f.id,{statuses:["completed"]})>=f.count)||(t=!1,n.anyBuilding=l.map(f=>({id:f.id,required:f.count,current:Oi(f.id,{statuses:["completed"]})})))),e.resources){const c=zi(e.resources);c.missing.length&&(t=!1,n.resources=c.missing.map(f=>({name:f.name,required:f.required,available:f.available})))}return Object.keys(n).forEach(c=>{const f=n[c];Array.isArray(f)&&!f.length&&delete n[c],(f===!1||f===null)&&delete n[c]}),{ok:t,missing:Object.keys(n).length?n:null}}function Yc(e={}){return!!Uc(e).ok}function yl(e){if(!e&&e!==0)return;const t=lu(e);t!=null&&t.definition?hc(e):(li(),C.research.add(String(e)))}function om(e){var r;const t=(r=e==null?void 0:e.effects)==null?void 0:r.unlocks;if(!t)return;(Array.isArray(t)?t:[t]).forEach(o=>{if(!(!o&&o!==0)){if(typeof o=="string"||typeof o=="number"){yl(o);return}if(o&&typeof o=="object"){const i=o.technology??o.tech??o.id;(i||i===0)&&yl(i)}}})}function im(e){return li(),C.unlockedBuildings.has(e.id)?!0:Yc(e.unlock)?(C.unlockedBuildings.add(e.id),!0):!1}function am(e){return Number.isFinite(e.maxCount)?e.maxCount:e.allowMultiple?1/0:1}function Tr(){C.buildings instanceof Map||(C.buildings=new Map(C.buildings||[]))}function Oi(e,{statuses:t=null}={}){Tr();const n=t?new Set(t):null;let r=0;return C.buildings.forEach(o=>{o.typeId===e&&(n&&!n.has(o.status)||(r+=1))}),r}function No(e){if(!e&&e!==0)return!1;Tr();const t=String(e).toLowerCase();let n=!1;return C.buildings.forEach(r=>{n||r.status==="completed"&&String(r.typeId).toLowerCase()===t&&(n=!0)}),n}function zi(e={}){const t=[],n={};return Object.entries(e).forEach(([r,o])=>{if(!o||o<=0)return;const i=oi(r).quantity||0;n[r]={required:o,available:i,deficit:Math.max(0,o-i)},i<o&&t.push({name:r,required:o,available:i})}),{missing:t,totals:n}}function sm(e={}){const t={wood:0,stone:0,metal:0};return Object.entries(e).forEach(([n,r])=>{const o=Math.max(0,Number(r)||0);if(!o)return;const i=String(n).toLowerCase();/(wood|log|timber|lumber|beam|board|plank|sapling|pole|stave|branch)/.test(i)&&(t.wood+=o),/(stone|rock|clay|brick|adobe|mortar|slate|granite|cobbl|marble)/.test(i)&&(t.stone+=o),/(metal|ingot|iron|copper|bronze|steel|nail|spike|ore)/.test(i)&&(t.metal+=o)}),t}function lm(e={}){const t=sm(e),n=Object.entries(t).filter(([,a])=>a>0);if(!n.length)return{primary:"construction",extras:[]};const[r]=n.reduce((a,d)=>d[1]>a[1]?d:a,n[0]),o=[],i=(a,d)=>{!a||d<=0||o.some(l=>l.id===a)||o.push({id:a,effortScale:d})};switch(r){case"stone":i("masonry",.7);break;case"wood":i("carpentry",.7);break;case"metal":i("smelting",.55);break}return n.forEach(([a])=>{a!==r&&(a==="stone"&&i("masonry",.45),a==="wood"&&i("carpentry",.45),a==="metal"&&i("smelting",.35))}),{primary:"construction",extras:o}}function Xc(e){var b;const t=Qn.get(e);if(!t)return null;const n=im(t),r=am(t),o=Oi(e),i=o<r,a=Zp(),d=rm(t,a),{siteOk:l,status:c}=Qp(t,a),f=d&&l,u=zi(t.stats.coreResources),p=zi(t.stats.totalResources),h=zi(((b=t.requirements)==null?void 0:b.craftedGoods)||{}),g=Uc(t.unlock);return{type:t,unlocked:n,canBuildMore:i,terrainOk:d,siteOk:l,locationOk:f,hasResources:u.missing.length===0,resourceStatus:u,craftedStatus:h,totalResourceStatus:p,siteStatus:c,existing:o,maxCount:r,unlockStatus:g}}function cm(){return[...Qn.values()]}function dm(){return li(),C.buildingSeq+=1,`bld-${C.buildingSeq}`}function um(e,{workers:t,locationId:n,x:r=null,y:o=null}={}){var I,s,F,Y,Z,re;const i=Qn.get(e);if(!i)throw new Error(`Unknown building type ${e}`);const a=Xc(e);if(!(a!=null&&a.unlocked))throw new Error(`Building ${i.name} is not unlocked`);if(!a.canBuildMore)throw new Error(`No additional ${i.name} can be constructed right now`);if(!a.locationOk)throw new Error(`${i.name} cannot be built at this location`);if(!a.hasResources)throw new Error(`Insufficient resources to begin ${i.name}`);Tr();const d=Math.max(i.stats.minBuilders,t||i.stats.minBuilders||1),l=Math.max(1,i.stats.totalLaborHours),c=Ir(i.stats.totalResources),f=Ir(i.stats.coreResources),u=lm(c),p=((s=(I=a==null?void 0:a.siteStatus)==null?void 0:I.selected)==null?void 0:s.category)||((F=i.stats.site)==null?void 0:F.primaryCategory)||null,h=p?String(p).toLowerCase():null,g=((Y=i.stats.site)==null?void 0:Y.surfaceArea)||0,b=((Z=i.stats.coreComponent)==null?void 0:Z.id)||null,x=Number.isFinite(r)&&Number.isFinite(o)?{x:Math.trunc(r),y:Math.trunc(o)}:null,k=dm(),T={id:k,typeId:e,status:"under-construction",locationId:n||((re=Bo()[0])==null?void 0:re.id)||null,progressHours:0,totalLaborHours:l,assignedWorkers:d,requiredResources:c,consumedResources:{},addons:[],coreResources:f,coreComponentId:b,siteCategory:h,siteSurfaceArea:g,tile:x};C.addItem("buildings",T);const A=Math.max(1,Math.ceil(l/d)),L=d*A,R={};Object.entries(c).forEach(([ke,ye])=>{!ye||ye<=0||(R[ke]=ye/L)});const z=l/L,H=Object.values(c).reduce((ke,ye)=>ke+ye,0),_=Math.min(100,28+Math.log10(l+1)*18+Math.log10(H+1)*6);return{project:{...T},order:{type:"building",workers:d,hours:A,notes:`${i.name} construction`,metadata:{buildingTypeId:e,projectId:k,typeName:i.name,totalLaborHours:l,perWorkerHourResources:R,progressPerWorkerHour:z,baseComplexity:_,taskComplexity:_,effortHours:l,proficiencyId:u.primary,additionalProficiencies:u.extras.length?u.extras:void 0,taskId:`construction:${e}`,tile:x}}}}function fm(e,t=0){if(!t)return;Tr();const n=C.getItem("buildings",e);if(!n)return;const r=Math.min(n.totalLaborHours,(n.progressHours||0)+t);C.updateItem("buildings",{id:e,progressHours:r})}function pm(e,t={}){const n=Object.keys(t||{});if(!n.length)return;Tr();const r=C.getItem("buildings",e);if(!r)return;const o={...r.consumedResources||{}};n.forEach(i=>{const a=t[i];!Number.isFinite(a)||a<=0||(o[i]=(o[i]||0)+a)}),C.updateItem("buildings",{id:e,consumedResources:o})}function mm(e){Tr();const t=C.getItem("buildings",e);if(!t)return null;const n=an(t.typeId),r=sn?sn():null,o={id:e,status:"completed",progressHours:t.totalLaborHours,completedAt:r};return C.updateItem("buildings",o),n&&om(n),Aa(),{...t,...o}}function er({statuses:e=null}={}){Tr();const t=e?new Set(e):null;return[...C.buildings.values()].filter(n=>t?t.has(n.status):!0)}function Aa(){li(),Qn.forEach(e=>{Yc(e.unlock)&&C.unlockedBuildings.add(e.id)})}function an(e){return Qn.get(e)||null}function hm(){Qn.size>0||(pu.forEach(tm),Aa())}hm();const wl={open:"--tile-open",forest:"--tile-forest",stone:"--tile-stone",ore:"--tile-ore",water:"--tile-water",ocean:"--legend-ocean",lake:"--legend-lake",river:"--legend-river",marsh:"--legend-marsh",mangrove:"--legend-mangrove",grassland:"--legend-grassland",desert:"--legend-desert",tundra:"--legend-tundra",taiga:"--legend-taiga",savanna:"--legend-savanna",rainforest:"--legend-rainforest",jungle:"--legend-jungle",swamp:"--legend-swamp",wetland:"--legend-wetland",sand:"--legend-sand",coast:"--legend-coast",island:"--legend-island",mountain:"--legend-mountain",alpine:"--legend-alpine",volcanic:"--legend-volcanic",temperate:"--legend-temperate",tropical:"--legend-tropical",plains:"--legend-plains"},ss={open:"#facc15",forest:"#16a34a",stone:"#94a3b8",ore:"#f97316",water:"#2d7ff9",ocean:"#2563eb",lake:"#38bdf8",river:"#0ea5e9",marsh:"#4ade80",mangrove:"#065f46",grassland:"#a3e635",desert:"#f4b76b",tundra:"#9ac5ff",taiga:"#2f6b2a",savanna:"#f59e0b",rainforest:"#047857",jungle:"#0f766e",swamp:"#14532d",wetland:"#22c55e",sand:"#fcd34d",coast:"#0ea5e9",island:"#38bdf8",mountain:"#64748b",alpine:"#60a5fa",volcanic:"#ea580c",temperate:"#4ade80",tropical:"#10b981",plains:"#facc15"};let Pi=null;function gm(e,t){if(!e)return"";try{return e.getPropertyValue(t)||""}catch{return""}}function bm(){let e=null;if(typeof document<"u"&&document.documentElement)try{e=getComputedStyle(document.documentElement)}catch{e=null}const t={...ss};return Object.keys(wl).forEach(n=>{const r=n,o=wl[r],i=gm(e,o).trim();t[r]=i||ss[r]}),t}function Ls(e={}){const{forceRefresh:t=!1}=e;return(!Pi||t)&&(Pi=bm()),{...Pi}}Ls();function ym(e){const t=Pi??Ls(),n=typeof e=="string"&&e?e.toLowerCase():"open";return Object.prototype.hasOwnProperty.call(ss,n)?t[n]:t.open}function xl(e,t,n){return Number.isNaN(e)?t:t>n?e:e<t?t:e>n?n:e}function ki(e,t){return Number.isFinite(e)?e:t}function wm(e){var H,_;const t=e.minZoom&&Number.isFinite(e.minZoom)?Math.max(.05,e.minZoom):.1,n=e.maxZoom&&Number.isFinite(e.maxZoom)?Math.max(t,e.maxZoom):Math.max(t,8);let r=Math.max(0,Math.trunc(e.viewportWidth||0)),o=Math.max(0,Math.trunc(e.viewportHeight||0)),i=ki((H=e.centerTile)==null?void 0:H.x,0),a=ki((_=e.centerTile)==null?void 0:_.y,0),d=xl(Number.isFinite(e.initialZoom)?e.initialZoom:1,t,n),l=null,c=null,f=0,u=i,p=a,h=i,g=a,b=null,S=null,x=null;const k=I=>typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(I):setTimeout(()=>I(Date.now()),16),T=I=>{if(I!=null){if(typeof window<"u"&&typeof window.cancelAnimationFrame=="function"&&typeof I=="number"){window.cancelAnimationFrame(I);return}clearTimeout(I)}};function A(I=!1){l!==null&&(T(l),l=null),c=null,I&&(i=h,a=g),S=null,x=null,b=null}function L(I){const F=1-(I<0?0:I>1?1:I);return 1-F*F*F}function R(I,s){f=I,u=i,p=a,c=null,b=s;const F=Y=>{c===null&&(c=Y);const Z=Y-c,re=f>0?Math.min(1,Z/f):1,ke=b?b(re):re,ye=u+(h-u)*ke,We=p+(g-p)*ke;if(i=Number.isFinite(ye)?ye:h,a=Number.isFinite(We)?We:g,S&&S({x:i,y:a}),re>=1-1e-6){i=h,a=g,l=null,c=null;const Ye=S,Xe=x;S=null,x=null,b=null,Ye&&Ye({x:i,y:a}),Xe&&Xe({x:i,y:a});return}l=k(F)};l=k(F)}const z={get centerTile(){return{x:i,y:a}},get zoom(){return d},get minZoom(){return t},get maxZoom(){return n},get viewportWidth(){return r},get viewportHeight(){return o},setViewportSize(I,s){Number.isFinite(I)&&(r=Math.max(0,Math.trunc(I))),Number.isFinite(s)&&(o=Math.max(0,Math.trunc(s)))},setCenterTile(I,s={}){l!==null&&A(!1);const F=ki(I==null?void 0:I.x,i),Y=ki(I==null?void 0:I.y,a);i=Number.isFinite(F)?F:i,a=Number.isFinite(Y)?Y:a,s.snap&&(i=Math.round(i),a=Math.round(a))},setZoom(I,s="viewport"){const F=d;return d=xl(Number.isFinite(I)?I:F,t,n),d},panBy(I,s,F={}){l!==null&&A(!1),Number.isFinite(I)&&(i+=I),Number.isFinite(s)&&(a+=s),F.snap&&z.commitSnap()},commitSnap(I={}){const s=Math.round(i),F=Math.round(a),Y=Math.abs(s-i)>1e-6||Math.abs(F-a)>1e-6,Z=typeof I.onUpdate=="function"?I.onUpdate:null,re=typeof I.onComplete=="function"?I.onComplete:null;if(A(!1),!Y)return Z&&Z({x:i,y:a}),re&&re({x:i,y:a}),{targetX:s,targetY:F,changed:!1};if(!(I.animate!==!1))return i=s,a=F,Z&&Z({x:i,y:a}),re&&re({x:i,y:a}),{targetX:s,targetY:F,changed:!0};const ye=Math.max(Math.abs(s-i),Math.abs(F-a)),We=150,Ye=250,Xe=Number.isFinite(I.duration)?I.duration:We+Math.min(Ye-We,ye*40),Ve=Math.max(We,Math.min(Ye,Xe)),ve=typeof I.easing=="function"?I.easing:L;return h=s,g=F,S=Z,x=re,R(Ve,ve),{targetX:s,targetY:F,changed:!0}},worldToScreen(I,s,F){const Y=z.getScaledTileSize(F),Z=r/2+(I-i-.5)*Y,re=o/2+(s-a-.5)*Y;return{x:Z,y:re}},worldToScreenCenter(I,s,F){const Y=z.getScaledTileSize(F),Z=r/2+(I-i)*Y,re=o/2+(s-a)*Y;return{x:Z,y:re}},screenToTile(I,s,F){const Y=z.getScaledTileSize(F)||1,Z=i+(I-r/2)/Y+.5,re=a+(s-o/2)/Y+.5;return{x:Z,y:re}},getVisibleWorldBounds(I){const s=z.getScaledTileSize(I)||1,F=r/(2*s),Y=o/(2*s);return{minX:i-F-1,maxX:i+F+1,minY:a-Y-1,maxY:a+Y+1}},getScaledTileSize(I){return(Number.isFinite(I)&&I>0?I:1)*d}};return z}const xm=32,vm='"Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif';function Uo(e,t){if(typeof window>"u"||typeof document>"u")return t;try{return getComputedStyle(document.documentElement).getPropertyValue(e).trim()||t}catch{return t}}function Sm(e){const t=Uo("--accent","#f7c948"),n=Uo("--accent-strong","#d4a72c"),r=Uo("--warn","#ff9f47"),o=Uo("--accent-stronger","#f59e0b");switch((e==null?void 0:e.toLowerCase())||""){case"completed":case"complete":return n||t;case"under-construction":case"under construction":case"construction":case"in-progress":return r;case"planned":case"queued":return o||r;case"mixed":return Uo("--accent",r);default:return t}}class km{constructor(t,n){this.canvas=t;let r=null;try{r=t.getContext("2d")}catch{r=null}this.ctx=r,this.camera=n.camera,this.tileBaseSize=Math.max(2,Math.trunc(n.tileBaseSize||xm)),this.useTerrainColors=n.useTerrainColors??!1,this.getTerrainColor=n.getTerrainColor||(()=>null),this.devicePixelRatio=typeof window<"u"&&window.devicePixelRatio||1,this.viewportWidth=Math.max(1,this.camera.viewportWidth||this.canvas.clientWidth||1),this.viewportHeight=Math.max(1,this.camera.viewportHeight||this.canvas.clientHeight||1),this.map=null,this.developments=new Map,this.scale=this.camera.zoom,this.configureCanvasSize(this.viewportWidth,this.viewportHeight)}setTileBaseSize(t){!Number.isFinite(t)||t<=0||(this.tileBaseSize=Math.max(2,Math.trunc(t)))}setUseTerrainColors(t){this.useTerrainColors=!!t}setTerrainColorResolver(t){this.getTerrainColor=t}setScale(t){!Number.isFinite(t)||t<=0||(this.scale=t)}setMap(t){this.map=t}setDevelopments(t){this.developments=t}resize(t,n){const r=Math.max(1,Math.round(t)),o=Math.max(1,Math.round(n));this.viewportWidth=r,this.viewportHeight=o,this.camera.setViewportSize(r,o),this.configureCanvasSize(r,o)}render(){var l,c,f,u;if(!this.ctx)return;const t=this.ctx;if(t.save(),t.setTransform(this.devicePixelRatio,0,0,this.devicePixelRatio,0,0),t.clearRect(0,0,this.viewportWidth,this.viewportHeight),!this.map||!((l=this.map.tiles)!=null&&l.length)){t.restore();return}const n=Math.max(2,this.tileBaseSize*(this.scale||1)),r=Math.max(6,Math.floor(n*.78));t.font=`${r}px ${vm}`,t.textAlign="center",t.textBaseline="middle";const o=this.map.tiles.length,i=((c=this.map.tiles[0])==null?void 0:c.length)||0,a=this.map.xStart,d=this.map.yStart;for(let p=0;p<o;p++){const h=this.map.tiles[p];if(h)for(let g=0;g<i;g++){const b=h[g]??"",S=a+g,x=d+p,{x:k,y:T}=this.camera.worldToScreen(S,x,this.tileBaseSize),A=Math.round(k),L=Math.round(T),R=((u=(f=this.map.types)==null?void 0:f[p])==null?void 0:u[g])??null,z=this.useTerrainColors?this.getTerrainColor(R):null;z?(t.fillStyle=z,t.fillRect(A,L,Math.ceil(n),Math.ceil(n)),t.strokeStyle="rgba(0, 0, 0, 0.18)",t.lineWidth=Math.max(1,Math.round(n*.03)),t.strokeRect(A+.5,L+.5,Math.ceil(n)-1,Math.ceil(n)-1)):(t.fillStyle="rgba(0, 0, 0, 0)",t.fillRect(A,L,Math.ceil(n),Math.ceil(n))),b&&(t.fillStyle=z?"rgba(16, 24, 40, 0.92)":"rgba(15, 23, 42, 0.88)",t.fillText(b,A+n/2,L+n/2+n*.02));const H=`${S}:${x}`,_=this.developments.get(H)||null;_&&this.drawDevelopmentOverlay(t,A,L,n,_)}}t.restore()}hitTest(t,n){var h,g,b;if(!this.map||!((h=this.map.tiles)!=null&&h.length))return null;const r=this.camera.screenToTile(t,n,this.tileBaseSize),o=Math.floor(r.x),i=Math.floor(r.y),a=o-this.map.xStart,d=i-this.map.yStart;if(d<0||a<0||d>=this.map.height||a>=this.map.width)return null;const l=this.map.tiles[d];if(!l)return null;const c=l[a]??"",f=((b=(g=this.map.types)==null?void 0:g[d])==null?void 0:b[a])??null,u=`${o}:${i}`,p=this.developments.get(u)||null;return{x:o,y:i,col:a,row:d,symbol:c??"",type:f??null,development:p}}configureCanvasSize(t,n){this.devicePixelRatio=typeof window<"u"&&window.devicePixelRatio||1;const r=Math.max(1,Math.round(t*this.devicePixelRatio)),o=Math.max(1,Math.round(n*this.devicePixelRatio));this.canvas.width!==r&&(this.canvas.width=r),this.canvas.height!==o&&(this.canvas.height=o),this.canvas.style.width=`${t}px`,this.canvas.style.height=`${n}px`}drawDevelopmentOverlay(t,n,r,o,i){const a=Sm(i.status),d=Math.max(1,Math.round(o*.08)),l=Math.max(2,Math.round(o*.18));if(t.save(),t.lineWidth=d,t.strokeStyle=a,t.globalAlpha=.85,t.strokeRect(n+l,r+l,Math.max(1,o-l*2),Math.max(1,o-l*2)),i.emphasis||i.highlight){t.lineWidth=Math.max(d*.6,1),t.globalAlpha=.45;const c=Math.max(1,l-d*1.2);t.strokeRect(n+c,r+c,Math.max(1,o-c*2),Math.max(1,o-c*2))}t.restore()}}function Cm(e,t){return new km(e,t)}const vl=(e,t,n)=>Number.isNaN(e)||e<t?t:e>n?n:e;function Mm(e,t={}){const n=typeof t.size=="number"&&Number.isFinite(t.size)?`${t.size}px`:typeof t.size=="string"?t.size:"48px",r=t.variant||"square",o=t.fontSize||(r==="chip"?"16px":"18px"),i=r==="chip"||r==="stacked";e.style.width=i?"auto":n,e.style.minWidth=n,e.style.height=r==="stacked"?"auto":n,e.style.minHeight=n,e.style.padding=i?"0 12px":"0",e.style.fontSize=o,e.style.display="inline-flex",e.style.flexDirection=r==="stacked"?"column":"row",e.style.gap=r==="stacked"?"2px":"0",e.style.alignItems="center",e.style.justifyContent="center",e.style.borderRadius="12px",e.style.border="1px solid var(--map-control-border, var(--map-border, #ccc))",e.style.background="var(--map-control-bg, var(--bg-color, #fff))",e.style.color="var(--map-control-fg, inherit)",e.style.lineHeight="1.1",e.style.whiteSpace="nowrap",e.style.cursor="pointer",e.style.transition="background 0.2s ease, transform 0.1s ease",e.style.boxShadow="var(--map-control-shadow, 0 1px 2px rgba(0, 0, 0, 0.08))",e.style.fontWeight="600"}function Em(e){const t=e.styleButton||Mm,n=document.createElement("div");n.className="map-zoom-controls",n.style.display="flex",n.style.flexDirection="row",n.style.flexWrap="wrap",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.alignSelf="center",n.style.marginTop="12px",n.style.pointerEvents="auto";const r=(l,c,f)=>{const u=document.createElement("button");return u.type="button",u.textContent=l,u.setAttribute("aria-label",c),t(u,f),u},o=r("−","Zoom out",{fontSize:"22px",variant:"chip"}),i=r("+","Zoom in",{fontSize:"22px",variant:"chip"}),a=r("100%","Reset zoom to 100%",{fontSize:"15px",variant:"chip",size:64});return a.classList.add("map-zoom-reset"),o.addEventListener("click",l=>{l.preventDefault(),e.onZoomOut()}),i.addEventListener("click",l=>{l.preventDefault(),e.onZoomIn()}),a.addEventListener("click",l=>{l.preventDefault(),e.onZoomReset()}),n.appendChild(o),n.appendChild(i),n.appendChild(a),{element:n,update(l){var k,T,A;const c=((k=l.camera)==null?void 0:k.zoom)??l.zoom,f=((T=l.camera)==null?void 0:T.minZoom)??l.minZoom,u=((A=l.camera)==null?void 0:A.maxZoom)??l.maxZoom,p=Number.isFinite(l.baselineZoom)?l.baselineZoom:1,h=vl(c,0,Number.isFinite(u)?u:8),g=vl(f,0,h),b=u>0?u:Math.max(h,1),S=Math.round(h*100),x=Math.round(p*100);a.textContent=`${S}%`,a.setAttribute("aria-label",`Reset zoom to ${x}% (current ${S}%)`),o.disabled=h<=g+.001,i.disabled=h>=b-.001}}}class Gc{constructor(t,n){this.maxSize=Math.max(0,Math.trunc(t)),this.onEvict=typeof n=="function"?n:null,this.map=new Map}get size(){return this.map.size}get capacity(){return this.maxSize}setCapacity(t){const n=Math.max(0,Math.trunc(t));if(n!==this.maxSize){if(this.maxSize=n,this.maxSize===0){this.clear();return}this.evictIfNeeded()}}get(t){if(!this.map.has(t))return;const n=this.map.get(t);return this.map.delete(t),this.map.set(t,n),n}peek(t){return this.map.get(t)}set(t,n){if(this.maxSize<=0){this.handleEviction(t,n);return}if(this.map.has(t)){const r=this.map.get(t);this.map.delete(t),r!==void 0&&this.handleEviction(t,r)}this.map.set(t,n),this.evictIfNeeded()}has(t){return this.map.has(t)}delete(t){if(!this.map.has(t))return!1;const n=this.map.get(t);return this.map.delete(t),n!==void 0&&this.handleEviction(t,n),!0}clear(){if(this.map.size===0)return;const t=this.map.entries();for(const[n,r]of t)this.handleEviction(n,r);this.map.clear()}keys(){return this.map.keys()}values(){return this.map.values()}entries(){return this.map.entries()}evictIfNeeded(){if(this.maxSize<=0){this.clear();return}for(;this.map.size>this.maxSize;){const t=this.map.keys().next();if(t.done)break;const n=t.value,r=this.map.get(n);this.map.delete(n),r!==void 0&&this.handleEviction(n,r)}}handleEviction(t,n){if(this.onEvict)try{this.onEvict(t,n)}catch{}}}function Tm(e){if(typeof OffscreenCanvas<"u")return new OffscreenCanvas(e,e);if(typeof document<"u"&&typeof document.createElement=="function"){const t=document.createElement("canvas");return t.width=e,t.height=e,t}return{width:e,height:e,getContext:()=>null}}function Am(e,t){Number.isFinite(e.width)&&(e.width=t),Number.isFinite(e.height)&&(e.height=t)}function Wa(e){if(Number.isFinite(e.width)&&(e.width=0),Number.isFinite(e.height)&&(e.height=0),typeof e.transferToImageBitmap=="function")try{e.transferToImageBitmap()}catch{}}class Nm{constructor(t={}){this.maxPoolSize=Math.max(0,Math.trunc(t.maxPoolSize??48)),this.createCanvas=typeof t.createCanvas=="function"?t.createCanvas:Tm,this.pool=[]}get size(){return this.pool.length}acquire(t){const n=Math.max(1,Math.trunc(t)),r=this.pool.pop()??this.createCanvas(n);return Am(r,n),r}release(t){if(t){if(this.pool.length>=this.maxPoolSize){Wa(t);return}Wa(t),this.pool.push(t)}}clear(){if(this.pool.length)for(;this.pool.length;){const t=this.pool.pop();t&&Wa(t)}}}const ji=new Nm,Lm=256,Bm=96,ao=new Gc(Lm),so=new Gc(Bm,(e,t)=>{t&&ji.release(t)}),Fm=new Map([["complete","completed"],["completed","completed"],["built","completed"],["finished","completed"],["constructed","completed"],["constructing","under-construction"],["building","under-construction"],["under construction","under-construction"],["under-construction","under-construction"],["in-progress","under-construction"],["progress","under-construction"],["queued","planned"],["pending","planned"],["planned","planned"],["noted","noted"],["mixed","mixed"]].map(([e,t])=>[e,t])),Rm=Object.freeze({ArrowUp:{dx:0,dy:-1},ArrowDown:{dx:0,dy:1},ArrowLeft:{dx:-1,dy:0},ArrowRight:{dx:1,dy:0}}),$m=220,Hm="debug",Im="1";function Dm(){if(typeof window>"u"||typeof URLSearchParams>"u")return!1;try{return new URLSearchParams(window.location.search).get(Hm)===Im}catch{return!1}}function ia(e){return Number.isFinite(e)?Math.trunc(e):null}function lo(e,t,n){return!Number.isFinite(e)||t>n?e:Math.min(n,Math.max(t,e))}function Vc(e,t="noted"){if(!e)return t;const n=String(e).trim().toLowerCase();return Fm.get(n)||t}function Kc(e){return e?typeof e=="string"?e:e.name||e.label||e.title||e.typeName||e.typeId||(typeof e.toString=="function"?e.toString():"")||"":""}function Sl(e,t=0){var u,p;if(!e)return null;const n=typeof e=="object"?e:{structures:[e]},r=ia(n.x??n.col??n.column??n.tileX??((u=n.tile)==null?void 0:u.x)),o=ia(n.y??n.row??n.tileY??((p=n.tile)==null?void 0:p.y));if(r===null||o===null)return null;const a=(Array.isArray(n.structures)?n.structures:Array.isArray(n.projects)?n.projects:n.structure?[n.structure]:n.name?[n.name]:[]).map(h=>Kc(h)).map(h=>String(h||"").trim()).filter(Boolean),d=Vc(n.status||n.state||n.progress||null),l=[];n.tooltip&&l.push(String(n.tooltip)),n.details&&l.push(String(n.details)),n.description&&l.push(String(n.description)),l.length===0&&a.length&&l.push(a.join(", "));const c=n.label||(a.length?a[0]:"")||n.name||n.title||`Development ${t+1}`,f=Number.isFinite(n.count)?Math.max(0,Math.trunc(n.count)):a.length;return{x:r,y:o,status:d,structures:a,label:c,tooltip:l.join(" • "),count:f,emphasis:n.emphasis===!0,highlight:n.highlight===!0}}function kl(e){if(!e||typeof e!="object")return null;const t={};for(const[n,r]of Object.entries(e)){if(!n&&n!==0)continue;const o=String(n).trim().toLowerCase();if(!o||r==null)continue;const i=String(r).trim();i&&(t[o]=i)}return Object.keys(t).length?t:null}function Om(e){const t=[],n=[],r=[],o=[];e.items.forEach(c=>{const f=Kc(c),u=String(f||"").trim()||"Structure",p=Vc(c.status||c.state||c.progress||null,"planned");p==="completed"?t.push(u):p==="under-construction"?n.push(u):r.push(u),c.details?o.push(String(c.details)):c.description&&o.push(String(c.description))});const i=[];t.length&&i.push(`${t.length>1?"Completed structures":"Completed structure"}: ${t.join(", ")}`),n.length&&i.push(`${n.length>1,"Under construction"}: ${n.join(", ")}`),r.length&&i.push(`Planned: ${r.join(", ")}`),o.length&&i.push(o.join(" • "));let a="noted";n.length?a=t.length?"mixed":"under-construction":t.length?a="completed":r.length&&(a="planned");const d=[...t,...n,...r],l=e.label||d[0]||"Development";return{x:e.x,y:e.y,status:a,structures:d,label:l,tooltip:i.join(" • "),count:d.length,emphasis:!!e.emphasis,highlight:!!e.highlight}}function zm(e={},t={}){const n=[],r=new Set,o=t.developments??e.developments??e.development??e.developmentTiles??null;Array.isArray(o)?o.forEach((a,d)=>{const l=Sl(a,d);if(!l)return;const c=`${l.x}:${l.y}`;r.add(c),n.push(l)}):o&&typeof o=="object"&&Object.values(o).forEach((a,d)=>{const l=Sl(a,d);if(!l)return;const c=`${l.x}:${l.y}`;r.add(c),n.push(l)});const i=Array.isArray(t.structures)?t.structures:Array.isArray(e.structures)?e.structures:[];if(i.length){const a=new Map;i.forEach(d=>{if(!d)return;const l=d.tile||d.location||d.coords||{},c=ia(d.x??l.x??d.col),f=ia(d.y??l.y??d.row);if(c===null||f===null)return;const u=`${c}:${f}`;a.has(u)||a.set(u,{x:c,y:f,items:[],label:d.label||d.name||null,emphasis:d.emphasis,highlight:d.highlight}),a.get(u).items.push(d)}),a.forEach((d,l)=>{if(r.has(l))return;const c=Om(d);c&&(r.add(l),n.push(c))})}return n}const Pm={water:"Water",ocean:"Ocean",lake:"Lake",river:"River",marsh:"Marsh",mangrove:"Mangrove Forest",open:"Open Land",forest:"Forest",ore:"Ore Deposits",stone:"Stone Outcrop"},Cl=12,Ml=32;function jm(e,t,n){const r=Math.max(0,(e==null?void 0:e.cols)??0),o=Math.max(0,(e==null?void 0:e.rows)??0),i=Math.max(0,t||0),a=Math.max(0,n||0);return{x:Math.max(0,Math.floor((r-i)/2)),y:Math.max(0,Math.floor((o-a)/2))}}const Vt=Zr;function _m(e=0,t=0,n=null){if(typeof window>"u"){const c=Math.max(220,320);return{width:c,height:c}}const o=Math.max(220,Number.isFinite(n)&&n>0?n:window.innerWidth-80),i=Math.max(220,window.innerHeight-260),a=Math.max(220,Math.round(o)),d=Math.max(220,Math.min(a,Math.round(i))),l=Math.max(220,d);return{width:l,height:l}}function ur(e){typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(e):setTimeout(e,0)}function kt(e,t=0){return Number.isFinite(e)?Math.trunc(e):t}function go(e=[]){var r;const t=Array.isArray(e)?e.length:0;return{cols:t&&((r=e[0])==null?void 0:r.length)||0,rows:t}}function Ua(e=[],t=0,n=0,r=0,o=0){if(!Array.isArray(e)||!e.length||r<=0||o<=0)return[];const i=[];for(let a=0;a<o;a++){const d=e[n+a];if(!Array.isArray(d))break;i.push(d.slice(t,t+r))}return i}function El(e){var a,d,l,c,f;if(!e)return null;const t=(d=(a=e.buffer)==null?void 0:a.tiles)!=null&&d.length?e.buffer:e;if(!((l=t==null?void 0:t.tiles)!=null&&l.length))return null;const{cols:n,rows:r}=go(t.tiles),o=(c=t.types)!=null&&c.length?t.types:null,i=(f=t.elevations)!=null&&f.length?t.elevations:null;return{...t,tiles:t.tiles,types:o,elevations:i,width:t.width??n,height:t.height??r,xStart:kt(t.xStart,0),yStart:kt(t.yStart,0)}}function qm(e,t=0,n=0){if(t&&n)return{width:t,height:n};const{cols:r,rows:o}=go(e==null?void 0:e.tiles);if(r||o){const i=Math.max(r,o);return{width:i,height:i}}return{width:Vt,height:Vt}}function Zc(e,{legendLabels:t=Pm,showControls:n=!0,showLegend:r=!0,allowDrag:o=!0,idPrefix:i="map",fetchMap:a=null,onMapUpdate:d=null,onTileClick:l=null,navMode:c="viewport",onNavigate:f=null,actions:u={},jobSelector:p=null,useTerrainColors:h=!1,terrainColors:g=null,bufferMargin:b=Cl,minZoom:S=.5,maxZoom:x=3,initialZoom:k=1}={}){if(!e)throw new Error("Container is required for map view");const T=kl(g),A=Number.isFinite(b)?Math.max(0,Math.trunc(b)):Cl,L=Number.isFinite(S)?Math.max(.1,S):.5,R=Number.isFinite(x)?Math.max(L,x):3,z=Number.isFinite(k)?k:1,H=Math.min(R,Math.max(L,z)),_=(m,{size:y=48,fontSize:M="18px",variant:v="square"}={})=>{const N=typeof y=="number"&&Number.isFinite(y)?`${y}px`:`${y}`,P=v==="chip"||v==="stacked";m.style.width=P?"auto":N,m.style.minWidth=N,m.style.height=v==="stacked"?"auto":N,m.style.minHeight=N,m.style.padding=P?"0 12px":"0",m.style.fontSize=M,m.style.display="inline-flex",m.style.flexDirection=v==="stacked"?"column":"row",m.style.gap=v==="stacked"?"2px":"0",m.style.alignItems="center",m.style.justifyContent="center",m.style.borderRadius="12px",m.style.border="1px solid var(--map-control-border, var(--map-border, #ccc))",m.style.background="var(--map-control-bg, var(--bg-color, #fff))",m.style.color="var(--map-control-fg, inherit)",m.style.lineHeight="1.1",m.style.whiteSpace="nowrap",m.style.cursor="pointer",m.style.transition="background 0.2s ease, transform 0.1s ease",m.style.boxShadow="var(--map-control-shadow, 0 1px 2px rgba(0, 0, 0, 0.08))",m.style.fontWeight="600"},I=Dm(),s={map:null,buffer:null,context:{},home:{xStart:0,yStart:0},focus:{x:0,y:0},viewport:{width:0,height:0,xStart:0,yStart:0},drag:{active:!1,lastX:0,lastY:0,pendingX:0,pendingY:0,fractionalX:0,fractionalY:0},keyboardPan:{timer:null},resizeHandler:null,fetchMap:a,onMapUpdate:d,onTileClick:typeof l=="function"?l:null,navMode:c==="player"?"player":"viewport",onNavigate:typeof f=="function"?f:null,bufferMargin:A,bufferPadding:{x:A,y:A},expectedBufferPadding:{x:A,y:A},zoom:H,minZoom:L,maxZoom:R,initialZoom:H,zoomBase:{width:0,height:0},zoomDisplayFactor:1,tileBaseSize:Ml,camera:null,renderer:null,renderScheduled:!1,markerLayer:null,dataLayer:null,markerElements:new Map,markerDefs:[],useTerrainColors:!!h,terrainColorOverrides:T,pendingZoomSync:!1,developmentTiles:new Map,hasInitializedBaseChunk:!1,debug:{enabled:I,overlay:null,fps:0,lastRenderTimestamp:0,pointerTile:null}},F=()=>s.camera?s.camera.zoom:s.zoom,Y=()=>{var M,v,N;const m=((v=(M=s.map)==null?void 0:M.tiles)==null?void 0:v.length)||0;return{cols:m&&((N=s.map.tiles[0])==null?void 0:N.length)||0,rows:m}};function Z(m){const y=qm(m,s.viewport.width,s.viewport.height);s.viewport.width=Math.max(1,kt(y.width,Vt)),s.viewport.height=Math.max(1,kt(y.height,Vt))}function re(m){var $e;if(!(($e=m==null?void 0:m.tiles)!=null&&$e.length))return null;const y=go(m.tiles);if(!y.cols||!y.rows)return null;const M=Math.min(Math.max(1,s.viewport.width||Vt),y.cols),v=Math.min(Math.max(1,s.viewport.height||Vt),y.rows);s.viewport.width=M,s.viewport.height=v;const N=m.xStart??0,P=m.yStart??0,G=Math.max(0,y.cols-M),q=Math.max(0,y.rows-v);let j=kt(s.viewport.xStart,N)-N,pe=kt(s.viewport.yStart,P)-P;return j=Math.max(0,Math.min(G,j)),pe=Math.max(0,Math.min(q,pe)),s.viewport.xStart=N+j,s.viewport.yStart=P+pe,{offsetX:j,offsetY:pe,originX:N,originY:P,width:M,height:v}}function ke(){var j,pe,$e,oe,Be,Ce,et;if(!((pe=(j=s.buffer)==null?void 0:j.tiles)!=null&&pe.length))return!1;const m=re(s.buffer);if(!m)return!1;const{offsetX:y,offsetY:M,width:v,height:N}=m,P=Ua(s.buffer.tiles,y,M,v,N);if(!P.length)return!1;const G=($e=s.buffer.types)!=null&&$e.length?Ua(s.buffer.types,y,M,v,N):null,q=(oe=s.buffer.elevations)!=null&&oe.length?Ua(s.buffer.elevations,y,M,v,N):null;return s.map={...s.map,seed:s.buffer.seed??((Be=s.map)==null?void 0:Be.seed),season:s.buffer.season??((Ce=s.map)==null?void 0:Ce.season),waterLevel:s.buffer.waterLevel??((et=s.map)==null?void 0:et.waterLevel),tiles:P,types:G,elevations:q,xStart:s.viewport.xStart,yStart:s.viewport.yStart,width:v,height:N,viewport:{...s.viewport}},!0}function ye(){var y,M;if(!s.map)return null;const m={seed:s.map.seed,season:s.map.season,waterLevel:s.map.waterLevel,tiles:s.map.tiles,types:s.map.types,elevations:s.map.elevations,xStart:s.map.xStart,yStart:s.map.yStart,width:s.map.width,height:s.map.height,viewport:{...s.viewport}};if((M=(y=s.buffer)==null?void 0:y.tiles)!=null&&M.length){const v=go(s.buffer.tiles);m.buffer={seed:s.buffer.seed,season:s.buffer.season,waterLevel:s.buffer.waterLevel,tiles:s.buffer.tiles,types:s.buffer.types,elevations:s.buffer.elevations,xStart:s.buffer.xStart,yStart:s.buffer.yStart,width:s.buffer.width??v.cols,height:s.buffer.height??v.rows}}return m}function We(){var P,G;const m=Math.max(.001,F()),y=Math.max(1,Math.trunc(s.zoomBase.width||s.viewport.width||((P=s.map)==null?void 0:P.width)||Vt)),M=Math.max(1,Math.trunc(s.zoomBase.height||s.viewport.height||((G=s.map)==null?void 0:G.height)||Vt)),v=Math.max(1,Math.round(y/m)),N=Math.max(1,Math.round(M/m));return{width:v,height:N}}function Ye(){var G,q,j;if(!s.map){s.zoomDisplayFactor=1;return}const m=F();if(Math.abs(m-1)<.001){s.zoomDisplayFactor=1;return}const y=We(),M=((q=(G=s.map.tiles)==null?void 0:G[0])==null?void 0:q.length)||s.map.width||y.width,v=((j=s.map.tiles)==null?void 0:j.length)||s.map.height||y.height,N=Math.abs(M-y.width)<=1,P=Math.abs(v-y.height)<=1;s.zoomDisplayFactor=N&&P?1:m}function Xe({forceFetch:m=!1}={}){const y=F();if(!s.map){s.zoomDisplayFactor=Math.abs(y-1)<.001?1:y;return}const M=We(),v=Math.max(1,s.viewport.width||s.map.width||M.width),N=Math.max(1,s.viewport.height||s.map.height||M.height),P=Math.max(1,M.width),G=Math.max(1,M.height),q=P!==v,j=G!==N,pe=s.viewport.xStart+Math.floor(v/2),$e=s.viewport.yStart+Math.floor(N/2);if(s.viewport.width=P,s.viewport.height=G,s.home=be(s.focus),!q&&!j){m?ht(s.viewport.xStart,s.viewport.yStart,{forceFetch:!0}):(Ye(),ur(zt),ur(De));return}const oe=pe-Math.floor(P/2),Be=$e-Math.floor(G/2);ht(oe,Be)}function Ve(m){if(!s.useTerrainColors)return null;const y=typeof m=="string"&&m?m.trim().toLowerCase():"open",M=s.terrainColorOverrides||null;return M&&M[y]?M[y]:ym(y)}const ve=["map-tile--developed","map-tile--developed-pending","map-tile--developed-complete","map-tile--developed-mixed","map-tile--developed-planned","map-tile--developed-emphasis"];function nt(m,y){return`${Math.trunc(m??0)}:${Math.trunc(y??0)}`}function Ge(m,y){return!Number.isFinite(m)||!Number.isFinite(y)?null:s.developmentTiles.get(nt(m,y))||null}function xt(m,y=0){if(!m&&m!==0)return null;const M=Number(m.x),v=Number(m.y);if(!Number.isFinite(M)||!Number.isFinite(v))return null;const N=Math.trunc(M),P=Math.trunc(v),G=typeof m.status=="string"?m.status.trim().toLowerCase():"";let q="";switch(G){case"completed":case"complete":case"built":q="completed";break;case"under-construction":case"construction":case"in-progress":case"building":q="under-construction";break;case"mixed":q="mixed";break;case"planned":case"planning":case"queued":q="planned";break;default:q=G||""}const j=Array.isArray(m.structures)?m.structures.map(Pe=>String(Pe||"").trim()).filter(Boolean):[],pe=Number.isFinite(m.count)?Math.max(0,Math.trunc(m.count)):j.length,$e=typeof m.label=="string"&&m.label.trim()?m.label.trim():j[0]||"Development",oe=[],Be=Pe=>{typeof Pe=="string"&&Pe.trim()&&oe.push(Pe.trim())};Be(m.tooltip),Be(m.details),Be(m.description),Be(m.summary),Be(m.note),!oe.length&&j.length>1&&oe.push(`Structures: ${j.join(", ")}`);const Ce=oe.join(" • "),et=q||(j.length?"completed":pe>0?"planned":"noted");return{key:nt(N,P),x:N,y:P,status:et,label:$e,tooltip:Ce,structures:j,count:pe,emphasis:m.emphasis===!0,highlight:m.highlight===!0}}function Ft(m=[]){const y=Array.isArray(m)?m.map((v,N)=>xt(v,N)).filter(Boolean):[],M=new Map;y.forEach(v=>{M.set(v.key,v)}),s.developmentTiles=M,s.renderer&&s.renderer.setDevelopments(s.developmentTiles),jn(),tn()}function Ke(){var M,v,N,P;if(!s.map)return;if(!s.hasInitializedBaseChunk&&((M=s.map.tiles)!=null&&M.length)&&(s.hasInitializedBaseChunk=!0),s.context={...s.context,focus:{...s.focus},viewport:{...s.viewport}},typeof s.onMapUpdate=="function"){const G=ye();G&&s.onMapUpdate(G,s.context)}const m=((N=(v=s.map.tiles)==null?void 0:v[0])==null?void 0:N.length)||s.viewport.width||s.map.width||0,y=((P=s.map.tiles)==null?void 0:P.length)||s.viewport.height||s.map.height||0;if((!s.zoomBase.width||!s.zoomBase.height||Math.abs(s.zoom-1)<.001)&&(s.zoomBase.width=Math.max(1,m),s.zoomBase.height=Math.max(1,y)),Ye(),zn(),Lt({snap:!0}),dt(),jn(),s.pendingZoomSync){const G=Math.abs(s.zoomDisplayFactor-1)>=.001;s.pendingZoomSync=!1,G&&ur(()=>ze(s.zoom,{force:!0}))}}function Rt(){var Pe,it;if(!((it=(Pe=s.buffer)==null?void 0:Pe.tiles)!=null&&it.length))return!0;const m=go(s.buffer.tiles),y=s.viewport.width||m.cols,M=s.viewport.height||m.rows;if(m.cols<y||m.rows<M)return!0;const v=s.buffer.xStart??0,N=s.buffer.yStart??0,P=s.viewport.xStart-v,G=s.viewport.yStart-N;if(P<0||G<0)return!0;const q=s.bufferPadding||s.expectedBufferPadding||{x:0,y:0},j=Math.max(0,s.bufferMargin??0),pe=Math.max(q.x||0,j),$e=Math.max(q.y||0,j),oe=pe>0?Math.max(1,Math.floor(pe/2)):0,Be=$e>0?Math.max(1,Math.floor($e/2)):0,Ce=m.cols-(P+y),et=m.rows-(G+M);return P<oe||G<Be||Ce<oe||et<Be}function Qe(m,y,M={}){var un,Lr,Mn,Po,jo,_o;if(typeof s.fetchMap!="function")return;const v=Math.max(1,s.viewport.width||Vt),N=Math.max(1,s.viewport.height||Vt),P=Math.max(0,s.bufferMargin??0),G=Math.max(P,v),q=Math.max(P,N),j=v+G*2,pe=N+q*2,$e=kt(m,0),oe=kt(y,0),Be=$e-G,Ce=oe-q,et=M.overrideSeed??((un=s.map)==null?void 0:un.seed)??((Lr=s.buffer)==null?void 0:Lr.seed)??((Mn=s.context)==null?void 0:Mn.seed),Pe=M.overrideSeason??((Po=s.map)==null?void 0:Po.season)??((jo=s.buffer)==null?void 0:jo.season)??((_o=s.context)==null?void 0:_o.season),it=M.skipSanityChecks??s.hasInitializedBaseChunk===!0;s.expectedBufferPadding={x:G,y:q};const nn={map:s.map,context:s.context,seed:et,season:Pe,xStart:Be,yStart:Ce,width:j,height:pe,skipSanityChecks:it,viewport:{xStart:$e,yStart:oe,width:v,height:N}},Pt=s.fetchMap(nn);Pt&&typeof Pt.then=="function"?Pt.then(bi=>mt(bi,{targetX:$e,targetY:oe})):mt(Pt,{targetX:$e,targetY:oe})}function mt(m,{targetX:y,targetY:M}={}){const v=El(m);if(!v)return;const N=go(v.tiles);if(v.width=v.width??N.cols,v.height=v.height??N.rows,s.buffer=v,Number.isFinite(y)&&(s.viewport.xStart=kt(y,v.xStart)),Number.isFinite(M)&&(s.viewport.yStart=kt(M,v.yStart)),Z(v),!ke()){const q=Math.min(s.viewport.width,v.width),j=Math.min(s.viewport.height,v.height);if(s.viewport.width=Math.max(1,q),s.viewport.height=Math.max(1,j),!ke())return}const P=Math.max(1,Math.min(s.viewport.width,v.width||N.cols)),G=Math.max(1,Math.min(s.viewport.height,v.height||N.rows));s.bufferPadding=jm(N,P,G),s.expectedBufferPadding={...s.bufferPadding},Ke()}function ht(m,y,M={}){if(s.viewport.xStart=kt(m,s.viewport.xStart),s.viewport.yStart=kt(y,s.viewport.yStart),M.forceFetch||Rt()){Qe(s.viewport.xStart,s.viewport.yStart,M);return}ke()?Ke():Qe(s.viewport.xStart,s.viewport.yStart,M)}const Ne=document.createElement("div");Ne.className=`${i}-wrapper map-wrapper`,Ne.style.position="relative",Ne.style.border="1px solid var(--map-border, #ccc)",Ne.style.background="var(--map-bg, #f4f4f4)",Ne.style.overflow="hidden",Ne.style.cursor=o?"grab":"default",Ne.style.userSelect="none",Ne.style.touchAction=o?"none":"auto",Ne.style.boxSizing="border-box",Ne.style.aspectRatio="auto",Ne.style.flexShrink="0",Ne.style.margin="0 auto",Ne.hasAttribute("tabindex")||Ne.setAttribute("tabindex","0");const At=document.createElement("div");At.className=`${i}-canvas map-canvas`,At.style.position="absolute",At.style.inset="0",At.style.display="block",At.style.overflow="hidden",At.style.boxSizing="border-box",Ne.appendChild(At);const rt=document.createElement("canvas");if(rt.className=`${i}-display map-display`,rt.style.position="absolute",rt.style.inset="0",rt.style.width="100%",rt.style.height="100%",rt.style.display="block",rt.style.boxSizing="border-box",rt.style.touchAction="none",At.appendChild(rt),s.debug.enabled){const m=document.createElement("pre");m.className=`${i}-debug-overlay map-debug-overlay`,Object.assign(m.style,{position:"absolute",top:"8px",left:"8px",margin:"0",padding:"8px 10px",borderRadius:"10px",background:"rgba(15, 23, 42, 0.78)",color:"#f8fafc",fontFamily:'SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',fontSize:"12px",lineHeight:"1.4",pointerEvents:"none",whiteSpace:"pre",minWidth:"180px",zIndex:"20",boxShadow:"0 8px 24px rgba(15, 23, 42, 0.45)",border:"1px solid rgba(148, 163, 184, 0.35)"}),Ne.appendChild(m),s.debug.overlay=m,vn()}const Q=document.createElement("div");Q.className=`${i}-data map-display-data`,Q.style.display="none",Q.style.visibility="hidden",Q.style.pointerEvents="none",Q.setAttribute("aria-hidden","true"),At.appendChild(Q),s.camera=wm({viewportWidth:Ne.clientWidth||0,viewportHeight:Ne.clientHeight||0,minZoom:s.minZoom,maxZoom:s.maxZoom,initialZoom:s.zoom,centerTile:{x:s.focus.x,y:s.focus.y}}),s.renderer=Cm(rt,{camera:s.camera,tileBaseSize:s.tileBaseSize,useTerrainColors:s.useTerrainColors,getTerrainColor:m=>Ve(m)}),s.renderer.setDevelopments(s.developmentTiles),s.dataLayer=Q;const _e=document.createElement("div");_e.className=`${i}-marker-layer map-marker-layer`,_e.style.position="absolute",_e.style.left="0",_e.style.top="0",_e.style.pointerEvents="none",_e.style.zIndex="3",_e.style.display="block",_e.style.transformOrigin="top left",_e.style.width="100%",_e.style.height="100%",_e.style.transform="none",At.appendChild(_e),s.markerLayer=_e,De();const xn=m=>{if(!s.renderer||!s.map)return null;const y=rt.getBoundingClientRect(),M=m.clientX-y.left,v=m.clientY-y.top;return M<0||v<0||M>y.width||v>y.height?null:s.renderer.hitTest(M,v)};function vn(m={}){var et,Pe;if(!((et=s.debug)!=null&&et.enabled)||!s.debug.overlay)return;const y=typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now();if(m.fromRender){const it=s.debug.lastRenderTimestamp;if(Number.isFinite(it)&&it>0){const nn=y-it;if(nn>0){const Pt=1e3/nn,un=.85;s.debug.fps=s.debug.fps?s.debug.fps*un+Pt*(1-un):Pt}}s.debug.lastRenderTimestamp=y}const M=((Pe=s.camera)==null?void 0:Pe.centerTile)||s.focus||{x:0,y:0},v=s.debug.pointerTile,N=F(),P=it=>Number.isFinite(it)?`${Math.round(it*100)/100}`:"—",G=Number.isFinite(N)?`${Math.round(N*100)/100}×`:"—",q=s.debug.fps?`${s.debug.fps.toFixed(1)} fps`:"n/a",j=(ao==null?void 0:ao.capacity)??null,pe=(ao==null?void 0:ao.size)??null,$e=(so==null?void 0:so.capacity)??null,oe=(so==null?void 0:so.size)??null,Be=ji&&typeof ji.size=="number"?ji.size:null,Ce=[v?`Current tile: (${P(v.x)}, ${P(v.y)})`:"Current tile: —",`Center tile: (${P(M.x)}, ${P(M.y)})`,`Zoom: ${G}`,`Frame rate: ${q}`,`Chunk cache: ${pe!==null&&j!==null?`${pe}/${j}`:"n/a"}`,`Tile canvases: ${oe!==null&&$e!==null?`${oe}/${$e}`:"n/a"}${Be!==null?` (pool ${Be})`:""}`];s.debug.overlay.textContent=Ce.join(`
`)}rt.addEventListener("click",m=>{if(typeof s.onTileClick!="function")return;const y=xn(m);if(!y)return;const M={x:y.x,y:y.y,col:y.col,row:y.row,terrain:y.type||null,event:m,map:s.map,context:{...s.context}};s.onTileClick(M)}),s.debug.enabled&&(rt.addEventListener("pointermove",m=>{const y=xn(m);s.debug.pointerTile=y?{x:y.x,y:y.y}:null,vn()}),rt.addEventListener("pointerleave",()=>{s.debug.pointerTile=null,vn()}));const $t=document.createElement("div");$t.className="map-tile-tooltip",Object.assign($t.style,{position:"absolute",display:"none",pointerEvents:"none",padding:"6px 10px",borderRadius:"10px",background:"rgba(26, 32, 44, 0.85)",color:"#fff",fontSize:"13px",lineHeight:"1.2",boxShadow:"0 8px 18px rgba(0, 0, 0, 0.35)",transform:"translate(-50%, calc(-100% - 12px))",zIndex:"12",whiteSpace:"nowrap",letterSpacing:"0.02em"}),Ne.appendChild($t);const He={visible:!1,tile:null,pointerId:null,pointerType:null,holdTimer:null,holdTarget:null,holdOriginX:0,holdOriginY:0},gt=()=>{He.visible=!1,He.tile=null,He.pointerId=null,He.pointerType=null,$t.style.display="none"},Ot=(m,y,M)=>{if(!He.visible)return;const v=Ne.getBoundingClientRect();let N,P;if(Number.isFinite(m)&&Number.isFinite(y))N=m-v.left,P=y-v.top;else if(M&&s.camera){const j=s.camera.worldToScreenCenter(M.x,M.y,s.tileBaseSize);N=j.x,P=j.y}else N=v.width/2,P=v.height/2;const G=Math.min(v.width-12,Math.max(12,N)),q=Math.min(v.height-12,Math.max(12,P));$t.style.left=`${G}px`,$t.style.top=`${q}px`},Ze=m=>{var q,j,pe,$e,oe,Be;if(!m)return"Unknown terrain";const y=m.type||"",M=t[y]||y||"Unknown terrain",v=((q=m.symbol)==null?void 0:q.trim())||"",N=` (${m.x}, ${m.y})`,P=((j=m.development)==null?void 0:j.tooltip)||(($e=(pe=m.development)==null?void 0:pe.structures)==null?void 0:$e.join(", "));let G="";if((oe=m.development)!=null&&oe.tooltip)G=` — ${m.development.tooltip}`;else if(P)G=` — ${P}`;else{const Ce=Ge(m.x,m.y),et=(Ce==null?void 0:Ce.tooltip)||((Be=Ce==null?void 0:Ce.structures)!=null&&Be.length?Ce.structures.join(", "):"");et&&(G=` — ${et}`)}return`${v?`${v} `:""}${M}${N}${G}`},st=(m,y=null)=>{m&&($t.textContent=Ze(m),$t.style.display="block",He.visible=!0,He.tile=m,He.pointerId=(y==null?void 0:y.pointerId)??null,He.pointerType=(y==null?void 0:y.pointerType)??null,Ot(y==null?void 0:y.clientX,y==null?void 0:y.clientY,m))},ft=()=>{He.holdTimer&&(clearTimeout(He.holdTimer),He.holdTimer=null),He.holdTarget=null,He.pointerId=null,He.pointerType=null},lt=(m,y)=>{ft(),He.holdTarget=y,He.pointerId=m.pointerId,He.pointerType=m.pointerType,He.holdOriginX=m.clientX,He.holdOriginY=m.clientY,He.holdTimer=setTimeout(()=>{He.holdTimer=null,st(y,m)},450)},ln=m=>{const y=xn(m);y&&m.pointerType==="mouse"&&st(y,m)},ce=m=>{const y=xn(m);if(He.holdTimer&&He.pointerId===m.pointerId){const M=m.clientX-He.holdOriginX,v=m.clientY-He.holdOriginY;Math.hypot(M,v)>12&&ft()}He.visible&&He.pointerId===m.pointerId?Ot(m.clientX,m.clientY,He.tile):m.pointerType==="mouse"&&y&&st(y,m)},Qt=m=>{m.pointerType==="mouse"&&gt()},Sn=m=>{const y=xn(m);if(y){if(m.pointerType==="mouse"){gt();return}lt(m,y)}},kn=m=>{He.holdTimer&&He.pointerId===m.pointerId&&ft(),He.visible&&He.pointerId===m.pointerId&&m.pointerType!=="mouse"&&gt()},nr=m=>{He.holdTimer&&He.pointerId===m.pointerId&&ft(),He.pointerId===m.pointerId&&gt()};rt.addEventListener("pointerover",ln),rt.addEventListener("pointermove",ce),rt.addEventListener("pointerout",Qt),rt.addEventListener("pointerdown",Sn),rt.addEventListener("pointerup",kn),rt.addEventListener("pointercancel",nr),Ne.addEventListener("mouseleave",gt);const Nt=document.createElement("div");Nt.setAttribute("aria-hidden","true"),Nt.style.position="absolute",Nt.style.opacity="0",Nt.style.pointerEvents="none",Nt.style.fontSize="1px",Nt.style.lineHeight="1",Nt.style.whiteSpace="nowrap",Nt.style.height="0",Nt.style.overflow="hidden",Nt.textContent=Object.values(Pc).join(""),Ne.appendChild(Nt);const Je=document.createElement("div");Je.className=`${i}-layout map-layout`,Je.style.display="flex",Je.style.flexDirection="column",Je.style.alignItems="stretch",Je.style.flexWrap="nowrap",Je.style.gap="16px",Je.style.width="100%",Je.style.maxWidth="100%";const ue=document.createElement("div");ue.className=`${i}-map-container map-container`,ue.style.display="flex",ue.style.flexDirection="column",ue.style.alignItems="flex-start",ue.style.gap="12px",ue.style.width="100%",ue.style.maxWidth="100%";const ct=document.createElement("div");ct.className=`${i}-primary map-primary-stack`,ct.style.display="flex",ct.style.flexDirection="column",ct.style.alignItems="center",ct.style.gap="8px",ct.style.width="100%",ct.style.maxWidth="100%",ct.style.flex="1 1 auto",ct.style.minWidth="0";const Ut=document.createElement("div");Ut.className=`${i}-stage map-stage`,Ut.style.position="relative",Ut.style.display="flex",Ut.style.flexDirection="column",Ut.style.alignItems="center",Ut.style.width="100%",Ut.style.maxWidth="100%",Ut.appendChild(Ne),ct.appendChild(Ut),ue.appendChild(ct);const Ue=document.createElement("div");Ue.className=`${i}-control-stack map-control-stack`,Ue.style.display="flex",Ue.style.flexDirection="column",Ue.style.alignItems="stretch",Ue.style.gap="12px",Je.appendChild(ue),e.appendChild(Je);const Me=document.createElement("div");let vt=null,St=null,Ee=null,le=null,te=!1,Te=null,Ae=null,Oe=null;if(n){Me.className=`${i}-controls map-controls`,Me.style.display="flex",Me.style.flexDirection="column",Me.style.alignItems="flex-start",Me.style.gap="8px",Me.style.justifyContent="flex-start",Me.style.alignSelf="flex-start",Te=document.createElement("div"),Te.style.display="flex",Te.style.flexDirection="column",Te.style.alignItems="stretch",Te.style.gap="10px",Me.appendChild(Te);const m="calc(3 * 48px + 2 * 6px)";vt=document.createElement("div"),vt.className=`${i}-nav map-nav-grid`,vt.style.display="grid",vt.style.gridTemplateColumns="repeat(3, 48px)",vt.style.gridAutoRows="48px",vt.style.gap="6px",vt.style.width=m,le=document.createElement("div"),le.className=`${i}-nav-panel map-nav-panel`,le.setAttribute("role","group"),le.setAttribute("aria-label","Map navigation controls"),le.hidden=!0,le.setAttribute("aria-hidden","true"),le.appendChild(vt);const y=`${i}-nav-panel`;le.id=y,Ee=document.createElement("button"),Ee.type="button",Ee.className="map-nav-toggle",Ee.setAttribute("aria-controls",y),Ee.setAttribute("aria-expanded","false"),Ee.setAttribute("aria-label","Toggle navigation controls");const M=document.createElement("span");M.className="map-nav-toggle__icon",M.textContent="🧭",Ee.appendChild(M);const v=(N=!1)=>{const P=!!N;te=P,le.hidden=!P,le.setAttribute("aria-hidden",P?"false":"true"),Ee.setAttribute("aria-expanded",P?"true":"false"),Ee.classList.toggle("is-active",P),P?ur(()=>{const G=vt.querySelector("button");G&&G.focus()}):document.activeElement&&le.contains(document.activeElement)&&Ee.focus()};Ee.addEventListener("click",()=>{v(!te)}),le.addEventListener("keydown",N=>{!N||typeof N.key!="string"||N.key==="Escape"&&(N.preventDefault(),v(!1))}),St=document.createElement("div"),St.className=`${i}-nav-overlay map-nav-overlay`,St.style.display="flex",St.style.flexDirection="column",St.style.alignItems="stretch",St.style.gap="10px",St.style.width=m,St.style.alignSelf="center",St.appendChild(Ee),St.appendChild(le),Te.appendChild(St),Ae=document.createElement("div"),Ae.className=`${i}-control-details map-control-details`,Ae.style.display="flex",Ae.style.flexDirection="column",Ae.style.gap="12px",Ae.style.width=m,Ae.style.alignSelf="center",Ae.style.boxSizing="border-box",Te.appendChild(Ae),Oe=Em({onZoomIn:()=>{bt(.1)},onZoomOut:()=>{bt(-.1)},onZoomReset:()=>{qt()},styleButton:(N,P)=>{_(N,P)}}),Oe.element.classList.add(`${i}-zoom`),Oe.element.style.alignSelf="center",ct.appendChild(Oe.element),Et()}u.build,u.craft,u.gather;const at=new Map;let me=null,fe=null;const ie=p&&typeof p=="object"?p:{};let W=null,Le=null,Se=null,ge=null,U=!1;const ae=new Map;let Fe=null,J=null,K=null,we=null,de=null,he=null,ne=null,Re=null,Mt=null,cn=null,rr=!1;const Ie={options:[],selectedId:null,laborers:null};function Ar(m){if(typeof m!="string")return"";const y=m.trim();return y?y.length>1&&/s$/i.test(y)&&!/ss$/i.test(y)?y.replace(/s$/i,""):y:""}function Ro(m={}){const y=typeof m.id=="string"&&m.id.trim()?m.id.trim():null;if(!y)return null;const M=typeof m.label=="string"&&m.label.trim()?m.label.trim():y,v=Ar(M),N=Number.isFinite(m.assigned)?Math.max(0,Math.trunc(m.assigned)):0,P=Number.isFinite(m.capacity)?Math.max(0,Math.trunc(m.capacity)):null,G=m.description||"",q=Number.isFinite(m.workdayHours)?Math.max(1,Math.trunc(m.workdayHours)):null;return{id:y,label:M,displayLabel:v,assigned:N,capacity:P,description:G,workdayHours:q}}function Ln(){return K?K.dataset.hasContent==="true":!1}function Cn(m){Re&&(rr=!!(m&&Ln()),rr?(Re.style.opacity="1",Re.style.visibility="visible",Re.style.transform="translateY(0)",Re.style.pointerEvents="auto",ne&&ne.setAttribute("aria-expanded","true")):(Re.style.opacity="0",Re.style.visibility="hidden",Re.style.transform="translateY(-4px)",Re.style.pointerEvents="none",ne&&ne.setAttribute("aria-expanded","false")))}function ui(m=140){if(clearTimeout(Mt),!Ln()){Cn(!1);return}Mt=setTimeout(()=>{Cn(!1)},Math.max(0,m))}function or(){clearTimeout(Mt),clearTimeout(cn),Mt=null,cn=null}function Qr(m){return m?typeof m.displayLabel=="string"&&m.displayLabel?m.displayLabel:m.label:""}function $o(){if(!W)return;const m=Ie.options.find(y=>y.id===Ie.selectedId)||null;if(m)W.textContent=Qr(m),W.dataset.placeholder="false";else if(!Ie.options.length)W.textContent=ie.emptyOptionLabel||"No jobs available",W.dataset.placeholder="true";else{const y=Ie.options[0];W.textContent=Qr(y),W.dataset.placeholder="false"}}function Ho(){const m=Ie.selectedId;ae.forEach((y,M)=>{const v=M===m;y.dataset.selected=v?"true":"false",y.setAttribute("aria-selected",v?"true":"false"),y.setAttribute("tabindex",v?"0":"-1"),v?(y.style.background="var(--map-select-selected, linear-gradient(135deg, rgba(40, 72, 140, 0.92), rgba(28, 52, 108, 0.88)))",y.style.boxShadow="inset 0 0 0 1px rgba(150, 182, 246, 0.35)",y.style.opacity="1"):(y.style.background="transparent",y.style.boxShadow="none",y.style.opacity="0.9")})}function Ra(){Fe||(Fe=m=>{U&&(!Se||!Le||Se.contains(m.target)||Le.contains(m.target)||Yt(!1))}),J||(J=m=>{U&&m.key==="Escape"&&(m.preventDefault(),Yt(!1,{focusButton:!0}))})}function Yt(m,{focusButton:y=!1}={}){if(!W||!Se)return;Ie.options.length||(m=!1);const M=!!m;if(U===M){!M&&y&&requestAnimationFrame(()=>{W.focus({preventScroll:!0})});return}if(U=M,W.setAttribute("aria-expanded",U?"true":"false"),Se.setAttribute("aria-hidden",U?"false":"true"),U){Ra(),W.dataset.open="true",W.style.boxShadow="0 0 0 2px rgba(154, 196, 255, 0.55), 0 8px 18px rgba(0, 0, 0, 0.4)",Se.style.display="flex",Se.style.opacity="1",Se.style.pointerEvents="auto",document.addEventListener("pointerdown",Fe,!0),document.addEventListener("keydown",J,!0);const N=ae.get(Ie.selectedId)||(ge==null?void 0:ge.querySelector("button[data-option-id]"));N&&requestAnimationFrame(()=>{N.focus({preventScroll:!0})})}else W.dataset.open="false",W.style.boxShadow="0 6px 16px rgba(0, 0, 0, 0.35)",Se.style.display="none",Se.style.opacity="0",Se.style.pointerEvents="none",document.removeEventListener("pointerdown",Fe,!0),document.removeEventListener("keydown",J,!0),y&&requestAnimationFrame(()=>{W.focus({preventScroll:!0})})}function eo(){return ge?Array.from(ge.querySelectorAll("button[data-option-id]")):[]}function Nr(m){const y=eo();if(!y.length)return;const M=Math.min(Math.max(m,0),y.length-1),v=y[M];v&&v.focus({preventScroll:!0})}function to(m){const y=eo();if(!y.length)return;const M=typeof document<"u"?document.activeElement:null;let v=y.indexOf(M);if(v===-1){const P=ae.get(Ie.selectedId);P&&(v=y.indexOf(P))}v===-1&&(v=0);const N=(v+m+y.length)%y.length;Nr(N)}function On(){if(!K)return;K.dataset.hasContent="false",Cn(!1);const m=Ie.options.find(M=>M.id===Ie.selectedId);if(!m){ne&&(ne.style.display="none",ne.disabled=!0),we&&(we.textContent="",we.style.display="none"),de&&(de.textContent="",de.style.display="none"),he&&(he.textContent=ie.emptyMessage||"No jobs are available right now.",he.style.display=Ie.options.length?"none":"block");return}if(ne&&(ne.style.display="inline-flex"),he&&(he.style.display="none"),we){const M=[];Number.isFinite(m.capacity)?M.push(`Assigned ${m.assigned}/${m.capacity}`):M.push(`Assigned ${m.assigned}`),Number.isFinite(m.workdayHours)&&M.push(`${m.workdayHours}h`),Number.isFinite(Ie.laborers)&&M.push(`${Ie.laborers} laborers free`),we.textContent=M.join(" · "),we.style.display=M.length?"block":"none"}de&&(m.description?(de.textContent=m.description,de.style.display="block"):ie.defaultDescription?(de.textContent=ie.defaultDescription,de.style.display="block"):(de.textContent="",de.style.display="none"));const y=!!(we!=null&&we.textContent||de!=null&&de.textContent);K.dataset.hasContent=y?"true":"false",ne&&(ne.disabled=!y,ne.style.display=y?"inline-flex":"none",y||Cn(!1))}function fi(m,{fromUser:y=!1}={}){if(!Ie.options.length){Ie.selectedId=null,$o(),Ho(),On();return}const M=Ie.options.find(v=>v.id===m)||Ie.options[0]||null;if(Ie.selectedId=M?M.id:null,$o(),Ho(),y&&Yt(!1,{focusButton:!0}),On(),y&&typeof ie.onSelect=="function")try{ie.onSelect(Ie.selectedId,{options:Ie.options.slice()})}catch(v){console.warn("Job selector onSelect failed",v)}}function Io(){var m;if(!(!W||!ge||!Se)){if(Yt(!1),ae.clear(),ge.innerHTML="",!Ie.options.length){W.disabled=!0,W.textContent=ie.emptyOptionLabel||"No jobs available",W.dataset.placeholder="true",he&&(he.textContent=ie.emptyMessage||"No jobs are available right now.",he.style.display="block");return}W.disabled=!1,Ie.options.forEach(y=>{const M=document.createElement("li");M.style.listStyle="none",M.style.margin="0",M.style.padding="0";const v=document.createElement("button");v.type="button",v.dataset.optionId=y.id,v.textContent=Qr(y),v.setAttribute("role","option"),v.setAttribute("aria-selected","false"),v.style.width="100%",v.style.border="none",v.style.background="transparent",v.style.color="inherit",v.style.padding="10px 16px",v.style.fontWeight="600",v.style.fontSize="15px",v.style.letterSpacing="0.03em",v.style.textTransform="uppercase",v.style.textAlign="left",v.style.cursor="pointer",v.style.transition="background 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease",v.style.opacity="0.9",v.style.borderRadius="0",v.addEventListener("click",()=>{fi(y.id,{fromUser:!0})}),v.addEventListener("keydown",N=>{if(N.key==="ArrowDown")N.preventDefault(),to(1);else if(N.key==="ArrowUp")N.preventDefault(),to(-1);else if(N.key==="Home")N.preventDefault(),Nr(0);else if(N.key==="End"){N.preventDefault();const P=eo();Nr(Math.max(0,P.length-1))}else N.key==="Enter"||N.key===" "?(N.preventDefault(),fi(y.id,{fromUser:!0})):N.key==="Tab"&&Yt(!1)}),v.addEventListener("mouseenter",()=>{v.dataset.selected!=="true"&&(v.style.background="var(--map-select-hover, rgba(42, 70, 128, 0.82))",v.style.boxShadow="inset 0 0 0 1px rgba(146, 176, 238, 0.18)",v.style.opacity="1")}),v.addEventListener("mouseleave",()=>{v.dataset.selected!=="true"&&(v.style.background="transparent",v.style.boxShadow="none",v.style.opacity="0.9")}),v.addEventListener("focus",()=>{v.dataset.selected!=="true"&&(v.style.background="var(--map-select-hover, rgba(42, 70, 128, 0.82))",v.style.boxShadow="inset 0 0 0 1px rgba(146, 176, 238, 0.22)",v.style.opacity="1")}),v.addEventListener("blur",()=>{v.dataset.selected!=="true"&&(v.style.background="transparent",v.style.boxShadow="none",v.style.opacity="0.9")}),M.appendChild(v),ge.appendChild(M),ae.set(y.id,v)}),Ie.options.some(y=>y.id===Ie.selectedId)||(Ie.selectedId=((m=Ie.options[0])==null?void 0:m.id)||null),$o(),Ho(),he&&(he.style.display="none"),On()}}function Do(m=[],{selectedId:y=null,laborers:M=null}={}){var v;Ie.options=Array.isArray(m)?m.map(Ro).filter(Boolean):[],Ie.laborers=Number.isFinite(M)?Math.max(0,Math.trunc(M)):null,y&&Ie.options.some(N=>N.id===y)?Ie.selectedId=y:Ie.options.some(N=>N.id===Ie.selectedId)||(Ie.selectedId=((v=Ie.options[0])==null?void 0:v.id)||null),Io()}const w=(m,y)=>{m&&(y?(m.style.background="var(--action-button-bg-active, linear-gradient(135deg, rgba(45, 108, 223, 0.95), rgba(88, 173, 255, 0.95)))",m.style.color="var(--action-button-text-active, #fff)",m.style.boxShadow="var(--action-button-shadow-active, 0 6px 16px rgba(45, 108, 223, 0.35))"):(m.style.background="var(--action-button-bg, linear-gradient(135deg, rgba(255, 255, 255, 0.96), rgba(235, 235, 235, 0.92)))",m.style.color="var(--action-button-text, inherit)",m.style.boxShadow="var(--action-button-shadow, 0 2px 6px rgba(0, 0, 0, 0.08))"))},E=m=>{at.forEach((y,M)=>{const v=m===M;y.dataset.active=v?"true":"false",y.setAttribute("aria-pressed",v?"true":"false"),w(y,v)})},$=m=>{m.key==="Escape"&&(m.preventDefault(),D())},D=()=>{if(!fe){E(null);return}fe.style.display="none",fe.setAttribute("aria-hidden","true"),document.removeEventListener("keydown",$),E(null)};if(r){if(me=document.createElement("div"),me.className=`${i}-action-panel map-action-panel`,me.style.display="flex",me.style.flexDirection="column",me.style.alignItems="stretch",me.style.gap="12px",me.style.padding="12px",me.style.borderRadius="16px",me.style.border="1px solid var(--map-border, #ccc)",me.style.background="var(--action-panel-bg, rgba(250, 250, 255, 0.96))",me.style.backdropFilter="blur(4px)",me.style.boxShadow="0 12px 28px rgba(0, 0, 0, 0.18)",me.style.alignSelf="flex-start",ie.title){const q=document.createElement("h4");q.textContent=ie.title,q.style.margin="0",q.style.fontSize="18px",q.style.letterSpacing="0.04em",me.appendChild(q)}const m=Ae||me,y=document.createElement("div");y.className=`${i}-job-selector map-job-selector`,Object.assign(y.style,{display:"flex",flexDirection:"column",gap:"8px",padding:"12px 14px",borderRadius:"14px",border:"1px solid var(--map-border, rgba(104, 132, 194, 0.75))",background:"var(--map-control-surface, linear-gradient(135deg, rgba(16, 28, 62, 0.95), rgba(12, 22, 46, 0.92)))",boxShadow:"0 10px 24px rgba(0, 0, 0, 0.35)",color:"var(--map-control-text, #f4f7ff)",width:"100%",boxSizing:"border-box"}),m.appendChild(y);const M=document.createElement("div");Object.assign(M.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"8px",position:"relative"}),y.appendChild(M);const v=document.createElement("label");v.textContent=ie.label||"Jobs",v.id=`${i}-job-label`,v.htmlFor=`${i}-job-select`,v.style.fontSize="15px",v.style.fontWeight="600",v.style.letterSpacing="0.04em",v.style.textTransform="uppercase",v.style.color="inherit",M.appendChild(v),ne=document.createElement("button"),ne.type="button",ne.textContent="i",ne.setAttribute("aria-label",`${ie.label||"Job"} details`),ne.setAttribute("aria-haspopup","true"),ne.setAttribute("aria-expanded","false"),Object.assign(ne.style,{width:"22px",height:"22px",display:"none",alignItems:"center",justifyContent:"center",borderRadius:"50%",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.75))",background:"transparent",color:"inherit",fontWeight:"700",fontSize:"13px",cursor:"pointer",lineHeight:"1",padding:"0"}),M.appendChild(ne),Re=document.createElement("div"),Re.id=`${i}-job-tooltip`,Re.setAttribute("role","tooltip"),Object.assign(Re.style,{position:"absolute",right:"0",top:"calc(100% + 8px)",maxWidth:"260px",minWidth:"220px",padding:"12px 14px",borderRadius:"12px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.85))",background:"var(--map-tooltip-bg, rgba(10, 18, 38, 0.96))",boxShadow:"0 12px 28px rgba(0, 0, 0, 0.45)",color:"inherit",opacity:"0",visibility:"hidden",transform:"translateY(-4px)",transition:"opacity 0.12s ease, transform 0.12s ease",pointerEvents:"none",zIndex:"30"}),M.appendChild(Re),ne.setAttribute("aria-controls",Re.id),Le=document.createElement("div"),Le.style.position="relative",Le.style.display="flex",Le.style.alignItems="center",Le.style.width="100%",y.appendChild(Le),W=document.createElement("button"),W.type="button",W.id=`${i}-job-select`,W.textContent=ie.placeholderLabel||ie.label||"Select",W.dataset.placeholder="true",W.dataset.open="false",W.disabled=!0,W.setAttribute("aria-haspopup","listbox"),W.setAttribute("aria-expanded","false"),W.setAttribute("aria-labelledby",`${v.id} ${W.id}`),W.setAttribute("aria-label",ie.ariaLabel||ie.label||"Jobs"),Object.assign(W.style,{width:"100%",borderRadius:"12px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.8))",padding:"12px 42px 12px 16px",fontWeight:"600",fontSize:"15px",letterSpacing:"0.03em",textTransform:"uppercase",background:"var(--map-select-bg, linear-gradient(135deg, rgba(20, 38, 78, 0.98), rgba(16, 28, 56, 0.95)))",color:"var(--map-select-text, #f5f8ff)",boxShadow:"0 6px 16px rgba(0, 0, 0, 0.35)",cursor:"pointer",textAlign:"left",lineHeight:"1.2",transition:"box-shadow 0.12s ease, transform 0.12s ease",outline:"none"}),Le.appendChild(W);const N=document.createElement("span");N.textContent="▾",N.setAttribute("aria-hidden","true"),Object.assign(N.style,{position:"absolute",right:"16px",top:"50%",transform:"translateY(-50%)",pointerEvents:"none",fontSize:"14px",color:"var(--map-select-caret, #d8e2ff)",opacity:"0.85"}),Le.appendChild(N),Se=document.createElement("div"),Se.setAttribute("aria-hidden","true"),Object.assign(Se.style,{position:"absolute",left:"0",right:"0",top:"calc(100% + 8px)",borderRadius:"14px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.9))",background:"var(--map-select-popup-bg, linear-gradient(135deg, rgba(16, 30, 64, 0.98), rgba(10, 22, 46, 0.94)))",boxShadow:"0 18px 36px rgba(0, 0, 0, 0.48)",padding:"8px 0",display:"none",flexDirection:"column",gap:"0",zIndex:"40",maxHeight:"280px",overflowY:"auto",backdropFilter:"blur(6px)",WebkitBackdropFilter:"blur(6px)"}),Le.appendChild(Se),ge=document.createElement("ul"),ge.id=`${i}-job-options`,ge.setAttribute("role","listbox"),ge.setAttribute("aria-labelledby",v.id),Object.assign(ge.style,{display:"flex",flexDirection:"column",margin:"0",padding:"0",gap:"0",listStyle:"none"}),Se.appendChild(ge),W.setAttribute("aria-controls",ge.id),W.addEventListener("click",()=>{Yt(!U)}),W.addEventListener("keydown",q=>{q.key==="ArrowDown"?(q.preventDefault(),U?to(1):Yt(!0)):q.key==="ArrowUp"?(q.preventDefault(),U?to(-1):Yt(!0)):q.key==="Enter"||q.key===" "?(q.preventDefault(),Yt(!U)):q.key==="Escape"&&U&&(q.preventDefault(),Yt(!1,{focusButton:!0}))}),W.addEventListener("focus",()=>{W.style.boxShadow="0 0 0 2px rgba(154, 196, 255, 0.55), 0 6px 16px rgba(0, 0, 0, 0.35)"}),W.addEventListener("blur",()=>{U||(W.style.boxShadow="0 6px 16px rgba(0, 0, 0, 0.35)")}),K=document.createElement("div"),K.dataset.hasContent="false",Object.assign(K.style,{display:"flex",flexDirection:"column",gap:"6px",fontSize:"13px",opacity:"0.92"}),Re.appendChild(K),we=document.createElement("span"),we.style.color="inherit",we.style.display="none",K.appendChild(we),de=document.createElement("span"),de.style.opacity="0.78",de.style.lineHeight="1.35",de.style.display="none",K.appendChild(de),he=document.createElement("span"),he.style.fontSize="13px",he.style.opacity="0.8",he.style.display="none",y.appendChild(he);const P=()=>{or(),Cn(!0)},G=q=>{ui(typeof q=="number"?q:void 0)};ne.addEventListener("mouseenter",()=>{Ln()&&P()}),ne.addEventListener("mouseleave",()=>{G(120)}),ne.addEventListener("focus",()=>{Ln()&&P()}),ne.addEventListener("blur",()=>{G(100)}),ne.addEventListener("keydown",q=>{if(q.key==="Enter"||q.key===" "){if(q.preventDefault(),!Ln())return;Cn(!rr)}}),ne.addEventListener("pointerdown",q=>{(q.pointerType==="touch"||q.pointerType==="pen")&&(or(),cn=setTimeout(()=>{Ln()&&Cn(!0)},420))}),ne.addEventListener("pointerup",q=>{(q.pointerType==="touch"||q.pointerType==="pen")&&(or(),G(200))}),ne.addEventListener("pointerleave",q=>{(q.pointerType==="touch"||q.pointerType==="pen")&&(or(),G(200))}),Ie.options.length?Io():Do(Array.isArray(ie.options)?ie.options:[],{selectedId:ie.initialId||null,laborers:ie.laborers})}function B(){if(typeof window>"u")return!0;if(typeof window.matchMedia=="function"){const m=window.matchMedia("(orientation: portrait)");if(m&&typeof m.matches=="boolean")return!m.matches}return window.innerWidth>=window.innerHeight}function X(){const m=B(),y=n&&Me,M=!!me;Je.style.flexDirection="column",Je.style.alignItems="stretch",Je.style.flexWrap="nowrap",ct.parentElement!==ue&&ue.insertBefore(ct,ue.firstChild),ct.style.alignSelf=m&&y?"flex-start":"stretch",ct.style.width="100%",ct.style.maxWidth="100%",m&&y?(ue.style.flexDirection="row",ue.style.flexWrap="nowrap",ue.style.gap="16px",ue.style.justifyContent="flex-start",ue.style.alignItems="flex-start",Ue.parentElement||ue.appendChild(Ue),Ue.style.alignItems="flex-start",Ue.style.justifyContent="flex-start",Me.parentElement!==Ue&&(Me.parentElement&&Me.parentElement.removeChild(Me),Ue.appendChild(Me)),Me.style.margin="0",Me.style.alignItems="flex-start",Me.style.alignSelf="flex-start",Me.style.justifyContent="flex-start"):(ue.style.flexDirection="column",ue.style.flexWrap="nowrap",ue.style.gap="12px",ue.style.justifyContent="flex-start",ue.style.alignItems="flex-start",Ue.parentElement&&Ue.parentElement.removeChild(Ue),y?(Me.parentElement&&Me.parentElement!==ue&&Me.parentElement.removeChild(Me),Me.parentElement!==ue&&ue.appendChild(Me),Me.style.margin="16px 0 0",Me.style.alignItems="flex-start",Me.style.alignSelf="flex-start",Me.style.justifyContent="flex-start"):Me!=null&&Me.parentElement&&Me.parentElement.removeChild(Me)),!y&&Ue.parentElement&&Ue.parentElement.removeChild(Ue),M&&me&&(me.parentElement&&me.parentElement!==Je&&me.parentElement.removeChild(me),Je.appendChild(me),me.style.alignSelf="stretch"),ur(zt),ur(O)}function O(){if(typeof document>"u"||!(Je!=null&&Je.isConnected))return;const m=typeof Je.getBoundingClientRect=="function"?Je.getBoundingClientRect():null,y=m!=null&&m.width?Math.round(m.width):0;y&&document.documentElement.style.setProperty("--map-layout-width",`${y}px`)}function V(m={}){const y=Number.isFinite(m.x)?m.x:0,M=Number.isFinite(m.y)?m.y:0;return{x:y,y:M}}function be(m={}){const y=Y(),M=s.viewport.width||y.cols||Vt,v=s.viewport.height||y.rows||Vt,N=V(m),P=Math.floor(M/2),G=Math.floor(v/2);return{xStart:Math.round(N.x)-P,yStart:Math.round(N.y)-G}}function se(m={},y=0){const M=Number.isFinite(m.x)?Math.trunc(m.x):null,v=Number.isFinite(m.y)?Math.trunc(m.y):null;if(M===null||v===null)return null;const N=m.id||`marker-${y}`,P=m.icon===void 0||m.icon===null?"":String(m.icon),G=m.className||"",q=!!m.emphasis,j=m.label||"";return{id:N,x:M,y:v,icon:P,className:G,emphasis:q,label:j}}function De(){var v,N,P,G,q;if(!s.markerLayer)return;if(!((N=(v=s.map)==null?void 0:v.tiles)!=null&&N.length)){s.markerElements.forEach(j=>{j&&(j.style.display="none")});return}const m=s.map.width||((G=(P=s.map.tiles)==null?void 0:P[0])==null?void 0:G.length)||0,y=s.map.height||((q=s.map.tiles)==null?void 0:q.length)||0;if(!m||!y||!s.camera){s.markerElements.forEach(j=>{j&&(j.style.display="none")});return}const M=new Set;s.markerDefs.forEach(j=>{const pe=j.x-s.map.xStart,$e=j.y-s.map.yStart;if(!Number.isFinite(pe)||!Number.isFinite($e))return;if(pe<0||$e<0||pe>=m||$e>=y){const Pe=s.markerElements.get(j.id);Pe&&(Pe.style.display="none");return}let oe=s.markerElements.get(j.id);oe||(oe=document.createElement("span"),oe.className="map-marker",oe.style.position="absolute",oe.style.transform="translate(-50%, -50%)",oe.style.pointerEvents="none",oe.style.lineHeight="1",oe.style.textShadow="0 0 4px rgba(0, 0, 0, 0.35)",s.markerLayer.appendChild(oe),s.markerElements.set(j.id,oe)),oe.textContent=j.icon,oe.style.fontSize=j.emphasis?"1.6em":"1.4em",j.label?(oe.title=j.label,oe.setAttribute("aria-label",j.label)):(oe.removeAttribute("title"),oe.removeAttribute("aria-label"));const Be=["map-marker"];j.className&&Be.push(j.className),j.emphasis&&Be.push("map-marker--emphasis"),oe.className=Be.join(" ");const Ce=s.camera.worldToScreenCenter(j.x,j.y,s.tileBaseSize);if(!(Number.isFinite(Ce.x)&&Number.isFinite(Ce.y)&&Ce.x>=0&&Ce.y>=0&&Ce.x<=s.camera.viewportWidth&&Ce.y<=s.camera.viewportHeight)){oe.style.display="none";return}oe.style.left=`${Ce.x}px`,oe.style.top=`${Ce.y}px`,oe.style.display="block",M.add(j.id)}),s.markerElements.forEach((j,pe)=>{!M.has(pe)&&j&&(j.style.display="none")})}function ot(m=[]){const y=Array.isArray(m)?m.map((M,v)=>se(M,v)).filter(Boolean):[];s.markerDefs=y,De()}function Et(){if(!Oe)return;const m=Number.isFinite(s.initialZoom)?s.initialZoom:1,y=F();Oe.update({zoom:y,minZoom:s.minZoom,maxZoom:s.maxZoom,baselineZoom:m,camera:s.camera})}function dt(){const m=Number.isFinite(s.zoomDisplayFactor)?s.zoomDisplayFactor:1,y=F();if(s.renderer){const M=s.camera?y:m||1;s.renderer.setScale(M)}tn(),Et()}function ze(m,y={}){let M=m;if(s.camera){const v=s.camera.zoom;if(M=s.camera.setZoom(m,y.pivot==="viewport"?"viewport":"centerTile"),!y.force&&Math.abs(M-v)<.001){s.zoom=M,Ye(),dt();return}s.zoom=M}else{if(M=Math.min(s.maxZoom,Math.max(s.minZoom,m)),!y.force&&Math.abs(M-s.zoom)<.001){Ye(),dt();return}s.zoom=M}Xe({forceFetch:!!y.force}),Ye(),dt()}function bt(m){ze(F()+m)}function qt(){ze(s.initialZoom||1)}function zt(){if(!s.renderer)return;const m=Number.isFinite(s.tileBaseSize)&&s.tileBaseSize>0?s.tileBaseSize:Ml;s.renderer.setTileBaseSize(m),s.renderer.setUseTerrainColors(s.useTerrainColors);const y=F(),M=s.camera?y:s.zoomDisplayFactor||1;s.renderer.setScale(M),tn()}function zn(){var P,G,q;if(!s.map)return;const m=((G=(P=s.map.tiles)==null?void 0:P[0])==null?void 0:G.length)||0,y=((q=s.map.tiles)==null?void 0:q.length)||0;let M=null;if(typeof(Je==null?void 0:Je.getBoundingClientRect)=="function"){const j=Je.getBoundingClientRect();M=(j==null?void 0:j.width)||null}if(Ue.parentElement===ue&&typeof Ue.getBoundingClientRect=="function"){const j=Ue.getBoundingClientRect(),pe=(j==null?void 0:j.width)||0;M=Math.max(0,(M||0)-pe-16)}if(!M&&typeof(e==null?void 0:e.getBoundingClientRect)=="function"){const j=e.getBoundingClientRect();M=(j==null?void 0:j.width)||null}const{width:v,height:N}=_m(m,y,M);Ne.style.width=`${v}px`,Ne.style.height=`${N}px`,s.renderer&&s.renderer.resize(v,N),s.camera&&s.camera.setViewportSize(v,N),zt(),ur(()=>{O(),De()})}function Pn(m={}){s.home=be(s.focus),ht(s.home.xStart,s.home.yStart,m)}function qe(m={},y={}){s.focus=V(m),s.context={...s.context,focus:{...s.focus}},s.home=be(s.focus),y.recenter!==!1&&Pn(y)}function Lt({snap:m=!1}={}){var P,G,q,j,pe,$e,oe;if(!s.camera)return;const y=Number.isFinite(s.viewport.width)?s.viewport.width:((P=s.map)==null?void 0:P.width)||((j=(q=(G=s.map)==null?void 0:G.tiles)==null?void 0:q[0])==null?void 0:j.length)||0,M=Number.isFinite(s.viewport.height)?s.viewport.height:((pe=s.map)==null?void 0:pe.height)||((oe=($e=s.map)==null?void 0:$e.tiles)==null?void 0:oe.length)||0;if(!y||!M)return;const v=s.viewport.xStart+y/2,N=s.viewport.yStart+M/2;s.camera.setCenterTile({x:v,y:N},{snap:m})}function en(m={}){var $e,oe,Be,Ce,et,Pe,it,nn,Pt;if(!s.camera)return;const y=m.center||null,M=m.forceFetch===!0,v=Number.isFinite(s.viewport.width)?s.viewport.width:(($e=s.map)==null?void 0:$e.width)||((Ce=(Be=(oe=s.map)==null?void 0:oe.tiles)==null?void 0:Be[0])==null?void 0:Ce.length)||0,N=Number.isFinite(s.viewport.height)?s.viewport.height:((et=s.map)==null?void 0:et.height)||((it=(Pe=s.map)==null?void 0:Pe.tiles)==null?void 0:it.length)||0;if(!v||!N)return;const P=y||s.camera.centerTile,G=Math.round(P.x-v/2),q=Math.round(P.y-N/2),j=Number.isFinite(s.viewport.xStart)?s.viewport.xStart:((nn=s.map)==null?void 0:nn.xStart)||0,pe=Number.isFinite(s.viewport.yStart)?s.viewport.yStart:((Pt=s.map)==null?void 0:Pt.yStart)||0;G===j&&q===pe||ht(G,q,{forceFetch:M})}function Xt(){var m;(m=s.keyboardPan)!=null&&m.timer&&(clearTimeout(s.keyboardPan.timer),s.keyboardPan.timer=null)}function ir(){Xt(),s.keyboardPan.timer=setTimeout(()=>{s.keyboardPan.timer=null,no()},$m)}function no(m={}){if(!s.camera)return null;Xt();let y=!1;const M=s.camera.commitSnap({animate:m.animate!==!1,duration:m.duration,onUpdate:()=>{tn()},onComplete:v=>{y=!0,tn(),en({center:v,forceFetch:!!m.forceFetch})}});return!y&&!(M!=null&&M.changed)&&en({forceFetch:!!m.forceFetch}),M}function pi(m,y,M){var P;if(!m)return;ve.forEach(G=>m.classList.remove(G)),delete m.dataset.development,delete m.dataset.developmentLabel,delete m.dataset.developmentStatus,delete m.dataset.developmentDetails,delete m.dataset.developmentCount;const v=Ge(y,M);if(!v)return;m.classList.add("map-tile--developed"),v.status==="under-construction"?m.classList.add("map-tile--developed-pending"):v.status==="completed"?m.classList.add("map-tile--developed-complete"):v.status==="planned"?m.classList.add("map-tile--developed-planned"):m.classList.add("map-tile--developed-mixed"),(v.emphasis||v.highlight)&&m.classList.add("map-tile--developed-emphasis"),m.dataset.development="true",v.label&&(m.dataset.developmentLabel=v.label),v.status&&(m.dataset.developmentStatus=v.status);const N=v.tooltip||((P=v.structures)!=null&&P.length?v.structures.join(", "):"");N&&(m.dataset.developmentDetails=N),Number.isFinite(v.count)&&v.count>0&&(m.dataset.developmentCount=`${v.count}`)}function jn(){var G,q,j,pe,$e,oe;const m=s.dataLayer;if(!m)return;if(!((q=(G=s.map)==null?void 0:G.tiles)!=null&&q.length)){m.replaceChildren();return}const y=s.map.tiles.length,M=((j=s.map.tiles[0])==null?void 0:j.length)||0;if(!y||!M){m.replaceChildren();return}const v=y*M;if(m.children.length!==v){const Be=document.createDocumentFragment();for(let Ce=0;Ce<v;Ce++){const et=document.createElement("span");et.className="map-tile";const Pe=document.createElement("span");Pe.className="map-tile-symbol",et.appendChild(Pe),Be.appendChild(et)}m.replaceChildren(Be)}const N=m.children;let P=0;for(let Be=0;Be<y;Be++)for(let Ce=0;Ce<M;Ce++){const et=N[P++];if(!(et instanceof HTMLElement))continue;const Pe=et;let it=Pe.firstElementChild;it instanceof HTMLElement||(it=document.createElement("span"),it.className="map-tile-symbol",Pe.appendChild(it));const nn=s.map.xStart+Ce,Pt=s.map.yStart+Be;Pe.dataset.col=`${Ce}`,Pe.dataset.row=`${Be}`,Pe.dataset.worldX=`${nn}`,Pe.dataset.worldY=`${Pt}`;const un=(($e=(pe=s.map.types)==null?void 0:pe[Be])==null?void 0:$e[Ce])??null;un?Pe.dataset.terrain=un:delete Pe.dataset.terrain;const Lr=((oe=s.map.tiles[Be])==null?void 0:oe[Ce])??"",Mn=Ve(un);it&&(it.textContent=Lr??"",it.style.backgroundColor=Mn||"transparent",it.style.borderRadius=Mn?"6px":"",it.style.boxShadow=Mn?"inset 0 0 0 1px rgba(0, 0, 0, 0.18)":""),Mn?Pe.classList.add("map-tile--fill"):Pe.classList.remove("map-tile--fill"),pi(Pe,nn,Pt)}}function tn(){!s.renderer||s.renderScheduled||(s.renderScheduled=!0,ur(()=>{s.renderScheduled=!1,mi()}))}function mi(){var m,y;if(s.renderer){if(!((y=(m=s.map)==null?void 0:m.tiles)!=null&&y.length)){s.renderer.setMap(null),s.renderer.render(),De(),jn(),vn({fromRender:!0});return}s.renderer.setMap({...s.map}),s.renderer.render(),jn(),De(),vn({fromRender:!0})}}function ro(){var M,v,N,P,G;const m=Number.isFinite(s.viewport.width)?s.viewport.width:((N=(v=(M=s.map)==null?void 0:M.tiles)==null?void 0:v[0])==null?void 0:N.length)||0,y=Number.isFinite(s.viewport.height)?s.viewport.height:((G=(P=s.map)==null?void 0:P.tiles)==null?void 0:G.length)||0;return{maxX:Math.max(0,Math.trunc(m)-1),maxY:Math.max(0,Math.trunc(y)-1)}}function hi(){var M,v,N,P,G;const m=s.viewport.width||((N=(v=(M=s.map)==null?void 0:M.tiles)==null?void 0:v[0])==null?void 0:N.length)||0,y=s.viewport.height||((G=(P=s.map)==null?void 0:P.tiles)==null?void 0:G.length)||0;return!m||!y?null:{stepX:Math.max(1,Math.floor(m*.5)),stepY:Math.max(1,Math.floor(y*.5))}}function Oo(m,y,M={}){if(!m&&!y)return;const v=hi();if(!v)return;const N=v.stepX*m,P=v.stepY*y;if(!(!N&&!P)){if(s.camera){dn(N,P,M);return}dn(N,P,M)}}function dn(m,y,M={}){var oe,Be;if(!m&&!y)return;const{maxX:v,maxY:N}=ro(),P=lo(m,-v,v),G=lo(y,-N,N);if(!P&&!G)return;if(s.camera){s.camera.panBy(P,G);const Ce=s.camera.centerTile;en({center:Ce,forceFetch:M.forceFetch});const et=s.camera.centerTile,Pe=Ce.x-et.x,it=Ce.y-et.y;(Math.abs(Pe)>1e-6||Math.abs(it)>1e-6)&&s.camera&&s.camera.panBy(Pe,it),tn(),M.deferCommit?ir():M.commit!==!1&&no({animate:M.animate!==!1,forceFetch:M.forceFetch});return}const q=Number.isFinite(s.viewport.xStart)?s.viewport.xStart:((oe=s.map)==null?void 0:oe.xStart)||0,j=Number.isFinite(s.viewport.yStart)?s.viewport.yStart:((Be=s.map)==null?void 0:Be.yStart)||0,pe=q+P,$e=j+G;ht(pe,$e,M)}function ar(m,y){Oo(m,y)}function zo(){if(!n||!vt)return;const m=s.navMode==="player"?"Travel":"Pan",y=s.navMode==="player"?"Center on explorer":"Recenter map";[{label:"↖",dx:-1,dy:-1,aria:`${m} northwest`},{label:"↑",dx:0,dy:-1,aria:`${m} north`},{label:"↗",dx:1,dy:-1,aria:`${m} northeast`},{label:"←",dx:-1,dy:0,aria:`${m} west`},{label:"⌂",recenter:!0,aria:y},{label:"→",dx:1,dy:0,aria:`${m} east`},{label:"↙",dx:-1,dy:1,aria:`${m} southwest`},{label:"↓",dx:0,dy:1,aria:`${m} south`},{label:"↘",dx:1,dy:1,aria:`${m} southeast`}].forEach(v=>{const N=document.createElement("button");N.type="button",N.textContent=v.label,N.setAttribute("aria-label",v.aria),_(N,{variant:"chip",fontSize:"22px"}),N.addEventListener("click",()=>{v.recenter?s.navMode==="player"&&typeof s.onNavigate=="function"?s.onNavigate({dx:0,dy:0,recenter:!0}):Pn():s.navMode==="player"&&typeof s.onNavigate=="function"?s.onNavigate({dx:v.dx??0,dy:v.dy??0,recenter:!1}):ar(v.dx,v.dy)}),vt.appendChild(N)})}function sr(m){if(!m||typeof m.key!="string")return;const y=Rm[m.key];if(y){if(s.navMode==="player"&&typeof s.onNavigate=="function"){m.preventDefault(),s.onNavigate({dx:y.dx,dy:y.dy,recenter:!1});return}m.preventDefault(),Oo(y.dx,y.dy,{deferCommit:!0})}}function lr(m,y){o&&(ft(),gt(),s.drag.active=!0,s.drag.lastX=m,s.drag.lastY=y,s.drag.pendingX=0,s.drag.pendingY=0,s.drag.fractionalX=0,s.drag.fractionalY=0,Xt(),Ne.style.cursor="grabbing")}function gi(m,y){var it,nn,Pt,un,Lr;if(!s.drag.active)return;const M=m-s.drag.lastX,v=y-s.drag.lastY;s.drag.lastX=m,s.drag.lastY=y,s.drag.pendingX-=M,s.drag.pendingY-=v;const N=((Pt=(nn=(it=s.map)==null?void 0:it.tiles)==null?void 0:nn[0])==null?void 0:Pt.length)||s.viewport.width||0,P=((Lr=(un=s.map)==null?void 0:un.tiles)==null?void 0:Lr.length)||s.viewport.height||0;if(!N||!P)return;const q=(s.dataLayer||At).getBoundingClientRect(),j=q.width/N,pe=q.height/P;if(!j||!pe)return;if(s.camera){let Mn=!1;const Po=Math.trunc(s.drag.pendingX/j),jo=Math.trunc(s.drag.pendingY/pe);if(Po||jo){const{maxX:Js,maxY:Qs}=ro(),$a=lo(Po,-Js,Js),Ha=lo(jo,-Qs,Qs);$a||Ha?(s.drag.pendingX-=$a*j,s.drag.pendingY-=Ha*pe,dn($a,Ha,{commit:!1}),Mn=!0):(s.drag.pendingX=Math.sign(s.drag.pendingX)*Math.min(Math.abs(s.drag.pendingX),j),s.drag.pendingY=Math.sign(s.drag.pendingY)*Math.min(Math.abs(s.drag.pendingY),pe))}const _o=j?s.drag.pendingX/j:0,bi=pe?s.drag.pendingY/pe:0,Ks=_o-s.drag.fractionalX,Zs=bi-s.drag.fractionalY;(Ks||Zs)&&(s.camera.panBy(Ks,Zs),Mn=!0),Mn&&tn(),s.drag.fractionalX=_o,s.drag.fractionalY=bi;return}const $e=Math.trunc(s.drag.pendingX/j),oe=Math.trunc(s.drag.pendingY/pe);if(!$e&&!oe)return;const{maxX:Be,maxY:Ce}=ro(),et=lo($e,-Be,Be),Pe=lo(oe,-Ce,Ce);!et&&!Pe||(s.drag.pendingX-=et*j,s.drag.pendingY-=Pe*pe,dn(et,Pe))}function _n(){s.drag.active&&(s.drag.active=!1,Ne.style.cursor=o?"grab":"default",s.drag.pendingX=0,s.drag.pendingY=0,s.drag.fractionalX=0,s.drag.fractionalY=0,s.camera&&no())}function Ud(){if(!o)return null;const m=M=>{s.drag.active&&(M.preventDefault(),gi(M.clientX,M.clientY))},y=M=>{var N;if(!s.drag.active||!((N=M.touches)!=null&&N.length))return;const v=M.touches[0];gi(v.clientX,v.clientY),M.preventDefault()};return Ne.addEventListener("mousedown",M=>{M.preventDefault(),lr(M.clientX,M.clientY)}),Ne.addEventListener("touchstart",M=>{var N;if(!((N=M.touches)!=null&&N.length))return;const v=M.touches[0];lr(v.clientX,v.clientY),M.preventDefault()},{passive:!1}),window.addEventListener("mousemove",m),window.addEventListener("mouseup",_n),window.addEventListener("touchmove",y,{passive:!1}),window.addEventListener("touchend",_n),window.addEventListener("touchcancel",_n),()=>{window.removeEventListener("mousemove",m),window.removeEventListener("mouseup",_n),window.removeEventListener("touchmove",y),window.removeEventListener("touchend",_n),window.removeEventListener("touchcancel",_n)}}Ne.addEventListener("keydown",sr);const Vs=Ud();return dt(),zo(),X(),typeof window<"u"&&(s.resizeHandler=()=>{zn(),X()},window.addEventListener("resize",s.resizeHandler)),{setMap(m,y={}){var G,q,j,pe,$e,oe;s.hasInitializedBaseChunk=!1,s.context={...s.context,...y};const M=(y==null?void 0:y.focus)??(y==null?void 0:y.center)??(y==null?void 0:y.current)??(y==null?void 0:y.currentCoords)??(y==null?void 0:y.homeCoords)??s.focus;if(s.focus=V(M),!m){s.map=null,s.buffer=null,s.context={...s.context,focus:{...s.focus}},s.zoomBase={width:0,height:0},s.zoomDisplayFactor=1,s.zoom=1,s.pendingZoomSync=!1,Ft([]),s.camera&&s.camera.setCenterTile({x:s.focus.x,y:s.focus.y},{snap:!0}),ze(1,{force:!0}),s.renderer&&(s.renderer.setMap(null),s.renderer.setScale(1)),tn(),dt(),jn();return}const v=El(m);(G=v==null?void 0:v.tiles)!=null&&G.length&&(s.hasInitializedBaseChunk=!0),s.buffer=v,Z(v);const N=m.viewport??(v==null?void 0:v.viewport)??null;N?(s.viewport.width=Math.max(1,kt(N.width,s.viewport.width)),s.viewport.height=Math.max(1,kt(N.height,s.viewport.height)),s.viewport.xStart=kt(N.xStart,(v==null?void 0:v.xStart)??s.viewport.xStart??0),s.viewport.yStart=kt(N.yStart,(v==null?void 0:v.yStart)??s.viewport.yStart??0)):v?(s.viewport.xStart=kt(m.xStart??v.xStart,v.xStart),s.viewport.yStart=kt(m.yStart??v.yStart,v.yStart)):(s.viewport.xStart=kt(m.xStart,s.viewport.xStart??0),s.viewport.yStart=kt(m.yStart,s.viewport.yStart??0)),Z(v),s.map={seed:m.seed??(v==null?void 0:v.seed)??((q=s.map)==null?void 0:q.seed),season:m.season??(v==null?void 0:v.season)??((j=s.map)==null?void 0:j.season),waterLevel:m.waterLevel??(v==null?void 0:v.waterLevel)??((pe=s.map)==null?void 0:pe.waterLevel),tiles:[],types:null,elevations:null,xStart:s.viewport.xStart,yStart:s.viewport.yStart,width:s.viewport.width,height:s.viewport.height},(!s.zoomBase.width||!s.zoomBase.height)&&(s.zoomBase.width=Math.max(1,s.viewport.width||(($e=s.map)==null?void 0:$e.width)||Vt),s.zoomBase.height=Math.max(1,s.viewport.height||((oe=s.map)==null?void 0:oe.height)||Vt)),s.pendingZoomSync=Math.abs(s.zoom-1)>.001,s.context={...s.context,focus:{...s.focus},seed:s.map.seed,season:s.map.season},s.home=be(s.focus);const P=zm(m);if(Ft(P),(!Number.isFinite(s.viewport.xStart)||!Number.isFinite(s.viewport.yStart))&&(s.viewport.xStart=s.home.xStart,s.viewport.yStart=s.home.yStart),Lt({snap:!0}),v){if(!ke()){ht(s.viewport.xStart,s.viewport.yStart,{forceFetch:!0});return}s.viewport.xStart!==s.home.xStart||s.viewport.yStart!==s.home.yStart?ht(s.home.xStart,s.home.yStart):Ke();return}tn(),ht(s.viewport.xStart,s.viewport.yStart,{forceFetch:!0})},refresh(){zn(),zt(),X()},setTerrainColors(m=null,y={}){var v,N;const{forceRefresh:M=!1}=y||{};m===!1?s.terrainColorOverrides=null:m&&typeof m=="object"&&(s.terrainColorOverrides=kl(m)),M&&Ls({forceRefresh:!0}),s.useTerrainColors&&((N=(v=s.map)==null?void 0:v.tiles)!=null&&N.length)&&(jn(),tn())},setJobOptions(m=[],y={}){Do(m,y)},getSelectedJob(){return Ie.selectedId},center:Pn,setFocus:qe,setMarkers:ot,setDevelopments:Ft,destroy(){Xt(),typeof window<"u"&&(s.resizeHandler&&window.removeEventListener("resize",s.resizeHandler),Vs&&Vs()),s.markerElements.forEach(m=>{m!=null&&m.parentElement&&m.parentElement.removeChild(m)}),s.markerElements.clear(),s.markerDefs=[],s.markerLayer=null,Je.parentElement&&Je.parentElement.removeChild(Je),Yt(!1),s.developmentTiles=new Map,ae.clear(),D(),fe!=null&&fe.parentElement&&fe.parentElement.removeChild(fe),fe=null,W=null,Se=null,ge=null,Le=null,typeof document<"u"&&document.documentElement.style.removeProperty("--map-layout-width"),Ne.removeEventListener("keydown",sr)},elements:{layout:Je,mapContainer:ue,wrapper:Ne,stage:Ut,display:Q,canvas:rt,markers:_e,controls:Me,nav:vt,controlDetails:Ae,actionPanel:me,actionButtons:at,jobSelect:W,zoom:Oe?Oe.element:null,navOverlay:St}}}const Jc="theme:selected",Qc="theme:appearance",Bs=["theme"],Wm=new Map([["lunar-surface-dawn","lunar-surface"]]),ed=new Set(["light","dark"]),Um=["red","orange","yellow","green","blue","pink","purple","brown"];function Xr(e,t=0,n=1){return typeof e!="number"||Number.isNaN(e)?t:Math.min(Math.max(e,t),n)}function Tt(e){if(!e)return null;const t=String(e).trim();if(!t)return null;const n=t.startsWith("#")?t.slice(1):t;if(/^([0-9a-f]{6})$/i.test(n))return`#${n.toLowerCase()}`;if(/^([0-9a-f]{3})$/i.test(n)){const[r,o,i]=n.split("");return`#${r}${r}${o}${o}${i}${i}`.toLowerCase()}return null}function ls(e){const t=Tt(e);if(!t)return null;const n=t.slice(1),r=parseInt(n.slice(0,2),16),o=parseInt(n.slice(2,4),16),i=parseInt(n.slice(4,6),16);return[r,o,i].some(a=>Number.isNaN(a))?null:{r,g:o,b:i}}function Ym({r:e,g:t,b:n}){const r=Xr(Math.round(e),0,255),o=Xr(Math.round(t),0,255),i=Xr(Math.round(n),0,255);return`#${[r,o,i].map(a=>a.toString(16).padStart(2,"0")).join("")}`}function mr(e,t,n=.5){const r=ls(e),o=ls(t);if(!r||!o)return Tt(e)||Tt(t);const i=Xr(n,0,1);return Ym({r:r.r*(1-i)+o.r*i,g:r.g*(1-i)+o.g*i,b:r.b*(1-i)+o.b*i})}function _i(e,t=.15){return mr(e,"#ffffff",Xr(t,0,1))}function qi(e,t=.15){return mr(e,"#000000",Xr(t,0,1))}function cs(e){const t=ls(e);if(!t)return 0;const n=[t.r,t.g,t.b].map(r=>{const o=r/255;return o<=.03928?o/12.92:Math.pow((o+.055)/1.055,2.4)});return .2126*n[0]+.7152*n[1]+.0722*n[2]}function Ci(e,t){const n=Tt(e),r=Tt(t);if(!n||!r)return 1;const o=cs(n),i=cs(r),a=Math.max(o,i),d=Math.min(o,i);return(a+.05)/(d+.05)}function Fr(e,t,n=4.5){const r=Tt(t);if(!r)return Tt(e)||"#ffffff";const o=Tt(e),i=cs(r),a=i>.5?"#111827":"#f9fafb",d=i>.5?"#f9fafb":"#111827",l=[];o&&l.push({color:o,ratio:Ci(o,r)}),l.push({color:Tt(a),ratio:Ci(a,r)}),l.push({color:Tt(d),ratio:Ci(d,r)});let c=l.filter(h=>h.color).sort((h,g)=>g.ratio-h.ratio)[0];if(!c)return"#ffffff";if(c.ratio>=n)return c.color;const f=i>.5?"#000000":"#ffffff";let u=c.color,p=c.ratio;for(let h=0;h<6&&p<n;h+=1)u=mr(u,f,.35),p=Ci(u,r);return p>=n?u:c.color}function Yo(e={}){const t=Tt(e.base)||Tt(e.light)||Tt(e.dark)||"#6b7280",n=Tt(e.light)||_i(t,.18),r=Tt(e.dark)||qi(t,.22);return{light:n,base:Tt(e.base)||t,dark:r}}const kr=[{id:"lunar-surface",meta:{label:"Lunar Surface",emoji:"🌕",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Full%20Moon/3D/full_moon_3d.png"},appearance:"dark",colors:{background:{light:"#2d3036",base:"#1f2228",dark:"#111419"},neutral:{light:"#dfe3eb",base:"#c7cbd3",dark:"#5f646f"},primary:{light:"#d6dae2",base:"#c3c8d0",dark:"#7b808a"},secondary:{light:"#d8dce4",base:"#c3c7cf",dark:"#757a84"},accent:{light:"#dfe3eb",base:"#ccd1d9",dark:"#8b9098"}},standardColors:{red:{light:"#d7dadd",dark:"#6b6e74"},orange:{light:"#cfd1d6",dark:"#686b71"},yellow:{light:"#c7cacf",dark:"#5f6268"},green:{light:"#c1c4c9",dark:"#585b60"},blue:{light:"#bbbfc5",dark:"#51555c"},pink:{light:"#d2d5da",dark:"#6a6d73"},purple:{light:"#c6c9d0",dark:"#5d6168"},brown:{light:"#bfc2c7",dark:"#55585e"}},text:{primary:"#f0f2f7",muted:"#dde1e8"},appearances:{light:{colors:{background:{light:"#f5f6f8",base:"#e5e7eb",dark:"#c2c5cc"},neutral:{light:"#4f5359",base:"#383c42",dark:"#202329"},primary:{light:"#6d7178",base:"#555960",dark:"#3a3e44"},secondary:{light:"#90949c",base:"#757981",dark:"#4f535a"},accent:{light:"#a4a8b0",base:"#878b93",dark:"#5d6168"}},standardColors:{red:{light:"#a6a9af",dark:"#4a4d53"},orange:{light:"#b0b3b9",dark:"#505359"},yellow:{light:"#bbbfc6",dark:"#555960"},green:{light:"#aeb1b8",dark:"#4c5056"},blue:{light:"#a1a5ac",dark:"#45494f"},pink:{light:"#b7bac1",dark:"#53565d"},purple:{light:"#bfc2ca",dark:"#595d63"},brown:{light:"#a7abb2",dark:"#4a4e54"}},text:{primary:"#1c1f23",muted:"#4f535a"}}}},{id:"apple-orchard",meta:{label:"Apple Orchard",emoji:"🍎",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Red%20Apple/3D/red_apple_3d.png"},appearance:"dark",colors:{background:{light:"#3a181b",base:"#271012",dark:"#120708"},neutral:{light:"#e4cfc9",base:"#b68f84",dark:"#7d6257"},primary:{light:"#ff6b6f",base:"#d9393e",dark:"#941c20"},secondary:{light:"#8ed97a",base:"#5faa4c",dark:"#3a6f2b"},accent:{light:"#f0b36a",base:"#c87f2f",dark:"#8a4f12"}},standardColors:{red:{light:"#ff6b6f",dark:"#941c20"},orange:{light:"#ff9b4f",dark:"#a85318"},yellow:{light:"#ffe38a",dark:"#b38a1b"},green:{light:"#8ed97a",dark:"#2f6b2a"},blue:{light:"#7fc1f7",dark:"#215b8e"},pink:{light:"#f7a1b5",dark:"#9a4963"},purple:{light:"#c29aff",dark:"#6c3ab8"},brown:{light:"#d7a47d",dark:"#7b4a2d"}},text:{primary:"#fbeae7",muted:"#c7a8a0"}},{id:"heartbeat-glow",meta:{label:"Heartbeat Glow",emoji:"❤️",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Red%20Heart/3D/red_heart_3d.png"},appearance:"dark",colors:{background:{light:"#431a2a",base:"#301320",dark:"#14060d"},neutral:{light:"#efd1da",base:"#c79aa9",dark:"#8a6976"},primary:{light:"#ff6b8f",base:"#ff3366",dark:"#b1123d"},secondary:{light:"#ffa4d9",base:"#ff6fbf",dark:"#c13f8a"},accent:{light:"#ffd27f",base:"#ffb347",dark:"#b47618"}},standardColors:{red:{light:"#ff6b8f",dark:"#b1123d"},orange:{light:"#ff9354",dark:"#b5541c"},yellow:{light:"#ffe382",dark:"#b88a20"},green:{light:"#9de2c0",dark:"#2f7a52"},blue:{light:"#7fbbff",dark:"#245a9d"},pink:{light:"#ff9ed1",dark:"#aa4d83"},purple:{light:"#c69dff",dark:"#6f3fab"},brown:{light:"#d7a691",dark:"#7a4937"}},text:{primary:"#ffeef3",muted:"#d7a3b7"}},{id:"evergreen-grove",meta:{label:"Evergreen Grove",emoji:"🌳",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Evergreen%20Tree/3D/evergreen_tree_3d.png"},appearance:"light",colors:{background:{light:"#f7fbf5",base:"#edf5eb",dark:"#c7d5c4"},neutral:{light:"#88977f",base:"#5b6a54",dark:"#394637"},primary:{light:"#63b36a",base:"#3d8543",dark:"#24562a"},secondary:{light:"#9dc98a",base:"#7aa66a",dark:"#4c7341"},accent:{light:"#f2c78d",base:"#c9985b",dark:"#8f6330"}},standardColors:{red:{light:"#f07f6f",dark:"#9c3b2c"},orange:{light:"#f6a85f",dark:"#b16019"},yellow:{light:"#fbe183",dark:"#b39829"},green:{light:"#7dd687",dark:"#2d6a35"},blue:{light:"#7fb5d9",dark:"#285c7d"},pink:{light:"#f2adc5",dark:"#9b4f74"},purple:{light:"#bfa6ec",dark:"#62479f"},brown:{light:"#cba581",dark:"#6c4b2e"}},text:{primary:"#263322",muted:"#546250"}},{id:"ember-forge",meta:{label:"Ember Forge",emoji:"🔥",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Fire/3D/fire_3d.png"},appearance:"dark",colors:{background:{light:"#401812",base:"#2a0f0a",dark:"#120503"},neutral:{light:"#f1d0c2",base:"#d0a89b",dark:"#946f63"},primary:{light:"#ff8a52",base:"#ff6b2d",dark:"#b73c07"},secondary:{light:"#ffc075",base:"#ff9f43",dark:"#c36a15"},accent:{light:"#ffe28a",base:"#ffd166",dark:"#b99229"}},standardColors:{red:{light:"#ff7053",dark:"#b12f1a"},orange:{light:"#ff9f43",dark:"#b55311"},yellow:{light:"#ffd76a",dark:"#b48b16"},green:{light:"#a4d67a",dark:"#436a1f"},blue:{light:"#77b4e8",dark:"#1f5387"},pink:{light:"#f293b3",dark:"#9d4363"},purple:{light:"#c79ae8",dark:"#69399c"},brown:{light:"#d49c71",dark:"#7c451b"}},text:{primary:"#fff2ea",muted:"#ddb09e"}},{id:"fireworks-festival",meta:{label:"Fireworks Festival",emoji:"🎆",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Fireworks/3D/fireworks_3d.png"},appearance:"light",colors:{background:{light:"#fbfdff",base:"#f4f7ff",dark:"#d0d9f5"},neutral:{light:"#6f7691",base:"#4e5470",dark:"#313752"},primary:{light:"#6d81ff",base:"#3d5af1",dark:"#2235a3"},secondary:{light:"#ff83da",base:"#ff4ecd",dark:"#c11c92"},accent:{light:"#ffe67a",base:"#ffd74f",dark:"#b89711"}},standardColors:{red:{light:"#ff6a86",dark:"#b31e3d"},orange:{light:"#ff9a4a",dark:"#b35d0d"},yellow:{light:"#ffe67a",dark:"#b5971a"},green:{light:"#94e6c3",dark:"#2c7d4f"},blue:{light:"#6fb6ff",dark:"#205ea2"},pink:{light:"#ffa0de",dark:"#b94b91"},purple:{light:"#b79aff",dark:"#5b38b4"},brown:{light:"#c8a37a",dark:"#704c22"}},text:{primary:"#202544",muted:"#535a79"}},{id:"rose-garden",meta:{label:"Rose Garden",emoji:"🌹",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Rose/3D/rose_3d.png"},appearance:"light",colors:{background:{light:"#fff9fb",base:"#fff4f6",dark:"#e7c7d0"},neutral:{light:"#9c6b7b",base:"#6f4a57",dark:"#402730"},primary:{light:"#ff7a9b",base:"#d03a59",dark:"#911932"},secondary:{light:"#ff98b8",base:"#ff7899",dark:"#c5476b"},accent:{light:"#b6daa1",base:"#8fbf72",dark:"#55773d"}},standardColors:{red:{light:"#ff7a9b",dark:"#911932"},orange:{light:"#ffad71",dark:"#b55e22"},yellow:{light:"#ffe6a3",dark:"#b59135"},green:{light:"#9fdda7",dark:"#3d7b43"},blue:{light:"#7fbef0",dark:"#2a6190"},pink:{light:"#ff9ec6",dark:"#b14a7e"},purple:{light:"#c8a1e8",dark:"#6a347f"},brown:{light:"#d2a28a",dark:"#744434"}},text:{primary:"#2c1a22",muted:"#5c3d47"}},{id:"melody-waves",meta:{label:"Melody Waves",emoji:"🎵",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Musical%20Notes/3D/musical_notes_3d.png"},appearance:"dark",colors:{background:{light:"#272b50",base:"#1a1d3b",dark:"#0a0b1b"},neutral:{light:"#d6d8f0",base:"#b5b8d8",dark:"#7c80a3"},primary:{light:"#7a8aff",base:"#5b6dff",dark:"#2c38b8"},secondary:{light:"#b68aff",base:"#9b58ff",dark:"#6221c1"},accent:{light:"#58e2d6",base:"#33d1c6",dark:"#17887e"}},standardColors:{red:{light:"#ff6c87",dark:"#a9203a"},orange:{light:"#ff9a55",dark:"#b1581a"},yellow:{light:"#ffdf73",dark:"#af8b18"},green:{light:"#7ce8c3",dark:"#1f7a54"},blue:{light:"#7fb6ff",dark:"#244ea2"},pink:{light:"#f99ade",dark:"#a7438a"},purple:{light:"#c49dff",dark:"#5f33b6"},brown:{light:"#c6a48a",dark:"#704b34"}},text:{primary:"#eef0ff",muted:"#bfc2df"}},{id:"ocean-tide",meta:{label:"Ocean Tide",emoji:"🌊",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Water%20Wave/3D/water_wave_3d.png"},appearance:"light",colors:{background:{light:"#f4fbfd",base:"#e7f4f9",dark:"#bfd6e1"},neutral:{light:"#73929e",base:"#4d6773",dark:"#2c3f46"},primary:{light:"#3b92c7",base:"#0f6fa4",dark:"#0a4a6e"},secondary:{light:"#55c0e6",base:"#2ba5d6",dark:"#176a8d"},accent:{light:"#f5c98a",base:"#f2b866",dark:"#af7a24"}},standardColors:{red:{light:"#f57c7d",dark:"#9c2d2f"},orange:{light:"#f7a65d",dark:"#b05919"},yellow:{light:"#ffe38a",dark:"#b59128"},green:{light:"#87dcb3",dark:"#2f7850"},blue:{light:"#68c3ff",dark:"#1e5d9a"},pink:{light:"#f4a7c8",dark:"#9e4a73"},purple:{light:"#b8a0f0",dark:"#5d3f9c"},brown:{light:"#c49a76",dark:"#6d4426"}},text:{primary:"#1f2f38",muted:"#4a5e69"}},{id:"sunburst-plains",meta:{label:"Sunburst Plains",emoji:"☀️",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Sun/3D/sun_3d.png"},appearance:"light",colors:{background:{light:"#fffdf5",base:"#fff8e6",dark:"#e9d5a5"},neutral:{light:"#9d8458",base:"#755f36",dark:"#4a3819"},primary:{light:"#ffbe4a",base:"#f4a11a",dark:"#b56a06"},secondary:{light:"#ffe066",base:"#ffcc33",dark:"#c1900b"},accent:{light:"#7cd3dc",base:"#5dbec8",dark:"#2d8087"}},standardColors:{red:{light:"#ff8360",dark:"#b33e1a"},orange:{light:"#ffb347",dark:"#b86612"},yellow:{light:"#ffe066",dark:"#b6910a"},green:{light:"#a7e37c",dark:"#4a8b20"},blue:{light:"#7fc4f5",dark:"#2a6aa6"},pink:{light:"#f9a4c2",dark:"#a64d6f"},purple:{light:"#c9a6ef",dark:"#6d459d"},brown:{light:"#d2a877",dark:"#704819"}},text:{primary:"#2c220e",muted:"#605235"}},{id:"lunar-serenity",meta:{label:"Lunar Serenity",emoji:"🌙",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Crescent%20Moon/3D/crescent_moon_3d.png"},appearance:"dark",colors:{background:{light:"#272a42",base:"#1a1c2e",dark:"#0c0d18"},neutral:{light:"#e0e3f0",base:"#c6c9dd",dark:"#8b8fa8"},primary:{light:"#9aa5ff",base:"#7c89ff",dark:"#3d48b8"},secondary:{light:"#daa9ff",base:"#c98bff",dark:"#8640c9"},accent:{light:"#ffe7a4",base:"#f6d87d",dark:"#b79a33"}},standardColors:{red:{light:"#ff7083",dark:"#ac2538"},orange:{light:"#ff9e55",dark:"#b35a1b"},yellow:{light:"#ffe18a",dark:"#b49028"},green:{light:"#8edcc2",dark:"#2f7860"},blue:{light:"#80c0ff",dark:"#245ca2"},pink:{light:"#f5a7da",dark:"#a55a92"},purple:{light:"#c3a2ff",dark:"#5e3ab2"},brown:{light:"#cdb196",dark:"#755a3b"}},text:{primary:"#f4f5ff",muted:"#c2c5da"}},{id:"frostfall-glade",meta:{label:"Frostfall Glade",emoji:"❄️",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Snowflake/3D/snowflake_3d.png"},appearance:"light",colors:{background:{light:"#ffffff",base:"#f2f8ff",dark:"#c7d8ea"},neutral:{light:"#6d7f93",base:"#4f6175",dark:"#2b3746"},primary:{light:"#6bc1f2",base:"#4aa4e0",dark:"#1f6498"},secondary:{light:"#b2e1ff",base:"#8fd0ff",dark:"#4d8ec7"},accent:{light:"#8ee4d8",base:"#6bd4c4",dark:"#2d8a7d"}},standardColors:{red:{light:"#f27f8e",dark:"#a23744"},orange:{light:"#f8ad6a",dark:"#b3621f"},yellow:{light:"#ffea95",dark:"#b59a24"},green:{light:"#7fdcc0",dark:"#2c7955"},blue:{light:"#6fc3ff",dark:"#1f5da0"},pink:{light:"#f4a6d5",dark:"#9d4f87"},purple:{light:"#bfa4f2",dark:"#5f419f"},brown:{light:"#c6a584",dark:"#6e4c2e"}},text:{primary:"#24364b",muted:"#54677f"}},{id:"granite-peaks",meta:{label:"Granite Peaks",emoji:"⛰️",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Mountain/3D/mountain_3d.png"},appearance:"dark",colors:{background:{light:"#2b2f32",base:"#1f2224",dark:"#0f1112"},neutral:{light:"#e0e3e7",base:"#c2c6cb",dark:"#8a8f95"},primary:{light:"#8a98a7",base:"#6d7e8f",dark:"#425260"},secondary:{light:"#c69b6c",base:"#a57e54",dark:"#6b4b26"},accent:{light:"#7fc2b5",base:"#57a999",dark:"#276f60"}},standardColors:{red:{light:"#f07672",dark:"#a32e2c"},orange:{light:"#f29a5a",dark:"#ae5c19"},yellow:{light:"#f5d877",dark:"#b08a1f"},green:{light:"#9dd2a7",dark:"#316a3a"},blue:{light:"#7fb1d4",dark:"#264d6c"},pink:{light:"#f0a6c5",dark:"#9a4f74"},purple:{light:"#b7a0d9",dark:"#5a417f"},brown:{light:"#c7a47f",dark:"#6d4a28"}},text:{primary:"#edf0f3",muted:"#b7bcc3"}},{id:"hearthside-brew",meta:{label:"Hearthside Brew",emoji:"☕",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Hot%20Beverage/3D/hot_beverage_3d.png"},appearance:"dark",colors:{background:{light:"#3f2720",base:"#2e1b13",dark:"#170c08"},neutral:{light:"#ecd8c9",base:"#d0b5a1",dark:"#9a7f6b"},primary:{light:"#d99260",base:"#c47a3d",dark:"#8a4614"},secondary:{light:"#ad6c45",base:"#8d4f2c",dark:"#5b2f14"},accent:{light:"#f6dba0",base:"#e5c27c",dark:"#b38a38"}},standardColors:{red:{light:"#f07262",dark:"#a32b1c"},orange:{light:"#f89c54",dark:"#ae5614"},yellow:{light:"#f8d072",dark:"#b1871a"},green:{light:"#97d28c",dark:"#3a6c30"},blue:{light:"#76b7df",dark:"#1f547a"},pink:{light:"#f09ebc",dark:"#94415f"},purple:{light:"#c59be1",dark:"#66358d"},brown:{light:"#d8aa7c",dark:"#6d3e1b"}},text:{primary:"#fef4ec",muted:"#d8b89d"}},{id:"zephyr-leaf",meta:{label:"Zephyr Leaf",emoji:"🍃",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Leaf%20Fluttering%20In%20Wind/3D/leaf_fluttering_in_wind_3d.png"},appearance:"light",colors:{background:{light:"#fafffc",base:"#f2fbf4",dark:"#c8e1cd"},neutral:{light:"#789883",base:"#56715c",dark:"#334537"},primary:{light:"#73c08b",base:"#4fa26d",dark:"#2f7047"},secondary:{light:"#a9d8a8",base:"#8ac78a",dark:"#577f57"},accent:{light:"#f6d895",base:"#f2c86b",dark:"#b58b2b"}},standardColors:{red:{light:"#f37d78",dark:"#a33a32"},orange:{light:"#f7aa63",dark:"#b3621c"},yellow:{light:"#ffe08c",dark:"#b19227"},green:{light:"#7fd89a",dark:"#2f6d42"},blue:{light:"#7ebfde",dark:"#266180"},pink:{light:"#f2a9c7",dark:"#964469"},purple:{light:"#bea5e6",dark:"#5f3e93"},brown:{light:"#c7a378",dark:"#6b4726"}},text:{primary:"#233027",muted:"#4f6355"}},{id:"stormspark",meta:{label:"Stormspark",emoji:"⚡",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Cloud%20With%20Lightning/3D/cloud_with_lightning_3d.png"},appearance:"dark",colors:{background:{light:"#202633",base:"#141923",dark:"#07090d"},neutral:{light:"#d5d9e4",base:"#b7bdc9",dark:"#7f8591"},primary:{light:"#ffe06a",base:"#ffd13b",dark:"#b99105"},secondary:{light:"#86c7ff",base:"#5aa9ff",dark:"#1f69b1"},accent:{light:"#ff8c5c",base:"#ff6f3c",dark:"#b33a11"}},standardColors:{red:{light:"#ff6e63",dark:"#b22c22"},orange:{light:"#ff9945",dark:"#b55612"},yellow:{light:"#ffe06a",dark:"#b89316"},green:{light:"#8bd9a3",dark:"#2f7341"},blue:{light:"#7dbaff",dark:"#1f5ca7"},pink:{light:"#f79cd0",dark:"#a24677"},purple:{light:"#c7a3ff",dark:"#6138a2"},brown:{light:"#c9a281",dark:"#6f4b2a"}},text:{primary:"#f5f6ff",muted:"#c3c8d4"}}];function td(e,t){if(!e)return{colors:{},standardColors:void 0,text:void 0,legendColors:void 0};const n=e.colors?{...e.colors}:{},r=e.standardColors?{...e.standardColors}:void 0,o=e.text?{...e.text}:void 0,i=e.legendColors?{...e.legendColors}:void 0,a=e.appearances||null,d=(a==null?void 0:a[t])||e.appearance&&(a==null?void 0:a[e.appearance])||null;if(!d)return{colors:n,standardColors:r,text:o,legendColors:i};const l=d.colors?{...n,...d.colors}:n,c=d.standardColors||r,f=d.text||o,u=d.legendColors?{...i||{},...d.legendColors}:i;return{colors:l,standardColors:c,text:f,legendColors:u}}const Na=new Map(kr.map(e=>[e.id,e])),aa=new Set(kr.map(e=>e.id)),Xm=kr.map(e=>`theme-${e.id}`);function La(e,t=ut){if(!e)return null;const n=e.meta?{...e.meta}:{label:"",emoji:"",image:null},r=td(e,t);return{...e,meta:n,colors:r.colors,standardColors:r.standardColors,text:r.text,name:n.emoji||"",label:n.label||"",activeAppearance:t}}const ds=new Set;let sa=!1,Fs=!1,Xo=null,Go=null;function nd(){if(Xo||typeof window>"u"||typeof window.matchMedia!="function")return Xo;try{Xo=window.matchMedia("(prefers-color-scheme: dark)")}catch(e){console.warn("Unable to access system color scheme.",e),Xo=null}return Xo}function Gm(){const e=[Qc,...Bs];for(const r of e){const o=ks(r);if(o&&ed.has(o))return Fs=!0,o}const t=nd();return(t&&typeof t.matches=="boolean"?t.matches:!0)?"dark":"light"}function Vm(e){var r;const t=e||ut||"dark",n=kr.find(o=>o.appearance===t)||kr[0];return(n==null?void 0:n.id)||((r=kr[0])==null?void 0:r.id)}function Km(){const e=[Jc,...Bs];for(const t of e){const n=ks(t);if(n){if(aa.has(n))return n;const r=Wm.get(n);if(r&&aa.has(r))return r}}return null}let ut=Gm(),wn=(()=>{const e=Km();return e?(sa=!0,e):Vm(ut)})();function ee(e,t,n){var r;!e||typeof((r=e.style)==null?void 0:r.setProperty)!="function"||!t||e.style.setProperty(t,n)}function Zm(e,t){Um.forEach(n=>{const r=t==null?void 0:t[n];if(!r){ee(e,`--color-${n}-light`,""),ee(e,`--color-${n}-dark`,"");return}const o=Tt(r.light),i=Tt(r.dark);ee(e,`--color-${n}-light`,o||""),ee(e,`--color-${n}-dark`,i||"")})}function Tl(e,t){return!e||!t?"":`linear-gradient(135deg, ${e}, ${t})`}function Rr(e,t=1){const n=Tt(e);if(!n)return"";const r=parseInt(n.slice(1,3),16),o=parseInt(n.slice(3,5),16),i=parseInt(n.slice(5,7),16);if([r,o,i].some(d=>Number.isNaN(d)))return"";const a=Math.round(Xr(t,0,1)*1e3)/1e3;return`rgba(${r}, ${o}, ${i}, ${a})`}function Rs(){if(typeof document>"u")return;const e=document.documentElement,t=document.body;if(!e||!t)return;const n=Na.get(wn);if(!n)return;const{colors:r,standardColors:o,text:i,legendColors:a}=td(n,ut),d=r||{},l=Yo(d.background||{}),c=Yo(d.neutral||{}),f=Yo(d.primary||{}),u=Yo(d.secondary||{}),p=Yo(d.accent||{});let h,g,b,S,x,k,T,A,L;ut==="light"?(h=l.light,g=_i(h,.12),b=l.base,S=qi(l.base,.22),x=c.light,k=_i(x,.12),T=c.base,A=c.dark,L=[h,g,_i(g,.14),x,k]):(h=l.base,g=l.light,b=l.dark,S=qi(b,.28),x=c.base,k=c.light,T=c.dark,A=qi(T,.24),L=[S,h,g,T,x]),ee(e,"--color-background",h),ee(e,"--color-background-light",g),ee(e,"--color-background-dark",b),ee(e,"--color-neutral",x),ee(e,"--color-neutral-light",k),ee(e,"--color-neutral-dark",T),ee(e,"--color-primary",f.base),ee(e,"--color-primary-light",f.light),ee(e,"--color-primary-dark",f.dark),ee(e,"--color-secondary",u.base),ee(e,"--color-secondary-light",u.light),ee(e,"--color-secondary-dark",u.dark),ee(e,"--color-accent",p.base),ee(e,"--color-accent-light",p.light),ee(e,"--color-accent-dark",p.dark),ee(e,"--accent",p.base),ee(e,"--accent-500",p.base),ee(e,"--accent-bright",p.light),ee(e,"--accent-strong",p.dark),ee(e,"--layer-background-0",L[0]),ee(e,"--layer-background-1",L[1]),ee(e,"--layer-background-2",L[2]),ee(e,"--layer-background-3",L[3]),ee(e,"--layer-background-4",L[4]);const R=L[1]||h,z=L[2]||R,H=L[3]||z,_=L[4]||H,I=L[0]||h;ee(e,"--bg",I),ee(e,"--surface",R),ee(e,"--surface-1",R),ee(e,"--surface-2",z),ee(e,"--surface-3",H),ee(e,"--surface-4",_),ee(e,"--bg-color",I),ee(e,"--surface-color",R),ee(e,"--surface-alt-color",z),ee(e,"--surface-strong-color",H),ee(e,"--menu-bg",L[1]),ee(e,"--map-bg",L[1]);const s=ut==="light"?.32:.45,F=ut==="light"?.4:.55;ee(e,"--map-border",Rr(f.dark,s)),ee(e,"--map-border-strong",Rr(u.dark,F)),ee(e,"--action-panel-bg",L[2]),ee(e,"--action-option-bg",L[3]),ee(e,"--card-bg",L[3]),ee(e,"--card-bg-alt",L[4]);const Y=R,Z=H,re=Fr(i==null?void 0:i.primary,Y,4.6),ke=Fr(i==null?void 0:i.muted,Y,3.2),ye=Fr(i==null?void 0:i.primary,Z,4.6);ee(e,"--text-color",re),ee(e,"--text",re),ee(e,"--text-strong",ye),ee(e,"--text-muted",ke),ee(e,"--card-text",Fr(i==null?void 0:i.primary,Z,4.6)),ee(e,"--heading-color",ye);const We=Fr(i==null?void 0:i.primary,p.base,4.6);ee(e,"--accent-contrast",We);const Ye=Tl(f.dark,f.light),Xe=Tl(u.dark,u.light);ee(e,"--action-button-bg",Ye),ee(e,"--action-button-text",Fr(re,f.dark,4.6));const Ve=ut==="light"?.25:.4,ve=ut==="light"?.3:.5,nt=ut==="light"?.3:.45;ee(e,"--action-button-shadow",`0 3px 12px ${Rr(f.dark,Ve)}`),ee(e,"--action-button-shadow-hover",`0 10px 24px ${Rr(f.dark,ve)}`),ee(e,"--action-button-bg-active",Xe),ee(e,"--action-button-text-active",Fr(re,u.dark,4.6)),ee(e,"--action-button-shadow-active",`0 12px 26px ${Rr(u.dark,nt)}`);const Ge=mr(T,Y,ut==="light"?.6:.35),xt=mr(T,Y,ut==="light"?.5:.28),Ft=mr(T,Y,ut==="light"?.42:.22);ee(e,"--chip-bg",Ge),ee(e,"--chip-bg-hover",xt),ee(e,"--chip-bg-active",Ft),ee(e,"--outline-strong",f.light);const Ke=mr(A,Y,ut==="light"?.35:.6),Rt=mr(A,Y,ut==="light"?.65:.35);ee(e,"--border-strong",Ke),ee(e,"--border-soft",Rt),ee(e,"--backdrop-shadow",`0 24px 60px ${Rr(S,ut==="light"?.28:.55)}`),ee(e,"--accent-glow-soft",Rr(p.light,ut==="light"?.35:.4)),Zm(e,o),t.dataset.themeAppearance=ut}function rd(e,{persist:t=!0}={}){aa.has(e)&&(t&&(sa=!0,ta(Jc,e),ta(Bs[0],e)),wn=e,id(),Rs(),$s())}function od(e,{persist:t=!0,notify:n=!0}={}){ed.has(e)&&e!==ut&&(t&&(Fs=!0,ta(Qc,e)),ut=e,Rs(),n&&$s())}function Jm(){const e=nd();if(!e||Go)return;const t=n=>{var d;if(Fs)return;const o=(typeof(n==null?void 0:n.matches)=="boolean"?n.matches:!!e.matches)?"dark":"light",i=((d=kr.find(l=>l.appearance===o))==null?void 0:d.id)||wn,a=!sa&&i!==wn;od(o,{persist:!1,notify:!a}),!sa&&a&&rd(i,{persist:!1})};typeof e.addEventListener=="function"?(e.addEventListener("change",t),Go=()=>{e.removeEventListener("change",t),Go=null}):typeof e.addListener=="function"&&(e.addListener(t),Go=()=>{e.removeListener(t),Go=null})}function id(){if(typeof document>"u"||!document.body)return;const{body:e}=document;e.classList.remove(...Xm),wn&&e.classList.add(`theme-${wn}`)}function $s(){const e=Na.get(wn),t=La(e,ut);ds.forEach(n=>{try{n(wn,t)}catch(r){console.error("Theme listener error",r)}})}function Qm(){id(),Rs(),$s(),Jm()}function Hs(){return wn}function Al(e=wn){return La(Na.get(e),ut)}function ad(){return kr.map(e=>La(e,ut))}function sd(e){aa.has(e)&&rd(e,{persist:!0})}function la(){return ut}function ca(e){od(e,{persist:!0,notify:!0})}function us(e,{immediate:t=!1}={}){if(typeof e!="function")return()=>{};if(ds.add(e),t)try{e(wn,La(Na.get(wn),ut))}catch(n){console.error("Theme listener error",n)}return()=>{ds.delete(e)}}const Nl=[{id:"Thawbound",label:"Spring",icon:"🌱"},{id:"Sunheight",label:"Summer",icon:"☀️"},{id:"Emberwane",label:"Autumn",icon:"🍂"},{id:"Frostshroud",label:"Winter",icon:"❄️"}],eh={easy:"forgiving",normal:"balanced",hard:"brutal",custom:"tailored"},Ll=128,Bl="#7d7f81",th=.08,Ya="#f2f4ff",nh=.08,rh=[{id:"oreDensity",path:["oreDensity"],label:"Ore Density",hint:"Likelihood of exposed ore veins.",min:0,max:100,step:1},{id:"waterTable",path:["waterTable"],label:"Water Table",hint:"Baseline access to groundwater and springs.",min:0,max:100,step:1},{id:"temperature",path:["temperature"],label:"Temperature",hint:"Relative warmth influencing open ground.",min:0,max:100,step:1},{id:"rainfall",path:["rainfall"],label:"Rainfall",hint:"Moisture levels that drive vegetation density.",min:0,max:100,step:1},{id:"mountains",path:["mountains"],label:"Mountains",hint:"Terrain ruggedness and elevation swings.",min:0,max:100,step:1},{id:"rivers100",path:["rivers100"],label:"Rivers (100 tiles)",hint:"Presence of flowing water near the start.",min:0,max:100,step:1},{id:"lakes100",path:["lakes100"],label:"Lakes (100 tiles)",hint:"Probability of still water nearby.",min:0,max:100,step:1}],oh=[{id:"advanced.elevationBase",path:["advanced","elevationBase"],label:"Elevation Base",hint:"Adjusts the average terrain height.",min:0,max:100,step:1},{id:"advanced.elevationVariance",path:["advanced","elevationVariance"],label:"Elevation Variance",hint:"Controls how steep or flat the landscape feels.",min:0,max:100,step:1},{id:"advanced.elevationScale",path:["advanced","elevationScale"],label:"Elevation Scale",hint:"Sets the scale of elevation noise patterns.",min:0,max:100,step:1},{id:"advanced.vegetationScale",path:["advanced","vegetationScale"],label:"Vegetation Scale",hint:"How clustered forests and clearings appear.",min:0,max:100,step:1},{id:"advanced.oreNoiseScale",path:["advanced","oreNoiseScale"],label:"Ore Noise Scale",hint:"Controls size of ore-rich pockets.",min:0,max:100,step:1},{id:"advanced.oreThresholdOffset",path:["advanced","oreThresholdOffset"],label:"Ore Threshold Offset",hint:"Bias for how easily ore tiles appear.",min:0,max:100,step:1},{id:"advanced.waterGuaranteeRadius",path:["advanced","waterGuaranteeRadius"],label:"Water Guarantee Radius",hint:"Radius checked to ensure starter water.",min:0,max:100,step:1},{id:"advanced.waterFlowMultiplier",path:["advanced","waterFlowMultiplier"],label:"Water Flow Multiplier",hint:"Scales river strength and drainage (50 is balanced).",min:0,max:100,step:1}],Fl=[...rh,...oh],Rl=[{id:"water",label:"Water",parameters:["waterTable","rivers100","lakes100","advanced.waterGuaranteeRadius","advanced.waterFlowMultiplier"]},{id:"ore",label:"Ore",parameters:["oreDensity","advanced.oreNoiseScale","advanced.oreThresholdOffset"]},{id:"fauna",label:"Fauna",parameters:["advanced.elevationVariance"]},{id:"flora",label:"Flora",parameters:["rainfall","advanced.vegetationScale"]},{id:"climate",label:"Climate",parameters:["temperature","advanced.elevationBase"]},{id:"events",label:"Events",parameters:["mountains"]},{id:"misc",label:"Misc",parameters:["advanced.elevationScale"]}];function Mi(e,t=0,n=100){const r=Number(e);return!Number.isFinite(r)||r<t?t:r>n?n:Math.round(r)}function En(e=ni){const t=xr(e);return{...t,advanced:{...t.advanced}}}function $l(e,t=[]){return t.reduce((n,r)=>{if(!(!n||typeof n!="object"))return n[r]},e)}function Hl(e,t=[],n){if(!t.length)return;let r=e;for(let o=0;o<t.length-1;o+=1){const i=t[o];(!r[i]||typeof r[i]!="object")&&(r[i]={}),r=r[i]}r[t[t.length-1]]=n}function Il(e=[]){return e.join(".")}function Dl(e){if(!e)return[];const t=["a[href]","button:not([disabled])",'input:not([disabled]):not([type="hidden"])',"select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(",");return Array.from(e.querySelectorAll(t)).filter(n=>!(n instanceof HTMLElement)||n.hidden?!1:n.getAttribute("aria-hidden")!=="true")}function ih(e,t=""){return!e||typeof e!="string"?t:e.split("-").filter(Boolean).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")}function Ei(){return typeof crypto<"u"&&(crypto!=null&&crypto.getRandomValues)?crypto.getRandomValues(new Uint32Array(1))[0].toString(36):Math.trunc(Date.now()*Math.random()).toString(36)}function ah(e){var Io,Do;Hc();const t=document.getElementById("content"),n=document.getElementById("setup"),r=t||n||document.body;n&&r!==n&&n.parentElement?n.parentElement.removeChild(n):n&&(n.innerHTML="");const o=r.querySelector(".create-steps");(o==null?void 0:o.parentElement)===r&&o.parentElement.removeChild(o);const i=r.querySelector("#create-step-content");(i==null?void 0:i.parentElement)===r&&i.parentElement.removeChild(i),document.body.classList.add("landing-active");const a=r.querySelector("#game"),d=a&&r.contains(a)?a:null,l=document.createElement("template");l.innerHTML=`
    <header class="setup-appbar" role="banner">
      <label class="setup-appbar__title" for="seed-input">World Seed</label>
      <div class="setup-appbar__seed">
        <div class="seed-row">
          <input id="seed-input" class="input" placeholder="Enter seed or leave blank for random" autocomplete="off">
          <button id="seed-rand" type="button" class="icon-ghost" aria-label="Randomize seed">
            <svg
              aria-hidden="true"
              viewBox="0 0 24 24"
              focusable="false"
              class="icon-ghost__glyph"
            >
              <rect
                x="5"
                y="5"
                width="14"
                height="14"
                rx="3"
                ry="3"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              ></rect>
              <circle cx="9" cy="9" r="1.5" fill="currentColor"></circle>
              <circle cx="15" cy="9" r="1.5" fill="currentColor"></circle>
              <circle cx="9" cy="15" r="1.5" fill="currentColor"></circle>
              <circle cx="15" cy="15" r="1.5" fill="currentColor"></circle>
              <circle cx="12" cy="12" r="1.5" fill="currentColor"></circle>
            </svg>
          </button>
        </div>
      </div>
      <button
        id="difficulty-toggle"
        type="button"
        class="icon-ghost"
        aria-haspopup="dialog"
        aria-expanded="false"
        aria-controls="difficulty-modal"
        aria-label="Adjust difficulty"
      >
        <svg
          aria-hidden="true"
          viewBox="0 0 24 24"
          focusable="false"
          class="icon-ghost__glyph"
        >
          <path
            d="M4 6h16M4 12h16M4 18h16"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
          ></path>
          <circle cx="9" cy="6" r="2" fill="currentColor"></circle>
          <circle cx="15" cy="12" r="2" fill="currentColor"></circle>
          <circle cx="12" cy="18" r="2" fill="currentColor"></circle>
        </svg>
      </button>
    </header>
    <dialog
      id="difficulty-modal"
      class="modal"
      aria-labelledby="difficulty-modal-title"
    >
      <div class="modal__card difficulty-modal">
        <header class="modal__header">
          <div class="modal__title">
            <h2 class="difficulty-modal__title" id="difficulty-modal-title">Difficulty</h2>
            <div class="difficulty-modal__meta">
              <div class="difficulty-score" id="difficulty-score" role="status" aria-live="polite"></div>
              <div class="difficulty-tip" id="difficulty-tip"></div>
            </div>
          </div>
          <button
            id="difficulty-close"
            type="button"
            class="modal__close"
            aria-label="Close difficulty settings"
          >
            ✕
          </button>
        </header>
        <div class="modal__body">
          <div class="difficulty-modal__preset-field">
            <label class="difficulty-modal__preset-label" for="difficulty-preset">Preset</label>
            <select id="difficulty-preset" class="difficulty-modal__preset"></select>
          </div>
          <div
            class="difficulty-modal__tabs"
            role="tablist"
            aria-label="Difficulty parameter categories"
            data-role="difficulty-tabs"
          ></div>
          <div class="difficulty-modal__panels" data-role="difficulty-panels"></div>
        </div>
        <footer class="modal__footer">
          <button id="difficulty-reset" type="button" class="btn btn--ghost">Reset</button>
          <div class="spacer" aria-hidden="true"></div>
          <button id="difficulty-apply" type="button" class="btn btn--primary">Apply</button>
        </footer>
      </div>
    </dialog>
    <section id="create-step-content" aria-live="polite">
      <div class="setup">
        <div class="setup__column setup__column--primary">
          <div class="card section" id="biome-card">
            <div class="season-row">
              <div class="season-label section__title">Starting Season</div>
              <div class="season-switch" id="season-seg"></div>
            </div>
            <div class="section__title">Biome</div>
            <div class="grid" id="biome-grid"></div>
            <div class="sub" id="biome-details"></div>
          </div>
        </div>
        <div class="setup__column setup__column--preview">
          <div class="card section map-section">
            <div id="map-preview" class="map-preview" aria-label="World map preview"></div>
            <p class="sub" id="spawn-info"></p>
          </div>
          <div class="card cta-row">
            <button id="randomize-all" type="button" class="btn">Randomize All</button>
            <div class="spacer" aria-hidden="true"></div>
            <button id="start-btn" type="button" class="btn btn--primary">Start Game</button>
          </div>
        </div>
      </div>
    </section>
  `;const c=l.content;r.insertBefore(c,d);const f=r.querySelector("#create-step-content"),u=f==null?void 0:f.querySelector(".setup"),p=r.querySelector(".setup-appbar"),h=r.querySelector("#difficulty-modal"),g=r.querySelector("#difficulty-toggle"),b=h==null?void 0:h.querySelector("#difficulty-close"),S=h==null?void 0:h.querySelector("#difficulty-reset"),x=h==null?void 0:h.querySelector("#difficulty-apply"),k=h==null?void 0:h.querySelector('[data-role="difficulty-tabs"]'),T=h==null?void 0:h.querySelector('[data-role="difficulty-panels"]'),A=h==null?void 0:h.querySelector("#difficulty-tip"),L=h==null?void 0:h.querySelector("#difficulty-score"),R=h==null?void 0:h.querySelector("#difficulty-preset");if(!f||!u||!p||!h||!g||!k||!T)throw new Error("Unable to initialize setup UI layout.");f.hidden=!1,f.style.display="";const z=document.querySelector(".settings-float");z!=null&&z.parentElement&&z.parentElement.removeChild(z);const H=document.createElement("div");H.className="settings-float";const _=document.createElement("button");_.id="landing-settings-btn",_.type="button",_.className="icon-gear",_.setAttribute("aria-haspopup","true"),_.setAttribute("aria-expanded","false"),_.setAttribute("aria-controls","landing-settings-panel"),_.setAttribute("aria-label","Settings"),_.title="Settings";const I=document.createElement("span");I.setAttribute("aria-hidden","true"),I.textContent="⚙️",_.appendChild(I);const s=document.createElement("div");s.id="landing-settings-panel",s.className="hero-settings__panel",s.setAttribute("role","dialog"),s.setAttribute("aria-hidden","true"),s.setAttribute("aria-labelledby","landing-settings-title"),s.innerHTML=`
    <div class="hero-settings__header">
      <div class="badge badge--ok">Alpha</div>
      <div class="hero-settings__title" id="landing-settings-title">Settings</div>
    </div>
    <div class="hero-settings__section">
      <div class="hero-settings__section-title">Theme</div>
      <div class="hero-settings__theme-row" id="landing-theme-grid"></div>
    </div>
  `,H.append(_,s),(document.body||r).appendChild(H);const Y=s.querySelector("#landing-theme-grid"),Z=u.querySelector("#biome-grid"),re=u.querySelector("#biome-details"),ke=u.querySelector("#season-seg"),ye=r.querySelector("#seed-input"),We=r.querySelector("#seed-rand"),Ye=u.querySelector("#map-preview"),Xe=u.querySelector("#spawn-info"),Ve=u.querySelector("#randomize-all"),ve=u.querySelector("#start-btn");if(!Z||!re||!ke||!ye||!We||!Ye||!Xe||!Ve||!ve)throw new Error("Missing setup UI elements.");let nt=()=>{};const Ge=ad(),xt=new Map;if(Y){Y.innerHTML="";const w=document.createElement("div");w.className="hero-settings__theme-contrast";const E=document.createElement("span");E.className="hero-settings__theme-contrast-label",E.textContent="Preview contrast";const $=document.createElement("div");$.className="hero-settings__theme-contrast-controls";const D=document.createElement("button");D.type="button",D.className="hero-settings__theme-contrast-btn",D.textContent="Light",D.setAttribute("aria-pressed","false");const B=document.createElement("button");B.type="button",B.className="hero-settings__theme-contrast-btn",B.textContent="Dark",B.setAttribute("aria-pressed","false"),$.append(D,B),w.append(E,$);const X=document.createElement("div");X.className="hero-settings__theme-grid",Y.append(w,X),nt=O=>{const V=O==="light"?"light":"dark";X.dataset.contrast=V,D.classList.toggle("is-active",V==="light"),B.classList.toggle("is-active",V==="dark"),D.setAttribute("aria-pressed",String(V==="light")),B.setAttribute("aria-pressed",String(V==="dark"))},D.addEventListener("click",()=>{ca("light")}),B.addEventListener("click",()=>{ca("dark")}),Ge.forEach(O=>{var ze,bt,qt;const V=document.createElement("button");V.type="button",V.className="hero-settings__theme-btn",V.dataset.themeId=O.id,V.dataset.themeAppearance=O.appearance,V.setAttribute("aria-pressed","false");const be=((ze=O.meta)==null?void 0:ze.label)||ih(O.id),se=be||((bt=O.meta)==null?void 0:bt.emoji)||O.id;V.setAttribute("aria-label",`Switch to ${se}`),V.title=se;const De=document.createElement("span");De.className="hero-settings__theme-icon",De.textContent=((qt=O.meta)==null?void 0:qt.emoji)||"",De.setAttribute("aria-hidden","true");const ot=document.createElement("span");ot.className="hero-settings__theme-label",ot.textContent=be;const Et=`linear-gradient(145deg, ${O.colors.primary.light}, ${O.colors.secondary.light})`,dt=`linear-gradient(145deg, ${O.colors.primary.dark}, ${O.colors.secondary.dark})`;V.style.setProperty("--preview-bg-light",Et),V.style.setProperty("--preview-bg-dark",dt),V.style.setProperty("--preview-border-light",O.colors.primary.light),V.style.setProperty("--preview-border-dark",O.colors.primary.dark),V.style.setProperty("--preview-fg-light","#18202b"),V.style.setProperty("--preview-fg-dark","#f6f8ff"),V.style.setProperty("--preview-shadow-light","0 1px 1px rgba(255, 255, 255, 0.55)"),V.style.setProperty("--preview-shadow-dark","0 2px 8px rgba(0, 0, 0, 0.55)"),V.append(De,ot),V.addEventListener("click",()=>{sd(O.id),Rt({returnFocus:!0})}),X.appendChild(V),xt.set(O.id,V)}),nt(la())}function Ft(w=Hs()){xt.forEach((E,$)=>{const D=$===w;E.classList.toggle("is-active",D),E.setAttribute("aria-pressed",String(D))})}function Ke(){!s||!_||(s.classList.add("is-open"),s.setAttribute("aria-hidden","false"),_.setAttribute("aria-expanded","true"))}function Rt(w={}){!s||!_||(s.classList.remove("is-open"),s.setAttribute("aria-hidden","true"),_.setAttribute("aria-expanded","false"),w.returnFocus&&_.focus())}_&&s&&H&&(_.addEventListener("click",w=>{w.stopPropagation(),s.classList.contains("is-open")?Rt({returnFocus:!0}):Ke()}),s.addEventListener("click",w=>{w.stopPropagation()}),document.addEventListener("click",w=>{H.contains(w.target)||Rt()}),document.addEventListener("keydown",w=>{w.key==="Escape"&&Rt({returnFocus:!0})}));const Qe=[],mt=[],ht=new Map,Ne=new Map,At=new Map;let rt=((Io=Rl[0])==null?void 0:Io.id)||null,Q=Al(),_e=null;us((w,E)=>{Q=E||Al(w),nt((Q==null?void 0:Q.activeAppearance)||la()),Ft(w),Qe.forEach(Ae),_e!=null&&_e.setTerrainColors&&_e.setTerrainColors(null,{forceRefresh:!0})},{immediate:!0});const xn=Ia.find(w=>w.id==="temperate-deciduous")||Ia[0],vn=Nl[0],$t=oo.find(w=>w.id==="normal")||oo[0],He=new Map(Fl.map(w=>[w.id,w]));let gt=(xn==null?void 0:xn.id)||"",Ot=(vn==null?void 0:vn.id)||"",Ze=($t==null?void 0:$t.id)||"",st=En(((Do=wi(Ze))==null?void 0:Do.world)||ni),ft=Ei(),lt=null,ln=null,ce=null,Qt=null,Sn=null,kn=null;const nr="setup-spawn-marker",Nt=180,Je=200,ue=Mo();ue!=null&&ue.biome&&(gt=ue.biome),ue!=null&&ue.season&&(Ot=ue.season),ue!=null&&ue.difficulty&&(Ze=oo.some(w=>w.id===ue.difficulty)?ue.difficulty:"custom"),ue!=null&&ue.worldParameters&&(st=En(ue.worldParameters)),ue!=null&&ue.seed&&(ft=String(ue.seed));const ct=[{type:"open",label:"Open Land"},{type:"forest",label:"Forest"},{type:"stone",label:"Stone Outcrop"},{type:"ore",label:"Ore Deposits"},{type:"water",label:"Water"}],Ut=ct.reduce((w,E)=>(w[E.type]=E.label,w),{});ye.value=ft;function Ue(w){if(!w)return null;const E=w.trim().toLowerCase();if(!E||E==="transparent")return{r:0,g:0,b:0,a:0};const $=E.match(/^rgba?\(\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)(?:\s*,\s*([\d.]+))?\s*\)$/);if($){const[,B,X,O,V]=$;return{r:Number(B),g:Number(X),b:Number(O),a:V!==void 0?Number(V):1}}const D=E.match(/^#([0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/);if(D){const B=D[1];if(B.length===3||B.length===4){const[X,O,V,be]=B.split("").map(se=>parseInt(se+se,16));return{r:X,g:O,b:V,a:B.length===4?be/255:1}}if(B.length===6||B.length===8){const X=parseInt(B.slice(0,2),16),O=parseInt(B.slice(2,4),16),V=parseInt(B.slice(4,6),16),be=B.length===8?parseInt(B.slice(6,8),16)/255:1;return{r:X,g:O,b:V,a:be}}}return null}function Me(w){if(!w)return"";const E=Math.round(Math.max(0,Math.min(255,w.r))),$=Math.round(Math.max(0,Math.min(255,w.g))),D=Math.round(Math.max(0,Math.min(255,w.b))),B=typeof w.a=="number"?Math.max(0,Math.min(1,w.a)):1;return B>=1?`rgb(${E}, ${$}, ${D})`:`rgba(${E}, ${$}, ${D}, ${Number(B.toFixed(3))})`}function vt(w,E,$){if(!w)return null;const D=Math.max(0,Math.min(1,$??0)),B=1-D,X=typeof w.a=="number"?w.a:1,O=typeof(E==null?void 0:E.a)=="number"?E.a:X;return{r:w.r*B+((E==null?void 0:E.r)??w.r)*D,g:w.g*B+((E==null?void 0:E.g)??w.g)*D,b:w.b*B+((E==null?void 0:E.b)??w.b)*D,a:X*B+O*D}}function St(w,E=.08){const $={r:255,g:255,b:255,a:typeof(w==null?void 0:w.a)=="number"?w.a:1};return vt(w,$,E)}function Ee(w){if(!w)return 0;const[E,$,D]=[w.r??0,w.g??0,w.b??0].map(B=>{const X=B/255;return X<=.03928?X/12.92:Math.pow((X+.055)/1.055,2.4)});return .2126*E+.7152*$+.0722*D}function le(w,E){if(!w||!E)return 1;const $=Ee(w),D=Ee(E),B=Math.max($,D),X=Math.min($,D);return(B+.05)/(X+.05)}function te(w,E,$=4.5){if(!E)return w||Ue("#ffffff");const D=Ee(E),B=Ue(D>.5?"#111827":"#f9fafb"),X=Ue(D>.5?"#f9fafb":"#111827"),O=[];w&&O.push({color:w,ratio:le(w,E)}),B&&O.push({color:B,ratio:le(B,E)}),X&&O.push({color:X,ratio:le(X,E)});let V=O.sort((ot,Et)=>Et.ratio-ot.ratio)[0];if(!V)return Ue("#ffffff");if(V.ratio>=$)return V.color;const be=Ue(D>.5?"#000000":"#ffffff");let se=V.color,De=V.ratio;for(let ot=0;ot<6&&De<$;ot+=1)se=vt(se,be,.35),De=le(se,E);return De>=$?se:V.color}function Te(w,E){w.forEach($=>{$.classList.toggle("is-active",$===E)})}function Ae(w){var se,De,ot,Et,dt,ze,bt,qt,zt,zn,Pn,qe,Lt,en,Xt,ir,no,pi,jn,tn,mi,ro,hi,Oo;if(!w)return;if(((Q==null?void 0:Q.activeAppearance)||(Q==null?void 0:Q.appearance))==="dark"){const dn=((De=(se=Q==null?void 0:Q.colors)==null?void 0:se.neutral)==null?void 0:De.dark)||((Et=(ot=Q==null?void 0:Q.colors)==null?void 0:ot.background)==null?void 0:Et.light)||Bl,ar=Ue(dn||Bl);if(ar){const lr=St(ar,th);w.style.setProperty("--tile-base-bg",Me(ar)),lr&&w.style.setProperty("--tile-hover-bg",Me(lr))}const zo=((ze=(dt=Q==null?void 0:Q.colors)==null?void 0:dt.accent)==null?void 0:ze.base)||((qt=(bt=Q==null?void 0:Q.colors)==null?void 0:bt.accent)==null?void 0:qt.light)||null,sr=Ue(zo);if(sr){const lr=St(sr,.22);w.style.setProperty("--tile-active-bg",Me(lr));const gi=Ue((zt=Q==null?void 0:Q.text)==null?void 0:zt.primary),_n=te(gi,lr);_n?w.style.setProperty("--tile-active-text",Me(_n)):w.style.removeProperty("--tile-active-text")}else w.style.removeProperty("--tile-active-bg"),w.style.removeProperty("--tile-active-text");return}const $=((Pn=(zn=Q==null?void 0:Q.colors)==null?void 0:zn.background)==null?void 0:Pn.light)||((Lt=(qe=Q==null?void 0:Q.colors)==null?void 0:qe.background)==null?void 0:Lt.base)||((Xt=(en=Q==null?void 0:Q.colors)==null?void 0:en.neutral)==null?void 0:Xt.light)||Ya,D=((no=(ir=Q==null?void 0:Q.colors)==null?void 0:ir.neutral)==null?void 0:no.base)||((jn=(pi=Q==null?void 0:Q.colors)==null?void 0:pi.background)==null?void 0:jn.base)||Ya,B=Ue($)||Ue(Ya),X=Ue(D);let O=B;if(O&&X&&(O=vt(O,X,.28)),O){w.style.setProperty("--tile-base-bg",Me(O));const dn=St(O,nh);dn&&w.style.setProperty("--tile-hover-bg",Me(dn))}const V=((mi=(tn=Q==null?void 0:Q.colors)==null?void 0:tn.accent)==null?void 0:mi.light)||((hi=(ro=Q==null?void 0:Q.colors)==null?void 0:ro.accent)==null?void 0:hi.base)||null,be=Ue(V);if(be){const dn=St(be,.25),ar=dn?vt(be,dn,.4):be;w.style.setProperty("--tile-active-bg",Me(ar));const zo=Ue((Oo=Q==null?void 0:Q.text)==null?void 0:Oo.primary),sr=te(zo,ar);sr?w.style.setProperty("--tile-active-text",Me(sr)):w.style.removeProperty("--tile-active-text")}else w.style.removeProperty("--tile-active-bg"),w.style.removeProperty("--tile-active-text")}function Oe(){ce&&(ce.style.display="none",ce.setAttribute("aria-hidden","true")),Qt=null}function at(){var E,$;const w=(E=_e==null?void 0:_e.elements)==null?void 0:E.wrapper;if(!w)return null;if(!ce){ce=document.createElement("div"),ce.className="spawn-confirm",ce.setAttribute("role","dialog"),ce.setAttribute("aria-modal","false"),ce.setAttribute("aria-hidden","true"),ce.style.position="absolute",ce.style.display="none",ce.style.flexDirection="column",ce.style.gap="8px",ce.style.padding="12px 16px",ce.style.borderRadius="12px",ce.style.boxShadow="0 12px 24px rgba(0, 0, 0, 0.45)",ce.style.minWidth="150px";const D=document.createElement("p");D.dataset.role="spawn-question",D.style.margin="0",D.style.fontWeight="600",ce.appendChild(D);const B=document.createElement("div");B.style.display="flex",B.style.justifyContent="flex-end",B.style.gap="8px";const X=document.createElement("button");X.type="button",X.textContent="No",X.dataset.role="spawn-no";const O=document.createElement("button");O.type="button",O.textContent="Yes",O.dataset.role="spawn-yes",B.appendChild(X),B.appendChild(O),ce.appendChild(B),O.addEventListener("click",()=>{Qt&&Se({x:Qt.x,y:Qt.y}),Oe()}),X.addEventListener("click",()=>{Oe()})}return ce.parentElement!==w&&(($=ce.parentElement)==null||$.removeChild(ce),w.appendChild(ce)),ce}function me(w){var V;const E=at();if(!E)return;const $=Le(w||{});if(!$)return;Qt={x:$.x,y:$.y};const D=E.querySelector('[data-role="spawn-question"]');D&&(D.textContent=$.relocated?`Water tile unavailable. Spawn at nearest land (${$.x}, ${$.y})?`:`Spawn here at (${$.x}, ${$.y})?`);const B=(V=_e==null?void 0:_e.elements)==null?void 0:V.wrapper;let X=(w==null?void 0:w.element)||null;if($.relocated&&B){const be=`[data-world-x="${$.x}"][data-world-y="${$.y}"]`,se=B.querySelector(be);se&&(X=se)}if(B&&(X!=null&&X.getBoundingClientRect)){const be=B.getBoundingClientRect(),se=X.getBoundingClientRect(),De=se.left-be.left+se.width/2,ot=se.top-be.top+se.height/2;E.style.left=`${De}px`,E.style.top=`${ot}px`}else E.style.left="50%",E.style.top="50%";E.style.transform="translate(-50%, -120%)",E.style.display="flex",E.setAttribute("aria-hidden","false");const O=E.querySelector('[data-role="spawn-yes"]');O&&(typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(()=>O.focus()):setTimeout(()=>O.focus(),0))}function fe(w){if(!w)return null;const E=w.viewport||w,$=Math.max(1,Math.trunc((E==null?void 0:E.width)??Zr)),D=Math.max(1,Math.trunc((E==null?void 0:E.height)??Ea)),B=Number.isFinite(E==null?void 0:E.xStart)?Math.trunc(E.xStart):Number.isFinite(w==null?void 0:w.xStart)?Math.trunc(w.xStart):0,X=Number.isFinite(E==null?void 0:E.yStart)?Math.trunc(E.yStart):Number.isFinite(w==null?void 0:w.yStart)?Math.trunc(w.yStart):0;return{x:B+Math.floor($/2),y:X+Math.floor(D/2)}}function ie(w,E={}){var V;if(!((V=w==null?void 0:w.types)!=null&&V.length))return null;const $=Number.isFinite(w.xStart)?Math.trunc(w.xStart):0,D=Number.isFinite(w.yStart)?Math.trunc(w.yStart):0,B=Math.trunc(E.x)-$,X=Math.trunc(E.y)-D;if(X<0||B<0)return null;const O=w.types[X];return!O||B>=O.length?null:O[B]}function W(w,E={}){var be;if(!((be=w==null?void 0:w.types)!=null&&be.length))return null;const $=Number.isFinite(w.xStart)?Math.trunc(w.xStart):0,D=Number.isFinite(w.yStart)?Math.trunc(w.yStart):0,B=w.types.length;if(!B)return null;const X=Number.isFinite(E==null?void 0:E.x)?Math.trunc(E.x):null,O=Number.isFinite(E==null?void 0:E.y)?Math.trunc(E.y):null;let V=null;for(let se=0;se<B;se+=1){const De=w.types[se];if(De)for(let ot=0;ot<De.length;ot+=1){const Et=De[ot];if(Tn(Et))continue;const dt=$+ot,ze=D+se,bt=X!==null?dt-X:dt,qt=O!==null?ze-O:ze,zt=Math.hypot(bt,qt);(!V||zt<V.distance||zt===V.distance&&(Math.abs(ze)<Math.abs(V.y)||Math.abs(ze)===Math.abs(V.y)&&Math.abs(dt)<Math.abs(V.x)))&&(V={x:dt,y:ze,type:Et,distance:zt})}}return V}function Le(w={}){var O;const E=Number.isFinite(w.x)?Math.trunc(w.x):null,$=Number.isFinite(w.y)?Math.trunc(w.y):null;if(E===null||$===null)return null;if(!((O=lt==null?void 0:lt.types)!=null&&O.length))return{x:E,y:$,terrain:null,relocated:!1};const D=ie(lt,{x:E,y:$});if(D&&!Tn(D))return{x:E,y:$,terrain:D,relocated:!1};const B=W(lt,{x:E,y:$});if(!B)return null;const X=B.type||ie(lt,B);return{x:B.x,y:B.y,terrain:X||null,relocated:!0}}function Se(w={},E={}){if(!w)return;const $=Le(w);$&&(ln={x:$.x,y:$.y},E.silent||Oe(),ge(),U())}function ge(){if(!_e||typeof _e.setMarkers!="function")return;const w=ln?[{id:nr,x:ln.x,y:ln.y,icon:"",label:"Chosen spawn location",emphasis:!0}]:[];_e.setMarkers(w)}function U(){if(Xe){if(!ln){Xe.hidden=!1,Xe.textContent="Click the map to choose your starting position.";return}Xe.textContent="",Xe.hidden=!0}}function ae(){!lt||!_e||(Oe(),_e.setMap(lt,{biomeId:gt,seed:(lt==null?void 0:lt.seed)??ft,season:(lt==null?void 0:lt.season)??Ot}),ge(),U())}function Fe(){if(!gt||!Ye)return;const w=Ll,E=Ll,{xStart:$,yStart:D}=Ta(w,E);lt=Cr(gt,ft,$,D,w,E,Ot,void 0,void 0,st,!1);const B=fe(lt);B?Se(B,{silent:!0}):(ln=null,ge(),U()),ae()}function J(){var zn,Pn;const w=((zn=_e==null?void 0:_e.elements)==null?void 0:zn.stage)||((Pn=_e==null?void 0:_e.elements)==null?void 0:Pn.wrapper);if(!w)return;const E=w.querySelector('[data-role="legend-toggle"]');E!=null&&E.parentElement&&E.parentElement.removeChild(E);const $=w.querySelector('[data-role="map-legend-overlay"]');$!=null&&$.parentElement&&$.parentElement.removeChild($);const D="setup-map-legend",B=document.createElement("div");B.className="map-legend-overlay",B.dataset.role="map-legend-overlay",B.id=D,B.hidden=!0,B.setAttribute("role","dialog"),B.setAttribute("aria-modal","true"),B.setAttribute("aria-label","Terrain legend"),B.setAttribute("aria-hidden","true"),B.tabIndex=-1;const X=document.createElement("div");X.className="map-legend-overlay__panel";const O=document.createElement("div");O.className="map-legend",O.dataset.role="map-legend",O.setAttribute("role","document"),O.tabIndex=-1;const V=document.createElement("button");V.type="button",V.className="map-legend__close",V.setAttribute("aria-label","Close terrain legend"),V.innerHTML='<span aria-hidden="true">×</span>',O.appendChild(V);const be=document.createElement("div");be.className="map-legend__list",be.setAttribute("role","list"),ct.forEach(qe=>{const Lt=document.createElement("div");Lt.className="map-legend__item",Lt.setAttribute("role","listitem");const en=document.createElement("span");en.className="map-legend__swatch",qe.type&&(en.dataset.type=qe.type),Lt.appendChild(en);const Xt=document.createElement("span");Xt.className="map-legend__label",Xt.textContent=qe.label,Lt.appendChild(Xt),be.appendChild(Lt)}),O.appendChild(be),X.appendChild(O),B.appendChild(X);const se=document.createElement("button");se.type="button",se.className="map-legend-toggle",se.dataset.role="legend-toggle",se.setAttribute("aria-label","Show terrain legend"),se.setAttribute("aria-controls",D),se.setAttribute("aria-expanded","false"),se.setAttribute("aria-haspopup","dialog");const De=document.createElement("span");De.className="map-legend-toggle__icon",De.setAttribute("aria-hidden","true"),De.textContent="?",se.appendChild(De);const ot=qe=>{se.setAttribute("aria-expanded",String(qe)),se.setAttribute("aria-label",qe?"Hide terrain legend":"Show terrain legend"),se.classList.toggle("is-active",qe),B.setAttribute("aria-hidden",String(!qe))},Et=["button:not([disabled])","[href]","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(","),dt=()=>Array.from(B.querySelectorAll(Et)).filter(qe=>qe.offsetParent!==null||qe.getClientRects().length>0||qe===document.activeElement),ze=()=>{const qe=dt(),Lt=qe.length?qe[0]:B;requestAnimationFrame(()=>{Lt.focus()})},bt=()=>{B.hidden||(B.hidden=!0,ot(!1),se.focus())},qt=()=>{B.hidden&&(B.hidden=!1,ot(!0),ze())},zt=qe=>{qe&&qe.preventDefault(),B.hidden?qt():bt()};se.addEventListener("click",zt),se.addEventListener("keydown",qe=>{(qe.key===" "||qe.key==="Enter")&&(qe.preventDefault(),zt(qe))}),V.addEventListener("click",()=>{bt()}),B.addEventListener("pointerdown",qe=>{qe.target===B&&(qe.preventDefault(),bt())}),B.addEventListener("keydown",qe=>{if(qe.key==="Escape"){qe.preventDefault(),bt();return}if(qe.key==="Tab"){const Lt=dt();if(!Lt.length){qe.preventDefault(),B.focus();return}const en=Lt[0],Xt=Lt[Lt.length-1],ir=document.activeElement;qe.shiftKey?(ir===en||!B.contains(ir))&&(qe.preventDefault(),Xt.focus()):ir===Xt&&(qe.preventDefault(),en.focus())}}),w.appendChild(se),w.appendChild(B)}function K(w){!w||!Ne.has(w)||(Ne.forEach((E,$)=>{const D=$===w;E.classList.toggle("is-active",D),E.setAttribute("aria-selected",String(D)),E.tabIndex=D?0:-1}),At.forEach((E,$)=>{const D=$===w;E.hidden=!D,E.setAttribute("aria-hidden",String(!D))}),rt=w)}function we(){var $;if(!k||!T)return;const w=Rl.filter(D=>Array.isArray(D.parameters)&&D.parameters.length);Ne.clear(),At.clear(),ht.clear(),k.innerHTML="",T.innerHTML="",R&&(R.innerHTML="",[...oo,{id:"custom",name:"Custom"}].forEach(B=>{const X=document.createElement("option");X.value=B.id;const O=eh[B.id];X.textContent=O?`${B.name} — ${O}`:B.name,R.appendChild(X)}),R.addEventListener("change",()=>{Qr(R.value)})),w.forEach(D=>{const B=`difficulty-tab-${D.id}`,X=`difficulty-panel-${D.id}`,O=document.createElement("button");O.type="button",O.className="difficulty-modal__tab",O.id=B,O.dataset.categoryId=D.id,O.setAttribute("role","tab"),O.setAttribute("aria-controls",X),O.setAttribute("aria-selected","false"),O.tabIndex=-1,O.textContent=D.label,O.addEventListener("click",()=>{K(D.id),O.focus()}),O.addEventListener("keydown",be=>{var De,ot,Et,dt;if(!w.length)return;const se=w.findIndex(ze=>ze.id===D.id);if(!(se<0)){if(be.key==="ArrowRight"||be.key==="ArrowDown"){be.preventDefault();const ze=w[(se+1)%w.length];K(ze.id),(De=Ne.get(ze.id))==null||De.focus()}else if(be.key==="ArrowLeft"||be.key==="ArrowUp"){be.preventDefault();const ze=w[(se-1+w.length)%w.length];K(ze.id),(ot=Ne.get(ze.id))==null||ot.focus()}else if(be.key==="Home"){be.preventDefault();const ze=w[0];K(ze.id),(Et=Ne.get(ze.id))==null||Et.focus()}else if(be.key==="End"){be.preventDefault();const ze=w[w.length-1];K(ze.id),(dt=Ne.get(ze.id))==null||dt.focus()}}});const V=document.createElement("div");V.id=X,V.className="difficulty-modal__panel",V.dataset.categoryId=D.id,V.setAttribute("role","tabpanel"),V.setAttribute("aria-labelledby",B),V.setAttribute("aria-hidden","true"),V.hidden=!0,D.parameters.forEach(be=>{const se=He.get(be);if(!se)return;const De=Ho(se);De!=null&&De.element&&V.appendChild(De.element)}),k.appendChild(O),T.appendChild(V),Ne.set(D.id,O),At.set(D.id,V)});const E=rt&&Ne.has(rt)&&rt||(($=w[0])==null?void 0:$.id)||null;E&&K(E),R&&Ze&&(R.value=Ze)}function de(){ke&&(ke.innerHTML="",mt.length=0,Nl.forEach(w=>{const E=document.createElement("button");E.type="button",E.className="season-switch__button season-switch__button--icon",E.dataset.season=w.id;const $=w.label||w.id;$&&(E.setAttribute("aria-label",$),E.title=$),E.textContent=w.icon||$,E.addEventListener("click",()=>{qn({season:w.id})}),mt.push(E),ke.appendChild(E)}))}function he(){Z&&(Z.innerHTML="",Qe.length=0,Ia.forEach(w=>{const E=document.createElement("button");E.type="button",E.className="tile col-4",E.dataset.biome=w.id,E.innerHTML=`
        <div class="tile__name">${w.name}</div>
        <div class="tile__desc">${w.description||""}</div>
      `,E.addEventListener("click",()=>{qn({biome:w.id})}),Qe.push(E),Z.appendChild(E),Ae(E)}))}de(),he(),we(),_e=Zc(Ye,{legendLabels:Ut,showControls:!0,showLegend:!1,idPrefix:"setup-map",useTerrainColors:!0,bufferMargin:8,minZoom:.4,fetchMap:({xStart:w,yStart:E,width:$,height:D,seed:B,season:X,viewport:O,skipSanityChecks:V})=>Cr(gt,B??ft,w,E,$,D,X??Ot,lt==null?void 0:lt.waterLevel,O,st,!!V),onMapUpdate:w=>{lt={...w,worldSettings:w.worldSettings||st},ge(),U()},onTileClick:w=>{me(w)}}),J();let ne=null,Re=null;const Mt=()=>h?typeof h.open=="boolean"?h.open:h.hasAttribute("open"):!1,cn=()=>{ne==null||ne(),ne=null,g==null||g.setAttribute("aria-expanded","false");const w=Re&&"focus"in Re?Re:g;w&&typeof w.focus=="function"&&w.focus(),Re=null},rr=w=>{const E=$=>{if($.key!=="Tab")return;const D=Dl(w);if(!D.length){$.preventDefault();return}const B=D[0],X=D[D.length-1],O=document.activeElement;$.shiftKey?(!w.contains(O)||O===B)&&($.preventDefault(),X.focus()):(!w.contains(O)||O===X)&&($.preventDefault(),B.focus())};return w.addEventListener("keydown",E),()=>{w.removeEventListener("keydown",E)}},Ie=()=>{if(!h||!g||Mt())return;if(Re=document.activeElement instanceof HTMLElement?document.activeElement:g,typeof h.showModal=="function")try{h.showModal()}catch{h.setAttribute("open","")}else h.setAttribute("open","");g.setAttribute("aria-expanded","true"),ne=rr(h),(Dl(h)[0]||b||h).focus()},Ar=()=>{if(!(!h||!Mt()))if(typeof h.close=="function")try{h.close()}catch{h.removeAttribute("open"),cn()}else h.removeAttribute("open"),cn()};g.addEventListener("click",()=>{Mt()?Ar():Ie()}),b==null||b.addEventListener("click",()=>{Ar()}),h==null||h.addEventListener("cancel",w=>{w.preventDefault(),Ar()}),h==null||h.addEventListener("click",w=>{w.target===h&&Ar()}),h==null||h.addEventListener("close",cn),S==null||S.addEventListener("click",()=>{const w=(R==null?void 0:R.value)||Ze||"custom";Qr(w),or(),Cn(),Ln(),ui()}),x==null||x.addEventListener("click",()=>{qn({difficulty:Ze,worldParameters:En(st)}),Ar()}),Yt(gt),eo(Ot),Nr(Ze),Ro(),Ln(),Cn();function Ro(){var $;if(!re)return;const w=Mr(gt);if(!w){re.textContent="";return}const E=($=w.features)!=null&&$.length?`Features: ${w.features.join(", ")}.`:"";re.textContent=`${w.name}${w.description?` – ${w.description}`:""} ${E}`.trim()}function Ln(){var $;if(!A)return;if(!Ze){A.textContent="",g==null||g.setAttribute("aria-label","Difficulty");return}const w=wi(Ze),E=(($=oo.find(D=>D.id===Ze))==null?void 0:$.name)||(Ze==="custom"?"Custom":Ze);if(w!=null&&w.start){const{people:D=0,foodDays:B=0,firewoodDays:X=0}=w.start;A.textContent=`${E}: ${D} settlers, ${B} days of food, ${X} days of firewood.`}else A.textContent=E;g==null||g.setAttribute("aria-label",`Adjust difficulty (current: ${E})`)}function Cn(){if(!L)return;const w=hu(st);L.textContent=`Score: ${w}`,L.dataset.score=String(w)}function ui(){Sn&&clearTimeout(Sn),Sn=setTimeout(()=>{Sn=null,Fe()},Nt)}function or(){ht.forEach(w=>{const E=$l(st,w.path);w.update(E)})}function Qr(w,E={}){const{preserveWorld:$=!1,world:D}=E,B=Eo[w]?w:"custom";let X;D?X=En(D):B==="custom"&&$?X=En(st):X=En(wi(B).world);const O=xr(X);Ze=B,st=O,R&&R.value!==B&&(R.value=B),qn({difficulty:B,worldParameters:O})}function $o(w,E){const{def:$}=w,D=Mi(E,$.min,$.max),B=En(st);Hl(B,$.path,D);const X=xr(B);st=X,Ze="custom",R&&R.value!=="custom"&&(R.value="custom"),w.update(D),qn({difficulty:"custom",worldParameters:X})}function Ho(w){const E=Il(w.path),$=document.createElement("div");$.className="difficulty-param";const D=document.createElement("div");D.className="difficulty-param__header";const B=document.createElement("label");B.className="difficulty-param__label";const X=`difficulty-slider-${E}`;B.setAttribute("for",X),B.textContent=w.label,w.hint&&(B.title=w.hint);const O=document.createElement("input");O.type="range",O.id=X,O.min=String(w.min),O.max=String(w.max),O.step=String(w.step??1),O.className="difficulty-param__slider range range__input";const V=document.createElement("div");V.className="difficulty-param__range",V.appendChild(O);const be=document.createElement("output");be.className="range__value",be.setAttribute("for",X),be.setAttribute("aria-live","polite");const se=document.createElement("div");se.className="difficulty-param__range-group",se.appendChild(V),se.appendChild(be);let De=!1;const ot={def:w,path:w.path,element:$,update(ze){const bt=Mi(ze,w.min,w.max),qt=String(bt);De=!0,O.value=qt,dt(bt),De=!1}},Et=ze=>{De||$o(ot,ze)},dt=ze=>{const bt=Mi(ze,w.min,w.max),qt=w.max-w.min||1,zt=(bt-w.min)/qt*100;O.style.setProperty("--range-progress",`${zt}%`),be.textContent=String(bt)};return O.addEventListener("input",()=>{const ze=Number(O.value);dt(ze),Et(ze)}),D.appendChild(B),$.appendChild(D),$.appendChild(se),ot.update($l(st,w.path)),ht.set(Il(w.path),ot),ot}function Ra(){const w=En(ni);return Fl.forEach(E=>{const $=E.max-E.min,D=E.min+Math.round(Math.random()*$);Hl(w,E.path,Mi(D,E.min,E.max))}),xr(w)}Ze||(Ze=($t==null?void 0:$t.id)||"custom"),R&&(R.value=Ze),us(()=>{Qe.forEach(Ae)});function Yt(w){const E=Qe.find($=>$.dataset.biome===w);E&&Te(Qe,E)}function eo(w){const E=mt.find($=>$.dataset.season===w);E&&Te(mt,E)}function Nr(w){!R||!w||R.value!==w&&(R.value=w)}function to(w){typeof w=="string"&&ye.value!==w&&(ye.value=w)}function On(w,E={}){const{immediate:$=!1}=E;kn&&(clearTimeout(kn),kn=null);const D=typeof w=="string"?w.trim():String(w??"");if($){const B=D||Ei();ft=B,ye.value=B,qn({seed:B});return}D&&(kn=setTimeout(()=>{kn=null,ft=D,qn({seed:D})},Je))}function fi(w={}){const{biome:E,season:$,difficulty:D,seed:B,worldParameters:X}=w;E&&(gt=E,Yt(E),Ro()),$&&(Ot=$,eo($)),D&&(Ze=D,Nr(D)),typeof B=="string"&&B&&B!==ft&&(ft=B,to(B)),X&&(st=En(X),or()),Ln(),Cn(),ui()}Qd(fi,{immediate:!0}),qn({biome:gt,season:Ot,difficulty:Ze,seed:ft,worldParameters:st},{force:!0}),ye.addEventListener("input",()=>{const w=ye.value;w.trim()&&On(w)}),ye.addEventListener("change",()=>{On(ye.value,{immediate:!0})}),ye.addEventListener("keydown",w=>{w.key==="Enter"&&(w.preventDefault(),On(ye.value,{immediate:!0}))}),We.addEventListener("click",()=>{On(Ei(),{immediate:!0})}),Ve.addEventListener("click",()=>{if(Qe.length){const B=Qe[Math.floor(Math.random()*Qe.length)];gt=B.dataset.biome,Te(Qe,B),Ro()}if(mt.length){const B=mt[Math.floor(Math.random()*mt.length)];Ot=B.dataset.season,Te(mt,B)}const w=[...oo.map(B=>B.id),"custom"],E=w[Math.floor(Math.random()*w.length)];Ze=Eo[E]?E:"custom",Nr(Ze);let $;Ze==="custom"?$=Ra():$=En(wi(Ze).world),st=xr($),or();const D=Ei();ye.value=D,ft=D,qn({biome:gt,season:Ot,difficulty:Ze,seed:D,worldParameters:st})}),ve.addEventListener("click",()=>{const w=ye.value.trim();w&&w!==ft&&On(w,{immediate:!0});const E=Mo();e({biome:E.biome||gt,season:E.season||Ot,difficulty:E.difficulty||Ze,seed:E.seed||ft,world:En(E.worldParameters||st),spawn:ln?{...ln}:null})})}let Dr=1,pr=null,Ti=null,Ai=null,gn=null,wt=null,Vn=null,Kn=null,fs=new Map,Co=null,da=null,ua=null,Ol=!1,Ni=null;function sh(e,t=""){return!e||typeof e!="string"?t:e.split("-").filter(Boolean).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")}function Wi(){const e=document.getElementById("content");e&&(e.style.transform=`scale(${Dr})`,e.style.transformOrigin="top left"),cd()}function ld(e=Hs()){fs.forEach((t,n)=>{const r=n===e;t.classList.toggle("active",r),t.setAttribute("aria-pressed",String(r))})}function lh(){Qm(),ld()}function cd(){if(!Co)return;const e=Math.round(Dr*100);Co.textContent=`${e}%`,Co.setAttribute("aria-label",`Reset zoom to 100% (current ${e}%)`)}function zl(e,t){const n=document.createElement("button");return n.type="button",n.textContent=e,n.setAttribute("aria-label",t),n.title=t,n.className="menu-trigger",n}function Fn(e,t,n){const r=document.createElement("button");r.type="button";const o=document.createElement("span");o.className="panel-icon",o.textContent=e;const i=document.createElement("span");return i.className="panel-label",i.textContent=t,r.append(o,i),typeof n=="function"&&r.addEventListener("click",n),{button:r,iconSpan:o,labelSpan:i}}function Xa(e,t,n){const r=document.createElement("button");return r.type="button",r.textContent=e,r.setAttribute("aria-label",t),r.title=t,r.classList.add("menu-icon-button"),typeof n=="function"&&r.addEventListener("click",n),r}function Kt(){gn&&(gn.classList.remove("open"),gn.setAttribute("aria-hidden","true")),wt&&(wt.classList.remove("open"),wt.setAttribute("aria-hidden","true")),Vn&&Vn.setAttribute("aria-expanded","false"),Kn&&Kn.setAttribute("aria-expanded","false")}function Pl(e,t){if(!e||!t)return;const n=e.classList.contains("open");Kt(),n||(e.classList.add("open"),e.setAttribute("aria-hidden","false"),t.setAttribute("aria-expanded","true"))}function ch(e){pr&&(pr.contains(e.target)||Kt())}function dh(e){e.key==="Escape"&&Kt()}function dd(){return pr||(pr=document.createElement("div"),pr.className="menu-action-group",Ti=document.createElement("div"),Ti.className="menu-action",Vn=zl("⚙️","Settings"),Vn.id="settings-btn",Vn.setAttribute("aria-expanded","false"),Vn.setAttribute("aria-haspopup","true"),Vn.addEventListener("click",e=>{e.stopPropagation(),Pl(gn,Vn)}),gn=document.createElement("div"),gn.className="menu-panel settings-panel",gn.setAttribute("aria-hidden","true"),Ti.append(Vn,gn),Ai=document.createElement("div"),Ai.className="menu-action",Kn=zl("☰","Game menu"),Kn.id="menu-btn",Kn.setAttribute("aria-expanded","false"),Kn.setAttribute("aria-haspopup","true"),Kn.addEventListener("click",e=>{e.stopPropagation(),Pl(wt,Kn)}),wt=document.createElement("div"),wt.id="dropdown-menu",wt.className="menu-panel menu-panel-list",wt.setAttribute("aria-hidden","true"),Ai.append(Kn,wt),pr.append(Ti,Ai),Ol||(document.addEventListener("click",ch),document.addEventListener("keydown",dh),Ol=!0),pr)}function uh(){if(!gn)return;gn.innerHTML="",fs=new Map,Ni&&(Ni(),Ni=null);const e=document.createElement("div");e.className="theme-settings-section";const t=document.createElement("div");t.className="theme-contrast-toggle";const n=document.createElement("span");n.className="theme-contrast-toggle__label",n.textContent="Preview contrast";const r=document.createElement("div");r.className="theme-contrast-toggle__controls";const o=document.createElement("button");o.type="button",o.className="theme-contrast-toggle__btn",o.textContent="Light",o.setAttribute("aria-pressed","false");const i=document.createElement("button");i.type="button",i.className="theme-contrast-toggle__btn",i.textContent="Dark",i.setAttribute("aria-pressed","false"),r.append(o,i),t.append(n,r);const a=document.createElement("div");a.className="theme-toggle-grid",e.append(t,a),gn.appendChild(e),ad().forEach(p=>{var A,L,R;const h=document.createElement("button");h.type="button",h.className="theme-toggle-button",h.dataset.themeId=p.id,h.dataset.themeAppearance=p.appearance,h.setAttribute("aria-pressed","false");const g=((A=p.meta)==null?void 0:A.label)||sh(p.id),b=g||((L=p.meta)==null?void 0:L.emoji)||p.id;h.setAttribute("aria-label",`Switch to ${b}`),h.title=b;const S=document.createElement("span");S.className="theme-toggle-button__icon",S.textContent=((R=p.meta)==null?void 0:R.emoji)||"",S.setAttribute("aria-hidden","true");const x=document.createElement("span");x.className="theme-toggle-button__label",x.textContent=g;const k=`linear-gradient(145deg, ${p.colors.primary.light}, ${p.colors.secondary.light})`,T=`linear-gradient(145deg, ${p.colors.primary.dark}, ${p.colors.secondary.dark})`;h.style.setProperty("--preview-bg-light",k),h.style.setProperty("--preview-bg-dark",T),h.style.setProperty("--preview-border-light",p.colors.primary.light),h.style.setProperty("--preview-border-dark",p.colors.primary.dark),h.style.setProperty("--preview-fg-light","#18202b"),h.style.setProperty("--preview-fg-dark","#f6f8ff"),h.style.setProperty("--preview-shadow-light","0 1px 1px rgba(255, 255, 255, 0.55)"),h.style.setProperty("--preview-shadow-dark","0 2px 8px rgba(0, 0, 0, 0.55)"),h.append(S,x),h.addEventListener("click",()=>{sd(p.id),Kt()}),a.appendChild(h),fs.set(p.id,h)});function l(p){const h=p==="light"?"light":"dark";a.dataset.contrast=h,o.classList.toggle("is-active",h==="light"),i.classList.toggle("is-active",h==="dark"),o.setAttribute("aria-pressed",String(h==="light")),i.setAttribute("aria-pressed",String(h==="dark"))}o.addEventListener("click",()=>{ca("light")}),i.addEventListener("click",()=>{ca("dark")}),l(la()),Ni=us((p=Hs(),h)=>{ld(p);const g=(h==null?void 0:h.activeAppearance)||la();l(g)},{immediate:!0});const c=document.createElement("div");c.className="icon-row";const f=Xa("➖","Zoom out",()=>{Dr=Math.max(.5,Math.round((Dr-.1)*10)/10),Wi()});f.classList.add("zoom-button"),Co=Xa("100%","Reset zoom to 100%",()=>{Dr=1,Wi()}),Co.classList.add("zoom-display-button");const u=Xa("➕","Zoom in",()=>{Dr=Math.min(2,Math.round((Dr+.1)*10)/10),Wi()});u.classList.add("zoom-button"),c.append(f,Co,u),gn.appendChild(c),cd()}function fh(e,t,n,r,o,i,a,d,l,c){if(!wt)return;if(wt.innerHTML="",da=null,ua=null,typeof t=="function"){const u=Fn("↩","Back",()=>{Kt(),t(),Is()});u.button.id="back-btn",u.button.style.display="none",wt.appendChild(u.button),da=u.button}if(typeof e=="function"){const u=Fn("👷","Jobs",()=>{Kt(),e()});u.button.id="jobs-btn",wt.appendChild(u.button)}if(typeof d=="function"){const u=Fn("🧰","Craft Planner",()=>{Kt(),d()});u.button.id="craft-planner-btn",wt.appendChild(u.button)}if(typeof r=="function"){const u=Fn("🏗️","Construction",()=>{Kt(),r()});u.button.id="construction-btn",wt.appendChild(u.button),ua=u.button}if(typeof o=="function"){const u=Fn("🎒","Inventory",()=>{Kt(),o()});u.button.id="inventory-btn",wt.appendChild(u.button)}if(typeof l=="function"){const u=Fn("🌿","Herbarium",()=>{Kt(),l()});u.button.id="herbarium-btn",wt.appendChild(u.button)}if(typeof c=="function"){const u=Fn("🐾","Bestiary",()=>{Kt(),c()});u.button.id="bestiary-btn",wt.appendChild(u.button)}if(typeof i=="function"){const u=Fn("👤","Profile",()=>{Kt(),i()});u.button.id="profile-btn",wt.appendChild(u.button)}if(typeof a=="function"){const u=Fn("📜","Log",()=>{Kt(),a()});u.button.id="log-btn",wt.appendChild(u.button)}const f=Fn("🔄","New Game",()=>{Kt(),typeof n=="function"&&n()});f.button.id="reset-btn",wt.appendChild(f.button)}function ph(e){if(!e)return;const t=dd();t.parentElement!==e&&(t.parentElement&&t.parentElement.removeChild(t),e.appendChild(t))}function Is(e){da&&(da.style.display="none"),ua&&(ua.style.display="flex")}function mh(e,t,n,r,o,i,a,d,l,c){const f=document.getElementById("top-menu");f&&(lh(),dd(),uh(),fh(e,t,n,r,o,i,a,d,l,c),f.innerHTML="",f.style.display="none",Wi())}function hh(e){const t=document.getElementById("bottom-menu");t&&(t.innerHTML="",Object.assign(t.style,{position:"fixed",bottom:"0",left:"0",right:"0",background:"var(--menu-bg)",padding:"4px",display:"flex",justifyContent:"center",zIndex:"1000"}))}const Ga=[{type:"iron ore",hardness:2},{type:"copper ore",hardness:2},{type:"tin ore",hardness:1},{type:"coal",hardness:1},{type:"silver ore",hardness:3}];function gh(e){return e&&C.locations.get(e)||null}function bh(e,t,n){var c;const r=e==null?void 0:e.map;if(!((c=r==null?void 0:r.types)!=null&&c.length))return null;const o=Number.isFinite(r.xStart)?Math.trunc(r.xStart):0,i=Number.isFinite(r.yStart)?Math.trunc(r.yStart):0,a=Math.trunc(t)-o,d=Math.trunc(n)-i;if(d<0||a<0)return null;const l=r.types[d];return!l||a>=l.length?null:l[a]}function yh(e){var r;if(!e)return"open";const t=typeof((r=e.map)==null?void 0:r.openTerrainType)=="string"?e.map.openTerrainType:"";if(t)return t.toLowerCase();const n=Mr(e.biome)||null;return bc(n)}function wh(e){return e.map||(e.map={}),(!e.map.resourceNodes||typeof e.map.resourceNodes!="object")&&(e.map.resourceNodes={}),e.map.resourceNodes}function xh(e,t){return`${Math.trunc(e)}:${Math.trunc(t)}`}function vh(e,t,n){const o=(e.map||{}).seed??`${e.id}`,i=Mr(e.biome)||{},a=Ao(o,t,n,"forest-density"),d=Ao(o,t,n,"forest-sizes"),l=Number.isFinite(i.woodMod)?i.woodMod:1,c=3+Math.round(a*5),f=Math.max(1,Math.round(c*l)),u=Math.min(.4,d*.4),p=Math.min(.5,.3+d*.3),h=Math.max(0,Math.round(f*u)),g=Math.max(0,Math.round(f*p));return{type:"forest",trees:{small:Math.max(0,f-h-g),medium:g,large:h},stockpiles:{"small logs":0,"medium logs":0,"large logs":0,firewood:0,planks:0,"building lumber":0}}}function Sh(e,t,n,r=0){const o=Ao(e,t+r,n-r,`ore-type-${r}`),i=Math.floor(o*Ga.length)%Ga.length;return Ga[Math.max(0,i)]}function kh(e,t,n){const o=(e.map||{}).seed??`${e.id}`,i=Ao(o,t,n,"ore-richness"),a=i>.8?3:i>.55?2:1,d=[];for(let c=0;c<a;c+=1){const f=Sh(o,t,n,c+1),u=Ao(o,t-c,n+c,`ore-qty-${c}`),p=Math.max(1,Math.round(3+u*5));d.push({type:f.type,quantity:p,hardness:f.hardness})}const l=Math.max(2,Math.round(4+i*6));return{type:"ore",deposits:d,stone:l,stockpiles:{stone:0}}}function Ch(e,t,n,r){const o=wh(e),i=xh(t,n);if(o[i])r==="forest"&&(o[i].trees||(o[i].trees={small:0,medium:0,large:0}));else if(r==="forest")o[i]=vh(e,t,n);else if(r==="ore")o[i]=kh(e,t,n);else{const a=r&&r!=="open"?r:yh(e);o[i]={type:a}}return(!o[i].stockpiles||typeof o[i].stockpiles!="object")&&(o[i].stockpiles={}),o[i]}function Mh(e,t,n){const r=gh(e);if(!r)return null;const o=bh(r,t,n),i=Ch(r,t,n,o);return i?{...i,trees:{...i.trees||{}},stockpiles:{...i.stockpiles||{}}}:null}function Ds(){Array.isArray(C.orders)||(C.orders=[]),typeof C.orderSeq!="number"&&(C.orderSeq=0)}function Eh(){return Ds(),C.orderSeq+=1,`ord-${C.orderSeq}`}function Th(){return Ds(),C.orders.map(e=>({...e}))}function Ah({type:e,workers:t=1,hours:n=4,notes:r="",metadata:o=null}){Ds();const a={id:Eh(),type:e,workers:Math.max(1,Math.floor(t)),durationHours:Math.max(1,Math.ceil(n)),remainingHours:Math.max(1,Math.ceil(n)),notes:r,status:"pending",metadata:o||null};return C.orders.push(a),{...a}}function Nh(){C.orders=[],C.orderSeq=0}const ps={wood:{icon:"🪵",label:"Wood"},firewood:{icon:"🪵",label:"Firewood"},food:{icon:"🍲",label:"Food Rations"},hides:{icon:"🦬",label:"Animal Hides"},"small stones":{icon:"🪨",label:"Small Stones"},pebbles:{icon:"⚪",label:"Pebbles"},"crafted goods":{icon:"🧰",label:"Crafted Goods"},"construction progress":{icon:"🏗️",label:"Construction Progress"},preservedFood:{icon:"🥫",label:"Preserved Food"},cookedMeals:{icon:"🍖",label:"Cooked Meals"},hidesPrepared:{icon:"🧵",label:"Prepared Hides"},mushrooms:{icon:"🍄",label:"Mushrooms"},herbs:{icon:"🌿",label:"Wild Herbs"},berries:{icon:"🍓",label:"Wild Berries"},pinecones:{icon:"🌰",label:"Pinecones"},"plant fibers":{icon:"🌾",label:"Plant Fibers"},water:{icon:"💧",label:"Water"},grain:{icon:"🌾",label:"Grain"},"root vegetables":{icon:"🥕",label:"Root Vegetables"},salt:{icon:"🧂",label:"Salt"},spices:{icon:"🧄",label:"Spices"},feathers:{icon:"🪶",label:"Feathers"},"animal fat":{icon:"🧈",label:"Animal Fat"},milk:{icon:"🥛",label:"Milk"},cord:{icon:"🪢",label:"Cord"},"sharpened stone":{icon:"🗡️",label:"Sharpened Stone"},"straight branch":{icon:"🌿",label:"Straight Branch"},"sturdy haft stick":{icon:"🥢",label:"Sturdy Haft Stick"},"seasoned wood":{icon:"🪑",label:"Seasoned Wood"},"prepared hides":{icon:"🧵",label:"Prepared Hides"},"raw ore":{icon:"⛏️",label:"Raw Ore"},"bronze ingot":{icon:"🔶",label:"Bronze Ingot"},"iron ingot":{icon:"⛓️",label:"Iron Ingot"},"steel ingot":{icon:"⚙️",label:"Steel Ingot"},charcoal:{icon:"⬛",label:"Charcoal"},clay:{icon:"🧱",label:"Clay"},"rendered tallow":{icon:"🕯️",label:"Rendered Tallow"},"ground flour":{icon:"🥣",label:"Ground Flour"},"hearty meal":{icon:"🍲",label:"Hearty Meal"},"bone broth":{icon:"🍜",label:"Bone Broth"},"traveler's bread":{icon:"🥖",label:"Traveler's Bread"},"comfort meal":{icon:"🥣",label:"Comfort Meal"},"smoked provisions":{icon:"🥩",label:"Smoked Provisions"},"preserved vegetables":{icon:"🥬",label:"Preserved Vegetables"},seeds:{icon:"🌱",label:"Seeds"},"aromatic sachet":{icon:"🪷",label:"Aromatic Sachet"},"herbal poultice":{icon:"🩹",label:"Herbal Poultice"},"restorative tonic":{icon:"🧪",label:"Restorative Tonic"},"soothing salve":{icon:"💧",label:"Soothing Salve"}};ru().forEach(e=>{const t=ps[e.id]||{};ps[e.id]={icon:e.icon||t.icon||"🎒",label:e.label||t.label||e.id}});function ci(e){if(!e)return null;const t=ps[e];if(t)return t;const n=wa(e);return n?{icon:n.icon,label:n.label}:null}function Ba(e){if(!e)return"";const t=ci(e);return t!=null&&t.label?t.label:typeof e=="string"&&e.trim()?e.split(/\s+/).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" "):""}const Lh=4200,Li={open:1,forest:1.7,ore:1.3,stone:1.4,water:4,ocean:4.2,lake:4,river:3.8,marsh:2.8,mangrove:3.1,default:1.25};function jl(e){if(!e)return Li.default;const t=typeof e=="string"?e.toLowerCase():"";return wr(t)?Li.open:Li[t]??Li.default}function _l(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,e)):t}function Bh({fromTerrain:e="open",toTerrain:t="open",distance:n=To,swimmingLevel:r=1}={}){const o=Math.max(1,Number.isFinite(n)?n:To),i=jl(e),a=jl(t);let d=(i+a)/2,l=!1,c="";if(Tn(t)||Tn(e)){const u=_l(r,1,100);if(u<8)l=!0,c="The current is too strong to cross without better swimming skill.";else{const p=_l(3.5-u/25,1.5,3.5);d*=p,u<25&&(c="Crossing the water is slow and exhausting.")}}return{hours:o/Lh*d,blocked:l,reason:c,distance:o,multiplier:d}}function ql(e){const t=typeof e=="string"?e.toLowerCase():"";if(wr(t))return"Gentle terrain allows steady progress.";switch(t){case"forest":return"Dense canopy and underbrush slow travel.";case"ore":return"Rocky outcrops require careful footing.";case"stone":return"Jagged stone forces a cautious pace.";case"water":case"lake":case"ocean":return"Requires swimming or a boat to cross safely.";case"river":return"Swift currents complicate fording attempts.";case"marsh":return"Slogging through wetlands is slow and exhausting.";case"mangrove":return"Dense roots and tidal pools demand careful, time-consuming steps.";default:return"Gentle terrain allows steady progress."}}function ud(e="",{fallback:t=""}={}){const n=String(e??"").trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");return n||t}function fd(e,t=""){return typeof e!="string"?t:e.trim().toLowerCase()||t}function Fh(e,t){const n=fd(e);return!n||!t?!1:n===t?!0:n==="open"||n==="meadow"?wr(t):wr(n)&&wr(t)?n===t:!1}const Rh={Thawbound:2,Sunheight:3,Emberwane:3,Frostshroud:2},Ui=["water","river","lake","marsh","ocean","mangrove"],$h=[{name:"Rowan",habitats:["forest"],encounterName:"storm-felled rowan limb",successSuffix:"from a storm-felled rowan branch ideal for hafting tools."},{name:"Buttonwood",habitats:Ui,encounterName:"salt-hardened buttonwood branch",successSuffix:"from the tide-smoothed buttonwood branch, tough enough for sturdy grips."},{name:"Carob",habitats:["forest","open"],encounterName:"fallen carob limb",successSuffix:"after trimming a dense carob branch suited for tool hafts."}],pd=$h.map(e=>{const t=ud(e.name,{fallback:"tree"}),n=e.name.toLowerCase(),r=`sturdy ${n} stick`;return{id:`sturdy-stick-${t}`,resource:r,singularName:r,encounterName:e.encounterName||`fallen ${n} branch`,type:"loose",habitats:Array.isArray(e.habitats)&&e.habitats.length?[...e.habitats]:["forest"],baseWeight:Number.isFinite(e.baseWeight)?e.baseWeight:2,seasonWeights:{...Rh,...e.seasonWeights||{}},minQuantity:Number.isFinite(e.minQuantity)?e.minQuantity:1,maxQuantity:Number.isFinite(e.maxQuantity)?e.maxQuantity:2,timePerUnit:Number.isFinite(e.timePerUnit)?e.timePerUnit:.35,respawnHours:Number.isFinite(e.respawnHours)?e.respawnHours:16,successSuffix:typeof e.successSuffix=="string"?e.successSuffix:`from a resilient ${n} branch ready to be carved into handles.`,blockedVerb:"gather"}}),Hh=[{id:"forest-mushrooms",resource:"mushrooms",singularName:"mushroom",encounterName:"cluster of mushrooms",type:"loose",habitats:["forest"],baseWeight:3,seasonWeights:{Thawbound:4,Sunheight:2,Emberwane:5,Frostshroud:1},minQuantity:1,maxQuantity:4,timePerUnit:.15,respawnHours:20,successSuffix:"from the forest floor."},{id:"forest-firewood",resource:"firewood",singularName:"bundle of firewood",encounterName:"fallen branches",type:"loose",habitats:["forest"],baseWeight:3,seasonWeights:{Thawbound:3,Sunheight:3,Emberwane:3,Frostshroud:2},minQuantity:1,maxQuantity:3,timePerUnit:.25,respawnHours:12,successSuffix:"from the surrounding forest."},{id:"forest-pinecones",resource:"pinecones",singularName:"pinecone",encounterName:"scatter of pinecones",type:"loose",habitats:["forest"],baseWeight:2,seasonWeights:{Thawbound:2,Sunheight:3,Emberwane:3,Frostshroud:1},minQuantity:2,maxQuantity:6,timePerUnit:.05,respawnHours:10,successSuffix:"from beneath the conifers."},{id:"forest-herbs",resource:"herbs",singularName:"bundle of herbs",encounterName:"patch of herbs",type:"loose",habitats:["forest"],baseWeight:2,seasonWeights:{Thawbound:2,Sunheight:3,Emberwane:4,Frostshroud:1},minQuantity:1,maxQuantity:3,timePerUnit:.2,respawnHours:18,successSuffix:"from a shaded glade."},{id:"forest-spices",resource:"spices",singularName:"handful of aromatic bark",encounterName:"clump of spice bark",type:"loose",habitats:["forest"],baseWeight:1.5,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:3,Frostshroud:1},minQuantity:1,maxQuantity:2,timePerUnit:.22,respawnHours:36,successSuffix:"by shaving fragrant bark and seed pods."},{id:"open-fibers",resource:"plant fibers",singularName:"bundle of plant fibers",encounterName:"tough meadow grasses",type:"loose",habitats:["open"],baseWeight:3,seasonWeights:{Thawbound:2,Sunheight:4,Emberwane:3,Frostshroud:1},minQuantity:1,maxQuantity:4,timePerUnit:.2,respawnHours:16,successSuffix:"by stripping tough grasses."},{id:"straight-saplings",resource:"straight branch",singularName:"straight branch",encounterName:"stand of straight saplings",type:"loose",habitats:["open","forest"],baseWeight:2.5,seasonWeights:{Thawbound:2,Sunheight:3,Emberwane:3,Frostshroud:2},minQuantity:1,maxQuantity:3,timePerUnit:.18,respawnHours:18,successSuffix:"after trimming a straight sapling for tool shafts."},{id:"open-berries",resource:"berries",singularName:"handful of berries",encounterName:"tangle of blackberries",type:"harvest",habitats:["open","forest"],baseWeight:2,seasonWeights:{Thawbound:0,Sunheight:4,Emberwane:5,Frostshroud:1},minQuantity:3,maxQuantity:8,timePerUnit:.18,respawnHours:48,successSuffix:"from a tangled bramble.",blockedVerb:"harvest"},{id:"meadow-grain",resource:"grain",singularName:"sheaf of grain",encounterName:"patch of wild grain",type:"harvest",habitats:["meadow","open"],baseWeight:2,seasonWeights:{Thawbound:0,Sunheight:3,Emberwane:4,Frostshroud:1},minQuantity:2,maxQuantity:5,timePerUnit:.25,respawnHours:36,successSuffix:"from the ripened heads of wild grain.",blockedVerb:"harvest"},{id:"meadow-root-vegetables",resource:"root vegetables",singularName:"bundle of root vegetables",encounterName:"cluster of wild tubers",type:"harvest",habitats:["meadow","open"],baseWeight:2,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:3,Frostshroud:1},minQuantity:2,maxQuantity:4,timePerUnit:.28,respawnHours:40,successSuffix:"after digging up hearty tubers.",blockedVerb:"dig"},{id:"open-stones",resource:"small stones",singularName:"small stone",encounterName:"scatter of stones",type:"loose",habitats:["open","ore"],baseWeight:3,seasonWeights:{Thawbound:3,Sunheight:3,Emberwane:3,Frostshroud:2},minQuantity:2,maxQuantity:5,timePerUnit:.08,respawnHours:8,successSuffix:"from the ground."},{id:"shore-driftwood",resource:"firewood",singularName:"driftwood log",encounterName:"driftwood",type:"loose",habitats:Ui,baseWeight:2,seasonWeights:{Thawbound:2,Sunheight:2,Emberwane:3,Frostshroud:2},minQuantity:1,maxQuantity:3,timePerUnit:.22,respawnHours:14,successSuffix:"washed up along the shore."},{id:"shore-herbs",resource:"herbs",singularName:"bundle of shoreline herbs",encounterName:"stand of shoreline herbs",type:"loose",habitats:Ui,baseWeight:1,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:3,Frostshroud:1},minQuantity:1,maxQuantity:2,timePerUnit:.18,respawnHours:20,successSuffix:"from the marshy banks."},{id:"shore-salt-crust",resource:"salt",singularName:"chunk of salt crust",encounterName:"salt-encrusted tide pool",type:"harvest",habitats:Ui,baseWeight:1,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:2,Frostshroud:1},minQuantity:1,maxQuantity:3,timePerUnit:.3,respawnHours:30,successSuffix:"by scraping salt crust from a receding tide pool.",blockedVerb:"scrape"},{id:"forest-log",resource:"firewood",singularName:"length of timber",encounterName:"fallen log",type:"harvest",habitats:["forest"],baseWeight:1.5,seasonWeights:{Thawbound:2,Sunheight:2,Emberwane:2,Frostshroud:1},minQuantity:3,maxQuantity:6,timePerUnit:.35,respawnHours:72,toolsRequired:["stone hand axe"],successSuffix:"after chopping apart a fallen log.",blockedVerb:"fell"},{id:"forest-carcass",resource:"animal fat",singularName:"lump of animal fat",encounterName:"fresh carcass scraps",type:"harvest",habitats:["forest"],baseWeight:1,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:2,Frostshroud:1},minQuantity:1,maxQuantity:2,timePerUnit:.35,respawnHours:42,toolsRequired:["stone knife"],successSuffix:"after carefully trimming usable fats from a carcass.",blockedVerb:"render"},{id:"meadow-feathers",resource:"feathers",singularName:"bundle of feathers",encounterName:"scatter of molted feathers",type:"loose",habitats:["meadow","open"],baseWeight:2,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:3,Frostshroud:1},minQuantity:2,maxQuantity:6,timePerUnit:.12,respawnHours:18,successSuffix:"gathered from nesting grounds."},{id:"ore-vein",resource:"raw ore",singularName:"chunk of raw ore",encounterName:"vein of ore",type:"harvest",habitats:["ore"],baseWeight:1.2,seasonWeights:{Thawbound:2,Sunheight:2,Emberwane:2,Frostshroud:2},minQuantity:1,maxQuantity:2,timePerUnit:1.5,respawnHours:0,toolsRequired:["stone hand axe","wooden hammer"],successSuffix:"from the exposed vein.",blockedVerb:"mine"}],Ih=[...Hh,...pd],Wl=new Map;function Dh(e,t){const n=fd(e,t);if(!n)return[];const r=Wl.get(n);if(r)return r;const o=Ih.filter(i=>Array.isArray(i.habitats)&&i.habitats.some(a=>Fh(a,n)));return Wl.set(n,o),o}function Oh(e){const t=Dh(e);return t.length?t.map(n=>({id:n.id,resource:n.resource,encounterName:n.encounterName||n.resource,type:n.type,toolsRequired:Array.isArray(n.toolsRequired)?[...n.toolsRequired]:[]})):[]}const zh=pd.map(e=>e.resource);function Wn(e,t={}){const{effect:n={},...r}=t||{},o=e.effect||{},i={inputMultiplier:n.inputMultiplier??o.inputMultiplier??1,outputMultiplier:n.outputMultiplier??o.outputMultiplier??1,laborMultiplier:n.laborMultiplier??o.laborMultiplier??1,timeMultiplier:n.timeMultiplier??o.timeMultiplier??1,batchBonus:n.batchBonus??o.batchBonus??0};return{...e,...r,effect:i}}const xe={handCraft:e=>Wn({id:"manual",label:"Hand Crafting",type:"manual",priority:0,effect:{inputMultiplier:1,outputMultiplier:.75,laborMultiplier:1.25,timeMultiplier:1.15,batchBonus:0}},e),handCook:e=>Wn({id:"manual-cook",label:"Improvised Cooking",type:"manual",priority:0,effect:{inputMultiplier:1,outputMultiplier:.65,laborMultiplier:1.3,timeMultiplier:1.25,batchBonus:0}},e),workshopBench:e=>Wn({id:"workshop-bench",label:"Workshop Benches",type:"building",building:"workshop",priority:18,effect:{inputMultiplier:1,outputMultiplier:1.15,laborMultiplier:.85,timeMultiplier:.9,batchBonus:0}},e),workshopForge:e=>Wn({id:"workshop-forge",label:"Workshop Forge",type:"building",building:"workshop",priority:22,effect:{inputMultiplier:1,outputMultiplier:1.2,laborMultiplier:.8,timeMultiplier:.85,batchBonus:0}},e),steelForge:e=>Wn({id:"steel-forge",label:"Refined Forge",type:"building",building:"workshop",priority:24,effect:{inputMultiplier:1,outputMultiplier:1.25,laborMultiplier:.75,timeMultiplier:.85,batchBonus:0}},e),firePit:e=>Wn({id:"fire-pit",label:"Fire Pit Hearth",type:"building",building:"fire-pit",priority:20,effect:{inputMultiplier:1,outputMultiplier:1.25,laborMultiplier:.9,timeMultiplier:.8,batchBonus:0}},e),longhouseHearth:e=>Wn({id:"longhouse-hearth",label:"Longhouse Hearth",type:"building",building:"longhouse",priority:16,effect:{inputMultiplier:1,outputMultiplier:1.18,laborMultiplier:.9,timeMultiplier:.85,batchBonus:0}},e),dryingRack:e=>Wn({id:"drying-rack",label:"Drying Rack",type:"building",building:"drying-rack",priority:14,effect:{inputMultiplier:.95,outputMultiplier:1.1,laborMultiplier:.95,timeMultiplier:.85,batchBonus:0}},e),smokehouse:e=>Wn({id:"smokehouse",label:"Smokehouse",type:"building",building:"smokehouse",priority:22,effect:{inputMultiplier:.9,outputMultiplier:1.35,laborMultiplier:.85,timeMultiplier:.9,batchBonus:0}},e)},md=[{id:"intermediate",label:"Intermediate Materials",recipes:[{id:"cord",name:"Cord",icon:"🪢",description:"Twist pliable fibers into sturdy cord for lashings and traps.",category:"intermediate",inputs:{"plant fibers":3},outputs:{cord:1},laborHours:.5,timeHours:.5,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:5,label:"lengths"},production:[xe.handCraft(),xe.workshopBench()]},{id:"sharpened-stone",name:"Sharpened Stone",icon:"🗡️",description:"Shape a keen stone edge for scraping hides or cutting cords.",category:"intermediate",inputs:{"small stones":1},outputs:{"sharpened stone":1},laborHours:.25,timeHours:.25,tools:["wooden hammer"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:6,label:"blanks"},production:[xe.handCraft(),xe.workshopBench()]},{id:"prepared-hides",name:"Prepared Hides",icon:"🧵",description:"Scrape, cure, and soften hides for armor and advanced crafting.",category:"intermediate",inputs:{hides:1,herbs:1,"plant fibers":1},outputs:{"prepared hides":1},laborHours:2.5,timeHours:6,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:2,label:"hides"},production:[xe.handCraft(),xe.dryingRack()]},{id:"seasoned-wood",name:"Seasoned Wood",icon:"🪑",description:"Air-dry select timber into balanced hafts and bow staves.",category:"intermediate",inputs:{firewood:3},outputs:{"seasoned wood":1},laborHours:1,timeHours:24,tools:["stone hand axe"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"bundles"},production:[xe.handCraft({label:"Open-Air Seasoning",effect:{outputMultiplier:.7,laborMultiplier:1.3}}),xe.workshopBench({label:"Workshop Racks"})]},{id:"rendered-tallow",name:"Rendered Tallow",icon:"🕯️",description:"Slowly clarify animal fats into clean-burning tallow cakes.",category:"intermediate",inputs:{"animal fat":3,firewood:1,salt:1},outputs:{"rendered tallow":2},laborHours:1.5,timeHours:4,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"batches"},production:[xe.handCook({label:"Camp Rendering",effect:{outputMultiplier:.7,laborMultiplier:1.25,timeMultiplier:1.2}}),xe.firePit()]},{id:"grain-flour",name:"Ground Flour",icon:"🥣",description:"Crush grains into coarse flour suitable for breads and porridges.",category:"intermediate",inputs:{grain:3,"small stones":1},outputs:{"ground flour":3},laborHours:1,timeHours:1,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:4,label:"sacks"},production:[xe.handCraft({label:"Hand Milling",effect:{outputMultiplier:.8,laborMultiplier:1.2}}),xe.workshopBench({label:"Quern Bench"})]},{id:"bronze-ingot",name:"Smelt Bronze Ingot",icon:"🔶",description:"Smelt raw ore in clay crucibles to pour balanced bronze ingots.",category:"intermediate",inputs:{"raw ore":3,firewood:2},outputs:{"bronze ingot":1},laborHours:6,timeHours:8,tools:["wooden hammer"],unlock:{technologies:["bronze-smithing"]},batch:{defaultSize:1,maxSize:2,label:"ingots"},production:[xe.workshopForge()]},{id:"iron-ingot",name:"Smelt Iron Ingot",icon:"⛓️",description:"Roast ore and hammer blooms into workable iron ingots.",category:"intermediate",inputs:{"raw ore":4,firewood:3},outputs:{"iron ingot":1},laborHours:8,timeHours:12,tools:["wooden hammer"],unlock:{technologies:["iron-smithing"]},batch:{defaultSize:1,maxSize:2,label:"ingots"},production:[xe.workshopForge({label:"Bloomery Forge",effect:{outputMultiplier:1.22,laborMultiplier:.78}})]},{id:"steel-ingot",name:"Forge Steel Ingot",icon:"⚙️",description:"Carburize iron with additional ore to forge high-grade steel.",category:"intermediate",inputs:{"iron ingot":1,"raw ore":3,"seasoned wood":1},outputs:{"steel ingot":1},laborHours:10,timeHours:16,tools:["wooden hammer"],unlock:{technologies:["steel-smithing"]},batch:{defaultSize:1,maxSize:2,label:"ingots"},production:[xe.steelForge()]}]},{id:"meals",label:"Cooked Meals",recipes:[{id:"hearty-stew",name:"Hearty Stew",icon:"🍲",description:"Simmer grains, vegetables, and meat into a filling communal stew.",category:"meals",inputs:{grain:2,"root vegetables":3,food:2,herbs:1,salt:1},outputs:{"hearty meal":3,"bone broth":1},laborHours:2.5,timeHours:3,tools:["stone knife","wooden hammer"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"pots"},production:[xe.handCook({effect:{outputMultiplier:.6,laborMultiplier:1.35}}),xe.firePit(),xe.longhouseHearth({label:"Longhouse Cauldrons",effect:{outputMultiplier:1.35,laborMultiplier:.8,timeMultiplier:.75}})]},{id:"traveler-flatbread",name:"Traveler Flatbread",icon:"🥖",description:"Bake dense flatbreads that travel well for scouting parties.",category:"meals",inputs:{"ground flour":3,salt:1,"rendered tallow":1},outputs:{"traveler's bread":4},laborHours:1.5,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"rounds"},production:[xe.handCook({label:"Hearthstones",effect:{outputMultiplier:.7,laborMultiplier:1.25}}),xe.firePit()]},{id:"herbal-porridge",name:"Herbal Porridge",icon:"🥣",description:"Blend grains, berries, and herbs into a soothing morning porridge.",category:"meals",inputs:{grain:2,berries:2,herbs:1,spices:1},outputs:{"comfort meal":3},laborHours:1,timeHours:1.5,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"bowls"},production:[xe.handCook({effect:{outputMultiplier:.7}}),xe.firePit()]}]},{id:"preserves",label:"Preserves & Stores",recipes:[{id:"smoke-cured-provisions",name:"Smoke-cured Provisions",icon:"🥩",description:"Salt and smoke cuts of meat for durable expedition rations.",category:"preserves",inputs:{food:4,salt:2,spices:1,firewood:2},outputs:{"smoked provisions":3},laborHours:3,timeHours:6,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"hooks"},production:[xe.handCook({label:"Makeshift Smoke",effect:{outputMultiplier:.6,laborMultiplier:1.4}}),xe.dryingRack(),xe.smokehouse()]},{id:"pickled-vegetables",name:"Pickled Vegetables",icon:"🥬",description:"Pack roots with herbs and salt into lasting pickled stores.",category:"preserves",inputs:{"root vegetables":4,salt:1,herbs:1,"crafted goods":1},outputs:{"preserved vegetables":4},laborHours:2,timeHours:4,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"jars"},production:[xe.handCraft({label:"Earthen Crocks",effect:{outputMultiplier:.8,laborMultiplier:1.2}}),xe.workshopBench({label:"Workshop Brining"})]},{id:"aromatic-sachets",name:"Aromatic Sachets",icon:"🪷",description:"Dry herbs and spices into sachets that deter pests from stores.",category:"preserves",inputs:{herbs:3,spices:2,"plant fibers":2},outputs:{"aromatic sachet":3},laborHours:1,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:4,label:"sachets"},production:[xe.handCraft({label:"Sun-dried Bundles"}),xe.dryingRack(),xe.workshopBench({label:"Workshop Infusers",effect:{outputMultiplier:1.2,laborMultiplier:.8}})]}]},{id:"remedies",label:"Herbal Remedies",recipes:[{id:"herbal-poultice",name:"Herbal Poultice",icon:"🩹",description:"Mash herbs into soothing poultices that speed recovery.",category:"remedies",inputs:{herbs:3,"plant fibers":2,"animal fat":1},outputs:{"herbal poultice":2},laborHours:1.5,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"wraps"},production:[xe.handCraft({label:"Field Dressing"}),xe.dryingRack(),xe.workshopBench({label:"Workshop Apothecary",effect:{outputMultiplier:1.25,laborMultiplier:.85}})]},{id:"restorative-tonic",name:"Restorative Tonic",icon:"🧪",description:"Brew concentrated herbal tonics to bolster the infirm.",category:"remedies",inputs:{herbs:2,berries:2,spices:1,salt:1},outputs:{"restorative tonic":2},laborHours:2,timeHours:3,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"bottles"},production:[xe.handCook({label:"Camp Brew",effect:{outputMultiplier:.7}}),xe.firePit({label:"Hearth Decoction"}),xe.workshopBench({label:"Workshop Still",effect:{outputMultiplier:1.25,laborMultiplier:.85}})]},{id:"soothing-salve",name:"Soothing Salve",icon:"💧",description:"Blend tallow and herbs into salves that stave off infection.",category:"remedies",inputs:{"rendered tallow":2,herbs:2,spices:1},outputs:{"soothing salve":3},laborHours:1.5,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"pots"},production:[xe.handCraft({label:"Palm Mixing"}),xe.workshopBench({label:"Workshop Mortars",effect:{outputMultiplier:1.2,laborMultiplier:.85}})]}]},{id:"ammunition",label:"Ammunition & Weaponry",recipes:[{id:"arrow-bundle",name:"Arrow Bundle",icon:"🏹",description:"Carve, fletch, and bundle arrows for ranged hunters.",category:"ammunition",inputs:{"seasoned wood":1,"plant fibers":2,"sharpened stone":2,feathers:4},outputs:{"wooden arrow":6},laborHours:2,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"bundles"},production:[xe.handCraft({label:"Trail Fletching",effect:{outputMultiplier:.8,laborMultiplier:1.2}}),xe.workshopBench({label:"Workshop Fletching Table",effect:{outputMultiplier:1.2,laborMultiplier:.85}})]}]},{id:"equipment",label:"Crafted Equipment",recipes:[{id:"stone-hand-axe",name:"Stone Hand Axe",icon:"🪓",description:"Haft a sharpened stone blade onto a seasoned branch for chopping timber.",category:"equipment",inputs:{cord:1,"sharpened stone":1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"stone hand axe":1},laborHours:2,timeHours:2,tools:["stone knife","wooden hammer"],unlock:{technologies:["basic-tools"]},production:[xe.handCraft({label:"Camp Assembly",effect:{outputMultiplier:.85,laborMultiplier:1.15}}),xe.workshopBench({label:"Workshop Assembly"})]},{id:"stone-pick",name:"Stone Pick",icon:"⛏️",description:"Chip a pointed stone and lash it to a haft for prying ore from seams.",category:"equipment",inputs:{cord:1,"sharpened stone":2,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"stone pick":1},laborHours:2.5,timeHours:2.5,tools:["stone knife","wooden hammer"],unlock:{technologies:["basic-tools"]},production:[xe.handCraft({label:"Trail Forging",effect:{outputMultiplier:.85,laborMultiplier:1.2}}),xe.workshopBench({label:"Workshop Toolbench"})]},{id:"bronze-axe",name:"Bronze Axe",icon:"🪓",description:"Forge a bronze axe head and bind it to a resilient haft for advanced lumbering.",category:"equipment",inputs:{"bronze ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"bronze axe":1},laborHours:6,timeHours:6,tools:["wooden hammer"],unlock:{technologies:["bronze-smithing"]},production:[xe.workshopForge({label:"Bronze Forge Bay"})]},{id:"bronze-pick",name:"Bronze Pick",icon:"⛏️",description:"Cast and temper a bronze pick for sturdier mining expeditions.",category:"equipment",inputs:{"bronze ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"bronze pick":1},laborHours:6,timeHours:6,tools:["wooden hammer"],unlock:{technologies:["bronze-smithing"]},production:[xe.workshopForge({label:"Bronze Forge Bay"})]},{id:"iron-axe",name:"Iron Axe",icon:"🪓",description:"Shape wrought iron into a balanced axe capable of felling great trees.",category:"equipment",inputs:{"iron ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"iron axe":1},laborHours:8,timeHours:8,tools:["wooden hammer"],unlock:{technologies:["iron-smithing"]},production:[xe.workshopForge({label:"Iron Forge Bay",effect:{outputMultiplier:1.25,laborMultiplier:.78}})]},{id:"iron-pick",name:"Iron Pick",icon:"⛏️",description:"Forge an iron pickaxe able to bite through dense stone and ore.",category:"equipment",inputs:{"iron ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"iron pick":1},laborHours:8,timeHours:8,tools:["wooden hammer"],unlock:{technologies:["iron-smithing"]},production:[xe.workshopForge({label:"Iron Forge Bay",effect:{outputMultiplier:1.25,laborMultiplier:.78}})]},{id:"steel-axe",name:"Steel Axe",icon:"🪓",description:"Quench a steel axe head and mount it for master-level forestry.",category:"equipment",inputs:{"steel ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"steel axe":1},laborHours:12,timeHours:12,tools:["wooden hammer"],unlock:{technologies:["steel-smithing"]},production:[xe.steelForge({label:"Steel Forge Bay"})]},{id:"steel-pick",name:"Steel Pick",icon:"⛏️",description:"Temper a steel pick to shatter the hardest stone without dulling.",category:"equipment",inputs:{"steel ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"steel pick":1},laborHours:12,timeHours:12,tools:["wooden hammer"],unlock:{technologies:["steel-smithing"]},production:[xe.steelForge({label:"Steel Forge Bay"})]}]}];function Ph(e){const t=wa(e);if(!t)throw new Error(`Missing equipment definition for ${e}`);return t}const Ul=Array.from(new Set(zh||[])).filter(Boolean);function Gr(e){return Array.isArray(e)?e.map(t=>Gr(t)):e&&typeof e=="object"?Object.fromEntries(Object.entries(e).map(([t,n])=>[t,Gr(n)])):e}function fa(e){if(Array.isArray(e))return e.map(t=>fa(t));if(e&&typeof e=="object"){const t={};if(Object.entries(e).forEach(([n,r])=>{t[n]=fa(r)}),t.dynamicOptions==="sturdy-stick"){const n=Ul.length?[...Ul]:["sturdy haft stick"];t.options=n,delete t.dynamicOptions,t.label||(t.label="sturdy haft stick"),["quantity","amount","count","required","qty","value"].some(i=>t[i]!==void 0)||(t.quantity=1)}return t}return e}function jh(e){if(!e)return{};if(Array.isArray(e))return e.map(n=>fa(n));if(typeof e!="object")return e;const t={};return Object.entries(e).forEach(([n,r])=>{t[n]=fa(r)}),t}function _h(e){if(!e||typeof e!="object")return{defaultSize:1,maxSize:1,label:"batches"};const t=Math.max(1,Math.floor(e.defaultSize??e.size??1)),n=Math.max(t,Math.floor(e.maxSize??e.maximum??t)),r=e.label||e.unit||"batches";return{defaultSize:t,maxSize:n,label:r}}function hd(e){if(!e)return null;if(e==="always")return{always:!0};if(typeof e=="string")return{technologies:[e]};const t={};e.always&&(t.always=!0);const n=new Set,r=new Set,o=new Set,i=new Set;function a(d,l){if(!l)return;(Array.isArray(l)?l:[l]).forEach(f=>{!f&&f!==0||d.add(String(f))})}return a(n,e.technology),a(n,e.technologies),a(n,e.tech),a(n,e.requiredTech),a(r,e.anyTechnology),a(r,e.anyTechnologies),a(r,e.anyTech),a(o,e.building),a(o,e.buildings),a(o,e.structures),a(i,e.anyBuilding),a(i,e.anyBuildings),n.size&&(t.technologies=[...n]),r.size&&(t.anyTechnology=[...r]),o.size&&(t.buildings=[...o]),i.size&&(t.anyBuilding=[...i]),Object.keys(t).length?t:null}function qh(e){return Array.isArray(e)?e.map(t=>{if(!t)return null;const n=t.type||t.kind,r=t.id||t.building||t.technology;if(!n||!r)return null;const o=t.effect||{},i=Number.isFinite(o.inputMultiplier??t.inputMultiplier)?o.inputMultiplier??t.inputMultiplier:1,a=Number.isFinite(o.outputMultiplier??t.outputMultiplier)?o.outputMultiplier??t.outputMultiplier:1,d=Number.isFinite(o.laborMultiplier??t.laborMultiplier)?o.laborMultiplier??t.laborMultiplier:1,l=Number.isFinite(o.timeMultiplier??t.timeMultiplier)?o.timeMultiplier??t.timeMultiplier:1,c=Number.isFinite(o.batchBonus??t.batchBonus)?o.batchBonus??t.batchBonus:0;return{type:String(n),id:String(r),effect:{inputMultiplier:i,outputMultiplier:a,laborMultiplier:d,timeMultiplier:l,batchBonus:c}}}).filter(Boolean):[]}function Wh(e={}){const t=e.effect||{},n=Number.isFinite(t.inputMultiplier??e.inputMultiplier)?t.inputMultiplier??e.inputMultiplier:1,r=Number.isFinite(t.outputMultiplier??e.outputMultiplier)?t.outputMultiplier??e.outputMultiplier:1,o=Number.isFinite(t.laborMultiplier??e.laborMultiplier)?t.laborMultiplier??e.laborMultiplier:1,i=Number.isFinite(t.timeMultiplier??e.timeMultiplier)?t.timeMultiplier??e.timeMultiplier:1,a=Number.isFinite(t.batchBonus??e.batchBonus)?t.batchBonus??e.batchBonus:0;return{inputMultiplier:n,outputMultiplier:r,laborMultiplier:o,timeMultiplier:i,batchBonus:a}}function Yl(e,t=0){if(!e)return null;const n=e.id||e.mode||e.name||e.building||`mode-${t}`,r=e.type||e.kind||(e.building?"building":"manual"),o=String(r).toLowerCase()==="hand"?"manual":String(r),i=e.label||e.name||(e.building?`${e.building} station`:"Manual Work"),a=Number.isFinite(e.priority)?Number(e.priority):o==="manual"?0:10+t,d=e.description||"",l=e.requires||e.requirement||e.unlock||null;let c=hd(l);const f=e.building||e.structure||e.station||null;if(f){const p=String(f),h=c?{...c}:{},g=new Set(h.buildings||[]);g.add(p),h.buildings=[...g],c=Object.keys(h).length?h:null}const u=Wh(e);return{id:String(n),label:i,type:o,buildingId:f?String(f):null,effect:u,requirements:c,priority:a,description:d}}function Uh(e){return!Array.isArray(e)||!e.length?[Yl({id:"manual",label:"Hand Crafting",type:"manual",effect:{inputMultiplier:1,outputMultiplier:1,laborMultiplier:1,timeMultiplier:1,batchBonus:0},priority:0},0)]:e.map((t,n)=>Yl(t,n)).filter(Boolean)}function Yh(e){if(!e)return{available:!0,missing:null};if(e.always)return{available:!0,missing:null};const t={technologies:[],anyTechnology:[],buildings:[],anyBuilding:[]};let n=!0;const r=[];if(Array.isArray(e.technologies)&&r.push(...e.technologies),r.length){const d=r.filter(l=>!yn(l));d.length&&(n=!1,t.technologies=[...new Set(d.map(l=>String(l)))])}const o=Array.isArray(e.anyTechnology)?e.anyTechnology:[];o.length&&(o.some(l=>yn(l))||(n=!1,t.anyTechnology=[...new Set(o.map(l=>String(l)))]));const i=[];if(Array.isArray(e.buildings)&&i.push(...e.buildings),i.length){const d=i.filter(l=>!No(l));d.length&&(n=!1,t.buildings=[...new Set(d.map(l=>String(l)))])}const a=Array.isArray(e.anyBuilding)?e.anyBuilding:[];return a.length&&(a.some(l=>No(l))||(n=!1,t.anyBuilding=[...new Set(a.map(l=>String(l)))])),Object.keys(t).forEach(d=>{Array.isArray(t[d])&&!t[d].length&&delete t[d]}),{available:n,missing:Object.keys(t).length?t:null}}function Xh(e,t=null){const n=((e==null?void 0:e.productionModes)||[]).map((d,l)=>{const c=Yh(d.requirements);return{...d,index:l,status:c}}),r=n.filter(d=>d.status.available);let o=null;if(t){const d=String(t);o=n.find(l=>l.id===d&&l.status.available)||null}!o&&r.length&&(o=[...r].sort((d,l)=>l.priority===d.priority?d.index-l.index:l.priority-d.priority)[0]);const i=t&&n.find(d=>d.id===String(t))||null,a=o||i||(n.length?n[0]:null);return{modes:n,selected:o,fallback:a}}function Gh(e,t,n){const r=String(e.id),o=(e.tools||[]).map(c=>Ph(c)),i=jh(e.inputs||{}),a=Gr(e.outputs||{}),d=Number.isFinite(e.laborHours)?e.laborHours:Number.isFinite(e.timeHours)?e.timeHours:0,l=Number.isFinite(e.timeHours)?e.timeHours:Number.isFinite(e.laborHours)?e.laborHours:0;return{id:r,name:e.name||r,icon:e.icon||"🛠️",description:e.description||"",category:e.category||t,groupId:t,groupLabel:n,baseInputs:i,baseOutputs:a,inputs:Gr(i),outputs:Gr(a),laborHours:d,timeHours:l,baseLaborHours:d,baseTimeHours:l,toolsRequired:o.map(c=>c.id),toolDetails:o,unlock:hd(e.unlock),batch:_h(e.batch),efficiencyBonuses:qh(e.efficiency),productionModes:Uh(e.production||e.workstations||e.stations)}}function Vh(e){const t=[];return(e||[]).forEach(n=>{const r=(n==null?void 0:n.id)||"general",o=(n==null?void 0:n.label)||r;((n==null?void 0:n.recipes)||[]).forEach(i=>{t.push(Gh(i,r,o))})}),t}const gd=Vh(md);function Kh(e){return gd.find(t=>t.id===e)||null}function Zh(e){const t=e==null?void 0:e.unlock;if(!t)return{unlocked:!1,gated:!1,missing:null};if(t.always)return{unlocked:!0,gated:!1,missing:null};let n=!1,r=!0;const o={technologies:[],anyTechnology:[],buildings:[],anyBuilding:[]},i=Array.isArray(t.technologies)?[...t.technologies]:[];if(i.length){n=!0;const c=i.filter(f=>!yn(f));c.length&&(r=!1,o.technologies=[...new Set(c.map(f=>String(f)))])}const a=Array.isArray(t.anyTechnology)?[...t.anyTechnology]:[];a.length&&(n=!0,a.some(f=>yn(f))||(r=!1,o.anyTechnology=[...new Set(a.map(f=>String(f)))]));const d=Array.isArray(t.buildings)?[...t.buildings]:[];if(d.length){n=!0;const c=d.filter(f=>!No(f));c.length&&(r=!1,o.buildings=[...new Set(c.map(f=>String(f)))])}const l=Array.isArray(t.anyBuilding)?[...t.anyBuilding]:[];return l.length&&(n=!0,l.some(f=>No(f))||(r=!1,o.anyBuilding=[...new Set(l.map(f=>String(f)))])),Object.keys(o).forEach(c=>{Array.isArray(o[c])&&!o[c].length&&delete o[c]}),n?{unlocked:r,gated:!0,missing:Object.keys(o).length?o:null}:{unlocked:!1,gated:!1,missing:null}}function Xl(e,t=0){const n=Number(e);return Number.isFinite(n)?n<=0?0:Math.max(0,Math.trunc(n)):t}const Gl=["quantity","amount","count","required","qty","value"];function Yi(e,t){const n=Gr(e);if(typeof n=="number"){if(n<=0)return 0;const r=n*t;return!Number.isFinite(r)||r<=0?0:Math.ceil(r-1e-9)}if(typeof n=="string")return n;if(Array.isArray(n))return n.map(r=>Yi(r,t));if(n&&typeof n=="object"){const r={...n};let o=null;if(Gl.forEach(i=>{o===null&&Number.isFinite(n[i])&&(o=Number(n[i]))}),o!==null){const i=o,a=i*t;let d=0;Number.isFinite(a)&&a>0&&(d=Math.ceil(a-1e-9),d<=0&&i>0&&(d=1)),Gl.forEach(l=>{n[l]!==void 0&&(r[l]=d)})}return r}return n}function Jh(e,t){if(!e)return{};if(Array.isArray(e))return e.map(r=>Yi(r,t));if(typeof e!="object")return Yi(e,t);const n={};return Object.entries(e).forEach(([r,o])=>{n[r]=Yi(o,t)}),n}const Vl=["quantity","amount","count","qty","value"];function Xi(e,t){const n=Gr(e);if(typeof n=="number"){if(n<=0)return 0;const r=n*t;if(!Number.isFinite(r)||r<=0)return 0;const o=Math.round(r);return o<=0?1:o}if(typeof n=="string")return n;if(Array.isArray(n))return n.map(r=>Xi(r,t));if(n&&typeof n=="object"){const r={...n};let o=null;if(Vl.forEach(i=>{o===null&&Number.isFinite(n[i])&&(o=Number(n[i]))}),o!==null){const a=o*t;let d=0;Number.isFinite(a)&&a>0&&(d=Math.round(a),d<=0&&a>0&&(d=1)),Vl.forEach(l=>{n[l]!==void 0&&(r[l]=d)})}return r}return n}function Qh(e,t){if(!e)return{};if(Array.isArray(e))return e.map(r=>Xi(r,t));if(typeof e!="object")return Xi(e,t);const n={};return Object.entries(e).forEach(([r,o])=>{n[r]=Xi(o,t)}),n}function eg(e){const t=[];return((e==null?void 0:e.efficiencyBonuses)||[]).forEach(n=>{if(!n)return;const r=String(n.type||"").toLowerCase();r==="technology"?yn(n.id)&&t.push(n):r==="building"?No(n.id)&&t.push(n):(yn(n.id)||No(n.id))&&t.push(n)}),t}function tg(e,{batchSize:t=null,productionMode:n=null}={}){const r=(e==null?void 0:e.batch)||{defaultSize:1,maxSize:1},o=Math.max(1,Math.floor(r.defaultSize||1)),i=Math.max(o,Math.floor(r.maxSize||o)),a=Number.isFinite(t)?Math.max(1,Math.floor(t)):o,d=eg(e);n!=null&&n.effect&&d.push({type:"production",id:n.id,label:n.label,effect:{...n.effect}});const l=d.reduce((k,T)=>{const A=T.effect||{};return Number.isFinite(A.inputMultiplier)&&(k.inputMultiplier*=A.inputMultiplier),Number.isFinite(A.outputMultiplier)&&(k.outputMultiplier*=A.outputMultiplier),Number.isFinite(A.laborMultiplier)&&(k.laborMultiplier*=A.laborMultiplier),Number.isFinite(A.timeMultiplier)&&(k.timeMultiplier*=A.timeMultiplier),Number.isFinite(A.batchBonus)&&(k.batchBonus+=A.batchBonus),k},{inputMultiplier:1,outputMultiplier:1,laborMultiplier:1,timeMultiplier:1,batchBonus:0});let c=Number.isFinite(a+l.batchBonus)?Math.floor(a+l.batchBonus):a;c<=0&&(c=a),c=Math.max(1,Math.min(i,c));const f=c*l.inputMultiplier,u=c*l.outputMultiplier,p=Number.isFinite(e.baseLaborHours)?e.baseLaborHours:e.laborHours||0,h=Number.isFinite(e.baseTimeHours)?e.baseTimeHours:e.timeHours||p,g=p*c*l.laborMultiplier,b=h*c*l.timeMultiplier,S=Jh(e.baseInputs,f),x=Qh(e.baseOutputs,u);return{instance:{...e,inputs:S,outputs:x,laborHours:g,timeHours:b,batchSize:c,appliedBonuses:d,productionMode:n?{id:n.id,label:n.label,type:n.type,buildingId:n.buildingId||null}:null},batchSize:c,requestedBatchSize:a,appliedBonuses:d}}function Bi(e,t){if(t==null)return null;const n=e?String(e):"";if(typeof t=="number"){const r=Xl(t,0);if(!r)return null;const o=n||"",i=o?[o]:[];return i.length?{label:n||o,options:i,quantity:r}:null}if(typeof t=="string"){const r=String(t);return{label:n||r,options:[r],quantity:1}}if(Array.isArray(t)){const r=t.map(i=>String(i)).filter(Boolean);return r.length?{label:n||r[0],options:r,quantity:1}:null}if(typeof t=="object"){const r=[];Array.isArray(t.options)&&r.push(t.options),Array.isArray(t.anyOf)&&r.push(t.anyOf),Array.isArray(t.choices)&&r.push(t.choices),Array.isArray(t.items)&&r.push(t.items);let o=r.flat().map(d=>String(d)).filter(Boolean);!o.length&&typeof t.name=="string"&&(o=[t.name]),!o.length&&n&&(o=[n]);const i=Xl(t.quantity??t.amount??t.count??t.required??t.qty??t.value,1)||1,a=t.label||n||o[0]||"";return o.length?{label:a,options:o,quantity:i}:null}return null}function ng(e){const t=[],n=e==null?void 0:e.inputs;return n?Array.isArray(n)?(n.forEach(r=>{if(r){if(typeof r=="string"){const o=Bi(r,r);o&&t.push(o)}else if(Array.isArray(r)){const o=Bi("",r);o&&t.push(o)}else if(typeof r=="object"){const o=r.label||r.name||r.id||"",i=Bi(o,r);i&&t.push(i)}}}),t):(typeof n=="object"&&Object.entries(n).forEach(([r,o])=>{const i=Bi(r,o);i&&t.push(i)}),t):t}function rg(e){const t=ng(e),n=[],r=[];return t.forEach(o=>{const{label:i,options:a,quantity:d}=o,l=a.map(h=>{const g=oi(h),b=Number.isFinite(g==null?void 0:g.quantity)?g.quantity:0;return{item:h,available:b}}),c=l.reduce((h,g)=>h+g.available,0);let u=Math.min(d,c);const p=[];l.forEach(h=>{if(u<=0||h.available<=0)return;const g=Math.min(h.available,u);g>0&&(p.push({item:h.item,amount:g}),u-=g)}),c<d&&n.push({name:i,required:d,available:c}),r.push({label:i,quantity:d,options:l.map(h=>h.item),usage:p})}),{requirements:t,missingMaterials:n,materialPlan:r}}function og(e,{availableTools:t=[],batchSize:n=null,productionModeId:r=null}={}){const o=Kh(e);if(!o)return null;const i=Zh(o),{modes:a,selected:d,fallback:l}=Xh(o,r),c=a.some(H=>H.status.available),f=d||l||null,{instance:u,batchSize:p,appliedBonuses:h}=tg(o,{batchSize:n,productionMode:f}),g=!!(i.unlocked&&c),b=Math.max(0,Number.isFinite(u.laborHours)?u.laborHours:u.timeHours||0),S=new Set((t||[]).map(H=>String(H).toLowerCase())),k=(u.toolsRequired||[]).filter(H=>!S.has(String(H).toLowerCase())),{missingMaterials:T,materialPlan:A,requirements:L}=rg(u),R=a.map(H=>({id:H.id,label:H.label,type:H.type,buildingId:H.buildingId,effect:H.effect,priority:H.priority,available:H.status.available,missing:H.status.missing})),z=R.filter(H=>!H.available);return{recipe:u,baseRecipe:o,unlocked:g,unlockStatus:i,hasProductionAccess:c,productionMode:u.productionMode,productionModeAvailable:!!d,productionModes:R,missingProduction:z,hasTools:k.length===0,hasMaterials:T.length===0,missingTools:k,missingMaterials:T,materialPlan:A,materialRequirements:L,laborHours:b,batchSize:p,appliedBonuses:h}}function ig({availableTools:e=[],batchSize:t=null}={}){return gd.map(n=>og(n.id,{availableTools:e,batchSize:t})).filter(n=>n&&n.unlocked)}function Os(){C.craftTargets instanceof Map||(Array.isArray(C.craftTargets)?C.craftTargets=new Map(C.craftTargets):C.craftTargets=new Map)}function po(e){return String(e||"").trim().toLowerCase()}function Gi(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.max(0,Math.trunc(t))}function hr(e,t){if(!e||!t)return 0;const n=po(t);if(!n)return 0;if(typeof e=="string")return po(e)===n?1:0;if(Array.isArray(e))return e.reduce((r,o)=>r+hr(o,n),0);if(e instanceof Map){let r=0;return e.forEach((o,i)=>{po(i)===n?r+=Gi(o)||0:r+=hr(o,n)}),r}if(typeof e=="object"){const r=e.id??e.name??e.item??e.type??e.slug;if(r&&po(r)===n){const o=e.quantity??e.qty??e.count??e.amount??e.number??1,i=Gi(o);return i>0?i:1}return Object.keys(e).reduce((o,i)=>{const a=e[i];return po(i)===n&&typeof a!="object"?o+Gi(a):o+hr(a,n)},0)}return 0}function ag(e){if(Os(),!e)return 0;const t=String(e);return C.craftTargets.get(t)||0}function Kl(e,t){if(!e)return;Os();const n=String(e),r=Gi(t);r?C.craftTargets.set(n,r):C.craftTargets.delete(n),Er()}function sg(){return Os(),Array.from(C.craftTargets.entries()).map(([e,t])=>({id:e,target:t}))}function lg(e){if(!e)return 0;const t=po(e);if(!t)return 0;let n=0;return C.people.forEach(r=>{n+=hr(r==null?void 0:r.equipment,t),n+=hr(r==null?void 0:r.equipped,t),n+=hr(r==null?void 0:r.heldItems,t),n+=hr(r==null?void 0:r.held,t),n+=hr(r==null?void 0:r.holding,t)}),n}const Fa={fauna:{mapKey:"discoveredFauna",collection:"animals",unknownLabel:"Unidentified creature"},flora:{mapKey:"discoveredFlora",collection:"plants",unknownLabel:"Uncatalogued specimen"}};function cg(e,t,n){return`${e}:${t}:${ud(n,{fallback:"entry"})}`}function dg(e){const t=Fa[e];if(!t)return new Map;const n=C[t.mapKey];if(n instanceof Map)return n;const r=new Map;return Array.isArray(n)?n.forEach(o=>{if(!o)return;const[i,a]=o;r.set(i,new Set(a||[]))}):n&&typeof n=="object"&&Object.entries(n).forEach(([o,i])=>{r.set(o,new Set(i||[]))}),C[t.mapKey]=r,r}function ug(e,t){if(!Fa[e])return new Set;const r=dg(e);r.has(t)||r.set(t,new Set);const o=r.get(t);if(o instanceof Set)return o;const i=new Set(Array.isArray(o)?o:[]);return r.set(t,i),i}function bd(e){const t=Fa[e];if(!t)return{sections:[],discovered:0,total:0};const n=Object.entries(Xd).map(([o,i])=>{var f;const a=(i==null?void 0:i[t.collection])||[];if(!a.length)return null;const d=ug(e,o),l=a.map(u=>{const p=cg(e,o,u.name),h=d.has(p);return{id:p,biomeId:o,discovered:h,item:u}}),c=l.filter(u=>u.discovered).length;return{biomeId:o,biomeName:((f=Mr(o))==null?void 0:f.name)||o,entries:l,discoveredCount:c,total:l.length}}).filter(Boolean).sort((o,i)=>o.biomeName.localeCompare(i.biomeName)),r=n.reduce((o,i)=>(o.discovered+=i.discoveredCount,o.total+=i.total,o),{discovered:0,total:0});return{sections:n,discovered:r.discovered,total:r.total}}function fg(){return bd("fauna")}function pg(){return bd("flora")}function yd(e){var t;return((t=Fa[e])==null?void 0:t.unknownLabel)||"Unknown entry"}const wd={water:"Water",open:"Open Land",forest:"Forest",ore:"Ore Deposits",stone:"Stone Outcrop"},mg="🧍",hg="player-marker",gg=4,Vr="survey",bg=[{id:Vr,label:"Surveyor",description:"Scout the surrounding wilderness and chart safe paths for settlers."}],xd=22,pa=.1,vd=.1,zs=[{id:"15m",label:"15 min",minutes:15},{id:"30m",label:"30 min",minutes:30},{id:"60m",label:"60 min",minutes:60},{id:"180m",label:"3 hr",minutes:180},{id:"all-day",label:"All Day",minutes:null}];let tt=null,Vi=null,Zn=null,fn=null,vr=null,Wt=null,Ht=null,Gn=null,Un=null,Dn=null,In=null,bo="all",Pr=null,jr=null,_r=null,pn=null,Yn=null,Sd=()=>{},yo=()=>{},Fi=null,$n=null,Ri=null,Va=null,rn=null,wo=null,qr=null,Wr=null,xo=null,Dt=null,hn=null;const ma=new Map;let Ki=null,Zl=null,yt=null,$r=null,vo=null,Ps=!1,So=null,mo=null,$i=null,ho=null,Hi=null,gr=null,Ii=null,br=null,Rn=null,It=null,mn=null,Ur=null;const yg=new Set(["wood","firewood","food","water"]);function wg(e=""){const t=String(e||"").trim().toLowerCase();if(!t)return"a";if(t.startsWith("hour"))return"an";const n=t[0];return["a","e","i","o","u"].includes(n)?"an":"a"}function xg(e=""){return e&&(/[^aeiou]ies$/i.test(e)?e.replace(/ies$/i,"y"):/(xes|ses|zes|ches|shes)$/i.test(e)?e.replace(/es$/i,""):/s$/i.test(e)&&!/ss$/i.test(e)?e.replace(/s$/i,""):e)}function vg(e=""){const t=String(e||"").trim();if(!t)return"";const n=t.split(/\s+/),r=n.pop(),o=xg(r);return n.push(o),n.join(" ")}function Ka(e,t){const n=Math.max(0,Math.ceil(t||0));if(!n)return null;const r=String(e||"").trim()||"resource";if(n===1){const o=r.toLowerCase();if(yg.has(o))return`1 more ${r}`;const i=vg(r);return`${wg(i)} ${i}`}return`${n} more ${r}`}function bn(e=[]){const t=e.filter(Boolean);if(!t.length)return"";if(t.length===1)return t[0];if(t.length===2)return`${t[0]} and ${t[1]}`;const n=t.slice(0,-1).join(", "),r=t[t.length-1];return`${n}, and ${r}`}function yr(e){const t=Number(e);return Number.isFinite(t)?Math.round(t*10)/10:0}function Sg(e,t){const n=Number(t);if(!Number.isFinite(n)||n<=0)return null;const r=yr(n),o=ci(e),i=o!=null&&o.icon?`${o.icon} ${e}`:e;return`${r} ${i}`}function kg(e={}){const t=[{key:"large",label:"large"},{key:"medium",label:"medium"},{key:"small",label:"small"}],n=[];let r=0;return t.forEach(({key:o,label:i})=>{const a=Number(e==null?void 0:e[o])||0;if(!a)return;r+=a;const d=a===1?"tree":"trees";n.push(`${a} ${i} ${d}`)}),r?`Standing timber includes ${bn(n)}.`:"Only stumps and brush remain; the grove has been cleared."}function Cg(e={}){const t=Array.isArray(e.deposits)?e.deposits.filter(r=>((r==null?void 0:r.quantity)||0)>0):[];if(t.length){const r=t.map(o=>`${o.quantity} ${o.type}`);return`Veins promise ${bn(r)}.`}const n=Number(e.stone)||0;return n>0?`Loose stone remains in workable supply (${yr(n)} blocks).`:"The exposed rock has already been stripped of useful ore."}function Mg(e={}){const t=Object.entries(e).filter(([,o])=>Number(o)>0);if(!t.length)return"";const n=t.map(([o,i])=>Sg(o,i)).filter(Boolean),r=bn(n);return r?`Set aside nearby: ${r}.`:""}function Eg(e,t){const n=String(e).toLowerCase(),r={lead:"",extras:[]};switch(n){case"forest":r.lead="is a patch of forest canopy",r.extras.push(kg(t==null?void 0:t.trees));break;case"ore":r.lead="sits atop an exposed ore seam",r.extras.push(Cg(t));break;case"stone":r.lead="is a bare stone outcrop",Number(t==null?void 0:t.stone)>0&&r.extras.push(`Chiseled rubble amounts to ${yr(t.stone)} blocks.`);break;case"water":case"lake":r.lead="rests beside a still lake with fresh water.";break;case"ocean":r.lead="opens onto a tidal shoreline with crashing surf.";break;case"river":r.lead="is cut by a flowing river ripe for fishing and power.";break;case"marsh":r.lead="is saturated marshland thick with reeds.";break;case"mangrove":r.lead="winds through tangled mangrove roots and tidal pools.";break;default:r.lead="is mostly open ground ready for work";break}return r.extras=r.extras.filter(Boolean),r}function kd(e){var t;return e?(Rn||(Rn=document.createElement("section"),Rn.id="tile-info-panel",Object.assign(Rn.style,{display:"flex",flexDirection:"column",gap:"8px",border:"1px solid var(--map-border, #ccc)",borderRadius:"12px",padding:"16px",background:"var(--bg-color, #fff)",gridColumn:"1 / -1",minWidth:"0"}),It=document.createElement("div"),It.className="tile-info-content",Object.assign(It.style,{display:"flex",flexDirection:"column",gap:"8px"}),Rn.appendChild(It)),Rn.parentElement!==e&&((t=Rn.parentElement)==null||t.removeChild(Rn),e.appendChild(Rn)),Rn):null}function Tg(e){var t;if(!e)return null;if(!mn){mn=document.createElement("section"),mn.id="research-panel",Object.assign(mn.style,{display:"flex",flexDirection:"column",gap:"10px",border:"1px solid var(--map-border, #ccc)",borderRadius:"12px",padding:"16px",background:"var(--bg-color, #fff)",minWidth:"0"});const n=document.createElement("h3");n.textContent="Research & Technologies",n.style.margin="0",mn.appendChild(n);const r=document.createElement("p");r.textContent="Monitor discoveries, required prerequisites, and the benefits unlocked for your settlement.",r.style.margin="0",r.style.fontSize="13px",r.style.opacity="0.85",mn.appendChild(r),Ur=document.createElement("div"),Object.assign(Ur.style,{display:"flex",flexDirection:"column",gap:"10px"}),mn.appendChild(Ur)}return mn.parentElement!==e&&((t=mn.parentElement)==null||t.removeChild(mn),e.appendChild(mn)),mn}function Ag(){if(!Ur)return;Ur.innerHTML="";const e=cu();if(!e.length){const t=document.createElement("p");t.textContent="No technologies have been catalogued yet. Advance your settlement to discover new research.",t.style.margin="0",Ur.appendChild(t);return}e.forEach(t=>{var S,x,k,T,A,L;const{definition:n,state:r,unlocked:o,available:i,missingPrerequisites:a}=t,d=document.createElement("article");Object.assign(d.style,{border:"1px solid var(--map-border, #ccc)",borderRadius:"10px",padding:"12px",background:"var(--menu-bg)",color:"var(--text-color)",display:"flex",flexDirection:"column",gap:"6px"});const l=document.createElement("div");Object.assign(l.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"8px",flexWrap:"wrap"});const c=document.createElement("h4");if(c.textContent=(n==null?void 0:n.name)||pt(t.id),c.style.margin="0",l.appendChild(c),n!=null&&n.category){const R=document.createElement("span");R.textContent=n.category,Object.assign(R.style,{fontSize:"12px",padding:"2px 6px",borderRadius:"999px",background:"rgba(128, 128, 128, 0.15)"}),l.appendChild(R)}let f="Locked",u="rgba(160, 40, 40, 0.85)";o?(f="Researched",u="rgba(36, 115, 72, 0.85)"):i?(f="Available to research",u="rgba(196, 132, 16, 0.85)"):a.length&&(f="Locked — prerequisites missing",u="rgba(160, 40, 40, 0.85)");const p=document.createElement("span");if(p.textContent=f,Object.assign(p.style,{fontSize:"12px",padding:"2px 8px",borderRadius:"999px",color:"#fff",background:u}),l.appendChild(p),d.appendChild(l),n!=null&&n.description){const R=document.createElement("p");R.textContent=n.description,R.style.margin="0",d.appendChild(R)}const h=t.prerequisites.length?t.prerequisites.map(R=>{const z=ea(R);return a.includes(R)?`${z} (missing)`:`${z}`}):["None"];if(d.appendChild(Bt("Prerequisites",h.join(", "))),!o&&a.length&&d.appendChild(Bt("Missing",Lo(a))),n!=null&&n.cost){const R=[];Number.isFinite(n.cost.research)&&n.cost.research>0&&R.push(`${n.cost.research} research points`);const z=Object.entries(n.cost.materials||{}).filter(([,H])=>Number.isFinite(H)&&H>0).map(([H,_])=>`${_} ${Ba(H)||pt(H)}`);z.length&&R.push(`Materials: ${z.join(", ")}`),R.length&&d.appendChild(Bt("Cost",R.join(" • ")))}const g=[],b=((S=n==null?void 0:n.effects)==null?void 0:S.unlocks)||{};if((x=b.technologies)!=null&&x.length&&g.push(`Technologies: ${Lo(b.technologies)}`),(k=b.buildings)!=null&&k.length){const R=b.buildings.map(z=>{var H;return((H=an(z))==null?void 0:H.name)||pt(z)});g.push(`Buildings: ${An(R)}`)}if((T=b.recipes)!=null&&T.length){const R=b.recipes.map(z=>eb(z));g.push(`Recipes: ${An(R)}`)}if((A=b.equipment)!=null&&A.length){const R=b.equipment.map(z=>{var H;return((H=wa(z))==null?void 0:H.label)||pt(z)});g.push(`Equipment: ${An(R)}`)}if((L=n==null?void 0:n.effects)!=null&&L.description&&g.unshift(n.effects.description),g.length&&d.appendChild(Bt("Unlocks",g.join("; "))),r!=null&&r.unlockedAt){const R=new Date(r.unlockedAt),z=Number.isFinite(R.getTime())?R.toLocaleString():r.unlockedAt;d.appendChild(Bt("Unlocked",o?z:"Not yet researched"))}Ur.appendChild(d)})}function Ng(e,t,n){if(!e)return!1;const r=e.tile;return r&&Number.isFinite(r.x)&&Number.isFinite(r.y)?Math.trunc(r.x)===Math.trunc(t)&&Math.trunc(r.y)===Math.trunc(n):!r&&Math.trunc(t)===0&&Math.trunc(n)===0}function Lg(e){var S,x;const t=an(e.typeId),n=document.createElement("details");n.style.borderTop="1px solid rgba(128, 128, 128, 0.25)",n.style.paddingTop="6px";const r=document.createElement("summary");r.style.fontWeight="600";const o=t!=null&&t.icon?`${t.icon} `:"",i=(t==null?void 0:t.name)||e.typeId,a=Number(e.totalLaborHours)||0,d=Math.min(a,Number(e.progressHours)||0),l=a?Math.round(d/a*100):0;r.textContent=`${o}${i} — ${l}% complete`,n.appendChild(r);const c=document.createElement("div");Object.assign(c.style,{display:"flex",flexDirection:"column",gap:"6px",marginTop:"6px"});const f=e.assignedWorkers===1?"builder":"builders",u=document.createElement("p");u.style.margin="0",u.textContent=`Labor recorded: ${yr(d)} / ${yr(a)} worker-hours with ${e.assignedWorkers} ${f} assigned.`,c.appendChild(u);const p=e.requiredResources||{},h=e.consumedResources||{},g=Object.keys(p);if(g.length){const k=document.createElement("p");k.style.margin="0",k.textContent="Materials drawn so far:",c.appendChild(k);const T=document.createElement("ul");T.style.margin="0",T.style.paddingLeft="20px",g.forEach(A=>{const L=Number(p[A])||0,R=Math.min(L,Number(h[A])||0),z=Math.max(0,L-R),H=ci(A),_=H!=null&&H.icon?`${H.icon} `:"",I=document.createElement("li");I.textContent=`${_}${A}: ${yr(R)} / ${yr(L)}${z>0?` (${yr(z)} remaining)`:""}`,T.appendChild(I)}),c.appendChild(T)}else{const k=document.createElement("p");k.style.margin="0",k.textContent="No material stockpiles are required for this project.",c.appendChild(k)}const b=e.siteCategory||((x=(S=t==null?void 0:t.stats)==null?void 0:S.site)==null?void 0:x.primaryCategory);if(b||e.siteSurfaceArea){const k=document.createElement("p");k.style.margin="0";const T=b?js(b):"Site",A=e.siteSurfaceArea?`${ri(e.siteSurfaceArea)} footprint`:"Flexible footprint";k.textContent=`${T}: ${A}.`,c.appendChild(k)}return n.appendChild(c),n}function Cd(e){if(!e)return"";const t=an(e.typeId),n=t!=null&&t.icon?`${t.icon} `:"",r=(t==null?void 0:t.name)||pt(e.typeId);return`${n}${r}`.trim()}function Bg(e){if(!e)return[];const t=new Map;return er().forEach(n=>{if(!n||n.locationId!==e)return;const r=n.tile;if(!r||!Number.isFinite(r.x)||!Number.isFinite(r.y))return;const o=Math.trunc(r.x),i=Math.trunc(r.y),a=`${o}:${i}`;t.has(a)||t.set(a,{x:o,y:i,completed:[],underway:[],planned:[]});const d=t.get(a),l=Cd(n),c=(n.status||"").toLowerCase();c==="completed"?d.completed.push(l):c==="under-construction"?d.underway.push(l):d.planned.push({name:l,status:c})}),[...t.values()].map(n=>{const r=[];if(n.completed.length){const l=n.completed.length>1?"Completed structures":"Completed structure";r.push(`${l}: ${bn(n.completed)}`)}if(n.underway.length){const l=(n.underway.length>1,"Under construction");r.push(`${l}: ${bn(n.underway)}`)}if(n.planned.length){const l=n.planned.map(c=>c.status&&c.status!=="planned"?`${c.name} (${pt(c.status)})`:c.name);r.push(`Planned: ${bn(l)}`)}const o=n.underway.length?n.completed.length?"mixed":"under-construction":n.completed.length?"completed":n.planned.length?"planned":"noted",i=[...n.completed,...n.underway,...n.planned.map(l=>l.name)],a=i[0]||"Development",d=r.join(" • ")||a;return{x:n.x,y:n.y,status:o,structures:i,label:a,details:d,count:i.length}})}function Md(){if(!tt||typeof tt.setDevelopments!="function")return;const e=Jt();if(!e){tt.setDevelopments([]);return}tt.setDevelopments(Bg(e.id))}function Zi(){var g;if(!It){const b=document.getElementById("game");b&&kd(b)}if(!It)return;It.replaceChildren();const e=Jt();if(!e){const b=document.createElement("p");b.textContent="No survey site is currently active.",It.appendChild(b);return}const t=Zt(e.id),n=Math.trunc(t.x||0),r=Math.trunc(t.y||0),o=Mh(e.id,n,r)||{},i=ha(e,n,r)||o.type||"open",a=Eg(i,o),d=document.createElement("p");let l=`The survey tile at (${n}, ${r}) ${a.lead}.`;(g=a.extras)!=null&&g.length&&(l+=` ${a.extras.join(" ")}`),d.textContent=l,It.appendChild(d);const c=Mg(o.stockpiles);if(c){const b=document.createElement("p");b.textContent=c,It.appendChild(b)}const f=Oh(i);if(f.length){const b=[...new Set(f.map(x=>x.encounterName||x.resource).filter(Boolean))];if(b.length){const x=document.createElement("p");x.textContent=`Foragers expect to find ${bn(b)} here.`,It.appendChild(x)}const S=new Set;if(f.forEach(x=>{Array.isArray(x.toolsRequired)&&x.toolsRequired.forEach(k=>S.add(k))}),S.size){const x=document.createElement("p");x.style.margin="0",x.style.fontStyle="italic",x.textContent=`Some finds will require ${bn([...S])}.`,It.appendChild(x)}}else{const b=document.createElement("p");b.textContent="Little of value grows here to gather right now.",It.appendChild(b)}const u=er().filter(b=>b.locationId===e.id&&Ng(b,n,r)),p=u.filter(b=>b.status==="completed"),h=u.filter(b=>b.status==="under-construction");if(!u.length){const b=document.createElement("p");b.textContent="No structures have been recorded on this tile yet.",It.appendChild(b);return}if(p.length){const b=p.map(x=>Cd(x)),S=document.createElement("p");S.textContent=`Completed structures: ${bn(b)}.`,It.appendChild(S)}if(h.length){const b=document.createElement("p");b.textContent="Construction underway:",It.appendChild(b),h.forEach(S=>{It.appendChild(Lg(S))})}}function co(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0":t>=10?`${Math.round(t)}`:`${Math.round(t*10)/10}`}function ri(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0 m²":t>=100?`${Math.round(t)} m²`:`${Math.round(t*10)/10} m²`}function js(e){const t=String(e||"").toLowerCase();switch(t){case"forest":return"Forest understory";case"cleared":return"Cleared ground";default:return t?jd(t):"Site"}}function Fg(e={},t=null){var u,p,h,g;const n=document.createElement("span");if(!e||!((u=e.categories)!=null&&u.length))return n.textContent="Flexible site",n;const r=(t==null?void 0:t.selected)||((p=t==null?void 0:t.categories)==null?void 0:p.find(b=>b.category===e.primaryCategory))||{category:e.primaryCategory,remaining:0},o=js((r==null?void 0:r.category)||e.primaryCategory),i=ri(e.surfaceArea),a=document.createElement("span");let d=`${o} site – needs ${i}`;if(r&&Number.isFinite(r.remaining)){const b=Math.max(0,r.remaining);d+=` (approx. ${ri(b)} open)`}a.textContent=d,n.appendChild(a);const l=[];(h=e.dimensions)!=null&&h.width&&((g=e.dimensions)!=null&&g.depth)&&l.push(`Structure ${co(e.dimensions.width)}×${co(e.dimensions.depth)} m`);const c=e.accessClearance||{},f=[];if(c.front&&f.push(`front ${co(c.front)} m`),c.back&&f.push(`rear ${co(c.back)} m`),c.left&&f.push(`left ${co(c.left)} m`),c.right&&f.push(`right ${co(c.right)} m`),f.length&&l.push(`Access clearance: ${f.join(", ")}`),l.length){n.appendChild(document.createElement("br"));const b=document.createElement("span");b.textContent=l.join(" • "),b.style.display="block",b.style.marginTop="2px",n.appendChild(b)}return n}function Ed(e){e&&(e.style.width="100%",e.style.borderCollapse="collapse",e.style.marginTop="6px",e.style.fontSize="13px",e.querySelectorAll("th").forEach(t=>{t.style.textAlign="left",t.style.padding="6px 8px",t.style.borderBottom="1px solid var(--map-border, #ccc)",t.style.position="sticky",t.style.top="0",t.style.background="var(--menu-bg)",t.style.zIndex="1"}),e.querySelectorAll("td").forEach(t=>{t.style.padding="6px 8px",t.style.borderBottom="1px solid rgba(128, 128, 128, 0.25)",t.style.verticalAlign="top"}))}function Rg(){Sd()}function $g(){yo()}function Jt(){return Bo()[0]||null}function ms(e){return e?wd[e]||e:"Uncharted ground"}function Hg(e=""){const t=String(e||"").trim();return t?/ies$/i.test(t)?t.replace(/ies$/i,"y"):/ers$/i.test(t)?t.replace(/ers$/i,"er"):/s$/i.test(t)&&!/ss$/i.test(t)?t.replace(/s$/i,""):t:"Generalist"}function Td(){const e=[],t=new Set;return bg.forEach(n=>{if(!n)return;const r=n.id||Vr;t.has(r)||(t.add(r),e.push({id:r,label:n.label,description:n.description||""}))}),Tc().filter(Boolean).forEach(n=>{const r=n.id||"";!r||t.has(r)||(t.add(r),e.push({id:r,label:Hg(n.label||r),description:n.description||""}))}),e.length||e.push({id:Vr,label:"Surveyor",description:"Scout the surroundings."}),e}function Ig(e){const t=Td();return t.find(n=>n.id===e)||t[0]||null}function Ad(e){var n;if(!e||typeof e!="object")return Vr;(typeof e.jobId!="string"||!e.jobId)&&(e.jobId=Vr);const t=Td();return t.some(r=>r.id===e.jobId)||(e.jobId=((n=t[0])==null?void 0:n.id)||Vr),e.jobId}function Zt(e=null){return(!C.player||typeof C.player!="object")&&(C.player={locationId:e??null,x:0,y:0,jobId:Vr}),(e&&C.player.locationId!==e||!C.player.locationId&&e)&&(C.player.locationId=e),Number.isFinite(C.player.x)||(C.player.x=0),Number.isFinite(C.player.y)||(C.player.y=0),C.player.x=Math.trunc(C.player.x),C.player.y=Math.trunc(C.player.y),Ad(C.player),C.player}function _s(e,t={}){var g,b,S;const n=e||Jt(),r=n==null?void 0:n.map,o=Number.isFinite(r==null?void 0:r.xStart)?Math.trunc(r.xStart):0,i=Number.isFinite(r==null?void 0:r.yStart)?Math.trunc(r.yStart):0,a=Math.max(1,Math.trunc((r==null?void 0:r.width)||((b=(g=r==null?void 0:r.tiles)==null?void 0:g[0])==null?void 0:b.length)||1)),d=Math.max(1,Math.trunc((r==null?void 0:r.height)||((S=r==null?void 0:r.tiles)==null?void 0:S.length)||1)),l=o,c=i,f=l+a-1,u=c+d-1,p=Number.isFinite(t.x)?Math.trunc(t.x):l,h=Number.isFinite(t.y)?Math.trunc(t.y):c;return{x:Math.min(f,Math.max(l,p)),y:Math.min(u,Math.max(c,h))}}function ha(e,t,n){var l;if(!((l=e==null?void 0:e.map)!=null&&l.types))return null;const r=Number.isFinite(e.map.xStart)?Math.trunc(e.map.xStart):0,o=Number.isFinite(e.map.yStart)?Math.trunc(e.map.yStart):0,i=Math.trunc(t)-r,a=Math.trunc(n)-o;if(a<0||i<0)return null;const d=e.map.types[a];return!d||i>=d.length?null:d[i]}function Dg(){const e=Jt();if(!e)return null;const t=Zt(e.id);return ha(e,t.x,t.y)}function hs(e){var t;if(!e)return null;if(!rn){rn=document.createElement("section"),rn.id="player-panel",Object.assign(rn.style,{display:"flex",flexDirection:"column",gap:"6px",border:"1px solid var(--map-border, #ccc)",borderRadius:"12px",padding:"12px",background:"var(--bg-color, #fff)"});const n=document.createElement("h4");n.textContent="Explorer Position",n.style.margin="0",rn.appendChild(n),qr=document.createElement("p"),qr.style.margin="0",rn.appendChild(qr),Wr=document.createElement("p"),Wr.style.margin="0",rn.appendChild(Wr)}return rn.parentElement!==e&&((t=rn.parentElement)==null||t.removeChild(rn),e.appendChild(rn)),rn}function Jl(){Dt!=null&&Dt.parentElement&&Dt.parentElement.removeChild(Dt),Dt=null,xo=null,hn=null,ma.clear()}function Nd(){var t,n,r;const e=((t=tt==null?void 0:tt.elements)==null?void 0:t.controlDetails)||((n=tt==null?void 0:tt.elements)==null?void 0:n.actionPanel)||((r=tt==null?void 0:tt.elements)==null?void 0:r.controls)||null;if(!e){Dt&&Jl();return}if(Dt&&!Dt.isConnected&&Jl(),!Dt){Dt=document.createElement("div"),Object.assign(Dt.style,{display:"flex",flexDirection:"column",gap:"10px",padding:"12px 14px",borderRadius:"14px",border:"1px solid var(--map-border, rgba(104, 132, 194, 0.75))",background:"var(--map-control-surface, linear-gradient(135deg, rgba(16, 28, 62, 0.95), rgba(12, 22, 46, 0.92)))",boxShadow:"0 10px 24px rgba(0, 0, 0, 0.35)",alignItems:"stretch",width:"100%",boxSizing:"border-box"});const o=document.createElement("h5");o.textContent="Time lapse",o.style.margin="0",o.style.fontSize="0.95rem",o.style.fontWeight="600",o.style.letterSpacing="0.08em",o.style.textTransform="uppercase",o.style.color="var(--map-control-text, #f4f7ff)",Dt.appendChild(o),xo=document.createElement("div"),Object.assign(xo.style,{display:"flex",flexDirection:"column",gap:"8px"}),Dt.appendChild(xo),ma.clear(),zs.forEach(i=>{const a=document.createElement("button");a.type="button",a.textContent=i.label,a.dataset.timeOptionId=i.id,Object.assign(a.style,{borderRadius:"12px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.8))",padding:"10px 14px",background:"var(--map-select-bg, linear-gradient(135deg, rgba(22, 40, 82, 0.98), rgba(17, 31, 60, 0.95)))",color:"var(--map-select-text, #f5f8ff)",cursor:"pointer",boxShadow:"0 6px 16px rgba(0, 0, 0, 0.35)",fontSize:"0.95rem",fontWeight:"600",letterSpacing:"0.04em",textTransform:"uppercase",width:"100%"}),a.addEventListener("click",()=>{Pg(i.id)}),xo.appendChild(a),ma.set(i.id,a)}),hn=document.createElement("button"),hn.type="button",hn.textContent="Sleep",Object.assign(hn.style,{borderRadius:"12px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.8))",padding:"10px 14px",background:"var(--map-select-bg, linear-gradient(135deg, rgba(22, 40, 82, 0.98), rgba(17, 31, 60, 0.95)))",color:"var(--map-select-text, #f5f8ff)",cursor:"pointer",fontWeight:"600",letterSpacing:"0.04em",textTransform:"uppercase",boxShadow:"0 6px 16px rgba(0, 0, 0, 0.35)",fontSize:"0.95rem",alignSelf:"stretch",width:"100%"}),hn.addEventListener("click",jg),Dt.appendChild(hn)}Dt.parentElement!==e&&e.appendChild(Dt)}function Og(){const e=ka();return{options:e.assignments.map(n=>({id:n.id,label:n.label,assigned:n.assigned,capacity:Math.max(0,e.adults-(e.assigned-n.assigned)),description:n.description,workdayHours:n.workdayHours})),laborers:e.laborer}}function qs(){if(!tt||typeof tt.setJobOptions!="function")return;const{options:e,laborers:t}=Og(),n=typeof tt.getSelectedJob=="function"?tt.getSelectedJob():null;tt.setJobOptions(e,{selectedId:n,laborers:t})}function zg(e){e&&(Ki=e)}function ga(){if(!tt||typeof tt.setMarkers!="function")return;const e=Jt();if(!e){tt.setMarkers([]);return}const t=Zt(e.id),n=_s(e,t);t.x=n.x,t.y=n.y,t.locationId!==e.id&&(t.locationId=e.id),tt.setMarkers([{id:hg,x:t.x,y:t.y,icon:mg,className:"map-marker--player",label:"Explorer position",emphasis:!1}])}function Ji(){if(wo&&hs(wo),Nd(),qs(),!rn)return;const e=Jt(),t=e?Zt(e.id):Zt(),n=sn();if(!e){qr&&(qr.textContent="No active expedition."),Wr&&(Wr.textContent=""),Ql(n,{hasLocation:!1});return}const r=_s(e,t);t.x=r.x,t.y=r.y,qr&&(qr.textContent=`Position: (${t.x}, ${t.y})`);const o=Dg(),i=ms(o);Wr&&(Wr.textContent=`Terrain: ${i} — ${n.season}, ${n.weather}`),Ad(t),Ql(n,{hasLocation:!0})}function Ql(e,{hasLocation:t=!0}={}){if(Nd(),!xo)return;const n=Number.isFinite(e==null?void 0:e.hour)?Number(e.hour):0,r=Math.max(0,n*60),o=xd*60,i=Math.max(0,o-r),a=Math.round(vd*100),d=n>=20;if(zs.forEach(l=>{const c=ma.get(l.id);if(!c)return;const f=l.minutes??i,u=l.minutes!=null?l.minutes*(1-pa):i*(1-pa),p=t&&i>=u&&f>.5;if(c.disabled=!p,p)if(l.id==="all-day"){const h=(r+f)/60;c.title=`Work until around ${tr(h)} with ±${a}% variance.`}else c.title=`Advance roughly ${ba(f/60)} (±${a}%).`;else t?c.title="Not enough daylight remains.":c.title="Time lapse unavailable without an active expedition."}),hn){const l=t&&(d||i<=0);hn.disabled=!l,t?l?hn.title="Turn in for the night and wake at dawn.":hn.title="Night has not yet fallen.":hn.title="Sleep is unavailable without an active expedition."}}function Pg(e){const t=zs.find(L=>L.id===e);if(!t)return;const n=Jt();if(!n){Nn("An active expedition is required before committing time.");return}const r=Zt(n.id),o=Ig(r.jobId),i=sn(),a=Number.isFinite(i==null?void 0:i.hour)?Number(i.hour):0,d=Math.max(0,a*60),l=xd*60,c=Math.max(0,l-d),f=t.minutes??c;if(f<=0){Nn("No daylight remains to act upon.");return}const u=t.minutes!=null?t.minutes*(1-pa):c*(1-pa);if(c<u){Nn("Not enough daylight remains for that plan.");return}const p=1+(Math.random()*2-1)*vd,h=Math.max(1,f*p),g=i.hour;Rc(h/60);const b=sn();Er();const S=ba(h/60),x=ba(f/60),k=tr(g),T=tr(b.hour),A=o!=null&&o.label?`${o.label.toLowerCase()} duties`:"daily tasks";Nn(`Worked on ${A} from ${k} for about ${S} (planned ${x}). Wrapped near ${T}.`),di()}function jg(){if(!Jt()){Nn("An active expedition is required before settling in to sleep.");return}const t=sn(),n=Number.isFinite(t==null?void 0:t.hour)?Number(t.hour):0;if(n<20){Nn("It is too early to sleep; daylight remains to be spent.");return}const r=tr(n);Fc(),$c(),Er();const o=sn(),i=tr(o.hour);Nn(`The settlement rests from ${r} and greets the dawn at ${i}.`),di()}function ei(e={}){if(!tt||typeof tt.setFocus!="function")return;const t=Jt(),n=t?Zt(t.id):Zt();tt.setFocus({x:n.x,y:n.y},e)}function _g({dx:e=0,dy:t=0,recenter:n=!1}={}){const r=Jt();if(!r)return;const o=Zt(r.id);if(n){ei();return}if(!e&&!t)return;const i=_s(r,{x:o.x+e,y:o.y+t});if(i.x===o.x&&i.y===o.y){Nn("The survey does not extend further in that direction."),ei();return}const a=ha(r,o.x,o.y)||"open",d=ha(r,i.x,i.y)||a,l=Math.hypot(i.x-o.x,i.y-o.y)*To,c=kc("swimming"),f=Bh({fromTerrain:a,toTerrain:d,distance:l,swimmingLevel:c});if(f.blocked){const S=f.reason||ql(d);Nn(`Unable to cross the ${ms(d).toLowerCase()}. ${S}`);return}o.x=i.x,o.y=i.y,o.locationId=r.id;const u=Math.max(f.hours,.02),p=Xg(l),h=ba(u),g=ms(d),b=f.reason||ql(d);Rc(u),ei(),ga(),Er(),di(),Nn(`Traveled ${p} into the ${g.toLowerCase()} in ${h}. ${b}`.trim())}function Ld(){if(Ht||(Ht=document.createElement("div"),Ht.id="time-banner",Ht.setAttribute("role","status"),Ht.setAttribute("aria-live","polite")),!Ht.parentElement){const e=document.getElementById("content");if(e){const t=document.getElementById("game");t&&e.contains(t)?e.insertBefore(Ht,t):e.appendChild(Ht)}}return Gn||(Gn=document.createElement("div"),Gn.className="time-chip-group"),Gn.parentElement!==Ht&&(Gn.parentElement&&Gn.parentElement.removeChild(Gn),Ht.insertBefore(Gn,Ht.firstChild)),Un||(Un=document.createElement("div"),Un.className="time-actions"),Un.parentElement!==Ht&&(Un.parentElement&&Un.parentElement.removeChild(Un),Ht.appendChild(Un)),ph(Un),Ht}function Bd(){if(!fn){fn=document.createElement("section"),fn.id="event-log-panel",fn.setAttribute("aria-live","polite"),Object.assign(fn.style,{display:"flex",flexDirection:"column",gap:"8px",padding:"12px 16px",background:"var(--menu-bg)",border:"1px solid var(--map-border)",borderRadius:"12px",gridColumn:"1 / -1",minWidth:"0"});const t=document.createElement("div");Object.assign(t.style,{display:"flex",justifyContent:"flex-end",marginBottom:"8px"}),Wt=document.createElement("button"),Wt.type="button",Wt.textContent="Open Full Log",Object.assign(Wt.style,{borderRadius:"8px",border:"1px solid var(--map-border)",background:"var(--action-button-bg)",color:"var(--action-button-text)",padding:"6px 12px",cursor:"pointer",boxShadow:"var(--action-button-shadow)",alignSelf:"flex-start"}),Wt.disabled=!0,Wt.addEventListener("click",()=>{_d()}),t.appendChild(Wt),fn.appendChild(t),vr=document.createElement("ul"),vr.id="event-log-summary-list",Object.assign(vr.style,{listStyle:"none",padding:"0",margin:"0",display:"flex",flexDirection:"column",gap:"6px"}),fn.appendChild(vr)}const e=document.getElementById("content");if(e){const t=document.getElementById("game");let n=null;Ht&&Ht.parentElement===e?n=Ht:t&&e.contains(t)&&(n=t),n?e.insertBefore(fn,n):(fn.parentElement!==e||e.firstChild!==fn)&&e.insertBefore(fn,e.firstChild)}return fn}function Fo(e,t){const n=document.createElement("div");n.id=e,n.setAttribute("role","dialog"),n.setAttribute("aria-modal","true"),n.setAttribute("aria-labelledby",`${e}-title`),Object.assign(n.style,{position:"fixed",inset:"0",display:"none",alignItems:"center",justifyContent:"center",padding:"24px",background:"rgba(0, 0, 0, 0.65)",zIndex:"2000"});const r=document.createElement("div");r.tabIndex=-1,Object.assign(r.style,{background:"var(--bg-color)",color:"var(--text-color)",borderRadius:"12px",padding:"20px",maxWidth:"min(600px, 92vw)",width:"100%",maxHeight:"min(640px, 90vh)",overflow:"hidden",boxShadow:"0 24px 48px rgba(0, 0, 0, 0.35)"});const o=document.createElement("div");Object.assign(o.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"16px"});const i=document.createElement("h3");i.id=`${e}-title`,i.textContent=t,i.style.margin="0",o.appendChild(i);const a=document.createElement("button");a.type="button",a.textContent="Close",a.style.alignSelf="flex-start",o.appendChild(a),r.appendChild(o);const d=document.createElement("div");Object.assign(d.style,{marginTop:"12px",overflowY:"auto",maxHeight:"calc(90vh - 160px)"}),r.appendChild(d);const l=()=>{n.style.display="none",n.setAttribute("aria-hidden","true"),document.removeEventListener("keydown",f)},c=()=>{n.style.display="flex",n.setAttribute("aria-hidden","false"),document.addEventListener("keydown",f),typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(()=>r.focus()):setTimeout(()=>r.focus(),0)},f=u=>{u.key==="Escape"&&(u.preventDefault(),l())};return a.addEventListener("click",()=>{l()}),n.addEventListener("click",u=>{u.target===n&&l()}),n.appendChild(r),document.body.appendChild(n),{overlay:n,panel:r,content:d,openDialog:c,closeDialog:l}}function Fd(){return So||(So=Fo("jobs-dialog","Assign Jobs"),mo=So.content),So}function gs(){const e=Fd();if(!mo||!e)return;const t=ka();mo.innerHTML="";const n=document.createElement("p");n.textContent=`Adults ready to work: ${t.adults}. Unassigned laborers: ${t.laborer}.`,mo.appendChild(n);const r=document.createElement("p");r.textContent="Assign settlers to focused duties. Laborers without assignments will handle general chores. Hover or long-press a job to view details.",r.style.fontSize="13px",r.style.opacity="0.82",r.style.marginTop="4px",mo.appendChild(r);const o=document.createElement("div");if(Object.assign(o.style,{display:"flex",flexDirection:"column",gap:"6px",marginTop:"12px"}),o.setAttribute("role","list"),mo.appendChild(o),t.assignments.forEach(i=>{const a=Math.max(0,t.adults-(t.assigned-i.assigned)),d=document.createElement("div");d.dataset.jobId=i.id,d.setAttribute("role","listitem"),Object.assign(d.style,{display:"grid",gridTemplateColumns:"1fr auto auto auto",alignItems:"center",gap:"8px",padding:"8px 12px",borderRadius:"10px",border:"1px solid var(--map-border, #ccc)",background:"var(--menu-bg)",color:"var(--text-color)"});const l=[];if(i.description&&l.push(i.description),l.push(`Assigned ${i.assigned} of ${a}`),Array.isArray(i.roster)&&i.roster.length){const s=i.roster.map(F=>F.name).join(", ");l.push(`Assigned settlers: ${s}`)}l.push(`Unassigned laborers: ${t.laborer}`),l.push(`Workday: ${i.workdayHours} hours`);const c=l.join(`
`);d.title=c,d.setAttribute("aria-label",`${i.label}. ${l.join(". ")}`);const f=document.createElement("span");f.textContent=i.label,f.style.fontWeight="600",f.style.whiteSpace="nowrap",f.style.overflow="hidden",f.style.textOverflow="ellipsis",d.appendChild(f);const u=document.createElement("div");Object.assign(u.style,{display:"flex",alignItems:"center",gap:"4px",justifySelf:"center"});const p=document.createElement("span");p.textContent="⏰",p.setAttribute("aria-hidden","true"),u.appendChild(p);const h=document.createElement("span");h.textContent=`${i.workdayHours}h`,h.style.fontVariantNumeric="tabular-nums",h.style.minWidth="38px",h.style.textAlign="center",u.appendChild(h);const g=document.createElement("div");Object.assign(g.style,{display:"flex",flexDirection:"column",gap:"2px"});const b=4,S=16,x=(s,F,Y)=>{const Z=document.createElement("button");return Z.type="button",Z.textContent=s,Z.setAttribute("aria-label",Y),Object.assign(Z.style,{width:"22px",height:"18px",borderRadius:"4px",border:"1px solid var(--map-border, #999)",background:"var(--menu-bg)",cursor:"pointer",lineHeight:"1"}),Z.addEventListener("click",re=>{re.preventDefault();const ke=Math.max(b,Math.min(S,(i.workdayHours||10)+F));Yu(i.id,ke),gs()}),Z},k=x("▼",-1,`Reduce ${i.label} workday`),T=x("▲",1,`Increase ${i.label} workday`);k.disabled=i.workdayHours<=b,T.disabled=i.workdayHours>=S,k.disabled&&(k.style.cursor="not-allowed",k.style.opacity="0.5"),T.disabled&&(T.style.cursor="not-allowed",T.style.opacity="0.5"),g.appendChild(T),g.appendChild(k),u.appendChild(g),d.appendChild(u);const A=document.createElement("span");A.textContent=String(i.assigned||0),A.style.fontVariantNumeric="tabular-nums",A.style.justifySelf="center",d.appendChild(A);const L=document.createElement("div");Object.assign(L.style,{display:"flex",gap:"4px"});const R=(s,F,Y)=>{const Z=document.createElement("button");return Z.type="button",Z.textContent=s,Z.setAttribute("aria-label",Y),Object.assign(Z.style,{width:"28px",height:"28px",borderRadius:"6px",border:"1px solid var(--map-border, #999)",background:"var(--menu-bg)",cursor:"pointer"}),Z.addEventListener("click",re=>{re.preventDefault(),Uu(i.id,i.assigned+F),gs()}),Z},z=R("▼",-1,`Reduce ${i.label} assignments`),H=R("▲",1,`Increase ${i.label} assignments`);z.disabled=i.assigned<=0,H.disabled=i.assigned>=a,z.disabled&&(z.style.cursor="not-allowed",z.style.opacity="0.5"),H.disabled&&(H.style.cursor="not-allowed",H.style.opacity="0.5"),L.appendChild(z),L.appendChild(H),d.appendChild(L);const _=document.createElement("div");_.style.gridColumn="1 / -1",_.style.fontSize="12px",_.style.opacity="0.82",_.style.paddingTop="4px";const I=Array.isArray(i.roster)?i.roster.map(s=>{const F=[s.name];return s.focusSkillName&&F.push(`specialises in ${s.focusSkillName.toLowerCase()}`),Number.isFinite(s.score)&&F.push(`score ${s.score}`),F.join(" • ")}):[];_.textContent=I.length?`Assigned: ${I.join(", ")}`:"Assigned: None — laborers will rotate through as needed.",d.appendChild(_),o.appendChild(d)}),qs(),Ki){const i=Ki;Ki=null;const a=o.querySelector(`[data-job-id="${i}"]`);if(a){const d=a.style.boxShadow;a.style.boxShadow="0 0 0 3px rgba(74, 144, 226, 0.45)",a.scrollIntoView({block:"center",behavior:"smooth"}),clearTimeout(Zl),Zl=setTimeout(()=>{a.style.boxShadow=d||""},1600)}}}function Rd(){return $i||($i=Fo("craft-planner-dialog","Craft Planner"),ho=$i.content),$i}function bs(){const e=Rd();if(!ho||!e)return;const t=Gg(),n=ig({availableTools:t}),r=new Map;n.forEach(l=>{Object.entries(l.recipe.outputs||{}).forEach(([c])=>{r.has(c)||r.set(c,{recipes:new Set}),r.get(c).recipes.add(l.recipe.name||c)})});const o=sg(),i=new Set([...r.keys(),...o.map(l=>l.id)]);if(ho.innerHTML="",!i.size){const l=document.createElement("p");l.textContent="No craftable goods are available yet.",ho.appendChild(l);return}const a=document.createElement("p");a.textContent="Set the desired stock for crafted goods. Equipped or held items are ignored automatically.",a.style.fontSize="13px",a.style.opacity="0.82",ho.appendChild(a);const d=document.createElement("div");Object.assign(d.style,{display:"flex",flexDirection:"column",gap:"12px",marginTop:"12px"}),ho.appendChild(d),Array.from(i).sort((l,c)=>l.localeCompare(c)).forEach(l=>{const c=r.get(l)||{recipes:new Set},f=ag(l),u=oi(l),p=Number(u.quantity)||0,h=lg(l),g=Math.max(0,Math.round((p-h)*10)/10),b=Math.max(0,Math.round(h*10)/10),S=document.createElement("div");Object.assign(S.style,{border:"1px solid var(--map-border, #ccc)",borderRadius:"12px",padding:"12px",background:"var(--menu-bg)",color:"var(--text-color)",display:"flex",flexDirection:"column",gap:"8px"});const x=document.createElement("div");Object.assign(x.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"12px",flexWrap:"wrap"});const k=document.createElement("h4");k.textContent=l.charAt(0).toUpperCase()+l.slice(1),k.style.margin="0",x.appendChild(k);const T=document.createElement("div");Object.assign(T.style,{display:"flex",alignItems:"center",gap:"8px"});const A=document.createElement("span");A.textContent="Target",A.style.fontWeight="600",T.appendChild(A);const L=document.createElement("input");L.type="number",L.min="0",L.step="1",L.value=String(f||0),L.style.width="80px",L.setAttribute("aria-label",`Desired stock for ${l}`),L.addEventListener("change",()=>{const H=Number.parseInt(L.value,10);Kl(l,Number.isFinite(H)?H:0),bs()}),T.appendChild(L);const R=document.createElement("button");R.type="button",R.textContent="Clear",R.addEventListener("click",()=>{Kl(l,0),bs()}),T.appendChild(R),x.appendChild(T),S.appendChild(x);const z=document.createElement("span");if(z.style.fontSize="13px",z.style.opacity="0.85",z.textContent=`Usable on hand: ${g} (Reserved: ${b}).`,S.appendChild(z),c.recipes.size){const H=document.createElement("span");H.style.fontSize="12px",H.style.opacity="0.75",H.textContent=`Produced by: ${Array.from(c.recipes).join(", ")}.`,S.appendChild(H)}d.appendChild(S)})}function qg(){return Fi||(Fi=Fo("profile-dialog","Settlement Profile"),$n=Fi.content),Fi}function Wg(){if(!Ri){Ri=Fo("log-dialog","Event Log"),Va=Ri.content;const e=document.createElement("p");e.textContent="A chronological account of notable happenings within your settlement.",Va.appendChild(e),Zn=document.createElement("ul"),Zn.style.listStyle="none",Zn.style.padding="0",Zn.style.margin="0",Va.appendChild(Zn)}return Ri}function $d(){if(!Hi&&(Hi=Fo("herbarium-dialog","Herbarium"),gr=Hi.content,gr)){const e=document.createElement("p");e.textContent="Catalogue of flora identified throughout your travels. Forage to reveal new entries.",e.style.marginBottom="8px",gr.appendChild(e)}return Hi}function Ug(){const e=$d();if(!gr||!e)return;gr.innerHTML="";const t=pg();if(!t.total){const r=document.createElement("p");r.textContent="No flora specimens have been catalogued yet. Forage successfully to add discoveries to your herbarium.",gr.appendChild(r);return}const n=document.createElement("p");n.textContent=`Specimens catalogued: ${t.discovered} of ${t.total}.`,n.style.marginBottom="6px",gr.appendChild(n),t.sections.forEach(r=>{const o=document.createElement("section");o.style.marginTop="12px";const i=document.createElement("h4");i.textContent=`${r.biomeName} (${r.discoveredCount}/${r.total})`,i.style.margin="0 0 4px 0",o.appendChild(i);const a=document.createElement("table"),d=document.createElement("thead"),l=document.createElement("tr");["Specimen","Edible Parts","Caution","Uses"].forEach(f=>{const u=document.createElement("th");u.textContent=f,l.appendChild(u)}),d.appendChild(l),a.appendChild(d);const c=document.createElement("tbody");r.entries.forEach(f=>{const u=document.createElement("tr");f.discovered||(u.style.opacity="0.65");const p=document.createElement("td");f.discovered?(p.textContent=f.item.name,p.style.fontWeight="600"):(p.textContent=yd("flora"),p.style.fontStyle="italic"),u.appendChild(p);const h=document.createElement("td");h.textContent=f.discovered?f.item.edibleParts||"None noted":"Unknown",u.appendChild(h);const g=document.createElement("td");g.textContent=f.discovered?f.item.poisonousParts||"None noted":"Unknown",u.appendChild(g);const b=document.createElement("td");b.textContent=f.discovered?f.item.usefulParts||"No recorded uses":"Unknown",u.appendChild(b),c.appendChild(u)}),a.appendChild(c),Ed(a),o.appendChild(a),gr.appendChild(o)})}function Hd(){if(!Ii&&(Ii=Fo("bestiary-dialog","Bestiary"),br=Ii.content,br)){const e=document.createElement("p");e.textContent="Records of wildlife encountered in each biome. Successful hunts reveal new creatures.",e.style.marginBottom="8px",br.appendChild(e)}return Ii}function Yg(){const e=Hd();if(!br||!e)return;br.innerHTML="";const t=fg();if(!t.total){const r=document.createElement("p");r.textContent="No wildlife has been documented yet. Complete hunting expeditions to populate the bestiary.",br.appendChild(r);return}const n=document.createElement("p");n.textContent=`Creatures documented: ${t.discovered} of ${t.total}.`,n.style.marginBottom="6px",br.appendChild(n),t.sections.forEach(r=>{const o=document.createElement("section");o.style.marginTop="12px";const i=document.createElement("h4");i.textContent=`${r.biomeName} (${r.discoveredCount}/${r.total})`,i.style.margin="0 0 4px 0",o.appendChild(i);const a=document.createElement("table"),d=document.createElement("thead"),l=document.createElement("tr");["Creature","Difficulty","Aggression","Diet","Recommended Tools","Notes"].forEach(f=>{const u=document.createElement("th");u.textContent=f,l.appendChild(u)}),d.appendChild(l),a.appendChild(d);const c=document.createElement("tbody");r.entries.forEach(f=>{const u=document.createElement("tr");f.discovered||(u.style.opacity="0.65");const p=document.createElement("td");f.discovered?(p.textContent=f.item.name,p.style.fontWeight="600"):(p.textContent=yd("fauna"),p.style.fontStyle="italic"),u.appendChild(p);const h=document.createElement("td");h.textContent=f.discovered?f.item.difficulty:"Unknown",u.appendChild(h);const g=document.createElement("td");g.textContent=f.discovered?f.item.aggressive?"Yes":"No":"Unknown",u.appendChild(g);const b=document.createElement("td");b.textContent=f.discovered?f.item.diet:"Unknown",u.appendChild(b);const S=document.createElement("td");S.textContent=f.discovered?f.item.tools&&f.item.tools.length?f.item.tools.join(", "):"None":"Unknown",u.appendChild(S);const x=document.createElement("td");x.textContent=f.discovered?f.item.notes||"No notes recorded.":"Unknown",u.appendChild(x),c.appendChild(u)}),a.appendChild(c),Ed(a),o.appendChild(a),br.appendChild(o)})}function Ws(){var n,r;const e=Jt();if(!e||!tt)return;const t=Zt(e.id);tt.setMap(e.map,{biomeId:e.biome,seed:(n=e.map)==null?void 0:n.seed,season:(r=e.map)==null?void 0:r.season,focus:{x:t.x,y:t.y}}),ei({recenter:!0}),ga(),Md()}function tr(e=0,t={}){const{separator:n=":"}=t,o=((Number.isFinite(e)?Number(e):0)%24+24)%24;let i=Math.floor(o),a=Math.round((o-i)*60);a>=60&&(a-=60,i=(i+1)%24);const d=ec(i),l=ec(a);return n?`${d}${n}${l}`:`${d}${l}`}function ba(e=0){const t=Number.isFinite(e)?Math.max(0,e):0,n=Math.round(t*60);if(n<=0)return"<1m";const r=Math.floor(n/60),o=n%60;return r&&o?`${r}h ${o}m`:r?`${r}h`:`${o}m`}function Xg(e=To){const t=Number.isFinite(e)?Math.max(0,e):To;return t>=1e3?`${Math.round(t/1e3*10)/10} km`:`${Math.round(t)} m`}function ec(e,t=2){const n=Number.isFinite(e)?Math.trunc(e):0,r=n<0?0:n;return String(r).padStart(t,"0")}function Gg(){return dc().filter(e=>Number.isFinite(e.quantity)&&e.quantity>0).map(e=>e.id)}function Id(){return Array.isArray(C.eventLog)||(C.eventLog=[]),C.eventLog}function Dd(e={}){const t=Number.isFinite(e.day)?Math.max(1,Math.floor(e.day)):1,n=Ns(e.month??1),r=Number.isFinite(e.year)?Math.floor(e.year):0,o=[e.season,e.weather].filter(Boolean),i=o.length?` (${o.join(" • ")})`:"",a=tr(e.hour);return{dayNumber:t,monthName:n,yearNumber:r,descriptor:i,timeText:a}}function Nn(e){const t=sn(),n=Id();n.unshift({id:`${Date.now()}-${Math.random()}`,message:e,day:t.day,month:t.month,year:t.year,hour:t.hour,season:t.season,weather:t.weather}),n.length>30&&(n.length=30),Us()}function Vg(e){if(Bd(),!!vr){if(vr.innerHTML="",!e.length){const t=document.createElement("li");t.textContent="No recent events yet. Venture out to gather supplies or assign work orders.",t.style.fontStyle="italic",vr.appendChild(t),Wt&&(Wt.disabled=!0,Wt.style.opacity="0.6",Wt.style.cursor="default");return}Wt&&(Wt.disabled=!1,Wt.style.opacity="1",Wt.style.cursor="pointer"),e.slice(0,gg).forEach(t=>{var d,l;const n=Dd(t),r=document.createElement("li");Object.assign(r.style,{display:"flex",flexDirection:"column",gap:"2px"});const o=document.createElement("div");Object.assign(o.style,{display:"flex",alignItems:"center",gap:"8px"});const i=document.createElement("span");Object.assign(i.style,{fontFamily:'"Fira Mono", "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',fontSize:"12px",padding:"2px 6px",borderRadius:"6px",color:"inherit"}),(l=(d=document.body)==null?void 0:d.classList)!=null&&l.contains("dark")?(i.style.background="rgba(255, 255, 255, 0.12)",i.style.border="1px solid rgba(255, 255, 255, 0.18)"):(i.style.background="rgba(0, 0, 0, 0.06)",i.style.border="1px solid rgba(0, 0, 0, 0.08)"),i.textContent=n.timeText,o.appendChild(i);const a=document.createElement("span");a.textContent=t.message,a.style.fontWeight="600",o.appendChild(a),r.appendChild(o),vr.appendChild(r)})}}function Kg(e){if(Zn){if(Zn.innerHTML="",!e.length){const t=document.createElement("li");t.textContent="No recent events yet.",Zn.appendChild(t);return}e.forEach(t=>{const n=Dd(t),r=document.createElement("li");r.textContent=`${n.timeText} – ${t.message}`,Zn.appendChild(r)})}}function Us(){const e=Id();Vg(e),Kg(e)}function Za(e,t,n){!Number.isFinite(n)||n===0||(e[t]||(e[t]={supply:0,demand:0}),n>0?e[t].supply+=n:e[t].demand+=Math.abs(n))}function Zg(){var i;const e={},t=er({statuses:["completed"]}),n=ka(),r=new Map;(i=n==null?void 0:n.assignments)==null||i.forEach(a=>{r.set(a.id,a.assigned||0)});const o=new Map;return t.forEach(a=>{var c;const d=an(a.typeId),l=(c=d==null?void 0:d.effects)==null?void 0:c.jobs;l&&Object.entries(l).forEach(([f,u])=>{const p=Number(u)||0;p>0&&o.set(f,(o.get(f)||0)+p)})}),t.forEach(a=>{const d=an(a.typeId);if(!d)return;const l=d.effects||{};let c=1;const f=l.jobs;if(f&&Object.keys(f).length){let u=1;Object.entries(f).forEach(([p])=>{const h=o.get(p)||0,g=r.get(p)||0,b=h>0?Math.min(1,g/h):0;u=Math.min(u,b)}),c=u}Object.entries(l.supply||{}).forEach(([u,p])=>{Za(e,u,(p||0)*c)}),Object.entries(l.demand||{}).forEach(([u,p])=>{if(!Number.isFinite(p)||p===0)return;const h=p*c;h>0?Za(e,u,-h):Za(e,u,Math.abs(h))})}),e}function Od(){const e=Hf(Th()),t=Zg();Object.entries(t).forEach(([r,o])=>{e[r]||(e[r]={supply:0,demand:0}),e[r].supply+=o.supply||0,e[r].demand+=o.demand||0});const n=new Set(Array.from(C.inventory.keys()));Object.keys(e).forEach(r=>n.add(r)),n.forEach(r=>{const o=e[r]||{supply:0,demand:0},i=Math.round((o.supply||0)*10)/10,a=Math.round((o.demand||0)*10)/10;ou(r,{supply:i,demand:a})})}function tc(e=0,t=""){const n=Math.round((e||0)*10)/10;return n?`${t}${Math.abs(n)}`:"0"}function zd(){if(Xs(),!vo)return;vo.innerHTML="";const e=dc().sort((t,n)=>{if(t.isEquipment!==n.isEquipment)return t.isEquipment?-1:1;const r=(t.label||t.id||"").toLowerCase(),o=(n.label||n.id||"").toLowerCase();return r.localeCompare(o)});if(!e.length){const t=document.createElement("tr");t.innerHTML='<td colspan="5">No supplies on hand.</td>',vo.appendChild(t);return}e.forEach(t=>{const n=document.createElement("tr"),r=document.createElement("td");r.style.display="flex",r.style.alignItems="center",r.style.gap="6px";const o=ci(t.id);if(o){const f=document.createElement("span");f.textContent=o.icon,f.title=o.label,f.setAttribute("role","img"),f.setAttribute("aria-label",o.label),r.appendChild(f)}const i=document.createElement("span");i.textContent=t.label||Ba(t.id)||t.id,r.appendChild(i);const a=document.createElement("td");a.textContent=t.tierLabel||t.qualityLabel||"—";const d=document.createElement("td");d.textContent=Math.round((t.quantity||0)*10)/10,d.style.textAlign="right";const l=document.createElement("td");l.textContent=tc(t.supply,"+"),l.style.textAlign="right";const c=document.createElement("td");c.textContent=tc(t.demand,"-"),c.style.textAlign="right",n.appendChild(r),n.appendChild(a),n.appendChild(d),n.appendChild(l),n.appendChild(c),vo.appendChild(n)})}function Ys(){Od(),Ps&&zd()}function Xs(){if(yt)return yt.parentElement||document.body.appendChild(yt),yt;yt=document.createElement("div"),yt.id="inventory-popup",yt.setAttribute("role","dialog"),yt.setAttribute("aria-modal","true"),yt.setAttribute("aria-hidden","true"),yt.setAttribute("aria-labelledby","inventory-popup-title"),Object.assign(yt.style,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",display:"none",alignItems:"center",justifyContent:"center",background:"rgba(0, 0, 0, 0.45)",zIndex:"2100"}),yt.addEventListener("click",l=>{l.target===yt&&nc()}),$r=document.createElement("div"),$r.classList.add("inventory-dialog"),Object.assign($r.style,{background:"var(--menu-bg)",color:"var(--text-color)",borderRadius:"10px",boxShadow:"0 10px 24px rgba(0, 0, 0, 0.35)",padding:"20px",maxWidth:"520px",width:"90vw",maxHeight:"80vh",overflowY:"auto"});const e=document.createElement("div");e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="space-between",e.style.gap="12px";const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.gap="12px";const n=document.createElement("h3");n.id="inventory-popup-title",n.textContent="Inventory Overview",n.style.margin="0",t.appendChild(n),e.appendChild(t);const r=document.createElement("button");r.type="button",r.textContent="Close",r.addEventListener("click",()=>{nc()}),e.appendChild(r),$r.appendChild(e);const o=document.createElement("p");o.textContent="Track on-hand quantities alongside projected supply and demand from queued orders.",o.style.marginTop="12px",o.style.marginBottom="12px",$r.appendChild(o);const i=document.createElement("table");i.style.width="100%",i.style.borderCollapse="collapse";const a=document.createElement("tr");a.innerHTML='<th style="text-align:left;">Item</th><th style="text-align:left;">Tier</th><th style="text-align:right;">#</th><th style="text-align:right;">Supply (+)</th><th style="text-align:right;">Demand (-)</th>';const d=document.createElement("thead");return d.appendChild(a),i.appendChild(d),vo=document.createElement("tbody"),i.appendChild(vo),$r.appendChild(i),yt.appendChild($r),document.body.appendChild(yt),yt}function Jg(){Xs(),Od(),zd(),yt.style.display="flex",yt.setAttribute("aria-hidden","false"),Ps=!0}function nc(){yt&&(yt.style.display="none",yt.setAttribute("aria-hidden","true"),Ps=!1)}function Xn(e=0){const t=Math.round(e*10)/10;return t>0?`+${t}`:`${t}`}function An(e=[]){const t=(Array.isArray(e)?e:[e]).filter(n=>n!=null&&`${n}`.trim()!=="");return t.length?t.length===1?`${t[0]}`:t.length===2?`${t[0]} and ${t[1]}`:`${t.slice(0,-1).join(", ")}, and ${t[t.length-1]}`:""}function pt(e=""){return String(e||"").split(/[-_]/).filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function ya(e){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number")return{id:String(e),count:1};if(e&&typeof e=="object"){const t=e.id??e.building??e.type;if(!t&&t!==0)return null;const n=Number.isFinite(e.count)?Math.max(1,e.count):Number.isFinite(e.required)?Math.max(1,e.required):1;return{id:String(t),count:n}}return null}function uo(e){return!e&&e!==0?[]:Array.isArray(e)?e:[e]}function Lo(e=[]){const t=(Array.isArray(e)?e:[e]).filter(n=>n||n===0).map(n=>ea(n));return An(t)}function Qg(e={}){if(!e)return[];const t=[],n=uo(e.technologies||[]).filter(l=>l||l===0);n.length&&t.push(`Research ${Lo(n)}`);const r=uo(e.anyTechnology||[]).filter(l=>l||l===0);r.length&&t.push(`Research one of ${Lo(r)}`);const o=uo(e.research||[]).filter(l=>l||l===0);if(o.length){const l=o.map(c=>pt(c));t.push(`Complete research: ${An(l)}`)}const i=uo(e.anyResearch||[]).filter(l=>l||l===0);if(i.length){const l=i.map(c=>pt(c));t.push(`Complete one of: ${An(l)}`)}const a=uo(e.buildings||[]).map(ya).filter(Boolean).map(l=>{var f;const c=((f=an(l.id))==null?void 0:f.name)||pt(l.id);return l.count>1?`${l.count}× ${c}`:c});a.length&&t.push(`Construct ${An(a)}`);const d=uo(e.anyBuilding||[]).map(ya).filter(Boolean).map(l=>{var f;const c=((f=an(l.id))==null?void 0:f.name)||pt(l.id);return l.count>1?`${l.count}× ${c}`:c});if(d.length&&t.push(`Construct one of: ${An(d)}`),e.resources&&typeof e.resources=="object"){const l=Object.entries(e.resources).filter(([,c])=>Number.isFinite(c)&&c>0).map(([c,f])=>`${f} ${Ba(c)||pt(c)}`);l.length&&t.push(`Stockpile ${An(l)}`)}return t}const Vo=new Map;function eb(e){if(!e&&e!==0)return"";const t=String(e);return Vo.size||md.forEach(n=>{(n.recipes||[]).forEach(r=>{const o=String(r.id);Vo.set(o,r.name||pt(o))})}),Vo.has(t)||Vo.set(t,pt(t)),Vo.get(t)}function Bt(e,t){const n=document.createElement("p"),r=document.createElement("strong");return r.textContent=`${e}: `,n.appendChild(r),t instanceof Node?n.appendChild(t):n.appendChild(document.createTextNode(t)),n}function Hr(e={}){const t=Object.entries(e).filter(([,r])=>r&&r!==0),n=document.createElement("span");return t.length?(t.forEach(([r,o],i)=>{const a=document.createElement("span");a.style.display="inline-flex",a.style.alignItems="center",a.style.gap="4px",a.style.marginRight="8px";const d=Math.round(o*10)/10,l=ci(r);if(l){const c=document.createElement("span");c.textContent=l.icon,c.title=l.label,c.setAttribute("role","img"),c.setAttribute("aria-label",l.label),a.appendChild(c);const f=document.createElement("span");f.textContent=`×${d}`,a.appendChild(f)}else a.textContent=`${d} ${r}`;n.appendChild(a),i===t.length-1&&(a.style.marginRight="0")}),n):(n.textContent="None",n)}function rc(e={}){const t=[];if([["occupancy",r=>`Occupancy ${Xn(r)}`],["comfort",r=>`Comfort ${Xn(r)}`],["survivability",r=>`Survivability ${Xn(r)}`],["appeal",r=>`Appeal ${Xn(r)}`],["safety",r=>`Safety ${Xn(r)}`],["maxWorkers",r=>`Supports ${r} workers`]].forEach(([r,o])=>{e[r]&&t.push(o(e[r]))}),e.jobs){const r=new Map(Tc().map(o=>[o.id,o.label||pt(o.id)]));Object.entries(e.jobs).forEach(([o,i])=>{if(!Number.isFinite(i)||i<=0)return;const a=r.get(o)||pt(o);t.push(`Supports ${i} ${a}`)})}if(e.supply&&Object.entries(e.supply).forEach(([r,o])=>{t.push(`Supply ${r} ${Xn(o)}`)}),e.demand&&Object.entries(e.demand).forEach(([r,o])=>{t.push(`Demand ${r} ${Xn(o)}`)}),e.capacity&&Object.entries(e.capacity).forEach(([r,o])=>{t.push(`Capacity ${r} ${Xn(o)}`)}),e.storage&&Object.entries(e.storage).forEach(([r,o])=>{t.push(`Storage ${r} ${Xn(o)}`)}),e.unlocks){const o=(Array.isArray(e.unlocks)?e.unlocks:[e.unlocks]).map(i=>{if(!i&&i!==0)return null;if(typeof i=="string"||typeof i=="number")return ea(i)||pt(i);if(i&&typeof i=="object"){const a=i.technology??i.tech??i.id;if(a||a===0)return ea(a)||pt(a)}return null}).filter(Boolean);o.length&&t.push(`Unlocks: ${o.join(", ")}`)}return t}function tb(e,t){var c,f,u,p,h;const n=document.createElement("article");n.className="build-card",e!=null&&e.id&&(n.dataset.typeId=e.id),n.style.border="1px solid var(--map-border)",n.style.padding="8px",n.style.borderRadius="6px",n.style.background="var(--card-bg, var(--map-bg))",n.style.color="var(--card-text, var(--text-color))";const r=document.createElement("h4");if(r.textContent=`${e.icon?`${e.icon} `:""}${e.name}`,n.appendChild(r),e.description){const g=document.createElement("p");g.textContent=e.description,n.appendChild(g)}n.appendChild(Bt("Labor",`${e.stats.totalLaborHours} worker-hours`)),n.appendChild(Bt("Minimum Builders",e.stats.minBuilders)),e.stats.site&&n.appendChild(Bt("Site",Fg(e.stats.site,t.siteStatus))),n.appendChild(Bt("Core Structure",Hr(e.stats.coreResources))),n.appendChild(Bt("Full Build",Hr(e.stats.totalResources))),(c=e.requirements)!=null&&c.craftedGoods&&n.appendChild(Bt("Crafted Goods",Hr(e.requirements.craftedGoods)));const o=Qg(e.unlock);o.length&&n.appendChild(Bt("Prerequisites",o.join("; ")));const i=rc(e.effects);if(i.length){const g=document.createElement("p");g.innerHTML="<strong>Effects:</strong>",n.appendChild(g);const b=document.createElement("ul");i.forEach(S=>{const x=document.createElement("li");x.textContent=S,b.appendChild(x)}),n.appendChild(b)}if((f=e.stats.components)!=null&&f.length){const g=document.createElement("details"),b=document.createElement("summary");b.textContent="Construction segments",g.appendChild(b),e.stats.components.forEach(S=>{const x=document.createElement("div");x.style.marginBottom="6px";const k=document.createElement("p"),T=document.createElement("strong");if(T.textContent=S.name,k.appendChild(T),S.isCore){const A=document.createElement("em");A.textContent=" (Core structure)",A.style.marginLeft="4px",k.appendChild(A)}S.description&&k.appendChild(document.createTextNode(` – ${S.description}`)),x.appendChild(k),x.appendChild(Bt("Labor",`${S.laborHours} hrs @ ≥${S.minBuilders} builders`)),x.appendChild(Bt("Resources",Hr(S.resources))),g.appendChild(x)}),n.appendChild(g)}if((u=e.stats.addons)!=null&&u.length){const g=document.createElement("details"),b=document.createElement("summary");b.textContent="Optional upgrades",g.appendChild(b),e.stats.addons.forEach(S=>{const x=document.createElement("div");x.style.marginBottom="6px";const k=document.createElement("p");if(k.innerHTML=`<strong>${S.name}:</strong> ${S.description}`,x.appendChild(k),x.appendChild(Bt("Labor",`${S.laborHours} hrs @ ≥${S.minBuilders} builders`)),S.effects){const T=rc(S.effects);if(T.length){const A=document.createElement("ul");T.forEach(L=>{const R=document.createElement("li");R.textContent=L,A.appendChild(R)}),x.appendChild(A)}}x.appendChild(Bt("Resources",Hr(S.resources))),g.appendChild(x)}),n.appendChild(g)}const a=((p=t.resourceStatus)==null?void 0:p.missing)||[];if(a.length){const g=Object.fromEntries(a.map(x=>[x.name,Math.max(0,(x.required||0)-(x.available||0))])),b=Bt("Core Shortfall",Hr(g));n.appendChild(b);const S=a.map(x=>Ka(x.name,(x.required||0)-(x.available||0))).filter(Boolean);if(S.length){const x=document.createElement("p");x.textContent=`Core structure requires ${bn(S)}.`,n.appendChild(x)}}const d=((h=t.craftedStatus)==null?void 0:h.missing)||[];if(d.length){const g=Object.fromEntries(d.map(x=>[x.name,Math.max(0,(x.required||0)-(x.available||0))])),b=Bt("Later Crafted Needs",Hr(g));n.appendChild(b);const S=d.map(x=>Ka(x.name,(x.required||0)-(x.available||0))).filter(Boolean);if(S.length){const x=document.createElement("p");x.style.fontStyle="italic",x.textContent=`Later phases will also need ${bn(S)}.`,n.appendChild(x)}}const l=document.createElement("button");if(l.textContent=`Build ${e.name}`,l.disabled=!t.hasResources,!t.hasResources){const g=a.map(b=>Ka(b.name,(b.required||0)-(b.available||0))).filter(Boolean);l.title=g.length?`Core structure requires ${bn(g)}.`:"Gather more resources to begin construction."}return l.addEventListener("click",()=>{try{const g=Jt(),b=g?Zt(g.id):Zt(),{order:S}=um(e.id,{workers:e.stats.minBuilders,locationId:g==null?void 0:g.id,x:b==null?void 0:b.x,y:b==null?void 0:b.y});Ah(S),Nn(`Construction started on the ${e.name}.`),Ys(),di()}catch(g){console.warn(g),alert(g.message)}}),n.appendChild(l),n}function Pd(){if(pn)return;pn=document.createElement("div"),pn.id="construction-dashboard",Object.assign(pn.style,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0, 0, 0, 0.5)",display:"none",alignItems:"flex-start",justifyContent:"center",overflowY:"auto",padding:"40px 16px",zIndex:"2000"}),pn.addEventListener("click",l=>{l.target===pn&&yo()}),Yn=document.createElement("div"),Object.assign(Yn.style,{background:"var(--menu-bg)",color:"var(--text-color)",borderRadius:"8px",boxShadow:"0 6px 20px rgba(0, 0, 0, 0.3)",maxWidth:"960px",width:"100%",padding:"24px",boxSizing:"border-box"});const e=document.createElement("div");e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center";const t=document.createElement("h3");t.textContent="Construction Planner",e.appendChild(t);const n=document.createElement("button");n.type="button",n.textContent="Close",n.addEventListener("click",()=>{yo()}),e.appendChild(n),Yn.appendChild(e);const r=document.createElement("p");r.textContent="Plan, upgrade, and review settlement structures. Projects consume materials over time and unlock more sophisticated buildings as the village advances.",Yn.appendChild(r);const o=document.createElement("section");o.id="build-menu",In=document.createElement("div"),In.id="build-category-filters",In.style.display="flex",In.style.flexWrap="wrap",In.style.gap="8px",In.style.margin="12px 0",o.appendChild(In),Dn=document.createElement("div"),Dn.id="build-options",Dn.style.display="grid",Dn.style.gridTemplateColumns="repeat(auto-fit, minmax(260px, 1fr))",Dn.style.gap="12px",o.appendChild(Dn);const i=document.createElement("h4");i.textContent="Active Projects",o.appendChild(i),Pr=document.createElement("div"),Pr.id="build-projects",o.appendChild(Pr);const a=document.createElement("h4");a.textContent="Completed Structures",o.appendChild(a),jr=document.createElement("div"),jr.id="completed-buildings",o.appendChild(jr);const d=document.createElement("h4");d.textContent="Locked or Unavailable",o.appendChild(d),_r=document.createElement("div"),_r.id="locked-buildings",o.appendChild(_r),Yn.appendChild(o),pn.appendChild(Yn),document.body.appendChild(pn),yo=()=>{pn&&(pn.style.display="none")},Sd=()=>{Pd(),Gs(),pn&&(pn.style.display="flex",Yn==null||Yn.scrollTo({top:0}))},yo()}function nb(e){if(!In)return;const t=new Set;e.forEach(r=>{var i;const o=(i=r.type)==null?void 0:i.category;o&&t.add(o)});const n=["All",...Array.from(t).sort((r,o)=>r.localeCompare(o))];n.some(r=>r.toLowerCase()===bo)||(bo="all"),In.innerHTML="",n.forEach(r=>{const o=r.toLowerCase(),i=document.createElement("button");i.type="button",i.textContent=r,i.style.padding="4px 12px",i.style.borderRadius="999px",i.style.border="1px solid var(--map-border)",i.style.background="rgba(0, 0, 0, 0.04)",i.style.color="inherit",i.style.cursor="pointer",i.style.fontWeight="600",o===bo&&(i.disabled=!0,i.style.background="var(--accent-color, #3b82f6)",i.style.color="#fff",i.style.cursor="default"),i.addEventListener("click",()=>{bo=o,Gs()}),In.appendChild(i)})}function Gs(){const e=er({statuses:["under-construction"]});if(!Dn||!Pr||!jr||!_r)return;const t=cm().map(c=>({type:c,info:Xc(c.id)})).filter(c=>c.info);nb(t);const n=typeof bo=="string"?bo:"all",r=c=>{var u;return n==="all"?!0:(((u=c.type)==null?void 0:u.category)||"").toLowerCase()===n};Dn.innerHTML="";const o=t.filter(c=>c.info.unlocked&&c.info.locationOk&&c.info.canBuildMore),i=o.filter(r);if(i.length)i.forEach(c=>{const f=tb(c.type,c.info);Dn.appendChild(f)});else{const c=document.createElement("p");o.length&&n!=="all"?c.textContent="No structures in this category are ready to build yet.":c.textContent="No structures are currently available to build.",Dn.appendChild(c)}if(Pr.innerHTML="",e.length){const c=document.createElement("ul");e.forEach(f=>{const u=an(f.typeId),p=document.createElement("li"),h=f.totalLaborHours?Math.round(f.progressHours/f.totalLaborHours*100):0,g=Math.round(f.progressHours*10)/10,b=Math.round(f.totalLaborHours*10)/10,S=f.tile,x=S&&Number.isFinite(S.x)&&Number.isFinite(S.y)?` @ (${Math.trunc(S.x)}, ${Math.trunc(S.y)})`:"";p.textContent=`${u!=null&&u.icon?`${u.icon} `:""}${(u==null?void 0:u.name)||f.typeId}${x} – ${h}% complete (${g}/${b} worker-hours, ${f.assignedWorkers} builders)`,c.appendChild(p)}),Pr.appendChild(c)}else{const c=document.createElement("p");c.textContent="No projects are currently underway.",Pr.appendChild(c)}jr.innerHTML="";const a=er({statuses:["completed"]});if(a.length){const c=document.createElement("ul");a.forEach(f=>{const u=an(f.typeId),p=document.createElement("li"),h=(u==null?void 0:u.name)||f.typeId,g=f.tile,b=g&&Number.isFinite(g.x)&&Number.isFinite(g.y)?` @ (${Math.trunc(g.x)}, ${Math.trunc(g.y)})`:"";p.textContent=`${u!=null&&u.icon?`${u.icon} `:""}${h}${b}`,c.appendChild(p)}),jr.appendChild(c)}else{const c=document.createElement("p");c.textContent="No completed structures yet.",jr.appendChild(c)}_r.innerHTML="";const d=t.filter(c=>!c.info.unlocked||!c.info.locationOk||!c.info.canBuildMore),l=d.filter(r);if(l.length){const c=document.createElement("ul");l.forEach(({type:f,info:u})=>{var b,S,x,k,T,A,L,R,z,H,_,I;const p=document.createElement("li"),h=`${f.icon?`${f.icon} `:""}${f.name}`,g=[];if(!u.unlocked){const s=(b=u.unlockStatus)==null?void 0:b.missing;if(s){if((S=s.technologies)!=null&&S.length&&g.push(`Research ${Lo(s.technologies)}`),(x=s.anyTechnology)!=null&&x.length&&g.push(`Research one of ${Lo(s.anyTechnology)}`),(k=s.research)!=null&&k.length&&g.push(`Complete research: ${An(s.research.map(F=>pt(F)))}`),(T=s.anyResearch)!=null&&T.length&&g.push(`Complete one of: ${An(s.anyResearch.map(F=>pt(F)))}`),(A=s.buildings)!=null&&A.length&&s.buildings.forEach(F=>{var ye;const Y=ya({id:F.id,count:F.required}),Z=Y?((ye=an(Y.id))==null?void 0:ye.name)||pt(Y.id):pt(F.id),re=Y?Y.count:F.required||1,ke=Number.isFinite(F.current)?F.current:0;g.push(`Construct ${re>1?`${re}× ${Z}`:Z} (${ke}/${re})`)}),(L=s.anyBuilding)!=null&&L.length){const F=s.anyBuilding.map(Y=>{var We;const Z=ya(Y);if(!Z)return null;const re=((We=an(Z.id))==null?void 0:We.name)||pt(Z.id),ke=Z.count,ye=Number.isFinite(Y.current)?Y.current:0;return`${ke>1?`${ke}× ${re}`:re} (${ye}/${ke})`}).filter(Boolean);F.length&&g.push(`Construct one of: ${F.join(" or ")}`)}(R=s.resources)!=null&&R.length&&s.resources.forEach(F=>{const Y=Ba(F.name)||pt(F.name),Z=Number.isFinite(F.required)?F.required:0,re=Number.isFinite(F.available)?F.available:0;g.push(`Stockpile ${Y} (${re}/${Z})`)}),s.custom&&g.push("Fulfil special conditions")}g.length||g.push("Prerequisites not yet met")}if(u.unlocked&&!u.terrainOk){const s=((H=(z=f.requirements)==null?void 0:z.locationTags)==null?void 0:H.join(", "))||"suitable terrain";g.push(`Requires terrain with: ${s}`)}if(u.unlocked&&u.terrainOk&&!u.siteOk){const s=(_=f.stats)==null?void 0:_.site;if(s!=null&&s.surfaceArea){const F=((I=u.siteStatus)==null?void 0:I.selected)||null,Y=F&&Number.isFinite(F.remaining)?Math.max(0,F.remaining):null;let Z=`Needs ${ri(s.surfaceArea)} of ${js((F==null?void 0:F.category)||s.primaryCategory).toLowerCase()} space`;Y!==null&&(Z+=` (only ${ri(Y)} free)`),g.push(Z)}else g.push("Insufficient buildable surface area")}u.unlocked&&!u.canBuildMore&&g.push("Maximum built for now"),p.textContent=`${h} – ${g.join("; ")}`,c.appendChild(p)}),_r.appendChild(c)}else{const c=document.createElement("p");d.length&&n!=="all"?c.textContent="Nothing in this category is ready—check prerequisites or staffing.":c.textContent="All known structures are available.",_r.appendChild(c)}}function jd(e=""){return e.charAt(0).toUpperCase()+e.slice(1)}function rb(){var i;const e=Jt();if(!(e!=null&&e.map))return;const t=sn();if(Vi&&Vi===t.season)return;const n=e.map,r=e.worldSettings||n.worldSettings,o=Cr(e.biome,n.seed,n.xStart,n.yStart,n.tiles[0].length,n.tiles.length,t.season,n.waterLevel,n.viewport,r,!1);e.map={...n,...o},!e.worldSettings&&((i=e.map)!=null&&i.worldSettings)&&(e.worldSettings=e.map.worldSettings),Vi=t.season,Ws()}function ob(){const e=Ld();if(!e)return;const t=Gn||e;t.replaceChildren();const n=sn(),r=Bc(n.season),o=Gf(n.weather),i=Vf(n.hour),a=n.monthName||Ns(n.month),d=Number.isFinite(n.day)?Math.max(1,Math.floor(n.day)):1,l=Number.isFinite(n.year)?Math.floor(n.year):0,c=tr(n.hour,{separator:""}),f=tr(n.hour),u=a||"Unknown Month",p=[c,d,u,l].filter(g=>g!=null&&`${g}`.trim()!=="").join(" ");[{icon:i.icon,text:p,title:`${i.label} at ${f} on ${d} ${u}, Year ${l}`,showText:!0},{icon:r.icon,text:r.name,title:`${r.name} season`,showText:!1},{icon:o.icon,text:o.name,title:`Weather: ${o.name}`,showText:!1}].forEach(g=>{const b=document.createElement("span");b.className="time-chip",g.title&&(b.title=g.title),(g.title||g.text)&&b.setAttribute("aria-label",g.title||g.text);const S=document.createElement("span");if(S.textContent=g.icon,b.appendChild(S),g.showText!==!1&&g.text!==void 0&&g.text!==null&&g.text!==""){const k=document.createElement("span");k.textContent=g.text,b.appendChild(k)}t.appendChild(b)})}function di(){rb(),ob(),Ws(),Ji(),Zi(),Ag(),Gs(),Ys(),Us()}function ib(){So&&So.closeDialog(),Is()}function ab(){$g(),gs(),Fd().openDialog(),Is()}function sb(){bs(),Rd().openDialog()}function lb(){var u,p,h,g,b,S;const e=qg();if(!$n)return;$n.innerHTML="";const t=document.createElement("p");t.textContent="Key facts about your settlement and its surroundings.",$n.appendChild(t);const n=document.createElement("dl");Object.assign(n.style,{display:"grid",gridTemplateColumns:"max-content 1fr",columnGap:"12px",rowGap:"6px",margin:"0"});const r=(x,k)=>{if(k==null||k==="")return;const T=document.createElement("dt");T.textContent=x,T.style.fontWeight="600",T.style.margin="0";const A=document.createElement("dd");A.textContent=k,A.style.margin="0",n.appendChild(T),n.appendChild(A)},o=Bo()[0],i=o!=null&&o.biome?((u=Mr(o.biome))==null?void 0:u.name)||o.biome:"Uncharted Region";if(r("Biome",i),o!=null&&o.map){const x=((h=(p=o.map.tiles)==null?void 0:p[0])==null?void 0:h.length)||0,k=((g=o.map.tiles)==null?void 0:g.length)||0;x&&k&&r("Survey Window",`${x} × ${k} tiles`),o.map.seed&&r("Map Seed",o.map.seed);const T=o.map.xStart??0,A=o.map.yStart??0;r("Survey Origin",`${T}, ${A}`)}const a=sn();r("Season",`${a.season} (Day ${a.day})`),r("Local Time",tr(a.hour)),r("Difficulty",jd(C.difficulty||"normal"));const d=((b=C.people)==null?void 0:b.size)??0;r("Population",`${d} settlers`);const l=er({statuses:["completed"]}).length,c=er({statuses:["under-construction"]}).length;r("Completed Structures",l),r("Projects Underway",c),$n.appendChild(n);const f=ku();if(f.length){const x=document.createElement("h4");x.textContent="Proficiencies",x.style.marginTop="16px",x.style.marginBottom="8px",$n.appendChild(x);const k=document.createElement("ul");k.style.margin="0",k.style.paddingLeft="20px",f.forEach(T=>{const A=document.createElement("li"),L=Math.round((T.level||0)*10)/10;A.textContent=`${T.name}: ${L}/100`,k.appendChild(A)}),$n.appendChild(k)}if((S=o==null?void 0:o.features)!=null&&S.length){const x=document.createElement("h4");x.textContent="Notable Features",x.style.marginBottom="8px",x.style.marginTop="16px",$n.appendChild(x);const k=document.createElement("ul");k.style.margin="0",k.style.paddingLeft="20px",o.features.forEach(T=>{const A=document.createElement("li");A.textContent=T,k.appendChild(A)}),$n.appendChild(k)}else{const x=document.createElement("p");x.textContent="No notable features have been catalogued yet.",x.style.marginTop="16px",$n.appendChild(x)}e.openDialog()}function cb(){Ug(),$d().openDialog()}function db(){Yg(),Hd().openDialog()}function _d(){const e=Wg();Us(),e.openDialog()}function qd(){var r,o,i,a,d;Hc();const e=document.getElementById("game");if(!e)return;document.getElementById("content"),e.innerHTML="",Object.assign(e.style,{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(300px, 1fr))",gap:"16px",alignItems:"flex-start"}),Ld(),Bd();const t=Jt(),n=t?Zt(t.id):Zt();if((r=t==null?void 0:t.map)!=null&&r.tiles){if(t.map.season!==C.time.season){const c=t.worldSettings||((o=t.map)==null?void 0:o.worldSettings),f=Cr(t.biome,t.map.seed,t.map.xStart,t.map.yStart,t.map.tiles[0].length,t.map.tiles.length,C.time.season,t.map.waterLevel,t.map.viewport,c,!1);t.map={...t.map,...f},!t.worldSettings&&((i=t.map)!=null&&i.worldSettings)&&(t.worldSettings=t.map.worldSettings)}const l=document.createElement("section");l.id="map-section",Object.assign(l.style,{display:"flex",flexDirection:"column",gap:"12px",gridColumn:"1 / -1",minWidth:"0"}),e.appendChild(l),tt=Zc(l,{legendLabels:wd,showControls:!0,showLegend:!0,idPrefix:"game-map",navMode:"player",onNavigate:_g,jobSelector:{label:"Role",emptyMessage:"No jobs are available yet.",defaultDescription:"Open the Jobs panel to adjust staffing and work schedules.",onSelect:zg},fetchMap:({xStart:c,yStart:f,width:u,height:p,seed:h,season:g,viewport:b,skipSanityChecks:S})=>{var A,L,R;const x=h??((A=t.map)==null?void 0:A.seed)??Date.now(),k=g??C.time.season,T=t.worldSettings||((L=t.map)==null?void 0:L.worldSettings);return Cr(t.biome,x,c,f,u,p,k,(R=t.map)==null?void 0:R.waterLevel,b,T,!!S)},onMapUpdate:c=>{t.map={...t.map,...c},ga(),Ji(),Zi(),Md()}}),tt.setMap(t.map,{biomeId:t.biome,seed:(a=t.map)==null?void 0:a.seed,season:(d=t.map)==null?void 0:d.season,focus:{x:n.x,y:n.y}}),qs(),wo=l,hs(wo),ga(),Ji(),Zi(),ei({recenter:!0}),Vi=C.time.season,Ws()}else wo=e,hs(wo),Ji(),Zi();kd(e),Tg(e),Pd(),yo(),e.style.display="grid",Xs(),Ys(),di(),tt&&typeof tt.refresh=="function"&&tt.refresh()}function Wd(){document.body.classList.remove("landing-active");const e=document.getElementById("landing-theme");e&&e.parentElement&&e.parentElement.removeChild(e)}function ub(e={}){var g;const t=e.difficulty||"normal",n=Eo[t]||Eo.normal,r=n.start,o=e.world||n.world;C.jobs={gather:0,hunt:0,craft:0,build:0,guard:0},C.technologies=new Map,Jr(),Pu(r.people,{seed:e.seed});const i=Ef(r);if(Object.entries(i).forEach(([b,S])=>Qi(b,S)),C.time.day=1,C.time.month=1,C.time.year=Wf(),C.time.weather="Clear",e.season){C.time.season=e.season;const b=Bc(e.season);(g=b.months)!=null&&g.length&&(C.time.month=b.months[0])}else C.time.season=As(C.time.month);$c(),e.biome?hl("loc1",e.biome,C.time.season,e.seed,o):C.locations.size===0&&hl("loc1","temperate-deciduous",C.time.season,e.seed,o);const a=e.spawn||{},d=Number.isFinite(a.x)?Math.trunc(a.x):0,l=Number.isFinite(a.y)?Math.trunc(a.y):0;C.player={locationId:"loc1",x:d,y:l,jobId:"survey"},hc({id:"basic-tools",name:"Basic Tools"}),Aa(),C.difficulty=t,C.worldSettings=o,C.craftTargets=new Map,C.buildQueue=0,C.haulQueue=0,Nh(),C.eventLog=[];const c=[...C.locations.values()][0],f=Gu(1,(c==null?void 0:c.biome)||"temperate-deciduous");Qi("wood",f),Er();const u=document.getElementById("setup");u&&(u.style.display="none");const p=document.querySelector(".create-steps"),h=document.getElementById("create-step-content");p instanceof HTMLElement&&(p.style.display="none"),h instanceof HTMLElement&&(h.style.display="none"),Wd(),qd()}function oc(){if(mh(ab,ib,()=>{xu(),window.location.reload()},Rg,Jg,lb,_d,sb,cb,db),document.getElementById("content"),hh(),!wu())ah(ub);else{const e=document.getElementById("setup");e&&(e.style.display="none");const t=document.querySelector(".create-steps"),n=document.getElementById("create-step-content");t instanceof HTMLElement&&(t.style.display="none"),n instanceof HTMLElement&&(n.style.display="none"),Wd(),qd()}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",oc):oc();window.Game={store:C,saveGame:Er};
