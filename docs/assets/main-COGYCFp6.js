import{g as wn,a as gf,b as xo,c as bf}from"./biomeWildlife-Cf3ZDbJA.js";const Us={water:"water",ocean:"ocean",lake:"lake",river:"river",stream:"stream",pond:"pond",marsh:"marsh",swamp:"swamp",bog:"bog",fen:"fen",mangrove:"mangrove",estuary:"estuary",delta:"delta",mangrove_forest:"mangrove_forest",kelp_forest:"kelp_forest",coral_reef:"coral_reef",polar_sea:"polar_sea",open_ocean:"open_ocean",abyssal_deep:"abyssal_deep",seamount:"seamount",open:"open",grassland:"grassland",plains:"plains",savanna:"savanna",tundra:"tundra",taiga:"taiga",desert:"desert",sand:"sand",wetland:"wetland",coast:"coast",temperate:"temperate",tropical:"tropical",rainforest:"rainforest",jungle:"jungle",alpine:"alpine",island:"island",mountain:"mountain",volcanic:"volcanic",forest:"forest",ore:"ore",stone:"stone"};function yf(e){const t=new Uint8Array(e);let n="";for(let r=0;r<t.length;r++){const i=t[r].toString(16).padStart(2,"0");n+=i}return n}function wf(e){const t=new DataView(e),n=[];for(let r=0;r<8;r++)n.push(t.getUint32(r*4,!1));return n}async function xf(e){const n=new TextEncoder().encode(e);return crypto.subtle.digest("SHA-256",n)}async function ns(e){const t=(e??"").trim().normalize("NFC"),n=await xf(t),r=yf(n),i=wf(n);return{raw:e,normalized:t,hex:r,lanes:i}}function gd(e,t){let n=e&(1n<<64n)-1n,r=t&(1n<<64n)-1n;n===0n&&r===0n&&(r=1n);const i=(1n<<64n)-1n;function o(){let l=n;const d=r;return n=d,l^=l<<23n&i,r=(l^d^l>>17n^d>>26n)&i,r+d&i}function a(){const l=o();return Number(l>>11n)/2**53}function c(){return gd(n,r)}return{next64:o,nextFloat01:a,clone:c}}const vf=[1831565813,461845907,2246822507,3266489909,668265261,374761393,3550635116,4251993797],Sf=5,Xl=8192,bd=["frigid","cold","cool","mild","warm","hot"],Re={Frigid:0,Cold:1,Cool:2,Mild:3,Warm:4,Hot:5},yd=["arid","semi-arid","moderate","humid","wet"],Xe={Arid:0,SemiArid:1,Moderate:2,Humid:3,Wet:4},Mf=["minimal","seasonal","perennial"],Ss={Minimal:0,Seasonal:1,Perennial:2},fl=["mountain-alpine","mountain-cloudforest","wetland-floodplain","coastal-mangrove","temperate-coastal-rainforest","equatorial-rainforest","tropical-monsoon-forest","tropical-savanna","mediterranean-scrub","temperate-maritime","temperate-broadleaf","boreal-conifer"],le={MountainAlpine:0,MountainCloudforest:1,WetlandFloodplain:2,CoastalMangrove:3,TemperateCoastalRainforest:4,EquatorialRainforest:5,TropicalMonsoonForest:6,TropicalSavanna:7,MediterraneanScrub:8,TemperateMaritime:9,TemperateBroadleaf:10,BorealConifer:11};fl.reduce((e,t,n)=>(e[t]=n,e),{});function wd(e){return fl[e]??"temperate-broadleaf"}const kf=["high elevation alpine conditions","warm, humid highlands","saturated lowlands with persistent runoff","warm wetlands near sea level","cool, very wet regions","hot and perennially wet climates","hot, humid regions with seasonal runoff","warm climates with moderate moisture","mild, dry regions","cool coasts with steady moisture","temperate climates with balanced moisture","cold climates with moderate moisture","fallback climate lookup"],Kl=fl.map(e=>{var n;const t=wn(e);return{woodMod:(t==null?void 0:t.woodMod)??1,openLand:Se((t==null?void 0:t.openLand)??.5),freshwaterPresence:t!=null&&t.freshwater?(t.freshwater.streams+t.freshwater.springs+t.freshwater.lakes+t.freshwater.wetlands)/20:.2,elevationVariance:((n=t==null?void 0:t.elevation)==null?void 0:n.variance)??.2}}),xd=new Float32Array(1),Cf=new Uint32Array(xd.buffer);function Ms(e){return xd[0]=e,Cf[0]>>>0}function Se(e){return!Number.isFinite(e)||e<=0?0:e>=1?1:e}function Zl(e,t){return Number.isFinite(e)?Math.max(1,Math.trunc(e)):t}function ks(e,t){if(!Number.isFinite(e))return 0;const n=Math.max(-t,Math.min(t,e));return Math.fround(n)}function Ef(e){const t=Zl(e.width,128),n=Zl(e.height,128),r=e.params??{},i=ks(r.elevationBias,.45),o=ks(r.temperatureBias,.45),a=ks(r.moistureBias,.45),c=Math.max(16,Math.min(256,Math.floor(t*n/64))),l=Math.trunc(r.spawnSuggestionCount??c),d=Math.max(8,Math.min(t*n,l));return{width:t,height:n,elevationBias:i,temperatureBias:o,moistureBias:a,spawnSuggestionCount:d}}function vd(e){let t=2166136261;return t=pr(t,e.width>>>0),t=pr(t,e.height>>>0),t=pr(t,Ms(e.elevationBias)),t=pr(t,Ms(e.temperatureBias)),t=pr(t,Ms(e.moistureBias)),t=pr(t,e.spawnSuggestionCount>>>0),t>>>0}function Sd(e){return e!=null&&e.lanes&&e.lanes.length>=8?e.lanes.map(t=>t>>>0):vf}function pr(e,t){let n=(e^t)>>>0;return n^=n>>>16,n=Math.imul(n,2146121005)>>>0,n^=n>>>15,n=Math.imul(n,2221713035)>>>0,n^=n>>>16,n>>>0}function Yo(e,t,n,r,i,o){const a=(e[n%e.length]^o)>>>0,c=(e[r%e.length]^o>>>1)>>>0;let l=(a^(c<<7|c>>>25)^i^t)>>>0;return l=Math.imul(l^l>>>13,2246822507)>>>0,l=Math.imul(l^l>>>16,3266489909)>>>0,l>>>0}function Tf(e,t,n){const r=Math.trunc(e),i=Math.trunc(t);let o=Math.imul(r^n,668265261)^Math.imul(i^n>>>1,374761393);return o^=o>>>15,o=Math.imul(o,668265261)>>>0,o^=o>>>13,(o>>>0)/4294967295}function Go(e,t,n){let r=1,i=1,o=0,a=0;for(let c=0;c<Sf;c+=1){const l=e*i*Xl+c*4096,d=t*i*Xl+c*2048,u=Tf(l,d,n^c*2654435761);o+=u*r,a+=r,r*=.5,i*=2}return a>0?o/a:0}function Jl(e,t){return t<=1?0:e/(t-1)}function Af(e,t,n,r){const i=e%n,o=Math.trunc(e/n),a=t[e],c=i>0?t[e-1]:a,l=i+1<n?t[e+1]:a,d=o>0?t[e-n]:a,u=o+1<r?t[e+n]:a,m=Math.abs(a-c)+Math.abs(a-l)+Math.abs(a-d)+Math.abs(a-u);return Se(m*.5)}function Nf(e){const t=Se(e);return t<.18?Re.Frigid:t<.32?Re.Cold:t<.46?Re.Cool:t<.63?Re.Mild:t<.8?Re.Warm:Re.Hot}function Ff(e){const t=Se(e);return t<.18?Xe.Arid:t<.35?Xe.SemiArid:t<.55?Xe.Moderate:t<.75?Xe.Humid:Xe.Wet}function Bf(e){const t=Se(e);return t<.22?Ss.Minimal:t<.55?Ss.Seasonal:Ss.Perennial}function Lf(e,t){const n=Math.max(0,.4-Se(e)),r=Se(t)*.25;return Se(n*1.6+r)}function Rf(e,t,n,r,i){const o=1-Math.abs(e-.58),a=Se(t*.75+r*.25),c=Math.max(0,n-.78)*2,l=Se((o*.6+a*.4)*(1-c));return Se(l*(.8+i.woodMod*.4)*(.6+i.openLand*.4))}function If(e,t,n){return Se(.35+e*.45+n.elevationVariance*.3-t*.2)}function Hf(e,t,n){return Se(e*.6+t*.25+n.freshwaterPresence*.4)}function zf(e,t,n,r){const i=Se(e*.8+r*.2),o=1-Math.abs(t-.55),a=Math.max(0,n-.65)*1.4;return Se((i*.6+o*.4)*(1-a))}function $f(e,t,n,r){const i=Se(.35+e*.5+r.elevationVariance*.25),o=Se(t*.2),a=n*.5;return Se(i+o-a)}function Of(e,t,n,r){const i=e===Re.Frigid?.3:e===Re.Cold?.5:1,o=t===Xe.Arid?.35:t===Xe.SemiArid?.6:1;return Se(n*.8*i*o+r*.2)}function _f(e,t,n,r,i,o,a,c,l,d,u){const m=1-Math.abs(t-.55),h=Se(n*.7+r*.3),p=Se(m*.6+h*.4),w=c*.3+a*.2+l*.15+d*.1+i*.15+o*.1+u*.1,x=Se(Math.abs(e-.45)*.2+r*.1);return Se(w*.7+p*.3-x)}function Pf(e,t){const n=e.length,r=new Array(n);for(let o=0;o<n;o+=1)r[o]=o;r.sort((o,a)=>{const c=e[a]-e[o];return c!==0?c>0?1:-1:o-a});const i=r.slice(0,Math.min(t,n));return Uint32Array.from(i)}function Df(e,t,n,r,i,o){let a=null;function c(p,w,x,C){w&&(!a||x>a.score)&&(a={code:p,score:Se(x),reason:C})}if(c(le.MountainAlpine,e>=.78&&(i===Re.Frigid||i===Re.Cold),e,0),c(le.MountainCloudforest,e>=.62&&o!==Xe.Arid&&(i===Re.Warm||i===Re.Hot),(e+n)*.5,1),c(le.WetlandFloodplain,e<=.35&&r>=.6&&(o===Xe.Humid||o===Xe.Wet),(1-e)*.6+r*.4,2),c(le.CoastalMangrove,e<=.18&&(i===Re.Warm||i===Re.Hot)&&o===Xe.Wet,(1-e)*.5+n*.5,3),c(le.TemperateCoastalRainforest,(i===Re.Cool||i===Re.Mild)&&o===Xe.Wet,n,4),c(le.EquatorialRainforest,i===Re.Hot&&o===Xe.Wet,n,5),c(le.TropicalMonsoonForest,i===Re.Hot&&(o===Xe.Humid||o===Xe.Wet),n*.6+r*.4,6),c(le.TropicalSavanna,(i===Re.Warm||i===Re.Hot)&&(o===Xe.Moderate||o===Xe.SemiArid),t,7),c(le.MediterraneanScrub,(i===Re.Mild||i===Re.Warm)&&(o===Xe.SemiArid||o===Xe.Arid),1-n,8),c(le.TemperateMaritime,(i===Re.Cool||i===Re.Mild)&&o===Xe.Humid,n,9),c(le.TemperateBroadleaf,i===Re.Mild&&o===Xe.Moderate,1-Math.abs(.5-t),10),c(le.BorealConifer,(i===Re.Cold||i===Re.Frigid)&&o!==Xe.Arid,1-t,11),a)return a;const l={frigid:{arid:le.MountainAlpine,"semi-arid":le.MountainAlpine,moderate:le.BorealConifer,humid:le.BorealConifer,wet:le.MountainAlpine},cold:{arid:le.MediterraneanScrub,"semi-arid":le.MediterraneanScrub,moderate:le.BorealConifer,humid:le.TemperateBroadleaf,wet:le.TemperateCoastalRainforest},cool:{arid:le.MediterraneanScrub,"semi-arid":le.TemperateBroadleaf,moderate:le.TemperateBroadleaf,humid:le.TemperateMaritime,wet:le.TemperateCoastalRainforest},mild:{arid:le.MediterraneanScrub,"semi-arid":le.TemperateBroadleaf,moderate:le.TemperateBroadleaf,humid:le.TemperateMaritime,wet:le.WetlandFloodplain},warm:{arid:le.TropicalSavanna,"semi-arid":le.TropicalSavanna,moderate:le.TropicalSavanna,humid:le.TropicalMonsoonForest,wet:le.WetlandFloodplain},hot:{arid:le.TropicalSavanna,"semi-arid":le.TropicalSavanna,moderate:le.TropicalMonsoonForest,humid:le.EquatorialRainforest,wet:le.CoastalMangrove}},d=bd[i],u=yd[o],m=l[d];return{code:(m==null?void 0:m[u])??le.TemperateBroadleaf,score:.35,reason:12}}function jf(e,t){const n=Sd(e),r=vd(t),i=(BigInt(n[0]^r)<<32n|BigInt(n[1]^r>>>1))&(1n<<64n)-1n,o=(BigInt(n[2]^t.width<<1)<<32n|BigInt(n[3]^t.height<<1))&(1n<<64n)-1n;return gd(i,o)}function Ql(e,t){const n=Sd(e),r=jf(e,t),i=Number(r.next64()&0xffffffffn)>>>0,o=pr(vd(t),i^pr(t.width,t.height)),a={elevation:Yo(n,i,0,4,1390208809,o),secondaryElevation:Yo(n,i,1,5,2135587861,o^461845907),temperature:Yo(n,i,2,6,461845907,o^2246822507),moisture:Yo(n,i,3,7,2246822507,o^3266489909)},{width:c,height:l}=t,d=c*l,u=new Float32Array(d),m=new Float32Array(d),h=new Float32Array(d),p=new Float32Array(d),w=new Uint8Array(d),x=new Float32Array(d),C=new Float32Array(d),M=new Float32Array(d),T=new Float32Array(d),A=new Float32Array(d),E=new Float32Array(d),R=new Float32Array(d),L=new Uint8Array(d),W=new Uint8Array(d),D=new Uint8Array(d),V=new Float32Array(d),P=new Uint8Array(d),O=new Float32Array(d);for(let q=0;q<l;q+=1){const ee=Jl(q,l),Me=Math.abs(ee-.5);for(let me=0;me<c;me+=1){const _e=Jl(me,c),je=q*c+me,lt=Math.sqrt((_e-.5)**2+(ee-.5)**2),Ht=Se(1-Math.pow(lt*1.3,1.35)),zt=Go(_e*1.1,ee*1.1,a.elevation),wt=Go(_e*2.4,ee*2.4,a.secondaryElevation),Pe=Se(zt*.65+wt*.35),kt=Se(Pe*.75+Ht*.55-.2+t.elevationBias*.15),cn=Go(_e*1.7+Pe*.15,ee*1.3,a.temperature),vn=Se(1-Me*1.28),Sn=kt*.35,Mn=Se(vn*.72+cn*.28-Sn+.05+t.temperatureBias*.2),dn=Go(_e*2.3,ee*2.1,a.moisture),In=Se((1-kt)*.45),tr=Se((1-Me)*.15),nt=Se(dn*.65+In+tr-.05+t.moistureBias*.2);u[je]=kt,m[je]=Mn,h[je]=nt}}for(let q=0;q<d;q+=1){const ee=Af(q,u,c,l),Me=Se(h[q]*.45+(1-u[q])*.25+ee*.5);p[q]=Me}for(let q=0;q<d;q+=1){const ee=u[q],Me=m[q],me=h[q],_e=p[q],je=Nf(Me),lt=Ff(me),Ht=Bf(_e);L[q]=je,W[q]=lt,D[q]=Ht;const zt=Df(ee,Me,me,_e,je,lt),wt=Kl[zt.code]??Kl[le.TemperateBroadleaf],Pe=Rf(Me,me,ee,_e,wt),kt=If(ee,me,wt),cn=Hf(_e,me,wt),vn=zf(me,Me,ee,Pe),Sn=$f(ee,_e,Pe,wt),Mn=Se(Pe*.85),dn=Of(je,lt,Pe,me);w[q]=zt.code,V[q]=zt.score,P[q]=zt.reason,A[q]=Pe,x[q]=kt,M[q]=cn,T[q]=vn,C[q]=Sn,E[q]=Mn,R[q]=dn,O[q]=_f(ee,Me,me,_e,kt,Sn,cn,vn,Mn,dn,Pe)}const s=Pf(O,t.spawnSuggestionCount),G=new Array(d);for(let q=0;q<d;q+=1){const ee=Object.freeze({temperature:bd[L[q]],moisture:yd[W[q]],runoff:Mf[D[q]],frostRisk:Lf(m[q],p[q])}),Me=Object.freeze({vegetation:A[q],wood:E[q],forage:R[q],ore:x[q],freshWater:M[q],fertility:T[q]}),me=Object.freeze({id:wd(w[q]),score:Se(V[q]),reason:kf[P[q]]??"fallback climate lookup"});G[q]=Object.freeze({index:q,x:q%c,y:Math.trunc(q/c),elevation:u[q],temperature:m[q],moisture:h[q],runoff:p[q],climate:ee,biome:me,resources:Me})}const X=Object.freeze({width:c,height:l,size:d}),re=Object.freeze({elevation:u,temperature:m,moisture:h,runoff:p,biome:w,ore:x,stone:C,water:M,fertility:T});return Object.freeze({seed:e,params:Object.freeze(t),dimensions:X,layers:re,tiles:Object.freeze(G),spawnSuggestions:s})}function Ys(e){const t=Ef(e);if(e.seed){const o=Ql(e.seed,t);return Object.assign(Promise.resolve(o),o)}const n=e.seedString??"",r=ns(n).then(o=>Ql(o,t)),i=r;return r.then(o=>Object.assign(i,o)),i}const io=[{id:"easy",name:"Easy"},{id:"normal",name:"Medium"},{id:"hard",name:"Hard"}],vo={oreDensity:55,waterTable:50,temperature:50,rainfall:50,mountains:50,rivers100:45,lakes100:35,streams100:42,ponds100:30,marshSwamp:28,bogFen:24,mapIslands:50,mapElevationMax:50,mapElevationVariance:50,mapType:"continent",advanced:{elevationBase:50,elevationVariance:50,elevationScale:50,vegetationScale:50,oreNoiseScale:50,oreThresholdOffset:50,waterGuaranteeRadius:50,waterFlowMultiplier:50}};function Rt(e){const t=Number.isFinite(e)?e:0;return t<0?0:t>100?100:Math.round(t)}function Wf(e={}){const t={...vo.advanced,...e};return Object.fromEntries(Object.entries(t).map(([n,r])=>[n,Rt(r)]))}function ni(e={}){const t=typeof e.mapType=="string"&&e.mapType.trim()?e.mapType:vo.mapType,n={...vo,...e,mapType:t,advanced:Wf(e.advanced)};return{...n,oreDensity:Rt(n.oreDensity),waterTable:Rt(n.waterTable),temperature:Rt(n.temperature),rainfall:Rt(n.rainfall),mountains:Rt(n.mountains),rivers100:Rt(n.rivers100),lakes100:Rt(n.lakes100),streams100:Rt(n.streams100),ponds100:Rt(n.ponds100),marshSwamp:Rt(n.marshSwamp),bogFen:Rt(n.bogFen),mapIslands:Rt(n.mapIslands),mapElevationMax:Rt(n.mapElevationMax),mapElevationVariance:Rt(n.mapElevationVariance)}}const ec={easy:{people:9,foodDays:7,firewoodDays:7,tools:{"stone hand axe":1,"stone knife":1,bow:1,"wooden arrow":10,"wooden shovel":1,"wooden hammer":1}},normal:{people:7,foodDays:3,firewoodDays:3,tools:{"stone hand axe":1,"stone knife":1}},hard:{people:5,foodDays:0,firewoodDays:0,tools:{}}},Lt={oreDensity:-8,waterTable:-6,temperature:-5,rainfall:-4,mountains:7,rivers100:-3,lakes100:-2,streams100:-2,ponds100:-1,marshSwamp:-1,bogFen:-1,mapIslands:4,mapElevationMax:5,mapElevationVariance:6,advanced:{elevationVariance:3,elevationScale:2,vegetationScale:-1,oreNoiseScale:2,oreThresholdOffset:-3,waterGuaranteeRadius:-2,waterFlowMultiplier:-2}};function qf(e={}){const t=ni(e);let n=50;const r=(o,a)=>{const c=(o-50)/50;n+=c*a};r(t.oreDensity,Lt.oreDensity),r(t.waterTable,Lt.waterTable),r(t.temperature,Lt.temperature),r(t.rainfall,Lt.rainfall),r(t.mountains,Lt.mountains),r(t.rivers100,Lt.rivers100),r(t.lakes100,Lt.lakes100),r(t.streams100,Lt.streams100),r(t.ponds100,Lt.ponds100),r(t.marshSwamp,Lt.marshSwamp),r(t.bogFen,Lt.bogFen),r(t.mapIslands,Lt.mapIslands),r(t.mapElevationMax,Lt.mapElevationMax),r(t.mapElevationVariance,Lt.mapElevationVariance);const i=Lt.advanced;return Object.entries(i).forEach(([o,a])=>{o in t.advanced&&r(t.advanced[o],a)}),Math.round(Math.min(100,Math.max(1,n)))}function Vo(e,t={}){const n=ec[e]||ec.normal;return{start:{...n,tools:{...n.tools}},world:ni(t)}}const So={easy:Vo("easy",{oreDensity:78,waterTable:70,temperature:65,rainfall:62,mountains:35,rivers100:72,lakes100:68,streams100:60,ponds100:56,marshSwamp:58,bogFen:52,mapIslands:35,mapElevationMax:45,mapElevationVariance:42,advanced:{vegetationScale:62,oreThresholdOffset:68,waterGuaranteeRadius:70,waterFlowMultiplier:45}}),normal:Vo("normal",{oreDensity:55,waterTable:50,temperature:50,rainfall:50,mountains:50,rivers100:45,lakes100:35,streams100:42,ponds100:30,marshSwamp:28,bogFen:24,mapIslands:50,mapElevationMax:50,mapElevationVariance:50}),hard:Vo("hard",{oreDensity:38,waterTable:40,temperature:42,rainfall:38,mountains:68,rivers100:32,lakes100:28,streams100:28,ponds100:18,marshSwamp:16,bogFen:14,mapIslands:62,mapElevationMax:64,mapElevationVariance:68,advanced:{elevationVariance:68,elevationScale:64,oreNoiseScale:62,oreThresholdOffset:38,waterGuaranteeRadius:32,waterFlowMultiplier:62}}),custom:Vo("normal")};function Cs(e="normal"){return So[e]||So.normal}const Uf=Object.freeze({maskStrength:.68,maskBias:-.04,worldScaleFactor:.95,waterCoverageTarget:.42,minOceanFraction:.1,openLandBias:-.06}),Yf=Object.freeze({maskStrength:.5,maskBias:-.01,worldScaleFactor:1.15,waterCoverageTarget:.35,minOceanFraction:.05,openLandBias:-.02}),Gf=Object.freeze({maskStrength:.55,maskBias:0,worldScaleFactor:1.2,waterCoverageTarget:.32,minOceanFraction:.02,openLandBias:0}),Vf=Object.freeze({maskStrength:.34,maskBias:.1,worldScaleFactor:1.35,waterCoverageTarget:.26,minOceanFraction:.02,openLandBias:.06}),Xf=Object.freeze({maskStrength:.82,maskBias:-.06,worldScaleFactor:.9,waterCoverageTarget:.5,minOceanFraction:.14,openLandBias:-.1}),Kf=Object.freeze({maskStrength:.38,maskBias:.08,worldScaleFactor:1.45,waterCoverageTarget:.24,minOceanFraction:.02,openLandBias:.08}),Zf={archipelago:Uf,coastal:Yf,continent:Gf,inland:Vf,island:Xf,pangea:Kf},Jf=Object.entries(Zf).map(([e,t])=>{if(!t||typeof t!="object")throw new TypeError(`Landmass preset "${e}" must export an object.`);return[e,t]}).sort(([e],[t])=>e.localeCompare(t));Object.freeze(Object.fromEntries(Jf));const Xo=.45;function Es(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function Qf(e,t,n=50){if(!e||typeof e!="object")return Es(n,0,100);const r=Number(e[t]);return Number.isFinite(r)?Es(r,0,100):Es(n,0,100)}function Pn(e,t,n=50){return(Qf(e,t,n)-50)/50}function Ts(e){return Number.isFinite(e)?e<-Xo?-Xo:e>Xo?Xo:Math.fround(e):0}function Gs(e,{skipResolve:t=!1,width:n,height:r}={}){const i=t?e||{}:ni(e||{});if(!i||typeof i!="object")return{elevationBias:0,temperatureBias:0,moistureBias:0};const o=Pn(i,"mountains",50),a=Pn(i,"mapElevationMax",50),c=Pn(i,"mapElevationVariance",50),l=Ts(o*.28+a*.4+c*.18),d=Pn(i,"temperature",50),u=Pn(i,"rainfall",50),m=Pn(i,"waterTable",50),h=Ts(d*.45+o*-.12+u*-.08),p=Pn(i,"marshSwamp",28),w=Pn(i,"bogFen",24),x=Ts(u*.42+m*.32+p*.12+w*.1),C=Pn(i,"mapIslands",50),M=Number.isFinite(n)?Math.max(1,Math.trunc(n)):null,T=Number.isFinite(r)?Math.max(1,Math.trunc(r)):null,A=M&&T?M*T:null,E=A?Math.max(16,Math.min(256,Math.floor(A/64))):null,R=E?Math.round(E+o*-.35*E+C*-.28*E+m*.22*E+u*.18*E):null;return{elevationBias:l,temperatureBias:h,moistureBias:x,...R!=null?{spawnSuggestionCount:R}:{}}}const As=.32,tc=.08,em=.82,tm=.88,nm=.55,rm=.65,im=.6,om=.78,am=.72,sm=new Set(["water","ocean","lake","river","stream","pond","marsh","swamp","bog","fen","mangrove","estuary","delta","mangrove_forest","kelp_forest","coral_reef","polar_sea","open_ocean","abyssal_deep","seamount"]);function Md(e,t,n=0,r=0){const i=Math.max(1,Math.trunc(e)),o=Math.max(1,Math.trunc(t)),a=Math.floor(i/2),c=Math.floor(o/2);return{xStart:Math.round(n)-a,yStart:Math.round(r)-c}}function pa(e=""){const t=(e??"").trim(),n=new Array(8).fill(0);let r=2166136261;for(let o=0;o<t.length;o+=1){const a=t.charCodeAt(o);r^=a,r=Math.imul(r,16777619)>>>0;const c=o%n.length;n[c]=Math.imul(n[c]^r,668265261)>>>0}if(t.length)for(let o=0;o<n.length;o+=1)n[o]||(n[o]=r+o*2654435761>>>0);else for(let o=0;o<n.length;o+=1)n[o]=r+o*2654435761>>>0;const i=n.map(o=>o.toString(16).padStart(8,"0")).join("");return{raw:e,normalized:t,hex:i,lanes:n}}function lm(e){if(e&&typeof e=="object"&&Array.isArray(e.lanes)&&typeof e.hex=="string"||e&&typeof e=="object"&&typeof e.raw=="string"&&Array.isArray(e.lanes))return e;const t=e==null?"":String(e);return pa(t)}function cm(e){if(!e)return"open";const t=Number.isFinite(e.elevation)?e.elevation:0,n=Number.isFinite(e.runoff)?e.runoff:0,r=Number.isFinite(e.moisture)?e.moisture:0,i=e.resources||{},o=Number.isFinite(i.ore)?i.ore:0,a=Number.isFinite(i.wood)?i.wood:0,c=Number.isFinite(i.vegetation)?i.vegetation:0;return t<=As||t<=As+tc&&n>=em||r>=tm&&t<=As+tc?"water":o>=om?"ore":o>=im||t>=am?"stone":a>=nm||c>=rm?"forest":"open"}function nc(e,t){return e?{xStart:Number.isFinite(e.xStart)?Math.trunc(e.xStart):t.xStart,yStart:Number.isFinite(e.yStart)?Math.trunc(e.yStart):t.yStart,width:Math.max(1,Math.trunc(e.width??t.width)),height:Math.max(1,Math.trunc(e.height??t.height))}:{...t}}function si(e,t={}){var x,C,M,T,A;if(!e)return{seed:t.seedString||"",seedInfo:t.seedInfo||null,season:t.season||null,tiles:[],types:[],elevations:[],xStart:Number.isFinite(t.xStart)?Math.trunc(t.xStart):0,yStart:Number.isFinite(t.yStart)?Math.trunc(t.yStart):0,width:0,height:0,viewport:nc(t.viewport,{xStart:0,yStart:0,width:0,height:0}),tileData:[],tileMatrix:[],layerBuffers:{elevation:new Float32Array(0),temperature:new Float32Array(0),moisture:new Float32Array(0),runoff:new Float32Array(0)},worldSettings:t.worldSettings||null,buffer:null,spawnSuggestion:null,world:null};const n=Math.max(1,Math.trunc(((x=e.dimensions)==null?void 0:x.width)??0)),r=Math.max(1,Math.trunc(((C=e.dimensions)==null?void 0:C.height)??0)),i=n*r,o=Md(n,r,t.focusX??0,t.focusY??0),a=Number.isFinite(t.xStart)?Math.trunc(t.xStart):o.xStart,c=Number.isFinite(t.yStart)?Math.trunc(t.yStart):o.yStart,l=new Array(r),d=new Array(r),u=new Array(r),m=new Array(r),h=((M=e.layers)==null?void 0:M.elevation)instanceof Float32Array?e.layers.elevation:new Float32Array(i);for(let E=0;E<r;E+=1){const R=new Array(n),L=new Array(n),W=new Array(n),D=new Array(n);for(let V=0;V<n;V+=1){const P=E*n+V,O=((T=e.tiles)==null?void 0:T[P])||null,s=cm(O);L[V]=s;const G=Us[s]??Us.open??s??"?";R[V]=G,W[V]=h[P]??0,D[V]=O}l[E]=R,d[E]=L,u[E]=W,m[E]=D}const p=nc(t.viewport,{xStart:a,yStart:c,width:n,height:r}),w={seed:t.seedString??((A=t.seedInfo)==null?void 0:A.raw)??"",seedInfo:t.seedInfo??null,season:t.season??null,tiles:l,types:d,elevations:u,xStart:a,yStart:c,width:n,height:r,viewport:p,tileData:e.tiles??[],tileMatrix:m,layerBuffers:e.layers??{elevation:new Float32Array(i),temperature:new Float32Array(i),moisture:new Float32Array(i),runoff:new Float32Array(i)},worldSettings:t.worldSettings||null,buffer:null,spawnSuggestion:null,world:e};return w.buffer={seed:w.seed,season:w.season,tiles:l,types:d,elevations:u,xStart:a,yStart:c,width:n,height:r,viewport:p,tileData:w.tileData,tileMatrix:m,layers:w.layerBuffers,worldSettings:w.worldSettings,world:e},w.spawnSuggestion=dm(w),w}function dm(e){var l,d,u;if(!((l=e==null?void 0:e.tileMatrix)!=null&&l.length)||!((d=e==null?void 0:e.types)!=null&&d.length))return null;const t=Math.max(1,Math.trunc(e.width??((u=e.tileMatrix[0])==null?void 0:u.length)??0)),n=Math.max(1,Math.trunc(e.height??e.tileMatrix.length??0));if(!t||!n)return null;const r=Number.isFinite(e.xStart)?Math.trunc(e.xStart):0,i=Number.isFinite(e.yStart)?Math.trunc(e.yStart):0,o=r+Math.floor(t/2),a=i+Math.floor(n/2);let c=null;for(let m=0;m<n;m+=1){const h=e.types[m],p=e.tileMatrix[m];if(!(!h||!p))for(let w=0;w<t;w+=1){const x=h[w];if(!x||sm.has(x))continue;const C=p[w];if(!C)continue;const M=r+w,T=i+m,A=Math.hypot(M-o,T-a),E=C.resources||{},R=Number.isFinite(E.fertility)?E.fertility:0,L=Number.isFinite(E.forage)?E.forage:0,W=Number.isFinite(E.wood)?E.wood:0,D=Number.isFinite(E.freshWater)?E.freshWater:0,V=Number.isFinite(E.ore)?E.ore:0,P=Number.isFinite(C.elevation)?C.elevation:.5,s=R*.25+D*.2+L*.2+W*.2+V*.1+(1-Math.abs(P-.55))*.05-A*.02;(!c||s>c.score||Math.abs(s-c.score)<1e-6&&A<c.distance)&&(c={x:M,y:T,score:s,distance:A})}}return c?{x:c.x,y:c.y}:null}function um(e,t,n){const r=e&&typeof e=="object"?{...e}:{};return t&&((!r.seed||typeof r.seed!="string")&&(r.seed=t.raw??""),r.seedHash=t.hex,r.seedLanes=Array.from(t.lanes)),n&&!r.startingBiomeId&&(r.startingBiomeId=n),r}function Mo(e={}){const t=Math.max(1,Math.trunc(e.width??e.height??128)),n=Math.max(1,Math.trunc(e.height??e.width??128)),r=lm(e.seedInfo??e.seed??Date.now()),i=typeof e.seed=="string"?e.seed:typeof r.raw=="string"?r.raw:String(e.seed??""),o=Gs(e.worldSettings,{width:t,height:n}),a=Ys({width:t,height:n,seed:r,params:o}),c=um(e.worldSettings,r,e.startingBiomeId??null),l=Md(t,n,e.focusX??0,e.focusY??0),d=Number.isFinite(e.xStart)?Math.trunc(e.xStart):l.xStart,u=Number.isFinite(e.yStart)?Math.trunc(e.yStart):l.yStart,m=si(a,{seedInfo:r,seedString:i,season:e.season??null,xStart:d,yStart:u,viewport:e.viewport??null,worldSettings:c});return m.worldSettings||(m.worldSettings=c,m.buffer&&(m.buffer.worldSettings=c)),m.seedInfo=r,m.seed=i,{world:a,map:m,seedInfo:r}}const Wi=100,kd=64,Er=kd,li=kd,Ti=Object.freeze({water:"#2d7ff9",ocean:"#2563eb",lake:"#38bdf8",river:"#0ea5e9",stream:"#38bdf8",pond:"#67e8f9",marsh:"#4ade80",swamp:"#166534",bog:"#0f5132",fen:"#22c55e",mangrove:"#065f46",estuary:"#2563eb",delta:"#3b82f6",mangrove_forest:"#047857",kelp_forest:"#0f766e",coral_reef:"#f97316",polar_sea:"#bae6fd",open_ocean:"#1d4ed8",abyssal_deep:"#0f172a",seamount:"#334155",open:"#facc15",grassland:"#a3e635",forest:"#16a34a",ore:"#f97316",stone:"#94a3b8",desert:"#f4b76b",tundra:"#9ac5ff",taiga:"#2f6b2a",savanna:"#f59e0b",rainforest:"#047857",jungle:"#0f766e",wetland:"#22c55e",sand:"#fcd34d",coast:"#0ea5e9",island:"#38bdf8",mountain:"#64748b",alpine:"#60a5fa",volcanic:"#ea580c",temperate:"#4ade80",tropical:"#10b981",plains:"#facc15"}),fm=Object.freeze({water:"--legend-water",ocean:"--legend-ocean",lake:"--legend-lake",river:"--legend-river",stream:"--legend-stream",pond:"--legend-pond",marsh:"--legend-marsh",swamp:"--legend-swamp",bog:"--legend-bog",fen:"--legend-fen",mangrove:"--legend-mangrove",estuary:"--legend-estuary",delta:"--legend-delta",mangrove_forest:"--legend-mangrove-forest",kelp_forest:"--legend-kelp-forest",coral_reef:"--legend-coral-reef",polar_sea:"--legend-polar-sea",open_ocean:"--legend-open-ocean",abyssal_deep:"--legend-abyssal-deep",seamount:"--legend-seamount",open:"--legend-open",grassland:"--legend-grassland",forest:"--legend-forest",ore:"--legend-ore",stone:"--legend-stone",desert:"--legend-desert",tundra:"--legend-tundra",taiga:"--legend-taiga",savanna:"--legend-savanna",rainforest:"--legend-rainforest",jungle:"--legend-jungle",wetland:"--legend-wetland",sand:"--legend-sand",coast:"--legend-coast",island:"--legend-island",mountain:"--legend-mountain",alpine:"--legend-alpine",volcanic:"--legend-volcanic",temperate:"--legend-temperate",tropical:"--legend-tropical",plains:"--legend-plains"});let Ko=null;function mm(e,t){if(!e||typeof e.getPropertyValue!="function")return"";try{return e.getPropertyValue(t)||""}catch{return""}}function hm(){let e=null;if(typeof document<"u"&&document.documentElement)try{e=getComputedStyle(document.documentElement)}catch{e=null}const t={};for(const[n,r]of Object.entries(fm)){const i=Ti[n],o=mm(e,r).trim();t[n]=o||i}return t}function rc({forceRefresh:e=!1}={}){if(e&&(Ko=null),Ko)return{...Ko};const t=hm();return Ko=t,{...t}}new Proxy({},{get(e,t){if(typeof t=="string"){const n=rc();if(Object.prototype.hasOwnProperty.call(n,t))return n[t];if(Object.prototype.hasOwnProperty.call(Ti,t))return Ti[t]}},has(e,t){return Object.prototype.hasOwnProperty.call(Ti,t)},ownKeys(){return Reflect.ownKeys(Ti)},getOwnPropertyDescriptor(e,t){if(Object.prototype.hasOwnProperty.call(Ti,t))return{configurable:!0,enumerable:!0,value:rc()[t],writable:!1}}});const pm=new Set(["water","ocean","open_ocean","polar_sea","abyssal_deep","seamount","estuary","delta","mangrove_forest","kelp_forest","coral_reef","lake","pond","river","stream","marsh","swamp","bog","fen","mangrove"]);function ic(e){return e?pm.has(e):!1}function No(e=Er,t=li,n=0,r=0){const i=Math.max(1,Math.trunc(e)),o=Math.max(1,Math.trunc(t)),a=Math.floor(i/2),c=Math.floor(o/2);return{xStart:Math.round(n)-a,yStart:Math.round(r)-c}}function gm(e){let t=1779033703^e.length;for(let n=0;n<e.length;n+=1)t=Math.imul(t^e.charCodeAt(n),3432918353),t=t<<13|t>>>19;return function(){return t=Math.imul(t^t>>>16,2246822507),t=Math.imul(t^t>>>13,3266489909),(t^=t>>>16)>>>0}}function bm(e){return function(){let n=e+=1831565813;return n=Math.imul(n^n>>>15,n|1),n^=n+Math.imul(n^n>>>7,n|61),((n^n>>>14)>>>0)/4294967296}}function ym(e,t,n,r=""){return bm(gm(`${e}:${t}:${n}:${r}`)())()}function ko(e,t,n,r=""){return ym(e,t,n,r)}const wm=["elevation","temperature","moisture","runoff","ore","stone","water","fertility"],xm=["biome"];function $i(e){return Number.isFinite(e)?e:Number(e)||0}function Oi(e){return!e||typeof e!="object"?null:Object.entries(e).reduce((t,[n,r])=>(r===void 0||(t[n]=typeof r=="number"?$i(r):r),t),{})}function vm(e){return!e||typeof e!="object"?null:{index:Number.isFinite(e.index)?Math.trunc(e.index):0,x:Number.isFinite(e.x)?Math.trunc(e.x):0,y:Number.isFinite(e.y)?Math.trunc(e.y):0,elevation:Number(e.elevation??0),temperature:Number(e.temperature??0),moisture:Number(e.moisture??0),runoff:Number(e.runoff??0),climate:Oi(e.climate),biome:Oi(e.biome),resources:Oi(e.resources)}}function Ns(e){if(!e)return[];if(Array.isArray(e))return e.map($i);if(ArrayBuffer.isView(e)){if("length"in e&&typeof e.length=="number"){const t=e,n=new Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=$i(t[r]);return n}return[]}return[]}function Cd(e){if(!e||typeof e!="object")return null;const t=Array.isArray(e.lanes)?e.lanes.map(n=>Number.isFinite(n)?n>>>0:0):[];return{raw:typeof e.raw=="string"?e.raw:e.raw!=null?String(e.raw):"",normalized:typeof e.normalized=="string"?e.normalized:e.normalized!=null?String(e.normalized):typeof e.raw=="string"?e.raw:"",hex:typeof e.hex=="string"?e.hex:"",lanes:t}}function ml(e,t=0){if(!e)return new Array(t).fill(0);if(ArrayBuffer.isView(e)){if("length"in e&&typeof e.length=="number"){const n=e,r=new Array(n.length);for(let i=0;i<n.length;i+=1)r[i]=$i(n[i]);return r}return[]}if(Array.isArray(e)){if(e.length>=t)return e.map($i);const n=new Array(t);for(let r=0;r<t;r+=1)n[r]=$i(e[r]??0);return n}return new Array(t).fill(0)}function fr(e,t=0){const n=ml(e,t);return Float32Array.from(n)}function Sm(e,t=0){const n=ml(e,t).map(r=>Number.isFinite(r)?r>>>0:0);return Uint8Array.from(n)}function Mm(e,t=0){const n=ml(e,t).map(r=>Number.isFinite(r)?r>>>0:0);return Uint32Array.from(n)}function km(e){if(!e)return null;const t=e.climate?Object.freeze({...e.climate}):null,n=e.biome?Object.freeze({...e.biome}):null,r=e.resources?Object.freeze({...e.resources}):null;return Object.freeze({index:e.index,x:e.x,y:e.y,elevation:e.elevation,temperature:e.temperature,moisture:e.moisture,runoff:e.runoff,climate:t,biome:n,resources:r})}function Cm(e){if(!e||typeof e!="object")return null;const t=e.layers||{},n={};for(const r of wm)n[r]=Ns(t[r]);for(const r of xm)n[r]=Ns(t[r]);return{seed:Cd(e.seed),params:e.params&&typeof e.params=="object"?{...e.params}:null,dimensions:e.dimensions&&typeof e.dimensions=="object"?{width:Number.isFinite(e.dimensions.width)?Math.trunc(e.dimensions.width):0,height:Number.isFinite(e.dimensions.height)?Math.trunc(e.dimensions.height):0,size:Number.isFinite(e.dimensions.size)?Math.max(0,Math.trunc(e.dimensions.size)):0}:null,layers:n,tiles:Array.isArray(e.tiles)?e.tiles.map(vm).filter(Boolean):[],spawnSuggestions:Ns(e.spawnSuggestions)}}function Vs(e){if(!e||typeof e!="object")return null;const t=Array.isArray(e.lanes)?e.lanes.map(n=>Number.isFinite(n)?n>>>0:0):[];return Object.freeze({raw:typeof e.raw=="string"?e.raw:e.raw!=null?String(e.raw):"",normalized:typeof e.normalized=="string"?e.normalized:e.normalized!=null?String(e.normalized):typeof e.raw=="string"?e.raw:"",hex:typeof e.hex=="string"?e.hex:"",lanes:Object.freeze([...t])})}function Em(e){if(!e||typeof e!="object")return null;const t=e.dimensions||{},n=Number.isFinite(t.width)?Math.max(1,Math.trunc(t.width)):0,r=Number.isFinite(t.height)?Math.max(1,Math.trunc(t.height)):0,o=(n&&r?n*r:Math.max(0,Math.trunc(t.size||0)))||(Array.isArray(e.tiles)?e.tiles.length:0),a=e.layers||{},c=fr(a.elevation,o),l=fr(a.temperature,o),d=fr(a.moisture,o),u=fr(a.runoff,o),m=fr(a.ore,o),h=fr(a.stone,o),p=fr(a.water,o),w=fr(a.fertility,o),x=Sm(a.biome,o),C=Array.isArray(e.tiles)?e.tiles.map(A=>!A||typeof A!="object"?null:{index:Number.isFinite(A.index)?Math.trunc(A.index):0,x:Number.isFinite(A.x)?Math.trunc(A.x):0,y:Number.isFinite(A.y)?Math.trunc(A.y):0,elevation:Number(A.elevation??0),temperature:Number(A.temperature??0),moisture:Number(A.moisture??0),runoff:Number(A.runoff??0),climate:Oi(A.climate)||{temperature:"temperate",moisture:"balanced",runoff:"moderate",frostRisk:0},biome:Oi(A.biome)||{id:"temperate-broadleaf",score:0,reason:"restored"},resources:Oi(A.resources)||{vegetation:0,wood:0,forage:0,ore:0,freshWater:0,fertility:0}}).filter(Boolean).map(km):[],M=Array.isArray(e.spawnSuggestions)||ArrayBuffer.isView(e.spawnSuggestions)?Mm(e.spawnSuggestions):new Uint32Array(0),T={seed:Vs(e.seed),params:e.params&&typeof e.params=="object"?Object.freeze({...e.params}):Object.freeze({width:n,height:r,spawnSuggestionCount:Math.min(o,64)}),dimensions:Object.freeze({width:n,height:r,size:o}),layers:Object.freeze({elevation:c,temperature:l,moisture:d,runoff:u,biome:x,ore:m,stone:h,water:p,fertility:w}),tiles:Object.freeze(C),spawnSuggestions:M};return Object.freeze(T)}const oc="survey";function Tm(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;if(e instanceof Date){const t=e.getTime();return Number.isFinite(t)?t:null}if(typeof e=="string"&&e.trim()){const t=Date.parse(e);return Number.isFinite(t)?t:null}return null}function Fs(e,t){const n=t&&typeof t=="object"?t:{},r=e||n.id?String(e||n.id):null;if(!r)return null;const i=n.unlocked===!0||n.status==="unlocked"||!("unlocked"in n)&&!!(n.discovered||n.name),o=n.discovered===!0||i,a=Number.isFinite(n.progress)?Math.min(1,Math.max(0,n.progress)):i?1:0,c=n.label||n.name||r,l=Tm(n.unlockedAt??n.completedAt??null),d=typeof n.notes=="string"&&n.notes.trim()?n.notes:null;return{id:r,unlocked:i,discovered:o,progress:a,unlockedAt:l,label:c,notes:d}}function Am(e){return e?e instanceof Map?[...e.entries()]:Array.isArray(e)?e:typeof e=="object"?Object.entries(e):[]:[]}function wi(e){if(!e)return[];if(e instanceof Map)return[...e.entries()];if(typeof e=="object"&&!Array.isArray(e))return Object.entries(e);if(!Array.isArray(e))return[];const t=[];for(const n of e){if(Array.isArray(n)&&n.length>=2){t.push([n[0],n[1]]);continue}if(n&&typeof n=="object"){const r=Object.keys(n);if(r.length===1){const i=r[0];t.push([i,n[i]])}}}return t}function Nm(e){if(!e||typeof e!="object")return null;const t=Number.isFinite(e.xStart)?Math.trunc(e.xStart):null,n=Number.isFinite(e.yStart)?Math.trunc(e.yStart):null,r=Number.isFinite(e.width)?Math.max(1,Math.trunc(e.width)):null,i=Number.isFinite(e.height)?Math.max(1,Math.trunc(e.height)):null;return{xStart:t,yStart:n,width:r,height:i}}function Fm(e){var n;return!e||typeof e!="object"?null:{seed:e.seed??null,seedInfo:Cd(e.seedInfo)??null,season:e.season??null,xStart:Number.isFinite(e.xStart)?Math.trunc(e.xStart):null,yStart:Number.isFinite(e.yStart)?Math.trunc(e.yStart):null,width:Number.isFinite(e.width)?Math.max(1,Math.trunc(e.width)):Array.isArray((n=e.tiles)==null?void 0:n[0])?e.tiles[0].length:null,height:Number.isFinite(e.height)?Math.max(1,Math.trunc(e.height)):Array.isArray(e.tiles)?e.tiles.length:null,viewport:Nm(e.viewport),worldSettings:e.worldSettings?qi(e.worldSettings):null,waterLevel:e.waterLevel??null}}function Bm(e,t){const n=e&&typeof e=="object"?e:{},r=t||{xStart:0,yStart:0,width:1,height:1},i=Number.isFinite(n.width)?Math.max(1,Math.trunc(n.width)):r.width,o=Number.isFinite(n.height)?Math.max(1,Math.trunc(n.height)):r.height,a=Number.isFinite(n.xStart)?Math.trunc(n.xStart):r.xStart,c=Number.isFinite(n.yStart)?Math.trunc(n.yStart):r.yStart;return{xStart:a,yStart:c,width:i,height:o}}function Lm(e,t=null){var x;if(!e)return t&&typeof t=="object"?{...t}:null;const n=e.dimensions||{},r=n.width??(t&&Number.isFinite(t.width)?t.width:0),i=n.height??(t&&Number.isFinite(t.height)?t.height:0),o=Math.max(1,Math.trunc(r||0)),a=Math.max(1,Math.trunc(i||0)),c=No(o,a),l=t&&Number.isFinite(t.xStart)?Math.trunc(t.xStart):c.xStart,d=t&&Number.isFinite(t.yStart)?Math.trunc(t.yStart):c.yStart,u=Bm(t==null?void 0:t.viewport,{xStart:l,yStart:d,width:o,height:a}),m=t!=null&&t.seedInfo?Vs(t.seedInfo):e.seed?Vs(e.seed):null,h=typeof(t==null?void 0:t.seed)=="string"?t.seed:(m==null?void 0:m.raw)??(typeof((x=e.seed)==null?void 0:x.raw)=="string"?e.seed.raw:""),p=t!=null&&t.worldSettings?qi(t.worldSettings):null,w=si(e,{seedInfo:m,seedString:h,season:(t==null?void 0:t.season)??null,xStart:l,yStart:d,viewport:u,worldSettings:p});return w.waterLevel=(t==null?void 0:t.waterLevel)??w.waterLevel??null,m&&(w.seedInfo=m),h!==void 0&&(w.seed=h),w.world=e,w}function Rm(e){if(!e||typeof e!="object")return e;const t={...e};return t.world&&(t.world=Cm(t.world)),t.map&&(t.map=Fm(t.map)),t.worldSettings&&(t.worldSettings=qi(t.worldSettings)),t}function ac(e){var o;if(!e||typeof e!="object")return e;const t={...e},n=t.map&&typeof t.map=="object"?{...t.map}:null,r=t.world??(n==null?void 0:n.world)??null,i=Em(r);return t.world=i,i?t.map=Lm(i,n):n?t.map={...n}:t.map=null,t.map&&t.world&&!t.map.world&&(t.map.world=t.world),t.worldSettings=qi(t.worldSettings??((o=t.map)==null?void 0:o.worldSettings)??null),t}class Im{constructor(){this.buildings=new Map,this.people=new Map,this.inventory=new Map,this.craftTargets=new Map,this.locations=new Map,this.technologies=new Map,this.proficiencies=new Map,this.player={locationId:null,x:0,y:0,jobId:oc},this.time={day:1,month:1,year:410,hour:6,season:"Thawbound",weather:"Clear"},this.difficulty="normal",this.jobs={},this.orders=[],this.eventLog=[],this.orderSeq=0,this.unlockedBuildings=new Set,this.research=new Set,this.buildingSeq=0,this.gatherNodes=new Map,this.discoveredFauna=new Map,this.discoveredFlora=new Map,this.jobSettings={},this.jobDaily={},this.buildQueue=0,this.haulQueue=0,this.worldSettings=null}addItem(t,n){const r=n.id;if(!r){console.warn(`Missing id for ${t} item`,n);return}this[t].has(r)?console.warn(`Duplicate ${t} id ${r} ignored.`):this[t].set(r,n)}updateItem(t,n){const r=n.id;if(this[t].has(r)){const i=this[t].get(r);this[t].set(r,{...i,...n})}else console.warn(`Cannot update missing ${t} id ${r}.`)}getItem(t,n){return this[t].get(n)}serialize(){const t=[...this.technologies.entries()].map(([n,r])=>{const i=Fs(n,r);return i?[i.id,i]:null}).filter(Boolean);return{buildings:[...this.buildings.entries()],people:[...this.people.entries()],inventory:[...this.inventory.entries()],craftTargets:[...this.craftTargets.entries()],locations:[...this.locations.entries()].map(([n,r])=>[n,Rm(r)]),technologies:t,proficiencies:[...this.proficiencies.entries()],player:{...this.player},time:this.time,difficulty:this.difficulty,jobs:this.jobs,orders:this.orders,eventLog:this.eventLog,orderSeq:this.orderSeq,unlockedBuildings:[...this.unlockedBuildings],research:[...this.research],buildingSeq:this.buildingSeq,gatherNodes:[...this.gatherNodes.entries()],discoveredFauna:[...this.discoveredFauna.entries()].map(([n,r])=>[n,[...r]]),discoveredFlora:[...this.discoveredFlora.entries()].map(([n,r])=>[n,[...r]]),jobSettings:this.jobSettings,jobDaily:this.jobDaily,worldSettings:qi(this.worldSettings)}}deserialize(t){this.buildings=new Map(wi(t.buildings)),this.people=new Map(wi(t.people)),this.inventory=new Map(wi(t.inventory)),this.craftTargets=new Map(wi(t.craftTargets));const n=Am(t.locations),r=[];for(const u of n){if(Array.isArray(u)&&u.length>=2){const[m,h]=u;if(m==null)continue;const p=String(m),w=ac(h);w&&(w.id===void 0||w.id===null)&&(w.id=p),r.push([p,w]);continue}if(u&&typeof u=="object"){const m=ac(u),h=(m==null?void 0:m.id)??u.id;if(h==null)continue;const p=String(h);m&&(m.id===void 0||m.id===null)&&(m.id=p),r.push([p,m])}}this.locations=new Map(r);const o=(Array.isArray(t.technologies)?t.technologies:t.technologies&&typeof t.technologies=="object"?Object.entries(t.technologies):[]).map(u=>{if(Array.isArray(u)&&u.length>=2){const m=Fs(u[0],u[1]);return m?[m.id,m]:null}if(u&&typeof u=="object"){const m=Fs(u.id,u);return m?[m.id,m]:null}return null}).filter(Boolean);this.technologies=new Map(o),this.proficiencies=new Map(wi(t.proficiencies));const a=t.player||{};this.player={locationId:a.locationId??null,x:Number.isFinite(a.x)?Math.trunc(a.x):0,y:Number.isFinite(a.y)?Math.trunc(a.y):0,jobId:typeof a.jobId=="string"&&a.jobId?a.jobId:oc};const c=t.time||{};this.time={day:1,month:1,year:410,hour:6,season:"Thawbound",weather:"Clear",...c},this.difficulty=t.difficulty||"normal",this.jobs=t.jobs||{},this.orders=t.orders||[],this.eventLog=t.eventLog||[],this.orderSeq=t.orderSeq||0,this.unlockedBuildings=new Set(t.unlockedBuildings||[]),this.research=new Set(t.research||[]),this.buildingSeq=t.buildingSeq||0,this.gatherNodes=new Map(wi(t.gatherNodes)),this.jobSettings=t.jobSettings||{},this.jobDaily=t.jobDaily||{},this.worldSettings=qi(t.worldSettings);const l=Array.isArray(t.discoveredFauna)?t.discoveredFauna:Object.entries(t.discoveredFauna||{});this.discoveredFauna=new Map(l.map(u=>{const[m,h]=u||[];return[m,new Set(h||[])]}));const d=Array.isArray(t.discoveredFlora)?t.discoveredFlora:Object.entries(t.discoveredFlora||{});this.discoveredFlora=new Map(d.map(u=>{const[m,h]=u||[];return[m,new Set(h||[])]}))}}const Hm="WORLD_CONFIG_CHANGED",Mt={startingBiomeId:null,season:null,seed:null,difficulty:null,worldParameters:null};function hl(e){return!e||typeof e!="object"?{present:!1,value:void 0}:Object.prototype.hasOwnProperty.call(e,"startingBiomeId")?{present:!0,value:e.startingBiomeId??null}:Object.prototype.hasOwnProperty.call(e,"biome")?{present:!0,value:e.biome??null}:{present:!1,value:void 0}}const Xs=new Set;function qi(e){if(!e||typeof e!="object")return null;const{advanced:t,...n}=e,r={...n},i=t&&typeof t=="object"?{...t}:t??null;r.advanced=i;const{present:o,value:a}=hl(e);return o&&(r.startingBiomeId=a),"biome"in r&&delete r.biome,r}function Ed(e){if(!e||typeof e!="object")return null;const{advanced:t,...n}=e,r={...n},{present:i,value:o}=hl(r);i&&(r.startingBiomeId=o),"biome"in r&&delete r.biome;const a=t&&typeof t=="object"?{...t}:t??null;return{...r,advanced:a}}function zm(e,t){if(e===t)return!0;if(!e||!t)return!e&&!t;const n=new Set([...Object.keys(e),...Object.keys(t)]);for(const a of n)if(a!=="advanced"&&(e[a]??null)!==(t[a]??null))return!1;const r=e.advanced&&typeof e.advanced=="object"?e.advanced:{},i=t.advanced&&typeof t.advanced=="object"?t.advanced:{},o=new Set([...Object.keys(r),...Object.keys(i)]);for(const a of o)if((r[a]??null)!==(i[a]??null))return!1;return!0}function Ui(){return{startingBiomeId:Mt.startingBiomeId,season:Mt.season,seed:Mt.seed,difficulty:Mt.difficulty,worldParameters:Mt.worldParameters?Ed(Mt.worldParameters):null}}function $m(){const e=Ui();Xs.forEach(t=>{try{t(e)}catch(n){console.error("Error in world config listener",n)}}),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent(Hm,{detail:e}))}function Om(e,t={}){if(typeof e!="function")return()=>{};if(Xs.add(e),t!=null&&t.immediate)try{e(Ui())}catch(n){console.error("Error in immediate world config listener",n)}return()=>Xs.delete(e)}function Dn(e={},t={}){if(!e||typeof e!="object")return Ui();const{silent:n=!1,force:r=!1}=t;let i=!1;const{present:o,value:a}=hl(e);if(o&&a!==Mt.startingBiomeId&&(Mt.startingBiomeId=a??null,i=!0),"season"in e&&e.season!==Mt.season&&(Mt.season=e.season??null,i=!0),"seed"in e&&e.seed!==Mt.seed&&(Mt.seed=e.seed??null,i=!0),"difficulty"in e&&e.difficulty!==Mt.difficulty&&(Mt.difficulty=e.difficulty??null,i=!0),"worldParameters"in e){const c=e.worldParameters,l=c?Ed(c):null;zm(Mt.worldParameters,l)||(Mt.worldParameters=l,i=!0)}return(i||r)&&!n&&$m(),Ui()}const S=new Im,_m={primitive:"Primitive",bronze:"Bronze",iron:"Iron",steel:"Steel"};function sc(e=""){return String(e).split(/[^a-zA-Z0-9]+/).filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function Pm(e){return Array.isArray(e)?e.map(t=>{if(!t)return null;if(typeof t=="string")return{item:t,quantity:1};if(typeof t=="object"){const n=t.item||t.id||t.name;if(!n)return null;const r=Number.isFinite(t.quantity)&&t.quantity>0?t.quantity:1;return{item:String(n),quantity:r}}return null}).filter(Boolean):[]}function St(e){if(!e||!e.id)throw new Error("Equipment entries must include an id.");const t=e.tier||"primitive",n=e.label||e.name||sc(e.id),r=e.tierLabel||_m[t]||sc(t);return Object.freeze({id:String(e.id),label:n,category:e.category||"tool",role:e.role||e.type||null,tier:t,tierLabel:r,icon:e.icon||"ðŸŽ’",stats:e.stats||{},materials:Pm(e.materials),durability:Number.isFinite(e.durability)?Math.max(1,Math.round(e.durability)):null,requiredTech:e.requiredTech||null})}const pl=[St({id:"stone knife",label:"Stone Knife",category:"weapon",role:"blade",tier:"primitive",icon:"ðŸ”ª",stats:{damage:3,utility:2},materials:["sharpened stone","cord","straight branch"],durability:25,requiredTech:"basic-tools"}),St({id:"wooden hammer",label:"Wooden Hammer",category:"tool",role:"hammer",tier:"primitive",icon:"ðŸ”¨",stats:{damage:1,utility:3},materials:["seasoned wood","cord"],durability:40,requiredTech:"basic-tools"}),St({id:"stone hand axe",label:"Stone Hand Axe",category:"tool",role:"axe",tier:"primitive",icon:"ðŸª“",stats:{damage:4,utility:3},materials:["sturdy haft stick","cord","sharpened stone"],durability:45,requiredTech:"basic-tools"}),St({id:"stone pick",label:"Stone Pick",category:"tool",role:"pick",tier:"primitive",icon:"â›ï¸",stats:{damage:3,utility:4},materials:["sturdy haft stick","cord","sharpened stone"],durability:40,requiredTech:"basic-tools"}),St({id:"bow",label:"Self Bow",category:"weapon",role:"bow",tier:"primitive",icon:"ðŸ¹",stats:{damage:5},materials:["seasoned wood","cord","plant fibers"],durability:55,requiredTech:"basic-tools"}),St({id:"wooden arrow",label:"Wooden Arrows",category:"weapon",role:"ammunition",tier:"primitive",icon:"ðŸª¶",stats:{damage:2},materials:["straight branch","stone knife","plant fibers"],durability:5,requiredTech:"basic-tools"}),St({id:"leather armor",label:"Leather Armor",category:"armor",role:"light-armor",tier:"primitive",icon:"ðŸ¥‹",stats:{protection:4},materials:["prepared hides","cord"],durability:65,requiredTech:"basic-tools"}),St({id:"bronze axe",label:"Bronze Axe",category:"tool",role:"axe",tier:"bronze",icon:"ðŸª“",stats:{damage:6,utility:5},materials:[{item:"bronze ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:70,requiredTech:"bronze-smithing"}),St({id:"bronze pick",label:"Bronze Pick",category:"tool",role:"pick",tier:"bronze",icon:"â›ï¸",stats:{damage:5,utility:6},materials:[{item:"bronze ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:75,requiredTech:"bronze-smithing"}),St({id:"bronze scale armor",label:"Bronze Scale Armor",category:"armor",role:"medium-armor",tier:"bronze",icon:"ðŸ›¡ï¸",stats:{protection:7},materials:[{item:"bronze ingot",quantity:3},{item:"prepared hides",quantity:2},{item:"cord",quantity:1}],durability:90,requiredTech:"bronze-smithing"}),St({id:"iron axe",label:"Iron Axe",category:"tool",role:"axe",tier:"iron",icon:"ðŸª“",stats:{damage:7,utility:7},materials:[{item:"iron ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:90,requiredTech:"iron-smithing"}),St({id:"iron pick",label:"Iron Pick",category:"tool",role:"pick",tier:"iron",icon:"â›ï¸",stats:{damage:6,utility:8},materials:[{item:"iron ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:95,requiredTech:"iron-smithing"}),St({id:"iron chainmail",label:"Iron Chainmail",category:"armor",role:"medium-armor",tier:"iron",icon:"ðŸ›¡ï¸",stats:{protection:10},materials:[{item:"iron ingot",quantity:4},{item:"prepared hides",quantity:2}],durability:120,requiredTech:"iron-smithing"}),St({id:"steel axe",label:"Steel Axe",category:"tool",role:"axe",tier:"steel",icon:"ðŸª“",stats:{damage:8,utility:9},materials:[{item:"steel ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:110,requiredTech:"steel-smithing"}),St({id:"steel pick",label:"Steel Pick",category:"tool",role:"pick",tier:"steel",icon:"â›ï¸",stats:{damage:7,utility:10},materials:[{item:"steel ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:115,requiredTech:"steel-smithing"}),St({id:"steel plate",label:"Steel Plate Armor",category:"armor",role:"heavy-armor",tier:"steel",icon:"ðŸ›¡ï¸",stats:{protection:14},materials:[{item:"steel ingot",quantity:5},{item:"leather armor",quantity:1}],durability:160,requiredTech:"steel-smithing"})],Dm=new Map(pl.map(e=>[e.id,e]));function jm(e={}){const{category:t,tier:n}=e||{};return pl.filter(r=>!(t&&r.category!==t||n&&r.tier!==n))}function rs(e){return e&&Dm.get(String(e))||null}Object.freeze(Array.from(new Set(pl.map(e=>e.tier))));function Ks(e=""){return String(e).split(/\s+/).filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function Td(e){const t=String(e);return{id:t,label:Ks(t),quantity:0,demand:0,supply:0,expectedChange:0,isEquipment:!1,category:"resource",tier:null,tierLabel:null,quality:null,qualityLabel:null,durability:null,stats:null,requiredTech:null}}function Co(e){if(!e)return e;const t=rs(e.id),n={...e};return t?(n.label=t.label||n.label||Ks(n.id),n.isEquipment=!0,n.category=t.category||"equipment",n.tier=t.tier||null,n.tierLabel=t.tierLabel||null,n.quality=t.tier||null,n.qualityLabel=t.tierLabel||null,n.durability=t.durability??n.durability??null,n.stats=t.stats||n.stats||null,n.requiredTech=t.requiredTech||n.requiredTech||null):(n.label=n.label||Ks(n.id),n.isEquipment=!1,n.category="resource",n.tier=null,n.tierLabel=null,n.quality=null,n.qualityLabel=null,n.durability=null,n.stats=null,n.requiredTech=null),n}function Ad(e){const t=S.getItem("inventory",e.id);t?S.updateItem("inventory",{...t,...e}):S.addItem("inventory",e)}function Nd(e){const t=S.getItem("inventory",e);return Co(t?{...t}:Td(e))}function Fd(e){const t=Number.isFinite(e.supply)?e.supply:0,n=Number.isFinite(e.demand)?e.demand:0;e.expectedChange=Math.round((t-n)*100)/100,e.supply=t,e.demand=n}function Ha(e,t=0){const n=Nd(e);n.quantity=Math.max(0,(n.quantity||0)+t),Fd(n),Ad(n)}function Fo(e){const t=S.getItem("inventory",e);return Co(t?{...t}:Td(e))}function Wm(e,{supply:t=0,demand:n=0}={}){const r=Nd(e);r.supply=t,r.demand=n,Fd(r),Ad(r)}function Bd(){return Array.from(S.inventory.values()).map(e=>Co({...e}))}const Ld=[{id:"basic-tools",name:"Basic Tools",category:"Woodworking",order:10,description:"Stone and bone implements along with cordage techniques that let settlers work timber and hides reliably.",prerequisites:[],cost:{research:25,materials:{"plant fibers":12,cord:6,"sharpened stone":4}},effects:{description:"Unlocks foundational woodworking structures, recipes, and primitive gear.",unlocks:{buildings:["drying-rack","hunter-blind","workshop","smokehouse","longhouse","watchtower"],recipes:["cord","sharpened-stone","prepared-hides","seasoned-wood","rendered-tallow","grain-flour","hearty-stew","traveler-flatbread","herbal-porridge","smoke-cured-provisions","pickled-vegetables","aromatic-sachets","herbal-poultice","restorative-tonic","soothing-salve","arrow-bundle","stone-hand-axe","stone-pick"],equipment:["stone knife","wooden hammer","stone hand axe","stone pick","bow","wooden arrow","leather armor"],technologies:[]}}},{id:"metalworking-basics",name:"Metalworking Basics",category:"Metalworking",order:20,description:"Clay forges, bellows, and charcoal production that allow smiths to shape soft metals.",prerequisites:["basic-tools"],cost:{research:80,materials:{charcoal:12,clay:10,"crafted goods":4}},effects:{description:"Opens the path toward bronze alloys and improved forging stations.",unlocks:{technologies:["bronze-smithing"],recipes:[],buildings:[],equipment:[]}}},{id:"bronze-smithing",name:"Bronze Smithing",category:"Metalworking",order:30,description:"Copper and tin alloys hammered into resilient edges and scales.",prerequisites:["metalworking-basics"],cost:{research:120,materials:{"bronze ingot":4,charcoal:8}},effects:{description:"Enables bronze tools, armor, and the knowledge required to tackle harder metals.",unlocks:{technologies:["iron-smithing"],recipes:["bronze-ingot","bronze-axe","bronze-pick"],buildings:[],equipment:["bronze axe","bronze pick","bronze scale armor"]}}},{id:"iron-smithing",name:"Iron Smithing",category:"Metalworking",order:40,description:"Bloom refining, quenching, and tempering techniques for wrought iron.",prerequisites:["bronze-smithing"],cost:{research:160,materials:{"iron ingot":4,charcoal:12}},effects:{description:"Unlocks ironwork recipes and arms the settlement with tougher implements.",unlocks:{technologies:["steel-smithing"],recipes:["iron-ingot","iron-axe","iron-pick"],buildings:[],equipment:["iron axe","iron pick","iron chainmail"]}}},{id:"steel-smithing",name:"Steel Smithing",category:"Metalworking",order:50,description:"High-heat furnaces, folding, and oil quenching that create elite steel arms and armor.",prerequisites:["iron-smithing"],cost:{research:220,materials:{"steel ingot":4,charcoal:16}},effects:{description:"Completes the smithing ladder with access to superior weapons and armor.",unlocks:{technologies:[],recipes:["steel-ingot","steel-axe","steel-pick"],buildings:[],equipment:["steel axe","steel pick","steel plate"]}}},{id:"defense-drills",name:"Defense Drills",category:"Fortifications",order:60,description:"Coordinated watches, signal calls, and militia routines to hold the palisade.",prerequisites:["basic-tools"],cost:{research:100,materials:{"crafted goods":6,firewood:40}},effects:{description:"Strengthens vigilance and readies the village for broader alliances.",unlocks:{technologies:["regional-alliance"],recipes:[],buildings:[],equipment:[]}}},{id:"regional-alliance",name:"Regional Alliance",category:"Fortifications",order:70,description:"Treaties, signal braziers, and trade obligations with neighboring strongholds.",prerequisites:["defense-drills"],cost:{research:180,materials:{"crafted goods":8,preservedFood:20}},effects:{description:"Broadens diplomacy, bringing aid and prestige to the settlement.",unlocks:{technologies:[],recipes:[],buildings:[],equipment:[]}}}];function qm(){return Ld.map(e=>({...e}))}function Um(e){if(!e&&e!==0)return null;const t=String(e);return Ld.find(n=>n.id===t)||null}const ri=new Map;let lc=!1;function Rd(){const e=S.technologies;return e instanceof Map?e:Array.isArray(e)?(S.technologies=new Map(e),S.technologies):e&&typeof e=="object"?(S.technologies=new Map(Object.entries(e)),S.technologies):(S.technologies=new Map,S.technologies)}function Id(e){return!Number.isFinite(e)||e<=0?0:e>=1?1:e}function Hd(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;if(e instanceof Date){const t=e.getTime();return Number.isFinite(t)?t:null}if(typeof e=="string"&&e.trim()){const t=Date.parse(e);return Number.isFinite(t)?t:null}return null}function gl(e){var a,c;if(!(e!=null&&e.id))return null;const t=String(e.id);if(ri.has(t))return ri.get(t);const n=Array.isArray(e.prerequisites)?e.prerequisites.filter(Boolean).map(l=>String(l)):[],r=e.cost?{research:Number.isFinite(e.cost.research)?Math.max(0,e.cost.research):null,materials:e.cost.materials?{...e.cost.materials}:{}}:null,i=((a=e.effects)==null?void 0:a.unlocks)||{},o={id:t,name:e.name||t,category:e.category||null,description:e.description||"",order:Number.isFinite(e.order)?e.order:0,prerequisites:n,cost:r,effects:{description:((c=e.effects)==null?void 0:c.description)||"",unlocks:{technologies:Array.isArray(i.technologies)?i.technologies.map(l=>String(l)):[],recipes:Array.isArray(i.recipes)?i.recipes.map(l=>String(l)):[],buildings:Array.isArray(i.buildings)?i.buildings.map(l=>String(l)):[],equipment:Array.isArray(i.equipment)?i.equipment.map(l=>String(l)):[]}}};return ri.set(t,o),o}function bl(e,t={}){const n=t&&typeof t=="object"?t:{},r=n.unlocked===!0,i=n.discovered===!0||r,o=Id(Number.isFinite(n.progress)?n.progress:r?1:0),a=typeof n.label=="string"&&n.label.trim()?n.label:typeof n.name=="string"&&n.name.trim()?n.name:e.name,c=Hd(n.unlockedAt),l=typeof n.notes=="string"&&n.notes.trim()?n.notes:null;return{id:e.id,unlocked:r,discovered:i,progress:o,unlockedAt:c,label:a,notes:l}}function yl(e,t={}){const n=t&&typeof t=="object"?t:{},r=n.unlocked===!0||!("unlocked"in n)&&!!n.name,i=n.discovered===!0||r,o=Id(Number.isFinite(n.progress)?n.progress:r?1:0),a=typeof n.label=="string"&&n.label.trim()?n.label:typeof n.name=="string"&&n.name.trim()?n.name:String(e),c=Hd(n.unlockedAt),l=typeof n.notes=="string"&&n.notes.trim()?n.notes:null;return{id:String(e),unlocked:r,discovered:i,progress:o,unlockedAt:c,label:a,notes:l}}function Ym(){const e=Rd(),t=new Map;ri.forEach(n=>{const r=e.get(n.id),i=bl(n,r||{id:n.id});t.set(n.id,i)}),e.forEach((n,r)=>{if(t.has(r))return;const i=yl(r,n||{id:r});t.set(r,i)}),e.clear(),t.forEach((n,r)=>{e.set(r,n)})}function ui(){lc||(qm().forEach(e=>{gl(e)}),lc=!0),Ym()}function is(e){if(!e&&e!==0)return null;const t=String(e);if(ri.has(t))return ri.get(t);const n=Um(t);return n?gl(n):null}function os(e){const t=String(e),n=Rd();if(!n.has(t)){const r=is(t),i=r?bl(r,{}):yl(t,{id:t});n.set(t,i)}return n.get(t)}function zd(e,t={}){ui();const n=typeof e=="string"||typeof e=="number"?e:e==null?void 0:e.id;if(!n&&n!==0)return null;const r=String(n),i=is(r)||(typeof e=="object"?gl(e):null),o=os(r),a=Number.isFinite(t.unlockedAt)?t.unlockedAt:Date.now(),c={...o,...typeof e=="object"?e:{},id:r,unlocked:!0,discovered:!0,progress:1,unlockedAt:(o==null?void 0:o.unlockedAt)??a,label:typeof e=="object"&&(e==null?void 0:e.name)||(o==null?void 0:o.label)||(i==null?void 0:i.name)||r},l=i?bl(i,c):yl(r,c);return l.unlocked=!0,l.discovered=!0,l.progress=1,l.unlockedAt||(l.unlockedAt=a),S.technologies.set(r,l),l}function sn(e){if(!e&&e!==0)return!1;ui();const t=os(e);return!!(t!=null&&t.unlocked)}function Gm(e){if(!e&&e!==0)return null;ui();const t=String(e),n=is(t),r=os(t),i=(n==null?void 0:n.prerequisites)||[],o=i.filter(a=>!sn(a));return{id:t,definition:n||null,state:r,unlocked:!!(r!=null&&r.unlocked),discovered:!!(r!=null&&r.discovered),prerequisites:i,missingPrerequisites:o,available:!!(r&&!r.unlocked&&o.length===0)}}function Vm(){ui();const e=[];return ri.forEach(t=>{const n=os(t.id),r=t.prerequisites.filter(i=>!sn(i));e.push({id:t.id,definition:t,state:n,unlocked:!!(n!=null&&n.unlocked),discovered:!!(n!=null&&n.discovered),available:!(n!=null&&n.unlocked)&&r.length===0,prerequisites:[...t.prerequisites],missingPrerequisites:r})}),e.sort((t,n)=>{const r=Number.isFinite(t.definition.order)?t.definition.order:0,i=Number.isFinite(n.definition.order)?n.definition.order:0;return r!==i?r-i:t.definition.name.localeCompare(n.definition.name)})}function za(e){if(!e&&e!==0)return"";const t=String(e),n=is(t);if(n!=null&&n.name)return n.name;const r=S.technologies instanceof Map?S.technologies.get(t):null;return r!=null&&r.label?r.label:t.split(/[-_]/).filter(Boolean).map(i=>i.charAt(0).toUpperCase()+i.slice(1)).join(" ")}ui();const $d=Object.freeze(["open","grassland","plains","savanna","tundra","taiga","desert","sand","wetland","coast","temperate","tropical","rainforest","jungle","alpine"]),Xm=new Set($d),Km=Object.freeze({mountain:"alpine","subpolar-forest":"taiga","coastal-temperate":"coast","coastal-tropical":"coast",wetland:"wetland",mediterranean:"grassland","mountain-forest":"alpine","tropical-grassland":"savanna","temperate-forest":"plains","tropical-forest":"rainforest",special:"temperate"});function Rn(e){return e?Xm.has(String(e).toLowerCase()):!1}function Zm(e){if(!e)return"open";const t=typeof e.openTerrainId=="string"?e.openTerrainId.toLowerCase():"";if(t&&Rn(t))return t;if(Array.isArray(e.openTerrainHints))for(const n of e.openTerrainHints){const r=typeof n=="string"?n.toLowerCase():"";if(r&&Rn(r))return r}if(typeof e.category=="string"){const n=e.category.toLowerCase(),r=Km[n];if(r&&Rn(r))return r}return"open"}function Jm(e=[]){if(!Array.isArray(e)||!e.length)return e;const t=e.map(i=>String(i||"").toLowerCase());if(!t.includes("open"))return e;const n=$d.filter(i=>i!=="open"),r=new Set;return t.forEach(i=>{i&&i!=="open"&&r.add(i)}),n.forEach(i=>r.add(i)),r.add("open"),Array.from(r)}const Qm=[{id:"lean-to",name:"Lean-to Shelter",icon:"â›º",category:"Shelter",description:"A quick shelter made from flexible saplings and a sloped roof. Offers basic protection from the elements.",allowMultiple:!0,unlock:{always:!0},requirements:{minBuilders:1,locationTags:["forest","grove"],site:{category:"forest",dimensions:{width:3.6,depth:2.1},accessClearance:{front:2.4,back:.6,left:.6,right:.6}},craftedGoods:{cord:8}},effects:{occupancy:2,comfort:1,survivability:1,demand:{firewood:-.1}},components:[{id:"foundation",name:"Ground Preparation",description:"Clear debris and level the sleeping surface, laying a base of small stones for drainage.",laborHours:4,minBuilders:1,resources:{"small stones":12,pebbles:20}},{id:"main-supports",name:"Ridge Frame & Lashings",description:"Raise forked poles and lash the ridge beam that anchors the shelter.",laborHours:6,minBuilders:1,isCore:!0,resources:{firewood:28,"plant fibers":12,cord:4}},{id:"roof",name:"Weather Shed Cover",description:"Lay overlapping boughs down the leeward slope and extend a front overhang for access.",laborHours:5,minBuilders:1,resources:{firewood:18,"plant fibers":16,cord:4}}],addons:[{id:"windbreak",name:"Windbreak Walls",description:"Add woven branch walls to shield against prevailing winds.",effects:{comfort:1,demand:{firewood:-.05}},laborHours:3,minBuilders:1,resources:{firewood:12,"plant fibers":8,cord:2}},{id:"raised-bed",name:"Raised Sleeping Platform",description:"Lift sleepers off damp ground using a lashed frame.",effects:{comfort:1},laborHours:4,minBuilders:1,resources:{firewood:10,"plant fibers":6,cord:2,"crafted goods":1}}]},{id:"crop-field",name:"Tended Crop Field",icon:"ðŸŒ¾",category:"Agriculture",description:"Tilled plots bordered by windbreaks and irrigation furrows that turn open ground into dependable harvests.",allowMultiple:!0,unlock:{buildings:[{id:"fire-pit",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["meadow","grassland","open"],site:{category:"cleared",dimensions:{width:12,depth:18},accessClearance:{front:3,back:2,left:2,right:2}},craftedGoods:{cord:18,"crafted goods":4}},effects:{supply:{grain:6,"root vegetables":4,herbs:1},demand:{"crafted goods":.6},jobs:{farm:3}},components:[{id:"clearing",name:"Brush Clearing & Stumping",description:"Pull stones, roots, and brush then mound field borders against erosion.",laborHours:10,minBuilders:3,isCore:!0,resources:{firewood:80,"small stones":40,pebbles:60,"plant fibers":24,cord:8}},{id:"furrows",name:"Tilling & Furrows",description:"Turn the topsoil, lay drainage trenches, and stake crop rows.",laborHours:9,minBuilders:2,resources:{firewood:36,pebbles:30,"plant fibers":20,cord:6,"crafted goods":2}},{id:"irrigation",name:"Irrigation Channels",description:"Line feeder ditches with stone and wattle spillways for steady watering.",laborHours:8,minBuilders:2,resources:{"small stones":50,pebbles:70,firewood:24,"plant fibers":18,cord:4}},{id:"windbreaks",name:"Windbreak Fencing",description:"Plant woven hurdles and saplings along the prevailing wind edge.",laborHours:6,minBuilders:2,resources:{firewood:48,"plant fibers":22,cord:6}}],addons:[{id:"seed-house",name:"Seed Shelter",description:"Add a small covered bin to keep seed stores dry and pest free.",effects:{storage:{grain:80,seeds:40}},laborHours:4,minBuilders:1,resources:{firewood:24,"small stones":20,"plant fibers":12,cord:4,"crafted goods":1}}]},{id:"animal-pen",name:"Timber Animal Pen",icon:"ðŸ‘",category:"Agriculture",description:"Fenced paddock with troughs and lean-tos for managing herds or work beasts.",allowMultiple:!0,unlock:{buildings:[{id:"crop-field",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["meadow","grassland","open"],site:{category:"cleared",dimensions:{width:10,depth:14},accessClearance:{front:3,back:2,left:2,right:2}},craftedGoods:{cord:22,"crafted goods":3}},effects:{supply:{food:3,hides:.8,"animal fat":.4},demand:{grain:1.5,water:2},jobs:{herd:2}},components:[{id:"postholes",name:"Postholes & Stone Footings",description:"Auger postholes and tamp stone collars to keep the fence upright.",laborHours:8,minBuilders:3,isCore:!0,resources:{"small stones":60,pebbles:70,firewood:40,"plant fibers":16,cord:6}},{id:"fencing",name:"Woven Fencing",description:"Weave rails and saplings into tight hurdles and double gates.",laborHours:9,minBuilders:2,resources:{firewood:96,"plant fibers":40,cord:12}},{id:"shelters",name:"Lean-to Shelters",description:"Raise timber sheds with thatched roofs for sick bays and shade.",laborHours:7,minBuilders:2,resources:{firewood:84,"plant fibers":32,cord:10,"crafted goods":2}},{id:"watering",name:"Troughs & Drainage",description:"Carve log troughs, stone the muddiest ground, and drain wallows.",laborHours:5,minBuilders:1,resources:{firewood:24,"small stones":30,pebbles:40,"crafted goods":1}}],addons:[{id:"milking-bay",name:"Milking Bay",description:"Build a narrow chute and stanchions for safer milking.",effects:{supply:{food:1,milk:1}},laborHours:4,minBuilders:1,resources:{firewood:28,"plant fibers":14,cord:4,"crafted goods":1}}]},{id:"granary",name:"Raised Granary",icon:"ðŸšï¸",category:"Storage",description:"Elevated grain house with ventilation floors that guards stores from damp and vermin.",allowMultiple:!0,unlock:{buildings:[{id:"crop-field",count:2}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["meadow","hill","open"],site:{category:"cleared",dimensions:{width:6,depth:8},accessClearance:{front:2.5,back:2,left:2,right:2}},craftedGoods:{cord:20,"crafted goods":5}},effects:{survivability:2,demand:{"crafted goods":.3},storage:{grain:400,food:120,seeds:80}},components:[{id:"footings",name:"Stone Piers",description:"Set squat stone pillars and pad stones to lift the floor clear of pests.",laborHours:7,minBuilders:3,isCore:!0,resources:{"small stones":90,pebbles:100,"crafted goods":1}},{id:"floor",name:"Slatted Subfloor",description:"Lay tight slats and woven reed mats that breathe without spilling grain.",laborHours:6,minBuilders:2,resources:{firewood:70,"plant fibers":34,cord:10,"crafted goods":2}},{id:"walls",name:"Boarded Walls",description:"Raise plank walls with rat guards and shingled ventilation shutters.",laborHours:7,minBuilders:2,resources:{firewood:90,"plant fibers":28,cord:8,"crafted goods":1}},{id:"roof",name:"Steep Thatch Roof",description:"Build a steep pitch roof and ridge vent to shed rain and heat.",laborHours:6,minBuilders:2,resources:{firewood:60,"plant fibers":40,cord:8}}],addons:[{id:"drying-floor",name:"Drying Loft",description:"Suspend removable lattice floors for drying herbs and seed heads.",effects:{supply:{preservedFood:1},storage:{herbs:60}},laborHours:4,minBuilders:1,resources:{firewood:32,"plant fibers":18,cord:4}}]},{id:"fire-pit",name:"Stone Fire Pit",icon:"ðŸ”¥",category:"Utility",description:"Central hearth used for cooking and warmth. Concentrates heat and reduces smoke drift.",allowMultiple:!1,unlock:{always:!0},requirements:{minBuilders:1,locationTags:["forest","grove","meadow","open"],site:{categories:["forest","cleared"],dimensions:{width:1.8,depth:1.8},accessClearance:{front:1.8,back:1.8,left:1.8,right:1.8}},craftedGoods:{"crafted goods":2}},effects:{comfort:1,supply:{cookedMeals:1.5,"hearty meal":1,"bone broth":.5,"comfort meal":.5},demand:{food:-.5,grain:-.2,"root vegetables":-.2,salt:-.1,spices:-.05},survivability:1},components:[{id:"foundation",name:"Fire Ring Base",description:"Excavate a shallow basin and line it with gravel for drainage.",laborHours:3,minBuilders:1,isCore:!0,resources:{pebbles:30}},{id:"walls",name:"Stone Ring",description:"Stack fist-sized stones to contain the fire.",laborHours:4,minBuilders:1,resources:{"small stones":40}},{id:"fireplace",name:"Cooking Grate",description:"Fashion a simple grate for pots and skewers.",laborHours:2,minBuilders:1,resources:{"crafted goods":2}}],addons:[{id:"smoke-hood",name:"Smoke Hood",description:"Channel smoke upward using lashed poles and hides.",effects:{comfort:1},laborHours:3,minBuilders:1,resources:{firewood:12,"plant fibers":6,cord:2,hides:1}},{id:"stone-benches",name:"Stone Benches",description:"Arrange stone seats around the fire for gathering.",effects:{appeal:1},laborHours:2,minBuilders:1,resources:{"small stones":16}}]},{id:"drying-rack",name:"Drying Rack",icon:"ðŸªµ",category:"Production",description:"Elevated framework to dry hides, herbs, and meat, reducing spoilage.",allowMultiple:!0,unlock:{technologies:["basic-tools"]},requirements:{minBuilders:1,locationTags:["meadow","shore","open"],site:{category:"cleared",dimensions:{width:3,depth:1.8},accessClearance:{front:1.2,back:1.2,left:1,right:1}},craftedGoods:{cord:9,"crafted goods":1}},effects:{supply:{preservedFood:1,hides:.5,"smoked provisions":1,"preserved vegetables":.5,"herbal poultice":.3,"aromatic sachet":.2},demand:{food:-.2,salt:-.2,spices:-.1,herbs:-.1},capacity:{storage:40}},components:[{id:"stilts",name:"Support Stilts",description:"Set four sturdy posts to lift the rack clear of pests.",laborHours:4,minBuilders:1,isCore:!0,resources:{firewood:22,"plant fibers":8,cord:3}},{id:"crossbeams",name:"Crossbeams & Lashings",description:"Lash horizontal beams and lattice for hanging materials.",laborHours:5,minBuilders:1,resources:{firewood:16,"plant fibers":12,cord:4,"crafted goods":1}},{id:"roof",name:"Rain Cover",description:"Stretch hides or woven mats as a simple roof.",laborHours:3,minBuilders:1,resources:{hides:1,firewood:6,"plant fibers":10,cord:2}}],addons:[{id:"smoke-channel",name:"Smoke Channel",description:"Direct smoke from a nearby fire to improve preservation.",effects:{supply:{preservedFood:.5}},laborHours:2,minBuilders:1,resources:{firewood:8,"plant fibers":6,cord:2,"crafted goods":1}}]},{id:"hunter-blind",name:"Hunter's Blind",icon:"ðŸ¹",category:"Production",description:"Concealed elevated post to improve hunting success and safety.",allowMultiple:!0,unlock:{technologies:["basic-tools"],buildings:[{id:"lean-to",count:1}]},requirements:{minBuilders:2,locationTags:["forest"],site:{category:"forest",dimensions:{width:2.4,depth:2.4},accessClearance:{front:1.8,back:1.2,left:1.5,right:1.5}},craftedGoods:{cord:14,"crafted goods":2}},effects:{supply:{food:1.5,hides:.5},survivability:1,appeal:1},components:[{id:"foundation",name:"Footings & Bracing",description:"Drive support poles deep and brace against sway.",laborHours:6,minBuilders:2,isCore:!0,resources:{firewood:36,"small stones":12,"plant fibers":10,cord:4}},{id:"floor",name:"Platform Floor",description:"Lay planks and lashings to create a stable perch.",laborHours:5,minBuilders:2,resources:{firewood:24,"plant fibers":12,cord:4,"crafted goods":2}},{id:"walls",name:"Camouflaged Walls",description:"Weave brush and hides for concealment.",laborHours:4,minBuilders:1,resources:{hides:1,firewood:12,"plant fibers":14,cord:4}},{id:"roof",name:"Weatherproof Roof",description:"Slope the roof to shed rain and snow.",laborHours:3,minBuilders:1,resources:{firewood:10,"plant fibers":8,cord:2}}],addons:[{id:"ladder",name:"Reinforced Ladder",description:"Add a safer, sturdier ladder for quick access.",effects:{safety:1},laborHours:2,minBuilders:1,resources:{firewood:10,"plant fibers":6,cord:2}}]},{id:"workshop",name:"Crafter's Workshop",icon:"ðŸ› ï¸",category:"Production",description:"Covered workspace with benches and tool storage that boosts crafting output.",allowMultiple:!0,unlock:{buildings:[{id:"fire-pit",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["meadow","open"],site:{category:"cleared",dimensions:{width:6,depth:8},accessClearance:{front:2.5,back:2,left:1.5,right:1.5}},craftedGoods:{cord:16,"crafted goods":7}},effects:{supply:{"crafted goods":2},comfort:1,maxWorkers:2},components:[{id:"foundation",name:"Leveled Pad",description:"Lay compacted earth and stone to level the workspace.",laborHours:6,minBuilders:2,isCore:!0,resources:{"small stones":30,pebbles:40}},{id:"main-supports",name:"Timber Frame",description:"Raise sturdy posts and beams to support the roof.",laborHours:8,minBuilders:3,resources:{firewood:70,"plant fibers":24,cord:6,"crafted goods":4}},{id:"walls",name:"Half Walls & Storage",description:"Add waist-high walls with shelving and tool pegs.",laborHours:6,minBuilders:2,resources:{firewood:48,"plant fibers":20,cord:6,"crafted goods":3}},{id:"roof",name:"Shingled Roof",description:"Install a plank and bark roof to keep workers dry.",laborHours:7,minBuilders:2,resources:{firewood:36,"plant fibers":16,cord:4}}],addons:[{id:"forge",name:"Charcoal Forge",description:"Adds a clay-lined forge for metalworking research.",effects:{unlocks:["metalworking-basics"],supply:{"crafted goods":1}},laborHours:6,minBuilders:2,resources:{"small stones":24,firewood:36,"plant fibers":10,cord:4,"crafted goods":3}}]},{id:"cookhouse",name:"Communal Cookhouse",icon:"ðŸ²",category:"Food Production",description:"Ventilated kitchen with racks, smoke flues, and work tables for preserving harvests at scale.",allowMultiple:!0,unlock:{buildings:[{id:"fire-pit",count:1},{id:"drying-rack",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["river","lake","shore","meadow","open"],site:{category:"cleared",dimensions:{width:6,depth:10},accessClearance:{front:3,back:2,left:2,right:2}},craftedGoods:{cord:26,"crafted goods":6}},effects:{supply:{cookedMeals:4,"hearty meal":2,"comfort meal":1,preservedFood:1},demand:{food:6,firewood:3,herbs:1,salt:.6,spices:.3},jobs:{cook:2}},components:[{id:"foundation",name:"Stone Hearth Floor",description:"Lay a mortared stone pad with drainage trenches to contain spills.",laborHours:8,minBuilders:3,isCore:!0,resources:{"small stones":120,pebbles:120,clay:30}},{id:"smokehall",name:"Smoke Hall Framing",description:"Raise stout posts and beams with smoke baffles and storage lofts.",laborHours:9,minBuilders:3,resources:{firewood:140,"plant fibers":48,cord:12,"crafted goods":3}},{id:"prep-benches",name:"Prep Benches & Racks",description:"Install butcher blocks, hanging hooks, and sloped drying racks.",laborHours:7,minBuilders:2,resources:{firewood:80,"plant fibers":26,cord:6,"crafted goods":2}},{id:"chimney",name:"Chimney & Ventilation",description:"Build a clay flue, smoke hoods, and shutters to control draft.",laborHours:6,minBuilders:2,resources:{clay:24,"small stones":60,pebbles:80,"crafted goods":2}}],addons:[{id:"cellar",name:"Cold Cellar",description:"Dig a root cellar with plank shelving beneath the cookhouse.",effects:{storage:{food:160,preservedFood:120},survivability:1},laborHours:6,minBuilders:2,resources:{"small stones":90,pebbles:100,firewood:40,"crafted goods":2}}]},{id:"smithy",name:"Charcoal Smithy",icon:"âš’ï¸",category:"Production",description:"Forge house with bellows, anvils, and quenching troughs for shaping bronze and iron.",allowMultiple:!0,unlock:{buildings:[{id:"workshop",count:1}],technologies:["metalworking-basics"]},requirements:{minBuilders:4,locationTags:["stone","ore","cliff","ridge"],site:{category:"cleared",dimensions:{width:7,depth:9},accessClearance:{front:3,back:2.5,left:2,right:2}},craftedGoods:{cord:28,"crafted goods":8}},effects:{supply:{"crafted goods":3,"bronze ingot":1},demand:{"raw ore":2,charcoal:2,firewood:1},jobs:{smith:2},storage:{"raw ore":160,charcoal:120}},components:[{id:"foundation",name:"Stone Forge Pad",description:"Excavate and lay a heatproof stone slab with drainage and slag pit.",laborHours:9,minBuilders:4,isCore:!0,resources:{"small stones":140,pebbles:160,clay:40}},{id:"forge",name:"Forge & Chimney",description:"Brick a double forge, install tuyÃ¨res, and build a high draft chimney.",laborHours:10,minBuilders:3,resources:{clay:60,"small stones":80,pebbles:120,charcoal:40,"crafted goods":4}},{id:"workbay",name:"Work Bays & Anvils",description:"Set heavy timbers, hanging racks, quench troughs, and tool chests.",laborHours:8,minBuilders:3,resources:{firewood:120,"plant fibers":36,cord:10,"crafted goods":4}},{id:"roof",name:"Ventilated Roof",description:"Raise a steep roof with smoke shutters and weatherproof shakes.",laborHours:7,minBuilders:2,resources:{firewood:90,"plant fibers":30,cord:8}}],addons:[{id:"bellows",name:"Twin Bellows",description:"Install counterweighted bellows and crank shafts for constant airflow.",effects:{supply:{"crafted goods":1}},laborHours:5,minBuilders:2,resources:{firewood:36,"plant fibers":18,cord:6,"crafted goods":2}}]},{id:"smokehouse",name:"Smokehouse",icon:"ðŸ–",category:"Production",description:"Enclosed smoking hut that preserves large batches of meat and fish.",allowMultiple:!0,unlock:{buildings:[{id:"drying-rack",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["river","lake","shore","open"],site:{category:"cleared",dimensions:{width:4.2,depth:4.2},accessClearance:{front:3,back:1.5,left:1.5,right:1.5}},craftedGoods:{cord:15,"crafted goods":4}},effects:{supply:{preservedFood:4},demand:{food:-1,firewood:.5},comfort:1},components:[{id:"foundation",name:"Stone Footing",description:"Create a sealed stone base to contain smoke.",laborHours:8,minBuilders:3,isCore:!0,resources:{"small stones":60,pebbles:60}},{id:"walls",name:"Log Walls",description:"Stack logs and seal gaps with mud and moss.",laborHours:9,minBuilders:3,resources:{firewood:140,"plant fibers":30,cord:8}},{id:"roof",name:"Conical Vent Roof",description:"Construct a vented roof to draw smoke upward.",laborHours:7,minBuilders:2,resources:{firewood:46,"plant fibers":20,cord:4}},{id:"fireplace",name:"Fire Chamber & Racks",description:"Build a separate fire chamber and install hanging racks.",laborHours:6,minBuilders:2,resources:{firewood:24,"plant fibers":10,cord:3,"crafted goods":4}}],addons:[{id:"salt-bins",name:"Salt Storage Bins",description:"Add sealed bins for brining meats before smoking.",effects:{supply:{preservedFood:1},storage:{salt:50}},laborHours:4,minBuilders:1,resources:{firewood:16,"plant fibers":8,cord:2,"crafted goods":1}}]},{id:"longhouse",name:"Longhouse",icon:"ðŸ ",category:"Shelter",description:"Large communal dwelling with raised bunks, central hearth, and smoke vents.",allowMultiple:!0,unlock:{buildings:[{id:"lean-to",count:2},{id:"fire-pit",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:4,locationTags:["meadow","open"],site:{category:"cleared",dimensions:{width:8,depth:24},accessClearance:{front:3,back:3,left:2.5,right:2.5}},craftedGoods:{cord:66,"crafted goods":13}},effects:{occupancy:12,comfort:3,survivability:2,demand:{firewood:-.5},maxWorkers:2},components:[{id:"foundation",name:"Raised Timber Floor",description:"Set heavy sills on stone footings to lift the structure.",laborHours:12,minBuilders:4,isCore:!0,resources:{firewood:200,"small stones":40,"plant fibers":40,cord:12}},{id:"main-supports",name:"Central Beams & Arches",description:"Erect tall arches and ridge poles for the expansive roof.",laborHours:14,minBuilders:4,resources:{firewood:240,"plant fibers":60,cord:16,"crafted goods":6}},{id:"walls",name:"Planked Walls & Doors",description:"Install plank walls, smoke shutters, and wide doors.",laborHours:12,minBuilders:3,resources:{firewood:180,"plant fibers":55,cord:14,"crafted goods":4}},{id:"roof",name:"Thatch & Beam Roof",description:"Layer thatch over beams with adjustable smoke vents.",laborHours:11,minBuilders:3,resources:{firewood:120,"plant fibers":80,cord:20,"crafted goods":3}},{id:"fireplace",name:"Central Hearths",description:"Construct two large hearths with stone surrounds.",laborHours:8,minBuilders:2,resources:{"small stones":80,pebbles:120,firewood:40,"plant fibers":10,cord:4}}],addons:[{id:"privacy-screens",name:"Privacy Screens",description:"Hang woven partitions for family spaces.",effects:{comfort:1,appeal:1},laborHours:4,minBuilders:1,resources:{firewood:24,"plant fibers":36,cord:10,"crafted goods":2}},{id:"insulated-roof",name:"Insulated Roof Layer",description:"Add moss and hides above the rafters to retain heat.",effects:{survivability:1,demand:{firewood:-.5}},laborHours:6,minBuilders:2,resources:{firewood:40,hides:3,"plant fibers":20,cord:6}}]},{id:"watchtower",name:"Watchtower",icon:"ðŸ›¡ï¸",category:"Defense",description:"Tall lookout tower providing advance warning of threats.",allowMultiple:!0,unlock:{buildings:[{id:"workshop",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["cliff","ridge","hill","high"],site:{category:"cleared",dimensions:{width:4,depth:4},accessClearance:{front:3,back:3,left:3,right:3}},craftedGoods:{cord:38,"crafted goods":8}},effects:{survivability:3,appeal:1,unlocks:["defense-drills"]},components:[{id:"foundation",name:"Anchored Footings",description:"Dig deep footings and backfill with stone for stability.",laborHours:10,minBuilders:3,isCore:!0,resources:{"small stones":70,pebbles:80,firewood:60,"plant fibers":20,cord:6}},{id:"main-supports",name:"Tapered Supports",description:"Raise heavy supports braced with diagonal timbers.",laborHours:12,minBuilders:3,resources:{firewood:180,"plant fibers":50,cord:14,"crafted goods":4}},{id:"floor",name:"Observation Deck",description:"Lay planked flooring with railing.",laborHours:6,minBuilders:2,resources:{firewood:80,"plant fibers":24,cord:6,"crafted goods":2}},{id:"roof",name:"Lookout Roof",description:"Add a small roof and signal brazier platform.",laborHours:5,minBuilders:2,resources:{firewood:45,"plant fibers":18,cord:4}},{id:"access",name:"Spiral Stairs",description:"Construct a spiral stair for rapid ascent.",laborHours:7,minBuilders:2,resources:{firewood:90,"plant fibers":26,cord:8,"crafted goods":2}}],addons:[{id:"signal-braziers",name:"Signal Braziers",description:"Install braziers for signaling neighboring settlements.",effects:{unlocks:["regional-alliance"]},laborHours:3,minBuilders:1,resources:{"small stones":20,firewood:24,"plant fibers":8,cord:2}}]},{id:"palisade",name:"Perimeter Palisade",icon:"ðŸªµ",category:"Defense",description:"Encircling wall of sharpened logs with fighting walkways and a reinforced gate.",allowMultiple:!1,unlock:{buildings:[{id:"watchtower",count:1}],technologies:["defense-drills"]},requirements:{minBuilders:5,locationTags:["meadow","forest","open"],site:{category:"cleared",dimensions:{width:24,depth:24},accessClearance:{front:4,back:4,left:4,right:4}},craftedGoods:{cord:60,"crafted goods":10}},effects:{survivability:4,safety:3,demand:{firewood:2,"crafted goods":1}},components:[{id:"ditch",name:"Ditch & Berm",description:"Excavate an outer ditch and throw up an inner berm for the log curtain.",laborHours:16,minBuilders:5,isCore:!0,resources:{pebbles:260,"small stones":160,firewood:120}},{id:"walls",name:"Log Curtain",description:"Set sharpened trunks shoulder to shoulder and bind them with heavy wales.",laborHours:18,minBuilders:4,resources:{firewood:420,"plant fibers":120,cord:36,"crafted goods":6}},{id:"walkway",name:"Fighting Walkway",description:"Lay interior catwalks with railing and ladder access for sentries.",laborHours:12,minBuilders:3,resources:{firewood:180,"plant fibers":48,cord:12,"crafted goods":4}},{id:"gate",name:"Reinforced Gatehouse",description:"Build a double-door gate with drop bar, murder holes, and flanking platforms.",laborHours:14,minBuilders:3,resources:{firewood:220,"plant fibers":60,cord:18,"small stones":80,"crafted goods":6}}],addons:[{id:"chevaux-de-frise",name:"Chevaux-de-frise",description:"Deploy portable spiked barriers outside the gate to break charges.",effects:{safety:1},laborHours:6,minBuilders:2,resources:{firewood:120,"plant fibers":40,cord:12}}]}],eh=Qm.map(e=>{var n;if(!((n=e==null?void 0:e.requirements)!=null&&n.locationTags))return e;const t=Jm(e.requirements.locationTags);return t===e.requirements.locationTags?e:{...e,requirements:{...e.requirements,locationTags:t}}}),th=new Set(["ore","stone"]);function nh(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}function Od(e){if(!e||!Array.isArray(e.types))return{forest:0,cleared:0};const t=nh(Wi)**2||0;let n=0,r=0;return e.types.forEach(i=>{i.forEach(o=>{o==="forest"?n+=1:(th.has(o)||Rn(o))&&(r+=1)})}),{forest:n*t,cleared:r*t}}function Zs(e){if(!e||e.siteCapacities&&typeof e.siteCapacities=="object")return e;const t=Od(e.map);return e.siteCapacities=t,e.id&&S.updateItem("locations",{id:e.id,siteCapacities:t}),e}function cc(e,t,n=S.time.season,r=Date.now(),i=null){var x;const o=((x=wn(t))==null?void 0:x.features)||[],a=gf(t),c=Er,l=li,{xStart:d,yStart:u}=No(c,l),{world:m,map:h}=Mo({width:c,height:l,seed:r,season:n,xStart:d,yStart:u,worldSettings:i,startingBiomeId:t??null});h!=null&&h.worldSettings&&typeof h.worldSettings=="object"&&(h.worldSettings.startingBiomeId||(h.worldSettings.startingBiomeId=t));const p=Od(h),w={id:e,biome:t,startingBiomeId:t,features:o,pointsOfInterest:a,map:h,world:m,siteCapacities:p,worldSettings:h.worldSettings};return S.addItem("locations",w),w}function Vi(){return[...S.locations.values()].map(e=>Zs(e))}function rh(e){if(!e){const n=Vi()[0];return n&&Zs(n).siteCapacities||{forest:0,cleared:0}}const t=S.getItem("locations",e);return t?Zs(t).siteCapacities||{forest:0,cleared:0}:{forest:0,cleared:0}}function ih(e=[]){S.people instanceof Map?S.people.clear():S.people=new Map,e.forEach(t=>{t!=null&&t.id&&S.people.set(t.id,{...t})}),_d()}function _d(){const e=[...S.people.values()],t=e.length,n=e.filter(l=>(l.age??0)>=16).length,r=t-n,i=e.filter(l=>l.job).length,o=t-i,a=e.filter(l=>l.home).length,c=t-a;S.peopleStats={total:t,adults:n,children:r,employed:i,unemployed:o,housed:a,homeless:c}}function Pd(){_d()}function Dd(){return S.peopleStats||{total:0,adults:0,children:0,employed:0,unemployed:0,housed:0,homeless:0}}const Gr=new Map;let Js=!1,fo=null,mo=!1,dc=!1;function ga(e){dc||(console.warn("Local storage is unavailable; using in-memory storage instead.",e),dc=!0)}function oh(){if(typeof window<"u"&&window&&"localStorage"in window)try{return window.localStorage}catch(e){return ga(e),null}if(typeof globalThis<"u"&&"localStorage"in globalThis)try{return globalThis.localStorage}catch(e){return ga(e),null}try{if(typeof localStorage<"u")return localStorage}catch(e){ga(e)}return null}function as(e){e&&ga(e),fo=null,mo=!1,Js=!0}function wl(){if(Js)return mo?fo:null;Js=!0,mo=!1,fo=null;const e=oh();if(!e)return null;try{const t="__fantasy-survival-storage-test__";e.setItem(t,t),e.removeItem(t),fo=e,mo=!0}catch(t){as(t)}return mo?fo:null}function xl(e){const t=wl();if(t)try{const n=t.getItem(e);return n==null?(Gr.delete(e),null):(Gr.set(e,n),n)}catch(n){as(n)}return Gr.has(e)?Gr.get(e):null}function Eo(e,t){const n=wl();if(n)try{return n.setItem(e,t),Gr.set(e,t),!0}catch(r){as(r)}return Gr.set(e,t),!1}function ah(e){const t=wl();if(t)try{t.removeItem(e)}catch(n){as(n)}Gr.delete(e)}const $a="fantasy-survival-save";function er(){try{const e=S.serialize();Eo($a,JSON.stringify(e))}catch(e){console.error("Failed to save game",e)}}async function sh(e,t){if(!e)return{changed:!1,primarySeed:null};const n=Array.isArray(e)?e:typeof e=="object"?Object.entries(e):[];let r=!1,i=null;return await Promise.all(n.map(async o=>{if(!Array.isArray(o)||o.length<2)return;const[,a]=o;if(!a||typeof a!="object")return;const c=a.map&&typeof a.map=="object"?a.map:null;let l;a.worldSettings&&typeof a.worldSettings=="object"?l=a.worldSettings:c&&c.worldSettings&&typeof c.worldSettings=="object"?(l=c.worldSettings,a.worldSettings=l,r=!0):(l={},a.worldSettings=l,r=!0);const d=(c&&c.seed!==void 0?c.seed:void 0)??(l&&l.seed!==void 0?l.seed:void 0)??(t&&t.seed!==void 0?t.seed:void 0)??"",u=typeof d=="string"?d:String(d??""),m=await ns(u);c&&(c.seed===void 0&&(c.seed=d,r=!0),c.seedHash!==m.hex&&(c.seedHash=m.hex,r=!0),(!Array.isArray(c.seedLanes)||c.seedLanes.length!==8)&&(c.seedLanes=Array.from(m.lanes),r=!0)),(!l.seed||l.seed!==(c==null?void 0:c.seed))&&(l.seed=(c==null?void 0:c.seed)??d??m.raw,r=!0),l.seedHash!==m.hex&&(l.seedHash=m.hex,r=!0),(!Array.isArray(l.seedLanes)||l.seedLanes.length!==8)&&(l.seedLanes=Array.from(m.lanes),r=!0);const h=a.startingBiomeId||l.startingBiomeId||a.biome||null;if(h&&l.startingBiomeId!==h&&(l.startingBiomeId=h,r=!0),h&&a.startingBiomeId!==h&&(a.startingBiomeId=h,r=!0),i||(i={seed:(c==null?void 0:c.seed)??d??m.raw,canonical:m,startingBiome:h}),c&&(!c.worldSettings||typeof c.worldSettings!="object"))c.worldSettings={...l},r=!0;else if(c){const p=c.worldSettings;let w=!1;p.seedHash!==l.seedHash&&(p.seedHash=l.seedHash,w=!0),(!Array.isArray(p.seedLanes)||p.seedLanes.length!==8)&&(p.seedLanes=Array.from(m.lanes),w=!0),l.seed!==void 0&&p.seed!==l.seed&&(p.seed=l.seed,w=!0),h&&p.startingBiomeId!==h&&(p.startingBiomeId=h,w=!0),w&&(r=!0)}})),{changed:r,primarySeed:i}}async function lh(e){if(!e||typeof e!="object")return{data:e,changed:!1};const t=e.worldSettings&&typeof e.worldSettings=="object"?e.worldSettings:null,{changed:n,primarySeed:r}=await sh(e.locations,t);let i=n;return r&&t&&(t.seed!==r.seed&&(t.seed=r.seed,i=!0),t.seedHash!==r.canonical.hex&&(t.seedHash=r.canonical.hex,i=!0),(!Array.isArray(t.seedLanes)||t.seedLanes.length!==8)&&(t.seedLanes=Array.from(r.canonical.lanes),i=!0),r.startingBiome&&t.startingBiomeId!==r.startingBiome&&(t.startingBiomeId=r.startingBiome,i=!0)),{data:e,changed:i}}async function ch(){var e,t,n,r,i,o,a;try{const c=xl($a);if(!c)return!1;const l=JSON.parse(c),{data:d,changed:u}=await lh(l);if(u)try{Eo($a,JSON.stringify(d))}catch(h){console.warn("Failed to persist migrated save data",h)}S.deserialize(d),ui();let m=!1;for(const h of S.locations.values()){const p=h.map&&typeof h.map=="object"?h.map:{},w=h.worldSettings||p.worldSettings||S.worldSettings||null,x=((e=h.world)==null?void 0:e.dimensions)||{},C=Math.max(1,Math.trunc(x.width??p.width??((n=(t=p.tiles)==null?void 0:t[0])==null?void 0:n.length)??Er)),M=Math.max(1,Math.trunc(x.height??p.height??((r=p.tiles)==null?void 0:r.length)??li)),{xStart:T,yStart:A}=No(C,M),E=(p.seed!==void 0?p.seed:void 0)??(w&&w.seed!==void 0?w.seed:void 0)??((o=(i=h.world)==null?void 0:i.seed)==null?void 0:o.raw)??null,R=typeof E=="string"?E:E!=null?String(E):"";let L=p.seedInfo;(!L||!Array.isArray(L.lanes)||L.lanes.length<8)&&(L=await ns(R),p.seedInfo=L,m=!0);let W=h.world;!W&&p.world&&(W=p.world,h.world=W);const D=Number.isFinite(p.xStart)?Math.trunc(p.xStart):T,V=Number.isFinite(p.yStart)?Math.trunc(p.yStart):A,P=p.viewport||null,O=p.season??S.time.season;if(W)if(!p.tiles||!p.types){const s=si(W,{seedInfo:L,seedString:R,season:O,xStart:D,yStart:V,viewport:P,worldSettings:w});h.map={...p,...s,waterLevel:(p==null?void 0:p.waterLevel)??s.waterLevel??null},m=!0}else h.map.world=W,!h.map.seedInfo&&L&&(h.map.seedInfo=L,m=!0);else{const{world:s,map:G}=Mo({width:C,height:M,seed:L,season:O,xStart:D,yStart:V,viewport:P,worldSettings:w,startingBiomeId:h.biome??null});W=s,h.world=W,h.map={...G,waterLevel:(p==null?void 0:p.waterLevel)??G.waterLevel??null},m=!0}h.map.seed||(h.map.seed=R||String(Date.now()),m=!0),!h.worldSettings&&((a=h.map)!=null&&a.worldSettings)&&(h.worldSettings=h.map.worldSettings,m=!0),!S.worldSettings&&w&&(S.worldSettings=w)}if(m)try{er()}catch(h){console.warn("Failed to persist regenerated world data",h)}return Pd(),ds(),!0}catch(c){return console.error("Failed to load game",c),!1}}function dh(){try{ah($a)}catch(e){console.warn("Failed to clear saved game data.",e)}}const Bo=[{id:"hunting",name:"Hunting",description:"Tracking, stalking, and harvesting wild game.",baseRate:1.1,defaultComplexity:45,diminishing:.9,startLevel:5},{id:"tracking",name:"Tracking",description:"Reading prints, scat, and disturbances to follow prey or intruders.",baseRate:1,defaultComplexity:40,diminishing:.85,startLevel:5},{id:"foraging",name:"Foraging",description:"Identifying edible and medicinal plants in the wild.",baseRate:.95,defaultComplexity:32,diminishing:.75,startLevel:5},{id:"gathering",name:"Gathering",description:"Collecting loose resources such as branches, stone, and salvage.",baseRate:.9,defaultComplexity:24,diminishing:.7,startLevel:5},{id:"fishing",name:"Fishing",description:"Casting nets, setting lines, and harvesting aquatic life.",baseRate:.96,defaultComplexity:34,diminishing:.82,startLevel:5},{id:"agriculture",name:"Agriculture",description:"Cultivating crops, tending soil, and rotating fields for food security.",baseRate:.94,defaultComplexity:42,diminishing:.8,startLevel:5},{id:"herbalism",name:"Herbalism",description:"Harvesting, preparing, and preserving medicinal plants.",baseRate:.92,defaultComplexity:36,diminishing:.78,startLevel:5},{id:"woodcutting",name:"Tree Felling",description:"Cutting timber, pruning, and shaping wood.",baseRate:1,defaultComplexity:40,diminishing:.95,startLevel:5},{id:"carpentry",name:"Carpentry",description:"Working seasoned lumber into beams, furniture, and fittings.",baseRate:.98,defaultComplexity:44,diminishing:.9,startLevel:5},{id:"masonry",name:"Stone Masonry",description:"Shaping, laying, and mortaring stone for durable structures.",baseRate:.92,defaultComplexity:50,diminishing:.88,startLevel:5},{id:"mining",name:"Mining",description:"Extracting ore, stone, and minerals safely from the earth.",baseRate:.9,defaultComplexity:52,diminishing:.95,startLevel:5},{id:"smelting",name:"Smelting",description:"Refining ore in a furnace to produce workable metals.",baseRate:.88,defaultComplexity:56,diminishing:.9,startLevel:5},{id:"smithing",name:"Smithing",description:"Forging, shaping, and tempering metal tools and weapons.",baseRate:.9,defaultComplexity:58,diminishing:.92,startLevel:5},{id:"leatherworking",name:"Leatherworking",description:"Tanning hides and sewing them into garments, armor, and goods.",baseRate:.9,defaultComplexity:40,diminishing:.82,startLevel:5},{id:"weaving",name:"Weaving",description:"Spinning fibers and weaving textiles for clothing and trade.",baseRate:.92,defaultComplexity:42,diminishing:.8,startLevel:5},{id:"pottery",name:"Pottery",description:"Forming clay vessels and firing them for storage and trade.",baseRate:.88,defaultComplexity:46,diminishing:.85,startLevel:5},{id:"crafting",name:"General Crafting",description:"Hand crafting tools, garments, and trade goods.",baseRate:.92,defaultComplexity:36,diminishing:.85,startLevel:5},{id:"cooking",name:"Cooking",description:"Preparing meals, preserving food, and balancing flavours.",baseRate:.94,defaultComplexity:30,diminishing:.76,startLevel:5},{id:"swimming",name:"Swimming",description:"Crossing rivers, lakes, and flooded ground without aid.",baseRate:.8,defaultComplexity:38,diminishing:1.2,startLevel:1},{id:"construction",name:"Construction",description:"Coordinating and executing building projects.",baseRate:.9,defaultComplexity:44,diminishing:1,startLevel:5},{id:"combat",name:"Combat Readiness",description:"Armed drills, patrol discipline, and tactical awareness.",baseRate:1.05,defaultComplexity:55,diminishing:1.1,startLevel:5}],uh=new Map(Bo.map(e=>[e.id,e])),fh={hunting:"hunting",gathering:"gathering",farming:"agriculture",herding:"agriculture",crafting:"crafting",cooking:"cooking",smithing:"smithing",building:"construction",combat:"combat"};function jd(){return S.proficiencies instanceof Map||(S.proficiencies=new Map),Bo.forEach(e=>{S.proficiencies.has(e.id)||S.proficiencies.set(e.id,{id:e.id,level:e.startLevel??1,lastComplexity:e.defaultComplexity,lastUpdated:Date.now()})}),S.proficiencies}function Wd(e){const t=jd(),n=uh.get(e),r=t.get(e);return n?{id:n.id,name:n.name,description:n.description,level:(r==null?void 0:r.level)??n.startLevel??1,lastComplexity:(r==null?void 0:r.lastComplexity)??n.defaultComplexity}:{id:e,name:e,level:(r==null?void 0:r.level)??1,lastComplexity:(r==null?void 0:r.lastComplexity)??0}}function qd(e){return Wd(e).level}function mh(){return jd(),Bo.map(e=>Wd(e.id))}function hh(e){return fh[e]||null}const ph=new Map(Bo.map(e=>[e.id,e])),Oa=["Alden","Bram","Cedric","Doran","Eamon","Gareth","Hadrian","Ivor","Lysander","Marek","Niall","Oren","Percival","Quentin","Rowan","Silas","Theron","Ulric","Varek","Wystan"],_a=["Aislin","Bria","Celes","Daphne","Elowen","Fiora","Gwyn","Helena","Isolde","Junia","Kaela","Lira","Mira","Nerine","Odette","Petra","Quilla","Rhosyn","Selene","Thalia","Vessa","Wren"],uc=["Amberfall","Blackbriar","Coppervein","Dawnbreak","Eldercrest","Frostmere","Galehart","Hawthorne","Ironwood","Lakeshore","Moonridge","Nightbloom","Oakenshield","Riversong","Stormwatch","Thornfield","Umberlyn","Valewind","Wilderose","Yarwick"],gh={hunting:"spent adolescence shadowing veteran hunters through the border woods",tracking:"learned to read faint trails while running long scouting patrols",foraging:"studied plant lore from a kindly travelling herbalist",gathering:"knows how to comb the wilds for every loose branch or stone",fishing:"worked the riverboats casting nets since childhood",agriculture:"tended terraced fields with extended kin back home",herbalism:"apprenticed under a village apothecary drying roots and leaves",woodcutting:"was raised among timber camps and swung an axe before dawn each day",carpentry:"served as a carpenterâ€™s apprentice crafting beams and joints",masonry:"helped raise keep walls from painstakingly cut stone",mining:"hauled carts through narrow mines for many seasons",smelting:"kept smoky bloomery furnaces stoked for a merchant caravan",smithing:"apprenticed under a travelling blacksmith at a roaring forge",leatherworking:"kept tannery vats bubbling and pliable back in town",weaving:"learned the rhythm of the loom from a patient aunt",pottery:"spent years at the wheel shaping clay for market stalls",crafting:"keeps nimble hands busy fashioning useful trinkets",cooking:"ran a crowded cookfire for a mercenary band",swimming:"ferried messages by swimming swift rivers unassisted",construction:"coordinated work crews to raise palisades and scaffolds",combat:"trained relentlessly with the militia in formation drills"},bh={hunting:"has an aversion to gore and drawn-out chases",tracking:"struggles to focus on faint signs in the underbrush",foraging:"mixes up similar herbs unless closely guided",gathering:"tires quickly hauling loose salvage",fishing:"gets seasick even on placid waters",agriculture:"suffers from pollen that blankets the spring fields",herbalism:"sneezes constantly around drying herbs",woodcutting:"worries about misjudging a treeâ€™s fall",carpentry:"fumbles with precise joinery and measurements",masonry:"finds hefting stone exhausting after a short while",mining:"feels uneasy deep underground",smelting:"coughs in the heavy furnace smoke",smithing:"wilts in the forge heat",leatherworking:"never got used to the tannery stench",weaving:"grows impatient at the loom",pottery:"dislikes the feel of wet clay under their nails",crafting:"prefers not to fuss with fine details",cooking:"second-guesses seasoning and timing",swimming:"still remembers nearly drowning as a child",construction:"struggles with heights and scaffolding",combat:"hesitates when blades are drawn"},yh={hunting:"keeps a journal of animal movements around camp",tracking:"enjoys mapping the prints discovered near the settlement",foraging:"collects unusual berries and edible roots for fun",fishing:"mends nets and whittles floats during downtime",agriculture:"experiments with seed rows in spare plots",herbalism:"presses herbs into journals to study them later",carpentry:"carves small keepsakes from leftover lumber",masonry:"sketches arch designs on scrap parchment",smithing:"tinkers with broken tools to see how they are made",cooking:"tries new spice blends at the communal hearth",weaving:"braids cordage into intricate patterns",pottery:"shapes clay charms and beads to trade with others",leatherworking:"crafts small pouches for friends and family",combat:"keeps weapon drills sharp even after duties end"},wh={male:{subject:"He",object:"him",possessive:"his"},female:{subject:"She",object:"her",possessive:"her"}};let Ud=1;function xh(e){if(e==null)return Math.random;let t=typeof e=="number"?e:0;if(Number.isNaN(t)&&(t=0),typeof e=="string")for(let n=0;n<e.length;n++)t=t+e.charCodeAt(n)*13>>>0;return t=(t||Date.now())>>>0,function(){t+=1831565813;let r=t;return r=Math.imul(r^r>>>15,r|1),r^=r+Math.imul(r^r>>>7,r|61),((r^r>>>14)>>>0)/4294967296}}function Zo(e,t,n){const r=Math.ceil(t),i=Math.floor(n);return Math.floor(e()*(i-r+1))+r}function vh(e,t,n){const r=e==="female"?n.female:n.male;r.available.length===0&&(r.available=[...r.source]);const i=Math.floor(t()*r.available.length),[o]=r.available.splice(i,1);return o}function Sh(e=[]){const t=e.filter(Boolean);if(!t.length)return"";if(t.length===1)return t[0];if(t.length===2)return`${t[0]} and ${t[1]}`;const n=t.slice(0,-1).join(", "),r=t[t.length-1];return`${n}, and ${r}`}function kr(e){var t;return((t=ph.get(e))==null?void 0:t.name)||e}function Mh(e){return gh[e]||`has a knack for ${kr(e).toLowerCase()}`}function kh(e){return bh[e]||`struggles with ${kr(e).toLowerCase()}`}function Ch(e){return yh[e]||`enjoys practising ${kr(e).toLowerCase()} during quiet moments`}function Eh(e){const t={},n=Bo.map(h=>h.id);n.forEach(h=>{t[h]=30+Math.round(e()*20)});const r=[...n],i=(h,p=new Set)=>{const w=r.filter(C=>!p.has(C)),x=[];for(let C=0;C<h&&w.length;C++){const M=Math.floor(e()*w.length),[T]=w.splice(M,1);p.add(T),x.push(T)}return x},o=new Set,a=i(2,o),c=i(1,o);a.forEach(h=>{t[h]=70+Math.round(e()*20)}),c.forEach(h=>{t[h]=10+Math.round(e()*12)});const l=new Set(a);e()>.4&&i(1,new Set([...o,...l])).forEach(p=>l.add(p));const d=a.map(h=>({id:h,name:kr(h),level:t[h],reason:Mh(h)})),u=c.map(h=>({id:h,name:kr(h),level:t[h],reason:kh(h)})),m=Array.from(l).filter(h=>!c.includes(h)).map(h=>({id:h,label:kr(h),reason:Ch(h)}));return{skillRatings:t,talents:d,deficiencies:u,interests:m}}function Vr({sex:e,age:t,surname:n,householdId:r,rng:i}){const o=Vr.namePools||{male:{available:[...Oa],source:Oa},female:{available:[..._a],source:_a}};Vr.namePools=o;const a=vh(e,i,o),c=`pop-${String(Ud++).padStart(3,"0")}`,{skillRatings:l,talents:d,deficiencies:u,interests:m}=Eh(i);return{id:c,givenName:a,surname:n,name:`${a} ${n}`,age:t,sex:e,householdId:r,relationships:[],family:[],interests:m,talents:d,deficiencies:u,skillRatings:l,backstory:"",job:null,assignment:null}}function fc(e,t,n,r){e.relationships.some(i=>i.id===t.id&&i.relation===n)||e.relationships.push({id:t.id,relation:n}),t.relationships.some(i=>i.id===e.id&&i.relation===r)||t.relationships.push({id:e.id,relation:r})}function Th(e,t){if(!e.length)return"";const n=e.map(r=>{var i,o;return((i=t.get(r.id))==null?void 0:i.givenName)||((o=t.get(r.id))==null?void 0:o.name)}).filter(Boolean);return n.length?n.length===1?n[0]:`${n.length} children (${n.join(", ")})`:""}function Ah(e){const t=new Map(e.map(n=>[n.id,n]));e.forEach(n=>{var T,A;const r=wh[n.sex]||{subject:"They",possessive:"their"},i=n.relationships.find(E=>E.relation==="spouse"),o=n.relationships.filter(E=>E.relation==="parent"),a=n.relationships.filter(E=>E.relation==="child"),c=i?((T=t.get(i.id))==null?void 0:T.givenName)||((A=t.get(i.id))==null?void 0:A.name):null,l=o.map(E=>{var R,L;return((R=t.get(E.id))==null?void 0:R.givenName)||((L=t.get(E.id))==null?void 0:L.name)}).filter(Boolean),d=Th(a,t),u=n.talents[0],m=n.deficiencies[0],h=n.interests[0],p=[];l.length&&p.push(`grew up learning from ${Sh(l)}`),c&&p.push(`now shares a home with ${c}`),d&&p.push(`looks after ${d}`),p.length||p.push("carved out a life on the frontier with little help");const w=u?`${r.subject} ${u.reason}, honing ${r.possessive} ${u.name.toLowerCase()} talents.`:`${r.subject} applies a steady hand to any task at hand.`,x=m?`However, ${r.subject.toLowerCase()} ${m.reason}, so ${r.subject.toLowerCase()} prefers others handle ${m.name.toLowerCase()} when possible.`:"",C=h?`In quieter moments, ${r.subject.toLowerCase()} ${h.reason}.`:"",M=`${n.name} ${p.join(" and ")}. ${w} ${x} ${C}`.replace(/\s+/g," ").trim();n.backstory=M,n.family=n.relationships.map(E=>({...E}))})}function Nh(e,t){const n=[],r=[],i=[...uc],o=()=>{i.length||i.push(...uc);const l=Math.floor(t()*i.length);return i.splice(l,1)[0]},a=Math.max(1,Math.min(Math.floor(e/3),Math.floor(e/2)));for(let l=0;l<a&&n.length+2<=e;l++){const d=o(),u=`household-${l+1}`,m=Vr({sex:"male",age:Zo(t,20,45),surname:d,householdId:u,rng:t}),h=Vr({sex:"female",age:Zo(t,18,42),surname:d,householdId:u,rng:t});r.push({id:u,surname:d,adults:[m,h],children:[]}),n.push(m,h)}let c=r.length;for(;n.length<e;)if(r.length&&t()<.7){const d=r[Math.floor(t()*r.length)],u=t()<.5?"male":"female",m=Zo(t,14,Math.min(22,45)),h=Vr({sex:u,age:m,surname:d.surname,householdId:d.id,rng:t});d.children.push(h),n.push(h)}else{const d=o(),u=`household-${++c}`,m=t()<.5?"male":"female",h=Zo(t,18,45),p=Vr({sex:m,age:h,surname:d,householdId:u,rng:t});r.push({id:u,surname:d,adults:[p],children:[]}),n.push(p)}return r.forEach(l=>{if(l.adults.length>=2){const[d,u]=l.adults;fc(d,u,"spouse","spouse")}l.children.forEach(d=>{l.adults.forEach(u=>{fc(u,d,"parent","child")})})}),n}function Fh(e,t={}){const n=Math.max(1,Math.trunc(Number(e)||0)),r=xh(t.seed);Ud=1,Vr.namePools={male:{available:[...Oa],source:Oa},female:{available:[..._a],source:_a}};const i=Nh(n,r);return Ah(i),ih(i),i}function Bh(e,t={}){var u;const n=Array.isArray(t.preferredSkills)&&t.preferredSkills.length?t.preferredSkills:[t.id];let r=n[0],i=Number.MIN_SAFE_INTEGER;n.forEach(m=>{var p;const h=Number((p=e.skillRatings)==null?void 0:p[m]);Number.isFinite(h)&&h>i&&(r=m,i=h)}),Number.isFinite(i)||(i=Number((u=e.skillRatings)==null?void 0:u[r])||0);let o=i;const a=(e.talents||[]).some(m=>m.id===r),c=(e.interests||[]).some(m=>m.id===r),l=(e.deficiencies||[]).some(m=>m.id===r);a&&(o+=7),c&&(o+=5),l&&(o-=12);const d=Math.min(6,Math.max(0,(e.age||0)-20)*.3);return o=Math.max(0,o+d),{score:o,focusSkill:r}}function Yd(e={},t=[]){S.people instanceof Map||(S.people=new Map);const n=Array.isArray(t)?t:[],r={},i=[],o=new Set;return S.people.forEach(a=>{a&&(a.job=null,a.assignment&&delete a.assignment,!Array.isArray(a.relationships)&&Array.isArray(a.family)&&(a.relationships=[...a.family]),(a.age||0)>=16&&i.push(a))}),n.forEach(a=>{const c=Math.max(0,Math.trunc(Number((e==null?void 0:e[a.id])??0)));if(!c){r[a.id]=[],e&&(e[a.id]=0);return}const d=i.filter(u=>!o.has(u.id)).map(u=>({person:u,...Bh(u,a)})).sort((u,m)=>m.score!==u.score?m.score-u.score:m.person.age!==u.person.age?m.person.age-u.person.age:u.person.name.localeCompare(m.person.name)).slice(0,c);r[a.id]=[],d.forEach(u=>{const{person:m,score:h,focusSkill:p}=u;m.job=a.id,m.assignment={jobId:a.id,score:h,focusSkill:p},o.add(m.id),r[a.id].push({id:m.id,name:m.name,age:m.age,sex:m.sex,score:Math.round(h*10)/10,focusSkill:p,focusSkillName:kr(p)})}),e&&(e[a.id]=r[a.id].length)}),S.people.forEach((a,c)=>{const l=Array.isArray(a.relationships)?a.relationships:Array.isArray(a.family)?[...a.family]:[];S.people.set(c,{...a,relationships:l,family:l,assignment:a.job?a.assignment:null})}),Pd(),r}function Lh(){if(!(S.people instanceof Map))return{};const e={};return S.people.forEach(t=>{if(!(t!=null&&t.job))return;e[t.job]||(e[t.job]=[]);const n=t.assignment||{};e[t.job].push({id:t.id,name:t.name,age:t.age,sex:t.sex,score:n.score!=null?Math.round(n.score*10)/10:null,focusSkill:n.focusSkill||null,focusSkillName:n.focusSkill?kr(n.focusSkill):null})}),Object.values(e).forEach(t=>{t.sort((n,r)=>{const i=n.score??0,o=r.score??0;return o!==i?o-i:n.name.localeCompare(r.name)})}),e}const ci=[{id:"gather",label:"Gatherers",description:"Collect forage, firewood, and loose materials from the surrounding area.",preferredSkills:["foraging","gathering","herbalism","agriculture","woodcutting","mining"]},{id:"hunt",label:"Hunters",description:"Track game to keep the settlement supplied with meat and hides.",preferredSkills:["hunting","tracking","fishing","swimming"]},{id:"farm",label:"Farmers",description:"Tend crop fields, manage irrigation, and rotate plantings for steady harvests.",preferredSkills:["agriculture","herbalism","gathering"]},{id:"herd",label:"Herders",description:"Raise livestock, muck pens, and keep breeding stock healthy.",preferredSkills:["agriculture","hunting","herbalism"]},{id:"craft",label:"Crafters",description:"Maintain tools, weave cordage, and assemble needed goods.",preferredSkills:["crafting","carpentry","smithing","weaving","pottery","leatherworking","cooking","smelting"]},{id:"cook",label:"Cooks",description:"Prepare meals, smoke provisions, and keep communal kitchens stocked.",preferredSkills:["cooking","herbalism","crafting"]},{id:"smith",label:"Smiths",description:"Work the forge to shape metal fittings, tools, and weapons.",preferredSkills:["smithing","smelting","crafting"]},{id:"build",label:"Builders",description:"Raise new structures and shore up existing shelters.",preferredSkills:["construction","carpentry","masonry","smithing"]},{id:"guard",label:"Guards",description:"Keep watch for danger and respond to hostile threats.",preferredSkills:["combat","hunting","tracking"]}];function Rh(){if((!S.jobs||typeof S.jobs!="object")&&(S.jobs={}),Object.prototype.hasOwnProperty.call(S.jobs,"scavenge")){const e=Math.max(0,Number(S.jobs.scavenge)||0);S.jobs.gather=Math.max(0,(S.jobs.gather||0)+e),delete S.jobs.scavenge}}function vl(){(!S.jobSettings||typeof S.jobSettings!="object")&&(S.jobSettings={}),ci.forEach(e=>{const t=S.jobSettings[e.id],n=Number.isFinite(t==null?void 0:t.workdayHours)?t.workdayHours:10;S.jobSettings[e.id]={workdayHours:Math.max(1,Math.round(n))}})}function Gd(){Rh(),vl(),ci.forEach(e=>{const t=Number(S.jobs[e.id]);S.jobs[e.id]=Number.isFinite(t)&&t>0?Math.trunc(t):0})}function Vd(){return ci.map(e=>({...e}))}function ss(){Gd();const e=Yd(S.jobs,ci)||{},t=Dd().adults||0,n=ci.map(o=>({...o,assigned:S.jobs[o.id]||0,workdayHours:Sl(o.id),roster:e[o.id]||[]})),r=n.reduce((o,a)=>o+a.assigned,0),i=Math.max(0,t-r);return{assignments:n,adults:t,assigned:r,laborer:i}}function Ih(){const e=ss(),t={};return e.assignments.forEach(n=>{t[n.id]=n.assigned}),t.laborer=e.laborer,t}function Hh(e,t){if(Gd(),e==="laborer")return;const n=Dd().adults||0,r=Object.entries(S.jobs).filter(([a])=>a!==e).reduce((a,[,c])=>a+c,0),i=Math.max(0,n-r),o=Math.max(0,Math.trunc(Number.isFinite(t)?t:0));S.jobs[e]=Math.max(0,Math.min(o,i)),Yd(S.jobs,ci),er()}function Sl(e){var r;vl();const t=(r=S.jobSettings)==null?void 0:r[e],n=Number.isFinite(t==null?void 0:t.workdayHours)?t.workdayHours:10;return Math.max(1,Math.round(n))}function zh(e,t){if(vl(),!ci.find(r=>r.id===e))return;const n=Math.max(4,Math.min(16,Math.round(Number.isFinite(t)?t:10)));S.jobSettings[e]={workdayHours:n},er()}const $h={"stone-hand-axe":300,"bronze-axe":800,"iron-axe":1500};function Oh(e=0,t="temperate-broadleaf"){var o;let n="stone-hand-axe";sn("bronze-tools")&&(n="bronze-axe"),sn("iron-tools")&&(n="iron-axe");const r=$h[n]||0,i=((o=wn(t))==null?void 0:o.woodMod)??1;return e*r*i}const _h=50,Ph=.8,Dh=_h*Ph,jh=[{name:"firewood",weight:5},{name:"food",weight:1},{name:"small stones",weight:2},{name:"pebbles",weight:1}],Wh={firewood:.25,food:.4,"small stones":.2,pebbles:.15},qh=.95,Uh=3,Yh=.35,Gh=.5,Vh=.5,Xh=.3;function Kh(e){const t=jh.find(n=>n.name===e);return t?t.weight:1}function Zh(e,t){const n={};return Object.entries(e).forEach(([r,i])=>{n[r]=i*t}),n}function Jh(e,t){return e[t]||(e[t]={supply:0,demand:0}),e[t]}function Xd(e,t,n){if(!Number.isFinite(n)||n===0)return;const r=Jh(e,t);n>0?r.supply+=n:r.demand+=Math.abs(n)}const Qh={gather:"gathering",hunt:"hunting",farm:"farming",herd:"herding",craft:"crafting",cook:"cooking",smith:"smithing"},ep={gather:"gathering",hunt:"hunting",farm:"agriculture",herd:"agriculture",craft:"crafting",cook:"cooking",smith:"smithing"};function Qs(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,e)):t}function tp(e){const n=Number.isFinite(e)?Math.max(0,e):50;if(n>=50){const i=(n-50)/50;return 1+Qs(i,0,1.6)*.6}const r=(50-n)/50;return Qs(1-r*.6,.4,1)}function np(e){if(!e)return 1;const t=qd(e);return Number.isFinite(t)?.55+Qs(t,1,100)/90:1}function rp(e,t,n){if(t!=null&&t.focusSkill)return t.focusSkill;if(n){const r=hh(n);if(r)return r}return ep[e]||n||null}function ip(e){const t=Lh();Object.entries(t).forEach(([n,r])=>{if(!Array.isArray(r)||r.length===0)return;const i=Qh[n];if(!i)return;const o=Sl(n);if(!Number.isFinite(o)||o<=0)return;let a=0;if(r.forEach(d=>{const u=rp(n,d,i),m=tp(d==null?void 0:d.score)*np(u);Number.isFinite(m)&&m>0&&(a+=m)}),!Number.isFinite(a)||a<=0)return;const c=Ml({type:i,workers:a,assigned:r.length}),l=Object.entries(c||{}).filter(([,d])=>Number.isFinite(d)&&d!==0);l.length&&l.forEach(([d,u])=>{const m=u*o;Xd(e,d,m)})})}function op(e){const t=Jn({statuses:["completed"]});let n=0;return t.forEach(r=>{var c,l;const i=Gt(r.typeId),o=(l=(c=i==null?void 0:i.effects)==null?void 0:c.jobs)==null?void 0:l[e],a=Number(o)||0;a>0&&(n+=a)}),n}const ap={grain:.2,"root vegetables":.1333,herbs:.0333},sp={"crafted goods":.02},lp={food:.15,hides:.04,"animal fat":.02},cp={grain:.075,water:.1},dp={cookedMeals:.2,"hearty meal":.1,"comfort meal":.05,preservedFood:.05},up={food:.3,firewood:.15,herbs:.05,salt:.03,spices:.015},fp={"crafted goods":.15,"bronze ingot":.05},mp={"raw ore":.1,charcoal:.1,firewood:.05};function ls(e,t=0,n=0){if(!Number.isFinite(t)||t<=0)return 0;const r=op(e);if(r<=0)return 0;const i=Math.min(Math.max(0,n),r);return i<=0?0:Math.min(t,i)}function hp(e=0){const t=Dh*qh/8,n={};return Object.entries(Wh).forEach(([r,i])=>{const o=t*i;n[r]=o/Kh(r)*e}),n}function pp(e={}){const{people:t=0,foodDays:n=0,firewoodDays:r=0,tools:i={}}=e,o={},a=1;return t>0&&n>0&&(o.food=t*n*a),t>0&&r>0&&(o.firewood=t*r),Object.entries(i).forEach(([c,l])=>{l&&(o[c]=(o[c]||0)+l)}),o}function gp(e){const t=(e==null?void 0:e.workers)||0;return{food:t*Uh,hides:t*Yh}}function bp(e){const t=(e==null?void 0:e.workers)||0;return{"crafted goods":t*Gh,firewood:-t*Vh}}function yp(e){const t=ls("farm",(e==null?void 0:e.workers)||0,(e==null?void 0:e.assigned)||0);if(!t)return{};const n={};return Object.entries(ap).forEach(([r,i])=>{n[r]=(n[r]||0)+i*t}),Object.entries(sp).forEach(([r,i])=>{n[r]=(n[r]||0)-i*t}),n}function wp(e){const t=ls("herd",(e==null?void 0:e.workers)||0,(e==null?void 0:e.assigned)||0);if(!t)return{};const n={};return Object.entries(lp).forEach(([r,i])=>{n[r]=(n[r]||0)+i*t}),Object.entries(cp).forEach(([r,i])=>{n[r]=(n[r]||0)-i*t}),n}function xp(e){const t=ls("cook",(e==null?void 0:e.workers)||0,(e==null?void 0:e.assigned)||0);if(!t)return{};const n={};return Object.entries(dp).forEach(([r,i])=>{n[r]=(n[r]||0)+i*t}),Object.entries(up).forEach(([r,i])=>{n[r]=(n[r]||0)-i*t}),n}function vp(e){const t=ls("smith",(e==null?void 0:e.workers)||0,(e==null?void 0:e.assigned)||0);if(!t)return{};const n={};return Object.entries(fp).forEach(([r,i])=>{n[r]=(n[r]||0)+i*t}),Object.entries(mp).forEach(([r,i])=>{n[r]=(n[r]||0)-i*t}),n}function Sp(e){var o,a;const t=(e==null?void 0:e.workers)||0,n={},r=((o=e==null?void 0:e.metadata)==null?void 0:o.perWorkerHourResources)||{};Object.entries(r).forEach(([c,l])=>{l&&(n[c]=-l*t)});const i=((a=e==null?void 0:e.metadata)==null?void 0:a.progressPerWorkerHour)??Xh;return n["construction progress"]=t*i,n}function Ml(e){if(!e)return{};switch(e.type){case"gathering":return hp(e.workers);case"hunting":return gp(e);case"farming":return yp(e);case"herding":return wp(e);case"crafting":return bp(e);case"cooking":return xp(e);case"smithing":return vp(e);case"building":return Sp(e);case"combat":default:return{}}}function Mp(e,t=1){if(!e||t<=0)return{};const n=Ml(e);return Zh(n,t)}function kp(e=[]){const t={};return e.filter(n=>n.status==="pending"||n.status==="active").forEach(n=>{const r=n.status==="pending"?n.durationHours:n.remainingHours,i=Mp(n,r);Object.entries(i).forEach(([o,a])=>{Xd(t,o,a)})}),ip(t),t}const Cp={gather:"gathering",hunt:"hunting",craft:"crafting"};function Ep(e,t){(!S.jobDaily||typeof S.jobDaily!="object")&&(S.jobDaily={});const n=S.jobDaily[e];return(!n||n.dayStamp!==t)&&(S.jobDaily[e]={dayStamp:t,workedHours:0,idleHours:0}),S.jobDaily[e]}function Tp(e,t){Object.entries(e||{}).forEach(([n,r])=>{if(!r)return;const i=r*t;i&&Ha(n,i)})}function Ap(e,t,n){var a;const r=Cp[e];if(!r||t<=0||n<=0)return 0;const i=Ml({type:r,workers:t});if(!i)return 0;let o=n;if(r==="crafting"){const c=Math.abs(i.firewood||0);if(c>0){const l=Math.max(0,((a=Fo("firewood"))==null?void 0:a.quantity)||0),d=l>0?l/c:0;o=Math.min(n,d)}}return o<=0?0:(Tp(i,o),o)}function Np(e,t,n){if(!e||t<=0)return 0;const r=Math.max(1,e.totalLaborHours||1),i=e.requiredResources||{},o=e.consumedResources||{};let a=t;return Object.entries(i).forEach(([c,l])=>{var C;if(!Number.isFinite(l)||l<=0)return;const d=l/r;if(d<=0)return;const u=d*n;if(u<=0)return;const m=o[c]||0,h=Math.max(0,l-m);if(h<=0){a=Math.min(a,0);return}const p=Math.max(0,((C=Fo(c))==null?void 0:C.quantity)||0),x=Math.min(h,p)/u;a=Math.min(a,x)}),Math.max(0,a)}function Fp(e,t){if(t<=0)return;const n=Math.max(1,e.totalLaborHours||1),r=e.requiredResources||{};if(!Object.keys(r).length)return;const i={};Object.entries(r).forEach(([o,a])=>{if(!Number.isFinite(a)||a<=0)return;const c=a/n;if(c<=0)return;const l=c*t;l&&(i[o]=l,Ha(o,-l))}),Object.keys(i).length&&rg(e.id,i)}function Bp(e,t){if(e<=0||t<=0)return 0;const n=Jn({statuses:["under-construction"]});if(!n.length)return 0;let r=e*t,i=0;return n.some(o=>{if(r<=0)return!0;const a=Math.max(1,o.assignedWorkers||1),c=Math.max(1,o.totalLaborHours||1),l=Math.ceil(c/a),d=Math.max(a*l,c),u=c/d,m=Math.max(0,c-(o.progressHours||0));if(m<=0)return!1;const h=m/u;if(h<=0)return!1;const p=Math.min(r,h);if(p<=0)return!1;const w=Np(o,p,u);if(w<=0)return!1;const x=w*u;return x<=0||(Fp(o,x),ng(o.id,x),r-=w,i+=w,Math.min(c,(o.progressHours||0)+x)>=c&&ig(o.id)),!1}),i}function Lp(e,{dayStamp:t}={}){if(!Number.isFinite(e)||e<=0)return;const n=Ih();Object.entries(n).forEach(([r,i])=>{if(r==="laborer")return;const o=Math.max(0,Number(i)||0);if(o<=0)return;const a=Ep(r,t),c=Sl(r),l=Math.max(0,c-a.workedHours);if(l<=0)return;const d=Math.min(e,l);if(d<=0)return;let u=0;r==="build"?(u=Bp(o,d),u>0&&(u/=Math.max(1,o))):u=Ap(r,o,d),u>0?(a.workedHours+=u,u<d&&(a.idleHours+=d-u)):a.idleHours+=d})}function mc(e){if(!S.jobDaily||typeof S.jobDaily!="object"){S.jobDaily={};return}Object.entries(S.jobDaily).forEach(([t,n])=>{!n||n.dayStamp===e||(S.jobDaily[t]={dayStamp:e,workedHours:0,idleHours:0})})}const el=28,_i=24,Kd=6,go={min:410,max:987};function Rp(){const e=go.max-go.min+1;return go.min+Math.floor(Math.random()*e)}const Lo=[{name:"Frostmelt",season:"Thawbound"},{name:"Dawnforge",season:"Thawbound"},{name:"Seedwane",season:"Thawbound"},{name:"Raincall",season:"Sunheight"},{name:"Suncrest",season:"Sunheight"},{name:"Highember",season:"Sunheight"},{name:"Harvestgale",season:"Emberwane"},{name:"Emberfall",season:"Emberwane"},{name:"Gloamreach",season:"Emberwane"},{name:"Stormwrack",season:"Frostshroud"},{name:"Nightveil",season:"Frostshroud"},{name:"Deepfrost",season:"Frostshroud"},{name:"Ghostmoon",season:"Frostshroud"}],Yt=Lo.length,Ip=Lo.map(e=>e.name),cs={Thawbound:{icon:"ðŸŒ¿",months:[]},Sunheight:{icon:"ðŸ”¥",months:[]},Emberwane:{icon:"ðŸ‚",months:[]},Frostshroud:{icon:"â„ï¸",months:[]}};Lo.forEach((e,t)=>{const n=cs[e.season];n&&n.months.push(t+1)});Object.values(cs).forEach(e=>{e.months.sort((t,n)=>t-n)});const Zd=[{name:"Clear",icon:"â˜€ï¸",weights:{Thawbound:3,Sunheight:4,Emberwane:3,Frostshroud:2}},{name:"Cloudy",icon:"â˜ï¸",weights:{Thawbound:2,Sunheight:2,Emberwane:3,Frostshroud:3}},{name:"Rain",icon:"ðŸŒ§ï¸",weights:{Thawbound:3,Sunheight:3,Emberwane:2,Frostshroud:1}},{name:"Storm",icon:"â›ˆï¸",weights:{Thawbound:1,Sunheight:2,Emberwane:1,Frostshroud:1}},{name:"Snow",icon:"â„ï¸",weights:{Thawbound:0,Sunheight:0,Emberwane:1,Frostshroud:4}},{name:"Fog",icon:"ðŸŒ«ï¸",weights:{Thawbound:1,Sunheight:1,Emberwane:2,Frostshroud:2}}],hc=[{key:"night",label:"Night",icon:"ðŸŒ™",start:0,end:4},{key:"dawn",label:"Dawn",icon:"ðŸŒ…",start:4,end:7},{key:"day",label:"Day",icon:"â˜€ï¸",start:7,end:18},{key:"dusk",label:"Dusk",icon:"ðŸŒ‡",start:18,end:21},{key:"night",label:"Night",icon:"ðŸŒ™",start:21,end:24}];function Hp(e=0){return((Number.isFinite(e)?e:0)%_i+_i)%_i}function Ro(){return S.time||(S.time={}),(!Number.isFinite(S.time.day)||S.time.day<1)&&(S.time.day=1),Number.isFinite(S.time.month)?S.time.month<1?S.time.month=1:S.time.month>Yt&&(S.time.month=(Math.floor(S.time.month)-1)%Yt+1):S.time.month=1,!Number.isFinite(S.time.year)||S.time.year<go.min?S.time.year=go.min:S.time.year=Math.floor(S.time.year),Number.isFinite(S.time.hour)||(S.time.hour=Kd),S.time.season=kl(S.time.month),S.time.weather||(S.time.weather="Clear"),S.time}function Bs(e=Ro()){const t=Number.isFinite(e.year)?Math.floor(e.year):0,n=Number.isFinite(e.month)?Math.floor(e.month):1,r=Number.isFinite(e.day)?Math.floor(e.day):1,i=((n-1)%Yt+Yt)%Yt;return t*Yt*el+i*el+(r-1)}function kl(e=1){var r;const n=(((Number.isFinite(e)?Math.floor(e):1)-1)%Yt+Yt)%Yt;return((r=Lo[n])==null?void 0:r.season)||Object.keys(cs)[0]}function Cl(e=1){var r;const n=(((Number.isFinite(e)?Math.floor(e):1)-1)%Yt+Yt)%Yt;return((r=Lo[n])==null?void 0:r.name)||Ip[0]}function zp(e,t){const n=Zd.map(o=>{var a;return{name:o.name,icon:o.icon,weight:((a=o.weights)==null?void 0:a[e])??0}}).filter(o=>o.weight>0);if(!n.length)return t||"Clear";if(t){const o=n.find(a=>a.name===t);o&&(o.weight+=1.5)}const r=n.reduce((o,a)=>o+a.weight,0);if(r<=0)return t||n[0].name;let i=Math.random()*r;for(const o of n)if(i-=o.weight,i<=0)return o.name;return n[n.length-1].name}function Jd(e){const t=e||"Unknown",n=cs[t];return n?{name:t,icon:n.icon,months:[...n.months]}:{name:t,icon:"â”",months:[]}}function $p(e){const t=Zd.find(n=>n.name===e);return t?{name:t.name,icon:t.icon}:{name:e||"Unknown",icon:"â”"}}function Op(e=(t=>(t=S.time)==null?void 0:t.hour)()){const n=Hp(e),r=hc.find(i=>n>=i.start&&n<i.end)||hc[0];return{key:r.key,label:r.label,icon:r.icon,start:r.start,end:r.end}}function Qd(){const e=Ro();e.day+=1,e.day>el&&(e.day=1,e.month+=1,e.month>Yt&&(e.month=1,e.year+=1)),e.season=kl(e.month),e.weather=zp(e.season,e.weather)}function eu(e=1){const t=Ro(),n=Math.max(0,Number.isFinite(e)?e:0);if(n<=0)return;mc(Bs(t));let r=n;for(;r>0;){const i=Bs(t),o=_i-t.hour,a=Math.min(r,o);a>0?(Lp(a,{dayStamp:i}),t.hour+=a,r-=a):(t.hour+=r,r=0),t.hour>=_i-1e-9&&(t.hour-=_i,Qd(),mc(Bs(t)))}}function xn(){const e=Ro();return{...e,monthName:Cl(e.month)}}function tu(){const e=Ro();e.hour=Kd}const Zn=new Map;function Io(){if(!(S.unlockedBuildings instanceof Set)){const e=Array.isArray(S.unlockedBuildings)?S.unlockedBuildings:[];S.unlockedBuildings=new Set(e)}if(!(S.research instanceof Set)){const e=Array.isArray(S.research)?S.research:[];S.research=new Set(e)}typeof S.buildingSeq!="number"&&(S.buildingSeq=0)}function _p(e,t={}){return Object.entries(t).forEach(([n,r])=>{!Number.isFinite(r)||r===0||(e[n]=(e[n]||0)+r)}),e}function Ur(e={}){return Object.fromEntries(Object.entries(e).map(([t,n])=>[t,n]))}function mr(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}function Pp(e={}){if(!e)return null;const t=[];if(Array.isArray(e.categories)&&e.categories.forEach(u=>{if(!u&&u!==0)return;const m=String(u).trim().toLowerCase();m&&t.push(m)}),e.category){const u=String(e.category).trim().toLowerCase();u&&t.push(u)}const n=[...new Set(t)];if(!n.length)return null;const r=e.dimensions||{},i=mr(r.width),o=mr(r.depth),a=e.accessClearance||{},c=mr(a.side),l={front:mr(a.front),back:mr(a.back),left:mr(a.left)||c,right:mr(a.right)||c};let d=mr(e.surfaceArea);if(!d){const u=i+l.left+l.right,m=o+l.front+l.back;u>0&&m>0&&(d=u*m)}return{categories:n,primaryCategory:n[0],surfaceArea:d,dimensions:{width:i,depth:o},accessClearance:l,raw:{...e}}}function Dp(){return Vi()[0]||null}function jp(e,t){if(!e||!t)return 0;Tr();const n=String(t).toLowerCase();let r=0;return S.buildings.forEach(i=>{var l;if(i.locationId!==e)return;const o=Zn.get(i.typeId),a=(l=o==null?void 0:o.stats)==null?void 0:l.site;!a||!a.surfaceArea||String(i.siteCategory||a.primaryCategory||"").toLowerCase()!==n||(r+=a.surfaceArea||0)}),r}function Wp(e,t){var l,d;const n=(l=e==null?void 0:e.stats)==null?void 0:l.site;if(!n||!n.surfaceArea||!((d=n.categories)!=null&&d.length))return{siteOk:!0,status:null};if(!t){const u=n.categories.map(m=>({category:m,capacity:0,usage:0,remaining:0}));return{siteOk:!1,status:{categories:u,selected:u[0]||null}}}const r=rh(t.id),i=n.categories.map(u=>{const m=(r==null?void 0:r[u])??0,h=jp(t.id,u),p=m-h;return{category:u,capacity:m,usage:h,remaining:p}}),o=n.surfaceArea||0;let a=i.find(u=>u.remaining>=o-1e-6);return!a&&i.length&&(a=i[0]),{siteOk:!!(a&&a.remaining>=o-1e-6),status:{categories:i,selected:a||null}}}function qp(e={}){var r,i;const t=Pp((r=e.requirements)==null?void 0:r.site),n={totalLaborHours:0,minBuilders:Math.max(1,((i=e.requirements)==null?void 0:i.minBuilders)||1),totalResources:{},components:[],addons:[],site:t,coreComponent:null,coreResources:{},coreLaborHours:0};if((e.components||[]).forEach((o,a)=>{const c=Math.max(0,o.laborHours||0),l=Math.max(1,o.minBuilders||1);n.totalLaborHours+=c,n.minBuilders=Math.max(n.minBuilders,l);const d=Ur(o.resources||{});_p(n.totalResources,d);const u=!!o.isCore||!n.coreComponent&&a===0,m={...o,isCore:u,laborHours:c,minBuilders:l,resources:d};n.components.push(m),u&&!n.coreComponent&&(n.coreComponent=m,n.coreResources=Ur(d),n.coreLaborHours=c)}),!n.coreComponent&&n.components.length){const o=n.components[0];o.isCore=!0,n.coreComponent=o,n.coreResources=Ur(o.resources||{}),n.coreLaborHours=o.laborHours||0}return(e.addons||[]).forEach(o=>{const a=Math.max(0,o.laborHours||0),c=Math.max(1,o.minBuilders||1),l=Ur(o.resources||{});n.addons.push({...o,laborHours:a,minBuilders:c,resources:l,totals:{laborHours:a,resources:Ur(l)}})}),n.totalLaborHours<=0&&(n.totalLaborHours=n.minBuilders),n}function Up(e){if(!(e!=null&&e.id)||Zn.has(e.id))return;const t=qp(e);Zn.set(e.id,{...e,stats:t})}function Yp(e=[],t=""){if(!t)return!0;const n=t.toLowerCase();return e.some(r=>r.toLowerCase().includes(n))}function Gp(e,t=null){var a,c;const n=((a=e.requirements)==null?void 0:a.locationTags)||[];if(!n.length)return!0;const r=n.map(l=>String(l||"").toLowerCase());if(r.some(l=>l==="open"||l==="any"))return!0;const i=t?[t]:Vi();if(!i.length)return!1;const o=(((c=i[0])==null?void 0:c.features)||[]).map(l=>l.toLowerCase());return r.some(l=>Yp(o,l))}function pc(e){return Io(),S.research.has(e)}function xi(e){return!e&&e!==0?[]:Array.isArray(e)?e:[e]}function gc(e){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number")return{id:String(e),count:1};if(e&&typeof e=="object"){const t=e.id??e.building??e.type;if(!t&&t!==0)return null;const n=Number.isFinite(e.count)?Math.max(1,e.count):Number.isFinite(e.required)?Math.max(1,e.required):1;return{id:String(t),count:n}}return null}function nu(e={}){if(!e)return{ok:!1,missing:null};if(e.always)return{ok:!0,missing:null};let t=!0;const n={technologies:[],anyTechnology:[],research:[],anyResearch:[],buildings:[],anyBuilding:[],resources:[],custom:!1};if(e.custom&&typeof e.custom=="function")try{e.custom(S)||(t=!1,n.custom=!0)}catch(d){console.warn("Building unlock custom check failed",d),t=!1,n.custom=!0}const r=xi(e.technologies).map(d=>d||d===0?String(d):null).filter(Boolean);if(r.length){const d=r.filter(u=>!sn(u));d.length&&(t=!1,n.technologies=[...new Set(d)])}const i=xi(e.anyTechnology).map(d=>d||d===0?String(d):null).filter(Boolean);i.length&&(i.some(u=>sn(u))||(t=!1,n.anyTechnology=[...new Set(i)]));const o=xi(e.research).map(d=>d||d===0?String(d):null).filter(Boolean);if(o.length){const d=o.filter(u=>!pc(u));d.length&&(t=!1,n.research=[...new Set(d)])}const a=xi(e.anyResearch).map(d=>d||d===0?String(d):null).filter(Boolean);a.length&&(a.some(u=>pc(u))||(t=!1,n.anyResearch=[...new Set(a)]));const c=xi(e.buildings).map(gc).filter(Boolean);if(c.length){const d=[];c.forEach(u=>{const m=ba(u.id,{statuses:["completed"]});m<u.count&&d.push({id:u.id,required:u.count,current:m})}),d.length&&(t=!1,n.buildings=d)}const l=xi(e.anyBuilding).map(gc).filter(Boolean);if(l.length&&(l.some(u=>ba(u.id,{statuses:["completed"]})>=u.count)||(t=!1,n.anyBuilding=l.map(u=>({id:u.id,required:u.count,current:ba(u.id,{statuses:["completed"]})})))),e.resources){const d=ya(e.resources);d.missing.length&&(t=!1,n.resources=d.missing.map(u=>({name:u.name,required:u.required,available:u.available})))}return Object.keys(n).forEach(d=>{const u=n[d];Array.isArray(u)&&!u.length&&delete n[d],(u===!1||u===null)&&delete n[d]}),{ok:t,missing:Object.keys(n).length?n:null}}function ru(e={}){return!!nu(e).ok}function bc(e){if(!e&&e!==0)return;const t=Gm(e);t!=null&&t.definition?zd(e):(Io(),S.research.add(String(e)))}function Vp(e){var r;const t=(r=e==null?void 0:e.effects)==null?void 0:r.unlocks;if(!t)return;(Array.isArray(t)?t:[t]).forEach(i=>{if(!(!i&&i!==0)){if(typeof i=="string"||typeof i=="number"){bc(i);return}if(i&&typeof i=="object"){const o=i.technology??i.tech??i.id;(o||o===0)&&bc(o)}}})}function Xp(e){return Io(),S.unlockedBuildings.has(e.id)?!0:ru(e.unlock)?(S.unlockedBuildings.add(e.id),!0):!1}function Kp(e){return Number.isFinite(e.maxCount)?e.maxCount:e.allowMultiple?1/0:1}function Tr(){S.buildings instanceof Map||(S.buildings=new Map(S.buildings||[]))}function ba(e,{statuses:t=null}={}){Tr();const n=t?new Set(t):null;let r=0;return S.buildings.forEach(i=>{i.typeId===e&&(n&&!n.has(i.status)||(r+=1))}),r}function Yi(e){if(!e&&e!==0)return!1;Tr();const t=String(e).toLowerCase();let n=!1;return S.buildings.forEach(r=>{n||r.status==="completed"&&String(r.typeId).toLowerCase()===t&&(n=!0)}),n}function ya(e={}){const t=[],n={};return Object.entries(e).forEach(([r,i])=>{if(!i||i<=0)return;const o=Fo(r).quantity||0;n[r]={required:i,available:o,deficit:Math.max(0,i-o)},o<i&&t.push({name:r,required:i,available:o})}),{missing:t,totals:n}}function Zp(e={}){const t={wood:0,stone:0,metal:0};return Object.entries(e).forEach(([n,r])=>{const i=Math.max(0,Number(r)||0);if(!i)return;const o=String(n).toLowerCase();/(wood|log|timber|lumber|beam|board|plank|sapling|pole|stave|branch)/.test(o)&&(t.wood+=i),/(stone|rock|clay|brick|adobe|mortar|slate|granite|cobbl|marble)/.test(o)&&(t.stone+=i),/(metal|ingot|iron|copper|bronze|steel|nail|spike|ore)/.test(o)&&(t.metal+=i)}),t}function Jp(e={}){const t=Zp(e),n=Object.entries(t).filter(([,a])=>a>0);if(!n.length)return{primary:"construction",extras:[]};const[r]=n.reduce((a,c)=>c[1]>a[1]?c:a,n[0]),i=[],o=(a,c)=>{!a||c<=0||i.some(l=>l.id===a)||i.push({id:a,effortScale:c})};switch(r){case"stone":o("masonry",.7);break;case"wood":o("carpentry",.7);break;case"metal":o("smelting",.55);break}return n.forEach(([a])=>{a!==r&&(a==="stone"&&o("masonry",.45),a==="wood"&&o("carpentry",.45),a==="metal"&&o("smelting",.35))}),{primary:"construction",extras:i}}function iu(e){var x;const t=Zn.get(e);if(!t)return null;const n=Xp(t),r=Kp(t),i=ba(e),o=i<r,a=Dp(),c=Gp(t,a),{siteOk:l,status:d}=Wp(t,a),u=c&&l,m=ya(t.stats.coreResources),h=ya(t.stats.totalResources),p=ya(((x=t.requirements)==null?void 0:x.craftedGoods)||{}),w=nu(t.unlock);return{type:t,unlocked:n,canBuildMore:o,terrainOk:c,siteOk:l,locationOk:u,hasResources:m.missing.length===0,resourceStatus:m,craftedStatus:p,totalResourceStatus:h,siteStatus:d,existing:i,maxCount:r,unlockStatus:w}}function Qp(){return[...Zn.values()]}function eg(){return Io(),S.buildingSeq+=1,`bld-${S.buildingSeq}`}function tg(e,{workers:t,locationId:n,x:r=null,y:i=null}={}){var P,O,s,G,X,re;const o=Zn.get(e);if(!o)throw new Error(`Unknown building type ${e}`);const a=iu(e);if(!(a!=null&&a.unlocked))throw new Error(`Building ${o.name} is not unlocked`);if(!a.canBuildMore)throw new Error(`No additional ${o.name} can be constructed right now`);if(!a.locationOk)throw new Error(`${o.name} cannot be built at this location`);if(!a.hasResources)throw new Error(`Insufficient resources to begin ${o.name}`);Tr();const c=Math.max(o.stats.minBuilders,t||o.stats.minBuilders||1),l=Math.max(1,o.stats.totalLaborHours),d=Ur(o.stats.totalResources),u=Ur(o.stats.coreResources),m=Jp(d),h=((O=(P=a==null?void 0:a.siteStatus)==null?void 0:P.selected)==null?void 0:O.category)||((s=o.stats.site)==null?void 0:s.primaryCategory)||null,p=h?String(h).toLowerCase():null,w=((G=o.stats.site)==null?void 0:G.surfaceArea)||0,x=((X=o.stats.coreComponent)==null?void 0:X.id)||null,M=Number.isFinite(r)&&Number.isFinite(i)?{x:Math.trunc(r),y:Math.trunc(i)}:null,T=eg(),A={id:T,typeId:e,status:"under-construction",locationId:n||((re=Vi()[0])==null?void 0:re.id)||null,progressHours:0,totalLaborHours:l,assignedWorkers:c,requiredResources:d,consumedResources:{},addons:[],coreResources:u,coreComponentId:x,siteCategory:p,siteSurfaceArea:w,tile:M};S.addItem("buildings",A);const E=Math.max(1,Math.ceil(l/c)),R=c*E,L={};Object.entries(d).forEach(([q,ee])=>{!ee||ee<=0||(L[q]=ee/R)});const W=l/R,D=Object.values(d).reduce((q,ee)=>q+ee,0),V=Math.min(100,28+Math.log10(l+1)*18+Math.log10(D+1)*6);return{project:{...A},order:{type:"building",workers:c,hours:E,notes:`${o.name} construction`,metadata:{buildingTypeId:e,projectId:T,typeName:o.name,totalLaborHours:l,perWorkerHourResources:L,progressPerWorkerHour:W,baseComplexity:V,taskComplexity:V,effortHours:l,proficiencyId:m.primary,additionalProficiencies:m.extras.length?m.extras:void 0,taskId:`construction:${e}`,tile:M}}}}function ng(e,t=0){if(!t)return;Tr();const n=S.getItem("buildings",e);if(!n)return;const r=Math.min(n.totalLaborHours,(n.progressHours||0)+t);S.updateItem("buildings",{id:e,progressHours:r})}function rg(e,t={}){const n=Object.keys(t||{});if(!n.length)return;Tr();const r=S.getItem("buildings",e);if(!r)return;const i={...r.consumedResources||{}};n.forEach(o=>{const a=t[o];!Number.isFinite(a)||a<=0||(i[o]=(i[o]||0)+a)}),S.updateItem("buildings",{id:e,consumedResources:i})}function ig(e){Tr();const t=S.getItem("buildings",e);if(!t)return null;const n=Gt(t.typeId),r=xn?xn():null,i={id:e,status:"completed",progressHours:t.totalLaborHours,completedAt:r};return S.updateItem("buildings",i),n&&Vp(n),ds(),{...t,...i}}function Jn({statuses:e=null}={}){Tr();const t=e?new Set(e):null;return[...S.buildings.values()].filter(n=>t?t.has(n.status):!0)}function ds(){Io(),Zn.forEach(e=>{ru(e.unlock)&&S.unlockedBuildings.add(e.id)})}function Gt(e){return Zn.get(e)||null}function og(){Zn.size>0||(eh.forEach(Up),ds())}og();const yc={open:"--tile-open",forest:"--tile-forest",stone:"--tile-stone",ore:"--tile-ore",water:"--tile-water",ocean:"--legend-ocean",open_ocean:"--legend-open-ocean",polar_sea:"--legend-polar-sea",abyssal_deep:"--legend-abyssal-deep",seamount:"--legend-seamount",estuary:"--legend-estuary",delta:"--legend-delta",mangrove_forest:"--legend-mangrove-forest",kelp_forest:"--legend-kelp-forest",coral_reef:"--legend-coral-reef",lake:"--legend-lake",pond:"--legend-pond",river:"--legend-river",stream:"--legend-stream",marsh:"--legend-marsh",mangrove:"--legend-mangrove",bog:"--legend-bog",fen:"--legend-fen",swamp:"--legend-swamp",grassland:"--legend-grassland",desert:"--legend-desert",tundra:"--legend-tundra",taiga:"--legend-taiga",savanna:"--legend-savanna",rainforest:"--legend-rainforest",jungle:"--legend-jungle",wetland:"--legend-wetland",sand:"--legend-sand",coast:"--legend-coast",island:"--legend-island",mountain:"--legend-mountain",alpine:"--legend-alpine",volcanic:"--legend-volcanic",temperate:"--legend-temperate",tropical:"--legend-tropical",plains:"--legend-plains"},To={open:"#facc15",forest:"#16a34a",stone:"#94a3b8",ore:"#f97316",water:"#2d7ff9",ocean:"#2563eb",open_ocean:"#1d4ed8",polar_sea:"#bae6fd",abyssal_deep:"#0f172a",seamount:"#334155",estuary:"#2563eb",delta:"#3b82f6",mangrove_forest:"#047857",kelp_forest:"#0f766e",coral_reef:"#f97316",lake:"#38bdf8",pond:"#67e8f9",river:"#0ea5e9",stream:"#38bdf8",marsh:"#4ade80",mangrove:"#065f46",bog:"#0f5132",fen:"#22c55e",swamp:"#166534",grassland:"#a3e635",desert:"#f4b76b",tundra:"#9ac5ff",taiga:"#2f6b2a",savanna:"#f59e0b",rainforest:"#047857",jungle:"#0f766e",wetland:"#22c55e",sand:"#fcd34d",coast:"#0ea5e9",island:"#38bdf8",mountain:"#64748b",alpine:"#60a5fa",volcanic:"#ea580c",temperate:"#4ade80",tropical:"#10b981",plains:"#facc15"},wc=Object.freeze(Object.fromEntries(Object.keys(To).map(e=>[e,{start:`--tile-${e}-gradient-start`,end:`--tile-${e}-gradient-end`}]))),ag=.22,sg=.18,xc="#6b7280";let bo=null,wa=null;function Pi(e){return Number.isFinite(e)?Math.min(255,Math.max(0,Math.round(e))):0}function vc(e){if(!e)return null;const t=String(e).trim();if(!t)return null;const n=t.match(/^#?([0-9a-f]{3}|[0-9a-f]{6})$/i);if(n){let r=n[1];r.length===3&&(r=r.split("").map(o=>o+o).join(""));const i=Number.parseInt(r,16);return Number.isNaN(i)?null:{r:i>>16&255,g:i>>8&255,b:i&255}}if(/^rgba?\(/i.test(t)){const r=t.replace(/rgba?\(/i,"").replace(/\)/g,"").replace(/\//g," ").split(/[\s,]+/).filter(Boolean).slice(0,3).map(i=>Number.parseFloat(i));return r.length<3||r.some(i=>Number.isNaN(i))?null:{r:Pi(r[0]),g:Pi(r[1]),b:Pi(r[2])}}return null}function Sc({r:e,g:t,b:n}){return`#${[Pi(e),Pi(t),Pi(n)].map(r=>r.toString(16).padStart(2,"0")).join("")}`}function Mc(e,t,n=.5){const r=Math.min(1,Math.max(0,n));return{r:e.r*(1-r)+t.r*r,g:e.g*(1-r)+t.g*r,b:e.b*(1-r)+t.b*r}}function ou(e){const t=vc(e)||vc(xc);if(!t)return{start:xc,end:"#1f2937"};const n=Mc(t,{r:255,g:255,b:255},ag),r=Mc(t,{r:0,g:0,b:0},sg);return{start:Sc(n),end:Sc(r)}}function tl(e,t){if(!e)return"";try{return e.getPropertyValue(t)||""}catch{return""}}function lg(){let e=null;if(typeof document<"u"&&document.documentElement)try{e=getComputedStyle(document.documentElement)}catch{e=null}const t={...To};return Object.keys(yc).forEach(n=>{const r=n,i=yc[r],o=tl(e,i).trim();t[r]=o||To[r]}),t}function Ho(e={}){const{forceRefresh:t=!1}=e;return(!bo||t)&&(bo=lg()),{...bo}}Ho();function cg(){let e=null;if(typeof document<"u"&&document.documentElement)try{e=getComputedStyle(document.documentElement)}catch{e=null}const t=bo??Ho(),n={};return Object.keys(wc).forEach(r=>{const i=r,o=wc[i],a=tl(e,o.start).trim(),c=tl(e,o.end).trim(),l=t[i]||To[i],d=ou(l);n[i]={start:a||d.start,end:c||d.end}}),n}function dg(e={}){const{forceRefresh:t=!1}=e;(!wa||t)&&(t&&Ho({forceRefresh:!0}),wa=cg());const n={};return Object.entries(wa).forEach(([r,i])=>{n[r]={...i}}),n}function ug(e){const t=wa??dg(),n=typeof e=="string"&&e?e.toLowerCase():"open";return Object.prototype.hasOwnProperty.call(t,n)?{...t[n]}:{...t.open}}function fg(e){const t=bo??Ho(),n=typeof e=="string"&&e?e.toLowerCase():"open";return Object.prototype.hasOwnProperty.call(To,n)?t[n]:t.open}function kc(e,t,n){return Number.isNaN(e)?t:t>n?e:e<t?t:e>n?n:e}function Jo(e,t){return Number.isFinite(e)?e:t}function mg(e){var D,V;const t=e.minZoom&&Number.isFinite(e.minZoom)?Math.max(.05,e.minZoom):.1,n=e.maxZoom&&Number.isFinite(e.maxZoom)?Math.max(t,e.maxZoom):Math.max(t,8);let r=Math.max(0,Math.trunc(e.viewportWidth||0)),i=Math.max(0,Math.trunc(e.viewportHeight||0)),o=Jo((D=e.centerTile)==null?void 0:D.x,0),a=Jo((V=e.centerTile)==null?void 0:V.y,0),c=kc(Number.isFinite(e.initialZoom)?e.initialZoom:1,t,n),l=null,d=null,u=0,m=o,h=a,p=o,w=a,x=null,C=null,M=null;const T=P=>typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(P):setTimeout(()=>P(Date.now()),16),A=P=>{if(P!=null){if(typeof window<"u"&&typeof window.cancelAnimationFrame=="function"&&typeof P=="number"){window.cancelAnimationFrame(P);return}clearTimeout(P)}};function E(P=!1){l!==null&&(A(l),l=null),d=null,P&&(o=p,a=w),C=null,M=null,x=null}function R(P){const s=1-(P<0?0:P>1?1:P);return 1-s*s*s}function L(P,O){u=P,m=o,h=a,d=null,x=O;const s=G=>{d===null&&(d=G);const X=G-d,re=u>0?Math.min(1,X/u):1,q=x?x(re):re,ee=m+(p-m)*q,Me=h+(w-h)*q;if(o=Number.isFinite(ee)?ee:p,a=Number.isFinite(Me)?Me:w,C&&C({x:o,y:a}),re>=1-1e-6){o=p,a=w,l=null,d=null;const me=C,_e=M;C=null,M=null,x=null,me&&me({x:o,y:a}),_e&&_e({x:o,y:a});return}l=T(s)};l=T(s)}const W={get centerTile(){return{x:o,y:a}},get zoom(){return c},get minZoom(){return t},get maxZoom(){return n},get viewportWidth(){return r},get viewportHeight(){return i},setViewportSize(P,O){Number.isFinite(P)&&(r=Math.max(0,Math.trunc(P))),Number.isFinite(O)&&(i=Math.max(0,Math.trunc(O)))},setCenterTile(P,O={}){l!==null&&E(!1);const s=Jo(P==null?void 0:P.x,o),G=Jo(P==null?void 0:P.y,a);o=Number.isFinite(s)?s:o,a=Number.isFinite(G)?G:a,O.snap&&(o=Math.round(o),a=Math.round(a))},setZoom(P,O="viewport"){const s=c;return c=kc(Number.isFinite(P)?P:s,t,n),c},panBy(P,O,s={}){l!==null&&E(!1),Number.isFinite(P)&&(o+=P),Number.isFinite(O)&&(a+=O),s.snap&&W.commitSnap()},commitSnap(P={}){const O=Math.round(o),s=Math.round(a),G=Math.abs(O-o)>1e-6||Math.abs(s-a)>1e-6,X=typeof P.onUpdate=="function"?P.onUpdate:null,re=typeof P.onComplete=="function"?P.onComplete:null;if(E(!1),!G)return X&&X({x:o,y:a}),re&&re({x:o,y:a}),{targetX:O,targetY:s,changed:!1};if(!(P.animate!==!1))return o=O,a=s,X&&X({x:o,y:a}),re&&re({x:o,y:a}),{targetX:O,targetY:s,changed:!0};const ee=Math.max(Math.abs(O-o),Math.abs(s-a)),Me=150,me=250,_e=Number.isFinite(P.duration)?P.duration:Me+Math.min(me-Me,ee*40),je=Math.max(Me,Math.min(me,_e)),lt=typeof P.easing=="function"?P.easing:R;return p=O,w=s,C=X,M=re,L(je,lt),{targetX:O,targetY:s,changed:!0}},worldToScreen(P,O,s){const G=W.getScaledTileSize(s),X=r/2+(P-o-.5)*G,re=i/2+(O-a-.5)*G;return{x:X,y:re}},worldToScreenCenter(P,O,s){const G=W.getScaledTileSize(s),X=r/2+(P-o)*G,re=i/2+(O-a)*G;return{x:X,y:re}},screenToTile(P,O,s){const G=W.getScaledTileSize(s)||1,X=o+(P-r/2)/G+.5,re=a+(O-i/2)/G+.5;return{x:X,y:re}},getVisibleWorldBounds(P){const O=W.getScaledTileSize(P)||1,s=r/(2*O),G=i/(2*O);return{minX:o-s-1,maxX:o+s+1,minY:a-G-1,maxY:a+G+1}},getScaledTileSize(P){return(Number.isFinite(P)&&P>0?P:1)*c}};return W}class au{constructor(t,n){this.maxSize=Math.max(0,Math.trunc(t)),this.onEvict=typeof n=="function"?n:null,this.map=new Map}get size(){return this.map.size}get capacity(){return this.maxSize}setCapacity(t){const n=Math.max(0,Math.trunc(t));if(n!==this.maxSize){if(this.maxSize=n,this.maxSize===0){this.clear();return}this.evictIfNeeded()}}get(t){if(!this.map.has(t))return;const n=this.map.get(t);return this.map.delete(t),this.map.set(t,n),n}peek(t){return this.map.get(t)}set(t,n){if(this.maxSize<=0){this.handleEviction(t,n);return}if(this.map.has(t)){const r=this.map.get(t);this.map.delete(t),r!==void 0&&this.handleEviction(t,r)}this.map.set(t,n),this.evictIfNeeded()}has(t){return this.map.has(t)}delete(t){if(!this.map.has(t))return!1;const n=this.map.get(t);return this.map.delete(t),n!==void 0&&this.handleEviction(t,n),!0}clear(){if(this.map.size===0)return;const t=this.map.entries();for(const[n,r]of t)this.handleEviction(n,r);this.map.clear()}keys(){return this.map.keys()}values(){return this.map.values()}entries(){return this.map.entries()}evictIfNeeded(){if(this.maxSize<=0){this.clear();return}for(;this.map.size>this.maxSize;){const t=this.map.keys().next();if(t.done)break;const n=t.value,r=this.map.get(n);this.map.delete(n),r!==void 0&&this.handleEviction(n,r)}}handleEviction(t,n){if(this.onEvict)try{this.onEvict(t,n)}catch{}}}function hg(e){if(typeof OffscreenCanvas<"u")return new OffscreenCanvas(e,e);if(typeof document<"u"&&typeof document.createElement=="function"){const t=document.createElement("canvas");return t.width=e,t.height=e,t}return{width:e,height:e,getContext:()=>null}}function pg(e,t){Number.isFinite(e.width)&&(e.width=t),Number.isFinite(e.height)&&(e.height=t)}function Ls(e){if(Number.isFinite(e.width)&&(e.width=0),Number.isFinite(e.height)&&(e.height=0),typeof e.transferToImageBitmap=="function")try{e.transferToImageBitmap()}catch{}}class gg{constructor(t={}){this.maxPoolSize=Math.max(0,Math.trunc(t.maxPoolSize??48)),this.createCanvas=typeof t.createCanvas=="function"?t.createCanvas:hg,this.pool=[]}get size(){return this.pool.length}acquire(t){const n=Math.max(1,Math.trunc(t)),r=this.pool.pop()??this.createCanvas(n);return pg(r,n),r}release(t){if(t){if(this.pool.length>=this.maxPoolSize){Ls(t);return}Ls(t),this.pool.push(t)}}clear(){if(this.pool.length)for(;this.pool.length;){const t=this.pool.pop();t&&Ls(t)}}}const Di=new gg,bg=256,yg=96,vi=new au(bg),gr=new au(yg,(e,t)=>{t&&Di.release(t)});function wg(e){return Di.acquire(e)}function xg(e){Di.release(e)}const su="#64748b",oo=256,vg=Object.keys(le).length;let xa=null,va=null,Sa=null,Ma=null;function Xr(e){return Number.isFinite(e)?Math.min(255,Math.max(0,Math.round(e))):0}function lu(e){if(!e)return{r:100,g:116,b:139};const t=String(e).trim();if(!t)return{r:100,g:116,b:139};const n=t.match(/^#?([0-9a-f]{3}|[0-9a-f]{6})$/i);if(n){let i=n[1];i.length===3&&(i=i.split("").map(a=>a+a).join(""));const o=Number.parseInt(i,16);if(!Number.isNaN(o))return{r:o>>16&255,g:o>>8&255,b:o&255}}const r=t.match(/^rgba?\(([^)]+)\)$/i);if(r){const i=r[1].split(/[,\s]+/).filter(Boolean).map(o=>Number.parseFloat(o));if(i.length>=3&&i.every(o=>!Number.isNaN(o)))return{r:Xr(i[0]),g:Xr(i[1]),b:Xr(i[2])}}return lu(su)}function Sg(e,t,n,r=255){return(Xr(r)<<24|Xr(n)<<16|Xr(t)<<8|Xr(e))>>>0}function us(){if(!(xa&&va&&Sa&&Ma)){xa=new Uint32Array(oo),va=new Array(oo),Sa=new Array(oo),Ma=new Array(oo);for(let e=0;e<oo;e+=1){const n=e%vg,r=wd(n),i=wn(r),o=lu((i==null?void 0:i.color)??su);xa[e]=Sg(o.r,o.g,o.b,255),va[e]=`rgb(${o.r}, ${o.g}, ${o.b})`,Sa[e]=(i==null?void 0:i.name)||r||"Unknown biome",Ma[e]=r||"temperate-broadleaf"}}}function Mg(e){us();const t=Number.isFinite(e)?e&255:0;return xa[t]}function kg(e){us();const t=Number.isFinite(e)?e&255:0;return va[t]}function Cc(e){us();const t=Number.isFinite(e)?e&255:0;return Sa[t]}function Cg(e){us();const t=Number.isFinite(e)?e&255:0;return Ma[t]}const Eg=16,Ec=.24,Tg=32,Ag=0;function Qo(e,t,n,r,i,o){const a=Math.max(0,Math.min(o,Math.min(r,i)/2));if(typeof e.roundRect=="function"){e.beginPath(),e.roundRect(t,n,r,i,a);return}e.beginPath(),e.moveTo(t+a,n),e.lineTo(t+r-a,n),e.quadraticCurveTo(t+r,n,t+r,n+a),e.lineTo(t+r,n+i-a),e.quadraticCurveTo(t+r,n+i,t+r-a,n+i),e.lineTo(t+a,n+i),e.quadraticCurveTo(t,n+i,t,n+i-a),e.lineTo(t,n+a),e.quadraticCurveTo(t,n,t+a,n),e.closePath()}function Xn(e,t){if(typeof window>"u"||typeof document>"u")return t;try{return getComputedStyle(document.documentElement).getPropertyValue(e).trim()||t}catch{return t}}function Ng(e){const t=Xn("--accent","#f7c948"),n=Xn("--accent-strong","#d4a72c"),r=Xn("--warn","#ff9f47"),i=Xn("--accent-stronger","#f59e0b");switch((e==null?void 0:e.toLowerCase())||""){case"completed":case"complete":return n||t;case"under-construction":case"under construction":case"construction":case"in-progress":return r;case"planned":case"queued":return i||r;case"mixed":return Xn("--accent",r);default:return t}}function cu(e){return e&&typeof e=="object"&&typeof e.get=="function"&&Number.isFinite(e.width)&&Number.isFinite(e.height)}function du(e,t=0){var n;return e?Number.isFinite(e.width)?Math.max(0,Math.trunc(e.width)):Number.isFinite(e.baseWidth)?Math.max(0,Math.trunc(e.baseWidth)):Array.isArray(e)?Array.isArray(e[0])?((n=e[0])==null?void 0:n.length)||0:e.length||0:t:t}function uu(e,t=0){return e?Number.isFinite(e.height)?Math.max(0,Math.trunc(e.height)):Number.isFinite(e.baseHeight)?Math.max(0,Math.trunc(e.baseHeight)):Array.isArray(e)?Array.isArray(e[0])?e.length||0:e.length>0?1:0:t:t}function ea(e){if(!e)return!1;const t=e.tiles;return t?cu(t)?t.size>0&&t.width>0&&t.height>0:Array.isArray(t)&&t.length?Array.isArray(t[0])?t[0].length>0:!0:!1:!1}function ta(e,t,n,r=null){if(!e)return r;const i=Math.trunc(t),o=Math.trunc(n);if(!Number.isFinite(i)||!Number.isFinite(o))return r;if(cu(e))return e.get(i,o)??r;if(Array.isArray(e)){const a=e[o];return a?Array.isArray(a)?a[i]??r:a??r:r}return r}function Rs(e){if(!e)return{width:0,height:0};const t=Number.isFinite(e.width)&&e.width>0?Math.trunc(e.width):du(e.tiles,0),n=Number.isFinite(e.height)&&e.height>0?Math.trunc(e.height):uu(e.tiles,0);return{width:t,height:n}}class Fg{constructor(t,n){this.canvas=t;let r=null;try{r=t.getContext("2d")}catch{r=null}this.ctx=r,this.camera=n.camera;const i=Number.isFinite(n.tileBaseSize)?n.tileBaseSize:Eg;this.tileBaseSize=Math.max(2,i),this.useTerrainColors=n.useTerrainColors??!1,this.getTerrainColor=n.getTerrainColor||(()=>null),this.getTerrainGradient=n.getTerrainGradient||(()=>null),this.devicePixelRatio=typeof window<"u"&&window.devicePixelRatio||1,this.viewportWidth=Math.max(1,this.camera.viewportWidth||this.canvas.clientWidth||1),this.viewportHeight=Math.max(1,this.camera.viewportHeight||this.canvas.clientHeight||1),this.map=null,this.developments=new Map,this.scale=this.camera.zoom,this.configureCanvasSize(this.viewportWidth,this.viewportHeight),this.chunkSize=Math.max(4,n.chunkSize||Tg),this.prefetchMargin=Math.max(0,Number.isFinite(n.prefetchMargin)?Math.trunc(n.prefetchMargin):Ag),this.cacheSignature=1,this._missingMapLogged=!1,this._shouldLogMissingMap=!1,this.world=null}setTileBaseSize(t){!Number.isFinite(t)||t<=0||(this.tileBaseSize=Math.max(2,t))}setUseTerrainColors(t){const n=!!t;this.useTerrainColors!==n&&(this.useTerrainColors=n,this.invalidateTileCache())}setTerrainColorResolver(t){this.getTerrainColor!==t&&(this.getTerrainColor=t,this.invalidateTileCache())}setTerrainGradientResolver(t){this.getTerrainGradient!==t&&(this.getTerrainGradient=t,this.invalidateTileCache())}setScale(t){!Number.isFinite(t)||t<=0||(this.scale=t)}setMap(t){var l,d,u;this._shouldLogMissingMap=!!t;const n=((l=this.map)==null?void 0:l.seed)??null,r=((d=this.map)==null?void 0:d.season)??null,i=((u=this.map)==null?void 0:u.waterLevel)??null,o=(t==null?void 0:t.seed)??null,a=(t==null?void 0:t.season)??null,c=(t==null?void 0:t.waterLevel)??null;(n!==o||r!==a||i!==c)&&this.invalidateTileCache(),this.map=t,t!=null&&t.world&&this.setWorld(t.world)}setWorld(t){this.world!==t&&(this.world=t||null,this.invalidateTileCache())}setDevelopments(t){this.developments=t}setPrefetchMargin(t){if(!Number.isFinite(t))return;const n=Math.max(0,Math.trunc(t));n!==this.prefetchMargin&&(this.prefetchMargin=n)}resize(t,n){const r=Math.max(1,Math.round(t)),i=Math.max(1,Math.round(n));this.viewportWidth=r,this.viewportHeight=i,this.camera.setViewportSize(r,i),this.configureCanvasSize(r,i)}render(){var T,A,E,R,L,W;if(!this.ctx)return;const t=this.ctx;t.save(),t.setTransform(this.devicePixelRatio,0,0,this.devicePixelRatio,0,0),t.clearRect(0,0,this.viewportWidth,this.viewportHeight);const n=ea(this.map),r=!!((E=(A=(T=this.world)==null?void 0:T.layers)==null?void 0:A.biome)!=null&&E.length);if(!this.map||!n&&!r){if((this._shouldLogMissingMap||!!this.map)&&!this._missingMapLogged){const P=this.map?"The current map is missing tile data.":"Map data is not available.";console.error(`[MapRenderer] Unable to render map: ${P}`,{hasMap:!!this.map,tilesPresent:n,tileWidth:du((R=this.map)==null?void 0:R.tiles,0),tileHeight:uu((L=this.map)==null?void 0:L.tiles,0),worldLayers:r}),this._missingMapLogged=!0}const V=this.map?"Map tiles missing":"Map data unavailable";this.drawMissingMapFallback(t,V),t.restore();return}this._missingMapLogged=!1;const i=(W=this.camera)!=null&&W.getScaledTileSize?Math.max(2,this.camera.getScaledTileSize(this.tileBaseSize)):Math.max(2,this.tileBaseSize*(this.scale||1)),a=Xn("--accent","#f7c948")||"#f7c948",c=r,l=c?.25:.35,d=Math.max(1,Math.round(i*.09)),u=Math.max(1.5,i*Ec),m=Math.max(1,Math.ceil(i)),h=c?0:Math.max(2,Math.ceil(d*.75)),p=Xn("--map-grid-line","rgba(15, 23, 42, 0.32)")||"rgba(15, 23, 42, 0.32)",w={tileSize:i,tilePixelSize:m,strokeColor:a,gapAlpha:l,strokeWidth:d,cornerRadius:u,padding:h,gridColor:p,usingWorld:c},x=new Map,C=this.computeChunkRange(i,this.prefetchMargin);for(const D of C)this.ensureChunkCanvas(D,w,x);const M=this.computeChunkRange(i,0);for(const D of M){const V=this.ensureChunkCanvas(D,w,x);if(V!=null&&V.canvas){const P=this.camera.worldToScreen(D.worldX+D.startCol,D.worldY+D.startRow,this.tileBaseSize),O=Math.round(P.x)-h,s=Math.round(P.y)-h,G=D.tileCols*m+h*2,X=D.tileRows*m+h*2;t.drawImage(V.canvas,0,0,G,X,O,s,G,X)}else this.drawChunkDirect(t,D,w)}this.drawVisibleDevelopments(t,i),t.restore()}invalidateTileCache(){this.cacheSignature=(this.cacheSignature+1)%1e9}buildChunkKey(t,n){const r=Math.round(n.tileSize*1e3);return[this.cacheSignature,r,t.chunkX,t.chunkY,t.startCol,t.startRow,t.tileCols,t.tileRows].join(":")}computeChunkRange(t,n){var E;if(!ea(this.map))return[];const r=this.chunkSize,i=Number.isFinite(this.map.xStart)?this.map.xStart:0,o=Number.isFinite(this.map.yStart)?this.map.yStart:0,{width:a,height:c}=Rs(this.map),l=i+a,d=o+c;if(a<=0||c<=0)return[];let u=i,m=o,h=l,p=d;const w=typeof((E=this.camera)==null?void 0:E.getVisibleWorldBounds)=="function"?this.camera.getVisibleWorldBounds(this.tileBaseSize):null;if(w){const R=Math.max(0,Math.trunc(n||0));u=Math.max(i,Math.floor(w.minX-R)),m=Math.max(o,Math.floor(w.minY-R)),h=Math.min(l,Math.ceil(w.maxX+R)),p=Math.min(d,Math.ceil(w.maxY+R))}if(u>=h||m>=p)return[];const x=Math.floor(u/r),C=Math.floor((h-1)/r),M=Math.floor(m/r),T=Math.floor((p-1)/r),A=[];for(let R=M;R<=T;R++)for(let L=x;L<=C;L++){const W=L*r,D=R*r,V=Math.max(0,i-W),P=Math.max(0,o-D),O=Math.min(r,l-W),s=Math.min(r,d-D),G=Math.max(0,O-V),X=Math.max(0,s-P);G<=0||X<=0||A.push({chunkX:L,chunkY:R,worldX:W,worldY:D,startCol:V,startRow:P,tileCols:G,tileRows:X})}return A}ensureChunkCanvas(t,n,r){if(!t)return null;const i=this.buildChunkKey(t,n);if(r!=null&&r.has(i))return r.get(i);let o=gr.get(i);o||(o=this.createChunkCanvas(t,n),o&&gr.set(i,o));const a=o?{canvas:o,geometry:t}:{canvas:null,geometry:t};return r&&r.set(i,a),a}createChunkCanvas(t,n){if(!ea(this.map))return null;const r=n.tilePixelSize,i=n.padding,o=t.tileCols*r+i*2,a=t.tileRows*r+i*2,c=Number.isFinite(this.map.xStart)?this.map.xStart:0,l=Number.isFinite(this.map.yStart)?this.map.yStart:0,d=wg(Math.max(o,a));if(!d)return null;Number.isFinite(o)&&(d.width=o),Number.isFinite(a)&&(d.height=a);const u=d.getContext("2d");if(!u||!("clearRect"in u))return xg(d),null;const m=u;if(m.clearRect(0,0,d.width,d.height),n.usingWorld&&this.renderBiomeChunkToContext(m,t,n,i,i))return d;for(let h=t.startRow;h<t.startRow+t.tileRows;h++){const w=t.worldY+h-l;for(let x=t.startCol;x<t.startCol+t.tileCols;x++){const M=t.worldX+x-c;if(w<0||M<0)continue;const T=ta(this.map.types,M,w,null),A=i+(x-t.startCol)*r,E=i+(h-t.startRow)*r;this.drawTileBase(m,A,E,n,T)}}return d}drawTileBase(t,n,r,i,o){const a=i.tilePixelSize,c=i.tilePixelSize,l=this.useTerrainColors?this.getTerrainGradient(o):null,d=this.useTerrainColors?this.getTerrainColor(o):"rgba(148, 163, 184, 0.25)";if(Qo(t,n,r,a,c,i.cornerRadius),l&&(l.start||l.end)){const u=l.start||d||i.strokeColor,m=l.end||u,h=t.createLinearGradient(n,r,n,r+c);h.addColorStop(0,u),h.addColorStop(1,m),t.fillStyle=h}else t.fillStyle=d||i.strokeColor;t.fill(),t.save(),t.lineWidth=i.strokeWidth,t.lineJoin="round",t.lineCap="round",t.strokeStyle=i.strokeColor,t.globalAlpha=i.gapAlpha,Qo(t,n,r,a,c,i.cornerRadius),t.stroke(),t.restore()}renderBiomeChunkToContext(t,n,r,i=0,o=0){var M,T,A,E;if(!((A=(T=(M=this.world)==null?void 0:M.layers)==null?void 0:T.biome)!=null&&A.length))return!1;const a=((E=this.world)==null?void 0:E.dimensions)||{},c=Math.max(0,Math.trunc(a.width||0)),l=Math.max(0,Math.trunc(a.height||0));if(!c||!l)return!1;const d=Number.isFinite(r.tilePixelSize)?r.tilePixelSize:this.tileBaseSize,u=Math.max(1,Math.round(d)),m=n.tileCols*u,h=n.tileRows*u;if(m<=0||h<=0)return!1;let p;try{p=t.createImageData(m,h)}catch{try{p=new ImageData(m,h)}catch{return!1}}const w=new Uint32Array(p.data.buffer),x=m,C=this.world.layers.biome;for(let R=n.startRow;R<n.startRow+n.tileRows;R+=1){const L=n.worldY+R;if(L<0||L>=l)continue;const D=(R-n.startRow)*u*x,V=L*c;for(let P=n.startCol;P<n.startCol+n.tileCols;P+=1){const O=n.worldX+P;if(O<0||O>=c)continue;const s=P-n.startCol,G=V+O,X=C[G]??0,re=Mg(X);for(let q=0;q<u;q+=1){let ee=D+q*x+s*u;for(let Me=0;Me<u;Me+=1)w[ee++]=re}}}return t.putImageData(p,i,o),this.drawChunkGridLines(t,n,r,i,o),!0}drawChunkGridLines(t,n,r,i=0,o=0){if(!r.usingWorld)return;const a=r.gridColor||"rgba(15, 23, 42, 0.32)",c=Number.isFinite(r.tilePixelSize)?r.tilePixelSize:this.tileBaseSize,l=Math.max(1,Math.round(c)),d=n.tileCols*l,u=n.tileRows*l;if(!(d<=0||u<=0)){t.save(),t.translate(i,o),t.strokeStyle=a,t.globalAlpha=r.gapAlpha,t.lineWidth=Math.max(1,Math.round(l*.08));for(let m=1;m<n.tileCols;m+=1){const h=m*l+.5;t.beginPath(),t.moveTo(h,0),t.lineTo(h,u),t.stroke()}for(let m=1;m<n.tileRows;m+=1){const h=m*l+.5;t.beginPath(),t.moveTo(0,h),t.lineTo(d,h),t.stroke()}t.restore()}}drawChunkDirect(t,n,r){var a,c;const i=Number.isFinite((a=this.map)==null?void 0:a.xStart)?this.map.xStart:0,o=Number.isFinite((c=this.map)==null?void 0:c.yStart)?this.map.yStart:0;if(r.usingWorld){const l=n.worldX+n.startCol,d=n.worldY+n.startRow,u=this.camera.worldToScreen(l,d,this.tileBaseSize),m=Math.round(u.x)-r.padding,h=Math.round(u.y)-r.padding;if(this.renderBiomeChunkToContext(t,n,r,m+r.padding,h+r.padding))return}for(let l=n.startRow;l<n.startRow+n.tileRows;l++){const d=n.worldY+l,u=d-o;for(let m=n.startCol;m<n.startCol+n.tileCols;m++){const h=n.worldX+m,p=h-i;if(u<0||p<0)continue;const w=ta(this.map.types,p,u,null),x=this.camera.worldToScreen(h,d,this.tileBaseSize),C=Math.round(x.x),M=Math.round(x.y);this.drawTileBase(t,C,M,r,w)}}}drawMissingMapFallback(t,n){const r=this.viewportWidth,i=this.viewportHeight;if(r<=0||i<=0)return;const o=Xn("--surface-strong","rgba(17, 24, 39, 0.78)");o&&(t.fillStyle=o,t.fillRect(0,0,r,i));const a=Xn("--text-strong","#ffffff"),c=Math.max(12,Math.round(Math.min(r,i)/12));t.fillStyle=a||"#ffffff",t.font=`600 ${c}px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(n,r/2,i/2)}drawVisibleDevelopments(t,n){var d,u;if(!this.developments||this.developments.size===0)return;const r=((d=this.map)==null?void 0:d.xStart)??0,i=((u=this.map)==null?void 0:u.yStart)??0,{width:o,height:a}=Rs(this.map),c=r+o,l=i+a;for(const m of this.developments.values()){if(!m)continue;const h=Number.isFinite(m.x)?m.x:null,p=Number.isFinite(m.y)?m.y:null;if(h===null||p===null||h<r||p<i||h>=c||p>=l)continue;const{x:w,y:x}=this.camera.worldToScreen(h,p,this.tileBaseSize),C=Math.round(w),M=Math.round(x);this.drawDevelopmentOverlay(t,C,M,n,m)}}hitTest(t,n){var C,M,T,A;if(!ea(this.map))return null;const r=this.camera.screenToTile(t,n,this.tileBaseSize),i=Math.floor(r.x),o=Math.floor(r.y),a=i-this.map.xStart,c=o-this.map.yStart,{width:l,height:d}=Rs(this.map);if(c<0||a<0||c>=d||a>=l)return null;const u=ta(this.map.tiles,a,c,""),m=ta(this.map.types,a,c,null),h=`${i}:${o}`,p=this.developments.get(h)||null;let w=null,x=null;if((T=(M=(C=this.world)==null?void 0:C.layers)==null?void 0:M.biome)!=null&&T.length){const E=((A=this.world)==null?void 0:A.dimensions)||{},R=Math.max(0,Math.trunc(E.width||0)),L=Math.max(0,Math.trunc(E.height||0));if(R&&L&&i>=0&&o>=0&&i<R&&o<L){const W=o*R+i;W>=0&&W<this.world.layers.biome.length&&(w=W,x=this.world.layers.biome[W]??null)}}return{x:i,y:o,col:a,row:c,symbol:u??"",type:m??null,development:p,index:w,biomeCode:x}}configureCanvasSize(t,n){this.devicePixelRatio=typeof window<"u"&&window.devicePixelRatio||1;const r=Math.max(1,Math.round(t*this.devicePixelRatio)),i=Math.max(1,Math.round(n*this.devicePixelRatio));this.canvas.width!==r&&(this.canvas.width=r),this.canvas.height!==i&&(this.canvas.height=i),this.canvas.style.width=`${t}px`,this.canvas.style.height=`${n}px`}drawDevelopmentOverlay(t,n,r,i,o){const a=Ng(o.status),c=Math.max(1,Math.round(i*.08)),l=Math.max(2,Math.round(i*.18)),d=Math.max(1,Math.ceil(i)),u=Math.max(1,Math.ceil(i)),m=Math.max(1,i*Ec);t.save(),t.lineWidth=c,t.strokeStyle=a,t.globalAlpha=.85;const h=Math.max(1,m-l*.6);if(Qo(t,n+l,r+l,Math.max(1,d-l*2),Math.max(1,u-l*2),h),t.stroke(),o.emphasis||o.highlight){t.lineWidth=Math.max(c*.6,1),t.globalAlpha=.45;const p=Math.max(1,l-c*1.2),w=Math.max(1,m-p*.5);Qo(t,n+p,r+p,Math.max(1,d-p*2),Math.max(1,u-p*2),w),t.stroke()}t.restore()}}function Bg(e,t){return new Fg(e,t)}const Tc=(e,t,n)=>Number.isNaN(e)||e<t?t:e>n?n:e;function Lg(e,t={}){const n=typeof t.size=="number"&&Number.isFinite(t.size)?`${t.size}px`:typeof t.size=="string"?t.size:"48px",r=t.variant||"square",i=t.fontSize||(r==="chip"?"16px":"18px"),o=r==="stacked",a=t.square??!o,c=t.padding!==void 0?t.padding:a?"0":r==="chip"?"0 12px":"0";e.style.boxSizing="border-box",e.style.width=a?n:o?"auto":n,e.style.minWidth=n,e.style.height=a&&!o?n:o?"auto":n,e.style.minHeight=n,e.style.flexBasis=a?n:"auto",e.style.padding=c,e.style.fontSize=i,e.style.display="inline-flex",e.style.flexDirection=o?"column":"row",e.style.gap=o?"2px":"0",e.style.alignItems="center",e.style.justifyContent="center",e.style.borderRadius="12px",e.style.border="1px solid var(--map-control-border, var(--map-border, #ccc))",e.style.background="var(--map-control-bg, var(--bg-color, #fff))",e.style.color="var(--map-control-fg, inherit)",e.style.lineHeight=a?"1":"1.1",e.style.whiteSpace="nowrap",e.style.cursor="pointer",e.style.transition="background 0.2s ease, transform 0.1s ease",e.style.boxShadow="var(--map-control-shadow, 0 1px 2px rgba(0, 0, 0, 0.08))",e.style.fontWeight="600",e.style.textAlign="center",e.style.flexShrink="0",e.style.fontVariantNumeric="tabular-nums"}function Rg(e){const t=e.styleButton||Lg,n=document.createElement("div");n.className="map-zoom-controls",n.style.display="flex",n.style.flexDirection="row",n.style.flexWrap="nowrap",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.alignSelf="center",n.style.marginTop="12px",n.style.marginInline="auto",n.style.boxSizing="border-box",n.style.flex="0 0 auto",n.style.maxWidth="100%",n.style.pointerEvents="auto";const r=(d,u,m)=>{const h=document.createElement("button");return h.type="button",h.textContent=d,h.setAttribute("aria-label",u),t(h,m),h},i=48,o=r("âˆ’","Zoom out",{fontSize:"22px",square:!0,size:i}),a=r("+","Zoom in",{fontSize:"22px",square:!0,size:i}),c=r("100%","Reset zoom to 100%",{fontSize:"15px",square:!0,size:i});return c.classList.add("map-zoom-reset"),o.addEventListener("click",d=>{d.preventDefault(),e.onZoomOut()}),a.addEventListener("click",d=>{d.preventDefault(),e.onZoomIn()}),c.addEventListener("click",d=>{d.preventDefault(),e.onZoomReset()}),n.appendChild(o),n.appendChild(a),n.appendChild(c),{element:n,update(d){var A,E,R;const u=((A=d.camera)==null?void 0:A.zoom)??d.zoom,m=((E=d.camera)==null?void 0:E.minZoom)??d.minZoom,h=((R=d.camera)==null?void 0:R.maxZoom)??d.maxZoom,p=Number.isFinite(d.baselineZoom)?d.baselineZoom:1,w=Tc(u,0,Number.isFinite(h)?h:8),x=Tc(m,0,w),C=h>0?h:Math.max(w,1),M=Math.round(w*100),T=Math.round(p*100);c.textContent=`${M}%`,c.setAttribute("aria-label",`Reset zoom to ${T}% (current ${M}%)`),o.disabled=w<=x+.001,a.disabled=w>=C-.001}}}const Ig=new Map([["complete","completed"],["completed","completed"],["built","completed"],["finished","completed"],["constructed","completed"],["constructing","under-construction"],["building","under-construction"],["under construction","under-construction"],["under-construction","under-construction"],["in-progress","under-construction"],["progress","under-construction"],["queued","planned"],["pending","planned"],["planned","planned"],["noted","noted"],["mixed","mixed"]].map(([e,t])=>[e,t])),Hg=Object.freeze({ArrowUp:{dx:0,dy:-1},ArrowDown:{dx:0,dy:1},ArrowLeft:{dx:-1,dy:0},ArrowRight:{dx:1,dy:0}}),zg=220,$g="debug",Og="1",Ac=5;function Nc(){if(typeof window>"u"||typeof URLSearchParams>"u")return!1;try{return new URLSearchParams(window.location.search).get($g)===Og}catch{return!1}}function Pa(e){return Number.isFinite(e)?Math.trunc(e):null}function zr(e,t,n){return!Number.isFinite(e)||t>n?e:Math.min(n,Math.max(t,e))}function fu(e,t="noted"){if(!e)return t;const n=String(e).trim().toLowerCase();return Ig.get(n)||t}function mu(e){return e?typeof e=="string"?e:e.name||e.label||e.title||e.typeName||e.typeId||(typeof e.toString=="function"?e.toString():"")||"":""}function Fc(e,t=0){var m,h;if(!e)return null;const n=typeof e=="object"?e:{structures:[e]},r=Pa(n.x??n.col??n.column??n.tileX??((m=n.tile)==null?void 0:m.x)),i=Pa(n.y??n.row??n.tileY??((h=n.tile)==null?void 0:h.y));if(r===null||i===null)return null;const a=(Array.isArray(n.structures)?n.structures:Array.isArray(n.projects)?n.projects:n.structure?[n.structure]:n.name?[n.name]:[]).map(p=>mu(p)).map(p=>String(p||"").trim()).filter(Boolean),c=fu(n.status||n.state||n.progress||null),l=[];n.tooltip&&l.push(String(n.tooltip)),n.details&&l.push(String(n.details)),n.description&&l.push(String(n.description)),l.length===0&&a.length&&l.push(a.join(", "));const d=n.label||(a.length?a[0]:"")||n.name||n.title||`Development ${t+1}`,u=Number.isFinite(n.count)?Math.max(0,Math.trunc(n.count)):a.length;return{x:r,y:i,status:c,structures:a,label:d,tooltip:l.join(" â€¢ "),count:u,emphasis:n.emphasis===!0,highlight:n.highlight===!0}}function Bc(e){if(!e||typeof e!="object")return null;const t={};for(const[n,r]of Object.entries(e)){if(!n&&n!==0)continue;const i=String(n).trim().toLowerCase();if(!i||r==null)continue;const o=String(r).trim();o&&(t[i]=o)}return Object.keys(t).length?t:null}function _g(e){const t=[],n=[],r=[],i=[];e.items.forEach(d=>{const u=mu(d),m=String(u||"").trim()||"Structure",h=fu(d.status||d.state||d.progress||null,"planned");h==="completed"?t.push(m):h==="under-construction"?n.push(m):r.push(m),d.details?i.push(String(d.details)):d.description&&i.push(String(d.description))});const o=[];t.length&&o.push(`${t.length>1?"Completed structures":"Completed structure"}: ${t.join(", ")}`),n.length&&o.push(`${n.length>1,"Under construction"}: ${n.join(", ")}`),r.length&&o.push(`Planned: ${r.join(", ")}`),i.length&&o.push(i.join(" â€¢ "));let a="noted";n.length?a=t.length?"mixed":"under-construction":t.length?a="completed":r.length&&(a="planned");const c=[...t,...n,...r],l=e.label||c[0]||"Development";return{x:e.x,y:e.y,status:a,structures:c,label:l,tooltip:o.join(" â€¢ "),count:c.length,emphasis:!!e.emphasis,highlight:!!e.highlight}}function Pg(e={},t={}){const n=[],r=new Set,i=t.developments??e.developments??e.development??e.developmentTiles??null;Array.isArray(i)?i.forEach((a,c)=>{const l=Fc(a,c);if(!l)return;const d=`${l.x}:${l.y}`;r.add(d),n.push(l)}):i&&typeof i=="object"&&Object.values(i).forEach((a,c)=>{const l=Fc(a,c);if(!l)return;const d=`${l.x}:${l.y}`;r.add(d),n.push(l)});const o=Array.isArray(t.structures)?t.structures:Array.isArray(e.structures)?e.structures:[];if(o.length){const a=new Map;o.forEach(c=>{if(!c)return;const l=c.tile||c.location||c.coords||{},d=Pa(c.x??l.x??c.col),u=Pa(c.y??l.y??c.row);if(d===null||u===null)return;const m=`${d}:${u}`;a.has(m)||a.set(m,{x:d,y:u,items:[],label:c.label||c.name||null,emphasis:c.emphasis,highlight:c.highlight}),a.get(m).items.push(c)}),a.forEach((c,l)=>{if(r.has(l))return;const d=_g(c);d&&(r.add(l),n.push(d))})}return n}const Dg={water:"Water",ocean:"Ocean",lake:"Lake",river:"River",marsh:"Marsh",mangrove:"Mangrove Forest",open:"Open Land",forest:"Forest",ore:"Ore Deposits",stone:"Stone Outcrop"},Lc=12,Rc=16;function jg(e,t,n){const r=Math.max(0,(e==null?void 0:e.width)??(e==null?void 0:e.cols)??ho(e,0)),i=Math.max(0,(e==null?void 0:e.height)??(e==null?void 0:e.rows)??po(e,0)),o=Math.max(0,t||0),a=Math.max(0,n||0);return{x:Math.max(0,Math.floor((r-o)/2)),y:Math.max(0,Math.floor((i-a)/2))}}const at=Er;function hr(e){typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(e):setTimeout(e,0)}function Ie(e,t=0){return Number.isFinite(e)?Math.trunc(e):t}function hu(e){var o,a,c,l;if(!e||typeof e!="object")return{width:0,height:0};const t=Ie(e.width??e.cols??((o=e.dimensions)==null?void 0:o.width)??((a=e.shape)==null?void 0:a.width),0),n=Ie(e.height??e.rows??((c=e.dimensions)==null?void 0:c.height)??((l=e.shape)==null?void 0:l.height),0);if(t&&n)return{width:t,height:n};const r=e.tiles??e.tileMatrix??null;if(r&&typeof r=="object"){const d=Ie(r.width??r.cols,0),u=Ie(r.height??r.rows,0);if(d&&u)return{width:d,height:u}}if(Array.isArray(r)){const d=r.length,u=d?Array.isArray(r[0])?r[0].length||0:r.length:0;if(u&&d)return{width:u,height:d}}if(Array.isArray(e.tiles)){const d=e.tiles.length,u=d?Array.isArray(e.tiles[0])?e.tiles[0].length||0:e.tiles.length:0;if(u&&d)return{width:u,height:d}}if(Array.isArray(e.types)){const d=e.types.length,u=d?Array.isArray(e.types[0])?e.types[0].length||0:e.types.length:0;if(u&&d)return{width:u,height:d}}const i=Ie(e.size??e.length,0);if(i&&t){const d=Math.max(1,Math.trunc(i/t));return{width:t,height:d}}return{width:0,height:0}}function Wg(e){return e&&typeof e=="object"&&Number.isFinite(e.width)&&Number.isFinite(e.height)&&typeof e.get=="function"&&typeof e.getIndex=="function"}function Wr(e,{width:t,height:n,baseWidth:r=t,baseHeight:i=n,defaultValue:o=null,offsetX:a=0,offsetY:c=0}){const l=Math.max(0,Math.trunc(t||0)),d=Math.max(0,Math.trunc(n||0)),u=Math.max(l,Math.trunc(r||l||0)),m=Math.max(d,Math.trunc(i||d||0)),h=Math.max(0,Math.trunc(a||0)),p=Math.max(0,Math.trunc(c||0));return{data:e,width:l,height:d,baseWidth:u,baseHeight:m,offsetX:h,offsetY:p,size:l*d,defaultValue:o,get(x,C){const M=Math.trunc(x),T=Math.trunc(C);if(!Number.isFinite(M)||!Number.isFinite(T)||M<0||T<0||M>=this.width||T>=this.height)return o;const A=this.offsetX+M,E=this.offsetY+T;if(A<0||E<0||A>=this.baseWidth||E>=this.baseHeight)return o;const R=E*this.baseWidth+A;return!e||R<0||R>=e.length?o:e[R]??o},getIndex(x){if(!Number.isFinite(x)||x<0||x>=this.size)return o;const C=x%this.width,M=Math.trunc(x/this.width);return this.get(C,M)},getByWorld(x,C){const M=Math.trunc(x),T=Math.trunc(C);if(!Number.isFinite(M)||!Number.isFinite(T)||M<0||T<0||M>=this.baseWidth||T>=this.baseHeight)return o;const A=T*this.baseWidth+M;return!e||A<0||A>=e.length?o:e[A]??o},slice(x,C,M,T){const A=Math.max(0,Math.trunc(M||0)),E=Math.max(0,Math.trunc(T||0)),R=this.offsetX+Math.max(0,Math.trunc(x||0)),L=this.offsetY+Math.max(0,Math.trunc(C||0)),W=Math.max(0,this.baseWidth-R),D=Math.max(0,this.baseHeight-L),V=Math.min(A,W),P=Math.min(E,D);return Wr(e,{width:V,height:P,baseWidth:this.baseWidth,baseHeight:this.baseHeight,defaultValue:o,offsetX:R,offsetY:L})}}}function Is(e,t,n,r=null){if(!t||!n)return Wr(new Array(0),{width:0,height:0,baseWidth:0,baseHeight:0,defaultValue:r});if(Wg(e))return e;const i=Math.max(0,t*n);if(Array.isArray(e)){if(e.length===i&&!Array.isArray(e[0]))return Wr(e,{width:t,height:n,baseWidth:t,baseHeight:n,defaultValue:r});if(Array.isArray(e[0])){const a=new Array(i);for(let c=0;c<n;c+=1){const l=e[c]||[];for(let d=0;d<t;d+=1)a[c*t+d]=l[d]??r}return Wr(a,{width:t,height:n,baseWidth:t,baseHeight:n,defaultValue:r})}if(e.length>=i)return Wr(e,{width:t,height:n,baseWidth:t,baseHeight:n,defaultValue:r})}if(typeof ArrayBuffer<"u"&&ArrayBuffer.isView&&ArrayBuffer.isView(e))return Wr(e,{width:t,height:n,baseWidth:t,baseHeight:n,defaultValue:r});const o=new Array(i);for(let a=0;a<i;a+=1)o[a]=r;return Wr(o,{width:t,height:n,baseWidth:t,baseHeight:n,defaultValue:r})}function Hs(e,t,n,r,i){return!e||typeof e.slice!="function"?null:e.slice(t,n,r,i)}function pu(e){var r,i,o,a;const t=Number.isFinite((i=(r=e.world)==null?void 0:r.dimensions)==null?void 0:i.width)?Math.max(0,Math.trunc(e.world.dimensions.width)):0,n=Number.isFinite((a=(o=e.world)==null?void 0:o.dimensions)==null?void 0:a.height)?Math.max(0,Math.trunc(e.world.dimensions.height)):0;return{width:t,height:n}}function Ic(e,t,n){const{width:r,height:i}=pu(e);if(!r||!i)return-1;const o=Math.trunc(t),a=Math.trunc(n);return o<0||a<0||o>=r||a>=i?-1:a*r+o}function $r(e,t,n=0){if(!e||t<0||t>=e.length)return n;const r=e[t];return Number.isFinite(r)?r:n}function Or(e,t=0){if(!Number.isFinite(e))return"0%";const n=e*100,r=10**t;return`${(Math.round(n*r)/r).toFixed(t)}%`}function tn(e,t=0){return e&&Number.isFinite(e.width)?Math.max(0,Math.trunc(e.width)):t}function nn(e,t=0){return e&&Number.isFinite(e.height)?Math.max(0,Math.trunc(e.height)):t}function ho(e,t=0){return e?Number.isFinite(e.baseWidth)?Math.max(0,Math.trunc(e.baseWidth)):tn(e,t):t}function po(e,t=0){return e?Number.isFinite(e.baseHeight)?Math.max(0,Math.trunc(e.baseHeight)):nn(e,t):t}function Hc(e){if(!e)return null;const t=e.buffer&&(e.buffer.tiles||e.buffer.tileData||e.buffer.layers)?e.buffer:e;if(!t||typeof t!="object")return null;const{width:n,height:r}=hu(t),i=Math.max(0,Ie(t.width,n)),o=Math.max(0,Ie(t.height,r));if(!i||!o)return null;const a=t.layers??t.layerBuffers??null,c=t.elevations??(a==null?void 0:a.elevation)??(t.layerBuffers?t.layerBuffers.elevation:null),l=t.types??null,d=t.tiles??t.tileMatrix??null,u=Is(d,i,o,""),m=l?Is(l,i,o,null):null,h=c?Is(c,i,o,0):null,p=Array.isArray(t.tileData)?t.tileData:t.tilesFlat&&Array.isArray(t.tilesFlat)?t.tilesFlat:null;return{...t,tiles:u,types:m,elevations:h,layers:a,tileData:p,width:i,height:o,size:i*o,xStart:Ie(t.xStart,0),yStart:Ie(t.yStart,0),world:t.world||null}}function qg(e,t=0,n=0){if(t&&n)return{width:t,height:n};if(!e)return{width:at,height:at};const{width:r,height:i}=hu(e);if(r||i){const o=Math.max(r,i);return{width:o||at,height:o||at}}return{width:at,height:at}}function gu(e,{legendLabels:t=Dg,showControls:n=!0,showLegend:r=!0,allowDrag:i=!0,idPrefix:o="map",fetchMap:a=null,onMapUpdate:c=null,onTileClick:l=null,navMode:d="viewport",onNavigate:u=null,actions:m={},jobSelector:h=null,useTerrainColors:p=!1,terrainColors:w=null,bufferMargin:x=Lc,minZoom:C=.5,maxZoom:M=3,initialZoom:T=1,controlsContainer:A=null}={}){if(!e)throw new Error("Container is required for map view");const E=Bc(w),R=Number.isFinite(x)?Math.max(0,Math.trunc(x)):Lc,L=Number.isFinite(C)?Math.max(.1,C):.5,W=Number.isFinite(M)?Math.max(L,M):3,D=Number.isFinite(T)?T:1,V=Math.min(W,Math.max(L,D)),P=(f,{size:g=48,fontSize:v="18px",variant:b="square",square:N,padding:B}={})=>{const _=typeof g=="number"&&Number.isFinite(g)?`${g}px`:`${g}`,z=b==="stacked",j=N??!z,J=B!==void 0?B:j?"0":b==="chip"?"0 12px":"0";f.style.boxSizing="border-box",f.style.width=j?_:z?"auto":_,f.style.minWidth=_,f.style.height=j&&!z?_:z?"auto":_,f.style.minHeight=_,f.style.flexBasis=j?_:"auto",f.style.padding=J,f.style.fontSize=v,f.style.display="inline-flex",f.style.flexDirection=z?"column":"row",f.style.gap=z?"2px":"0",f.style.alignItems="center",f.style.justifyContent="center",f.style.borderRadius="12px",f.style.border="1px solid var(--map-control-border, var(--map-border, #ccc))",f.style.background="var(--map-control-bg, var(--bg-color, #fff))",f.style.color="var(--map-control-fg, inherit)",f.style.lineHeight=j?"1":"1.1",f.style.whiteSpace="nowrap",f.style.cursor="pointer",f.style.transition="background 0.2s ease, transform 0.1s ease",f.style.boxShadow="var(--map-control-shadow, 0 1px 2px rgba(0, 0, 0, 0.08))",f.style.fontWeight="600",f.style.textAlign="center",f.style.flexShrink="0",f.style.fontVariantNumeric="tabular-nums"},O=Nc(),s={map:null,buffer:null,world:null,context:{},home:{xStart:0,yStart:0},focus:{x:0,y:0},viewport:{width:0,height:0,xStart:0,yStart:0},drag:{active:!1,lastX:0,lastY:0,pendingX:0,pendingY:0,fractionalX:0,fractionalY:0},keyboardPan:{timer:null},resizeHandler:null,fetchMap:a,onMapUpdate:c,onTileClick:typeof l=="function"?l:null,navMode:d==="player"?"player":"viewport",onNavigate:typeof u=="function"?u:null,bufferMargin:R,bufferPadding:{x:R,y:R},expectedBufferPadding:{x:R,y:R},zoom:V,minZoom:L,maxZoom:W,initialZoom:V,zoomBase:{width:0,height:0},zoomDisplayFactor:1,tileBaseSize:Rc,camera:null,renderer:null,renderScheduled:!1,markerLayer:null,dataLayer:null,markerElements:new Map,markerDefs:[],spawnSuggestionMarkers:[],spawnSuggestionRank:new Map,spawnSuggestionLimit:Ac,useTerrainColors:!!p,terrainColorOverrides:E,pendingZoomSync:!1,developmentTiles:new Map,hasInitializedBaseChunk:!1,debug:{enabled:O,overlay:null,fps:0,lastRenderTimestamp:0,pointerTile:null}},G=()=>s.camera?s.camera.zoom:s.zoom;function X(){var _;if(s.spawnSuggestionRank.clear(),!((_=s.world)!=null&&_.spawnSuggestions)||!s.world.spawnSuggestions.length){s.spawnSuggestionMarkers=[],mn();return}const{width:f,height:g}=pu(s);if(!f||!g){s.spawnSuggestionMarkers=[],mn();return}const v=s.world.spawnSuggestions,b=Math.max(1,Math.min(s.spawnSuggestionLimit||Ac,v.length)),N=[];for(let z=0;z<b;z+=1){const j=v[z],J=j%f,te=Math.floor(j/f);s.spawnSuggestionRank.set(j,z),N.push({id:`spawn-suggestion-${z}`,x:J,y:te,icon:z===0?"â˜…":"â˜†",className:"map-marker--suggestion",emphasis:z===0,label:`Spawn suggestion #${z+1}`,color:z===0?"var(--map-suggestion-primary, #facc15)":"var(--map-suggestion-secondary, #fde047)",index:j})}const B=N.map((z,j)=>lr(z,j)).filter(Boolean);s.spawnSuggestionMarkers=B,mn()}function re(f){s.world!==f&&(s.world=f||null,s.spawnSuggestionRank.clear(),s.spawnSuggestionMarkers=[],s.renderer&&s.renderer.setWorld(s.world),X())}const q=()=>{var v,b,N,B;const f=Number.isFinite((v=s.map)==null?void 0:v.width)?Math.max(0,Math.trunc(s.map.width)):tn((b=s.map)==null?void 0:b.tiles,0),g=Number.isFinite((N=s.map)==null?void 0:N.height)?Math.max(0,Math.trunc(s.map.height)):nn((B=s.map)==null?void 0:B.tiles,0);return{cols:f,rows:g}};function ee(f){const g=qg(f,s.viewport.width,s.viewport.height);s.viewport.width=Math.max(1,Ie(g.width,at)),s.viewport.height=Math.max(1,Ie(g.height,at))}function Me(f){if(!f)return null;const g=Number.isFinite(f.width)?Math.max(0,Math.trunc(f.width)):ho(f.tiles,0),v=Number.isFinite(f.height)?Math.max(0,Math.trunc(f.height)):po(f.tiles,0);if(!g||!v)return null;const b=Math.min(Math.max(1,s.viewport.width||at),g),N=Math.min(Math.max(1,s.viewport.height||at),v);s.viewport.width=b,s.viewport.height=N;const B=f.xStart??0,_=f.yStart??0,z=Math.max(0,g-b),j=Math.max(0,v-N);let J=Ie(s.viewport.xStart,B)-B,te=Ie(s.viewport.yStart,_)-_;return J=Math.max(0,Math.min(z,J)),te=Math.max(0,Math.min(j,te)),s.viewport.xStart=B+J,s.viewport.yStart=_+te,{offsetX:J,offsetY:te,originX:B,originY:_,width:b,height:N}}function me(){var j,J,te,fe,ge,Be;if(!((j=s.buffer)!=null&&j.tiles))return!1;const f=Me(s.buffer);if(!f)return!1;const{offsetX:g,offsetY:v,width:b,height:N}=f,B=Hs(s.buffer.tiles,g,v,b,N);if(!B||B.size!==b*N)return!1;const _=s.buffer.types?Hs(s.buffer.types,g,v,b,N):null,z=s.buffer.elevations?Hs(s.buffer.elevations,g,v,b,N):null;return s.map={...s.map,seed:s.buffer.seed??((J=s.map)==null?void 0:J.seed),season:s.buffer.season??((te=s.map)==null?void 0:te.season),waterLevel:s.buffer.waterLevel??((fe=s.map)==null?void 0:fe.waterLevel),tiles:B,types:_,elevations:z,layers:s.buffer.layers??((ge=s.map)==null?void 0:ge.layers)??null,tileData:s.buffer.tileData??((Be=s.map)==null?void 0:Be.tileData)??null,xStart:s.viewport.xStart,yStart:s.viewport.yStart,width:b,height:N,viewport:{...s.viewport},world:s.world},!0}function _e(){var g;if(!s.map)return null;const f={seed:s.map.seed,season:s.map.season,waterLevel:s.map.waterLevel,tiles:s.map.tiles,types:s.map.types,elevations:s.map.elevations,xStart:s.map.xStart,yStart:s.map.yStart,width:s.map.width,height:s.map.height,viewport:{...s.viewport},world:s.world};if((g=s.buffer)!=null&&g.tiles){const v=Number.isFinite(s.buffer.width)?Math.max(0,Math.trunc(s.buffer.width)):ho(s.buffer.tiles,0),b=Number.isFinite(s.buffer.height)?Math.max(0,Math.trunc(s.buffer.height)):po(s.buffer.tiles,0);f.buffer={seed:s.buffer.seed,season:s.buffer.season,waterLevel:s.buffer.waterLevel,tiles:s.buffer.tiles,types:s.buffer.types,elevations:s.buffer.elevations,xStart:s.buffer.xStart,yStart:s.buffer.yStart,width:v,height:b},s.buffer.world&&(f.buffer.world=s.buffer.world)}return f}function je(){var B,_;const f=Math.max(.001,G()),g=Math.max(1,Math.trunc(s.zoomBase.width||s.viewport.width||((B=s.map)==null?void 0:B.width)||at)),v=Math.max(1,Math.trunc(s.zoomBase.height||s.viewport.height||((_=s.map)==null?void 0:_.height)||at)),b=Math.max(1,Math.round(g/f)),N=Math.max(1,Math.round(v/f));return{width:b,height:N}}function lt(){var _,z,j,J;if(!s.map){s.zoomDisplayFactor=1;return}const f=G();if(Math.abs(f-1)<.001){s.zoomDisplayFactor=1;return}const g=je(),v=Number.isFinite((_=s.map)==null?void 0:_.width)&&s.map.width>0?Math.trunc(s.map.width):tn((z=s.map)==null?void 0:z.tiles,g.width),b=Number.isFinite((j=s.map)==null?void 0:j.height)&&s.map.height>0?Math.trunc(s.map.height):nn((J=s.map)==null?void 0:J.tiles,g.height),N=Math.abs(v-g.width)<=1,B=Math.abs(b-g.height)<=1;s.zoomDisplayFactor=N&&B?1:f}function Ht({forceFetch:f=!1}={}){const g=G();if(!s.map){s.zoomDisplayFactor=Math.abs(g-1)<.001?1:g;return}const v=je(),b=Math.max(1,s.viewport.width||s.map.width||v.width),N=Math.max(1,s.viewport.height||s.map.height||v.height),B=Math.max(1,v.width),_=Math.max(1,v.height),z=B!==b,j=_!==N,J=s.viewport.xStart+Math.floor(b/2),te=s.viewport.yStart+Math.floor(N/2);if(s.viewport.width=B,s.viewport.height=_,s.home=gi(s.focus),!z&&!j){f?nt(s.viewport.xStart,s.viewport.yStart,{forceFetch:!0}):(lt(),hr(I),hr(mn));return}const fe=J-Math.floor(B/2),ge=te-Math.floor(_/2);nt(fe,ge)}function zt(f){if(!s.useTerrainColors)return null;const g=typeof f=="string"&&f?f.trim().toLowerCase():"open",v=s.terrainColorOverrides||null;return v&&v[g]?v[g]:fg(g)}function wt(f){if(!s.useTerrainColors)return null;const g=typeof f=="string"&&f?f.trim().toLowerCase():"open",v=s.terrainColorOverrides||null;return v&&v[g]?ou(v[g]):ug(g)}const Pe=["map-tile--developed","map-tile--developed-pending","map-tile--developed-complete","map-tile--developed-mixed","map-tile--developed-planned","map-tile--developed-emphasis"];function kt(f,g){return`${Math.trunc(f??0)}:${Math.trunc(g??0)}`}function cn(f,g){return!Number.isFinite(f)||!Number.isFinite(g)?null:s.developmentTiles.get(kt(f,g))||null}function vn(f,g=0){if(!f&&f!==0)return null;const v=Number(f.x),b=Number(f.y);if(!Number.isFinite(v)||!Number.isFinite(b))return null;const N=Math.trunc(v),B=Math.trunc(b),_=typeof f.status=="string"?f.status.trim().toLowerCase():"";let z="";switch(_){case"completed":case"complete":case"built":z="completed";break;case"under-construction":case"construction":case"in-progress":case"building":z="under-construction";break;case"mixed":z="mixed";break;case"planned":case"planning":case"queued":z="planned";break;default:z=_||""}const j=Array.isArray(f.structures)?f.structures.map(be=>String(be||"").trim()).filter(Boolean):[],J=Number.isFinite(f.count)?Math.max(0,Math.trunc(f.count)):j.length,te=typeof f.label=="string"&&f.label.trim()?f.label.trim():j[0]||"Development",fe=[],ge=be=>{typeof be=="string"&&be.trim()&&fe.push(be.trim())};ge(f.tooltip),ge(f.details),ge(f.description),ge(f.summary),ge(f.note),!fe.length&&j.length>1&&fe.push(`Structures: ${j.join(", ")}`);const Be=fe.join(" â€¢ "),we=z||(j.length?"completed":J>0?"planned":"noted");return{key:kt(N,B),x:N,y:B,status:we,label:te,tooltip:Be,structures:j,count:J,emphasis:f.emphasis===!0,highlight:f.highlight===!0}}function Sn(f=[]){const g=Array.isArray(f)?f.map((b,N)=>vn(b,N)).filter(Boolean):[],v=new Map;g.forEach(b=>{v.set(b.key,b)}),s.developmentTiles=v,s.renderer&&s.renderer.setDevelopments(s.developmentTiles),Nt(),Ft()}function Mn(){var v,b,N,B,_,z,j;if(!s.map)return;if(!s.hasInitializedBaseChunk&&((v=s.map.tiles)!=null&&v.size)&&(s.hasInitializedBaseChunk=!0),s.context={...s.context,focus:{...s.focus},viewport:{...s.viewport},world:s.world},typeof s.onMapUpdate=="function"){const J=_e();J&&s.onMapUpdate(J,s.context)}const f=Number.isFinite((b=s.map)==null?void 0:b.width)&&s.map.width>0?Math.trunc(s.map.width):tn((N=s.map)==null?void 0:N.tiles,s.viewport.width||((B=s.map)==null?void 0:B.width)||0),g=Number.isFinite((_=s.map)==null?void 0:_.height)&&s.map.height>0?Math.trunc(s.map.height):nn((z=s.map)==null?void 0:z.tiles,s.viewport.height||((j=s.map)==null?void 0:j.height)||0);if((!s.zoomBase.width||!s.zoomBase.height||Math.abs(s.zoom-1)<.001)&&(s.zoomBase.width=Math.max(1,f),s.zoomBase.height=Math.max(1,g)),lt(),ne(),ke({snap:!0}),y(),Nt(),s.pendingZoomSync){const J=Math.abs(s.zoomDisplayFactor-1)>=.001;s.pendingZoomSync=!1,J&&hr(()=>k(s.zoom,{force:!0}))}}function dn(){var Ae;if(!((Ae=s.buffer)!=null&&Ae.tiles))return!0;const f=Number.isFinite(s.buffer.width)?Math.max(0,Math.trunc(s.buffer.width)):ho(s.buffer.tiles,0),g=Number.isFinite(s.buffer.height)?Math.max(0,Math.trunc(s.buffer.height)):po(s.buffer.tiles,0);if(!f||!g)return!0;const v=s.viewport.width||f,b=s.viewport.height||g;if(f<v||g<b)return!0;const N=s.buffer.xStart??0,B=s.buffer.yStart??0,_=s.viewport.xStart-N,z=s.viewport.yStart-B;if(_<0||z<0)return!0;const j=s.bufferPadding||s.expectedBufferPadding||{x:0,y:0},J=Math.max(0,s.bufferMargin??0),te=Math.max(j.x||0,J),fe=Math.max(j.y||0,J),ge=te>0?Math.max(1,Math.floor(te/2)):0,Be=fe>0?Math.max(1,Math.floor(fe/2)):0,we=f-(_+v),be=g-(z+b);return _<ge||z<Be||we<ge||be<Be}function In(f,g,v={}){var Ve,Tn,_n,pn,cr,dr;if(typeof s.fetchMap!="function")return;const b=Math.max(1,s.viewport.width||at),N=Math.max(1,s.viewport.height||at),B=Math.max(0,s.bufferMargin??0),_=Math.max(B,b),z=Math.max(B,N),j=b+_*2,J=N+z*2,te=Ie(f,0),fe=Ie(g,0),ge=te-_,Be=fe-z,we=v.overrideSeed??((Ve=s.map)==null?void 0:Ve.seed)??((Tn=s.buffer)==null?void 0:Tn.seed)??((_n=s.context)==null?void 0:_n.seed),be=v.overrideSeason??((pn=s.map)==null?void 0:pn.season)??((cr=s.buffer)==null?void 0:cr.season)??((dr=s.context)==null?void 0:dr.season),Ae=v.skipSanityChecks??s.hasInitializedBaseChunk===!0;s.expectedBufferPadding={x:_,y:z};const vt={map:s.map,context:s.context,seed:we,season:be,xStart:ge,yStart:Be,width:j,height:J,skipSanityChecks:Ae,viewport:{xStart:te,yStart:fe,width:b,height:N}},Ne=s.fetchMap(vt);Ne&&typeof Ne.then=="function"?Ne.then(gn=>tr(gn,{targetX:te,targetY:fe})):tr(Ne,{targetX:te,targetY:fe})}function tr(f,{targetX:g,targetY:v}={}){const b=Hc(f);if(!b)return;const N=Number.isFinite(b.width)?Math.max(0,Math.trunc(b.width)):ho(b.tiles,0),B=Number.isFinite(b.height)?Math.max(0,Math.trunc(b.height)):po(b.tiles,0);if(b.width=N,b.height=B,s.buffer=b,b.world&&re(b.world),Number.isFinite(g)&&(s.viewport.xStart=Ie(g,b.xStart)),Number.isFinite(v)&&(s.viewport.yStart=Ie(v,b.yStart)),ee(b),!me()){const j=Math.min(s.viewport.width,b.width),J=Math.min(s.viewport.height,b.height);if(s.viewport.width=Math.max(1,j),s.viewport.height=Math.max(1,J),!me())return}const _=Math.max(1,Math.min(s.viewport.width,b.width||N)),z=Math.max(1,Math.min(s.viewport.height,b.height||B));s.bufferPadding=jg({width:b.width||N,height:b.height||B},_,z),s.expectedBufferPadding={...s.bufferPadding},Mn()}function nt(f,g,v={}){if(s.viewport.xStart=Ie(f,s.viewport.xStart),s.viewport.yStart=Ie(g,s.viewport.yStart),v.forceFetch||dn()){In(s.viewport.xStart,s.viewport.yStart,v);return}me()?Mn():In(s.viewport.xStart,s.viewport.yStart,v)}const ie=document.createElement("div");ie.className=`${o}-wrapper map-wrapper`,ie.style.position="relative",ie.style.border="1px solid var(--map-border, #ccc)",ie.style.background="var(--map-bg, #f4f4f4)",ie.style.overflow="hidden",ie.style.cursor=i?"grab":"default",ie.style.userSelect="none",ie.style.touchAction=i?"none":"auto",ie.style.boxSizing="border-box",ie.style.aspectRatio="auto",ie.style.flexShrink="0",ie.style.margin="0 auto",ie.hasAttribute("tabindex")||ie.setAttribute("tabindex","0");const xt=document.createElement("div");xt.className=`${o}-canvas map-canvas`,xt.style.position="absolute",xt.style.inset="0",xt.style.display="block",xt.style.overflow="hidden",xt.style.boxSizing="border-box",ie.appendChild(xt);const He=document.createElement("canvas");if(He.className=`${o}-display map-display`,He.style.position="absolute",He.style.inset="0",He.style.width="100%",He.style.height="100%",He.style.display="block",He.style.boxSizing="border-box",He.style.touchAction="none",xt.appendChild(He),s.debug.enabled){const f=document.createElement("pre");f.className=`${o}-debug-overlay map-debug-overlay`,Object.assign(f.style,{position:"absolute",top:"8px",left:"8px",margin:"0",padding:"8px 10px",borderRadius:"10px",background:"rgba(15, 23, 42, 0.78)",color:"#f8fafc",fontFamily:'SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',fontSize:"12px",lineHeight:"1.4",pointerEvents:"none",whiteSpace:"pre",minWidth:"180px",zIndex:"20",boxShadow:"0 8px 24px rgba(15, 23, 42, 0.45)",border:"1px solid rgba(148, 163, 184, 0.35)"}),ie.appendChild(f),s.debug.overlay=f,zn()}const Te=document.createElement("div");Te.className=`${o}-data map-display-data`,Te.style.display="none",Te.style.visibility="hidden",Te.style.pointerEvents="none",Te.setAttribute("aria-hidden","true"),xt.appendChild(Te),s.camera=mg({viewportWidth:ie.clientWidth||0,viewportHeight:ie.clientHeight||0,minZoom:s.minZoom,maxZoom:s.maxZoom,initialZoom:s.zoom,centerTile:{x:s.focus.x,y:s.focus.y}}),s.renderer=Bg(He,{camera:s.camera,tileBaseSize:s.tileBaseSize,useTerrainColors:s.useTerrainColors,getTerrainColor:f=>zt(f),getTerrainGradient:f=>wt(f),prefetchMargin:s.bufferMargin}),s.renderer.setWorld(s.world),s.renderer.setDevelopments(s.developmentTiles),s.renderer.setPrefetchMargin(s.bufferMargin),s.dataLayer=Te;const ct=document.createElement("div");ct.className=`${o}-marker-layer map-marker-layer`,ct.style.position="absolute",ct.style.left="0",ct.style.top="0",ct.style.pointerEvents="none",ct.style.zIndex="3",ct.style.display="block",ct.style.transformOrigin="top left",ct.style.width="100%",ct.style.height="100%",ct.style.transform="none",xt.appendChild(ct),s.markerLayer=ct,mn();const Hn=f=>{if(!s.renderer||!s.map)return null;const g=He.getBoundingClientRect(),v=f.clientX-g.left,b=f.clientY-g.top;return v<0||b<0||v>g.width||b>g.height?null:s.renderer.hitTest(v,b)};function zn(f={}){var we,be;if(!((we=s.debug)!=null&&we.enabled)||!s.debug.overlay)return;const g=typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now();if(f.fromRender){const Ae=s.debug.lastRenderTimestamp;if(Number.isFinite(Ae)&&Ae>0){const vt=g-Ae;if(vt>0){const Ne=1e3/vt,Ve=.85;s.debug.fps=s.debug.fps?s.debug.fps*Ve+Ne*(1-Ve):Ne}}s.debug.lastRenderTimestamp=g}const v=((be=s.camera)==null?void 0:be.centerTile)||s.focus||{x:0,y:0},b=s.debug.pointerTile,N=G(),B=Ae=>Number.isFinite(Ae)?`${Math.round(Ae*100)/100}`:"â€”",_=Number.isFinite(N)?`${Math.round(N*100)/100}Ã—`:"â€”",z=s.debug.fps?`${s.debug.fps.toFixed(1)} fps`:"n/a",j=(vi==null?void 0:vi.capacity)??null,J=(vi==null?void 0:vi.size)??null,te=(gr==null?void 0:gr.capacity)??null,fe=(gr==null?void 0:gr.size)??null,ge=Di&&typeof Di.size=="number"?Di.size:null,Be=[b?`Current tile: (${B(b.x)}, ${B(b.y)})`:"Current tile: â€”",`Center tile: (${B(v.x)}, ${B(v.y)})`,`Zoom: ${_}`,`Frame rate: ${z}`,`Chunk cache: ${J!==null&&j!==null?`${J}/${j}`:"n/a"}`,`Tile canvases: ${fe!==null&&te!==null?`${fe}/${te}`:"n/a"}${ge!==null?` (pool ${ge})`:""}`];s.debug.overlay.textContent=Be.join(`
`)}He.addEventListener("click",f=>{if(typeof s.onTileClick!="function")return;const g=Hn(f);if(!g)return;const v={x:g.x,y:g.y,col:g.col,row:g.row,terrain:g.type||null,event:f,map:s.map,context:{...s.context}};s.onTileClick(v)}),s.debug.enabled&&(He.addEventListener("pointermove",f=>{const g=Hn(f);s.debug.pointerTile=g?{x:g.x,y:g.y}:null,zn()}),He.addEventListener("pointerleave",()=>{s.debug.pointerTile=null,zn()}));const Vt=document.createElement("div");Vt.className="map-tile-tooltip",Object.assign(Vt.style,{position:"absolute",display:"none",pointerEvents:"none",padding:"6px 10px",borderRadius:"10px",background:"rgba(26, 32, 44, 0.85)",color:"#fff",fontSize:"13px",lineHeight:"1.2",boxShadow:"0 8px 18px rgba(0, 0, 0, 0.35)",transform:"translate(-50%, calc(-100% - 12px))",zIndex:"12",whiteSpace:"pre-line",letterSpacing:"0.02em"}),ie.appendChild(Vt);const ce={visible:!1,tile:null,pointerId:null,pointerType:null,holdTimer:null,holdTarget:null,holdOriginX:0,holdOriginY:0},nr=()=>{ce.visible=!1,ce.tile=null,ce.pointerId=null,ce.pointerType=null,Vt.style.display="none"},it=(f,g,v)=>{if(!ce.visible)return;const b=ie.getBoundingClientRect();let N,B;if(Number.isFinite(f)&&Number.isFinite(g))N=f-b.left,B=g-b.top;else if(v&&s.camera){const j=s.camera.worldToScreenCenter(v.x,v.y,s.tileBaseSize);N=j.x,B=j.y}else N=b.width/2,B=b.height/2;const _=Math.min(b.width-12,Math.max(12,N)),z=Math.min(b.height-12,Math.max(12,B));Vt.style.left=`${_}px`,Vt.style.top=`${z}px`},jt=f=>{var J,te,fe,ge,Be;if(!f)return"Unknown terrain";const g=Number.isFinite(f.index)?Math.trunc(f.index):Ic(s,f.x,f.y),v=((J=s.world)==null?void 0:J.layers)||null;let b=Number.isFinite(f.biomeCode)?f.biomeCode:null;b===null&&g>=0&&(v!=null&&v.biome)&&(b=v.biome[g]??null);const N=b!==null?Cc(b):null,B=[];if(N)B.push(N);else{const we=f.type||"";B.push(t[we]||we||"Unknown terrain")}if(B.push(`(${f.x}, ${f.y})`),g>=0){const we=s.spawnSuggestionRank.get(g);we!==void 0&&B.push(`Spawn suggestion #${we+1}`)}const _=[];v&&g>=0&&(_.push(`Elev ${Or($r(v.elevation,g,0),0)}`),_.push(`Temp ${Or($r(v.temperature,g,0),0)}`),_.push(`Moist ${Or($r(v.moisture,g,0),0)}`),_.push(`Ore ${Or($r(v.ore,g,0),0)}`),_.push(`Stone ${Or($r(v.stone,g,0),0)}`),_.push(`Water ${Or($r(v.water,g,0),0)}`),_.push(`Fertility ${Or($r(v.fertility,g,0),0)}`));let z=((te=f.development)==null?void 0:te.tooltip)||((ge=(fe=f.development)==null?void 0:fe.structures)==null?void 0:ge.join(", "));if(!z){const we=cn(f.x,f.y),be=(we==null?void 0:we.tooltip)||((Be=we==null?void 0:we.structures)!=null&&Be.length?we.structures.join(", "):"");be&&(z=be)}const j=[B.join(" â€¢ ")];return _.length&&j.push(_.join(" Â· ")),z&&j.push(`Development: ${z}`),j.join(`
`)},un=(f,g=null)=>{f&&(Vt.textContent=jt(f),Vt.style.display="block",ce.visible=!0,ce.tile=f,ce.pointerId=(g==null?void 0:g.pointerId)??null,ce.pointerType=(g==null?void 0:g.pointerType)??null,it(g==null?void 0:g.clientX,g==null?void 0:g.clientY,f))},Le=()=>{ce.holdTimer&&(clearTimeout(ce.holdTimer),ce.holdTimer=null),ce.holdTarget=null,ce.pointerId=null,ce.pointerType=null},ze=(f,g)=>{Le(),ce.holdTarget=g,ce.pointerId=f.pointerId,ce.pointerType=f.pointerType,ce.holdOriginX=f.clientX,ce.holdOriginY=f.clientY,ce.holdTimer=setTimeout(()=>{ce.holdTimer=null,un(g,f)},450)},Wt=f=>{const g=Hn(f);g&&f.pointerType==="mouse"&&un(g,f)},We=f=>{const g=Hn(f);if(ce.holdTimer&&ce.pointerId===f.pointerId){const v=f.clientX-ce.holdOriginX,b=f.clientY-ce.holdOriginY;Math.hypot(v,b)>12&&Le()}ce.visible&&ce.pointerId===f.pointerId?it(f.clientX,f.clientY,ce.tile):f.pointerType==="mouse"&&g&&un(g,f)},Ar=f=>{f.pointerType==="mouse"&&nr()},fi=f=>{const g=Hn(f);if(g){if(f.pointerType==="mouse"){nr();return}ze(f,g)}},Oo=f=>{ce.holdTimer&&ce.pointerId===f.pointerId&&Le(),ce.visible&&ce.pointerId===f.pointerId&&f.pointerType!=="mouse"&&nr()},gs=f=>{ce.holdTimer&&ce.pointerId===f.pointerId&&Le(),ce.pointerId===f.pointerId&&nr()};He.addEventListener("pointerover",Wt),He.addEventListener("pointermove",We),He.addEventListener("pointerout",Ar),He.addEventListener("pointerdown",fi),He.addEventListener("pointerup",Oo),He.addEventListener("pointercancel",gs),ie.addEventListener("mouseleave",nr);const ht=document.createElement("div");ht.setAttribute("aria-hidden","true"),ht.style.position="absolute",ht.style.opacity="0",ht.style.pointerEvents="none",ht.style.fontSize="1px",ht.style.lineHeight="1",ht.style.whiteSpace="nowrap",ht.style.height="0",ht.style.overflow="hidden",ht.textContent=Object.values(Us).join(""),ie.appendChild(ht);const xe=document.createElement("div");xe.className=`${o}-layout map-layout`,xe.style.display="flex",xe.style.flexDirection="column",xe.style.alignItems="stretch",xe.style.flexWrap="nowrap",xe.style.gap="16px",xe.style.width="100%",xe.style.maxWidth="100%",xe.style.height="100%",xe.style.minHeight="100%";const ae=document.createElement("div");ae.className=`${o}-map-container map-container`,ae.style.display="flex",ae.style.flexDirection="column",ae.style.alignItems="flex-start",ae.style.gap="12px",ae.style.width="100%",ae.style.maxWidth="100%",ae.style.flex="1 1 auto",ae.style.minHeight="100%";const Q=document.createElement("div");Q.className=`${o}-primary map-primary-stack`,Q.style.display="flex",Q.style.flexDirection="column",Q.style.alignItems="center",Q.style.gap="8px",Q.style.width="100%",Q.style.maxWidth="100%",Q.style.flex="1 1 auto",Q.style.minWidth="0",Q.style.minHeight="100%";const De=document.createElement("div");De.className=`${o}-stage map-stage`,De.style.position="relative",De.style.display="flex",De.style.flexDirection="column",De.style.alignItems="center",De.style.width="100%",De.style.maxWidth="100%",De.style.flex="1 1 auto",De.style.minHeight="100%",De.appendChild(ie),Q.appendChild(De),ae.appendChild(Q);const ue=document.createElement("div");ue.className=`${o}-control-stack map-control-stack`,ue.style.display="flex",ue.style.flexDirection="column",ue.style.alignItems="stretch",ue.style.gap="12px",xe.appendChild(ae),e.appendChild(xe);const he=document.createElement("div");let pt=null,dt=null,$t=null,Ct=null,_o=!1,Fe=null,Xt=null,fn=null;if(n){he.className=`${o}-controls map-controls`,he.style.display="flex",he.style.flexDirection="column",he.style.alignItems="flex-start",he.style.gap="8px",he.style.justifyContent="flex-start",he.style.alignSelf="flex-start",Fe=document.createElement("div"),Fe.style.display="flex",Fe.style.flexDirection="column",Fe.style.alignItems="stretch",Fe.style.gap="10px",he.appendChild(Fe);const f="calc(3 * 48px + 2 * 6px)";pt=document.createElement("div"),pt.className=`${o}-nav map-nav-grid`,pt.style.display="grid",pt.style.gridTemplateColumns="repeat(3, 48px)",pt.style.gridAutoRows="48px",pt.style.gap="6px",pt.style.width=f,Ct=document.createElement("div"),Ct.className=`${o}-nav-panel map-nav-panel`,Ct.setAttribute("role","group"),Ct.setAttribute("aria-label","Map navigation controls"),Ct.hidden=!0,Ct.setAttribute("aria-hidden","true"),Ct.appendChild(pt);const g=`${o}-nav-panel`;Ct.id=g,$t=document.createElement("button"),$t.type="button",$t.className="map-nav-toggle",$t.setAttribute("aria-controls",g),$t.setAttribute("aria-expanded","false"),$t.setAttribute("aria-label","Toggle navigation controls");const v=document.createElement("span");v.className="map-nav-toggle__icon",v.textContent="ðŸ§­",$t.appendChild(v);const b=(B=!1)=>{const _=!!B;_o=_,Ct.hidden=!_,Ct.setAttribute("aria-hidden",_?"false":"true"),$t.setAttribute("aria-expanded",_?"true":"false"),$t.classList.toggle("is-active",_),_?hr(()=>{const z=pt.querySelector("button");z&&z.focus()}):document.activeElement&&Ct.contains(document.activeElement)&&$t.focus()};$t.addEventListener("click",()=>{b(!_o)}),Ct.addEventListener("keydown",B=>{!B||typeof B.key!="string"||B.key==="Escape"&&(B.preventDefault(),b(!1))}),dt=document.createElement("div"),dt.className=`${o}-nav-overlay map-nav-overlay`,dt.style.display="flex",dt.style.flexDirection="column",dt.style.alignItems="stretch",dt.style.gap="10px",dt.style.width=f,dt.style.alignSelf="center",dt.appendChild($t),dt.appendChild(Ct),Fe.appendChild(dt),Xt=document.createElement("div"),Xt.className=`${o}-control-details map-control-details`,Xt.style.display="flex",Xt.style.flexDirection="column",Xt.style.gap="12px",Xt.style.width=f,Xt.style.alignSelf="center",Xt.style.boxSizing="border-box",Fe.appendChild(Xt),fn=Rg({onZoomIn:()=>{$(1)},onZoomOut:()=>{$(-1)},onZoomReset:()=>{Y()},styleButton:(B,_)=>{P(B,_)}}),fn.element.classList.add(`${o}-zoom`),fn.element.style.alignSelf="center",(A&&typeof A.appendChild=="function"?A:Q).appendChild(fn.element),to()}m.build,m.craft,m.gather;const Po=new Map;let $e=null,Ot=null;const Ye=h&&typeof h=="object"?h:{};let se=null,Et=null,qe=null,ut=null,Tt=!1;const kn=new Map;let Nr=null,Fr=null,At=null,ot=null,Ke=null,Ze=null,ve=null,Je=null,rr=null,Ki=null,Zi=!1;const ye={options:[],selectedId:null,laborers:null};function ir(f){if(typeof f!="string")return"";const g=f.trim();return g?g.length>1&&/s$/i.test(g)&&!/ss$/i.test(g)?g.replace(/s$/i,""):g:""}function bs(f={}){const g=typeof f.id=="string"&&f.id.trim()?f.id.trim():null;if(!g)return null;const v=typeof f.label=="string"&&f.label.trim()?f.label.trim():g,b=ir(v),N=Number.isFinite(f.assigned)?Math.max(0,Math.trunc(f.assigned)):0,B=Number.isFinite(f.capacity)?Math.max(0,Math.trunc(f.capacity)):null,_=f.description||"",z=Number.isFinite(f.workdayHours)?Math.max(1,Math.trunc(f.workdayHours)):null;return{id:g,label:v,displayLabel:b,assigned:N,capacity:B,description:_,workdayHours:z}}function or(){return At?At.dataset.hasContent==="true":!1}function Cn(f){Je&&(Zi=!!(f&&or()),Zi?(Je.style.opacity="1",Je.style.visibility="visible",Je.style.transform="translateY(0)",Je.style.pointerEvents="auto",ve&&ve.setAttribute("aria-expanded","true")):(Je.style.opacity="0",Je.style.visibility="hidden",Je.style.transform="translateY(-4px)",Je.style.pointerEvents="none",ve&&ve.setAttribute("aria-expanded","false")))}function ys(f=140){if(clearTimeout(rr),!or()){Cn(!1);return}rr=setTimeout(()=>{Cn(!1)},Math.max(0,f))}function En(){clearTimeout(rr),clearTimeout(Ki),rr=null,Ki=null}function $n(f){return f?typeof f.displayLabel=="string"&&f.displayLabel?f.displayLabel:f.label:""}function Br(){if(!se)return;const f=ye.options.find(g=>g.id===ye.selectedId)||null;if(f)se.textContent=$n(f),se.dataset.placeholder="false";else if(!ye.options.length)se.textContent=Ye.emptyOptionLabel||"No jobs available",se.dataset.placeholder="true";else{const g=ye.options[0];se.textContent=$n(g),se.dataset.placeholder="false"}}function Lr(){const f=ye.selectedId;kn.forEach((g,v)=>{const b=v===f;g.dataset.selected=b?"true":"false",g.setAttribute("aria-selected",b?"true":"false"),g.setAttribute("tabindex",b?"0":"-1"),b?(g.style.background="var(--map-select-selected, linear-gradient(135deg, rgba(40, 72, 140, 0.92), rgba(28, 52, 108, 0.88)))",g.style.boxShadow="inset 0 0 0 1px rgba(150, 182, 246, 0.35)",g.style.opacity="1"):(g.style.background="transparent",g.style.boxShadow="none",g.style.opacity="0.9")})}function ws(){Nr||(Nr=f=>{Tt&&(!qe||!Et||qe.contains(f.target)||Et.contains(f.target)||qt(!1))}),Fr||(Fr=f=>{Tt&&f.key==="Escape"&&(f.preventDefault(),qt(!1,{focusButton:!0}))})}function qt(f,{focusButton:g=!1}={}){if(!se||!qe)return;ye.options.length||(f=!1);const v=!!f;if(Tt===v){!v&&g&&requestAnimationFrame(()=>{se.focus({preventScroll:!0})});return}if(Tt=v,se.setAttribute("aria-expanded",Tt?"true":"false"),qe.setAttribute("aria-hidden",Tt?"false":"true"),Tt){ws(),se.dataset.open="true",se.style.boxShadow="0 0 0 2px rgba(154, 196, 255, 0.55), 0 8px 18px rgba(0, 0, 0, 0.4)",qe.style.display="flex",qe.style.opacity="1",qe.style.pointerEvents="auto",document.addEventListener("pointerdown",Nr,!0),document.addEventListener("keydown",Fr,!0);const N=kn.get(ye.selectedId)||(ut==null?void 0:ut.querySelector("button[data-option-id]"));N&&requestAnimationFrame(()=>{N.focus({preventScroll:!0})})}else se.dataset.open="false",se.style.boxShadow="0 6px 16px rgba(0, 0, 0, 0.35)",qe.style.display="none",qe.style.opacity="0",qe.style.pointerEvents="none",document.removeEventListener("pointerdown",Nr,!0),document.removeEventListener("keydown",Fr,!0),g&&requestAnimationFrame(()=>{se.focus({preventScroll:!0})})}function On(){return ut?Array.from(ut.querySelectorAll("button[data-option-id]")):[]}function ar(f){const g=On();if(!g.length)return;const v=Math.min(Math.max(f,0),g.length-1),b=g[v];b&&b.focus({preventScroll:!0})}function sr(f){const g=On();if(!g.length)return;const v=typeof document<"u"?document.activeElement:null;let b=g.indexOf(v);if(b===-1){const B=kn.get(ye.selectedId);B&&(b=g.indexOf(B))}b===-1&&(b=0);const N=(b+f+g.length)%g.length;ar(N)}function Rr(){if(!At)return;At.dataset.hasContent="false",Cn(!1);const f=ye.options.find(v=>v.id===ye.selectedId);if(!f){ve&&(ve.style.display="none",ve.disabled=!0),ot&&(ot.textContent="",ot.style.display="none"),Ke&&(Ke.textContent="",Ke.style.display="none"),Ze&&(Ze.textContent=Ye.emptyMessage||"No jobs are available right now.",Ze.style.display=ye.options.length?"none":"block");return}if(ve&&(ve.style.display="inline-flex"),Ze&&(Ze.style.display="none"),ot){const v=[];Number.isFinite(f.capacity)?v.push(`Assigned ${f.assigned}/${f.capacity}`):v.push(`Assigned ${f.assigned}`),Number.isFinite(f.workdayHours)&&v.push(`${f.workdayHours}h`),Number.isFinite(ye.laborers)&&v.push(`${ye.laborers} laborers free`),ot.textContent=v.join(" Â· "),ot.style.display=v.length?"block":"none"}Ke&&(f.description?(Ke.textContent=f.description,Ke.style.display="block"):Ye.defaultDescription?(Ke.textContent=Ye.defaultDescription,Ke.style.display="block"):(Ke.textContent="",Ke.style.display="none"));const g=!!(ot!=null&&ot.textContent||Ke!=null&&Ke.textContent);At.dataset.hasContent=g?"true":"false",ve&&(ve.disabled=!g,ve.style.display=g?"inline-flex":"none",g||Cn(!1))}function Ir(f,{fromUser:g=!1}={}){if(!ye.options.length){ye.selectedId=null,Br(),Lr(),Rr();return}const v=ye.options.find(b=>b.id===f)||ye.options[0]||null;if(ye.selectedId=v?v.id:null,Br(),Lr(),g&&qt(!1,{focusButton:!0}),Rr(),g&&typeof Ye.onSelect=="function")try{Ye.onSelect(ye.selectedId,{options:ye.options.slice()})}catch(b){console.warn("Job selector onSelect failed",b)}}function Ji(){var f;if(!(!se||!ut||!qe)){if(qt(!1),kn.clear(),ut.innerHTML="",!ye.options.length){se.disabled=!0,se.textContent=Ye.emptyOptionLabel||"No jobs available",se.dataset.placeholder="true",Ze&&(Ze.textContent=Ye.emptyMessage||"No jobs are available right now.",Ze.style.display="block");return}se.disabled=!1,ye.options.forEach(g=>{const v=document.createElement("li");v.style.listStyle="none",v.style.margin="0",v.style.padding="0";const b=document.createElement("button");b.type="button",b.dataset.optionId=g.id,b.textContent=$n(g),b.setAttribute("role","option"),b.setAttribute("aria-selected","false"),b.style.width="100%",b.style.border="none",b.style.background="transparent",b.style.color="inherit",b.style.padding="10px 16px",b.style.fontWeight="600",b.style.fontSize="15px",b.style.letterSpacing="0.03em",b.style.textTransform="uppercase",b.style.textAlign="left",b.style.cursor="pointer",b.style.transition="background 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease",b.style.opacity="0.9",b.style.borderRadius="0",b.addEventListener("click",()=>{Ir(g.id,{fromUser:!0})}),b.addEventListener("keydown",N=>{if(N.key==="ArrowDown")N.preventDefault(),sr(1);else if(N.key==="ArrowUp")N.preventDefault(),sr(-1);else if(N.key==="Home")N.preventDefault(),ar(0);else if(N.key==="End"){N.preventDefault();const B=On();ar(Math.max(0,B.length-1))}else N.key==="Enter"||N.key===" "?(N.preventDefault(),Ir(g.id,{fromUser:!0})):N.key==="Tab"&&qt(!1)}),b.addEventListener("mouseenter",()=>{b.dataset.selected!=="true"&&(b.style.background="var(--map-select-hover, rgba(42, 70, 128, 0.82))",b.style.boxShadow="inset 0 0 0 1px rgba(146, 176, 238, 0.18)",b.style.opacity="1")}),b.addEventListener("mouseleave",()=>{b.dataset.selected!=="true"&&(b.style.background="transparent",b.style.boxShadow="none",b.style.opacity="0.9")}),b.addEventListener("focus",()=>{b.dataset.selected!=="true"&&(b.style.background="var(--map-select-hover, rgba(42, 70, 128, 0.82))",b.style.boxShadow="inset 0 0 0 1px rgba(146, 176, 238, 0.22)",b.style.opacity="1")}),b.addEventListener("blur",()=>{b.dataset.selected!=="true"&&(b.style.background="transparent",b.style.boxShadow="none",b.style.opacity="0.9")}),v.appendChild(b),ut.appendChild(v),kn.set(g.id,b)}),ye.options.some(g=>g.id===ye.selectedId)||(ye.selectedId=((f=ye.options[0])==null?void 0:f.id)||null),Br(),Lr(),Ze&&(Ze.style.display="none"),Rr()}}function Qi(f=[],{selectedId:g=null,laborers:v=null}={}){var b;ye.options=Array.isArray(f)?f.map(bs).filter(Boolean):[],ye.laborers=Number.isFinite(v)?Math.max(0,Math.trunc(v)):null,g&&ye.options.some(N=>N.id===g)?ye.selectedId=g:ye.options.some(N=>N.id===ye.selectedId)||(ye.selectedId=((b=ye.options[0])==null?void 0:b.id)||null),Ji()}const xs=(f,g)=>{f&&(g?(f.style.background="var(--action-button-bg-active, linear-gradient(135deg, rgba(45, 108, 223, 0.95), rgba(88, 173, 255, 0.95)))",f.style.color="var(--action-button-text-active, #fff)",f.style.boxShadow="var(--action-button-shadow-active, 0 6px 16px rgba(45, 108, 223, 0.35))"):(f.style.background="var(--action-button-bg, linear-gradient(135deg, rgba(255, 255, 255, 0.96), rgba(235, 235, 235, 0.92)))",f.style.color="var(--action-button-text, inherit)",f.style.boxShadow="var(--action-button-shadow, 0 2px 6px rgba(0, 0, 0, 0.08))"))},Do=f=>{Po.forEach((g,v)=>{const b=f===v;g.dataset.active=b?"true":"false",g.setAttribute("aria-pressed",b?"true":"false"),xs(g,b)})},jo=f=>{f.key==="Escape"&&(f.preventDefault(),mi())},mi=()=>{if(!Ot){Do(null);return}Ot.style.display="none",Ot.setAttribute("aria-hidden","true"),document.removeEventListener("keydown",jo),Do(null)};if(r){if($e=document.createElement("div"),$e.className=`${o}-action-panel map-action-panel`,$e.style.display="flex",$e.style.flexDirection="column",$e.style.alignItems="stretch",$e.style.gap="12px",$e.style.padding="12px",$e.style.borderRadius="16px",$e.style.border="1px solid var(--map-border, #ccc)",$e.style.background="var(--action-panel-bg, linear-gradient(135deg, rgba(250, 250, 255, 0.94), rgba(232, 236, 252, 0.9)))",$e.style.boxShadow="0 18px 42px rgba(4, 10, 28, 0.25)",$e.style.alignSelf="flex-start",Ye.title){const z=document.createElement("h4");z.textContent=Ye.title,z.style.margin="0",z.style.fontSize="18px",z.style.letterSpacing="0.04em",$e.appendChild(z)}const f=Xt||$e,g=document.createElement("div");g.className=`${o}-job-selector map-job-selector`,Object.assign(g.style,{display:"flex",flexDirection:"column",gap:"8px",padding:"12px 14px",borderRadius:"14px",border:"1px solid var(--map-border, rgba(104, 132, 194, 0.75))",background:"var(--map-control-surface, linear-gradient(135deg, rgba(16, 28, 62, 0.95), rgba(12, 22, 46, 0.92)))",boxShadow:"0 10px 24px rgba(0, 0, 0, 0.35)",color:"var(--map-control-text, #f4f7ff)",width:"100%",boxSizing:"border-box"}),f.appendChild(g);const v=document.createElement("div");Object.assign(v.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"8px",position:"relative"}),g.appendChild(v);const b=document.createElement("label");b.textContent=Ye.label||"Jobs",b.id=`${o}-job-label`,b.htmlFor=`${o}-job-select`,b.style.fontSize="15px",b.style.fontWeight="600",b.style.letterSpacing="0.04em",b.style.textTransform="uppercase",b.style.color="inherit",v.appendChild(b),ve=document.createElement("button"),ve.type="button",ve.textContent="i",ve.setAttribute("aria-label",`${Ye.label||"Job"} details`),ve.setAttribute("aria-haspopup","true"),ve.setAttribute("aria-expanded","false"),Object.assign(ve.style,{width:"22px",height:"22px",display:"none",alignItems:"center",justifyContent:"center",borderRadius:"50%",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.75))",background:"transparent",color:"inherit",fontWeight:"700",fontSize:"13px",cursor:"pointer",lineHeight:"1",padding:"0"}),v.appendChild(ve),Je=document.createElement("div"),Je.id=`${o}-job-tooltip`,Je.setAttribute("role","tooltip"),Object.assign(Je.style,{position:"absolute",right:"0",top:"calc(100% + 8px)",maxWidth:"260px",minWidth:"220px",padding:"12px 14px",borderRadius:"12px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.85))",background:"var(--map-tooltip-bg, rgba(10, 18, 38, 0.96))",boxShadow:"0 12px 28px rgba(0, 0, 0, 0.45)",color:"inherit",opacity:"0",visibility:"hidden",transform:"translateY(-4px)",transition:"opacity 0.12s ease, transform 0.12s ease",pointerEvents:"none",zIndex:"30"}),v.appendChild(Je),ve.setAttribute("aria-controls",Je.id),Et=document.createElement("div"),Et.style.position="relative",Et.style.display="flex",Et.style.alignItems="center",Et.style.width="100%",g.appendChild(Et),se=document.createElement("button"),se.type="button",se.id=`${o}-job-select`,se.textContent=Ye.placeholderLabel||Ye.label||"Select",se.dataset.placeholder="true",se.dataset.open="false",se.disabled=!0,se.setAttribute("aria-haspopup","listbox"),se.setAttribute("aria-expanded","false"),se.setAttribute("aria-labelledby",`${b.id} ${se.id}`),se.setAttribute("aria-label",Ye.ariaLabel||Ye.label||"Jobs"),Object.assign(se.style,{width:"100%",borderRadius:"12px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.8))",padding:"12px 42px 12px 16px",fontWeight:"600",fontSize:"15px",letterSpacing:"0.03em",textTransform:"uppercase",background:"var(--map-select-bg, linear-gradient(135deg, rgba(20, 38, 78, 0.98), rgba(16, 28, 56, 0.95)))",color:"var(--map-select-text, #f5f8ff)",boxShadow:"0 6px 16px rgba(0, 0, 0, 0.35)",cursor:"pointer",textAlign:"left",lineHeight:"1.2",transition:"box-shadow 0.12s ease, transform 0.12s ease",outline:"none"}),Et.appendChild(se);const N=document.createElement("span");N.textContent="â–¾",N.setAttribute("aria-hidden","true"),Object.assign(N.style,{position:"absolute",right:"16px",top:"50%",transform:"translateY(-50%)",pointerEvents:"none",fontSize:"14px",color:"var(--map-select-caret, #d8e2ff)",opacity:"0.85"}),Et.appendChild(N),qe=document.createElement("div"),qe.setAttribute("aria-hidden","true"),Object.assign(qe.style,{position:"absolute",left:"0",right:"0",top:"calc(100% + 8px)",borderRadius:"14px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.9))",background:"var(--map-select-popup-bg, linear-gradient(135deg, rgba(18, 32, 66, 0.94), rgba(8, 20, 40, 0.9)))",boxShadow:"0 18px 42px rgba(4, 10, 26, 0.55)",padding:"8px 0",display:"none",flexDirection:"column",gap:"0",zIndex:"40",maxHeight:"280px",overflowY:"auto"}),Et.appendChild(qe),ut=document.createElement("ul"),ut.id=`${o}-job-options`,ut.setAttribute("role","listbox"),ut.setAttribute("aria-labelledby",b.id),Object.assign(ut.style,{display:"flex",flexDirection:"column",margin:"0",padding:"0",gap:"0",listStyle:"none"}),qe.appendChild(ut),se.setAttribute("aria-controls",ut.id),se.addEventListener("click",()=>{qt(!Tt)}),se.addEventListener("keydown",z=>{z.key==="ArrowDown"?(z.preventDefault(),Tt?sr(1):qt(!0)):z.key==="ArrowUp"?(z.preventDefault(),Tt?sr(-1):qt(!0)):z.key==="Enter"||z.key===" "?(z.preventDefault(),qt(!Tt)):z.key==="Escape"&&Tt&&(z.preventDefault(),qt(!1,{focusButton:!0}))}),se.addEventListener("focus",()=>{se.style.boxShadow="0 0 0 2px rgba(154, 196, 255, 0.55), 0 6px 16px rgba(0, 0, 0, 0.35)"}),se.addEventListener("blur",()=>{Tt||(se.style.boxShadow="0 6px 16px rgba(0, 0, 0, 0.35)")}),At=document.createElement("div"),At.dataset.hasContent="false",Object.assign(At.style,{display:"flex",flexDirection:"column",gap:"6px",fontSize:"13px",opacity:"0.92"}),Je.appendChild(At),ot=document.createElement("span"),ot.style.color="inherit",ot.style.display="none",At.appendChild(ot),Ke=document.createElement("span"),Ke.style.opacity="0.78",Ke.style.lineHeight="1.35",Ke.style.display="none",At.appendChild(Ke),Ze=document.createElement("span"),Ze.style.fontSize="13px",Ze.style.opacity="0.8",Ze.style.display="none",g.appendChild(Ze);const B=()=>{En(),Cn(!0)},_=z=>{ys(typeof z=="number"?z:void 0)};ve.addEventListener("mouseenter",()=>{or()&&B()}),ve.addEventListener("mouseleave",()=>{_(120)}),ve.addEventListener("focus",()=>{or()&&B()}),ve.addEventListener("blur",()=>{_(100)}),ve.addEventListener("keydown",z=>{if(z.key==="Enter"||z.key===" "){if(z.preventDefault(),!or())return;Cn(!Zi)}}),ve.addEventListener("pointerdown",z=>{(z.pointerType==="touch"||z.pointerType==="pen")&&(En(),Ki=setTimeout(()=>{or()&&Cn(!0)},420))}),ve.addEventListener("pointerup",z=>{(z.pointerType==="touch"||z.pointerType==="pen")&&(En(),_(200))}),ve.addEventListener("pointerleave",z=>{(z.pointerType==="touch"||z.pointerType==="pen")&&(En(),_(200))}),ye.options.length?Ji():Qi(Array.isArray(Ye.options)?Ye.options:[],{selectedId:Ye.initialId||null,laborers:Ye.laborers})}function vs(){if(typeof window>"u")return!0;if(typeof window.matchMedia=="function"){const f=window.matchMedia("(orientation: portrait)");if(f&&typeof f.matches=="boolean")return!f.matches}return window.innerWidth>=window.innerHeight}function hi(){const f=vs(),g=n&&he,v=!!$e;xe.style.flexDirection="column",xe.style.alignItems="stretch",xe.style.flexWrap="nowrap",Q.parentElement!==ae&&ae.insertBefore(Q,ae.firstChild),Q.style.alignSelf=f&&g?"flex-start":"stretch",Q.style.width="100%",Q.style.maxWidth="100%",f&&g?(ae.style.flexDirection="row",ae.style.flexWrap="nowrap",ae.style.gap="16px",ae.style.justifyContent="flex-start",ae.style.alignItems="flex-start",ue.parentElement||ae.appendChild(ue),ue.style.alignItems="flex-start",ue.style.justifyContent="flex-start",he.parentElement!==ue&&(he.parentElement&&he.parentElement.removeChild(he),ue.appendChild(he)),he.style.margin="0",he.style.alignItems="flex-start",he.style.alignSelf="flex-start",he.style.justifyContent="flex-start"):(ae.style.flexDirection="column",ae.style.flexWrap="nowrap",ae.style.gap="12px",ae.style.justifyContent="flex-start",ae.style.alignItems="flex-start",ue.parentElement&&ue.parentElement.removeChild(ue),g?(he.parentElement&&he.parentElement!==ae&&he.parentElement.removeChild(he),he.parentElement!==ae&&ae.appendChild(he),he.style.margin="16px 0 0",he.style.alignItems="flex-start",he.style.alignSelf="flex-start",he.style.justifyContent="flex-start"):he!=null&&he.parentElement&&he.parentElement.removeChild(he)),!g&&ue.parentElement&&ue.parentElement.removeChild(ue),v&&$e&&($e.parentElement&&$e.parentElement!==xe&&$e.parentElement.removeChild($e),xe.appendChild($e),$e.style.alignSelf="stretch"),hr(I),hr(eo)}function eo(){if(typeof document>"u"||!(xe!=null&&xe.isConnected))return;const f=typeof xe.getBoundingClientRect=="function"?xe.getBoundingClientRect():null,g=f!=null&&f.width?Math.round(f.width):0;g&&document.documentElement.style.setProperty("--map-layout-width",`${g}px`)}function pi(f={}){const g=Number.isFinite(f.x)?f.x:0,v=Number.isFinite(f.y)?f.y:0;return{x:g,y:v}}function gi(f={}){const g=q(),v=s.viewport.width||g.cols||at,b=s.viewport.height||g.rows||at,N=pi(f),B=Math.floor(v/2),_=Math.floor(b/2);return{xStart:Math.round(N.x)-B,yStart:Math.round(N.y)-_}}function lr(f={},g=0){const v=Number.isFinite(f.x)?Math.trunc(f.x):null,b=Number.isFinite(f.y)?Math.trunc(f.y):null;if(v===null||b===null)return null;const N=f.id||`marker-${g}`,B=f.icon===void 0||f.icon===null?"":String(f.icon),_=f.className||"",z=!!f.emphasis,j=f.label||"",J=f.color||"",te=Number.isFinite(f.index)?Math.trunc(f.index):null;return{id:N,x:v,y:b,icon:B,className:_,emphasis:z,label:j,color:J,index:te}}function mn(){var N;if(!s.markerLayer)return;if(!((N=s.map)!=null&&N.tiles)||!s.map.tiles.size){s.markerElements.forEach(B=>{B&&(B.style.display="none")});return}const f=Number.isFinite(s.map.width)&&s.map.width>0?Math.trunc(s.map.width):tn(s.map.tiles,0),g=Number.isFinite(s.map.height)&&s.map.height>0?Math.trunc(s.map.height):nn(s.map.tiles,0);if(!f||!g||!s.camera){s.markerElements.forEach(B=>{B&&(B.style.display="none")});return}const v=new Set;s.markerDefs.concat(s.spawnSuggestionMarkers||[]).forEach(B=>{const _=B.x-s.map.xStart,z=B.y-s.map.yStart;if(!Number.isFinite(_)||!Number.isFinite(z))return;if(_<0||z<0||_>=f||z>=g){const ge=s.markerElements.get(B.id);ge&&(ge.style.display="none");return}let j=s.markerElements.get(B.id);j||(j=document.createElement("span"),j.className="map-marker",j.style.position="absolute",j.style.transform="translate(-50%, -50%)",j.style.pointerEvents="none",j.style.lineHeight="1",j.style.textShadow="0 0 4px rgba(0, 0, 0, 0.35)",s.markerLayer.appendChild(j),s.markerElements.set(B.id,j)),j.textContent=B.icon,j.style.fontSize=B.emphasis?"1.6em":"1.4em",B.color?j.style.color=B.color:j.style.color="",B.label?(j.title=B.label,j.setAttribute("aria-label",B.label)):(j.removeAttribute("title"),j.removeAttribute("aria-label"));const J=["map-marker"];B.className&&J.push(B.className),B.emphasis&&J.push("map-marker--emphasis"),j.className=J.join(" ");const te=s.camera.worldToScreenCenter(B.x,B.y,s.tileBaseSize);if(!(Number.isFinite(te.x)&&Number.isFinite(te.y)&&te.x>=0&&te.y>=0&&te.x<=s.camera.viewportWidth&&te.y<=s.camera.viewportHeight)){j.style.display="none";return}j.style.left=`${te.x}px`,j.style.top=`${te.y}px`,j.style.display="block",v.add(B.id)}),s.markerElements.forEach((B,_)=>{!v.has(_)&&B&&(B.style.display="none")})}function Wo(f=[]){const g=Array.isArray(f)?f.map((v,b)=>lr(v,b)).filter(Boolean):[];s.markerDefs=g,mn()}function to(){if(!fn)return;const f=Number.isFinite(s.initialZoom)?s.initialZoom:1,g=G();fn.update({zoom:g,minZoom:s.minZoom,maxZoom:s.maxZoom,baselineZoom:f,camera:s.camera})}function y(){const f=Number.isFinite(s.zoomDisplayFactor)?s.zoomDisplayFactor:1,g=G();if(s.renderer){const v=s.camera?g:f||1;s.renderer.setScale(v)}Ft(),to()}function k(f,g={}){let v=f;if(s.camera){const b=s.camera.zoom;if(v=s.camera.setZoom(f,g.pivot==="viewport"?"viewport":"centerTile"),!g.force&&Math.abs(v-b)<.001){s.zoom=v,lt(),y();return}s.zoom=v}else{if(v=Math.min(s.maxZoom,Math.max(s.minZoom,f)),!g.force&&Math.abs(v-s.zoom)<.001){lt(),y();return}s.zoom=v}Ht({forceFetch:!!g.force}),lt(),y()}const F=1.25,H=.8;function $(f){if(!Number.isFinite(f)||f===0)return;const g=G(),v=f>0?F:H,b=zr(g*v,s.minZoom,s.maxZoom);k(b)}function Y(){k(s.initialZoom||1)}function I(){var J,te,fe,ge,Be,we,be,Ae;if(!s.renderer)return;const f=Number.isFinite((J=s.camera)==null?void 0:J.viewportWidth)?s.camera.viewportWidth:(ie==null?void 0:ie.clientWidth)||((te=s.renderer.canvas)==null?void 0:te.clientWidth)||0,g=Number.isFinite((fe=s.camera)==null?void 0:fe.viewportHeight)?s.camera.viewportHeight:(ie==null?void 0:ie.clientHeight)||((ge=s.renderer.canvas)==null?void 0:ge.clientHeight)||0,v=Number.isFinite(s.viewport.width)&&s.viewport.width>0?s.viewport.width:Number.isFinite((Be=s.map)==null?void 0:Be.width)&&s.map.width>0?s.map.width:tn((we=s.map)==null?void 0:we.tiles,0),b=Number.isFinite(s.viewport.height)&&s.viewport.height>0?s.viewport.height:Number.isFinite((be=s.map)==null?void 0:be.height)&&s.map.height>0?s.map.height:nn((Ae=s.map)==null?void 0:Ae.tiles,0),N=Math.max(1,Math.trunc(Number.isFinite(s.zoomBase.width)&&s.zoomBase.width>0?s.zoomBase.width:Number.isFinite(v)&&v>0?v:0)),B=Math.max(1,Math.trunc(Number.isFinite(s.zoomBase.height)&&s.zoomBase.height>0?s.zoomBase.height:Number.isFinite(b)&&b>0?b:0));let _=Number.isFinite(s.tileBaseSize)&&s.tileBaseSize>0?s.tileBaseSize:Rc;if(f>0&&g>0&&N>0&&B>0){const vt=f/N,Ne=g/B,Ve=Math.max(2,Math.min(vt,Ne));Number.isFinite(Ve)&&Ve>0&&(_=Ve)}s.tileBaseSize=_,s.renderer.setTileBaseSize(_),s.renderer.setUseTerrainColors(s.useTerrainColors);const z=G(),j=s.camera?z:s.zoomDisplayFactor||1;s.renderer.setScale(j),Ft()}function U(f,g){if(!f||typeof window>"u"||!window.getComputedStyle)return 0;try{const v=window.getComputedStyle(f).getPropertyValue(g);if(!v)return 0;const b=parseFloat(v);return Number.isFinite(b)?b:0}catch{return 0}}function ne(){if(!ie)return;ie.style.width="100%",ie.style.height="100%",ie.style.minWidth="100%",ie.style.minHeight="100%";const f=typeof ie.getBoundingClientRect=="function"?ie.getBoundingClientRect():null,g=typeof(e==null?void 0:e.getBoundingClientRect)=="function"?e.getBoundingClientRect():null;let v=Number.isFinite(f==null?void 0:f.width)&&f.width>0?f.width:ie.clientWidth||0;v>0||(v=Number.isFinite(g==null?void 0:g.width)&&g.width>0?g.width:(e==null?void 0:e.clientWidth)||0);let b=Number.isFinite(f==null?void 0:f.height)&&f.height>0?f.height:ie.clientHeight||0;if(b>0||(b=Number.isFinite(g==null?void 0:g.height)&&g.height>0?g.height:(e==null?void 0:e.clientHeight)||0),!(b>0)){const _=Number.isFinite(v)&&v>0?v:0;_>0&&(b=_)}b>0||(b=U(e,"min-height")||U(ie,"min-height")),b>0||(b=at);const N=Math.max(0,Math.round(v)),B=Math.max(0,Math.round(b));s.renderer&&s.renderer.resize(N,B),s.camera&&(s.camera.setViewportSize(N,B),ke()),I(),hr(()=>{eo(),mn()})}function Z(f={}){s.home=gi(s.focus),nt(s.home.xStart,s.home.yStart,f)}function pe(f={},g={}){s.focus=pi(f),s.context={...s.context,focus:{...s.focus}},s.home=gi(s.focus),g.recenter!==!1&&Z(g)}function ke({snap:f=!1}={}){var B,_,z,j;if(!s.camera)return;const g=Number.isFinite(s.viewport.width)?s.viewport.width:Number.isFinite((B=s.map)==null?void 0:B.width)&&s.map.width>0?s.map.width:tn((_=s.map)==null?void 0:_.tiles,0),v=Number.isFinite(s.viewport.height)?s.viewport.height:Number.isFinite((z=s.map)==null?void 0:z.height)&&s.map.height>0?s.map.height:nn((j=s.map)==null?void 0:j.tiles,0);if(!g||!v)return;const b=s.viewport.xStart+g/2,N=s.viewport.yStart+v/2;s.camera.setCenterTile({x:b,y:N},{snap:f})}function rt(f={}){var te,fe,ge,Be,we,be;if(!s.camera)return;const g=f.center||null,v=f.forceFetch===!0,b=Number.isFinite(s.viewport.width)?s.viewport.width:Number.isFinite((te=s.map)==null?void 0:te.width)&&s.map.width>0?s.map.width:tn((fe=s.map)==null?void 0:fe.tiles,0),N=Number.isFinite(s.viewport.height)?s.viewport.height:Number.isFinite((ge=s.map)==null?void 0:ge.height)&&s.map.height>0?s.map.height:nn((Be=s.map)==null?void 0:Be.tiles,0);if(!b||!N)return;const B=g||s.camera.centerTile,_=Math.round(B.x-b/2),z=Math.round(B.y-N/2),j=Number.isFinite(s.viewport.xStart)?s.viewport.xStart:((we=s.map)==null?void 0:we.xStart)||0,J=Number.isFinite(s.viewport.yStart)?s.viewport.yStart:((be=s.map)==null?void 0:be.yStart)||0;_===j&&z===J||nt(_,z,{forceFetch:v})}function Ge(){var f;(f=s.keyboardPan)!=null&&f.timer&&(clearTimeout(s.keyboardPan.timer),s.keyboardPan.timer=null)}function Ce(){Ge(),s.keyboardPan.timer=setTimeout(()=>{s.keyboardPan.timer=null,Qe()},zg)}function Qe(f={}){if(!s.camera)return null;Ge();let g=!1;const v=s.camera.commitSnap({animate:f.animate!==!1,duration:f.duration,onUpdate:()=>{Ft()},onComplete:b=>{g=!0,Ft(),rt({center:b,forceFetch:!!f.forceFetch})}});return!g&&!(v!=null&&v.changed)&&rt({forceFetch:!!f.forceFetch}),v}function Kt(f,g,v){var B;if(!f)return;Pe.forEach(_=>f.classList.remove(_)),delete f.dataset.development,delete f.dataset.developmentLabel,delete f.dataset.developmentStatus,delete f.dataset.developmentDetails,delete f.dataset.developmentCount;const b=cn(g,v);if(!b)return;f.classList.add("map-tile--developed"),b.status==="under-construction"?f.classList.add("map-tile--developed-pending"):b.status==="completed"?f.classList.add("map-tile--developed-complete"):b.status==="planned"?f.classList.add("map-tile--developed-planned"):f.classList.add("map-tile--developed-mixed"),(b.emphasis||b.highlight)&&f.classList.add("map-tile--developed-emphasis"),f.dataset.development="true",b.label&&(f.dataset.developmentLabel=b.label),b.status&&(f.dataset.developmentStatus=b.status);const N=b.tooltip||((B=b.structures)!=null&&B.length?b.structures.join(", "):"");N&&(f.dataset.developmentDetails=N),Number.isFinite(b.count)&&b.count>0&&(f.dataset.developmentCount=`${b.count}`)}function Nt(){var z,j,J,te,fe,ge,Be,we;const f=s.dataLayer;if(!f)return;const g=(z=s.map)==null?void 0:z.tiles;if(!g||!g.size){f.replaceChildren();return}const v=Number.isFinite((j=s.map)==null?void 0:j.width)&&s.map.width>0?Math.trunc(s.map.width):tn(g,0),b=Number.isFinite((J=s.map)==null?void 0:J.height)&&s.map.height>0?Math.trunc(s.map.height):nn(g,0);if(!b||!v){f.replaceChildren();return}const N=b*v;if(f.children.length!==N){const be=document.createDocumentFragment();for(let Ae=0;Ae<N;Ae++){const vt=document.createElement("span");vt.className="map-tile";const Ne=document.createElement("span");Ne.className="map-tile-symbol",vt.appendChild(Ne),be.appendChild(vt)}f.replaceChildren(be)}const B=f.children;let _=0;for(let be=0;be<b;be++)for(let Ae=0;Ae<v;Ae++){const vt=B[_++];if(!(vt instanceof HTMLElement))continue;const Ne=vt;let Ve=Ne.firstElementChild;Ve instanceof HTMLElement||(Ve=document.createElement("span"),Ve.className="map-tile-symbol",Ne.appendChild(Ve));const Tn=s.map.xStart+Ae,_n=s.map.yStart+be;Ne.dataset.col=`${Ae}`,Ne.dataset.row=`${be}`,Ne.dataset.worldX=`${Tn}`,Ne.dataset.worldY=`${_n}`;const pn=(te=s.map.types)!=null&&te.get?s.map.types.get(Ae,be):((ge=(fe=s.map.types)==null?void 0:fe[be])==null?void 0:ge[Ae])??null,cr=Ic(s,Tn,_n),dr=((we=(Be=s.world)==null?void 0:Be.layers)==null?void 0:we.biome)||null,gn=dr&&cr>=0?dr[cr]??null:null,qo=gn!==null?Cc(gn):null,yi=gn!==null?Cg(gn):null;yi?(Ne.dataset.terrain=yi,Ne.dataset.biome=yi):pn?(Ne.dataset.terrain=pn,delete Ne.dataset.biome):(delete Ne.dataset.terrain,delete Ne.dataset.biome);const Uo=g.get(Ae,be)??"",ur=gn!==null?kg(gn):zt(pn),ro=qo||t[pn]||Uo||pn||"";Ve&&(Ve.textContent=ro,Ve.style.backgroundColor=ur||"transparent",Ve.style.borderRadius=ur?"6px":"",Ve.style.boxShadow=ur?"inset 0 0 0 1px rgba(0, 0, 0, 0.18)":""),ur?Ne.classList.add("map-tile--fill"):Ne.classList.remove("map-tile--fill"),Kt(Ne,Tn,_n)}}function Ft(){!s.renderer||s.renderScheduled||(s.renderScheduled=!0,hr(()=>{s.renderScheduled=!1,Hr()}))}function Hr(){var f;if(s.renderer){if(!((f=s.map)!=null&&f.tiles)||!s.map.tiles.size){s.renderer.setWorld(s.world),s.renderer.setMap(null),s.renderer.render(),mn(),Nt(),zn({fromRender:!0});return}s.renderer.setWorld(s.world),s.renderer.setMap({...s.map}),s.renderer.render(),Nt(),mn(),zn({fromRender:!0})}}function de(){var v,b;const f=Number.isFinite(s.viewport.width)?s.viewport.width:tn((v=s.map)==null?void 0:v.tiles,0),g=Number.isFinite(s.viewport.height)?s.viewport.height:nn((b=s.map)==null?void 0:b.tiles,0);return{maxX:Math.max(0,Math.trunc(f)-1),maxY:Math.max(0,Math.trunc(g)-1)}}function ft(){var v,b;const f=s.viewport.width||tn((v=s.map)==null?void 0:v.tiles,0),g=s.viewport.height||nn((b=s.map)==null?void 0:b.tiles,0);return!f||!g?null:{stepX:Math.max(1,Math.floor(f*.5)),stepY:Math.max(1,Math.floor(g*.5))}}function Bt(f,g,v={}){if(!f&&!g)return;const b=ft();if(!b)return;const N=b.stepX*f,B=b.stepY*g;if(!(!N&&!B)){if(s.camera){hn(N,B,v);return}hn(N,B,v)}}function hn(f,g,v={}){var fe,ge;if(!f&&!g)return;const{maxX:b,maxY:N}=de(),B=zr(f,-b,b),_=zr(g,-N,N);if(!B&&!_)return;if(s.camera){s.camera.panBy(B,_);const Be=s.camera.centerTile;rt({center:Be,forceFetch:v.forceFetch});const we=s.camera.centerTile,be=Be.x-we.x,Ae=Be.y-we.y;(Math.abs(be)>1e-6||Math.abs(Ae)>1e-6)&&s.camera&&s.camera.panBy(be,Ae),Ft(),v.deferCommit?Ce():v.commit!==!1&&Qe({animate:v.animate!==!1,forceFetch:v.forceFetch});return}const z=Number.isFinite(s.viewport.xStart)?s.viewport.xStart:((fe=s.map)==null?void 0:fe.xStart)||0,j=Number.isFinite(s.viewport.yStart)?s.viewport.yStart:((ge=s.map)==null?void 0:ge.yStart)||0,J=z+B,te=j+_;nt(J,te,v)}function no(f,g){Bt(f,g)}function hf(){if(!n||!pt)return;const f=s.navMode==="player"?"Travel":"Pan",g=s.navMode==="player"?"Center on explorer":"Recenter map";[{label:"â†–",dx:-1,dy:-1,aria:`${f} northwest`},{label:"â†‘",dx:0,dy:-1,aria:`${f} north`},{label:"â†—",dx:1,dy:-1,aria:`${f} northeast`},{label:"â†",dx:-1,dy:0,aria:`${f} west`},{label:"âŒ‚",recenter:!0,aria:g},{label:"â†’",dx:1,dy:0,aria:`${f} east`},{label:"â†™",dx:-1,dy:1,aria:`${f} southwest`},{label:"â†“",dx:0,dy:1,aria:`${f} south`},{label:"â†˜",dx:1,dy:1,aria:`${f} southeast`}].forEach(b=>{const N=document.createElement("button");N.type="button",N.textContent=b.label,N.setAttribute("aria-label",b.aria),P(N,{variant:"chip",fontSize:"22px"}),N.addEventListener("click",()=>{b.recenter?s.navMode==="player"&&typeof s.onNavigate=="function"?s.onNavigate({dx:0,dy:0,recenter:!0}):Z():s.navMode==="player"&&typeof s.onNavigate=="function"?s.onNavigate({dx:b.dx??0,dy:b.dy??0,recenter:!1}):no(b.dx,b.dy)}),pt.appendChild(N)})}function Ul(f){if(!f||typeof f.key!="string")return;const g=Hg[f.key];if(g){if(s.navMode==="player"&&typeof s.onNavigate=="function"){f.preventDefault(),s.onNavigate({dx:g.dx,dy:g.dy,recenter:!1});return}f.preventDefault(),Bt(g.dx,g.dy,{deferCommit:!0})}}function Yl(f,g){i&&(Le(),nr(),s.drag.active=!0,s.drag.lastX=f,s.drag.lastY=g,s.drag.pendingX=0,s.drag.pendingY=0,s.drag.fractionalX=0,s.drag.fractionalY=0,Ge(),ie.style.cursor="grabbing")}function Gl(f,g){var Ae,vt,Ne,Ve;if(!s.drag.active)return;const v=f-s.drag.lastX,b=g-s.drag.lastY;s.drag.lastX=f,s.drag.lastY=g,s.drag.pendingX-=v,s.drag.pendingY-=b;const N=Number.isFinite((Ae=s.map)==null?void 0:Ae.width)&&s.map.width>0?Math.trunc(s.map.width):s.viewport.width||tn((vt=s.map)==null?void 0:vt.tiles,0),B=Number.isFinite((Ne=s.map)==null?void 0:Ne.height)&&s.map.height>0?Math.trunc(s.map.height):s.viewport.height||nn((Ve=s.map)==null?void 0:Ve.tiles,0);if(!N||!B)return;const z=(s.dataLayer||xt).getBoundingClientRect(),j=z.width/N,J=z.height/B;if(!j||!J)return;if(s.camera){let Tn=!1;const _n=Math.trunc(s.drag.pendingX/j),pn=Math.trunc(s.drag.pendingY/J);if(_n||pn){const{maxX:yi,maxY:Uo}=de(),ur=zr(_n,-yi,yi),ro=zr(pn,-Uo,Uo);ur||ro?(s.drag.pendingX-=ur*j,s.drag.pendingY-=ro*J,hn(ur,ro,{commit:!1}),Tn=!0):(s.drag.pendingX=Math.sign(s.drag.pendingX)*Math.min(Math.abs(s.drag.pendingX),j),s.drag.pendingY=Math.sign(s.drag.pendingY)*Math.min(Math.abs(s.drag.pendingY),J))}const cr=j?s.drag.pendingX/j:0,dr=J?s.drag.pendingY/J:0,gn=cr-s.drag.fractionalX,qo=dr-s.drag.fractionalY;(gn||qo)&&(s.camera.panBy(gn,qo),Tn=!0),Tn&&Ft(),s.drag.fractionalX=cr,s.drag.fractionalY=dr;return}const te=Math.trunc(s.drag.pendingX/j),fe=Math.trunc(s.drag.pendingY/J);if(!te&&!fe)return;const{maxX:ge,maxY:Be}=de(),we=zr(te,-ge,ge),be=zr(fe,-Be,Be);!we&&!be||(s.drag.pendingX-=we*j,s.drag.pendingY-=be*J,hn(we,be))}function bi(){s.drag.active&&(s.drag.active=!1,ie.style.cursor=i?"grab":"default",s.drag.pendingX=0,s.drag.pendingY=0,s.drag.fractionalX=0,s.drag.fractionalY=0,s.camera&&Qe())}function pf(){if(!i)return null;const f=v=>{s.drag.active&&(v.preventDefault(),Gl(v.clientX,v.clientY))},g=v=>{var N;if(!s.drag.active||!((N=v.touches)!=null&&N.length))return;const b=v.touches[0];Gl(b.clientX,b.clientY),v.preventDefault()};return ie.addEventListener("mousedown",v=>{v.preventDefault(),Yl(v.clientX,v.clientY)}),ie.addEventListener("touchstart",v=>{var N;if(!((N=v.touches)!=null&&N.length))return;const b=v.touches[0];Yl(b.clientX,b.clientY),v.preventDefault()},{passive:!1}),window.addEventListener("mousemove",f),window.addEventListener("mouseup",bi),window.addEventListener("touchmove",g,{passive:!1}),window.addEventListener("touchend",bi),window.addEventListener("touchcancel",bi),()=>{window.removeEventListener("mousemove",f),window.removeEventListener("mouseup",bi),window.removeEventListener("touchmove",g),window.removeEventListener("touchend",bi),window.removeEventListener("touchcancel",bi)}}ie.addEventListener("keydown",Ul);const Vl=pf();return y(),hf(),hi(),typeof window<"u"&&(s.resizeHandler=()=>{ne(),hi()},window.addEventListener("resize",s.resizeHandler)),{setMap(f,g={}){var _,z,j,J,te,fe;s.hasInitializedBaseChunk=!1,s.context={...s.context,...g};const v=(g==null?void 0:g.focus)??(g==null?void 0:g.center)??(g==null?void 0:g.current)??(g==null?void 0:g.currentCoords)??(g==null?void 0:g.homeCoords)??s.focus;if(s.focus=pi(v),!f){s.map=null,s.buffer=null,re(null),s.context={...s.context,focus:{...s.focus}},s.zoomBase={width:0,height:0},s.zoomDisplayFactor=1,s.zoom=1,s.pendingZoomSync=!1,Sn([]),s.camera&&s.camera.setCenterTile({x:s.focus.x,y:s.focus.y},{snap:!0}),k(1,{force:!0}),s.renderer&&(s.renderer.setMap(null),s.renderer.setScale(1)),Ft(),y(),Nt();return}const b=Hc(f);(_=b==null?void 0:b.tiles)!=null&&_.size&&(s.hasInitializedBaseChunk=!0),s.buffer=b,b!=null&&b.world?re(b.world):f.world&&re(f.world),ee(b);const N=f.viewport??(b==null?void 0:b.viewport)??null;N?(s.viewport.width=Math.max(1,Ie(N.width,s.viewport.width)),s.viewport.height=Math.max(1,Ie(N.height,s.viewport.height)),s.viewport.xStart=Ie(N.xStart,(b==null?void 0:b.xStart)??s.viewport.xStart??0),s.viewport.yStart=Ie(N.yStart,(b==null?void 0:b.yStart)??s.viewport.yStart??0)):b?(s.viewport.xStart=Ie(f.xStart??b.xStart,b.xStart),s.viewport.yStart=Ie(f.yStart??b.yStart,b.yStart)):(s.viewport.xStart=Ie(f.xStart,s.viewport.xStart??0),s.viewport.yStart=Ie(f.yStart,s.viewport.yStart??0)),ee(b),s.map={seed:f.seed??(b==null?void 0:b.seed)??((z=s.map)==null?void 0:z.seed),season:f.season??(b==null?void 0:b.season)??((j=s.map)==null?void 0:j.season),waterLevel:f.waterLevel??(b==null?void 0:b.waterLevel)??((J=s.map)==null?void 0:J.waterLevel),tiles:[],types:null,elevations:null,xStart:s.viewport.xStart,yStart:s.viewport.yStart,width:s.viewport.width,height:s.viewport.height},(!s.zoomBase.width||!s.zoomBase.height)&&(s.zoomBase.width=Math.max(1,s.viewport.width||((te=s.map)==null?void 0:te.width)||at),s.zoomBase.height=Math.max(1,s.viewport.height||((fe=s.map)==null?void 0:fe.height)||at)),s.pendingZoomSync=Math.abs(s.zoom-1)>.001,s.context={...s.context,focus:{...s.focus},seed:s.map.seed,season:s.map.season},s.home=gi(s.focus);const B=Pg(f);if(Sn(B),(!Number.isFinite(s.viewport.xStart)||!Number.isFinite(s.viewport.yStart))&&(s.viewport.xStart=s.home.xStart,s.viewport.yStart=s.home.yStart),ke({snap:!0}),b){if(!me()){nt(s.viewport.xStart,s.viewport.yStart,{forceFetch:!0});return}s.viewport.xStart!==s.home.xStart||s.viewport.yStart!==s.home.yStart?nt(s.home.xStart,s.home.yStart):Mn();return}Ft(),nt(s.viewport.xStart,s.viewport.yStart,{forceFetch:!0})},refresh(){ne(),I(),hi()},setTerrainColors(f=null,g={}){var N;const{forceRefresh:v=!1}=g||{};f===!1?s.terrainColorOverrides=null:f&&typeof f=="object"&&(s.terrainColorOverrides=Bc(f));const b=Array.isArray((N=s.map)==null?void 0:N.tiles)&&s.map.tiles.length>0;v&&(Ho({forceRefresh:!0}),Nc()&&console.assert(b,"setTerrainColors: forceRefresh requested without available tile data")),s.useTerrainColors&&(b||v)&&(Nt(),Ft())},setJobOptions(f=[],g={}){Qi(f,g)},getSelectedJob(){return ye.selectedId},center:Z,setFocus:pe,setMarkers:Wo,setDevelopments:Sn,destroy(){Ge(),typeof window<"u"&&(s.resizeHandler&&window.removeEventListener("resize",s.resizeHandler),Vl&&Vl()),s.markerElements.forEach(f=>{f!=null&&f.parentElement&&f.parentElement.removeChild(f)}),s.markerElements.clear(),s.markerDefs=[],s.markerLayer=null,s.spawnSuggestionMarkers=[],s.spawnSuggestionRank.clear(),s.world=null,xe.parentElement&&xe.parentElement.removeChild(xe),qt(!1),s.developmentTiles=new Map,kn.clear(),mi(),Ot!=null&&Ot.parentElement&&Ot.parentElement.removeChild(Ot),Ot=null,se=null,qe=null,ut=null,Et=null,typeof document<"u"&&document.documentElement.style.removeProperty("--map-layout-width"),ie.removeEventListener("keydown",Ul)},elements:{layout:xe,mapContainer:ae,wrapper:ie,stage:De,display:Te,canvas:He,markers:ct,controls:he,nav:pt,controlDetails:Xt,actionPanel:$e,actionButtons:Po,jobSelect:se,zoom:fn?fn.element:null,navOverlay:dt}}}const zc="sanity-check-notification";let na=null;const Ug=5e3;let $c=null;function Yg(){if(na||typeof document>"u")return na;const e=document.createElement("div");return e.className="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","false"),document.body.appendChild(e),na=e,na}function Gg(e,t={}){if(typeof document>"u")return;const n=Yg();if(!n)return;const r=document.createElement("div");r.className="toast",t!=null&&t.type&&r.classList.add(`toast--${t.type}`),r.textContent=typeof e=="string"?e:"",n.appendChild(r),requestAnimationFrame(()=>{r.classList.add("is-visible")});const i=Number.isFinite(t==null?void 0:t.duration)?Math.max(0,t.duration):Ug;window.setTimeout(()=>{r.classList.remove("is-visible"),window.setTimeout(()=>{r.parentElement===n&&n.removeChild(r)},300)},i)}function Vg(e){if(typeof e!="function")return()=>{};if(typeof document>"u"||typeof document.addEventListener!="function")return()=>{};const t=n=>{try{e(n.detail||{})}catch(r){console.error("Error in sanity check listener",r)}};return document.addEventListener(zc,t),()=>document.removeEventListener(zc,t)}function bu(){$c||typeof document>"u"||($c=Vg(e=>{!e||typeof e.message!="string"||Gg(e.message,{type:e.type??"info"})}))}const yu="theme:selected",wu="theme:appearance",El=["theme"],Xg=new Map([["lunar-surface-dawn","lunar-surface"]]),xu=new Set(["light","dark"]),Kg=["red","orange","yellow","green","blue","pink","purple","brown"];function ii(e,t=0,n=1){return typeof e!="number"||Number.isNaN(e)?t:Math.min(Math.max(e,t),n)}function st(e){if(!e)return null;const t=String(e).trim();if(!t)return null;const n=t.startsWith("#")?t.slice(1):t;if(/^([0-9a-f]{6})$/i.test(n))return`#${n.toLowerCase()}`;if(/^([0-9a-f]{3})$/i.test(n)){const[r,i,o]=n.split("");return`#${r}${r}${i}${i}${o}${o}`.toLowerCase()}return null}function nl(e){const t=st(e);if(!t)return null;const n=t.slice(1),r=parseInt(n.slice(0,2),16),i=parseInt(n.slice(2,4),16),o=parseInt(n.slice(4,6),16);return[r,i,o].some(a=>Number.isNaN(a))?null:{r,g:i,b:o}}function Zg({r:e,g:t,b:n}){const r=ii(Math.round(e),0,255),i=ii(Math.round(t),0,255),o=ii(Math.round(n),0,255);return`#${[r,i,o].map(a=>a.toString(16).padStart(2,"0")).join("")}`}function yr(e,t,n=.5){const r=nl(e),i=nl(t);if(!r||!i)return st(e)||st(t);const o=ii(n,0,1);return Zg({r:r.r*(1-o)+i.r*o,g:r.g*(1-o)+i.g*o,b:r.b*(1-o)+i.b*o})}function ka(e,t=.15){return yr(e,"#ffffff",ii(t,0,1))}function Ca(e,t=.15){return yr(e,"#000000",ii(t,0,1))}function rl(e){const t=nl(e);if(!t)return 0;const n=[t.r,t.g,t.b].map(r=>{const i=r/255;return i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4)});return .2126*n[0]+.7152*n[1]+.0722*n[2]}function ra(e,t){const n=st(e),r=st(t);if(!n||!r)return 1;const i=rl(n),o=rl(r),a=Math.max(i,o),c=Math.min(i,o);return(a+.05)/(c+.05)}function _r(e,t,n=4.5){const r=st(t);if(!r)return st(e)||"#ffffff";const i=st(e),o=rl(r),a=o>.5?"#111827":"#f9fafb",c=o>.5?"#f9fafb":"#111827",l=[];i&&l.push({color:i,ratio:ra(i,r)}),l.push({color:st(a),ratio:ra(a,r)}),l.push({color:st(c),ratio:ra(c,r)});let d=l.filter(p=>p.color).sort((p,w)=>w.ratio-p.ratio)[0];if(!d)return"#ffffff";if(d.ratio>=n)return d.color;const u=o>.5?"#000000":"#ffffff";let m=d.color,h=d.ratio;for(let p=0;p<6&&h<n;p+=1)m=yr(m,u,.35),h=ra(m,r);return h>=n?m:d.color}function ao(e={}){const t=st(e.base)||st(e.light)||st(e.dark)||"#6b7280",n=st(e.light)||ka(t,.18),r=st(e.dark)||Ca(t,.22);return{light:n,base:st(e.base)||t,dark:r}}const Cr=[{id:"lunar-surface",meta:{label:"Lunar Surface",emoji:"ðŸŒ•",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Full%20Moon/3D/full_moon_3d.png"},appearance:"dark",colors:{background:{light:"#2d3036",base:"#1f2228",dark:"#111419"},neutral:{light:"#dfe3eb",base:"#c7cbd3",dark:"#5f646f"},primary:{light:"#d6dae2",base:"#c3c8d0",dark:"#7b808a"},secondary:{light:"#d8dce4",base:"#c3c7cf",dark:"#757a84"},accent:{light:"#dfe3eb",base:"#ccd1d9",dark:"#8b9098"}},standardColors:{red:{light:"#d7dadd",dark:"#6b6e74"},orange:{light:"#cfd1d6",dark:"#686b71"},yellow:{light:"#c7cacf",dark:"#5f6268"},green:{light:"#c1c4c9",dark:"#585b60"},blue:{light:"#bbbfc5",dark:"#51555c"},pink:{light:"#d2d5da",dark:"#6a6d73"},purple:{light:"#c6c9d0",dark:"#5d6168"},brown:{light:"#bfc2c7",dark:"#55585e"}},text:{primary:"#f0f2f7",muted:"#dde1e8"},appearances:{light:{colors:{background:{light:"#f5f6f8",base:"#e5e7eb",dark:"#c2c5cc"},neutral:{light:"#4f5359",base:"#383c42",dark:"#202329"},primary:{light:"#6d7178",base:"#555960",dark:"#3a3e44"},secondary:{light:"#90949c",base:"#757981",dark:"#4f535a"},accent:{light:"#a4a8b0",base:"#878b93",dark:"#5d6168"}},standardColors:{red:{light:"#a6a9af",dark:"#4a4d53"},orange:{light:"#b0b3b9",dark:"#505359"},yellow:{light:"#bbbfc6",dark:"#555960"},green:{light:"#aeb1b8",dark:"#4c5056"},blue:{light:"#a1a5ac",dark:"#45494f"},pink:{light:"#b7bac1",dark:"#53565d"},purple:{light:"#bfc2ca",dark:"#595d63"},brown:{light:"#a7abb2",dark:"#4a4e54"}},text:{primary:"#1c1f23",muted:"#4f535a"}}}},{id:"apple-orchard",meta:{label:"Apple Orchard",emoji:"ðŸŽ",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Red%20Apple/3D/red_apple_3d.png"},appearance:"dark",colors:{background:{light:"#3a181b",base:"#271012",dark:"#120708"},neutral:{light:"#e4cfc9",base:"#b68f84",dark:"#7d6257"},primary:{light:"#ff6b6f",base:"#d9393e",dark:"#941c20"},secondary:{light:"#8ed97a",base:"#5faa4c",dark:"#3a6f2b"},accent:{light:"#f0b36a",base:"#c87f2f",dark:"#8a4f12"}},standardColors:{red:{light:"#ff6b6f",dark:"#941c20"},orange:{light:"#ff9b4f",dark:"#a85318"},yellow:{light:"#ffe38a",dark:"#b38a1b"},green:{light:"#8ed97a",dark:"#2f6b2a"},blue:{light:"#7fc1f7",dark:"#215b8e"},pink:{light:"#f7a1b5",dark:"#9a4963"},purple:{light:"#c29aff",dark:"#6c3ab8"},brown:{light:"#d7a47d",dark:"#7b4a2d"}},text:{primary:"#fbeae7",muted:"#c7a8a0"}},{id:"heartbeat-glow",meta:{label:"Heartbeat Glow",emoji:"â¤ï¸",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Red%20Heart/3D/red_heart_3d.png"},appearance:"dark",colors:{background:{light:"#431a2a",base:"#301320",dark:"#14060d"},neutral:{light:"#efd1da",base:"#c79aa9",dark:"#8a6976"},primary:{light:"#ff6b8f",base:"#ff3366",dark:"#b1123d"},secondary:{light:"#ffa4d9",base:"#ff6fbf",dark:"#c13f8a"},accent:{light:"#ffd27f",base:"#ffb347",dark:"#b47618"}},standardColors:{red:{light:"#ff6b8f",dark:"#b1123d"},orange:{light:"#ff9354",dark:"#b5541c"},yellow:{light:"#ffe382",dark:"#b88a20"},green:{light:"#9de2c0",dark:"#2f7a52"},blue:{light:"#7fbbff",dark:"#245a9d"},pink:{light:"#ff9ed1",dark:"#aa4d83"},purple:{light:"#c69dff",dark:"#6f3fab"},brown:{light:"#d7a691",dark:"#7a4937"}},text:{primary:"#ffeef3",muted:"#d7a3b7"}},{id:"evergreen-grove",meta:{label:"Evergreen Grove",emoji:"ðŸŒ³",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Evergreen%20Tree/3D/evergreen_tree_3d.png"},appearance:"light",colors:{background:{light:"#f7fbf5",base:"#edf5eb",dark:"#c7d5c4"},neutral:{light:"#88977f",base:"#5b6a54",dark:"#394637"},primary:{light:"#63b36a",base:"#3d8543",dark:"#24562a"},secondary:{light:"#9dc98a",base:"#7aa66a",dark:"#4c7341"},accent:{light:"#f2c78d",base:"#c9985b",dark:"#8f6330"}},standardColors:{red:{light:"#f07f6f",dark:"#9c3b2c"},orange:{light:"#f6a85f",dark:"#b16019"},yellow:{light:"#fbe183",dark:"#b39829"},green:{light:"#7dd687",dark:"#2d6a35"},blue:{light:"#7fb5d9",dark:"#285c7d"},pink:{light:"#f2adc5",dark:"#9b4f74"},purple:{light:"#bfa6ec",dark:"#62479f"},brown:{light:"#cba581",dark:"#6c4b2e"}},text:{primary:"#263322",muted:"#546250"}},{id:"ember-forge",meta:{label:"Ember Forge",emoji:"ðŸ”¥",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Fire/3D/fire_3d.png"},appearance:"dark",colors:{background:{light:"#401812",base:"#2a0f0a",dark:"#120503"},neutral:{light:"#f1d0c2",base:"#d0a89b",dark:"#946f63"},primary:{light:"#ff8a52",base:"#ff6b2d",dark:"#b73c07"},secondary:{light:"#ffc075",base:"#ff9f43",dark:"#c36a15"},accent:{light:"#ffe28a",base:"#ffd166",dark:"#b99229"}},standardColors:{red:{light:"#ff7053",dark:"#b12f1a"},orange:{light:"#ff9f43",dark:"#b55311"},yellow:{light:"#ffd76a",dark:"#b48b16"},green:{light:"#a4d67a",dark:"#436a1f"},blue:{light:"#77b4e8",dark:"#1f5387"},pink:{light:"#f293b3",dark:"#9d4363"},purple:{light:"#c79ae8",dark:"#69399c"},brown:{light:"#d49c71",dark:"#7c451b"}},text:{primary:"#fff2ea",muted:"#ddb09e"}},{id:"fireworks-festival",meta:{label:"Fireworks Festival",emoji:"ðŸŽ†",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Fireworks/3D/fireworks_3d.png"},appearance:"light",colors:{background:{light:"#fbfdff",base:"#f4f7ff",dark:"#d0d9f5"},neutral:{light:"#6f7691",base:"#4e5470",dark:"#313752"},primary:{light:"#6d81ff",base:"#3d5af1",dark:"#2235a3"},secondary:{light:"#ff83da",base:"#ff4ecd",dark:"#c11c92"},accent:{light:"#ffe67a",base:"#ffd74f",dark:"#b89711"}},standardColors:{red:{light:"#ff6a86",dark:"#b31e3d"},orange:{light:"#ff9a4a",dark:"#b35d0d"},yellow:{light:"#ffe67a",dark:"#b5971a"},green:{light:"#94e6c3",dark:"#2c7d4f"},blue:{light:"#6fb6ff",dark:"#205ea2"},pink:{light:"#ffa0de",dark:"#b94b91"},purple:{light:"#b79aff",dark:"#5b38b4"},brown:{light:"#c8a37a",dark:"#704c22"}},text:{primary:"#202544",muted:"#535a79"}},{id:"rose-garden",meta:{label:"Rose Garden",emoji:"ðŸŒ¹",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Rose/3D/rose_3d.png"},appearance:"light",colors:{background:{light:"#fff9fb",base:"#fff4f6",dark:"#e7c7d0"},neutral:{light:"#9c6b7b",base:"#6f4a57",dark:"#402730"},primary:{light:"#ff7a9b",base:"#d03a59",dark:"#911932"},secondary:{light:"#ff98b8",base:"#ff7899",dark:"#c5476b"},accent:{light:"#b6daa1",base:"#8fbf72",dark:"#55773d"}},standardColors:{red:{light:"#ff7a9b",dark:"#911932"},orange:{light:"#ffad71",dark:"#b55e22"},yellow:{light:"#ffe6a3",dark:"#b59135"},green:{light:"#9fdda7",dark:"#3d7b43"},blue:{light:"#7fbef0",dark:"#2a6190"},pink:{light:"#ff9ec6",dark:"#b14a7e"},purple:{light:"#c8a1e8",dark:"#6a347f"},brown:{light:"#d2a28a",dark:"#744434"}},text:{primary:"#2c1a22",muted:"#5c3d47"}},{id:"melody-waves",meta:{label:"Melody Waves",emoji:"ðŸŽµ",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Musical%20Notes/3D/musical_notes_3d.png"},appearance:"dark",colors:{background:{light:"#272b50",base:"#1a1d3b",dark:"#0a0b1b"},neutral:{light:"#d6d8f0",base:"#b5b8d8",dark:"#7c80a3"},primary:{light:"#7a8aff",base:"#5b6dff",dark:"#2c38b8"},secondary:{light:"#b68aff",base:"#9b58ff",dark:"#6221c1"},accent:{light:"#58e2d6",base:"#33d1c6",dark:"#17887e"}},standardColors:{red:{light:"#ff6c87",dark:"#a9203a"},orange:{light:"#ff9a55",dark:"#b1581a"},yellow:{light:"#ffdf73",dark:"#af8b18"},green:{light:"#7ce8c3",dark:"#1f7a54"},blue:{light:"#7fb6ff",dark:"#244ea2"},pink:{light:"#f99ade",dark:"#a7438a"},purple:{light:"#c49dff",dark:"#5f33b6"},brown:{light:"#c6a48a",dark:"#704b34"}},text:{primary:"#eef0ff",muted:"#bfc2df"}},{id:"ocean-tide",meta:{label:"Ocean Tide",emoji:"ðŸŒŠ",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Water%20Wave/3D/water_wave_3d.png"},appearance:"light",colors:{background:{light:"#f4fbfd",base:"#e7f4f9",dark:"#bfd6e1"},neutral:{light:"#73929e",base:"#4d6773",dark:"#2c3f46"},primary:{light:"#3b92c7",base:"#0f6fa4",dark:"#0a4a6e"},secondary:{light:"#55c0e6",base:"#2ba5d6",dark:"#176a8d"},accent:{light:"#f5c98a",base:"#f2b866",dark:"#af7a24"}},standardColors:{red:{light:"#f57c7d",dark:"#9c2d2f"},orange:{light:"#f7a65d",dark:"#b05919"},yellow:{light:"#ffe38a",dark:"#b59128"},green:{light:"#87dcb3",dark:"#2f7850"},blue:{light:"#68c3ff",dark:"#1e5d9a"},pink:{light:"#f4a7c8",dark:"#9e4a73"},purple:{light:"#b8a0f0",dark:"#5d3f9c"},brown:{light:"#c49a76",dark:"#6d4426"}},text:{primary:"#1f2f38",muted:"#4a5e69"}},{id:"sunburst-plains",meta:{label:"Sunburst Plains",emoji:"â˜€ï¸",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Sun/3D/sun_3d.png"},appearance:"light",colors:{background:{light:"#fffdf5",base:"#fff8e6",dark:"#e9d5a5"},neutral:{light:"#9d8458",base:"#755f36",dark:"#4a3819"},primary:{light:"#ffbe4a",base:"#f4a11a",dark:"#b56a06"},secondary:{light:"#ffe066",base:"#ffcc33",dark:"#c1900b"},accent:{light:"#7cd3dc",base:"#5dbec8",dark:"#2d8087"}},standardColors:{red:{light:"#ff8360",dark:"#b33e1a"},orange:{light:"#ffb347",dark:"#b86612"},yellow:{light:"#ffe066",dark:"#b6910a"},green:{light:"#a7e37c",dark:"#4a8b20"},blue:{light:"#7fc4f5",dark:"#2a6aa6"},pink:{light:"#f9a4c2",dark:"#a64d6f"},purple:{light:"#c9a6ef",dark:"#6d459d"},brown:{light:"#d2a877",dark:"#704819"}},text:{primary:"#2c220e",muted:"#605235"}},{id:"lunar-serenity",meta:{label:"Lunar Serenity",emoji:"ðŸŒ™",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Crescent%20Moon/3D/crescent_moon_3d.png"},appearance:"dark",colors:{background:{light:"#272a42",base:"#1a1c2e",dark:"#0c0d18"},neutral:{light:"#e0e3f0",base:"#c6c9dd",dark:"#8b8fa8"},primary:{light:"#9aa5ff",base:"#7c89ff",dark:"#3d48b8"},secondary:{light:"#daa9ff",base:"#c98bff",dark:"#8640c9"},accent:{light:"#ffe7a4",base:"#f6d87d",dark:"#b79a33"}},standardColors:{red:{light:"#ff7083",dark:"#ac2538"},orange:{light:"#ff9e55",dark:"#b35a1b"},yellow:{light:"#ffe18a",dark:"#b49028"},green:{light:"#8edcc2",dark:"#2f7860"},blue:{light:"#80c0ff",dark:"#245ca2"},pink:{light:"#f5a7da",dark:"#a55a92"},purple:{light:"#c3a2ff",dark:"#5e3ab2"},brown:{light:"#cdb196",dark:"#755a3b"}},text:{primary:"#f4f5ff",muted:"#c2c5da"}},{id:"frostfall-glade",meta:{label:"Frostfall Glade",emoji:"â„ï¸",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Snowflake/3D/snowflake_3d.png"},appearance:"light",colors:{background:{light:"#ffffff",base:"#f2f8ff",dark:"#c7d8ea"},neutral:{light:"#6d7f93",base:"#4f6175",dark:"#2b3746"},primary:{light:"#6bc1f2",base:"#4aa4e0",dark:"#1f6498"},secondary:{light:"#b2e1ff",base:"#8fd0ff",dark:"#4d8ec7"},accent:{light:"#8ee4d8",base:"#6bd4c4",dark:"#2d8a7d"}},standardColors:{red:{light:"#f27f8e",dark:"#a23744"},orange:{light:"#f8ad6a",dark:"#b3621f"},yellow:{light:"#ffea95",dark:"#b59a24"},green:{light:"#7fdcc0",dark:"#2c7955"},blue:{light:"#6fc3ff",dark:"#1f5da0"},pink:{light:"#f4a6d5",dark:"#9d4f87"},purple:{light:"#bfa4f2",dark:"#5f419f"},brown:{light:"#c6a584",dark:"#6e4c2e"}},text:{primary:"#24364b",muted:"#54677f"}},{id:"granite-peaks",meta:{label:"Granite Peaks",emoji:"â›°ï¸",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Mountain/3D/mountain_3d.png"},appearance:"dark",colors:{background:{light:"#2b2f32",base:"#1f2224",dark:"#0f1112"},neutral:{light:"#e0e3e7",base:"#c2c6cb",dark:"#8a8f95"},primary:{light:"#8a98a7",base:"#6d7e8f",dark:"#425260"},secondary:{light:"#c69b6c",base:"#a57e54",dark:"#6b4b26"},accent:{light:"#7fc2b5",base:"#57a999",dark:"#276f60"}},standardColors:{red:{light:"#f07672",dark:"#a32e2c"},orange:{light:"#f29a5a",dark:"#ae5c19"},yellow:{light:"#f5d877",dark:"#b08a1f"},green:{light:"#9dd2a7",dark:"#316a3a"},blue:{light:"#7fb1d4",dark:"#264d6c"},pink:{light:"#f0a6c5",dark:"#9a4f74"},purple:{light:"#b7a0d9",dark:"#5a417f"},brown:{light:"#c7a47f",dark:"#6d4a28"}},text:{primary:"#edf0f3",muted:"#b7bcc3"}},{id:"hearthside-brew",meta:{label:"Hearthside Brew",emoji:"â˜•",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Hot%20Beverage/3D/hot_beverage_3d.png"},appearance:"dark",colors:{background:{light:"#3f2720",base:"#2e1b13",dark:"#170c08"},neutral:{light:"#ecd8c9",base:"#d0b5a1",dark:"#9a7f6b"},primary:{light:"#d99260",base:"#c47a3d",dark:"#8a4614"},secondary:{light:"#ad6c45",base:"#8d4f2c",dark:"#5b2f14"},accent:{light:"#f6dba0",base:"#e5c27c",dark:"#b38a38"}},standardColors:{red:{light:"#f07262",dark:"#a32b1c"},orange:{light:"#f89c54",dark:"#ae5614"},yellow:{light:"#f8d072",dark:"#b1871a"},green:{light:"#97d28c",dark:"#3a6c30"},blue:{light:"#76b7df",dark:"#1f547a"},pink:{light:"#f09ebc",dark:"#94415f"},purple:{light:"#c59be1",dark:"#66358d"},brown:{light:"#d8aa7c",dark:"#6d3e1b"}},text:{primary:"#fef4ec",muted:"#d8b89d"}},{id:"zephyr-leaf",meta:{label:"Zephyr Leaf",emoji:"ðŸƒ",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Leaf%20Fluttering%20In%20Wind/3D/leaf_fluttering_in_wind_3d.png"},appearance:"light",colors:{background:{light:"#fafffc",base:"#f2fbf4",dark:"#c8e1cd"},neutral:{light:"#789883",base:"#56715c",dark:"#334537"},primary:{light:"#73c08b",base:"#4fa26d",dark:"#2f7047"},secondary:{light:"#a9d8a8",base:"#8ac78a",dark:"#577f57"},accent:{light:"#f6d895",base:"#f2c86b",dark:"#b58b2b"}},standardColors:{red:{light:"#f37d78",dark:"#a33a32"},orange:{light:"#f7aa63",dark:"#b3621c"},yellow:{light:"#ffe08c",dark:"#b19227"},green:{light:"#7fd89a",dark:"#2f6d42"},blue:{light:"#7ebfde",dark:"#266180"},pink:{light:"#f2a9c7",dark:"#964469"},purple:{light:"#bea5e6",dark:"#5f3e93"},brown:{light:"#c7a378",dark:"#6b4726"}},text:{primary:"#233027",muted:"#4f6355"}},{id:"stormspark",meta:{label:"Stormspark",emoji:"âš¡",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Cloud%20With%20Lightning/3D/cloud_with_lightning_3d.png"},appearance:"dark",colors:{background:{light:"#202633",base:"#141923",dark:"#07090d"},neutral:{light:"#d5d9e4",base:"#b7bdc9",dark:"#7f8591"},primary:{light:"#ffe06a",base:"#ffd13b",dark:"#b99105"},secondary:{light:"#86c7ff",base:"#5aa9ff",dark:"#1f69b1"},accent:{light:"#ff8c5c",base:"#ff6f3c",dark:"#b33a11"}},standardColors:{red:{light:"#ff6e63",dark:"#b22c22"},orange:{light:"#ff9945",dark:"#b55612"},yellow:{light:"#ffe06a",dark:"#b89316"},green:{light:"#8bd9a3",dark:"#2f7341"},blue:{light:"#7dbaff",dark:"#1f5ca7"},pink:{light:"#f79cd0",dark:"#a24677"},purple:{light:"#c7a3ff",dark:"#6138a2"},brown:{light:"#c9a281",dark:"#6f4b2a"}},text:{primary:"#f5f6ff",muted:"#c3c8d4"}}];function vu(e,t){if(!e)return{colors:{},standardColors:void 0,text:void 0,legendColors:void 0};const n=e.colors?{...e.colors}:{},r=e.standardColors?{...e.standardColors}:void 0,i=e.text?{...e.text}:void 0,o=e.legendColors?{...e.legendColors}:void 0,a=e.appearances||null,c=(a==null?void 0:a[t])||e.appearance&&(a==null?void 0:a[e.appearance])||null;if(!c)return{colors:n,standardColors:r,text:i,legendColors:o};const l=c.colors?{...n,...c.colors}:n,d=c.standardColors||r,u=c.text||i,m=c.legendColors?{...o||{},...c.legendColors}:o;return{colors:l,standardColors:d,text:u,legendColors:m}}const fs=new Map(Cr.map(e=>[e.id,e])),Da=new Set(Cr.map(e=>e.id)),Jg=Cr.map(e=>`theme-${e.id}`);function ms(e,t=Oe){if(!e)return null;const n=e.meta?{...e.meta}:{label:"",emoji:"",image:null},r=vu(e,t);return{...e,meta:n,colors:r.colors,standardColors:r.standardColors,text:r.text,name:n.emoji||"",label:n.label||"",activeAppearance:t}}const il=new Set;let ja=!1,Tl=!1,so=null,lo=null;function Su(){if(so||typeof window>"u"||typeof window.matchMedia!="function")return so;try{so=window.matchMedia("(prefers-color-scheme: dark)")}catch(e){console.warn("Unable to access system color scheme.",e),so=null}return so}function Qg(){const e=[wu,...El];for(const r of e){const i=xl(r);if(i&&xu.has(i))return Tl=!0,i}const t=Su();return(t&&typeof t.matches=="boolean"?t.matches:!0)?"dark":"light"}function eb(e){var r;const t=e||Oe||"dark",n=Cr.find(i=>i.appearance===t)||Cr[0];return(n==null?void 0:n.id)||((r=Cr[0])==null?void 0:r.id)}function tb(){const e=[yu,...El];for(const t of e){const n=xl(t);if(n){if(Da.has(n))return n;const r=Xg.get(n);if(r&&Da.has(r))return r}}return null}let Oe=Qg(),ln=(()=>{const e=tb();return e?(ja=!0,e):eb(Oe)})();function K(e,t,n){var r;!e||typeof((r=e.style)==null?void 0:r.setProperty)!="function"||!t||e.style.setProperty(t,n)}function nb(e,t){Kg.forEach(n=>{const r=t==null?void 0:t[n];if(!r){K(e,`--color-${n}-light`,""),K(e,`--color-${n}-dark`,"");return}const i=st(r.light),o=st(r.dark);K(e,`--color-${n}-light`,i||""),K(e,`--color-${n}-dark`,o||"")})}function Oc(e,t){return!e||!t?"":`linear-gradient(135deg, ${e}, ${t})`}function Pr(e,t=1){const n=st(e);if(!n)return"";const r=parseInt(n.slice(1,3),16),i=parseInt(n.slice(3,5),16),o=parseInt(n.slice(5,7),16);if([r,i,o].some(c=>Number.isNaN(c)))return"";const a=Math.round(ii(t,0,1)*1e3)/1e3;return`rgba(${r}, ${i}, ${o}, ${a})`}function Al(){if(typeof document>"u")return;const e=document.documentElement,t=document.body;if(!e||!t)return;const n=fs.get(ln);if(!n)return;const{colors:r,standardColors:i,text:o,legendColors:a}=vu(n,Oe),c=r||{},l=ao(c.background||{}),d=ao(c.neutral||{}),u=ao(c.primary||{}),m=ao(c.secondary||{}),h=ao(c.accent||{});let p,w,x,C,M,T,A,E,R;Oe==="light"?(p=l.light,w=ka(p,.12),x=l.base,C=Ca(l.base,.22),M=d.light,T=ka(M,.12),A=d.base,E=d.dark,R=[p,w,ka(w,.14),M,T]):(p=l.base,w=l.light,x=l.dark,C=Ca(x,.28),M=d.base,T=d.light,A=d.dark,E=Ca(A,.24),R=[C,p,w,A,M]),K(e,"--color-background",p),K(e,"--color-background-light",w),K(e,"--color-background-dark",x),K(e,"--color-neutral",M),K(e,"--color-neutral-light",T),K(e,"--color-neutral-dark",A),K(e,"--color-primary",u.base),K(e,"--color-primary-light",u.light),K(e,"--color-primary-dark",u.dark),K(e,"--color-secondary",m.base),K(e,"--color-secondary-light",m.light),K(e,"--color-secondary-dark",m.dark),K(e,"--color-accent",h.base),K(e,"--color-accent-light",h.light),K(e,"--color-accent-dark",h.dark),K(e,"--accent",h.base),K(e,"--accent-500",h.base),K(e,"--accent-bright",h.light),K(e,"--accent-strong",h.dark),K(e,"--layer-background-0",R[0]),K(e,"--layer-background-1",R[1]),K(e,"--layer-background-2",R[2]),K(e,"--layer-background-3",R[3]),K(e,"--layer-background-4",R[4]);const L=R[1]||p,W=R[2]||L,D=R[3]||W,V=R[4]||D,P=R[0]||p;K(e,"--bg",P),K(e,"--surface",L),K(e,"--surface-1",L),K(e,"--surface-2",W),K(e,"--surface-3",D),K(e,"--surface-4",V),K(e,"--bg-color",P),K(e,"--surface-color",L),K(e,"--surface-alt-color",W),K(e,"--surface-strong-color",D),K(e,"--menu-bg",R[1]),K(e,"--map-bg",R[1]);const O=Oe==="light"?.32:.45,s=Oe==="light"?.4:.55;K(e,"--map-border",Pr(u.dark,O)),K(e,"--map-border-strong",Pr(m.dark,s)),K(e,"--action-panel-bg",R[2]),K(e,"--action-option-bg",R[3]),K(e,"--card-bg",R[3]),K(e,"--card-bg-alt",R[4]);const G=L,X=D,re=_r(o==null?void 0:o.primary,G,4.6),q=_r(o==null?void 0:o.muted,G,3.2),ee=_r(o==null?void 0:o.primary,X,4.6);K(e,"--text-color",re),K(e,"--text",re),K(e,"--text-strong",ee),K(e,"--text-muted",q),K(e,"--card-text",_r(o==null?void 0:o.primary,X,4.6)),K(e,"--heading-color",ee);const Me=_r(o==null?void 0:o.primary,h.base,4.6);K(e,"--accent-contrast",Me);const me=Oc(u.dark,u.light),_e=Oc(m.dark,m.light);K(e,"--action-button-bg",me),K(e,"--action-button-text",_r(re,u.dark,4.6));const je=Oe==="light"?.25:.4,lt=Oe==="light"?.3:.5,Ht=Oe==="light"?.3:.45;K(e,"--action-button-shadow",`0 3px 12px ${Pr(u.dark,je)}`),K(e,"--action-button-shadow-hover",`0 10px 24px ${Pr(u.dark,lt)}`),K(e,"--action-button-bg-active",_e),K(e,"--action-button-text-active",_r(re,m.dark,4.6)),K(e,"--action-button-shadow-active",`0 12px 26px ${Pr(m.dark,Ht)}`);const zt=yr(A,G,Oe==="light"?.6:.35),wt=yr(A,G,Oe==="light"?.5:.28),Pe=yr(A,G,Oe==="light"?.42:.22);K(e,"--chip-bg",zt),K(e,"--chip-bg-hover",wt),K(e,"--chip-bg-active",Pe),K(e,"--outline-strong",u.light);const kt=yr(E,G,Oe==="light"?.35:.6),cn=yr(E,G,Oe==="light"?.65:.35);K(e,"--border-strong",kt),K(e,"--border-soft",cn),K(e,"--backdrop-shadow",`0 24px 60px ${Pr(C,Oe==="light"?.28:.55)}`),K(e,"--accent-glow-soft",Pr(h.light,Oe==="light"?.35:.4)),nb(e,i),t.dataset.themeAppearance=Oe}function Mu(e,{persist:t=!0}={}){Da.has(e)&&(t&&(ja=!0,Eo(yu,e),Eo(El[0],e)),ln=e,Cu(),Al(),Nl())}function ku(e,{persist:t=!0,notify:n=!0}={}){xu.has(e)&&e!==Oe&&(t&&(Tl=!0,Eo(wu,e)),Oe=e,Al(),n&&Nl())}function rb(){const e=Su();if(!e||lo)return;const t=n=>{var c;if(Tl)return;const i=(typeof(n==null?void 0:n.matches)=="boolean"?n.matches:!!e.matches)?"dark":"light",o=((c=Cr.find(l=>l.appearance===i))==null?void 0:c.id)||ln,a=!ja&&o!==ln;ku(i,{persist:!1,notify:!a}),!ja&&a&&Mu(o,{persist:!1})};typeof e.addEventListener=="function"?(e.addEventListener("change",t),lo=()=>{e.removeEventListener("change",t),lo=null}):typeof e.addListener=="function"&&(e.addListener(t),lo=()=>{e.removeListener(t),lo=null})}function Cu(){if(typeof document>"u"||!document.body)return;const{body:e}=document;e.classList.remove(...Jg),ln&&e.classList.add(`theme-${ln}`)}function Nl(){const e=fs.get(ln),t=ms(e,Oe);il.forEach(n=>{try{n(ln,t)}catch(r){console.error("Theme listener error",r)}})}function ib(){Cu(),Al(),Nl(),rb()}function Fl(){return ln}function _c(e=ln){return ms(fs.get(e),Oe)}function Eu(){return Cr.map(e=>ms(e,Oe))}function Tu(e){Da.has(e)&&Mu(e,{persist:!0})}function Wa(){return Oe}function qa(e){ku(e,{persist:!0,notify:!0})}function Au(e,{immediate:t=!1}={}){if(typeof e!="function")return()=>{};if(il.add(e),t)try{e(ln,ms(fs.get(ln),Oe))}catch(n){console.error("Theme listener error",n)}return()=>{il.delete(e)}}const ob=xo.map(e=>({id:e.id,label:e.name,description:e.description||"",color:e.color||null})),zs=62,ab=140,sb=220;function qr(e,t,n){return Number.isNaN(e)||e<t?t:e>n?n:e}function di(e){if(!e)return null;const t=String(e).trim();if(!t)return null;const n=t.startsWith("#")?t.slice(1):t;if(/^[0-9a-f]{6}$/i.test(n))return`#${n.toLowerCase()}`;if(/^[0-9a-f]{3}$/i.test(n)){const[r,i,o]=n.split("");return`#${r}${r}${i}${i}${o}${o}`.toLowerCase()}return null}function ol(e){const t=di(e);if(!t)return null;const n=t.slice(1),r=parseInt(n.slice(0,2),16),i=parseInt(n.slice(2,4),16),o=parseInt(n.slice(4,6),16);return[r,i,o].some(a=>Number.isNaN(a))?null:{r,g:i,b:o}}function lb({r:e,g:t,b:n}){const r=i=>Math.min(Math.max(Math.round(i),0),255);return`#${[r(e),r(t),r(n)].map(i=>i.toString(16).padStart(2,"0")).join("")}`}function Nu(e,t,n){const r=ol(e),i=ol(t);if(!r||!i)return di(e)||di(t)||"#7c8ba1";const o=qr(n,0,1);return lb({r:r.r*(1-o)+i.r*o,g:r.g*(1-o)+i.g*o,b:r.b*(1-o)+i.b*o})}function cb(e,t=.18){return Nu(e,"#ffffff",t)}function db(e,t=.22){return Nu(e,"#000000",t)}function ia(e){const t=ol(e);if(!t)return 0;const n=a=>{const c=a/255;return c<=.03928?c/12.92:Math.pow((c+.055)/1.055,2.4)},r=n(t.r),i=n(t.g),o=n(t.b);return .2126*r+.7152*i+.0722*o}function Pc(e,t){const n=di(e),r=di(t);if(!n||!r)return 1;const i=Math.max(ia(n),ia(r)),o=Math.min(ia(n),ia(r));return(i+.05)/(o+.05)}function ub(e){const t=di(e)||"#546a94",n=Pc("#ffffff",t),r=Pc("#111827",t);return n>=4.5||n>=r?"#ffffff":r>=4.5?"#111827":n>=r?"#ffffff":"#111827"}function fb(e){const t=di(e)||"#4c6ef5";return{base:t,light:cb(t,.24),dark:db(t,.28),contrast:ub(t)}}class Dc{constructor(t,n){var i;this.root=t,this.options=[...n.options],this.items=[],this.value="",this.offset=0,this.activeIndex=-1,this.dragging=!1,this.dragPointerId=null,this.dragStartY=0,this.dragStartOffset=0,this.snapTimer=null,this.animationTimer=null,this.onChange=n.onChange,this.onCommit=n.onCommit,this.idPrefix=`wheel-option-${Math.random().toString(36).slice(2,10)}`,this.root.classList.add("wheel-select"),this.root.tabIndex=0,this.root.setAttribute("role","listbox"),this.root.setAttribute("aria-live","polite"),this.root.setAttribute("aria-orientation","vertical"),n.ariaLabel&&this.root.setAttribute("aria-label",n.ariaLabel),n.ariaLabelledBy&&this.root.setAttribute("aria-labelledby",n.ariaLabelledBy),n.ariaDescribedBy&&this.root.setAttribute("aria-describedby",n.ariaDescribedBy),this.viewport=document.createElement("div"),this.viewport.className="wheel-select__viewport",this.track=document.createElement("div"),this.track.className="wheel-select__track",this.viewport.appendChild(this.track),this.root.appendChild(this.viewport),this.renderOptions();const r=n.value??((i=this.options[0])==null?void 0:i.id)??null;r?this.setValue(r,{silent:!0,animate:!1}):(this.updateSelection(!0),this.updateTransforms()),this.bindEvents()}getValue(){return this.value}setValue(t,n={}){if(!this.options.length){this.value="",this.activeIndex=-1,this.root.removeAttribute("aria-activedescendant");return}const r=this.options.findIndex(o=>o.id===t),i=r>=0?r:0;this.offset=i,this.updateTransforms(n.animate??!1),this.updateSelection(!0,{silent:n.silent,commit:n.commit})}destroy(){this.stopSnap(),this.animationTimer&&(window.clearTimeout(this.animationTimer),this.animationTimer=null),this.detachEvents(),this.items.length=0}get maxIndex(){return Math.max(0,this.options.length-1)}renderOptions(){this.track.innerHTML="",this.items=this.options.map((t,n)=>{const r=document.createElement("div");r.className="wheel-select__item",r.id=`${this.idPrefix}-${n}`,r.setAttribute("role","option"),r.setAttribute("aria-selected","false"),r.dataset.value=t.id,r.tabIndex=-1;const i=fb(t.color);r.style.setProperty("--wheel-option-base",i.base),r.style.setProperty("--wheel-option-light",i.light),r.style.setProperty("--wheel-option-dark",i.dark),r.style.setProperty("--wheel-option-contrast",i.contrast);const o=document.createElement("div");o.className="wheel-select__item-label",o.textContent=t.label;const a=document.createElement("div");if(a.className="wheel-select__item-desc",a.textContent=t.description??"",a.hidden=!(t.description&&t.description.trim()),t.description){const c=`${t.label}. ${t.description}`;r.setAttribute("aria-label",c),r.title=t.description}else r.setAttribute("aria-label",t.label),r.removeAttribute("title");return r.append(o),a.hidden||r.append(a),r.addEventListener("click",c=>{c.stopPropagation(),this.root.focus({preventScroll:!0}),this.goToIndex(n,{animate:!0,commit:!0})}),this.track.appendChild(r),r})}bindEvents(){this.handlePointerDown=t=>{if(!(t.button!==0&&t.pointerType!=="touch")){this.root.focus({preventScroll:!0}),this.dragging=!0,this.dragPointerId=t.pointerId,this.dragStartY=t.clientY,this.dragStartOffset=this.offset,this.stopSnap(),this.root.classList.add("wheel-select--dragging");try{this.root.setPointerCapture(t.pointerId)}catch{}}},this.handlePointerMove=t=>{if(!this.dragging||this.dragPointerId!==t.pointerId)return;t.preventDefault();const n=t.clientY-this.dragStartY,r=this.dragStartOffset+n/zs;this.offset=qr(r,0,this.maxIndex),this.updateTransforms(),this.updateSelection(!1)},this.handlePointerUp=t=>{if(!(!this.dragging||this.dragPointerId!==null&&t.pointerId!==this.dragPointerId)){if(this.dragPointerId!==null)try{this.root.releasePointerCapture(this.dragPointerId)}catch{}this.dragging=!1,this.dragPointerId=null,this.root.classList.remove("wheel-select--dragging"),this.snapToNearest(!0)}},this.handlePointerLeave=t=>{!this.dragging||this.dragPointerId!==null&&t.pointerId!==this.dragPointerId||this.snapToNearest(!0)},this.handleWheel=t=>{if(!this.options.length)return;t.preventDefault();const n=t.deltaY,r=this.offset+n/(zs*2.4);this.offset=qr(r,0,this.maxIndex),this.updateTransforms(),this.updateSelection(!1),this.scheduleSnap()},this.handleKeyDown=t=>{if(!this.options.length)return;let n=!1;t.key==="ArrowUp"||t.key==="ArrowLeft"?(this.goToIndex(this.activeIndex-1,{animate:!0,commit:!0}),n=!0):t.key==="ArrowDown"||t.key==="ArrowRight"?(this.goToIndex(this.activeIndex+1,{animate:!0,commit:!0}),n=!0):t.key==="Home"?(this.goToIndex(0,{animate:!0,commit:!0}),n=!0):t.key==="End"?(this.goToIndex(this.maxIndex,{animate:!0,commit:!0}),n=!0):t.key==="PageUp"?(this.goToIndex(this.activeIndex-3,{animate:!0,commit:!0}),n=!0):t.key==="PageDown"?(this.goToIndex(this.activeIndex+3,{animate:!0,commit:!0}),n=!0):(t.key==="Enter"||t.key===" ")&&(this.updateSelection(!0,{commit:!0}),n=!0),n&&t.preventDefault()},this.handleBlur=()=>{this.dragging&&(this.dragging=!1,this.dragPointerId=null,this.root.classList.remove("wheel-select--dragging"),this.snapToNearest())},this.root.addEventListener("pointerdown",this.handlePointerDown),this.root.addEventListener("pointermove",this.handlePointerMove),this.root.addEventListener("pointerup",this.handlePointerUp),this.root.addEventListener("pointercancel",this.handlePointerUp),this.root.addEventListener("pointerleave",this.handlePointerLeave),this.root.addEventListener("wheel",this.handleWheel,{passive:!1}),this.root.addEventListener("keydown",this.handleKeyDown),this.root.addEventListener("blur",this.handleBlur,!0)}detachEvents(){this.root.removeEventListener("pointerdown",this.handlePointerDown),this.root.removeEventListener("pointermove",this.handlePointerMove),this.root.removeEventListener("pointerup",this.handlePointerUp),this.root.removeEventListener("pointercancel",this.handlePointerUp),this.root.removeEventListener("pointerleave",this.handlePointerLeave),this.root.removeEventListener("wheel",this.handleWheel),this.root.removeEventListener("keydown",this.handleKeyDown),this.root.removeEventListener("blur",this.handleBlur,!0)}goToIndex(t,n={}){if(!this.options.length)return;const r=qr(t,0,this.maxIndex);this.offset=r,this.updateTransforms(n.animate??!1),this.updateSelection(!0,{commit:n.commit})}updateTransforms(t=!1){if(!this.items.length)return;t?(this.root.classList.add("wheel-select--animating"),this.animationTimer&&window.clearTimeout(this.animationTimer),this.animationTimer=window.setTimeout(()=>{this.root.classList.remove("wheel-select--animating"),this.animationTimer=null},sb)):this.dragging||this.root.classList.remove("wheel-select--animating");const n=this.maxIndex;this.items.forEach((r,i)=>{const o=i-this.offset,a=o*zs,c=o*-18,l=1-Math.min(Math.abs(o)*.08,.35),d=1-Math.min(Math.abs(o)*.26,.68),u=n-Math.abs(Math.round(o));r.style.transform=`translate3d(0, ${a}px, 0) rotateX(${c}deg) scale(${l})`,r.style.opacity=String(qr(d,.08,1)),r.style.zIndex=String(u+1)})}updateSelection(t=!1,n={}){var a,c;if(!this.options.length){this.value="",this.activeIndex=-1,this.root.removeAttribute("aria-activedescendant");return}const r=qr(Math.round(this.offset),0,this.maxIndex),i=this.options[r];if(!i)return;const o=this.value!==i.id||t;this.activeIndex=r,this.value=i.id,this.items.forEach((l,d)=>{const u=d===r;l.setAttribute("aria-selected",String(u)),u&&this.root.setAttribute("aria-activedescendant",l.id)}),o&&!n.silent&&((a=this.onChange)==null||a.call(this,i.id,i)),n.commit&&!n.silent&&((c=this.onCommit)==null||c.call(this,i.id,i))}scheduleSnap(){this.stopSnap(),this.snapTimer=window.setTimeout(()=>{this.snapTimer=null,this.snapToNearest(!0)},ab)}stopSnap(){this.snapTimer&&(window.clearTimeout(this.snapTimer),this.snapTimer=null)}snapToNearest(t=!1){if(!this.options.length)return;const n=qr(Math.round(this.offset),0,this.maxIndex);this.offset=n,this.updateTransforms(!0),this.updateSelection(!0,{commit:t})}}const Ua=[{id:"Thawbound",label:"Spring",icon:"ðŸŒ±"},{id:"Sunheight",label:"Summer",icon:"â˜€ï¸"},{id:"Emberwane",label:"Autumn",icon:"ðŸ‚"},{id:"Frostshroud",label:"Winter",icon:"â„ï¸"},{id:"random",label:"Random",icon:"â”"}],Ya=[{id:"continent",label:"Continent",description:"Balanced land and water across a broad landmass."},{id:"island",label:"Island",description:"Single island surrounded by deep ocean and dramatic coasts."},{id:"archipelago",label:"Archipelago",description:"Scattered islands with wide sea lanes and sheltered bays."},{id:"coastal",label:"Coastal",description:"Continental shores etched with peninsulas, deltas and inlets."},{id:"pangea",label:"Pangea",description:"A near-unbroken supercontinent with sparse open ocean."},{id:"inland",label:"Inland",description:"Landlocked expanse dotted with inland seas and great lakes."}],Bl="random",yo="random";var pd;const jc=((pd=Ya[0])==null?void 0:pd.id)||"continent",$s=.32,Wc=.08,mb=.82,hb=.88;function pb(){return xo.filter(e=>e.id!==yo)}function co(e,t={}){var c;const{mode:n="stable",seed:r}=t;if(!e||e!==yo)return e;const i=pb();if(!i.length)return((c=xo[0])==null?void 0:c.id)||e;if(n==="random"){const l=Math.floor(Math.random()*i.length);return i[l].id}const o=r!=null?String(r):"";if(!o)return i[0].id;let a=0;for(let l=0;l<o.length;l+=1)a=a*31+o.charCodeAt(l)>>>0;return i[a%i.length].id}function gb(){return Ua.filter(e=>e.id!==Bl)}function Si(e,t={}){var c;const{mode:n="stable",seed:r}=t;if(!e||e!==Bl)return e;const i=gb();if(!i.length)return((c=Ua[0])==null?void 0:c.id)||e;if(n==="random"){const l=Math.floor(Math.random()*i.length);return i[l].id}const o=r!=null?String(r):"";if(!o)return i[0].id;let a=0;for(let l=0;l<o.length;l+=1)a=a*31+o.charCodeAt(l)>>>0;return i[a%i.length].id}function Mi(e){if(!e)return jc;const t=Ya.find(n=>n.id===e);return t?t.id:jc}const bb={easy:"forgiving",normal:"balanced",hard:"brutal",custom:"tailored"},ki=128,yb=[{id:"oreDensity",path:["oreDensity"],label:"Ore Density",hint:"Likelihood of exposed ore veins.",min:0,max:100,step:1},{id:"waterTable",path:["waterTable"],label:"Water Table",hint:"Baseline access to groundwater and springs.",min:0,max:100,step:1},{id:"temperature",path:["temperature"],label:"Temperature",hint:"Relative warmth influencing open ground.",min:0,max:100,step:1},{id:"rainfall",path:["rainfall"],label:"Rainfall",hint:"Moisture levels that drive vegetation density.",min:0,max:100,step:1},{id:"mountains",path:["mountains"],label:"Mountains",hint:"Terrain ruggedness and elevation swings.",min:0,max:100,step:1},{id:"rivers100",path:["rivers100"],label:"Rivers (100 tiles)",hint:"Presence of flowing water near the start.",min:0,max:100,step:1},{id:"lakes100",path:["lakes100"],label:"Lakes (100 tiles)",hint:"Probability of still water nearby.",min:0,max:100,step:1},{id:"streams100",path:["streams100"],label:"Streams (100 tiles)",hint:"Small flowing watercourses weaving through the start area.",min:0,max:100,step:1},{id:"ponds100",path:["ponds100"],label:"Ponds (100 tiles)",hint:"Chance of shallow pond basins and vernal pools forming nearby.",min:0,max:100,step:1},{id:"marshSwamp",path:["marshSwamp"],label:"Marsh & Swamp",hint:"Bias toward saturated marsh flats and wooded swampland.",min:0,max:100,step:1},{id:"bogFen",path:["bogFen"],label:"Bog & Fen",hint:"Preference for peat bogs and spring-fed fens in lowlands.",min:0,max:100,step:1},{id:"mapIslands",path:["mapIslands"],label:"Island Density",hint:"Adjusts how broken apart coastlines and land bridges become.",min:0,max:100,step:1}],wb=[{id:"mapElevationMax",path:["mapElevationMax"],label:"Elevation Bias",hint:"Raises or lowers the overall terrain height relative to sea level.",min:0,max:100,step:1},{id:"mapElevationVariance",path:["mapElevationVariance"],label:"Terrain Variance",hint:"Controls the contrast between lowlands and peaks across the world.",min:0,max:100,step:1},{id:"advanced.elevationBase",path:["advanced","elevationBase"],label:"Elevation Base",hint:"Adjusts the average terrain height.",min:0,max:100,step:1},{id:"advanced.elevationVariance",path:["advanced","elevationVariance"],label:"Elevation Variance",hint:"Controls how steep or flat the landscape feels.",min:0,max:100,step:1},{id:"advanced.elevationScale",path:["advanced","elevationScale"],label:"Elevation Scale",hint:"Sets the scale of elevation noise patterns.",min:0,max:100,step:1},{id:"advanced.vegetationScale",path:["advanced","vegetationScale"],label:"Vegetation Scale",hint:"How clustered forests and clearings appear.",min:0,max:100,step:1},{id:"advanced.oreNoiseScale",path:["advanced","oreNoiseScale"],label:"Ore Noise Scale",hint:"Controls size of ore-rich pockets.",min:0,max:100,step:1},{id:"advanced.oreThresholdOffset",path:["advanced","oreThresholdOffset"],label:"Ore Threshold Offset",hint:"Bias for how easily ore tiles appear.",min:0,max:100,step:1},{id:"advanced.waterGuaranteeRadius",path:["advanced","waterGuaranteeRadius"],label:"Water Guarantee Radius",hint:"Radius checked to ensure starter water.",min:0,max:100,step:1},{id:"advanced.waterFlowMultiplier",path:["advanced","waterFlowMultiplier"],label:"Water Flow Multiplier",hint:"Scales river strength and drainage (50 is balanced).",min:0,max:100,step:1}],xb=[...yb,...wb],qc=[{id:"landmass",label:"Landmass",parameters:["mountains","mapIslands","mapElevationMax","mapElevationVariance","advanced.elevationBase","advanced.elevationVariance","advanced.elevationScale"]},{id:"water",label:"Water",parameters:["waterTable","rivers100","lakes100","streams100","ponds100","marshSwamp","bogFen","advanced.waterGuaranteeRadius","advanced.waterFlowMultiplier"]},{id:"ore",label:"Ore",parameters:["oreDensity","advanced.oreNoiseScale","advanced.oreThresholdOffset"]},{id:"flora",label:"Flora",parameters:["rainfall","advanced.vegetationScale"]},{id:"climate",label:"Climate",parameters:["temperature"]}];function Os(e,t=0,n=100){const r=Number(e);return!Number.isFinite(r)||r<t?t:r>n?n:Math.round(r)}function Zt(e=vo){const t=ni(e);return{...t,advanced:{...t.advanced}}}function Uc(e,t=[]){return t.reduce((n,r)=>{if(!(!n||typeof n!="object"))return n[r]},e)}function vb(e,t=[],n){if(!t.length)return;let r=e;for(let i=0;i<t.length-1;i+=1){const o=t[i];(!r[o]||typeof r[o]!="object")&&(r[o]={}),r=r[o]}r[t[t.length-1]]=n}function Yc(e=[]){return e.join(".")}function Gc(e){if(!e)return[];const t=["a[href]","button:not([disabled])",'input:not([disabled]):not([type="hidden"])',"select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(",");return Array.from(e.querySelectorAll(t)).filter(n=>!(n instanceof HTMLElement)||n.hidden?!1:n.getAttribute("aria-hidden")!=="true")}function Sb(e,t=""){return!e||typeof e!="string"?t:e.split("-").filter(Boolean).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")}function _s(){return typeof crypto<"u"&&(crypto!=null&&crypto.getRandomValues)?crypto.getRandomValues(new Uint32Array(1))[0].toString(36):Math.trunc(Date.now()*Math.random()).toString(36)}function Mb(e){var Wo,to;bu();const t=document.getElementById("content"),n=document.getElementById("setup"),r=t||n||document.body;n&&r!==n&&n.parentElement?n.parentElement.removeChild(n):n&&(n.innerHTML="");const i=r.querySelector(".create-steps");(i==null?void 0:i.parentElement)===r&&i.parentElement.removeChild(i);const o=r.querySelector("#create-step-content");(o==null?void 0:o.parentElement)===r&&o.parentElement.removeChild(o),document.body.classList.add("landing-active");const a=r.querySelector("#game"),c=a&&r.contains(a)?a:null,l=document.createElement("template");l.innerHTML=`
    <header class="setup-appbar" role="banner">
      <label class="setup-appbar__title" for="seed-input">World Seed</label>
      <div class="setup-appbar__seed">
        <div class="seed-row">
          <input id="seed-input" class="input" placeholder="Enter seed or leave blank for random" autocomplete="off">
          <button id="seed-rand" type="button" class="icon-ghost" aria-label="Randomize seed">
            <svg
              aria-hidden="true"
              viewBox="0 0 24 24"
              focusable="false"
              class="icon-ghost__glyph"
            >
              <rect
                x="5"
                y="5"
                width="14"
                height="14"
                rx="3"
                ry="3"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              ></rect>
              <circle cx="9" cy="9" r="1.5" fill="currentColor"></circle>
              <circle cx="15" cy="9" r="1.5" fill="currentColor"></circle>
              <circle cx="9" cy="15" r="1.5" fill="currentColor"></circle>
              <circle cx="15" cy="15" r="1.5" fill="currentColor"></circle>
              <circle cx="12" cy="12" r="1.5" fill="currentColor"></circle>
            </svg>
          </button>
        </div>
      </div>
      <div class="setup-appbar__actions">
        <button
          id="difficulty-toggle"
          type="button"
          class="icon-ghost"
          aria-haspopup="dialog"
          aria-expanded="false"
          aria-controls="difficulty-modal"
          aria-label="Adjust difficulty"
        >
          <svg
            aria-hidden="true"
            viewBox="0 0 24 24"
            focusable="false"
            class="icon-ghost__glyph"
          >
            <path
              d="M4 6h16M4 12h16M4 18h16"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
            ></path>
            <circle cx="9" cy="6" r="2" fill="currentColor"></circle>
            <circle cx="15" cy="12" r="2" fill="currentColor"></circle>
            <circle cx="12" cy="18" r="2" fill="currentColor"></circle>
          </svg>
        </button>
        <button id="start-btn" type="button" class="btn btn--primary">Start</button>
      </div>
    </header>
    <dialog
      id="difficulty-modal"
      class="modal"
      aria-labelledby="difficulty-modal-title"
    >
      <div class="modal__card difficulty-modal">
        <header class="modal__header">
          <div class="modal__title">
            <h2 class="difficulty-modal__title" id="difficulty-modal-title">Difficulty</h2>
            <div class="difficulty-modal__meta">
              <div class="difficulty-score" id="difficulty-score" role="status" aria-live="polite"></div>
              <div class="difficulty-tip" id="difficulty-tip"></div>
            </div>
          </div>
          <button
            id="difficulty-close"
            type="button"
            class="modal__close"
            aria-label="Close difficulty settings"
          >
            âœ•
          </button>
        </header>
        <div class="modal__body">
          <div class="difficulty-modal__preset-field">
            <label class="difficulty-modal__preset-label" for="difficulty-preset">Preset</label>
            <select id="difficulty-preset" class="difficulty-modal__preset"></select>
          </div>
          <div
            class="difficulty-modal__tabs"
            role="tablist"
            aria-label="Difficulty parameter categories"
            data-role="difficulty-tabs"
          ></div>
          <div class="difficulty-modal__panels" data-role="difficulty-panels"></div>
        </div>
        <footer class="modal__footer">
          <button id="difficulty-reset" type="button" class="btn btn--ghost">Reset</button>
          <div class="spacer" aria-hidden="true"></div>
          <button id="difficulty-apply" type="button" class="btn btn--primary">Apply</button>
        </footer>
      </div>
    </dialog>
    <section id="create-step-content" aria-live="polite">
      <div class="setup">
        <div class="setup__column setup__column--primary">
          <div class="card section" id="biome-card">
            <div class="season-row">
              <div class="season-label section__title">Starting Season</div>
              <div class="season-switch" id="season-seg"></div>
            </div>
            <div class="section__title" id="biome-wheel-label">Biome</div>
            <div class="wheel-select-host" id="biome-wheel" aria-describedby="biome-details"></div>
            <div class="sub" id="biome-details"></div>
          </div>
        </div>
        <div class="setup__column setup__column--preview">
          <div class="card section map-section">
            <div class="maptype-row">
              <div class="section__title maptype-label" id="maptype-wheel-label">Map Type</div>
              <div class="wheel-select-host maptype-wheel" id="maptype-wheel" aria-describedby="maptype-details"></div>
            </div>
            <div class="sub" id="maptype-details"></div>
            <div class="map-preview-layout">
              <div id="map-preview" class="map-preview" aria-label="World map preview"></div>
              <div id="map-preview-sidebar" class="map-preview-sidebar"></div>
            </div>
            <p class="sub" id="spawn-info"></p>
          </div>
        </div>
      </div>
    </section>
  `;const d=l.content;r.insertBefore(d,c);const u=r.querySelector("#create-step-content"),m=u==null?void 0:u.querySelector(".setup"),h=r.querySelector(".setup-appbar"),p=r.querySelector("#difficulty-modal"),w=r.querySelector("#difficulty-toggle"),x=p==null?void 0:p.querySelector("#difficulty-close"),C=p==null?void 0:p.querySelector("#difficulty-reset"),M=p==null?void 0:p.querySelector("#difficulty-apply"),T=p==null?void 0:p.querySelector('[data-role="difficulty-tabs"]'),A=p==null?void 0:p.querySelector('[data-role="difficulty-panels"]'),E=p==null?void 0:p.querySelector("#difficulty-tip"),R=p==null?void 0:p.querySelector("#difficulty-score"),L=p==null?void 0:p.querySelector("#difficulty-preset");if(!u||!m||!h||!p||!w||!T||!A)throw new Error("Unable to initialize setup UI layout.");u.hidden=!1,u.style.display="";const W=document.querySelector(".settings-float");W!=null&&W.parentElement&&W.parentElement.removeChild(W);const D=document.createElement("div");D.className="settings-float";const V=document.createElement("button");V.id="landing-settings-btn",V.type="button",V.className="icon-gear",V.setAttribute("aria-haspopup","true"),V.setAttribute("aria-expanded","false"),V.setAttribute("aria-controls","landing-settings-panel"),V.setAttribute("aria-label","Settings"),V.title="Settings";const P=document.createElement("span");P.setAttribute("aria-hidden","true"),P.textContent="âš™ï¸",V.appendChild(P);const O=document.createElement("div");O.id="landing-settings-panel",O.className="hero-settings__panel",O.setAttribute("role","dialog"),O.setAttribute("aria-hidden","true"),O.setAttribute("aria-labelledby","landing-settings-title"),O.innerHTML=`
    <div class="hero-settings__header">
      <div class="badge badge--ok">Alpha</div>
      <div class="hero-settings__title" id="landing-settings-title">Settings</div>
    </div>
    <div class="hero-settings__section">
      <div class="hero-settings__section-title">Theme</div>
      <div class="hero-settings__theme-row" id="landing-theme-grid"></div>
    </div>
  `,D.append(V,O),(document.body||r).appendChild(D);const G=O.querySelector("#landing-theme-grid"),X=m.querySelector("#biome-wheel"),re=m.querySelector("#biome-details"),q=m.querySelector("#season-seg"),ee=m.querySelector("#maptype-wheel"),Me=m.querySelector("#maptype-details"),me=r.querySelector("#seed-input"),_e=r.querySelector("#seed-rand"),je=m.querySelector("#map-preview"),lt=m.querySelector("#map-preview-sidebar"),Ht=m.querySelector("#spawn-info"),zt=r.querySelector("#start-btn");let wt="loading",Pe=null;if(!X||!re||!q||!ee||!Me||!me||!_e||!je||!lt||!Ht||!zt)throw new Error("Missing setup UI elements.");Pe=document.createElement("div"),Pe.className="map-preview__status",Pe.setAttribute("role","status"),Pe.setAttribute("aria-live","polite"),Pe.dataset.status=wt,je.appendChild(Pe),Je();let kt=()=>{};const cn=Eu(),vn=new Map;if(G){G.innerHTML="";const y=document.createElement("div");y.className="hero-settings__theme-contrast";const k=document.createElement("span");k.className="hero-settings__theme-contrast-label",k.textContent="Preview contrast";const F=document.createElement("div");F.className="hero-settings__theme-contrast-controls";const H=document.createElement("button");H.type="button",H.className="hero-settings__theme-contrast-btn",H.textContent="Light",H.setAttribute("aria-pressed","false");const $=document.createElement("button");$.type="button",$.className="hero-settings__theme-contrast-btn",$.textContent="Dark",$.setAttribute("aria-pressed","false"),F.append(H,$),y.append(k,F);const Y=document.createElement("div");Y.className="hero-settings__theme-grid",G.append(y,Y),kt=I=>{const U=I==="light"?"light":"dark";Y.dataset.contrast=U,H.classList.toggle("is-active",U==="light"),$.classList.toggle("is-active",U==="dark"),H.setAttribute("aria-pressed",String(U==="light")),$.setAttribute("aria-pressed",String(U==="dark"))},H.addEventListener("click",()=>{qa("light")}),$.addEventListener("click",()=>{qa("dark")}),cn.forEach(I=>{var Ce,Qe,Kt;const U=document.createElement("button");U.type="button",U.className="hero-settings__theme-btn",U.dataset.themeId=I.id,U.dataset.themeAppearance=I.appearance,U.setAttribute("aria-pressed","false");const ne=((Ce=I.meta)==null?void 0:Ce.label)||Sb(I.id),Z=ne||((Qe=I.meta)==null?void 0:Qe.emoji)||I.id;U.setAttribute("aria-label",`Switch to ${Z}`),U.title=Z;const pe=document.createElement("span");pe.className="hero-settings__theme-icon",pe.textContent=((Kt=I.meta)==null?void 0:Kt.emoji)||"",pe.setAttribute("aria-hidden","true");const ke=document.createElement("span");ke.className="hero-settings__theme-label",ke.textContent=ne;const rt=`linear-gradient(145deg, ${I.colors.primary.light}, ${I.colors.secondary.light})`,Ge=`linear-gradient(145deg, ${I.colors.primary.dark}, ${I.colors.secondary.dark})`;U.style.setProperty("--preview-bg-light",rt),U.style.setProperty("--preview-bg-dark",Ge),U.style.setProperty("--preview-border-light",I.colors.primary.light),U.style.setProperty("--preview-border-dark",I.colors.primary.dark),U.style.setProperty("--preview-fg-light","#18202b"),U.style.setProperty("--preview-fg-dark","#f6f8ff"),U.style.setProperty("--preview-shadow-light","0 1px 1px rgba(255, 255, 255, 0.55)"),U.style.setProperty("--preview-shadow-dark","0 2px 8px rgba(0, 0, 0, 0.55)"),U.append(pe,ke),U.addEventListener("click",()=>{Tu(I.id),dn({returnFocus:!0})}),Y.appendChild(U),vn.set(I.id,U)}),kt(Wa())}function Sn(y=Fl()){vn.forEach((k,F)=>{const H=F===y;k.classList.toggle("is-active",H),k.setAttribute("aria-pressed",String(H))})}function Mn(){!O||!V||(O.classList.add("is-open"),O.setAttribute("aria-hidden","false"),V.setAttribute("aria-expanded","true"))}function dn(y={}){!O||!V||(O.classList.remove("is-open"),O.setAttribute("aria-hidden","true"),V.setAttribute("aria-expanded","false"),y.returnFocus&&V.focus())}V&&O&&D&&(V.addEventListener("click",y=>{y.stopPropagation(),O.classList.contains("is-open")?dn({returnFocus:!0}):Mn()}),O.addEventListener("click",y=>{y.stopPropagation()}),document.addEventListener("click",y=>{D.contains(y.target)||dn()}),document.addEventListener("keydown",y=>{y.key==="Escape"&&dn({returnFocus:!0})}));const In=[],tr=new Map,nt=new Map,ie=new Map;let xt=((Wo=qc[0])==null?void 0:Wo.id)||null,He=_c(),Te=null,ct=null,Hn=null;Au((y,k)=>{He=k||_c(y),kt((He==null?void 0:He.activeAppearance)||Wa()),Sn(y),Te!=null&&Te.setTerrainColors&&Te.setTerrainColors(null,{forceRefresh:!0})},{immediate:!0});const zn=xo.find(y=>y.id==="temperate-broadleaf")||xo[0],Vt=Ua[0],ce=io.find(y=>y.id==="normal")||io[0],nr=new Map(xb.map(y=>[y.id,y]));let it=(zn==null?void 0:zn.id)||"",jt=(Vt==null?void 0:Vt.id)||"",un=jt,Le=(ce==null?void 0:ce.id)||"",ze=Zt(((to=Cs(Le))==null?void 0:to.world)||vo),Wt=Mi(ze.mapType),We="",Ar=null,fi=null;const Oo=async(y=We)=>{const k=typeof y=="string"?y:String(y??"");if(Ar&&fi===k)return Ar;try{const F=await ns(k);return Ar=F,fi=k,F}catch(F){console.warn("Failed to canonicalize seed; using deterministic fallback.",F);const H=pa(k);return Ar=H,fi=k,H}},gs=()=>{Ar=null,fi=null},ht=y=>{We=typeof y=="string"?y:String(y??""),gs()};ht(_s());let xe=it,ae=null,Q=null,De=null,ue=null,he=null,pt=null,dt=null;const $t="setup-spawn-marker",Ct=180,_o=200,Fe=Ui();Object.prototype.hasOwnProperty.call(Fe??{},"startingBiomeId")&&Fe.startingBiomeId!==null&&Fe.startingBiomeId!==void 0&&(it=Fe.startingBiomeId),Fe!=null&&Fe.season&&(jt=Fe.season),Fe!=null&&Fe.difficulty&&(Le=io.some(y=>y.id===Fe.difficulty)?Fe.difficulty:"custom"),Fe!=null&&Fe.worldParameters&&(ze=Zt(Fe.worldParameters),Wt=Mi(ze.mapType)),Fe!=null&&Fe.seed&&ht(String(Fe.seed)),un=Si(jt,{mode:"stable",seed:We}),xe=co(it,{mode:"stable",seed:We});const fn=[{type:"open",label:"Open Land"},{type:"forest",label:"Forest"},{type:"stone",label:"Stone Outcrop"},{type:"ore",label:"Ore Deposits"},{type:"water",label:"Water"}],Po=fn.reduce((y,k)=>(y[k.type]=k.label,y),{});me.value=We;function $e(y,k){y.forEach(F=>{F.classList.toggle("is-active",F===k)})}function Ot(){ue&&(ue.style.display="none",ue.setAttribute("aria-hidden","true")),he=null}function Ye(){var k,F;const y=(k=Te==null?void 0:Te.elements)==null?void 0:k.wrapper;if(!y)return null;if(!ue){ue=document.createElement("div"),ue.className="spawn-confirm",ue.setAttribute("role","dialog"),ue.setAttribute("aria-modal","false"),ue.setAttribute("aria-hidden","true"),ue.style.position="absolute",ue.style.display="none",ue.style.flexDirection="column",ue.style.gap="8px",ue.style.padding="12px 16px",ue.style.borderRadius="12px",ue.style.boxShadow="0 12px 24px rgba(0, 0, 0, 0.45)",ue.style.minWidth="150px";const H=document.createElement("p");H.dataset.role="spawn-question",H.style.margin="0",H.style.fontWeight="600",ue.appendChild(H);const $=document.createElement("div");$.style.display="flex",$.style.justifyContent="flex-end",$.style.gap="8px";const Y=document.createElement("button");Y.type="button",Y.textContent="No",Y.dataset.role="spawn-no";const I=document.createElement("button");I.type="button",I.textContent="Yes",I.dataset.role="spawn-yes",$.appendChild(Y),$.appendChild(I),ue.appendChild($),I.addEventListener("click",()=>{he&&ot({x:he.x,y:he.y}),Ot()}),Y.addEventListener("click",()=>{Ot()})}return ue.parentElement!==y&&((F=ue.parentElement)==null||F.removeChild(ue),y.appendChild(ue)),ue}function se(y){var U;const k=Ye();if(!k)return;const F=At(y||{});if(!F)return;he={x:F.x,y:F.y};const H=k.querySelector('[data-role="spawn-question"]');H&&(H.textContent=F.relocated?`Water tile unavailable. Spawn at nearest land (${F.x}, ${F.y})?`:`Spawn here at (${F.x}, ${F.y})?`);const $=(U=Te==null?void 0:Te.elements)==null?void 0:U.wrapper;let Y=(y==null?void 0:y.element)||null;if(F.relocated&&$){const ne=`[data-world-x="${F.x}"][data-world-y="${F.y}"]`,Z=$.querySelector(ne);Z&&(Y=Z)}if($&&(Y!=null&&Y.getBoundingClientRect)){const ne=$.getBoundingClientRect(),Z=Y.getBoundingClientRect(),pe=Z.left-ne.left+Z.width/2,ke=Z.top-ne.top+Z.height/2;k.style.left=`${pe}px`,k.style.top=`${ke}px`}else k.style.left="50%",k.style.top="50%";k.style.transform="translate(-50%, -120%)",k.style.display="flex",k.setAttribute("aria-hidden","false");const I=k.querySelector('[data-role="spawn-yes"]');I&&(typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(()=>I.focus()):setTimeout(()=>I.focus(),0))}function Et(y,k,F=0,H=0){const $=Math.max(1,Math.trunc(y??ki)),Y=Math.max(1,Math.trunc(k??ki)),I=Math.floor($/2),U=Math.floor(Y/2),ne=Number.isFinite(F)?Math.round(F):0,Z=Number.isFinite(H)?Math.round(H):0;return{xStart:ne-I,yStart:Z-U}}function qe(){var $,Y;if(!ae||!Q)return null;const y=Math.max(1,Math.trunc((($=ae==null?void 0:ae.dimensions)==null?void 0:$.width)??Q.width??0)),k=Math.max(1,Math.trunc(((Y=ae==null?void 0:ae.dimensions)==null?void 0:Y.height)??Q.height??0));if(!y||!k)return null;const F=Number.isFinite(Q.xStart)?Math.trunc(Q.xStart):0,H=Number.isFinite(Q.yStart)?Math.trunc(Q.yStart):0;return{width:y,height:k,size:y*k,xStart:F,yStart:H}}function ut(y={}){const k=qe();if(!k)return null;const F=Math.trunc(y.x)-k.xStart,H=Math.trunc(y.y)-k.yStart;return!Number.isFinite(F)||!Number.isFinite(H)||F<0||H<0||F>=k.width||H>=k.height?null:H*k.width+F}function Tt(y){const k=qe();if(!k||y==null||y<0||y>=k.size)return null;const F=y%k.width,H=Math.trunc(y/k.width);return{x:k.xStart+F,y:k.yStart+H,index:y}}function kn(y){var U,ne,Z,pe;if(!(ae!=null&&ae.layers))return!1;const k=qe();if(!k||y==null||y<0||y>=k.size)return!1;const F=ae.layers,H=Number.isFinite((U=F.elevation)==null?void 0:U[y])?F.elevation[y]:0,$=Number.isFinite((ne=F.runoff)==null?void 0:ne[y])?F.runoff[y]:0,Y=Number.isFinite((Z=F.moisture)==null?void 0:Z[y])?F.moisture[y]:0;return(Number.isFinite((pe=F.water)==null?void 0:pe[y])?F.water[y]:0)>=.5?!0:H<=$s||H<=$s+Wc&&$>=mb||Y>=hb&&H<=$s+Wc}function Nr(y={}){const k=qe();if(!k)return null;const F=Number.isFinite(y==null?void 0:y.x)?Math.trunc(y.x):null,H=Number.isFinite(y==null?void 0:y.y)?Math.trunc(y.y):null;let $=null;for(let Y=0;Y<k.height;Y+=1){const I=Y*k.width;for(let U=0;U<k.width;U+=1){const ne=I+U;if(kn(ne))continue;const Z=k.xStart+U,pe=k.yStart+Y,ke=F!==null?Z-F:Z,rt=H!==null?pe-H:pe,Ge=Math.hypot(ke,rt);(!$||Ge<$.distance||Math.abs(Ge-$.distance)<1e-6&&(Math.abs(pe)<Math.abs($.y)||Math.abs(pe)===Math.abs($.y)&&Math.abs(Z)<Math.abs($.x)))&&($={x:Z,y:pe,index:ne,distance:Ge})}}return $}function Fr(){if(!(ae!=null&&ae.spawnSuggestions)||ae.spawnSuggestions.length===0)return null;for(let y=0;y<ae.spawnSuggestions.length;y+=1){const k=ae.spawnSuggestions[y],F=Tt(k);if(F&&!kn(k))return{x:F.x,y:F.y}}return null}function At(y={}){const k=Number.isFinite(y.x)?Math.trunc(y.x):null,F=Number.isFinite(y.y)?Math.trunc(y.y):null;if(k===null||F===null)return null;if(!qe())return{x:k,y:F,terrain:null,relocated:!1};const $=ut({x:k,y:F});if($!==null&&!kn($))return{x:k,y:F,terrain:null,relocated:!1};const Y=Nr({x:k,y:F});if(!Y)return $===null?{x:k,y:F,terrain:null,relocated:!1}:null;const I=Y.x!==k||Y.y!==F;return{x:Y.x,y:Y.y,terrain:null,relocated:I}}function ot(y={},k={}){if(!y)return!1;const F=At(y);return F?(De={x:F.x,y:F.y},k.silent||Ot(),Ze(),ve(),!0):!1}function Ke(y={}){const k=Fr();if(Q&&(Q.spawnSuggestion=k?{...k}:null),k&&ot(k,y))return!0;const F=Nr({x:0,y:0});return!!(F&&ot({x:F.x,y:F.y},y))}function Ze(){if(!Te||typeof Te.setMarkers!="function")return;const y=De?[{id:$t,x:De.x,y:De.y,icon:"",label:"Chosen spawn location",emphasis:!0}]:[];Te.setMarkers(y)}function ve(){if(Ht){if(!De){Ht.hidden=!1,Ht.textContent="Click the map to choose your starting position.";return}Ht.textContent="",Ht.hidden=!0}}function Je(){if(!je)return;const y=wt==="error"?"error":wt==="loading"?"loading":"ready";if(wt=y,je.dataset.previewStatus=y,y==="loading"?je.setAttribute("aria-busy","true"):je.removeAttribute("aria-busy"),!Pe)return;Pe.dataset.status=y;let k="";y==="loading"?k="Generating previewâ€¦":y==="error"&&(k="Failed to generate map preview. Please try again."),Pe.textContent=k,Pe.setAttribute("aria-hidden",k?"false":"true")}function rr(y){wt=y==="error"?"error":y==="loading"?"loading":"ready",Je()}function Ki(){if(!Q||!Te){Je();return}Ot(),Te.setMap(Q,{biomeId:xe||it,seed:(Q==null?void 0:Q.seed)??We,season:(Q==null?void 0:Q.season)??un}),Ze(),ve(),Je()}async function Zi(){if(!it||!je)return;const y=ki,k=ki,{xStart:F,yStart:H}=Et(y,k);xe=co(it,{mode:"stable",seed:We});const Y=Si(jt,{mode:"stable",seed:We});un=Y;let I;try{I=await Oo(We)}catch(ke){console.error("Failed to derive canonical seed for preview generation.",ke),I=pa(We)}let U;const ne=Gs(ze,{width:y,height:k});try{U=await Ys({width:y,height:k,seed:I,params:ne})}catch(ke){throw console.error("Failed to generate world artifact for preview.",ke),ke}ae=U,Q=si(U,{seedInfo:I,seedString:We,season:Y,xStart:F,yStart:H,viewport:{xStart:F,yStart:H,width:y,height:k},worldSettings:ze}),Ke({silent:!0})||(De=null,Ze(),ve()),Ki(),ar()}function ye(){var Ft,Hr;const y=((Ft=Te==null?void 0:Te.elements)==null?void 0:Ft.stage)||((Hr=Te==null?void 0:Te.elements)==null?void 0:Hr.wrapper);if(!y)return;const k=y.querySelector('[data-role="legend-toggle"]');k!=null&&k.parentElement&&k.parentElement.removeChild(k);const F=y.querySelector('[data-role="map-legend-overlay"]');F!=null&&F.parentElement&&F.parentElement.removeChild(F);const H="setup-map-legend",$=document.createElement("div");$.className="map-legend-overlay",$.dataset.role="map-legend-overlay",$.id=H,$.hidden=!0,$.setAttribute("role","dialog"),$.setAttribute("aria-modal","true"),$.setAttribute("aria-label","Terrain legend"),$.setAttribute("aria-hidden","true"),$.tabIndex=-1;const Y=document.createElement("div");Y.className="map-legend-overlay__panel";const I=document.createElement("div");I.className="map-legend",I.dataset.role="map-legend",I.setAttribute("role","document"),I.tabIndex=-1;const U=document.createElement("button");U.type="button",U.className="map-legend__close",U.setAttribute("aria-label","Close terrain legend"),U.innerHTML='<span aria-hidden="true">Ã—</span>',I.appendChild(U);const ne=document.createElement("div");ne.className="map-legend__list",ne.setAttribute("role","list"),fn.forEach(de=>{const ft=document.createElement("div");ft.className="map-legend__item",ft.setAttribute("role","listitem");const Bt=document.createElement("span");Bt.className="map-legend__swatch",de.type&&(Bt.dataset.type=de.type),ft.appendChild(Bt);const hn=document.createElement("span");hn.className="map-legend__label",hn.textContent=de.label,ft.appendChild(hn),ne.appendChild(ft)}),I.appendChild(ne),Y.appendChild(I),$.appendChild(Y);const Z=document.createElement("button");Z.type="button",Z.className="map-legend-toggle",Z.dataset.role="legend-toggle",Z.setAttribute("aria-label","Show terrain legend"),Z.setAttribute("aria-controls",H),Z.setAttribute("aria-expanded","false"),Z.setAttribute("aria-haspopup","dialog");const pe=document.createElement("span");pe.className="map-legend-toggle__icon",pe.setAttribute("aria-hidden","true"),pe.textContent="?",Z.appendChild(pe);const ke=de=>{Z.setAttribute("aria-expanded",String(de)),Z.setAttribute("aria-label",de?"Hide terrain legend":"Show terrain legend"),Z.classList.toggle("is-active",de),$.setAttribute("aria-hidden",String(!de))},rt=["button:not([disabled])","[href]","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(","),Ge=()=>Array.from($.querySelectorAll(rt)).filter(de=>de.offsetParent!==null||de.getClientRects().length>0||de===document.activeElement),Ce=()=>{const de=Ge(),ft=de.length?de[0]:$;requestAnimationFrame(()=>{ft.focus()})},Qe=()=>{$.hidden||($.hidden=!0,ke(!1),Z.focus())},Kt=()=>{$.hidden&&($.hidden=!1,ke(!0),Ce())},Nt=de=>{de&&de.preventDefault(),$.hidden?Kt():Qe()};Z.addEventListener("click",Nt),Z.addEventListener("keydown",de=>{(de.key===" "||de.key==="Enter")&&(de.preventDefault(),Nt(de))}),U.addEventListener("click",()=>{Qe()}),$.addEventListener("pointerdown",de=>{de.target===$&&(de.preventDefault(),Qe())}),$.addEventListener("keydown",de=>{if(de.key==="Escape"){de.preventDefault(),Qe();return}if(de.key==="Tab"){const ft=Ge();if(!ft.length){de.preventDefault(),$.focus();return}const Bt=ft[0],hn=ft[ft.length-1],no=document.activeElement;de.shiftKey?(no===Bt||!$.contains(no))&&(de.preventDefault(),hn.focus()):no===hn&&(de.preventDefault(),Bt.focus())}}),y.appendChild(Z),y.appendChild($)}function ir(y){!y||!nt.has(y)||(nt.forEach((k,F)=>{const H=F===y;k.classList.toggle("is-active",H),k.setAttribute("aria-selected",String(H)),k.tabIndex=H?0:-1}),ie.forEach((k,F)=>{const H=F===y;k.hidden=!H,k.setAttribute("aria-hidden",String(!H))}),xt=y)}function bs(){var F;if(!T||!A)return;const y=qc.filter(H=>Array.isArray(H.parameters)&&H.parameters.length);nt.clear(),ie.clear(),tr.clear(),T.innerHTML="",A.innerHTML="",L&&(L.innerHTML="",[...io,{id:"custom",name:"Custom"}].forEach($=>{const Y=document.createElement("option");Y.value=$.id;const I=bb[$.id];Y.textContent=I?`${$.name} â€” ${I}`:$.name,L.appendChild(Y)}),L.addEventListener("change",()=>{Qi(L.value)})),y.forEach(H=>{const $=`difficulty-tab-${H.id}`,Y=`difficulty-panel-${H.id}`,I=document.createElement("button");I.type="button",I.className="difficulty-modal__tab",I.id=$,I.dataset.categoryId=H.id,I.setAttribute("role","tab"),I.setAttribute("aria-controls",Y),I.setAttribute("aria-selected","false"),I.tabIndex=-1,I.textContent=H.label,I.addEventListener("click",()=>{ir(H.id),I.focus()}),I.addEventListener("keydown",ne=>{var pe,ke,rt,Ge;if(!y.length)return;const Z=y.findIndex(Ce=>Ce.id===H.id);if(!(Z<0)){if(ne.key==="ArrowRight"||ne.key==="ArrowDown"){ne.preventDefault();const Ce=y[(Z+1)%y.length];ir(Ce.id),(pe=nt.get(Ce.id))==null||pe.focus()}else if(ne.key==="ArrowLeft"||ne.key==="ArrowUp"){ne.preventDefault();const Ce=y[(Z-1+y.length)%y.length];ir(Ce.id),(ke=nt.get(Ce.id))==null||ke.focus()}else if(ne.key==="Home"){ne.preventDefault();const Ce=y[0];ir(Ce.id),(rt=nt.get(Ce.id))==null||rt.focus()}else if(ne.key==="End"){ne.preventDefault();const Ce=y[y.length-1];ir(Ce.id),(Ge=nt.get(Ce.id))==null||Ge.focus()}}});const U=document.createElement("div");U.id=Y,U.className="difficulty-modal__panel",U.dataset.categoryId=H.id,U.setAttribute("role","tabpanel"),U.setAttribute("aria-labelledby",$),U.setAttribute("aria-hidden","true"),U.hidden=!0,H.parameters.forEach(ne=>{const Z=nr.get(ne);if(!Z)return;const pe=Do(Z);pe!=null&&pe.element&&U.appendChild(pe.element)}),T.appendChild(I),A.appendChild(U),nt.set(H.id,I),ie.set(H.id,U)});const k=xt&&nt.has(xt)&&xt||((F=y[0])==null?void 0:F.id)||null;k&&ir(k),L&&Le&&(L.value=Le)}function or(){q&&(q.innerHTML="",In.length=0,Ua.forEach(y=>{const k=document.createElement("button");k.type="button",k.className="season-switch__button season-switch__button--icon",k.dataset.season=y.id;const F=y.label||y.id;F&&(k.setAttribute("aria-label",F),k.title=F),k.textContent=y.icon||F,k.addEventListener("click",()=>{Dn({season:y.id})}),In.push(k),q.appendChild(k)}))}or();const Cn=ob.map(y=>({id:y.id,label:y.label||y.id,description:y.description||"",color:y.color||null}));X&&(ct=new Dc(X,{options:Cn,value:it,ariaLabelledBy:"biome-wheel-label",ariaDescribedBy:"biome-details",onChange:(y,k)=>{it=y,ar(),Ir(),k!=null&&k.description?X.title=k.description:X.removeAttribute("title")},onCommit:y=>{Dn({startingBiomeId:y})}}));const ys=Ya.map(y=>({id:y.id,label:y.label,description:y.description||""}));ee&&(Hn=new Dc(ee,{options:ys,value:Wt,ariaLabelledBy:"maptype-wheel-label",ariaDescribedBy:"maptype-details",onChange:(y,k)=>{hi(y,{persist:!1}),Ir()},onCommit:y=>{hi(y,{persist:!0})}})),bs(),Te=gu(je,{legendLabels:Po,showControls:!0,showLegend:!1,idPrefix:"setup-map",useTerrainColors:!0,bufferMargin:8,minZoom:.4,controlsContainer:lt,fetchMap:async({xStart:y,yStart:k,width:F,height:H,seed:$,season:Y,viewport:I})=>{const U=$??We;xe=co(it,{mode:"stable",seed:U});const Z=Si(Y??jt,{mode:"stable",seed:U});un=Z;let pe;try{pe=await Oo(U)}catch(Bt){console.error("Failed to canonicalize seed for buffered map fetch.",Bt),pe=pa(U)}const ke=Math.max(1,Math.trunc(F??ki)),rt=Math.max(1,Math.trunc(H??ki)),Ge=Et(ke,rt),Ce=Number.isFinite(y)?Math.trunc(y):Ge.xStart,Qe=Number.isFinite(k)?Math.trunc(k):Ge.yStart,Kt=Gs(ze,{width:ke,height:rt});let Nt;try{Nt=await Ys({width:ke,height:rt,seed:pe,params:Kt})}catch(Bt){throw console.error("Failed to generate world artifact for map fetch.",Bt),Bt}ae=Nt;const Ft=I?{xStart:Number.isFinite(I.xStart)?Math.trunc(I.xStart):Ce,yStart:Number.isFinite(I.yStart)?Math.trunc(I.yStart):Qe,width:Math.max(1,Math.trunc(I.width??ke)),height:Math.max(1,Math.trunc(I.height??rt))}:{xStart:Ce,yStart:Qe,width:ke,height:rt},Hr=si(Nt,{seedInfo:pe,seedString:U,season:Z,xStart:Ce,yStart:Qe,viewport:Ft,worldSettings:ze});Q=Hr;const de=Fr();Q&&(Q.spawnSuggestion=de?{...de}:null);const ft=De?At(De):null;return ft?ot({x:ft.x,y:ft.y},{silent:!0}):(de?ot(de,{silent:!0}):Ke({silent:!0}))||(De=null,Ze(),ve()),Hr},onMapUpdate:y=>{const k=(y==null?void 0:y.buffer)||(Q==null?void 0:Q.buffer)||null,F=(k==null?void 0:k.tileMatrix)||(Q==null?void 0:Q.tileMatrix)||null,H=(k==null?void 0:k.tileData)||(Q==null?void 0:Q.tileData)||null,$=(k==null?void 0:k.layers)||(Q==null?void 0:Q.layerBuffers)||null;Q={...Q,...y,tileMatrix:F,tileData:H,layerBuffers:$,buffer:k?{...k}:(Q==null?void 0:Q.buffer)||null,seedInfo:(Q==null?void 0:Q.seedInfo)||null,worldSettings:y.worldSettings||(Q==null?void 0:Q.worldSettings)||ze},Ze(),ve()},onTileClick:y=>{se(y)}}),ye();let En=null,$n=null;const Br=()=>p?typeof p.open=="boolean"?p.open:p.hasAttribute("open"):!1,Lr=()=>{En==null||En(),En=null,w==null||w.setAttribute("aria-expanded","false");const y=$n&&"focus"in $n?$n:w;y&&typeof y.focus=="function"&&y.focus(),$n=null},ws=y=>{const k=F=>{if(F.key!=="Tab")return;const H=Gc(y);if(!H.length){F.preventDefault();return}const $=H[0],Y=H[H.length-1],I=document.activeElement;F.shiftKey?(!y.contains(I)||I===$)&&(F.preventDefault(),Y.focus()):(!y.contains(I)||I===Y)&&(F.preventDefault(),$.focus())};return y.addEventListener("keydown",k),()=>{y.removeEventListener("keydown",k)}},qt=()=>{if(!p||!w||Br())return;if($n=document.activeElement instanceof HTMLElement?document.activeElement:w,typeof p.showModal=="function")try{p.showModal()}catch{p.setAttribute("open","")}else p.setAttribute("open","");w.setAttribute("aria-expanded","true"),En=ws(p),(Gc(p)[0]||x||p).focus()},On=()=>{if(!(!p||!Br()))if(typeof p.close=="function")try{p.close()}catch{p.removeAttribute("open"),Lr()}else p.removeAttribute("open"),Lr()};w.addEventListener("click",()=>{Br()?On():qt()}),x==null||x.addEventListener("click",()=>{On()}),p==null||p.addEventListener("cancel",y=>{y.preventDefault(),On()}),p==null||p.addEventListener("click",y=>{y.target===p&&On()}),p==null||p.addEventListener("close",Lr),C==null||C.addEventListener("click",()=>{const y=(L==null?void 0:L.value)||Le||"custom";Qi(y),Ji(),Rr(),sr(),Ir()}),M==null||M.addEventListener("click",()=>{Dn({difficulty:Le,worldParameters:Zt(ze)}),On()}),jo(it),eo(jt),pi(Le),ar(),sr(),Rr();function ar(){var F,H;if(!re)return;const y=wn(it);if(!y){re.textContent="";return}if(it===yo){const $=[],Y=y.description?`${y.name} â€“ ${y.description}`:y.name;Y&&$.push(Y);const I=xe&&xe!==yo?wn(xe):null;if(I){const U=I.description?`${I.name} â€“ ${I.description}`:I.name,ne=(F=I.features)!=null&&F.length?`Features: ${I.features.join(", ")}.`:"",Z=[U,ne].filter(Boolean).join(" ");Z&&$.push(`Currently previewing: ${Z}`)}re.textContent=$.join(" ");return}const k=(H=y.features)!=null&&H.length?`Features: ${y.features.join(", ")}.`:"";re.textContent=`${y.name}${y.description?` â€“ ${y.description}`:""} ${k}`.trim()}function sr(){var F;if(!E)return;if(!Le){E.textContent="",w==null||w.setAttribute("aria-label","Difficulty");return}const y=Cs(Le),k=((F=io.find(H=>H.id===Le))==null?void 0:F.name)||(Le==="custom"?"Custom":Le);if(y!=null&&y.start){const{people:H=0,foodDays:$=0,firewoodDays:Y=0}=y.start;E.textContent=`${k}: ${H} settlers, ${$} days of food, ${Y} days of firewood.`}else E.textContent=k;w==null||w.setAttribute("aria-label",`Adjust difficulty (current: ${k})`)}function Rr(){if(!R)return;const y=qf(ze);R.textContent=`Score: ${y}`,R.dataset.score=String(y)}function Ir(){pt&&clearTimeout(pt),rr("loading"),pt=setTimeout(async()=>{pt=null;try{await Zi(),rr("ready")}catch(y){console.error("Failed to generate world preview",y),rr("error")}},Ct)}function Ji(){tr.forEach(y=>{const k=Uc(ze,y.path);y.update(k)})}function Qi(y,k={}){const{preserveWorld:F=!1,world:H}=k,$=So[y]?y:"custom";let Y;H?Y=Zt(H):$==="custom"&&F?Y=Zt(ze):Y=Zt(Cs($).world);const I=ni(Y);Le=$,ze=I,Wt=Mi(I.mapType),L&&L.value!==$&&(L.value=$),mi(Wt),Dn({difficulty:$,worldParameters:I})}function xs(y,k){const{def:F}=y,H=Os(k,F.min,F.max),$=Zt(ze);vb($,F.path,H);const Y=ni($);ze=Y,Le="custom",L&&L.value!=="custom"&&(L.value="custom"),y.update(H),Dn({difficulty:"custom",worldParameters:Y})}function Do(y){const k=Yc(y.path),F=document.createElement("div");F.className="difficulty-param";const H=document.createElement("div");H.className="difficulty-param__header";const $=document.createElement("label");$.className="difficulty-param__label";const Y=`difficulty-slider-${k}`;$.setAttribute("for",Y),$.textContent=y.label,y.hint&&($.title=y.hint);const I=document.createElement("input");I.type="range",I.id=Y,I.min=String(y.min),I.max=String(y.max),I.step=String(y.step??1),I.className="difficulty-param__slider range range__input";const U=document.createElement("div");U.className="difficulty-param__range",U.appendChild(I);const ne=document.createElement("output");ne.className="range__value",ne.setAttribute("for",Y),ne.setAttribute("aria-live","polite");const Z=document.createElement("div");Z.className="difficulty-param__range-group",Z.appendChild(U),Z.appendChild(ne);let pe=!1;const ke={def:y,path:y.path,element:F,update(Ce){const Qe=Os(Ce,y.min,y.max),Kt=String(Qe);pe=!0,I.value=Kt,Ge(Qe),pe=!1}},rt=Ce=>{pe||xs(ke,Ce)},Ge=Ce=>{const Qe=Os(Ce,y.min,y.max),Kt=y.max-y.min||1,Nt=(Qe-y.min)/Kt*100;I.style.setProperty("--range-progress",`${Nt}%`),ne.textContent=String(Qe)};return I.addEventListener("input",()=>{const Ce=Number(I.value);Ge(Ce),rt(Ce)}),H.appendChild($),F.appendChild(H),F.appendChild(Z),ke.update(Uc(ze,y.path)),tr.set(Yc(y.path),ke),ke}Le||(Le=(ce==null?void 0:ce.id)||"custom"),L&&(L.value=Le);function jo(y){if(ct){ct.setValue(y,{silent:!0});const k=Cn.find(F=>F.id===y);k!=null&&k.description?X==null||X.setAttribute("title",k.description):X==null||X.removeAttribute("title")}}function mi(y){const k=Mi(y);Wt=k,Hn&&Hn.setValue(k,{silent:!0}),vs()}function vs(){if(!Me)return;const y=Ya.find(k=>k.id===Wt);if(!y){Me.textContent="",ee==null||ee.removeAttribute("title");return}Me.textContent=`${y.label} â€“ ${y.description}`,y.description?ee==null||ee.setAttribute("title",y.description):ee==null||ee.removeAttribute("title")}function hi(y,k={}){const{persist:F=!0}=k,H=Mi(y);if(!H)return;const $=ze.mapType,Y=Zt(ze);Y.mapType=H;const I=ni(Y),U=Wt!==H||$!==H;Wt=H,ze=I,U&&(Le="custom",L&&L.value!=="custom"&&(L.value="custom")),S.worldSettings=Zt(I),mi(H),F&&Dn({difficulty:Le,worldParameters:I})}function eo(y){const k=In.find(F=>F.dataset.season===y);k&&$e(In,k)}function pi(y){!L||!y||L.value!==y&&(L.value=y)}function gi(y){typeof y=="string"&&me.value!==y&&(me.value=y)}function lr(y,k={}){const{immediate:F=!1}=k;dt&&(clearTimeout(dt),dt=null);const H=typeof y=="string"?y.trim():String(y??"");if(F){const $=H||_s();ht($),me.value=$,Dn({seed:$});return}H&&(dt=setTimeout(()=>{dt=null,ht(H),Dn({seed:H})},_o))}function mn(y={}){const{season:k,difficulty:F,seed:H,worldParameters:$}=y,Y=Object.prototype.hasOwnProperty.call(y,"startingBiomeId"),I=Y?y.startingBiomeId:void 0;let U=!1;if(Y&&I!==null&&I!==void 0&&(it=I,jo(I),U=!0),k&&(jt=k,eo(k),un=Si(jt,{mode:"stable",seed:We})),F&&(Le=F,pi(F)),typeof H=="string"&&H&&H!==We&&(ht(H),gi(H),un=Si(jt,{mode:"stable",seed:We}),U=!0),$){const ne=Zt($);ze=ne,S.worldSettings=Zt(ne),Ji();const Z=Mi(ze.mapType);Z!==Wt&&(Wt=Z),mi(Wt)}else S.worldSettings=null;U&&(xe=co(it,{mode:"stable",seed:We}),ar()),sr(),Rr(),Ir()}Om(mn,{immediate:!0}),Dn({startingBiomeId:it,season:jt,difficulty:Le,seed:We,worldParameters:ze},{force:!0}),me.addEventListener("input",()=>{const y=me.value;y.trim()&&lr(y)}),me.addEventListener("change",()=>{lr(me.value,{immediate:!0})}),me.addEventListener("keydown",y=>{y.key==="Enter"&&(y.preventDefault(),lr(me.value,{immediate:!0}))}),_e.addEventListener("click",()=>{lr(_s(),{immediate:!0})}),zt.addEventListener("click",()=>{var Z;const y=me.value.trim();y&&y!==We&&lr(y,{immediate:!0});const k=Ui(),F=k.season||jt,H=Si(F,{mode:F===Bl?"random":"stable",seed:We});un=H;const Y=Object.prototype.hasOwnProperty.call(k,"startingBiomeId")?k.startingBiomeId:void 0,I=Y??it,U=I===yo?xe||co(I,{mode:"stable",seed:We}):I,ne=((Z=wn(U))==null?void 0:Z.color)||null;e({startingBiomeId:U,biomeColor:ne,season:H,difficulty:k.difficulty||Le,seed:k.seed||We,world:Zt(k.worldParameters||ze),spawn:De?{...De}:null})})}let Yr=1,br=null,oa=null,aa=null,on=null,tt=null,Gn=null,Vn=null,al=new Map,ji=null,Ga=null,Va=null,Vc=!1,sa=null;function kb(e,t=""){return!e||typeof e!="string"?t:e.split("-").filter(Boolean).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")}function Ea(){const e=document.getElementById("content");e&&(e.style.transform=`scale(${Yr})`,e.style.transformOrigin="top left"),Bu()}function Fu(e=Fl()){al.forEach((t,n)=>{const r=n===e;t.classList.toggle("active",r),t.setAttribute("aria-pressed",String(r))})}function Cb(){ib(),Fu()}function Bu(){if(!ji)return;const e=Math.round(Yr*100);ji.textContent=`${e}%`,ji.setAttribute("aria-label",`Reset zoom to 100% (current ${e}%)`)}function Xc(e,t){const n=document.createElement("button");return n.type="button",n.textContent=e,n.setAttribute("aria-label",t),n.title=t,n.className="menu-trigger",n}function An(e,t,n){const r=document.createElement("button");r.type="button";const i=document.createElement("span");i.className="panel-icon",i.textContent=e;const o=document.createElement("span");return o.className="panel-label",o.textContent=t,r.append(i,o),typeof n=="function"&&r.addEventListener("click",n),{button:r,iconSpan:i,labelSpan:o}}function Ps(e,t,n){const r=document.createElement("button");return r.type="button",r.textContent=e,r.setAttribute("aria-label",t),r.title=t,r.classList.add("menu-icon-button"),typeof n=="function"&&r.addEventListener("click",n),r}function _t(){on&&(on.classList.remove("open"),on.setAttribute("aria-hidden","true")),tt&&(tt.classList.remove("open"),tt.setAttribute("aria-hidden","true")),Gn&&Gn.setAttribute("aria-expanded","false"),Vn&&Vn.setAttribute("aria-expanded","false")}function Kc(e,t){if(!e||!t)return;const n=e.classList.contains("open");_t(),n||(e.classList.add("open"),e.setAttribute("aria-hidden","false"),t.setAttribute("aria-expanded","true"))}function Eb(e){br&&(br.contains(e.target)||_t())}function Tb(e){e.key==="Escape"&&_t()}function Lu(){return br||(br=document.createElement("div"),br.className="menu-action-group",oa=document.createElement("div"),oa.className="menu-action",Gn=Xc("âš™ï¸","Settings"),Gn.id="settings-btn",Gn.setAttribute("aria-expanded","false"),Gn.setAttribute("aria-haspopup","true"),Gn.addEventListener("click",e=>{e.stopPropagation(),Kc(on,Gn)}),on=document.createElement("div"),on.className="menu-panel settings-panel",on.setAttribute("aria-hidden","true"),oa.append(Gn,on),aa=document.createElement("div"),aa.className="menu-action",Vn=Xc("â˜°","Game menu"),Vn.id="menu-btn",Vn.setAttribute("aria-expanded","false"),Vn.setAttribute("aria-haspopup","true"),Vn.addEventListener("click",e=>{e.stopPropagation(),Kc(tt,Vn)}),tt=document.createElement("div"),tt.id="dropdown-menu",tt.className="menu-panel menu-panel-list",tt.setAttribute("aria-hidden","true"),aa.append(Vn,tt),br.append(oa,aa),Vc||(document.addEventListener("click",Eb),document.addEventListener("keydown",Tb),Vc=!0),br)}function Ab(){if(!on)return;on.innerHTML="",al=new Map,sa&&(sa(),sa=null);const e=document.createElement("div");e.className="theme-settings-section";const t=document.createElement("div");t.className="theme-contrast-toggle";const n=document.createElement("span");n.className="theme-contrast-toggle__label",n.textContent="Preview contrast";const r=document.createElement("div");r.className="theme-contrast-toggle__controls";const i=document.createElement("button");i.type="button",i.className="theme-contrast-toggle__btn",i.textContent="Light",i.setAttribute("aria-pressed","false");const o=document.createElement("button");o.type="button",o.className="theme-contrast-toggle__btn",o.textContent="Dark",o.setAttribute("aria-pressed","false"),r.append(i,o),t.append(n,r);const a=document.createElement("div");a.className="theme-toggle-grid",e.append(t,a),on.appendChild(e),Eu().forEach(h=>{var E,R,L;const p=document.createElement("button");p.type="button",p.className="theme-toggle-button",p.dataset.themeId=h.id,p.dataset.themeAppearance=h.appearance,p.setAttribute("aria-pressed","false");const w=((E=h.meta)==null?void 0:E.label)||kb(h.id),x=w||((R=h.meta)==null?void 0:R.emoji)||h.id;p.setAttribute("aria-label",`Switch to ${x}`),p.title=x;const C=document.createElement("span");C.className="theme-toggle-button__icon",C.textContent=((L=h.meta)==null?void 0:L.emoji)||"",C.setAttribute("aria-hidden","true");const M=document.createElement("span");M.className="theme-toggle-button__label",M.textContent=w;const T=`linear-gradient(145deg, ${h.colors.primary.light}, ${h.colors.secondary.light})`,A=`linear-gradient(145deg, ${h.colors.primary.dark}, ${h.colors.secondary.dark})`;p.style.setProperty("--preview-bg-light",T),p.style.setProperty("--preview-bg-dark",A),p.style.setProperty("--preview-border-light",h.colors.primary.light),p.style.setProperty("--preview-border-dark",h.colors.primary.dark),p.style.setProperty("--preview-fg-light","#18202b"),p.style.setProperty("--preview-fg-dark","#f6f8ff"),p.style.setProperty("--preview-shadow-light","0 1px 1px rgba(255, 255, 255, 0.55)"),p.style.setProperty("--preview-shadow-dark","0 2px 8px rgba(0, 0, 0, 0.55)"),p.append(C,M),p.addEventListener("click",()=>{Tu(h.id),_t()}),a.appendChild(p),al.set(h.id,p)});function l(h){const p=h==="light"?"light":"dark";a.dataset.contrast=p,i.classList.toggle("is-active",p==="light"),o.classList.toggle("is-active",p==="dark"),i.setAttribute("aria-pressed",String(p==="light")),o.setAttribute("aria-pressed",String(p==="dark"))}i.addEventListener("click",()=>{qa("light")}),o.addEventListener("click",()=>{qa("dark")}),l(Wa()),sa=Au((h=Fl(),p)=>{Fu(h);const w=(p==null?void 0:p.activeAppearance)||Wa();l(w)},{immediate:!0});const d=document.createElement("div");d.className="icon-row";const u=Ps("âž–","Zoom out",()=>{Yr=Math.max(.5,Math.round((Yr-.1)*10)/10),Ea()});u.classList.add("zoom-button"),ji=Ps("100%","Reset zoom to 100%",()=>{Yr=1,Ea()}),ji.classList.add("zoom-display-button");const m=Ps("âž•","Zoom in",()=>{Yr=Math.min(2,Math.round((Yr+.1)*10)/10),Ea()});m.classList.add("zoom-button"),d.append(u,ji,m),on.appendChild(d),Bu()}function Nb(e,t,n,r,i,o,a,c,l,d){if(!tt)return;if(tt.innerHTML="",Ga=null,Va=null,typeof t=="function"){const m=An("â†©","Back",()=>{_t(),t(),Ll()});m.button.id="back-btn",m.button.style.display="none",tt.appendChild(m.button),Ga=m.button}if(typeof e=="function"){const m=An("ðŸ‘·","Jobs",()=>{_t(),e()});m.button.id="jobs-btn",tt.appendChild(m.button)}if(typeof c=="function"){const m=An("ðŸ§°","Craft Planner",()=>{_t(),c()});m.button.id="craft-planner-btn",tt.appendChild(m.button)}if(typeof r=="function"){const m=An("ðŸ—ï¸","Construction",()=>{_t(),r()});m.button.id="construction-btn",tt.appendChild(m.button),Va=m.button}if(typeof i=="function"){const m=An("ðŸŽ’","Inventory",()=>{_t(),i()});m.button.id="inventory-btn",tt.appendChild(m.button)}if(typeof l=="function"){const m=An("ðŸŒ¿","Herbarium",()=>{_t(),l()});m.button.id="herbarium-btn",tt.appendChild(m.button)}if(typeof d=="function"){const m=An("ðŸ¾","Bestiary",()=>{_t(),d()});m.button.id="bestiary-btn",tt.appendChild(m.button)}if(typeof o=="function"){const m=An("ðŸ‘¤","Profile",()=>{_t(),o()});m.button.id="profile-btn",tt.appendChild(m.button)}if(typeof a=="function"){const m=An("ðŸ“œ","Log",()=>{_t(),a()});m.button.id="log-btn",tt.appendChild(m.button)}const u=An("ðŸ”„","New Game",()=>{_t(),typeof n=="function"&&n()});u.button.id="reset-btn",tt.appendChild(u.button)}function Fb(e){if(!e)return;const t=Lu();t.parentElement!==e&&(t.parentElement&&t.parentElement.removeChild(t),e.appendChild(t))}function Ll(e){Ga&&(Ga.style.display="none"),Va&&(Va.style.display="flex")}function Bb(e,t,n,r,i,o,a,c,l,d){const u=document.getElementById("top-menu");u&&(Cb(),Lu(),Ab(),Nb(e,t,n,r,i,o,a,c,l,d),u.innerHTML="",u.style.display="none",Ea())}function Lb(e){const t=document.getElementById("bottom-menu");t&&(t.innerHTML="",Object.assign(t.style,{position:"fixed",bottom:"0",left:"0",right:"0",background:"var(--menu-bg)",padding:"4px",display:"flex",justifyContent:"center",zIndex:"1000"}))}const Ds=[{type:"iron ore",hardness:2},{type:"copper ore",hardness:2},{type:"tin ore",hardness:1},{type:"coal",hardness:1},{type:"silver ore",hardness:3}];function Rb(e){return e&&S.locations.get(e)||null}function Ib(e,t,n){var d;const r=e==null?void 0:e.map;if(!((d=r==null?void 0:r.types)!=null&&d.length))return null;const i=Number.isFinite(r.xStart)?Math.trunc(r.xStart):0,o=Number.isFinite(r.yStart)?Math.trunc(r.yStart):0,a=Math.trunc(t)-i,c=Math.trunc(n)-o;if(c<0||a<0)return null;const l=r.types[c];return!l||a>=l.length?null:l[a]}function Hb(e){var r;if(!e)return"open";const t=typeof((r=e.map)==null?void 0:r.openTerrainType)=="string"?e.map.openTerrainType:"";if(t)return t.toLowerCase();const n=wn(e.biome)||null;return Zm(n)}function zb(e){return e.map||(e.map={}),(!e.map.resourceNodes||typeof e.map.resourceNodes!="object")&&(e.map.resourceNodes={}),e.map.resourceNodes}function $b(e,t){return`${Math.trunc(e)}:${Math.trunc(t)}`}function Ob(e,t,n){const i=(e.map||{}).seed??`${e.id}`,o=wn(e.biome)||{},a=ko(i,t,n,"forest-density"),c=ko(i,t,n,"forest-sizes"),l=Number.isFinite(o.woodMod)?o.woodMod:1,d=3+Math.round(a*5),u=Math.max(1,Math.round(d*l)),m=Math.min(.4,c*.4),h=Math.min(.5,.3+c*.3),p=Math.max(0,Math.round(u*m)),w=Math.max(0,Math.round(u*h));return{type:"forest",trees:{small:Math.max(0,u-p-w),medium:w,large:p},stockpiles:{"small logs":0,"medium logs":0,"large logs":0,firewood:0,planks:0,"building lumber":0}}}function _b(e,t,n,r=0){const i=ko(e,t+r,n-r,`ore-type-${r}`),o=Math.floor(i*Ds.length)%Ds.length;return Ds[Math.max(0,o)]}function Pb(e,t,n){const i=(e.map||{}).seed??`${e.id}`,o=ko(i,t,n,"ore-richness"),a=o>.8?3:o>.55?2:1,c=[];for(let d=0;d<a;d+=1){const u=_b(i,t,n,d+1),m=ko(i,t-d,n+d,`ore-qty-${d}`),h=Math.max(1,Math.round(3+m*5));c.push({type:u.type,quantity:h,hardness:u.hardness})}const l=Math.max(2,Math.round(4+o*6));return{type:"ore",deposits:c,stone:l,stockpiles:{stone:0}}}function Db(e,t,n,r){const i=zb(e),o=$b(t,n);if(i[o])r==="forest"&&(i[o].trees||(i[o].trees={small:0,medium:0,large:0}));else if(r==="forest")i[o]=Ob(e,t,n);else if(r==="ore")i[o]=Pb(e,t,n);else{const a=r&&r!=="open"?r:Hb(e);i[o]={type:a}}return(!i[o].stockpiles||typeof i[o].stockpiles!="object")&&(i[o].stockpiles={}),i[o]}function jb(e,t,n){const r=Rb(e);if(!r)return null;const i=Ib(r,t,n),o=Db(r,t,n,i);return o?{...o,trees:{...o.trees||{}},stockpiles:{...o.stockpiles||{}}}:null}function Rl(){Array.isArray(S.orders)||(S.orders=[]),typeof S.orderSeq!="number"&&(S.orderSeq=0)}function Wb(){return Rl(),S.orderSeq+=1,`ord-${S.orderSeq}`}function qb(){return Rl(),S.orders.map(e=>({...e}))}function Ub({type:e,workers:t=1,hours:n=4,notes:r="",metadata:i=null}){Rl();const a={id:Wb(),type:e,workers:Math.max(1,Math.floor(t)),durationHours:Math.max(1,Math.ceil(n)),remainingHours:Math.max(1,Math.ceil(n)),notes:r,status:"pending",metadata:i||null};return S.orders.push(a),{...a}}function Yb(){S.orders=[],S.orderSeq=0}const sl={wood:{icon:"ðŸªµ",label:"Wood"},firewood:{icon:"ðŸªµ",label:"Firewood"},food:{icon:"ðŸ²",label:"Food Rations"},hides:{icon:"ðŸ¦¬",label:"Animal Hides"},"small stones":{icon:"ðŸª¨",label:"Small Stones"},pebbles:{icon:"âšª",label:"Pebbles"},"crafted goods":{icon:"ðŸ§°",label:"Crafted Goods"},"construction progress":{icon:"ðŸ—ï¸",label:"Construction Progress"},preservedFood:{icon:"ðŸ¥«",label:"Preserved Food"},cookedMeals:{icon:"ðŸ–",label:"Cooked Meals"},hidesPrepared:{icon:"ðŸ§µ",label:"Prepared Hides"},mushrooms:{icon:"ðŸ„",label:"Mushrooms"},herbs:{icon:"ðŸŒ¿",label:"Wild Herbs"},berries:{icon:"ðŸ“",label:"Wild Berries"},pinecones:{icon:"ðŸŒ°",label:"Pinecones"},"plant fibers":{icon:"ðŸŒ¾",label:"Plant Fibers"},water:{icon:"ðŸ’§",label:"Water"},grain:{icon:"ðŸŒ¾",label:"Grain"},"root vegetables":{icon:"ðŸ¥•",label:"Root Vegetables"},salt:{icon:"ðŸ§‚",label:"Salt"},spices:{icon:"ðŸ§„",label:"Spices"},feathers:{icon:"ðŸª¶",label:"Feathers"},"animal fat":{icon:"ðŸ§ˆ",label:"Animal Fat"},milk:{icon:"ðŸ¥›",label:"Milk"},cord:{icon:"ðŸª¢",label:"Cord"},"sharpened stone":{icon:"ðŸ—¡ï¸",label:"Sharpened Stone"},"straight branch":{icon:"ðŸŒ¿",label:"Straight Branch"},"sturdy haft stick":{icon:"ðŸ¥¢",label:"Sturdy Haft Stick"},"seasoned wood":{icon:"ðŸª‘",label:"Seasoned Wood"},"prepared hides":{icon:"ðŸ§µ",label:"Prepared Hides"},"raw ore":{icon:"â›ï¸",label:"Raw Ore"},"bronze ingot":{icon:"ðŸ”¶",label:"Bronze Ingot"},"iron ingot":{icon:"â›“ï¸",label:"Iron Ingot"},"steel ingot":{icon:"âš™ï¸",label:"Steel Ingot"},charcoal:{icon:"â¬›",label:"Charcoal"},clay:{icon:"ðŸ§±",label:"Clay"},"rendered tallow":{icon:"ðŸ•¯ï¸",label:"Rendered Tallow"},"ground flour":{icon:"ðŸ¥£",label:"Ground Flour"},"hearty meal":{icon:"ðŸ²",label:"Hearty Meal"},"bone broth":{icon:"ðŸœ",label:"Bone Broth"},"traveler's bread":{icon:"ðŸ¥–",label:"Traveler's Bread"},"comfort meal":{icon:"ðŸ¥£",label:"Comfort Meal"},"smoked provisions":{icon:"ðŸ¥©",label:"Smoked Provisions"},"preserved vegetables":{icon:"ðŸ¥¬",label:"Preserved Vegetables"},seeds:{icon:"ðŸŒ±",label:"Seeds"},"aromatic sachet":{icon:"ðŸª·",label:"Aromatic Sachet"},"herbal poultice":{icon:"ðŸ©¹",label:"Herbal Poultice"},"restorative tonic":{icon:"ðŸ§ª",label:"Restorative Tonic"},"soothing salve":{icon:"ðŸ’§",label:"Soothing Salve"}};jm().forEach(e=>{const t=sl[e.id]||{};sl[e.id]={icon:e.icon||t.icon||"ðŸŽ’",label:e.label||t.label||e.id}});function zo(e){if(!e)return null;const t=sl[e];if(t)return t;const n=rs(e);return n?{icon:n.icon,label:n.label}:null}function hs(e){if(!e)return"";const t=zo(e);return t!=null&&t.label?t.label:typeof e=="string"&&e.trim()?e.split(/\s+/).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" "):""}const Gb=4200,la={open:1,forest:1.7,ore:1.3,stone:1.4,water:4,ocean:4.2,lake:4,river:3.8,marsh:2.8,mangrove:3.1,default:1.25};function Zc(e){if(!e)return la.default;const t=typeof e=="string"?e.toLowerCase():"";return Rn(t)?la.open:la[t]??la.default}function Jc(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,e)):t}function Vb({fromTerrain:e="open",toTerrain:t="open",distance:n=Wi,swimmingLevel:r=1}={}){const i=Math.max(1,Number.isFinite(n)?n:Wi),o=Zc(e),a=Zc(t);let c=(o+a)/2,l=!1,d="";if(ic(t)||ic(e)){const m=Jc(r,1,100);if(m<8)l=!0,d="The current is too strong to cross without better swimming skill.";else{const h=Jc(3.5-m/25,1.5,3.5);c*=h,m<25&&(d="Crossing the water is slow and exhausting.")}}return{hours:i/Gb*c,blocked:l,reason:d,distance:i,multiplier:c}}function Qc(e){const t=typeof e=="string"?e.toLowerCase():"";if(Rn(t))return"Gentle terrain allows steady progress.";switch(t){case"forest":return"Dense canopy and underbrush slow travel.";case"ore":return"Rocky outcrops require careful footing.";case"stone":return"Jagged stone forces a cautious pace.";case"water":case"lake":case"ocean":return"Requires swimming or a boat to cross safely.";case"river":return"Swift currents complicate fording attempts.";case"marsh":return"Slogging through wetlands is slow and exhausting.";case"mangrove":return"Dense roots and tidal pools demand careful, time-consuming steps.";default:return"Gentle terrain allows steady progress."}}function Ru(e="",{fallback:t=""}={}){const n=String(e??"").trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");return n||t}function Iu(e,t=""){return typeof e!="string"?t:e.trim().toLowerCase()||t}function Xb(e,t){const n=Iu(e);return!n||!t?!1:n===t?!0:n==="open"||n==="meadow"?Rn(t):Rn(n)&&Rn(t)?n===t:!1}const Kb={Thawbound:2,Sunheight:3,Emberwane:3,Frostshroud:2},Ta=["water","river","lake","marsh","ocean","mangrove"],Zb=[{name:"Rowan",habitats:["forest"],encounterName:"storm-felled rowan limb",successSuffix:"from a storm-felled rowan branch ideal for hafting tools."},{name:"Buttonwood",habitats:Ta,encounterName:"salt-hardened buttonwood branch",successSuffix:"from the tide-smoothed buttonwood branch, tough enough for sturdy grips."},{name:"Carob",habitats:["forest","open"],encounterName:"fallen carob limb",successSuffix:"after trimming a dense carob branch suited for tool hafts."}],Hu=Zb.map(e=>{const t=Ru(e.name,{fallback:"tree"}),n=e.name.toLowerCase(),r=`sturdy ${n} stick`;return{id:`sturdy-stick-${t}`,resource:r,singularName:r,encounterName:e.encounterName||`fallen ${n} branch`,type:"loose",habitats:Array.isArray(e.habitats)&&e.habitats.length?[...e.habitats]:["forest"],baseWeight:Number.isFinite(e.baseWeight)?e.baseWeight:2,seasonWeights:{...Kb,...e.seasonWeights||{}},minQuantity:Number.isFinite(e.minQuantity)?e.minQuantity:1,maxQuantity:Number.isFinite(e.maxQuantity)?e.maxQuantity:2,timePerUnit:Number.isFinite(e.timePerUnit)?e.timePerUnit:.35,respawnHours:Number.isFinite(e.respawnHours)?e.respawnHours:16,successSuffix:typeof e.successSuffix=="string"?e.successSuffix:`from a resilient ${n} branch ready to be carved into handles.`,blockedVerb:"gather"}}),Jb=[{id:"forest-mushrooms",resource:"mushrooms",singularName:"mushroom",encounterName:"cluster of mushrooms",type:"loose",habitats:["forest"],baseWeight:3,seasonWeights:{Thawbound:4,Sunheight:2,Emberwane:5,Frostshroud:1},minQuantity:1,maxQuantity:4,timePerUnit:.15,respawnHours:20,successSuffix:"from the forest floor."},{id:"forest-firewood",resource:"firewood",singularName:"bundle of firewood",encounterName:"fallen branches",type:"loose",habitats:["forest"],baseWeight:3,seasonWeights:{Thawbound:3,Sunheight:3,Emberwane:3,Frostshroud:2},minQuantity:1,maxQuantity:3,timePerUnit:.25,respawnHours:12,successSuffix:"from the surrounding forest."},{id:"forest-pinecones",resource:"pinecones",singularName:"pinecone",encounterName:"scatter of pinecones",type:"loose",habitats:["forest"],baseWeight:2,seasonWeights:{Thawbound:2,Sunheight:3,Emberwane:3,Frostshroud:1},minQuantity:2,maxQuantity:6,timePerUnit:.05,respawnHours:10,successSuffix:"from beneath the conifers."},{id:"forest-herbs",resource:"herbs",singularName:"bundle of herbs",encounterName:"patch of herbs",type:"loose",habitats:["forest"],baseWeight:2,seasonWeights:{Thawbound:2,Sunheight:3,Emberwane:4,Frostshroud:1},minQuantity:1,maxQuantity:3,timePerUnit:.2,respawnHours:18,successSuffix:"from a shaded glade."},{id:"forest-spices",resource:"spices",singularName:"handful of aromatic bark",encounterName:"clump of spice bark",type:"loose",habitats:["forest"],baseWeight:1.5,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:3,Frostshroud:1},minQuantity:1,maxQuantity:2,timePerUnit:.22,respawnHours:36,successSuffix:"by shaving fragrant bark and seed pods."},{id:"open-fibers",resource:"plant fibers",singularName:"bundle of plant fibers",encounterName:"tough meadow grasses",type:"loose",habitats:["open"],baseWeight:3,seasonWeights:{Thawbound:2,Sunheight:4,Emberwane:3,Frostshroud:1},minQuantity:1,maxQuantity:4,timePerUnit:.2,respawnHours:16,successSuffix:"by stripping tough grasses."},{id:"straight-saplings",resource:"straight branch",singularName:"straight branch",encounterName:"stand of straight saplings",type:"loose",habitats:["open","forest"],baseWeight:2.5,seasonWeights:{Thawbound:2,Sunheight:3,Emberwane:3,Frostshroud:2},minQuantity:1,maxQuantity:3,timePerUnit:.18,respawnHours:18,successSuffix:"after trimming a straight sapling for tool shafts."},{id:"open-berries",resource:"berries",singularName:"handful of berries",encounterName:"tangle of blackberries",type:"harvest",habitats:["open","forest"],baseWeight:2,seasonWeights:{Thawbound:0,Sunheight:4,Emberwane:5,Frostshroud:1},minQuantity:3,maxQuantity:8,timePerUnit:.18,respawnHours:48,successSuffix:"from a tangled bramble.",blockedVerb:"harvest"},{id:"meadow-grain",resource:"grain",singularName:"sheaf of grain",encounterName:"patch of wild grain",type:"harvest",habitats:["meadow","open"],baseWeight:2,seasonWeights:{Thawbound:0,Sunheight:3,Emberwane:4,Frostshroud:1},minQuantity:2,maxQuantity:5,timePerUnit:.25,respawnHours:36,successSuffix:"from the ripened heads of wild grain.",blockedVerb:"harvest"},{id:"meadow-root-vegetables",resource:"root vegetables",singularName:"bundle of root vegetables",encounterName:"cluster of wild tubers",type:"harvest",habitats:["meadow","open"],baseWeight:2,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:3,Frostshroud:1},minQuantity:2,maxQuantity:4,timePerUnit:.28,respawnHours:40,successSuffix:"after digging up hearty tubers.",blockedVerb:"dig"},{id:"open-stones",resource:"small stones",singularName:"small stone",encounterName:"scatter of stones",type:"loose",habitats:["open","ore"],baseWeight:3,seasonWeights:{Thawbound:3,Sunheight:3,Emberwane:3,Frostshroud:2},minQuantity:2,maxQuantity:5,timePerUnit:.08,respawnHours:8,successSuffix:"from the ground."},{id:"shore-driftwood",resource:"firewood",singularName:"driftwood log",encounterName:"driftwood",type:"loose",habitats:Ta,baseWeight:2,seasonWeights:{Thawbound:2,Sunheight:2,Emberwane:3,Frostshroud:2},minQuantity:1,maxQuantity:3,timePerUnit:.22,respawnHours:14,successSuffix:"washed up along the shore."},{id:"shore-herbs",resource:"herbs",singularName:"bundle of shoreline herbs",encounterName:"stand of shoreline herbs",type:"loose",habitats:Ta,baseWeight:1,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:3,Frostshroud:1},minQuantity:1,maxQuantity:2,timePerUnit:.18,respawnHours:20,successSuffix:"from the marshy banks."},{id:"shore-salt-crust",resource:"salt",singularName:"chunk of salt crust",encounterName:"salt-encrusted tide pool",type:"harvest",habitats:Ta,baseWeight:1,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:2,Frostshroud:1},minQuantity:1,maxQuantity:3,timePerUnit:.3,respawnHours:30,successSuffix:"by scraping salt crust from a receding tide pool.",blockedVerb:"scrape"},{id:"forest-log",resource:"firewood",singularName:"length of timber",encounterName:"fallen log",type:"harvest",habitats:["forest"],baseWeight:1.5,seasonWeights:{Thawbound:2,Sunheight:2,Emberwane:2,Frostshroud:1},minQuantity:3,maxQuantity:6,timePerUnit:.35,respawnHours:72,toolsRequired:["stone hand axe"],successSuffix:"after chopping apart a fallen log.",blockedVerb:"fell"},{id:"forest-carcass",resource:"animal fat",singularName:"lump of animal fat",encounterName:"fresh carcass scraps",type:"harvest",habitats:["forest"],baseWeight:1,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:2,Frostshroud:1},minQuantity:1,maxQuantity:2,timePerUnit:.35,respawnHours:42,toolsRequired:["stone knife"],successSuffix:"after carefully trimming usable fats from a carcass.",blockedVerb:"render"},{id:"meadow-feathers",resource:"feathers",singularName:"bundle of feathers",encounterName:"scatter of molted feathers",type:"loose",habitats:["meadow","open"],baseWeight:2,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:3,Frostshroud:1},minQuantity:2,maxQuantity:6,timePerUnit:.12,respawnHours:18,successSuffix:"gathered from nesting grounds."},{id:"ore-vein",resource:"raw ore",singularName:"chunk of raw ore",encounterName:"vein of ore",type:"harvest",habitats:["ore"],baseWeight:1.2,seasonWeights:{Thawbound:2,Sunheight:2,Emberwane:2,Frostshroud:2},minQuantity:1,maxQuantity:2,timePerUnit:1.5,respawnHours:0,toolsRequired:["stone hand axe","wooden hammer"],successSuffix:"from the exposed vein.",blockedVerb:"mine"}],Qb=[...Jb,...Hu],ed=new Map;function ey(e,t){const n=Iu(e,t);if(!n)return[];const r=ed.get(n);if(r)return r;const i=Qb.filter(o=>Array.isArray(o.habitats)&&o.habitats.some(a=>Xb(a,n)));return ed.set(n,i),i}function ty(e){const t=ey(e);return t.length?t.map(n=>({id:n.id,resource:n.resource,encounterName:n.encounterName||n.resource,type:n.type,toolsRequired:Array.isArray(n.toolsRequired)?[...n.toolsRequired]:[]})):[]}const ny=Hu.map(e=>e.resource);function jn(e,t={}){const{effect:n={},...r}=t||{},i=e.effect||{},o={inputMultiplier:n.inputMultiplier??i.inputMultiplier??1,outputMultiplier:n.outputMultiplier??i.outputMultiplier??1,laborMultiplier:n.laborMultiplier??i.laborMultiplier??1,timeMultiplier:n.timeMultiplier??i.timeMultiplier??1,batchBonus:n.batchBonus??i.batchBonus??0};return{...e,...r,effect:o}}const oe={handCraft:e=>jn({id:"manual",label:"Hand Crafting",type:"manual",priority:0,effect:{inputMultiplier:1,outputMultiplier:.75,laborMultiplier:1.25,timeMultiplier:1.15,batchBonus:0}},e),handCook:e=>jn({id:"manual-cook",label:"Improvised Cooking",type:"manual",priority:0,effect:{inputMultiplier:1,outputMultiplier:.65,laborMultiplier:1.3,timeMultiplier:1.25,batchBonus:0}},e),workshopBench:e=>jn({id:"workshop-bench",label:"Workshop Benches",type:"building",building:"workshop",priority:18,effect:{inputMultiplier:1,outputMultiplier:1.15,laborMultiplier:.85,timeMultiplier:.9,batchBonus:0}},e),workshopForge:e=>jn({id:"workshop-forge",label:"Workshop Forge",type:"building",building:"workshop",priority:22,effect:{inputMultiplier:1,outputMultiplier:1.2,laborMultiplier:.8,timeMultiplier:.85,batchBonus:0}},e),steelForge:e=>jn({id:"steel-forge",label:"Refined Forge",type:"building",building:"workshop",priority:24,effect:{inputMultiplier:1,outputMultiplier:1.25,laborMultiplier:.75,timeMultiplier:.85,batchBonus:0}},e),firePit:e=>jn({id:"fire-pit",label:"Fire Pit Hearth",type:"building",building:"fire-pit",priority:20,effect:{inputMultiplier:1,outputMultiplier:1.25,laborMultiplier:.9,timeMultiplier:.8,batchBonus:0}},e),longhouseHearth:e=>jn({id:"longhouse-hearth",label:"Longhouse Hearth",type:"building",building:"longhouse",priority:16,effect:{inputMultiplier:1,outputMultiplier:1.18,laborMultiplier:.9,timeMultiplier:.85,batchBonus:0}},e),dryingRack:e=>jn({id:"drying-rack",label:"Drying Rack",type:"building",building:"drying-rack",priority:14,effect:{inputMultiplier:.95,outputMultiplier:1.1,laborMultiplier:.95,timeMultiplier:.85,batchBonus:0}},e),smokehouse:e=>jn({id:"smokehouse",label:"Smokehouse",type:"building",building:"smokehouse",priority:22,effect:{inputMultiplier:.9,outputMultiplier:1.35,laborMultiplier:.85,timeMultiplier:.9,batchBonus:0}},e)},zu=[{id:"intermediate",label:"Intermediate Materials",recipes:[{id:"cord",name:"Cord",icon:"ðŸª¢",description:"Twist pliable fibers into sturdy cord for lashings and traps.",category:"intermediate",inputs:{"plant fibers":3},outputs:{cord:1},laborHours:.5,timeHours:.5,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:5,label:"lengths"},production:[oe.handCraft(),oe.workshopBench()]},{id:"sharpened-stone",name:"Sharpened Stone",icon:"ðŸ—¡ï¸",description:"Shape a keen stone edge for scraping hides or cutting cords.",category:"intermediate",inputs:{"small stones":1},outputs:{"sharpened stone":1},laborHours:.25,timeHours:.25,tools:["wooden hammer"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:6,label:"blanks"},production:[oe.handCraft(),oe.workshopBench()]},{id:"prepared-hides",name:"Prepared Hides",icon:"ðŸ§µ",description:"Scrape, cure, and soften hides for armor and advanced crafting.",category:"intermediate",inputs:{hides:1,herbs:1,"plant fibers":1},outputs:{"prepared hides":1},laborHours:2.5,timeHours:6,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:2,label:"hides"},production:[oe.handCraft(),oe.dryingRack()]},{id:"seasoned-wood",name:"Seasoned Wood",icon:"ðŸª‘",description:"Air-dry select timber into balanced hafts and bow staves.",category:"intermediate",inputs:{firewood:3},outputs:{"seasoned wood":1},laborHours:1,timeHours:24,tools:["stone hand axe"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"bundles"},production:[oe.handCraft({label:"Open-Air Seasoning",effect:{outputMultiplier:.7,laborMultiplier:1.3}}),oe.workshopBench({label:"Workshop Racks"})]},{id:"rendered-tallow",name:"Rendered Tallow",icon:"ðŸ•¯ï¸",description:"Slowly clarify animal fats into clean-burning tallow cakes.",category:"intermediate",inputs:{"animal fat":3,firewood:1,salt:1},outputs:{"rendered tallow":2},laborHours:1.5,timeHours:4,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"batches"},production:[oe.handCook({label:"Camp Rendering",effect:{outputMultiplier:.7,laborMultiplier:1.25,timeMultiplier:1.2}}),oe.firePit()]},{id:"grain-flour",name:"Ground Flour",icon:"ðŸ¥£",description:"Crush grains into coarse flour suitable for breads and porridges.",category:"intermediate",inputs:{grain:3,"small stones":1},outputs:{"ground flour":3},laborHours:1,timeHours:1,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:4,label:"sacks"},production:[oe.handCraft({label:"Hand Milling",effect:{outputMultiplier:.8,laborMultiplier:1.2}}),oe.workshopBench({label:"Quern Bench"})]},{id:"bronze-ingot",name:"Smelt Bronze Ingot",icon:"ðŸ”¶",description:"Smelt raw ore in clay crucibles to pour balanced bronze ingots.",category:"intermediate",inputs:{"raw ore":3,firewood:2},outputs:{"bronze ingot":1},laborHours:6,timeHours:8,tools:["wooden hammer"],unlock:{technologies:["bronze-smithing"]},batch:{defaultSize:1,maxSize:2,label:"ingots"},production:[oe.workshopForge()]},{id:"iron-ingot",name:"Smelt Iron Ingot",icon:"â›“ï¸",description:"Roast ore and hammer blooms into workable iron ingots.",category:"intermediate",inputs:{"raw ore":4,firewood:3},outputs:{"iron ingot":1},laborHours:8,timeHours:12,tools:["wooden hammer"],unlock:{technologies:["iron-smithing"]},batch:{defaultSize:1,maxSize:2,label:"ingots"},production:[oe.workshopForge({label:"Bloomery Forge",effect:{outputMultiplier:1.22,laborMultiplier:.78}})]},{id:"steel-ingot",name:"Forge Steel Ingot",icon:"âš™ï¸",description:"Carburize iron with additional ore to forge high-grade steel.",category:"intermediate",inputs:{"iron ingot":1,"raw ore":3,"seasoned wood":1},outputs:{"steel ingot":1},laborHours:10,timeHours:16,tools:["wooden hammer"],unlock:{technologies:["steel-smithing"]},batch:{defaultSize:1,maxSize:2,label:"ingots"},production:[oe.steelForge()]}]},{id:"meals",label:"Cooked Meals",recipes:[{id:"hearty-stew",name:"Hearty Stew",icon:"ðŸ²",description:"Simmer grains, vegetables, and meat into a filling communal stew.",category:"meals",inputs:{grain:2,"root vegetables":3,food:2,herbs:1,salt:1},outputs:{"hearty meal":3,"bone broth":1},laborHours:2.5,timeHours:3,tools:["stone knife","wooden hammer"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"pots"},production:[oe.handCook({effect:{outputMultiplier:.6,laborMultiplier:1.35}}),oe.firePit(),oe.longhouseHearth({label:"Longhouse Cauldrons",effect:{outputMultiplier:1.35,laborMultiplier:.8,timeMultiplier:.75}})]},{id:"traveler-flatbread",name:"Traveler Flatbread",icon:"ðŸ¥–",description:"Bake dense flatbreads that travel well for scouting parties.",category:"meals",inputs:{"ground flour":3,salt:1,"rendered tallow":1},outputs:{"traveler's bread":4},laborHours:1.5,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"rounds"},production:[oe.handCook({label:"Hearthstones",effect:{outputMultiplier:.7,laborMultiplier:1.25}}),oe.firePit()]},{id:"herbal-porridge",name:"Herbal Porridge",icon:"ðŸ¥£",description:"Blend grains, berries, and herbs into a soothing morning porridge.",category:"meals",inputs:{grain:2,berries:2,herbs:1,spices:1},outputs:{"comfort meal":3},laborHours:1,timeHours:1.5,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"bowls"},production:[oe.handCook({effect:{outputMultiplier:.7}}),oe.firePit()]}]},{id:"preserves",label:"Preserves & Stores",recipes:[{id:"smoke-cured-provisions",name:"Smoke-cured Provisions",icon:"ðŸ¥©",description:"Salt and smoke cuts of meat for durable expedition rations.",category:"preserves",inputs:{food:4,salt:2,spices:1,firewood:2},outputs:{"smoked provisions":3},laborHours:3,timeHours:6,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"hooks"},production:[oe.handCook({label:"Makeshift Smoke",effect:{outputMultiplier:.6,laborMultiplier:1.4}}),oe.dryingRack(),oe.smokehouse()]},{id:"pickled-vegetables",name:"Pickled Vegetables",icon:"ðŸ¥¬",description:"Pack roots with herbs and salt into lasting pickled stores.",category:"preserves",inputs:{"root vegetables":4,salt:1,herbs:1,"crafted goods":1},outputs:{"preserved vegetables":4},laborHours:2,timeHours:4,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"jars"},production:[oe.handCraft({label:"Earthen Crocks",effect:{outputMultiplier:.8,laborMultiplier:1.2}}),oe.workshopBench({label:"Workshop Brining"})]},{id:"aromatic-sachets",name:"Aromatic Sachets",icon:"ðŸª·",description:"Dry herbs and spices into sachets that deter pests from stores.",category:"preserves",inputs:{herbs:3,spices:2,"plant fibers":2},outputs:{"aromatic sachet":3},laborHours:1,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:4,label:"sachets"},production:[oe.handCraft({label:"Sun-dried Bundles"}),oe.dryingRack(),oe.workshopBench({label:"Workshop Infusers",effect:{outputMultiplier:1.2,laborMultiplier:.8}})]}]},{id:"remedies",label:"Herbal Remedies",recipes:[{id:"herbal-poultice",name:"Herbal Poultice",icon:"ðŸ©¹",description:"Mash herbs into soothing poultices that speed recovery.",category:"remedies",inputs:{herbs:3,"plant fibers":2,"animal fat":1},outputs:{"herbal poultice":2},laborHours:1.5,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"wraps"},production:[oe.handCraft({label:"Field Dressing"}),oe.dryingRack(),oe.workshopBench({label:"Workshop Apothecary",effect:{outputMultiplier:1.25,laborMultiplier:.85}})]},{id:"restorative-tonic",name:"Restorative Tonic",icon:"ðŸ§ª",description:"Brew concentrated herbal tonics to bolster the infirm.",category:"remedies",inputs:{herbs:2,berries:2,spices:1,salt:1},outputs:{"restorative tonic":2},laborHours:2,timeHours:3,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"bottles"},production:[oe.handCook({label:"Camp Brew",effect:{outputMultiplier:.7}}),oe.firePit({label:"Hearth Decoction"}),oe.workshopBench({label:"Workshop Still",effect:{outputMultiplier:1.25,laborMultiplier:.85}})]},{id:"soothing-salve",name:"Soothing Salve",icon:"ðŸ’§",description:"Blend tallow and herbs into salves that stave off infection.",category:"remedies",inputs:{"rendered tallow":2,herbs:2,spices:1},outputs:{"soothing salve":3},laborHours:1.5,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"pots"},production:[oe.handCraft({label:"Palm Mixing"}),oe.workshopBench({label:"Workshop Mortars",effect:{outputMultiplier:1.2,laborMultiplier:.85}})]}]},{id:"ammunition",label:"Ammunition & Weaponry",recipes:[{id:"arrow-bundle",name:"Arrow Bundle",icon:"ðŸ¹",description:"Carve, fletch, and bundle arrows for ranged hunters.",category:"ammunition",inputs:{"seasoned wood":1,"plant fibers":2,"sharpened stone":2,feathers:4},outputs:{"wooden arrow":6},laborHours:2,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"bundles"},production:[oe.handCraft({label:"Trail Fletching",effect:{outputMultiplier:.8,laborMultiplier:1.2}}),oe.workshopBench({label:"Workshop Fletching Table",effect:{outputMultiplier:1.2,laborMultiplier:.85}})]}]},{id:"equipment",label:"Crafted Equipment",recipes:[{id:"stone-hand-axe",name:"Stone Hand Axe",icon:"ðŸª“",description:"Haft a sharpened stone blade onto a seasoned branch for chopping timber.",category:"equipment",inputs:{cord:1,"sharpened stone":1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"stone hand axe":1},laborHours:2,timeHours:2,tools:["stone knife","wooden hammer"],unlock:{technologies:["basic-tools"]},production:[oe.handCraft({label:"Camp Assembly",effect:{outputMultiplier:.85,laborMultiplier:1.15}}),oe.workshopBench({label:"Workshop Assembly"})]},{id:"stone-pick",name:"Stone Pick",icon:"â›ï¸",description:"Chip a pointed stone and lash it to a haft for prying ore from seams.",category:"equipment",inputs:{cord:1,"sharpened stone":2,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"stone pick":1},laborHours:2.5,timeHours:2.5,tools:["stone knife","wooden hammer"],unlock:{technologies:["basic-tools"]},production:[oe.handCraft({label:"Trail Forging",effect:{outputMultiplier:.85,laborMultiplier:1.2}}),oe.workshopBench({label:"Workshop Toolbench"})]},{id:"bronze-axe",name:"Bronze Axe",icon:"ðŸª“",description:"Forge a bronze axe head and bind it to a resilient haft for advanced lumbering.",category:"equipment",inputs:{"bronze ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"bronze axe":1},laborHours:6,timeHours:6,tools:["wooden hammer"],unlock:{technologies:["bronze-smithing"]},production:[oe.workshopForge({label:"Bronze Forge Bay"})]},{id:"bronze-pick",name:"Bronze Pick",icon:"â›ï¸",description:"Cast and temper a bronze pick for sturdier mining expeditions.",category:"equipment",inputs:{"bronze ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"bronze pick":1},laborHours:6,timeHours:6,tools:["wooden hammer"],unlock:{technologies:["bronze-smithing"]},production:[oe.workshopForge({label:"Bronze Forge Bay"})]},{id:"iron-axe",name:"Iron Axe",icon:"ðŸª“",description:"Shape wrought iron into a balanced axe capable of felling great trees.",category:"equipment",inputs:{"iron ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"iron axe":1},laborHours:8,timeHours:8,tools:["wooden hammer"],unlock:{technologies:["iron-smithing"]},production:[oe.workshopForge({label:"Iron Forge Bay",effect:{outputMultiplier:1.25,laborMultiplier:.78}})]},{id:"iron-pick",name:"Iron Pick",icon:"â›ï¸",description:"Forge an iron pickaxe able to bite through dense stone and ore.",category:"equipment",inputs:{"iron ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"iron pick":1},laborHours:8,timeHours:8,tools:["wooden hammer"],unlock:{technologies:["iron-smithing"]},production:[oe.workshopForge({label:"Iron Forge Bay",effect:{outputMultiplier:1.25,laborMultiplier:.78}})]},{id:"steel-axe",name:"Steel Axe",icon:"ðŸª“",description:"Quench a steel axe head and mount it for master-level forestry.",category:"equipment",inputs:{"steel ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"steel axe":1},laborHours:12,timeHours:12,tools:["wooden hammer"],unlock:{technologies:["steel-smithing"]},production:[oe.steelForge({label:"Steel Forge Bay"})]},{id:"steel-pick",name:"Steel Pick",icon:"â›ï¸",description:"Temper a steel pick to shatter the hardest stone without dulling.",category:"equipment",inputs:{"steel ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"steel pick":1},laborHours:12,timeHours:12,tools:["wooden hammer"],unlock:{technologies:["steel-smithing"]},production:[oe.steelForge({label:"Steel Forge Bay"})]}]}];function ry(e){const t=rs(e);if(!t)throw new Error(`Missing equipment definition for ${e}`);return t}const td=Array.from(new Set(ny||[])).filter(Boolean);function oi(e){return Array.isArray(e)?e.map(t=>oi(t)):e&&typeof e=="object"?Object.fromEntries(Object.entries(e).map(([t,n])=>[t,oi(n)])):e}function Xa(e){if(Array.isArray(e))return e.map(t=>Xa(t));if(e&&typeof e=="object"){const t={};if(Object.entries(e).forEach(([n,r])=>{t[n]=Xa(r)}),t.dynamicOptions==="sturdy-stick"){const n=td.length?[...td]:["sturdy haft stick"];t.options=n,delete t.dynamicOptions,t.label||(t.label="sturdy haft stick"),["quantity","amount","count","required","qty","value"].some(o=>t[o]!==void 0)||(t.quantity=1)}return t}return e}function iy(e){if(!e)return{};if(Array.isArray(e))return e.map(n=>Xa(n));if(typeof e!="object")return e;const t={};return Object.entries(e).forEach(([n,r])=>{t[n]=Xa(r)}),t}function oy(e){if(!e||typeof e!="object")return{defaultSize:1,maxSize:1,label:"batches"};const t=Math.max(1,Math.floor(e.defaultSize??e.size??1)),n=Math.max(t,Math.floor(e.maxSize??e.maximum??t)),r=e.label||e.unit||"batches";return{defaultSize:t,maxSize:n,label:r}}function $u(e){if(!e)return null;if(e==="always")return{always:!0};if(typeof e=="string")return{technologies:[e]};const t={};e.always&&(t.always=!0);const n=new Set,r=new Set,i=new Set,o=new Set;function a(c,l){if(!l)return;(Array.isArray(l)?l:[l]).forEach(u=>{!u&&u!==0||c.add(String(u))})}return a(n,e.technology),a(n,e.technologies),a(n,e.tech),a(n,e.requiredTech),a(r,e.anyTechnology),a(r,e.anyTechnologies),a(r,e.anyTech),a(i,e.building),a(i,e.buildings),a(i,e.structures),a(o,e.anyBuilding),a(o,e.anyBuildings),n.size&&(t.technologies=[...n]),r.size&&(t.anyTechnology=[...r]),i.size&&(t.buildings=[...i]),o.size&&(t.anyBuilding=[...o]),Object.keys(t).length?t:null}function ay(e){return Array.isArray(e)?e.map(t=>{if(!t)return null;const n=t.type||t.kind,r=t.id||t.building||t.technology;if(!n||!r)return null;const i=t.effect||{},o=Number.isFinite(i.inputMultiplier??t.inputMultiplier)?i.inputMultiplier??t.inputMultiplier:1,a=Number.isFinite(i.outputMultiplier??t.outputMultiplier)?i.outputMultiplier??t.outputMultiplier:1,c=Number.isFinite(i.laborMultiplier??t.laborMultiplier)?i.laborMultiplier??t.laborMultiplier:1,l=Number.isFinite(i.timeMultiplier??t.timeMultiplier)?i.timeMultiplier??t.timeMultiplier:1,d=Number.isFinite(i.batchBonus??t.batchBonus)?i.batchBonus??t.batchBonus:0;return{type:String(n),id:String(r),effect:{inputMultiplier:o,outputMultiplier:a,laborMultiplier:c,timeMultiplier:l,batchBonus:d}}}).filter(Boolean):[]}function sy(e={}){const t=e.effect||{},n=Number.isFinite(t.inputMultiplier??e.inputMultiplier)?t.inputMultiplier??e.inputMultiplier:1,r=Number.isFinite(t.outputMultiplier??e.outputMultiplier)?t.outputMultiplier??e.outputMultiplier:1,i=Number.isFinite(t.laborMultiplier??e.laborMultiplier)?t.laborMultiplier??e.laborMultiplier:1,o=Number.isFinite(t.timeMultiplier??e.timeMultiplier)?t.timeMultiplier??e.timeMultiplier:1,a=Number.isFinite(t.batchBonus??e.batchBonus)?t.batchBonus??e.batchBonus:0;return{inputMultiplier:n,outputMultiplier:r,laborMultiplier:i,timeMultiplier:o,batchBonus:a}}function nd(e,t=0){if(!e)return null;const n=e.id||e.mode||e.name||e.building||`mode-${t}`,r=e.type||e.kind||(e.building?"building":"manual"),i=String(r).toLowerCase()==="hand"?"manual":String(r),o=e.label||e.name||(e.building?`${e.building} station`:"Manual Work"),a=Number.isFinite(e.priority)?Number(e.priority):i==="manual"?0:10+t,c=e.description||"",l=e.requires||e.requirement||e.unlock||null;let d=$u(l);const u=e.building||e.structure||e.station||null;if(u){const h=String(u),p=d?{...d}:{},w=new Set(p.buildings||[]);w.add(h),p.buildings=[...w],d=Object.keys(p).length?p:null}const m=sy(e);return{id:String(n),label:o,type:i,buildingId:u?String(u):null,effect:m,requirements:d,priority:a,description:c}}function ly(e){return!Array.isArray(e)||!e.length?[nd({id:"manual",label:"Hand Crafting",type:"manual",effect:{inputMultiplier:1,outputMultiplier:1,laborMultiplier:1,timeMultiplier:1,batchBonus:0},priority:0},0)]:e.map((t,n)=>nd(t,n)).filter(Boolean)}function cy(e){if(!e)return{available:!0,missing:null};if(e.always)return{available:!0,missing:null};const t={technologies:[],anyTechnology:[],buildings:[],anyBuilding:[]};let n=!0;const r=[];if(Array.isArray(e.technologies)&&r.push(...e.technologies),r.length){const c=r.filter(l=>!sn(l));c.length&&(n=!1,t.technologies=[...new Set(c.map(l=>String(l)))])}const i=Array.isArray(e.anyTechnology)?e.anyTechnology:[];i.length&&(i.some(l=>sn(l))||(n=!1,t.anyTechnology=[...new Set(i.map(l=>String(l)))]));const o=[];if(Array.isArray(e.buildings)&&o.push(...e.buildings),o.length){const c=o.filter(l=>!Yi(l));c.length&&(n=!1,t.buildings=[...new Set(c.map(l=>String(l)))])}const a=Array.isArray(e.anyBuilding)?e.anyBuilding:[];return a.length&&(a.some(l=>Yi(l))||(n=!1,t.anyBuilding=[...new Set(a.map(l=>String(l)))])),Object.keys(t).forEach(c=>{Array.isArray(t[c])&&!t[c].length&&delete t[c]}),{available:n,missing:Object.keys(t).length?t:null}}function dy(e,t=null){const n=((e==null?void 0:e.productionModes)||[]).map((c,l)=>{const d=cy(c.requirements);return{...c,index:l,status:d}}),r=n.filter(c=>c.status.available);let i=null;if(t){const c=String(t);i=n.find(l=>l.id===c&&l.status.available)||null}!i&&r.length&&(i=[...r].sort((c,l)=>l.priority===c.priority?c.index-l.index:l.priority-c.priority)[0]);const o=t&&n.find(c=>c.id===String(t))||null,a=i||o||(n.length?n[0]:null);return{modes:n,selected:i,fallback:a}}function uy(e,t,n){const r=String(e.id),i=(e.tools||[]).map(d=>ry(d)),o=iy(e.inputs||{}),a=oi(e.outputs||{}),c=Number.isFinite(e.laborHours)?e.laborHours:Number.isFinite(e.timeHours)?e.timeHours:0,l=Number.isFinite(e.timeHours)?e.timeHours:Number.isFinite(e.laborHours)?e.laborHours:0;return{id:r,name:e.name||r,icon:e.icon||"ðŸ› ï¸",description:e.description||"",category:e.category||t,groupId:t,groupLabel:n,baseInputs:o,baseOutputs:a,inputs:oi(o),outputs:oi(a),laborHours:c,timeHours:l,baseLaborHours:c,baseTimeHours:l,toolsRequired:i.map(d=>d.id),toolDetails:i,unlock:$u(e.unlock),batch:oy(e.batch),efficiencyBonuses:ay(e.efficiency),productionModes:ly(e.production||e.workstations||e.stations)}}function fy(e){const t=[];return(e||[]).forEach(n=>{const r=(n==null?void 0:n.id)||"general",i=(n==null?void 0:n.label)||r;((n==null?void 0:n.recipes)||[]).forEach(o=>{t.push(uy(o,r,i))})}),t}const Ou=fy(zu);function my(e){return Ou.find(t=>t.id===e)||null}function hy(e){const t=e==null?void 0:e.unlock;if(!t)return{unlocked:!1,gated:!1,missing:null};if(t.always)return{unlocked:!0,gated:!1,missing:null};let n=!1,r=!0;const i={technologies:[],anyTechnology:[],buildings:[],anyBuilding:[]},o=Array.isArray(t.technologies)?[...t.technologies]:[];if(o.length){n=!0;const d=o.filter(u=>!sn(u));d.length&&(r=!1,i.technologies=[...new Set(d.map(u=>String(u)))])}const a=Array.isArray(t.anyTechnology)?[...t.anyTechnology]:[];a.length&&(n=!0,a.some(u=>sn(u))||(r=!1,i.anyTechnology=[...new Set(a.map(u=>String(u)))]));const c=Array.isArray(t.buildings)?[...t.buildings]:[];if(c.length){n=!0;const d=c.filter(u=>!Yi(u));d.length&&(r=!1,i.buildings=[...new Set(d.map(u=>String(u)))])}const l=Array.isArray(t.anyBuilding)?[...t.anyBuilding]:[];return l.length&&(n=!0,l.some(u=>Yi(u))||(r=!1,i.anyBuilding=[...new Set(l.map(u=>String(u)))])),Object.keys(i).forEach(d=>{Array.isArray(i[d])&&!i[d].length&&delete i[d]}),n?{unlocked:r,gated:!0,missing:Object.keys(i).length?i:null}:{unlocked:!1,gated:!1,missing:null}}function rd(e,t=0){const n=Number(e);return Number.isFinite(n)?n<=0?0:Math.max(0,Math.trunc(n)):t}const id=["quantity","amount","count","required","qty","value"];function Aa(e,t){const n=oi(e);if(typeof n=="number"){if(n<=0)return 0;const r=n*t;return!Number.isFinite(r)||r<=0?0:Math.ceil(r-1e-9)}if(typeof n=="string")return n;if(Array.isArray(n))return n.map(r=>Aa(r,t));if(n&&typeof n=="object"){const r={...n};let i=null;if(id.forEach(o=>{i===null&&Number.isFinite(n[o])&&(i=Number(n[o]))}),i!==null){const o=i,a=o*t;let c=0;Number.isFinite(a)&&a>0&&(c=Math.ceil(a-1e-9),c<=0&&o>0&&(c=1)),id.forEach(l=>{n[l]!==void 0&&(r[l]=c)})}return r}return n}function py(e,t){if(!e)return{};if(Array.isArray(e))return e.map(r=>Aa(r,t));if(typeof e!="object")return Aa(e,t);const n={};return Object.entries(e).forEach(([r,i])=>{n[r]=Aa(i,t)}),n}const od=["quantity","amount","count","qty","value"];function Na(e,t){const n=oi(e);if(typeof n=="number"){if(n<=0)return 0;const r=n*t;if(!Number.isFinite(r)||r<=0)return 0;const i=Math.round(r);return i<=0?1:i}if(typeof n=="string")return n;if(Array.isArray(n))return n.map(r=>Na(r,t));if(n&&typeof n=="object"){const r={...n};let i=null;if(od.forEach(o=>{i===null&&Number.isFinite(n[o])&&(i=Number(n[o]))}),i!==null){const a=i*t;let c=0;Number.isFinite(a)&&a>0&&(c=Math.round(a),c<=0&&a>0&&(c=1)),od.forEach(l=>{n[l]!==void 0&&(r[l]=c)})}return r}return n}function gy(e,t){if(!e)return{};if(Array.isArray(e))return e.map(r=>Na(r,t));if(typeof e!="object")return Na(e,t);const n={};return Object.entries(e).forEach(([r,i])=>{n[r]=Na(i,t)}),n}function by(e){const t=[];return((e==null?void 0:e.efficiencyBonuses)||[]).forEach(n=>{if(!n)return;const r=String(n.type||"").toLowerCase();r==="technology"?sn(n.id)&&t.push(n):r==="building"?Yi(n.id)&&t.push(n):(sn(n.id)||Yi(n.id))&&t.push(n)}),t}function yy(e,{batchSize:t=null,productionMode:n=null}={}){const r=(e==null?void 0:e.batch)||{defaultSize:1,maxSize:1},i=Math.max(1,Math.floor(r.defaultSize||1)),o=Math.max(i,Math.floor(r.maxSize||i)),a=Number.isFinite(t)?Math.max(1,Math.floor(t)):i,c=by(e);n!=null&&n.effect&&c.push({type:"production",id:n.id,label:n.label,effect:{...n.effect}});const l=c.reduce((T,A)=>{const E=A.effect||{};return Number.isFinite(E.inputMultiplier)&&(T.inputMultiplier*=E.inputMultiplier),Number.isFinite(E.outputMultiplier)&&(T.outputMultiplier*=E.outputMultiplier),Number.isFinite(E.laborMultiplier)&&(T.laborMultiplier*=E.laborMultiplier),Number.isFinite(E.timeMultiplier)&&(T.timeMultiplier*=E.timeMultiplier),Number.isFinite(E.batchBonus)&&(T.batchBonus+=E.batchBonus),T},{inputMultiplier:1,outputMultiplier:1,laborMultiplier:1,timeMultiplier:1,batchBonus:0});let d=Number.isFinite(a+l.batchBonus)?Math.floor(a+l.batchBonus):a;d<=0&&(d=a),d=Math.max(1,Math.min(o,d));const u=d*l.inputMultiplier,m=d*l.outputMultiplier,h=Number.isFinite(e.baseLaborHours)?e.baseLaborHours:e.laborHours||0,p=Number.isFinite(e.baseTimeHours)?e.baseTimeHours:e.timeHours||h,w=h*d*l.laborMultiplier,x=p*d*l.timeMultiplier,C=py(e.baseInputs,u),M=gy(e.baseOutputs,m);return{instance:{...e,inputs:C,outputs:M,laborHours:w,timeHours:x,batchSize:d,appliedBonuses:c,productionMode:n?{id:n.id,label:n.label,type:n.type,buildingId:n.buildingId||null}:null},batchSize:d,requestedBatchSize:a,appliedBonuses:c}}function ca(e,t){if(t==null)return null;const n=e?String(e):"";if(typeof t=="number"){const r=rd(t,0);if(!r)return null;const i=n||"",o=i?[i]:[];return o.length?{label:n||i,options:o,quantity:r}:null}if(typeof t=="string"){const r=String(t);return{label:n||r,options:[r],quantity:1}}if(Array.isArray(t)){const r=t.map(o=>String(o)).filter(Boolean);return r.length?{label:n||r[0],options:r,quantity:1}:null}if(typeof t=="object"){const r=[];Array.isArray(t.options)&&r.push(t.options),Array.isArray(t.anyOf)&&r.push(t.anyOf),Array.isArray(t.choices)&&r.push(t.choices),Array.isArray(t.items)&&r.push(t.items);let i=r.flat().map(c=>String(c)).filter(Boolean);!i.length&&typeof t.name=="string"&&(i=[t.name]),!i.length&&n&&(i=[n]);const o=rd(t.quantity??t.amount??t.count??t.required??t.qty??t.value,1)||1,a=t.label||n||i[0]||"";return i.length?{label:a,options:i,quantity:o}:null}return null}function wy(e){const t=[],n=e==null?void 0:e.inputs;return n?Array.isArray(n)?(n.forEach(r=>{if(r){if(typeof r=="string"){const i=ca(r,r);i&&t.push(i)}else if(Array.isArray(r)){const i=ca("",r);i&&t.push(i)}else if(typeof r=="object"){const i=r.label||r.name||r.id||"",o=ca(i,r);o&&t.push(o)}}}),t):(typeof n=="object"&&Object.entries(n).forEach(([r,i])=>{const o=ca(r,i);o&&t.push(o)}),t):t}function xy(e){const t=wy(e),n=[],r=[];return t.forEach(i=>{const{label:o,options:a,quantity:c}=i,l=a.map(p=>{const w=Fo(p),x=Number.isFinite(w==null?void 0:w.quantity)?w.quantity:0;return{item:p,available:x}}),d=l.reduce((p,w)=>p+w.available,0);let m=Math.min(c,d);const h=[];l.forEach(p=>{if(m<=0||p.available<=0)return;const w=Math.min(p.available,m);w>0&&(h.push({item:p.item,amount:w}),m-=w)}),d<c&&n.push({name:o,required:c,available:d}),r.push({label:o,quantity:c,options:l.map(p=>p.item),usage:h})}),{requirements:t,missingMaterials:n,materialPlan:r}}function vy(e,{availableTools:t=[],batchSize:n=null,productionModeId:r=null}={}){const i=my(e);if(!i)return null;const o=hy(i),{modes:a,selected:c,fallback:l}=dy(i,r),d=a.some(D=>D.status.available),u=c||l||null,{instance:m,batchSize:h,appliedBonuses:p}=yy(i,{batchSize:n,productionMode:u}),w=!!(o.unlocked&&d),x=Math.max(0,Number.isFinite(m.laborHours)?m.laborHours:m.timeHours||0),C=new Set((t||[]).map(D=>String(D).toLowerCase())),T=(m.toolsRequired||[]).filter(D=>!C.has(String(D).toLowerCase())),{missingMaterials:A,materialPlan:E,requirements:R}=xy(m),L=a.map(D=>({id:D.id,label:D.label,type:D.type,buildingId:D.buildingId,effect:D.effect,priority:D.priority,available:D.status.available,missing:D.status.missing})),W=L.filter(D=>!D.available);return{recipe:m,baseRecipe:i,unlocked:w,unlockStatus:o,hasProductionAccess:d,productionMode:m.productionMode,productionModeAvailable:!!c,productionModes:L,missingProduction:W,hasTools:T.length===0,hasMaterials:A.length===0,missingTools:T,missingMaterials:A,materialPlan:E,materialRequirements:R,laborHours:x,batchSize:h,appliedBonuses:p}}function Sy({availableTools:e=[],batchSize:t=null}={}){return Ou.map(n=>vy(n.id,{availableTools:e,batchSize:t})).filter(n=>n&&n.unlocked)}function Il(){S.craftTargets instanceof Map||(Array.isArray(S.craftTargets)?S.craftTargets=new Map(S.craftTargets):S.craftTargets=new Map)}function Ai(e){return String(e||"").trim().toLowerCase()}function Fa(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.max(0,Math.trunc(t))}function wr(e,t){if(!e||!t)return 0;const n=Ai(t);if(!n)return 0;if(typeof e=="string")return Ai(e)===n?1:0;if(Array.isArray(e))return e.reduce((r,i)=>r+wr(i,n),0);if(e instanceof Map){let r=0;return e.forEach((i,o)=>{Ai(o)===n?r+=Fa(i)||0:r+=wr(i,n)}),r}if(typeof e=="object"){const r=e.id??e.name??e.item??e.type??e.slug;if(r&&Ai(r)===n){const i=e.quantity??e.qty??e.count??e.amount??e.number??1,o=Fa(i);return o>0?o:1}return Object.keys(e).reduce((i,o)=>{const a=e[o];return Ai(o)===n&&typeof a!="object"?i+Fa(a):i+wr(a,n)},0)}return 0}function My(e){if(Il(),!e)return 0;const t=String(e);return S.craftTargets.get(t)||0}function ad(e,t){if(!e)return;Il();const n=String(e),r=Fa(t);r?S.craftTargets.set(n,r):S.craftTargets.delete(n),er()}function ky(){return Il(),Array.from(S.craftTargets.entries()).map(([e,t])=>({id:e,target:t}))}function Cy(e){if(!e)return 0;const t=Ai(e);if(!t)return 0;let n=0;return S.people.forEach(r=>{n+=wr(r==null?void 0:r.equipment,t),n+=wr(r==null?void 0:r.equipped,t),n+=wr(r==null?void 0:r.heldItems,t),n+=wr(r==null?void 0:r.held,t),n+=wr(r==null?void 0:r.holding,t)}),n}const ps={fauna:{mapKey:"discoveredFauna",collection:"animals",unknownLabel:"Unidentified creature"},flora:{mapKey:"discoveredFlora",collection:"plants",unknownLabel:"Uncatalogued specimen"}};function Ey(e,t,n){return`${e}:${t}:${Ru(n,{fallback:"entry"})}`}function Ty(e){const t=ps[e];if(!t)return new Map;const n=S[t.mapKey];if(n instanceof Map)return n;const r=new Map;return Array.isArray(n)?n.forEach(i=>{if(!i)return;const[o,a]=i;r.set(o,new Set(a||[]))}):n&&typeof n=="object"&&Object.entries(n).forEach(([i,o])=>{r.set(i,new Set(o||[]))}),S[t.mapKey]=r,r}function Ay(e,t){if(!ps[e])return new Set;const r=Ty(e);r.has(t)||r.set(t,new Set);const i=r.get(t);if(i instanceof Set)return i;const o=new Set(Array.isArray(i)?i:[]);return r.set(t,o),o}function _u(e){const t=ps[e];if(!t)return{sections:[],discovered:0,total:0};const n=Object.entries(bf).map(([i,o])=>{var u;const a=(o==null?void 0:o[t.collection])||[];if(!a.length)return null;const c=Ay(e,i),l=a.map(m=>{const h=Ey(e,i,m.name),p=c.has(h);return{id:h,biomeId:i,discovered:p,item:m}}),d=l.filter(m=>m.discovered).length;return{biomeId:i,biomeName:((u=wn(i))==null?void 0:u.name)||i,entries:l,discoveredCount:d,total:l.length}}).filter(Boolean).sort((i,o)=>i.biomeName.localeCompare(o.biomeName)),r=n.reduce((i,o)=>(i.discovered+=o.discoveredCount,i.total+=o.total,i),{discovered:0,total:0});return{sections:n,discovered:r.discovered,total:r.total}}function Ny(){return _u("fauna")}function Fy(){return _u("flora")}function Pu(e){var t;return((t=ps[e])==null?void 0:t.unknownLabel)||"Unknown entry"}const Du={water:"Water",open:"Open Land",forest:"Forest",ore:"Ore Deposits",stone:"Stone Outcrop"},By="ðŸ§",Ly="player-marker",Ry=4,ai="survey",Iy=[{id:ai,label:"Surveyor",description:"Scout the surrounding wilderness and chart safe paths for settlers."}],ju=22,Ka=.1,Wu=.1,Hl=[{id:"15m",label:"15 min",minutes:15},{id:"30m",label:"30 min",minutes:30},{id:"60m",label:"60 min",minutes:60},{id:"180m",label:"3 hr",minutes:180},{id:"all-day",label:"All Day",minutes:null}];let Ee=null,Ba=null,Kn=null,Jt=null,Mr=null,It=null,gt=null,Yn=null,Wn=null,Ln=null,Bn=null,Bi="all",Kr=null,Zr=null,Jr=null,Qt=null,qn=null,qu=()=>{},Li=()=>{},da=null,Fn=null,ua=null,js=null,Ut=null,Ri=null,Qr=null,ei=null,Ii=null,yt=null,rn=null;const Za=new Map;let La=null,sd=null,et=null,Dr=null,Hi=null,zl=!1,zi=null,Ni=null,fa=null,Fi=null,ma=null,xr=null,ha=null,vr=null,Nn=null,bt=null,en=null,ti=null;const Hy=new Set(["wood","firewood","food","water"]);function zy(e=""){const t=String(e||"").trim().toLowerCase();if(!t)return"a";if(t.startsWith("hour"))return"an";const n=t[0];return["a","e","i","o","u"].includes(n)?"an":"a"}function $y(e=""){return e&&(/[^aeiou]ies$/i.test(e)?e.replace(/ies$/i,"y"):/(xes|ses|zes|ches|shes)$/i.test(e)?e.replace(/es$/i,""):/s$/i.test(e)&&!/ss$/i.test(e)?e.replace(/s$/i,""):e)}function Oy(e=""){const t=String(e||"").trim();if(!t)return"";const n=t.split(/\s+/),r=n.pop(),i=$y(r);return n.push(i),n.join(" ")}function Ws(e,t){const n=Math.max(0,Math.ceil(t||0));if(!n)return null;const r=String(e||"").trim()||"resource";if(n===1){const i=r.toLowerCase();if(Hy.has(i))return`1 more ${r}`;const o=Oy(r);return`${zy(o)} ${o}`}return`${n} more ${r}`}function an(e=[]){const t=e.filter(Boolean);if(!t.length)return"";if(t.length===1)return t[0];if(t.length===2)return`${t[0]} and ${t[1]}`;const n=t.slice(0,-1).join(", "),r=t[t.length-1];return`${n}, and ${r}`}function Sr(e){const t=Number(e);return Number.isFinite(t)?Math.round(t*10)/10:0}function _y(e,t){const n=Number(t);if(!Number.isFinite(n)||n<=0)return null;const r=Sr(n),i=zo(e),o=i!=null&&i.icon?`${i.icon} ${e}`:e;return`${r} ${o}`}function Py(e={}){const t=[{key:"large",label:"large"},{key:"medium",label:"medium"},{key:"small",label:"small"}],n=[];let r=0;return t.forEach(({key:i,label:o})=>{const a=Number(e==null?void 0:e[i])||0;if(!a)return;r+=a;const c=a===1?"tree":"trees";n.push(`${a} ${o} ${c}`)}),r?`Standing timber includes ${an(n)}.`:"Only stumps and brush remain; the grove has been cleared."}function Dy(e={}){const t=Array.isArray(e.deposits)?e.deposits.filter(r=>((r==null?void 0:r.quantity)||0)>0):[];if(t.length){const r=t.map(i=>`${i.quantity} ${i.type}`);return`Veins promise ${an(r)}.`}const n=Number(e.stone)||0;return n>0?`Loose stone remains in workable supply (${Sr(n)} blocks).`:"The exposed rock has already been stripped of useful ore."}function jy(e={}){const t=Object.entries(e).filter(([,i])=>Number(i)>0);if(!t.length)return"";const n=t.map(([i,o])=>_y(i,o)).filter(Boolean),r=an(n);return r?`Set aside nearby: ${r}.`:""}function Wy(e,t){const n=String(e).toLowerCase(),r={lead:"",extras:[]};switch(n){case"forest":r.lead="is a patch of forest canopy",r.extras.push(Py(t==null?void 0:t.trees));break;case"ore":r.lead="sits atop an exposed ore seam",r.extras.push(Dy(t));break;case"stone":r.lead="is a bare stone outcrop",Number(t==null?void 0:t.stone)>0&&r.extras.push(`Chiseled rubble amounts to ${Sr(t.stone)} blocks.`);break;case"water":case"lake":r.lead="rests beside a still lake with fresh water.";break;case"ocean":r.lead="opens onto a tidal shoreline with crashing surf.";break;case"river":r.lead="is cut by a flowing river ripe for fishing and power.";break;case"marsh":r.lead="is saturated marshland thick with reeds.";break;case"mangrove":r.lead="winds through tangled mangrove roots and tidal pools.";break;default:r.lead="is mostly open ground ready for work";break}return r.extras=r.extras.filter(Boolean),r}function Uu(e){var t;return e?(Nn||(Nn=document.createElement("section"),Nn.id="tile-info-panel",Object.assign(Nn.style,{display:"flex",flexDirection:"column",gap:"8px",border:"1px solid var(--map-border, #ccc)",borderRadius:"12px",padding:"16px",background:"var(--bg-color, #fff)",gridColumn:"1 / -1",minWidth:"0"}),bt=document.createElement("div"),bt.className="tile-info-content",Object.assign(bt.style,{display:"flex",flexDirection:"column",gap:"8px"}),Nn.appendChild(bt)),Nn.parentElement!==e&&((t=Nn.parentElement)==null||t.removeChild(Nn),e.appendChild(Nn)),Nn):null}function qy(e){var t;if(!e)return null;if(!en){en=document.createElement("section"),en.id="research-panel",Object.assign(en.style,{display:"flex",flexDirection:"column",gap:"10px",border:"1px solid var(--map-border, #ccc)",borderRadius:"12px",padding:"16px",background:"var(--bg-color, #fff)",minWidth:"0"});const n=document.createElement("h3");n.textContent="Research & Technologies",n.style.margin="0",en.appendChild(n);const r=document.createElement("p");r.textContent="Monitor discoveries, required prerequisites, and the benefits unlocked for your settlement.",r.style.margin="0",r.style.fontSize="13px",r.style.opacity="0.85",en.appendChild(r),ti=document.createElement("div"),Object.assign(ti.style,{display:"flex",flexDirection:"column",gap:"10px"}),en.appendChild(ti)}return en.parentElement!==e&&((t=en.parentElement)==null||t.removeChild(en),e.appendChild(en)),en}function Uy(){if(!ti)return;ti.innerHTML="";const e=Vm();if(!e.length){const t=document.createElement("p");t.textContent="No technologies have been catalogued yet. Advance your settlement to discover new research.",t.style.margin="0",ti.appendChild(t);return}e.forEach(t=>{var C,M,T,A,E,R;const{definition:n,state:r,unlocked:i,available:o,missingPrerequisites:a}=t,c=document.createElement("article");Object.assign(c.style,{border:"1px solid var(--map-border, #ccc)",borderRadius:"10px",padding:"12px",background:"var(--menu-bg)",color:"var(--text-color)",display:"flex",flexDirection:"column",gap:"6px"});const l=document.createElement("div");Object.assign(l.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"8px",flexWrap:"wrap"});const d=document.createElement("h4");if(d.textContent=(n==null?void 0:n.name)||Ue(t.id),d.style.margin="0",l.appendChild(d),n!=null&&n.category){const L=document.createElement("span");L.textContent=n.category,Object.assign(L.style,{fontSize:"12px",padding:"2px 6px",borderRadius:"999px",background:"rgba(128, 128, 128, 0.15)"}),l.appendChild(L)}let u="Locked",m="rgba(160, 40, 40, 0.85)";i?(u="Researched",m="rgba(36, 115, 72, 0.85)"):o?(u="Available to research",m="rgba(196, 132, 16, 0.85)"):a.length&&(u="Locked â€” prerequisites missing",m="rgba(160, 40, 40, 0.85)");const h=document.createElement("span");if(h.textContent=u,Object.assign(h.style,{fontSize:"12px",padding:"2px 8px",borderRadius:"999px",color:"#fff",background:m}),l.appendChild(h),c.appendChild(l),n!=null&&n.description){const L=document.createElement("p");L.textContent=n.description,L.style.margin="0",c.appendChild(L)}const p=t.prerequisites.length?t.prerequisites.map(L=>{const W=za(L);return a.includes(L)?`${W} (missing)`:`${W}`}):["None"];if(c.appendChild(mt("Prerequisites",p.join(", "))),!i&&a.length&&c.appendChild(mt("Missing",Gi(a))),n!=null&&n.cost){const L=[];Number.isFinite(n.cost.research)&&n.cost.research>0&&L.push(`${n.cost.research} research points`);const W=Object.entries(n.cost.materials||{}).filter(([,D])=>Number.isFinite(D)&&D>0).map(([D,V])=>`${V} ${hs(D)||Ue(D)}`);W.length&&L.push(`Materials: ${W.join(", ")}`),L.length&&c.appendChild(mt("Cost",L.join(" â€¢ ")))}const w=[],x=((C=n==null?void 0:n.effects)==null?void 0:C.unlocks)||{};if((M=x.technologies)!=null&&M.length&&w.push(`Technologies: ${Gi(x.technologies)}`),(T=x.buildings)!=null&&T.length){const L=x.buildings.map(W=>{var D;return((D=Gt(W))==null?void 0:D.name)||Ue(W)});w.push(`Buildings: ${bn(L)}`)}if((A=x.recipes)!=null&&A.length){const L=x.recipes.map(W=>b0(W));w.push(`Recipes: ${bn(L)}`)}if((E=x.equipment)!=null&&E.length){const L=x.equipment.map(W=>{var D;return((D=rs(W))==null?void 0:D.label)||Ue(W)});w.push(`Equipment: ${bn(L)}`)}if((R=n==null?void 0:n.effects)!=null&&R.description&&w.unshift(n.effects.description),w.length&&c.appendChild(mt("Unlocks",w.join("; "))),r!=null&&r.unlockedAt){const L=new Date(r.unlockedAt),W=Number.isFinite(L.getTime())?L.toLocaleString():r.unlockedAt;c.appendChild(mt("Unlocked",i?W:"Not yet researched"))}ti.appendChild(c)})}function Yy(e,t,n){if(!e)return!1;const r=e.tile;return r&&Number.isFinite(r.x)&&Number.isFinite(r.y)?Math.trunc(r.x)===Math.trunc(t)&&Math.trunc(r.y)===Math.trunc(n):!r&&Math.trunc(t)===0&&Math.trunc(n)===0}function Gy(e){var C,M;const t=Gt(e.typeId),n=document.createElement("details");n.style.borderTop="1px solid rgba(128, 128, 128, 0.25)",n.style.paddingTop="6px";const r=document.createElement("summary");r.style.fontWeight="600";const i=t!=null&&t.icon?`${t.icon} `:"",o=(t==null?void 0:t.name)||e.typeId,a=Number(e.totalLaborHours)||0,c=Math.min(a,Number(e.progressHours)||0),l=a?Math.round(c/a*100):0;r.textContent=`${i}${o} â€” ${l}% complete`,n.appendChild(r);const d=document.createElement("div");Object.assign(d.style,{display:"flex",flexDirection:"column",gap:"6px",marginTop:"6px"});const u=e.assignedWorkers===1?"builder":"builders",m=document.createElement("p");m.style.margin="0",m.textContent=`Labor recorded: ${Sr(c)} / ${Sr(a)} worker-hours with ${e.assignedWorkers} ${u} assigned.`,d.appendChild(m);const h=e.requiredResources||{},p=e.consumedResources||{},w=Object.keys(h);if(w.length){const T=document.createElement("p");T.style.margin="0",T.textContent="Materials drawn so far:",d.appendChild(T);const A=document.createElement("ul");A.style.margin="0",A.style.paddingLeft="20px",w.forEach(E=>{const R=Number(h[E])||0,L=Math.min(R,Number(p[E])||0),W=Math.max(0,R-L),D=zo(E),V=D!=null&&D.icon?`${D.icon} `:"",P=document.createElement("li");P.textContent=`${V}${E}: ${Sr(L)} / ${Sr(R)}${W>0?` (${Sr(W)} remaining)`:""}`,A.appendChild(P)}),d.appendChild(A)}else{const T=document.createElement("p");T.style.margin="0",T.textContent="No material stockpiles are required for this project.",d.appendChild(T)}const x=e.siteCategory||((M=(C=t==null?void 0:t.stats)==null?void 0:C.site)==null?void 0:M.primaryCategory);if(x||e.siteSurfaceArea){const T=document.createElement("p");T.style.margin="0";const A=x?$l(x):"Site",E=e.siteSurfaceArea?`${Ao(e.siteSurfaceArea)} footprint`:"Flexible footprint";T.textContent=`${A}: ${E}.`,d.appendChild(T)}return n.appendChild(d),n}function Yu(e){if(!e)return"";const t=Gt(e.typeId),n=t!=null&&t.icon?`${t.icon} `:"",r=(t==null?void 0:t.name)||Ue(e.typeId);return`${n}${r}`.trim()}function Vy(e){if(!e)return[];const t=new Map;return Jn().forEach(n=>{if(!n||n.locationId!==e)return;const r=n.tile;if(!r||!Number.isFinite(r.x)||!Number.isFinite(r.y))return;const i=Math.trunc(r.x),o=Math.trunc(r.y),a=`${i}:${o}`;t.has(a)||t.set(a,{x:i,y:o,completed:[],underway:[],planned:[]});const c=t.get(a),l=Yu(n),d=(n.status||"").toLowerCase();d==="completed"?c.completed.push(l):d==="under-construction"?c.underway.push(l):c.planned.push({name:l,status:d})}),[...t.values()].map(n=>{const r=[];if(n.completed.length){const l=n.completed.length>1?"Completed structures":"Completed structure";r.push(`${l}: ${an(n.completed)}`)}if(n.underway.length){const l=(n.underway.length>1,"Under construction");r.push(`${l}: ${an(n.underway)}`)}if(n.planned.length){const l=n.planned.map(d=>d.status&&d.status!=="planned"?`${d.name} (${Ue(d.status)})`:d.name);r.push(`Planned: ${an(l)}`)}const i=n.underway.length?n.completed.length?"mixed":"under-construction":n.completed.length?"completed":n.planned.length?"planned":"noted",o=[...n.completed,...n.underway,...n.planned.map(l=>l.name)],a=o[0]||"Development",c=r.join(" â€¢ ")||a;return{x:n.x,y:n.y,status:i,structures:o,label:a,details:c,count:o.length}})}function Gu(){if(!Ee||typeof Ee.setDevelopments!="function")return;const e=Dt();if(!e){Ee.setDevelopments([]);return}Ee.setDevelopments(Vy(e.id))}function Ra(){var w;if(!bt){const x=document.getElementById("game");x&&Uu(x)}if(!bt)return;bt.replaceChildren();const e=Dt();if(!e){const x=document.createElement("p");x.textContent="No survey site is currently active.",bt.appendChild(x);return}const t=Pt(e.id),n=Math.trunc(t.x||0),r=Math.trunc(t.y||0),i=jb(e.id,n,r)||{},o=Ja(e,n,r)||i.type||"open",a=Wy(o,i),c=document.createElement("p");let l=`The survey tile at (${n}, ${r}) ${a.lead}.`;(w=a.extras)!=null&&w.length&&(l+=` ${a.extras.join(" ")}`),c.textContent=l,bt.appendChild(c);const d=jy(i.stockpiles);if(d){const x=document.createElement("p");x.textContent=d,bt.appendChild(x)}const u=ty(o);if(u.length){const x=[...new Set(u.map(M=>M.encounterName||M.resource).filter(Boolean))];if(x.length){const M=document.createElement("p");M.textContent=`Foragers expect to find ${an(x)} here.`,bt.appendChild(M)}const C=new Set;if(u.forEach(M=>{Array.isArray(M.toolsRequired)&&M.toolsRequired.forEach(T=>C.add(T))}),C.size){const M=document.createElement("p");M.style.margin="0",M.style.fontStyle="italic",M.textContent=`Some finds will require ${an([...C])}.`,bt.appendChild(M)}}else{const x=document.createElement("p");x.textContent="Little of value grows here to gather right now.",bt.appendChild(x)}const m=Jn().filter(x=>x.locationId===e.id&&Yy(x,n,r)),h=m.filter(x=>x.status==="completed"),p=m.filter(x=>x.status==="under-construction");if(!m.length){const x=document.createElement("p");x.textContent="No structures have been recorded on this tile yet.",bt.appendChild(x);return}if(h.length){const x=h.map(M=>Yu(M)),C=document.createElement("p");C.textContent=`Completed structures: ${an(x)}.`,bt.appendChild(C)}if(p.length){const x=document.createElement("p");x.textContent="Construction underway:",bt.appendChild(x),p.forEach(C=>{bt.appendChild(Gy(C))})}}function Ci(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0":t>=10?`${Math.round(t)}`:`${Math.round(t*10)/10}`}function Ao(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0 mÂ²":t>=100?`${Math.round(t)} mÂ²`:`${Math.round(t*10)/10} mÂ²`}function $l(e){const t=String(e||"").toLowerCase();switch(t){case"forest":return"Forest understory";case"cleared":return"Cleared ground";default:return t?df(t):"Site"}}function Xy(e={},t=null){var m,h,p,w;const n=document.createElement("span");if(!e||!((m=e.categories)!=null&&m.length))return n.textContent="Flexible site",n;const r=(t==null?void 0:t.selected)||((h=t==null?void 0:t.categories)==null?void 0:h.find(x=>x.category===e.primaryCategory))||{category:e.primaryCategory,remaining:0},i=$l((r==null?void 0:r.category)||e.primaryCategory),o=Ao(e.surfaceArea),a=document.createElement("span");let c=`${i} site â€“ needs ${o}`;if(r&&Number.isFinite(r.remaining)){const x=Math.max(0,r.remaining);c+=` (approx. ${Ao(x)} open)`}a.textContent=c,n.appendChild(a);const l=[];(p=e.dimensions)!=null&&p.width&&((w=e.dimensions)!=null&&w.depth)&&l.push(`Structure ${Ci(e.dimensions.width)}Ã—${Ci(e.dimensions.depth)} m`);const d=e.accessClearance||{},u=[];if(d.front&&u.push(`front ${Ci(d.front)} m`),d.back&&u.push(`rear ${Ci(d.back)} m`),d.left&&u.push(`left ${Ci(d.left)} m`),d.right&&u.push(`right ${Ci(d.right)} m`),u.length&&l.push(`Access clearance: ${u.join(", ")}`),l.length){n.appendChild(document.createElement("br"));const x=document.createElement("span");x.textContent=l.join(" â€¢ "),x.style.display="block",x.style.marginTop="2px",n.appendChild(x)}return n}function Vu(e){e&&(e.style.width="100%",e.style.borderCollapse="collapse",e.style.marginTop="6px",e.style.fontSize="13px",e.querySelectorAll("th").forEach(t=>{t.style.textAlign="left",t.style.padding="6px 8px",t.style.borderBottom="1px solid var(--map-border, #ccc)",t.style.position="sticky",t.style.top="0",t.style.background="var(--menu-bg)",t.style.zIndex="1"}),e.querySelectorAll("td").forEach(t=>{t.style.padding="6px 8px",t.style.borderBottom="1px solid rgba(128, 128, 128, 0.25)",t.style.verticalAlign="top"}))}function Ky(){qu()}function Zy(){Li()}function Dt(){return Vi()[0]||null}function ll(e){return e?Du[e]||e:"Uncharted ground"}function Jy(e=""){const t=String(e||"").trim();return t?/ies$/i.test(t)?t.replace(/ies$/i,"y"):/ers$/i.test(t)?t.replace(/ers$/i,"er"):/s$/i.test(t)&&!/ss$/i.test(t)?t.replace(/s$/i,""):t:"Generalist"}function Xu(){const e=[],t=new Set;return Iy.forEach(n=>{if(!n)return;const r=n.id||ai;t.has(r)||(t.add(r),e.push({id:r,label:n.label,description:n.description||""}))}),Vd().filter(Boolean).forEach(n=>{const r=n.id||"";!r||t.has(r)||(t.add(r),e.push({id:r,label:Jy(n.label||r),description:n.description||""}))}),e.length||e.push({id:ai,label:"Surveyor",description:"Scout the surroundings."}),e}function Qy(e){const t=Xu();return t.find(n=>n.id===e)||t[0]||null}function Ku(e){var n;if(!e||typeof e!="object")return ai;(typeof e.jobId!="string"||!e.jobId)&&(e.jobId=ai);const t=Xu();return t.some(r=>r.id===e.jobId)||(e.jobId=((n=t[0])==null?void 0:n.id)||ai),e.jobId}function Pt(e=null){return(!S.player||typeof S.player!="object")&&(S.player={locationId:e??null,x:0,y:0,jobId:ai}),(e&&S.player.locationId!==e||!S.player.locationId&&e)&&(S.player.locationId=e),Number.isFinite(S.player.x)||(S.player.x=0),Number.isFinite(S.player.y)||(S.player.y=0),S.player.x=Math.trunc(S.player.x),S.player.y=Math.trunc(S.player.y),Ku(S.player),S.player}function Ol(e,t={}){var w,x,C;const n=e||Dt(),r=n==null?void 0:n.map,i=Number.isFinite(r==null?void 0:r.xStart)?Math.trunc(r.xStart):0,o=Number.isFinite(r==null?void 0:r.yStart)?Math.trunc(r.yStart):0,a=Math.max(1,Math.trunc((r==null?void 0:r.width)||((x=(w=r==null?void 0:r.tiles)==null?void 0:w[0])==null?void 0:x.length)||1)),c=Math.max(1,Math.trunc((r==null?void 0:r.height)||((C=r==null?void 0:r.tiles)==null?void 0:C.length)||1)),l=i,d=o,u=l+a-1,m=d+c-1,h=Number.isFinite(t.x)?Math.trunc(t.x):l,p=Number.isFinite(t.y)?Math.trunc(t.y):d;return{x:Math.min(u,Math.max(l,h)),y:Math.min(m,Math.max(d,p))}}function Ja(e,t,n){var l;if(!((l=e==null?void 0:e.map)!=null&&l.types))return null;const r=Number.isFinite(e.map.xStart)?Math.trunc(e.map.xStart):0,i=Number.isFinite(e.map.yStart)?Math.trunc(e.map.yStart):0,o=Math.trunc(t)-r,a=Math.trunc(n)-i;if(a<0||o<0)return null;const c=e.map.types[a];return!c||o>=c.length?null:c[o]}function e0(){const e=Dt();if(!e)return null;const t=Pt(e.id);return Ja(e,t.x,t.y)}function cl(e){var t;if(!e)return null;if(!Ut){Ut=document.createElement("section"),Ut.id="player-panel",Object.assign(Ut.style,{display:"flex",flexDirection:"column",gap:"6px",border:"1px solid var(--map-border, #ccc)",borderRadius:"12px",padding:"12px",background:"var(--bg-color, #fff)"});const n=document.createElement("h4");n.textContent="Explorer Position",n.style.margin="0",Ut.appendChild(n),Qr=document.createElement("p"),Qr.style.margin="0",Ut.appendChild(Qr),ei=document.createElement("p"),ei.style.margin="0",Ut.appendChild(ei)}return Ut.parentElement!==e&&((t=Ut.parentElement)==null||t.removeChild(Ut),e.appendChild(Ut)),Ut}function ld(){yt!=null&&yt.parentElement&&yt.parentElement.removeChild(yt),yt=null,Ii=null,rn=null,Za.clear()}function Zu(){var t,n,r;const e=((t=Ee==null?void 0:Ee.elements)==null?void 0:t.controlDetails)||((n=Ee==null?void 0:Ee.elements)==null?void 0:n.actionPanel)||((r=Ee==null?void 0:Ee.elements)==null?void 0:r.controls)||null;if(!e){yt&&ld();return}if(yt&&!yt.isConnected&&ld(),!yt){yt=document.createElement("div"),Object.assign(yt.style,{display:"flex",flexDirection:"column",gap:"10px",padding:"12px 14px",borderRadius:"14px",border:"1px solid var(--map-border, rgba(104, 132, 194, 0.75))",background:"var(--map-control-surface, linear-gradient(135deg, rgba(16, 28, 62, 0.95), rgba(12, 22, 46, 0.92)))",boxShadow:"0 10px 24px rgba(0, 0, 0, 0.35)",alignItems:"stretch",width:"100%",boxSizing:"border-box"});const i=document.createElement("h5");i.textContent="Time lapse",i.style.margin="0",i.style.fontSize="0.95rem",i.style.fontWeight="600",i.style.letterSpacing="0.08em",i.style.textTransform="uppercase",i.style.color="var(--map-control-text, #f4f7ff)",yt.appendChild(i),Ii=document.createElement("div"),Object.assign(Ii.style,{display:"flex",flexDirection:"column",gap:"8px"}),yt.appendChild(Ii),Za.clear(),Hl.forEach(o=>{const a=document.createElement("button");a.type="button",a.textContent=o.label,a.dataset.timeOptionId=o.id,Object.assign(a.style,{borderRadius:"12px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.8))",padding:"10px 14px",background:"var(--map-select-bg, linear-gradient(135deg, rgba(22, 40, 82, 0.98), rgba(17, 31, 60, 0.95)))",color:"var(--map-select-text, #f5f8ff)",cursor:"pointer",boxShadow:"0 6px 16px rgba(0, 0, 0, 0.35)",fontSize:"0.95rem",fontWeight:"600",letterSpacing:"0.04em",textTransform:"uppercase",width:"100%"}),a.addEventListener("click",()=>{r0(o.id)}),Ii.appendChild(a),Za.set(o.id,a)}),rn=document.createElement("button"),rn.type="button",rn.textContent="Sleep",Object.assign(rn.style,{borderRadius:"12px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.8))",padding:"10px 14px",background:"var(--map-select-bg, linear-gradient(135deg, rgba(22, 40, 82, 0.98), rgba(17, 31, 60, 0.95)))",color:"var(--map-select-text, #f5f8ff)",cursor:"pointer",fontWeight:"600",letterSpacing:"0.04em",textTransform:"uppercase",boxShadow:"0 6px 16px rgba(0, 0, 0, 0.35)",fontSize:"0.95rem",alignSelf:"stretch",width:"100%"}),rn.addEventListener("click",i0),yt.appendChild(rn)}yt.parentElement!==e&&e.appendChild(yt)}function t0(){const e=ss();return{options:e.assignments.map(n=>({id:n.id,label:n.label,assigned:n.assigned,capacity:Math.max(0,e.adults-(e.assigned-n.assigned)),description:n.description,workdayHours:n.workdayHours})),laborers:e.laborer}}function _l(){if(!Ee||typeof Ee.setJobOptions!="function")return;const{options:e,laborers:t}=t0(),n=typeof Ee.getSelectedJob=="function"?Ee.getSelectedJob():null;Ee.setJobOptions(e,{selectedId:n,laborers:t})}function n0(e){e&&(La=e)}function Qa(){if(!Ee||typeof Ee.setMarkers!="function")return;const e=Dt();if(!e){Ee.setMarkers([]);return}const t=Pt(e.id),n=Ol(e,t);t.x=n.x,t.y=n.y,t.locationId!==e.id&&(t.locationId=e.id),Ee.setMarkers([{id:Ly,x:t.x,y:t.y,icon:By,className:"map-marker--player",label:"Explorer position",emphasis:!1}])}function Ia(){if(Ri&&cl(Ri),Zu(),_l(),!Ut)return;const e=Dt(),t=e?Pt(e.id):Pt(),n=xn();if(!e){Qr&&(Qr.textContent="No active expedition."),ei&&(ei.textContent=""),cd(n,{hasLocation:!1});return}const r=Ol(e,t);t.x=r.x,t.y=r.y,Qr&&(Qr.textContent=`Position: (${t.x}, ${t.y})`);const i=e0(),o=ll(i);ei&&(ei.textContent=`Terrain: ${o} â€” ${n.season}, ${n.weather}`),Ku(t),cd(n,{hasLocation:!0})}function cd(e,{hasLocation:t=!0}={}){if(Zu(),!Ii)return;const n=Number.isFinite(e==null?void 0:e.hour)?Number(e.hour):0,r=Math.max(0,n*60),i=ju*60,o=Math.max(0,i-r),a=Math.round(Wu*100),c=n>=20;if(Hl.forEach(l=>{const d=Za.get(l.id);if(!d)return;const u=l.minutes??o,m=l.minutes!=null?l.minutes*(1-Ka):o*(1-Ka),h=t&&o>=m&&u>.5;if(d.disabled=!h,h)if(l.id==="all-day"){const p=(r+u)/60;d.title=`Work until around ${Qn(p)} with Â±${a}% variance.`}else d.title=`Advance roughly ${es(u/60)} (Â±${a}%).`;else t?d.title="Not enough daylight remains.":d.title="Time lapse unavailable without an active expedition."}),rn){const l=t&&(c||o<=0);rn.disabled=!l,t?l?rn.title="Turn in for the night and wake at dawn.":rn.title="Night has not yet fallen.":rn.title="Sleep is unavailable without an active expedition."}}function r0(e){const t=Hl.find(R=>R.id===e);if(!t)return;const n=Dt();if(!n){yn("An active expedition is required before committing time.");return}const r=Pt(n.id),i=Qy(r.jobId),o=xn(),a=Number.isFinite(o==null?void 0:o.hour)?Number(o.hour):0,c=Math.max(0,a*60),l=ju*60,d=Math.max(0,l-c),u=t.minutes??d;if(u<=0){yn("No daylight remains to act upon.");return}const m=t.minutes!=null?t.minutes*(1-Ka):d*(1-Ka);if(d<m){yn("Not enough daylight remains for that plan.");return}const h=1+(Math.random()*2-1)*Wu,p=Math.max(1,u*h),w=o.hour;eu(p/60);const x=xn();er();const C=es(p/60),M=es(u/60),T=Qn(w),A=Qn(x.hour),E=i!=null&&i.label?`${i.label.toLowerCase()} duties`:"daily tasks";yn(`Worked on ${E} from ${T} for about ${C} (planned ${M}). Wrapped near ${A}.`),$o()}function i0(){if(!Dt()){yn("An active expedition is required before settling in to sleep.");return}const t=xn(),n=Number.isFinite(t==null?void 0:t.hour)?Number(t.hour):0;if(n<20){yn("It is too early to sleep; daylight remains to be spent.");return}const r=Qn(n);Qd(),tu(),er();const i=xn(),o=Qn(i.hour);yn(`The settlement rests from ${r} and greets the dawn at ${o}.`),$o()}function wo(e={}){if(!Ee||typeof Ee.setFocus!="function")return;const t=Dt(),n=t?Pt(t.id):Pt();Ee.setFocus({x:n.x,y:n.y},e)}function o0({dx:e=0,dy:t=0,recenter:n=!1}={}){const r=Dt();if(!r)return;const i=Pt(r.id);if(n){wo();return}if(!e&&!t)return;const o=Ol(r,{x:i.x+e,y:i.y+t});if(o.x===i.x&&o.y===i.y){yn("The survey does not extend further in that direction."),wo();return}const a=Ja(r,i.x,i.y)||"open",c=Ja(r,o.x,o.y)||a,l=Math.hypot(o.x-i.x,o.y-i.y)*Wi,d=qd("swimming"),u=Vb({fromTerrain:a,toTerrain:c,distance:l,swimmingLevel:d});if(u.blocked){const C=u.reason||Qc(c);yn(`Unable to cross the ${ll(c).toLowerCase()}. ${C}`);return}i.x=o.x,i.y=o.y,i.locationId=r.id;const m=Math.max(u.hours,.02),h=d0(l),p=es(m),w=ll(c),x=u.reason||Qc(c);eu(m),wo(),Qa(),er(),$o(),yn(`Traveled ${h} into the ${w.toLowerCase()} in ${p}. ${x}`.trim())}function Ju(){if(gt||(gt=document.createElement("div"),gt.id="time-banner",gt.setAttribute("role","status"),gt.setAttribute("aria-live","polite")),!gt.parentElement){const e=document.getElementById("content");if(e){const t=document.getElementById("game");t&&e.contains(t)?e.insertBefore(gt,t):e.appendChild(gt)}}return Yn||(Yn=document.createElement("div"),Yn.className="time-chip-group"),Yn.parentElement!==gt&&(Yn.parentElement&&Yn.parentElement.removeChild(Yn),gt.insertBefore(Yn,gt.firstChild)),Wn||(Wn=document.createElement("div"),Wn.className="time-actions"),Wn.parentElement!==gt&&(Wn.parentElement&&Wn.parentElement.removeChild(Wn),gt.appendChild(Wn)),Fb(Wn),gt}function Qu(){if(!Jt){Jt=document.createElement("section"),Jt.id="event-log-panel",Jt.setAttribute("aria-live","polite"),Object.assign(Jt.style,{display:"flex",flexDirection:"column",gap:"8px",padding:"12px 16px",background:"var(--menu-bg)",border:"1px solid var(--map-border)",borderRadius:"12px",gridColumn:"1 / -1",minWidth:"0"});const t=document.createElement("div");Object.assign(t.style,{display:"flex",justifyContent:"flex-end",marginBottom:"8px"}),It=document.createElement("button"),It.type="button",It.textContent="Open Full Log",Object.assign(It.style,{borderRadius:"8px",border:"1px solid var(--map-border)",background:"var(--action-button-bg)",color:"var(--action-button-text)",padding:"6px 12px",cursor:"pointer",boxShadow:"var(--action-button-shadow)",alignSelf:"flex-start"}),It.disabled=!0,It.addEventListener("click",()=>{uf()}),t.appendChild(It),Jt.appendChild(t),Mr=document.createElement("ul"),Mr.id="event-log-summary-list",Object.assign(Mr.style,{listStyle:"none",padding:"0",margin:"0",display:"flex",flexDirection:"column",gap:"6px"}),Jt.appendChild(Mr)}const e=document.getElementById("content");if(e){const t=document.getElementById("game");let n=null;gt&&gt.parentElement===e?n=gt:t&&e.contains(t)&&(n=t),n?e.insertBefore(Jt,n):(Jt.parentElement!==e||e.firstChild!==Jt)&&e.insertBefore(Jt,e.firstChild)}return Jt}function Xi(e,t){const n=document.createElement("div");n.id=e,n.setAttribute("role","dialog"),n.setAttribute("aria-modal","true"),n.setAttribute("aria-labelledby",`${e}-title`),Object.assign(n.style,{position:"fixed",inset:"0",display:"none",alignItems:"center",justifyContent:"center",padding:"24px",background:"rgba(0, 0, 0, 0.65)",zIndex:"2000"});const r=document.createElement("div");r.tabIndex=-1,Object.assign(r.style,{background:"var(--bg-color)",color:"var(--text-color)",borderRadius:"12px",padding:"20px",maxWidth:"min(600px, 92vw)",width:"100%",maxHeight:"min(640px, 90vh)",overflow:"hidden",boxShadow:"0 24px 48px rgba(0, 0, 0, 0.35)"});const i=document.createElement("div");Object.assign(i.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"16px"});const o=document.createElement("h3");o.id=`${e}-title`,o.textContent=t,o.style.margin="0",i.appendChild(o);const a=document.createElement("button");a.type="button",a.textContent="Close",a.style.alignSelf="flex-start",i.appendChild(a),r.appendChild(i);const c=document.createElement("div");Object.assign(c.style,{marginTop:"12px",overflowY:"auto",maxHeight:"calc(90vh - 160px)"}),r.appendChild(c);const l=()=>{n.style.display="none",n.setAttribute("aria-hidden","true"),document.removeEventListener("keydown",u)},d=()=>{n.style.display="flex",n.setAttribute("aria-hidden","false"),document.addEventListener("keydown",u),typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(()=>r.focus()):setTimeout(()=>r.focus(),0)},u=m=>{m.key==="Escape"&&(m.preventDefault(),l())};return a.addEventListener("click",()=>{l()}),n.addEventListener("click",m=>{m.target===n&&l()}),n.appendChild(r),document.body.appendChild(n),{overlay:n,panel:r,content:c,openDialog:d,closeDialog:l}}function ef(){return zi||(zi=Xi("jobs-dialog","Assign Jobs"),Ni=zi.content),zi}function dl(){const e=ef();if(!Ni||!e)return;const t=ss();Ni.innerHTML="";const n=document.createElement("p");n.textContent=`Adults ready to work: ${t.adults}. Unassigned laborers: ${t.laborer}.`,Ni.appendChild(n);const r=document.createElement("p");r.textContent="Assign settlers to focused duties. Laborers without assignments will handle general chores. Hover or long-press a job to view details.",r.style.fontSize="13px",r.style.opacity="0.82",r.style.marginTop="4px",Ni.appendChild(r);const i=document.createElement("div");if(Object.assign(i.style,{display:"flex",flexDirection:"column",gap:"6px",marginTop:"12px"}),i.setAttribute("role","list"),Ni.appendChild(i),t.assignments.forEach(o=>{const a=Math.max(0,t.adults-(t.assigned-o.assigned)),c=document.createElement("div");c.dataset.jobId=o.id,c.setAttribute("role","listitem"),Object.assign(c.style,{display:"grid",gridTemplateColumns:"1fr auto auto auto",alignItems:"center",gap:"8px",padding:"8px 12px",borderRadius:"10px",border:"1px solid var(--map-border, #ccc)",background:"var(--menu-bg)",color:"var(--text-color)"});const l=[];if(o.description&&l.push(o.description),l.push(`Assigned ${o.assigned} of ${a}`),Array.isArray(o.roster)&&o.roster.length){const O=o.roster.map(s=>s.name).join(", ");l.push(`Assigned settlers: ${O}`)}l.push(`Unassigned laborers: ${t.laborer}`),l.push(`Workday: ${o.workdayHours} hours`);const d=l.join(`
`);c.title=d,c.setAttribute("aria-label",`${o.label}. ${l.join(". ")}`);const u=document.createElement("span");u.textContent=o.label,u.style.fontWeight="600",u.style.whiteSpace="nowrap",u.style.overflow="hidden",u.style.textOverflow="ellipsis",c.appendChild(u);const m=document.createElement("div");Object.assign(m.style,{display:"flex",alignItems:"center",gap:"4px",justifySelf:"center"});const h=document.createElement("span");h.textContent="â°",h.setAttribute("aria-hidden","true"),m.appendChild(h);const p=document.createElement("span");p.textContent=`${o.workdayHours}h`,p.style.fontVariantNumeric="tabular-nums",p.style.minWidth="38px",p.style.textAlign="center",m.appendChild(p);const w=document.createElement("div");Object.assign(w.style,{display:"flex",flexDirection:"column",gap:"2px"});const x=4,C=16,M=(O,s,G)=>{const X=document.createElement("button");return X.type="button",X.textContent=O,X.setAttribute("aria-label",G),Object.assign(X.style,{width:"22px",height:"18px",borderRadius:"4px",border:"1px solid var(--map-border, #999)",background:"var(--menu-bg)",cursor:"pointer",lineHeight:"1"}),X.addEventListener("click",re=>{re.preventDefault();const q=Math.max(x,Math.min(C,(o.workdayHours||10)+s));zh(o.id,q),dl()}),X},T=M("â–¼",-1,`Reduce ${o.label} workday`),A=M("â–²",1,`Increase ${o.label} workday`);T.disabled=o.workdayHours<=x,A.disabled=o.workdayHours>=C,T.disabled&&(T.style.cursor="not-allowed",T.style.opacity="0.5"),A.disabled&&(A.style.cursor="not-allowed",A.style.opacity="0.5"),w.appendChild(A),w.appendChild(T),m.appendChild(w),c.appendChild(m);const E=document.createElement("span");E.textContent=String(o.assigned||0),E.style.fontVariantNumeric="tabular-nums",E.style.justifySelf="center",c.appendChild(E);const R=document.createElement("div");Object.assign(R.style,{display:"flex",gap:"4px"});const L=(O,s,G)=>{const X=document.createElement("button");return X.type="button",X.textContent=O,X.setAttribute("aria-label",G),Object.assign(X.style,{width:"28px",height:"28px",borderRadius:"6px",border:"1px solid var(--map-border, #999)",background:"var(--menu-bg)",cursor:"pointer"}),X.addEventListener("click",re=>{re.preventDefault(),Hh(o.id,o.assigned+s),dl()}),X},W=L("â–¼",-1,`Reduce ${o.label} assignments`),D=L("â–²",1,`Increase ${o.label} assignments`);W.disabled=o.assigned<=0,D.disabled=o.assigned>=a,W.disabled&&(W.style.cursor="not-allowed",W.style.opacity="0.5"),D.disabled&&(D.style.cursor="not-allowed",D.style.opacity="0.5"),R.appendChild(W),R.appendChild(D),c.appendChild(R);const V=document.createElement("div");V.style.gridColumn="1 / -1",V.style.fontSize="12px",V.style.opacity="0.82",V.style.paddingTop="4px";const P=Array.isArray(o.roster)?o.roster.map(O=>{const s=[O.name];return O.focusSkillName&&s.push(`specialises in ${O.focusSkillName.toLowerCase()}`),Number.isFinite(O.score)&&s.push(`score ${O.score}`),s.join(" â€¢ ")}):[];V.textContent=P.length?`Assigned: ${P.join(", ")}`:"Assigned: None â€” laborers will rotate through as needed.",c.appendChild(V),i.appendChild(c)}),_l(),La){const o=La;La=null;const a=i.querySelector(`[data-job-id="${o}"]`);if(a){const c=a.style.boxShadow;a.style.boxShadow="0 0 0 3px rgba(74, 144, 226, 0.45)",a.scrollIntoView({block:"center",behavior:"smooth"}),clearTimeout(sd),sd=setTimeout(()=>{a.style.boxShadow=c||""},1600)}}}function tf(){return fa||(fa=Xi("craft-planner-dialog","Craft Planner"),Fi=fa.content),fa}function ul(){const e=tf();if(!Fi||!e)return;const t=u0(),n=Sy({availableTools:t}),r=new Map;n.forEach(l=>{Object.entries(l.recipe.outputs||{}).forEach(([d])=>{r.has(d)||r.set(d,{recipes:new Set}),r.get(d).recipes.add(l.recipe.name||d)})});const i=ky(),o=new Set([...r.keys(),...i.map(l=>l.id)]);if(Fi.innerHTML="",!o.size){const l=document.createElement("p");l.textContent="No craftable goods are available yet.",Fi.appendChild(l);return}const a=document.createElement("p");a.textContent="Set the desired stock for crafted goods. Equipped or held items are ignored automatically.",a.style.fontSize="13px",a.style.opacity="0.82",Fi.appendChild(a);const c=document.createElement("div");Object.assign(c.style,{display:"flex",flexDirection:"column",gap:"12px",marginTop:"12px"}),Fi.appendChild(c),Array.from(o).sort((l,d)=>l.localeCompare(d)).forEach(l=>{const d=r.get(l)||{recipes:new Set},u=My(l),m=Fo(l),h=Number(m.quantity)||0,p=Cy(l),w=Math.max(0,Math.round((h-p)*10)/10),x=Math.max(0,Math.round(p*10)/10),C=document.createElement("div");Object.assign(C.style,{border:"1px solid var(--map-border, #ccc)",borderRadius:"12px",padding:"12px",background:"var(--menu-bg)",color:"var(--text-color)",display:"flex",flexDirection:"column",gap:"8px"});const M=document.createElement("div");Object.assign(M.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"12px",flexWrap:"wrap"});const T=document.createElement("h4");T.textContent=l.charAt(0).toUpperCase()+l.slice(1),T.style.margin="0",M.appendChild(T);const A=document.createElement("div");Object.assign(A.style,{display:"flex",alignItems:"center",gap:"8px"});const E=document.createElement("span");E.textContent="Target",E.style.fontWeight="600",A.appendChild(E);const R=document.createElement("input");R.type="number",R.min="0",R.step="1",R.value=String(u||0),R.style.width="80px",R.setAttribute("aria-label",`Desired stock for ${l}`),R.addEventListener("change",()=>{const D=Number.parseInt(R.value,10);ad(l,Number.isFinite(D)?D:0),ul()}),A.appendChild(R);const L=document.createElement("button");L.type="button",L.textContent="Clear",L.addEventListener("click",()=>{ad(l,0),ul()}),A.appendChild(L),M.appendChild(A),C.appendChild(M);const W=document.createElement("span");if(W.style.fontSize="13px",W.style.opacity="0.85",W.textContent=`Usable on hand: ${w} (Reserved: ${x}).`,C.appendChild(W),d.recipes.size){const D=document.createElement("span");D.style.fontSize="12px",D.style.opacity="0.75",D.textContent=`Produced by: ${Array.from(d.recipes).join(", ")}.`,C.appendChild(D)}c.appendChild(C)})}function a0(){return da||(da=Xi("profile-dialog","Settlement Profile"),Fn=da.content),da}function s0(){if(!ua){ua=Xi("log-dialog","Event Log"),js=ua.content;const e=document.createElement("p");e.textContent="A chronological account of notable happenings within your settlement.",js.appendChild(e),Kn=document.createElement("ul"),Kn.style.listStyle="none",Kn.style.padding="0",Kn.style.margin="0",js.appendChild(Kn)}return ua}function nf(){if(!ma&&(ma=Xi("herbarium-dialog","Herbarium"),xr=ma.content,xr)){const e=document.createElement("p");e.textContent="Catalogue of flora identified throughout your travels. Forage to reveal new entries.",e.style.marginBottom="8px",xr.appendChild(e)}return ma}function l0(){const e=nf();if(!xr||!e)return;xr.innerHTML="";const t=Fy();if(!t.total){const r=document.createElement("p");r.textContent="No flora specimens have been catalogued yet. Forage successfully to add discoveries to your herbarium.",xr.appendChild(r);return}const n=document.createElement("p");n.textContent=`Specimens catalogued: ${t.discovered} of ${t.total}.`,n.style.marginBottom="6px",xr.appendChild(n),t.sections.forEach(r=>{const i=document.createElement("section");i.style.marginTop="12px";const o=document.createElement("h4");o.textContent=`${r.biomeName} (${r.discoveredCount}/${r.total})`,o.style.margin="0 0 4px 0",i.appendChild(o);const a=document.createElement("table"),c=document.createElement("thead"),l=document.createElement("tr");["Specimen","Edible Parts","Caution","Uses"].forEach(u=>{const m=document.createElement("th");m.textContent=u,l.appendChild(m)}),c.appendChild(l),a.appendChild(c);const d=document.createElement("tbody");r.entries.forEach(u=>{const m=document.createElement("tr");u.discovered||(m.style.opacity="0.65");const h=document.createElement("td");u.discovered?(h.textContent=u.item.name,h.style.fontWeight="600"):(h.textContent=Pu("flora"),h.style.fontStyle="italic"),m.appendChild(h);const p=document.createElement("td");p.textContent=u.discovered?u.item.edibleParts||"None noted":"Unknown",m.appendChild(p);const w=document.createElement("td");w.textContent=u.discovered?u.item.poisonousParts||"None noted":"Unknown",m.appendChild(w);const x=document.createElement("td");x.textContent=u.discovered?u.item.usefulParts||"No recorded uses":"Unknown",m.appendChild(x),d.appendChild(m)}),a.appendChild(d),Vu(a),i.appendChild(a),xr.appendChild(i)})}function rf(){if(!ha&&(ha=Xi("bestiary-dialog","Bestiary"),vr=ha.content,vr)){const e=document.createElement("p");e.textContent="Records of wildlife encountered in each biome. Successful hunts reveal new creatures.",e.style.marginBottom="8px",vr.appendChild(e)}return ha}function c0(){const e=rf();if(!vr||!e)return;vr.innerHTML="";const t=Ny();if(!t.total){const r=document.createElement("p");r.textContent="No wildlife has been documented yet. Complete hunting expeditions to populate the bestiary.",vr.appendChild(r);return}const n=document.createElement("p");n.textContent=`Creatures documented: ${t.discovered} of ${t.total}.`,n.style.marginBottom="6px",vr.appendChild(n),t.sections.forEach(r=>{const i=document.createElement("section");i.style.marginTop="12px";const o=document.createElement("h4");o.textContent=`${r.biomeName} (${r.discoveredCount}/${r.total})`,o.style.margin="0 0 4px 0",i.appendChild(o);const a=document.createElement("table"),c=document.createElement("thead"),l=document.createElement("tr");["Creature","Difficulty","Aggression","Diet","Recommended Tools","Notes"].forEach(u=>{const m=document.createElement("th");m.textContent=u,l.appendChild(m)}),c.appendChild(l),a.appendChild(c);const d=document.createElement("tbody");r.entries.forEach(u=>{const m=document.createElement("tr");u.discovered||(m.style.opacity="0.65");const h=document.createElement("td");u.discovered?(h.textContent=u.item.name,h.style.fontWeight="600"):(h.textContent=Pu("fauna"),h.style.fontStyle="italic"),m.appendChild(h);const p=document.createElement("td");p.textContent=u.discovered?u.item.difficulty:"Unknown",m.appendChild(p);const w=document.createElement("td");w.textContent=u.discovered?u.item.aggressive?"Yes":"No":"Unknown",m.appendChild(w);const x=document.createElement("td");x.textContent=u.discovered?u.item.diet:"Unknown",m.appendChild(x);const C=document.createElement("td");C.textContent=u.discovered?u.item.tools&&u.item.tools.length?u.item.tools.join(", "):"None":"Unknown",m.appendChild(C);const M=document.createElement("td");M.textContent=u.discovered?u.item.notes||"No notes recorded.":"Unknown",m.appendChild(M),d.appendChild(m)}),a.appendChild(d),Vu(a),i.appendChild(a),vr.appendChild(i)})}function Pl(){var n,r;const e=Dt();if(!e||!Ee)return;const t=Pt(e.id);Ee.setMap(e.map,{biomeId:e.biome,seed:(n=e.map)==null?void 0:n.seed,season:(r=e.map)==null?void 0:r.season,focus:{x:t.x,y:t.y}}),wo({recenter:!0}),Qa(),Gu()}function Qn(e=0,t={}){const{separator:n=":"}=t,i=((Number.isFinite(e)?Number(e):0)%24+24)%24;let o=Math.floor(i),a=Math.round((i-o)*60);a>=60&&(a-=60,o=(o+1)%24);const c=dd(o),l=dd(a);return n?`${c}${n}${l}`:`${c}${l}`}function es(e=0){const t=Number.isFinite(e)?Math.max(0,e):0,n=Math.round(t*60);if(n<=0)return"<1m";const r=Math.floor(n/60),i=n%60;return r&&i?`${r}h ${i}m`:r?`${r}h`:`${i}m`}function d0(e=Wi){const t=Number.isFinite(e)?Math.max(0,e):Wi;return t>=1e3?`${Math.round(t/1e3*10)/10} km`:`${Math.round(t)} m`}function dd(e,t=2){const n=Number.isFinite(e)?Math.trunc(e):0,r=n<0?0:n;return String(r).padStart(t,"0")}function u0(){return Bd().filter(e=>Number.isFinite(e.quantity)&&e.quantity>0).map(e=>e.id)}function of(){return Array.isArray(S.eventLog)||(S.eventLog=[]),S.eventLog}function af(e={}){const t=Number.isFinite(e.day)?Math.max(1,Math.floor(e.day)):1,n=Cl(e.month??1),r=Number.isFinite(e.year)?Math.floor(e.year):0,i=[e.season,e.weather].filter(Boolean),o=i.length?` (${i.join(" â€¢ ")})`:"",a=Qn(e.hour);return{dayNumber:t,monthName:n,yearNumber:r,descriptor:o,timeText:a}}function yn(e){const t=xn(),n=of();n.unshift({id:`${Date.now()}-${Math.random()}`,message:e,day:t.day,month:t.month,year:t.year,hour:t.hour,season:t.season,weather:t.weather}),n.length>30&&(n.length=30),Dl()}function f0(e){if(Qu(),!!Mr){if(Mr.innerHTML="",!e.length){const t=document.createElement("li");t.textContent="No recent events yet. Venture out to gather supplies or assign work orders.",t.style.fontStyle="italic",Mr.appendChild(t),It&&(It.disabled=!0,It.style.opacity="0.6",It.style.cursor="default");return}It&&(It.disabled=!1,It.style.opacity="1",It.style.cursor="pointer"),e.slice(0,Ry).forEach(t=>{var c,l;const n=af(t),r=document.createElement("li");Object.assign(r.style,{display:"flex",flexDirection:"column",gap:"2px"});const i=document.createElement("div");Object.assign(i.style,{display:"flex",alignItems:"center",gap:"8px"});const o=document.createElement("span");Object.assign(o.style,{fontFamily:'"Fira Mono", "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',fontSize:"12px",padding:"2px 6px",borderRadius:"6px",color:"inherit"}),(l=(c=document.body)==null?void 0:c.classList)!=null&&l.contains("dark")?(o.style.background="rgba(255, 255, 255, 0.12)",o.style.border="1px solid rgba(255, 255, 255, 0.18)"):(o.style.background="rgba(0, 0, 0, 0.06)",o.style.border="1px solid rgba(0, 0, 0, 0.08)"),o.textContent=n.timeText,i.appendChild(o);const a=document.createElement("span");a.textContent=t.message,a.style.fontWeight="600",i.appendChild(a),r.appendChild(i),Mr.appendChild(r)})}}function m0(e){if(Kn){if(Kn.innerHTML="",!e.length){const t=document.createElement("li");t.textContent="No recent events yet.",Kn.appendChild(t);return}e.forEach(t=>{const n=af(t),r=document.createElement("li");r.textContent=`${n.timeText} â€“ ${t.message}`,Kn.appendChild(r)})}}function Dl(){const e=of();f0(e),m0(e)}function qs(e,t,n){!Number.isFinite(n)||n===0||(e[t]||(e[t]={supply:0,demand:0}),n>0?e[t].supply+=n:e[t].demand+=Math.abs(n))}function h0(){var o;const e={},t=Jn({statuses:["completed"]}),n=ss(),r=new Map;(o=n==null?void 0:n.assignments)==null||o.forEach(a=>{r.set(a.id,a.assigned||0)});const i=new Map;return t.forEach(a=>{var d;const c=Gt(a.typeId),l=(d=c==null?void 0:c.effects)==null?void 0:d.jobs;l&&Object.entries(l).forEach(([u,m])=>{const h=Number(m)||0;h>0&&i.set(u,(i.get(u)||0)+h)})}),t.forEach(a=>{const c=Gt(a.typeId);if(!c)return;const l=c.effects||{};let d=1;const u=l.jobs;if(u&&Object.keys(u).length){let m=1;Object.entries(u).forEach(([h])=>{const p=i.get(h)||0,w=r.get(h)||0,x=p>0?Math.min(1,w/p):0;m=Math.min(m,x)}),d=m}Object.entries(l.supply||{}).forEach(([m,h])=>{qs(e,m,(h||0)*d)}),Object.entries(l.demand||{}).forEach(([m,h])=>{if(!Number.isFinite(h)||h===0)return;const p=h*d;p>0?qs(e,m,-p):qs(e,m,Math.abs(p))})}),e}function sf(){const e=kp(qb()),t=h0();Object.entries(t).forEach(([r,i])=>{e[r]||(e[r]={supply:0,demand:0}),e[r].supply+=i.supply||0,e[r].demand+=i.demand||0});const n=new Set(Array.from(S.inventory.keys()));Object.keys(e).forEach(r=>n.add(r)),n.forEach(r=>{const i=e[r]||{supply:0,demand:0},o=Math.round((i.supply||0)*10)/10,a=Math.round((i.demand||0)*10)/10;Wm(r,{supply:o,demand:a})})}function ud(e=0,t=""){const n=Math.round((e||0)*10)/10;return n?`${t}${Math.abs(n)}`:"0"}function lf(){if(Wl(),!Hi)return;Hi.innerHTML="";const e=Bd().sort((t,n)=>{if(t.isEquipment!==n.isEquipment)return t.isEquipment?-1:1;const r=(t.label||t.id||"").toLowerCase(),i=(n.label||n.id||"").toLowerCase();return r.localeCompare(i)});if(!e.length){const t=document.createElement("tr");t.innerHTML='<td colspan="5">No supplies on hand.</td>',Hi.appendChild(t);return}e.forEach(t=>{const n=document.createElement("tr"),r=document.createElement("td");r.style.display="flex",r.style.alignItems="center",r.style.gap="6px";const i=zo(t.id);if(i){const u=document.createElement("span");u.textContent=i.icon,u.title=i.label,u.setAttribute("role","img"),u.setAttribute("aria-label",i.label),r.appendChild(u)}const o=document.createElement("span");o.textContent=t.label||hs(t.id)||t.id,r.appendChild(o);const a=document.createElement("td");a.textContent=t.tierLabel||t.qualityLabel||"â€”";const c=document.createElement("td");c.textContent=Math.round((t.quantity||0)*10)/10,c.style.textAlign="right";const l=document.createElement("td");l.textContent=ud(t.supply,"+"),l.style.textAlign="right";const d=document.createElement("td");d.textContent=ud(t.demand,"-"),d.style.textAlign="right",n.appendChild(r),n.appendChild(a),n.appendChild(c),n.appendChild(l),n.appendChild(d),Hi.appendChild(n)})}function jl(){sf(),zl&&lf()}function Wl(){if(et)return et.parentElement||document.body.appendChild(et),et;et=document.createElement("div"),et.id="inventory-popup",et.setAttribute("role","dialog"),et.setAttribute("aria-modal","true"),et.setAttribute("aria-hidden","true"),et.setAttribute("aria-labelledby","inventory-popup-title"),Object.assign(et.style,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",display:"none",alignItems:"center",justifyContent:"center",background:"rgba(0, 0, 0, 0.45)",zIndex:"2100"}),et.addEventListener("click",l=>{l.target===et&&fd()}),Dr=document.createElement("div"),Dr.classList.add("inventory-dialog"),Object.assign(Dr.style,{background:"var(--menu-bg)",color:"var(--text-color)",borderRadius:"10px",boxShadow:"0 10px 24px rgba(0, 0, 0, 0.35)",padding:"20px",maxWidth:"520px",width:"90vw",maxHeight:"80vh",overflowY:"auto"});const e=document.createElement("div");e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="space-between",e.style.gap="12px";const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.gap="12px";const n=document.createElement("h3");n.id="inventory-popup-title",n.textContent="Inventory Overview",n.style.margin="0",t.appendChild(n),e.appendChild(t);const r=document.createElement("button");r.type="button",r.textContent="Close",r.addEventListener("click",()=>{fd()}),e.appendChild(r),Dr.appendChild(e);const i=document.createElement("p");i.textContent="Track on-hand quantities alongside projected supply and demand from queued orders.",i.style.marginTop="12px",i.style.marginBottom="12px",Dr.appendChild(i);const o=document.createElement("table");o.style.width="100%",o.style.borderCollapse="collapse";const a=document.createElement("tr");a.innerHTML='<th style="text-align:left;">Item</th><th style="text-align:left;">Tier</th><th style="text-align:right;">#</th><th style="text-align:right;">Supply (+)</th><th style="text-align:right;">Demand (-)</th>';const c=document.createElement("thead");return c.appendChild(a),o.appendChild(c),Hi=document.createElement("tbody"),o.appendChild(Hi),Dr.appendChild(o),et.appendChild(Dr),document.body.appendChild(et),et}function p0(){Wl(),sf(),lf(),et.style.display="flex",et.setAttribute("aria-hidden","false"),zl=!0}function fd(){et&&(et.style.display="none",et.setAttribute("aria-hidden","true"),zl=!1)}function Un(e=0){const t=Math.round(e*10)/10;return t>0?`+${t}`:`${t}`}function bn(e=[]){const t=(Array.isArray(e)?e:[e]).filter(n=>n!=null&&`${n}`.trim()!=="");return t.length?t.length===1?`${t[0]}`:t.length===2?`${t[0]} and ${t[1]}`:`${t.slice(0,-1).join(", ")}, and ${t[t.length-1]}`:""}function Ue(e=""){return String(e||"").split(/[-_]/).filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function ts(e){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number")return{id:String(e),count:1};if(e&&typeof e=="object"){const t=e.id??e.building??e.type;if(!t&&t!==0)return null;const n=Number.isFinite(e.count)?Math.max(1,e.count):Number.isFinite(e.required)?Math.max(1,e.required):1;return{id:String(t),count:n}}return null}function Ei(e){return!e&&e!==0?[]:Array.isArray(e)?e:[e]}function Gi(e=[]){const t=(Array.isArray(e)?e:[e]).filter(n=>n||n===0).map(n=>za(n));return bn(t)}function g0(e={}){if(!e)return[];const t=[],n=Ei(e.technologies||[]).filter(l=>l||l===0);n.length&&t.push(`Research ${Gi(n)}`);const r=Ei(e.anyTechnology||[]).filter(l=>l||l===0);r.length&&t.push(`Research one of ${Gi(r)}`);const i=Ei(e.research||[]).filter(l=>l||l===0);if(i.length){const l=i.map(d=>Ue(d));t.push(`Complete research: ${bn(l)}`)}const o=Ei(e.anyResearch||[]).filter(l=>l||l===0);if(o.length){const l=o.map(d=>Ue(d));t.push(`Complete one of: ${bn(l)}`)}const a=Ei(e.buildings||[]).map(ts).filter(Boolean).map(l=>{var u;const d=((u=Gt(l.id))==null?void 0:u.name)||Ue(l.id);return l.count>1?`${l.count}Ã— ${d}`:d});a.length&&t.push(`Construct ${bn(a)}`);const c=Ei(e.anyBuilding||[]).map(ts).filter(Boolean).map(l=>{var u;const d=((u=Gt(l.id))==null?void 0:u.name)||Ue(l.id);return l.count>1?`${l.count}Ã— ${d}`:d});if(c.length&&t.push(`Construct one of: ${bn(c)}`),e.resources&&typeof e.resources=="object"){const l=Object.entries(e.resources).filter(([,d])=>Number.isFinite(d)&&d>0).map(([d,u])=>`${u} ${hs(d)||Ue(d)}`);l.length&&t.push(`Stockpile ${bn(l)}`)}return t}const uo=new Map;function b0(e){if(!e&&e!==0)return"";const t=String(e);return uo.size||zu.forEach(n=>{(n.recipes||[]).forEach(r=>{const i=String(r.id);uo.set(i,r.name||Ue(i))})}),uo.has(t)||uo.set(t,Ue(t)),uo.get(t)}function mt(e,t){const n=document.createElement("p"),r=document.createElement("strong");return r.textContent=`${e}: `,n.appendChild(r),t instanceof Node?n.appendChild(t):n.appendChild(document.createTextNode(t)),n}function jr(e={}){const t=Object.entries(e).filter(([,r])=>r&&r!==0),n=document.createElement("span");return t.length?(t.forEach(([r,i],o)=>{const a=document.createElement("span");a.style.display="inline-flex",a.style.alignItems="center",a.style.gap="4px",a.style.marginRight="8px";const c=Math.round(i*10)/10,l=zo(r);if(l){const d=document.createElement("span");d.textContent=l.icon,d.title=l.label,d.setAttribute("role","img"),d.setAttribute("aria-label",l.label),a.appendChild(d);const u=document.createElement("span");u.textContent=`Ã—${c}`,a.appendChild(u)}else a.textContent=`${c} ${r}`;n.appendChild(a),o===t.length-1&&(a.style.marginRight="0")}),n):(n.textContent="None",n)}function md(e={}){const t=[];if([["occupancy",r=>`Occupancy ${Un(r)}`],["comfort",r=>`Comfort ${Un(r)}`],["survivability",r=>`Survivability ${Un(r)}`],["appeal",r=>`Appeal ${Un(r)}`],["safety",r=>`Safety ${Un(r)}`],["maxWorkers",r=>`Supports ${r} workers`]].forEach(([r,i])=>{e[r]&&t.push(i(e[r]))}),e.jobs){const r=new Map(Vd().map(i=>[i.id,i.label||Ue(i.id)]));Object.entries(e.jobs).forEach(([i,o])=>{if(!Number.isFinite(o)||o<=0)return;const a=r.get(i)||Ue(i);t.push(`Supports ${o} ${a}`)})}if(e.supply&&Object.entries(e.supply).forEach(([r,i])=>{t.push(`Supply ${r} ${Un(i)}`)}),e.demand&&Object.entries(e.demand).forEach(([r,i])=>{t.push(`Demand ${r} ${Un(i)}`)}),e.capacity&&Object.entries(e.capacity).forEach(([r,i])=>{t.push(`Capacity ${r} ${Un(i)}`)}),e.storage&&Object.entries(e.storage).forEach(([r,i])=>{t.push(`Storage ${r} ${Un(i)}`)}),e.unlocks){const i=(Array.isArray(e.unlocks)?e.unlocks:[e.unlocks]).map(o=>{if(!o&&o!==0)return null;if(typeof o=="string"||typeof o=="number")return za(o)||Ue(o);if(o&&typeof o=="object"){const a=o.technology??o.tech??o.id;if(a||a===0)return za(a)||Ue(a)}return null}).filter(Boolean);i.length&&t.push(`Unlocks: ${i.join(", ")}`)}return t}function y0(e,t){var d,u,m,h,p;const n=document.createElement("article");n.className="build-card",e!=null&&e.id&&(n.dataset.typeId=e.id),n.style.border="1px solid var(--map-border)",n.style.padding="8px",n.style.borderRadius="6px",n.style.background="var(--card-bg, var(--map-bg))",n.style.color="var(--card-text, var(--text-color))";const r=document.createElement("h4");if(r.textContent=`${e.icon?`${e.icon} `:""}${e.name}`,n.appendChild(r),e.description){const w=document.createElement("p");w.textContent=e.description,n.appendChild(w)}n.appendChild(mt("Labor",`${e.stats.totalLaborHours} worker-hours`)),n.appendChild(mt("Minimum Builders",e.stats.minBuilders)),e.stats.site&&n.appendChild(mt("Site",Xy(e.stats.site,t.siteStatus))),n.appendChild(mt("Core Structure",jr(e.stats.coreResources))),n.appendChild(mt("Full Build",jr(e.stats.totalResources))),(d=e.requirements)!=null&&d.craftedGoods&&n.appendChild(mt("Crafted Goods",jr(e.requirements.craftedGoods)));const i=g0(e.unlock);i.length&&n.appendChild(mt("Prerequisites",i.join("; ")));const o=md(e.effects);if(o.length){const w=document.createElement("p");w.innerHTML="<strong>Effects:</strong>",n.appendChild(w);const x=document.createElement("ul");o.forEach(C=>{const M=document.createElement("li");M.textContent=C,x.appendChild(M)}),n.appendChild(x)}if((u=e.stats.components)!=null&&u.length){const w=document.createElement("details"),x=document.createElement("summary");x.textContent="Construction segments",w.appendChild(x),e.stats.components.forEach(C=>{const M=document.createElement("div");M.style.marginBottom="6px";const T=document.createElement("p"),A=document.createElement("strong");if(A.textContent=C.name,T.appendChild(A),C.isCore){const E=document.createElement("em");E.textContent=" (Core structure)",E.style.marginLeft="4px",T.appendChild(E)}C.description&&T.appendChild(document.createTextNode(` â€“ ${C.description}`)),M.appendChild(T),M.appendChild(mt("Labor",`${C.laborHours} hrs @ â‰¥${C.minBuilders} builders`)),M.appendChild(mt("Resources",jr(C.resources))),w.appendChild(M)}),n.appendChild(w)}if((m=e.stats.addons)!=null&&m.length){const w=document.createElement("details"),x=document.createElement("summary");x.textContent="Optional upgrades",w.appendChild(x),e.stats.addons.forEach(C=>{const M=document.createElement("div");M.style.marginBottom="6px";const T=document.createElement("p");if(T.innerHTML=`<strong>${C.name}:</strong> ${C.description}`,M.appendChild(T),M.appendChild(mt("Labor",`${C.laborHours} hrs @ â‰¥${C.minBuilders} builders`)),C.effects){const A=md(C.effects);if(A.length){const E=document.createElement("ul");A.forEach(R=>{const L=document.createElement("li");L.textContent=R,E.appendChild(L)}),M.appendChild(E)}}M.appendChild(mt("Resources",jr(C.resources))),w.appendChild(M)}),n.appendChild(w)}const a=((h=t.resourceStatus)==null?void 0:h.missing)||[];if(a.length){const w=Object.fromEntries(a.map(M=>[M.name,Math.max(0,(M.required||0)-(M.available||0))])),x=mt("Core Shortfall",jr(w));n.appendChild(x);const C=a.map(M=>Ws(M.name,(M.required||0)-(M.available||0))).filter(Boolean);if(C.length){const M=document.createElement("p");M.textContent=`Core structure requires ${an(C)}.`,n.appendChild(M)}}const c=((p=t.craftedStatus)==null?void 0:p.missing)||[];if(c.length){const w=Object.fromEntries(c.map(M=>[M.name,Math.max(0,(M.required||0)-(M.available||0))])),x=mt("Later Crafted Needs",jr(w));n.appendChild(x);const C=c.map(M=>Ws(M.name,(M.required||0)-(M.available||0))).filter(Boolean);if(C.length){const M=document.createElement("p");M.style.fontStyle="italic",M.textContent=`Later phases will also need ${an(C)}.`,n.appendChild(M)}}const l=document.createElement("button");if(l.textContent=`Build ${e.name}`,l.disabled=!t.hasResources,!t.hasResources){const w=a.map(x=>Ws(x.name,(x.required||0)-(x.available||0))).filter(Boolean);l.title=w.length?`Core structure requires ${an(w)}.`:"Gather more resources to begin construction."}return l.addEventListener("click",()=>{try{const w=Dt(),x=w?Pt(w.id):Pt(),{order:C}=tg(e.id,{workers:e.stats.minBuilders,locationId:w==null?void 0:w.id,x:x==null?void 0:x.x,y:x==null?void 0:x.y});Ub(C),yn(`Construction started on the ${e.name}.`),jl(),$o()}catch(w){console.warn(w),alert(w.message)}}),n.appendChild(l),n}function cf(){if(Qt)return;Qt=document.createElement("div"),Qt.id="construction-dashboard",Object.assign(Qt.style,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0, 0, 0, 0.5)",display:"none",alignItems:"flex-start",justifyContent:"center",overflowY:"auto",padding:"40px 16px",zIndex:"2000"}),Qt.addEventListener("click",l=>{l.target===Qt&&Li()}),qn=document.createElement("div"),Object.assign(qn.style,{background:"var(--menu-bg)",color:"var(--text-color)",borderRadius:"8px",boxShadow:"0 6px 20px rgba(0, 0, 0, 0.3)",maxWidth:"960px",width:"100%",padding:"24px",boxSizing:"border-box"});const e=document.createElement("div");e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center";const t=document.createElement("h3");t.textContent="Construction Planner",e.appendChild(t);const n=document.createElement("button");n.type="button",n.textContent="Close",n.addEventListener("click",()=>{Li()}),e.appendChild(n),qn.appendChild(e);const r=document.createElement("p");r.textContent="Plan, upgrade, and review settlement structures. Projects consume materials over time and unlock more sophisticated buildings as the village advances.",qn.appendChild(r);const i=document.createElement("section");i.id="build-menu",Bn=document.createElement("div"),Bn.id="build-category-filters",Bn.style.display="flex",Bn.style.flexWrap="wrap",Bn.style.gap="8px",Bn.style.margin="12px 0",i.appendChild(Bn),Ln=document.createElement("div"),Ln.id="build-options",Ln.style.display="grid",Ln.style.gridTemplateColumns="repeat(auto-fit, minmax(260px, 1fr))",Ln.style.gap="12px",i.appendChild(Ln);const o=document.createElement("h4");o.textContent="Active Projects",i.appendChild(o),Kr=document.createElement("div"),Kr.id="build-projects",i.appendChild(Kr);const a=document.createElement("h4");a.textContent="Completed Structures",i.appendChild(a),Zr=document.createElement("div"),Zr.id="completed-buildings",i.appendChild(Zr);const c=document.createElement("h4");c.textContent="Locked or Unavailable",i.appendChild(c),Jr=document.createElement("div"),Jr.id="locked-buildings",i.appendChild(Jr),qn.appendChild(i),Qt.appendChild(qn),document.body.appendChild(Qt),Li=()=>{Qt&&(Qt.style.display="none")},qu=()=>{cf(),ql(),Qt&&(Qt.style.display="flex",qn==null||qn.scrollTo({top:0}))},Li()}function w0(e){if(!Bn)return;const t=new Set;e.forEach(r=>{var o;const i=(o=r.type)==null?void 0:o.category;i&&t.add(i)});const n=["All",...Array.from(t).sort((r,i)=>r.localeCompare(i))];n.some(r=>r.toLowerCase()===Bi)||(Bi="all"),Bn.innerHTML="",n.forEach(r=>{const i=r.toLowerCase(),o=document.createElement("button");o.type="button",o.textContent=r,o.style.padding="4px 12px",o.style.borderRadius="999px",o.style.border="1px solid var(--map-border)",o.style.background="rgba(0, 0, 0, 0.04)",o.style.color="inherit",o.style.cursor="pointer",o.style.fontWeight="600",i===Bi&&(o.disabled=!0,o.style.background="var(--accent-color, #3b82f6)",o.style.color="#fff",o.style.cursor="default"),o.addEventListener("click",()=>{Bi=i,ql()}),Bn.appendChild(o)})}function ql(){const e=Jn({statuses:["under-construction"]});if(!Ln||!Kr||!Zr||!Jr)return;const t=Qp().map(d=>({type:d,info:iu(d.id)})).filter(d=>d.info);w0(t);const n=typeof Bi=="string"?Bi:"all",r=d=>{var m;return n==="all"?!0:(((m=d.type)==null?void 0:m.category)||"").toLowerCase()===n};Ln.innerHTML="";const i=t.filter(d=>d.info.unlocked&&d.info.locationOk&&d.info.canBuildMore),o=i.filter(r);if(o.length)o.forEach(d=>{const u=y0(d.type,d.info);Ln.appendChild(u)});else{const d=document.createElement("p");i.length&&n!=="all"?d.textContent="No structures in this category are ready to build yet.":d.textContent="No structures are currently available to build.",Ln.appendChild(d)}if(Kr.innerHTML="",e.length){const d=document.createElement("ul");e.forEach(u=>{const m=Gt(u.typeId),h=document.createElement("li"),p=u.totalLaborHours?Math.round(u.progressHours/u.totalLaborHours*100):0,w=Math.round(u.progressHours*10)/10,x=Math.round(u.totalLaborHours*10)/10,C=u.tile,M=C&&Number.isFinite(C.x)&&Number.isFinite(C.y)?` @ (${Math.trunc(C.x)}, ${Math.trunc(C.y)})`:"";h.textContent=`${m!=null&&m.icon?`${m.icon} `:""}${(m==null?void 0:m.name)||u.typeId}${M} â€“ ${p}% complete (${w}/${x} worker-hours, ${u.assignedWorkers} builders)`,d.appendChild(h)}),Kr.appendChild(d)}else{const d=document.createElement("p");d.textContent="No projects are currently underway.",Kr.appendChild(d)}Zr.innerHTML="";const a=Jn({statuses:["completed"]});if(a.length){const d=document.createElement("ul");a.forEach(u=>{const m=Gt(u.typeId),h=document.createElement("li"),p=(m==null?void 0:m.name)||u.typeId,w=u.tile,x=w&&Number.isFinite(w.x)&&Number.isFinite(w.y)?` @ (${Math.trunc(w.x)}, ${Math.trunc(w.y)})`:"";h.textContent=`${m!=null&&m.icon?`${m.icon} `:""}${p}${x}`,d.appendChild(h)}),Zr.appendChild(d)}else{const d=document.createElement("p");d.textContent="No completed structures yet.",Zr.appendChild(d)}Jr.innerHTML="";const c=t.filter(d=>!d.info.unlocked||!d.info.locationOk||!d.info.canBuildMore),l=c.filter(r);if(l.length){const d=document.createElement("ul");l.forEach(({type:u,info:m})=>{var x,C,M,T,A,E,R,L,W,D,V,P;const h=document.createElement("li"),p=`${u.icon?`${u.icon} `:""}${u.name}`,w=[];if(!m.unlocked){const O=(x=m.unlockStatus)==null?void 0:x.missing;if(O){if((C=O.technologies)!=null&&C.length&&w.push(`Research ${Gi(O.technologies)}`),(M=O.anyTechnology)!=null&&M.length&&w.push(`Research one of ${Gi(O.anyTechnology)}`),(T=O.research)!=null&&T.length&&w.push(`Complete research: ${bn(O.research.map(s=>Ue(s)))}`),(A=O.anyResearch)!=null&&A.length&&w.push(`Complete one of: ${bn(O.anyResearch.map(s=>Ue(s)))}`),(E=O.buildings)!=null&&E.length&&O.buildings.forEach(s=>{var ee;const G=ts({id:s.id,count:s.required}),X=G?((ee=Gt(G.id))==null?void 0:ee.name)||Ue(G.id):Ue(s.id),re=G?G.count:s.required||1,q=Number.isFinite(s.current)?s.current:0;w.push(`Construct ${re>1?`${re}Ã— ${X}`:X} (${q}/${re})`)}),(R=O.anyBuilding)!=null&&R.length){const s=O.anyBuilding.map(G=>{var Me;const X=ts(G);if(!X)return null;const re=((Me=Gt(X.id))==null?void 0:Me.name)||Ue(X.id),q=X.count,ee=Number.isFinite(G.current)?G.current:0;return`${q>1?`${q}Ã— ${re}`:re} (${ee}/${q})`}).filter(Boolean);s.length&&w.push(`Construct one of: ${s.join(" or ")}`)}(L=O.resources)!=null&&L.length&&O.resources.forEach(s=>{const G=hs(s.name)||Ue(s.name),X=Number.isFinite(s.required)?s.required:0,re=Number.isFinite(s.available)?s.available:0;w.push(`Stockpile ${G} (${re}/${X})`)}),O.custom&&w.push("Fulfil special conditions")}w.length||w.push("Prerequisites not yet met")}if(m.unlocked&&!m.terrainOk){const O=((D=(W=u.requirements)==null?void 0:W.locationTags)==null?void 0:D.join(", "))||"suitable terrain";w.push(`Requires terrain with: ${O}`)}if(m.unlocked&&m.terrainOk&&!m.siteOk){const O=(V=u.stats)==null?void 0:V.site;if(O!=null&&O.surfaceArea){const s=((P=m.siteStatus)==null?void 0:P.selected)||null,G=s&&Number.isFinite(s.remaining)?Math.max(0,s.remaining):null;let X=`Needs ${Ao(O.surfaceArea)} of ${$l((s==null?void 0:s.category)||O.primaryCategory).toLowerCase()} space`;G!==null&&(X+=` (only ${Ao(G)} free)`),w.push(X)}else w.push("Insufficient buildable surface area")}m.unlocked&&!m.canBuildMore&&w.push("Maximum built for now"),h.textContent=`${p} â€“ ${w.join("; ")}`,d.appendChild(h)}),Jr.appendChild(d)}else{const d=document.createElement("p");c.length&&n!=="all"?d.textContent="Nothing in this category is readyâ€”check prerequisites or staffing.":d.textContent="All known structures are available.",Jr.appendChild(d)}}function df(e=""){return e.charAt(0).toUpperCase()+e.slice(1)}function x0(){var o,a,c,l;const e=Dt();if(!(e!=null&&e.map))return;const t=xn();if(Ba&&Ba===t.season)return;const n=e.map,r=e.worldSettings||n.worldSettings,i=e.world||n.world||null;if(i){const d=i.dimensions||{},u=Math.max(1,Math.trunc(d.width??n.width??Er)),m=Math.max(1,Math.trunc(d.height??n.height??li)),{xStart:h,yStart:p}=No(u,m),w=n.seedInfo||i.seed||null,x=n.seed??(w==null?void 0:w.raw)??"",C=n.viewport||null,M=si(i,{seedInfo:w,seedString:x,season:t.season,xStart:Number.isFinite(n.xStart)?Math.trunc(n.xStart):h,yStart:Number.isFinite(n.yStart)?Math.trunc(n.yStart):p,viewport:C,worldSettings:r});e.map={...n,...M,waterLevel:n.waterLevel??M.waterLevel??null,world:i}}else{const d=((a=(o=n.tiles)==null?void 0:o[0])==null?void 0:a.length)||Er,u=((c=n.tiles)==null?void 0:c.length)||li,{world:m,map:h}=Mo({width:d,height:u,seed:n.seed,season:t.season,xStart:n.xStart,yStart:n.yStart,viewport:n.viewport,worldSettings:r,startingBiomeId:e.biome??null});e.world=m,e.map={...n,...h,world:m,waterLevel:n.waterLevel??h.waterLevel??null}}!e.worldSettings&&((l=e.map)!=null&&l.worldSettings)&&(e.worldSettings=e.map.worldSettings),Ba=t.season,Pl()}function v0(){const e=Ju();if(!e)return;const t=Yn||e;t.replaceChildren();const n=xn(),r=Jd(n.season),i=$p(n.weather),o=Op(n.hour),a=n.monthName||Cl(n.month),c=Number.isFinite(n.day)?Math.max(1,Math.floor(n.day)):1,l=Number.isFinite(n.year)?Math.floor(n.year):0,d=Qn(n.hour,{separator:""}),u=Qn(n.hour),m=a||"Unknown Month",h=[d,c,m,l].filter(w=>w!=null&&`${w}`.trim()!=="").join(" ");[{icon:o.icon,text:h,title:`${o.label} at ${u} on ${c} ${m}, Year ${l}`,showText:!0},{icon:r.icon,text:r.name,title:`${r.name} season`,showText:!1},{icon:i.icon,text:i.name,title:`Weather: ${i.name}`,showText:!1}].forEach(w=>{const x=document.createElement("span");x.className="time-chip",w.title&&(x.title=w.title),(w.title||w.text)&&x.setAttribute("aria-label",w.title||w.text);const C=document.createElement("span");if(C.textContent=w.icon,x.appendChild(C),w.showText!==!1&&w.text!==void 0&&w.text!==null&&w.text!==""){const T=document.createElement("span");T.textContent=w.text,x.appendChild(T)}t.appendChild(x)})}function $o(){x0(),v0(),Pl(),Ia(),Ra(),Uy(),ql(),jl(),Dl()}function S0(){zi&&zi.closeDialog(),Ll()}function M0(){Zy(),dl(),ef().openDialog(),Ll()}function k0(){ul(),tf().openDialog()}function C0(){var m,h,p,w,x,C;const e=a0();if(!Fn)return;Fn.innerHTML="";const t=document.createElement("p");t.textContent="Key facts about your settlement and its surroundings.",Fn.appendChild(t);const n=document.createElement("dl");Object.assign(n.style,{display:"grid",gridTemplateColumns:"max-content 1fr",columnGap:"12px",rowGap:"6px",margin:"0"});const r=(M,T)=>{if(T==null||T==="")return;const A=document.createElement("dt");A.textContent=M,A.style.fontWeight="600",A.style.margin="0";const E=document.createElement("dd");E.textContent=T,E.style.margin="0",n.appendChild(A),n.appendChild(E)},i=Vi()[0],o=i!=null&&i.biome?((m=wn(i.biome))==null?void 0:m.name)||i.biome:"Uncharted Region";if(r("Biome",o),i!=null&&i.map){const M=((p=(h=i.map.tiles)==null?void 0:h[0])==null?void 0:p.length)||0,T=((w=i.map.tiles)==null?void 0:w.length)||0;M&&T&&r("Survey Window",`${M} Ã— ${T} tiles`),i.map.seed&&r("Map Seed",i.map.seed);const A=i.map.xStart??0,E=i.map.yStart??0;r("Survey Origin",`${A}, ${E}`)}const a=xn();r("Season",`${a.season} (Day ${a.day})`),r("Local Time",Qn(a.hour)),r("Difficulty",df(S.difficulty||"normal"));const c=((x=S.people)==null?void 0:x.size)??0;r("Population",`${c} settlers`);const l=Jn({statuses:["completed"]}).length,d=Jn({statuses:["under-construction"]}).length;r("Completed Structures",l),r("Projects Underway",d),Fn.appendChild(n);const u=mh();if(u.length){const M=document.createElement("h4");M.textContent="Proficiencies",M.style.marginTop="16px",M.style.marginBottom="8px",Fn.appendChild(M);const T=document.createElement("ul");T.style.margin="0",T.style.paddingLeft="20px",u.forEach(A=>{const E=document.createElement("li"),R=Math.round((A.level||0)*10)/10;E.textContent=`${A.name}: ${R}/100`,T.appendChild(E)}),Fn.appendChild(T)}if((C=i==null?void 0:i.features)!=null&&C.length){const M=document.createElement("h4");M.textContent="Notable Features",M.style.marginBottom="8px",M.style.marginTop="16px",Fn.appendChild(M);const T=document.createElement("ul");T.style.margin="0",T.style.paddingLeft="20px",i.features.forEach(A=>{const E=document.createElement("li");E.textContent=A,T.appendChild(E)}),Fn.appendChild(T)}else{const M=document.createElement("p");M.textContent="No notable features have been catalogued yet.",M.style.marginTop="16px",Fn.appendChild(M)}e.openDialog()}function E0(){l0(),nf().openDialog()}function T0(){c0(),rf().openDialog()}function uf(){const e=s0();Dl(),e.openDialog()}function ff(){var r,i,o,a,c,l,d,u,m;bu();const e=document.getElementById("game");if(!e)return;document.getElementById("content"),e.innerHTML="",Object.assign(e.style,{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(300px, 1fr))",gap:"16px",alignItems:"flex-start"}),Ju(),Qu();const t=Dt(),n=t?Pt(t.id):Pt();if((r=t==null?void 0:t.map)!=null&&r.tiles){if(t.map.season!==S.time.season){const p=t.worldSettings||((i=t.map)==null?void 0:i.worldSettings),w=t.world||((o=t.map)==null?void 0:o.world)||null;if(w){const x=w.dimensions||{},C=Math.max(1,Math.trunc(x.width??t.map.width??Er)),M=Math.max(1,Math.trunc(x.height??t.map.height??li)),{xStart:T,yStart:A}=No(C,M),E=t.map.seedInfo||w.seed||null,R=t.map.seed??(E==null?void 0:E.raw)??"",L=t.map.viewport||null,W=si(w,{seedInfo:E,seedString:R,season:S.time.season,xStart:Number.isFinite(t.map.xStart)?Math.trunc(t.map.xStart):T,yStart:Number.isFinite(t.map.yStart)?Math.trunc(t.map.yStart):A,viewport:L,worldSettings:p});t.map={...t.map,...W,world:w,waterLevel:t.map.waterLevel??W.waterLevel??null}}else{const x=((c=(a=t.map.tiles)==null?void 0:a[0])==null?void 0:c.length)||Er,C=((l=t.map.tiles)==null?void 0:l.length)||li,{world:M,map:T}=Mo({width:x,height:C,seed:t.map.seed,season:S.time.season,xStart:t.map.xStart,yStart:t.map.yStart,viewport:t.map.viewport,worldSettings:p,startingBiomeId:t.biome??null});t.world=M,t.map={...t.map,...T,world:M,waterLevel:t.map.waterLevel??T.waterLevel??null}}!t.worldSettings&&((d=t.map)!=null&&d.worldSettings)&&(t.worldSettings=t.map.worldSettings)}t.world&&t.map&&t.map.world!==t.world&&(t.map.world=t.world);const h=document.createElement("section");h.id="map-section",Object.assign(h.style,{display:"flex",flexDirection:"column",gap:"12px",gridColumn:"1 / -1",minWidth:"0"}),e.appendChild(h),Ee=gu(h,{legendLabels:Du,showControls:!0,showLegend:!0,idPrefix:"game-map",navMode:"player",onNavigate:o0,jobSelector:{label:"Role",emptyMessage:"No jobs are available yet.",defaultDescription:"Open the Jobs panel to adjust staffing and work schedules.",onSelect:n0},fetchMap:({xStart:p,yStart:w,width:x,height:C,seed:M,season:T,viewport:A,skipSanityChecks:E})=>{var V,P,O;const R=M??((V=t.map)==null?void 0:V.seed)??Date.now(),L=T??S.time.season,W=t.worldSettings||((P=t.map)==null?void 0:P.worldSettings),{map:D}=Mo({width:x,height:C,seed:R,season:L,xStart:p,yStart:w,viewport:A,worldSettings:W,startingBiomeId:t.biome??null});return{...D,waterLevel:((O=t.map)==null?void 0:O.waterLevel)??D.waterLevel??null,skipSanityChecks:!!E}},onMapUpdate:p=>{t.map={...t.map,...p},Qa(),Ia(),Ra(),Gu()}}),Ee.setMap(t.map,{biomeId:t.biome,seed:(u=t.map)==null?void 0:u.seed,season:(m=t.map)==null?void 0:m.season,focus:{x:n.x,y:n.y}}),_l(),Ri=h,cl(Ri),Qa(),Ia(),Ra(),wo({recenter:!0}),Ba=S.time.season,Pl()}else Ri=e,cl(Ri),Ia(),Ra();Uu(e),qy(e),cf(),Li(),e.style.display="grid",Wl(),jl(),$o(),Ee&&typeof Ee.refresh=="function"&&Ee.refresh()}function mf(){document.body.classList.remove("landing-active");const e=document.getElementById("landing-theme");e&&e.parentElement&&e.parentElement.removeChild(e)}function A0(e={}){var T;const t=e.difficulty||"normal",n=So[t]||So.normal,r=n.start,i=e.world||n.world,c=(Object.prototype.hasOwnProperty.call(e,"startingBiomeId")?e.startingBiomeId:e.biome)??(i==null?void 0:i.startingBiomeId)??null,l={...i,...c?{startingBiomeId:c}:{}};S.jobs={gather:0,hunt:0,craft:0,build:0,guard:0},S.technologies=new Map,ui(),Fh(r.people,{seed:e.seed});const d=pp(r);if(Object.entries(d).forEach(([A,E])=>Ha(A,E)),S.time.day=1,S.time.month=1,S.time.year=Rp(),S.time.weather="Clear",e.season){S.time.season=e.season;const A=Jd(e.season);(T=A.months)!=null&&T.length&&(S.time.month=A.months[0])}else S.time.season=kl(S.time.month);tu(),c?cc("loc1",c,S.time.season,e.seed,l):S.locations.size===0&&cc("loc1","temperate-broadleaf",S.time.season,e.seed,l);const u=e.spawn||{},m=Number.isFinite(u.x)?Math.trunc(u.x):0,h=Number.isFinite(u.y)?Math.trunc(u.y):0;S.player={locationId:"loc1",x:m,y:h,jobId:"survey"},zd({id:"basic-tools",name:"Basic Tools"}),ds(),S.difficulty=t,S.worldSettings=l,S.craftTargets=new Map,S.buildQueue=0,S.haulQueue=0,Yb(),S.eventLog=[];const p=[...S.locations.values()][0],w=Oh(1,(p==null?void 0:p.biome)||"temperate-broadleaf");Ha("wood",w),er();const x=document.getElementById("setup");x&&(x.style.display="none");const C=document.querySelector(".create-steps"),M=document.getElementById("create-step-content");C instanceof HTMLElement&&(C.style.display="none"),M instanceof HTMLElement&&(M.style.display="none"),mf(),ff()}async function hd(){if(Bb(M0,S0,()=>{dh(),window.location.reload()},Ky,p0,C0,uf,k0,E0,T0),document.getElementById("content"),Lb(),!await ch()){Mb(A0);return}const t=document.getElementById("setup");t&&(t.style.display="none");const n=document.querySelector(".create-steps"),r=document.getElementById("create-step-content");n instanceof HTMLElement&&(n.style.display="none"),r instanceof HTMLElement&&(r.style.display="none"),mf(),ff()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{hd()}):hd();window.Game={store:S,saveGame:er};
