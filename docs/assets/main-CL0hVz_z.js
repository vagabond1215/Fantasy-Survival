import{g as Mr,a as ou,b as qa,c as iu}from"./biomeWildlife-mBoYh2ch.js";const al="survey";function au(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;if(e instanceof Date){const t=e.getTime();return Number.isFinite(t)?t:null}if(typeof e=="string"&&e.trim()){const t=Date.parse(e);return Number.isFinite(t)?t:null}return null}function Wa(e,t){const n=t&&typeof t=="object"?t:{},r=e||n.id?String(e||n.id):null;if(!r)return null;const o=n.unlocked===!0||n.status==="unlocked"||!("unlocked"in n)&&!!(n.discovered||n.name),i=n.discovered===!0||o,a=Number.isFinite(n.progress)?Math.min(1,Math.max(0,n.progress)):o?1:0,d=n.label||n.name||r,l=au(n.unlockedAt??n.completedAt??null),c=typeof n.notes=="string"&&n.notes.trim()?n.notes:null;return{id:r,unlocked:o,discovered:i,progress:a,unlockedAt:l,label:d,notes:c}}function Br(e){return e?e instanceof Map?[...e.entries()]:Array.isArray(e)?e:typeof e=="object"?Object.entries(e):[]:[]}class su{constructor(){this.buildings=new Map,this.people=new Map,this.inventory=new Map,this.craftTargets=new Map,this.locations=new Map,this.technologies=new Map,this.proficiencies=new Map,this.player={locationId:null,x:0,y:0,jobId:al},this.time={day:1,month:1,year:410,hour:6,season:"Thawbound",weather:"Clear"},this.difficulty="normal",this.jobs={},this.orders=[],this.eventLog=[],this.orderSeq=0,this.unlockedBuildings=new Set,this.research=new Set,this.buildingSeq=0,this.gatherNodes=new Map,this.discoveredFauna=new Map,this.discoveredFlora=new Map,this.jobSettings={},this.jobDaily={},this.buildQueue=0,this.haulQueue=0,this.worldSettings=null}addItem(t,n){const r=n.id;if(!r){console.warn(`Missing id for ${t} item`,n);return}this[t].has(r)?console.warn(`Duplicate ${t} id ${r} ignored.`):this[t].set(r,n)}updateItem(t,n){const r=n.id;if(this[t].has(r)){const o=this[t].get(r);this[t].set(r,{...o,...n})}else console.warn(`Cannot update missing ${t} id ${r}.`)}getItem(t,n){return this[t].get(n)}serialize(){const t=[...this.technologies.entries()].map(([n,r])=>{const o=Wa(n,r);return o?[o.id,o]:null}).filter(Boolean);return{buildings:[...this.buildings.entries()],people:[...this.people.entries()],inventory:[...this.inventory.entries()],craftTargets:[...this.craftTargets.entries()],locations:[...this.locations.entries()],technologies:t,proficiencies:[...this.proficiencies.entries()],player:{...this.player},time:this.time,difficulty:this.difficulty,jobs:this.jobs,orders:this.orders,eventLog:this.eventLog,orderSeq:this.orderSeq,unlockedBuildings:[...this.unlockedBuildings],research:[...this.research],buildingSeq:this.buildingSeq,gatherNodes:[...this.gatherNodes.entries()],discoveredFauna:[...this.discoveredFauna.entries()].map(([n,r])=>[n,[...r]]),discoveredFlora:[...this.discoveredFlora.entries()].map(([n,r])=>[n,[...r]]),jobSettings:this.jobSettings,jobDaily:this.jobDaily,worldSettings:this.worldSettings}}deserialize(t){this.buildings=new Map(Br(t.buildings)),this.people=new Map(Br(t.people)),this.inventory=new Map(Br(t.inventory)),this.craftTargets=new Map(Br(t.craftTargets)),this.locations=new Map(Br(t.locations));const r=(Array.isArray(t.technologies)?t.technologies:t.technologies&&typeof t.technologies=="object"?Object.entries(t.technologies):[]).map(l=>{if(Array.isArray(l)&&l.length>=2){const c=Wa(l[0],l[1]);return c?[c.id,c]:null}if(l&&typeof l=="object"){const c=Wa(l.id,l);return c?[c.id,c]:null}return null}).filter(Boolean);this.technologies=new Map(r),this.proficiencies=new Map(Br(t.proficiencies));const o=t.player||{};this.player={locationId:o.locationId??null,x:Number.isFinite(o.x)?Math.trunc(o.x):0,y:Number.isFinite(o.y)?Math.trunc(o.y):0,jobId:typeof o.jobId=="string"&&o.jobId?o.jobId:al};const i=t.time||{};this.time={day:1,month:1,year:410,hour:6,season:"Thawbound",weather:"Clear",...i},this.difficulty=t.difficulty||"normal",this.jobs=t.jobs||{},this.orders=t.orders||[],this.eventLog=t.eventLog||[],this.orderSeq=t.orderSeq||0,this.unlockedBuildings=new Set(t.unlockedBuildings||[]),this.research=new Set(t.research||[]),this.buildingSeq=t.buildingSeq||0,this.gatherNodes=new Map(Br(t.gatherNodes)),this.jobSettings=t.jobSettings||{},this.jobDaily=t.jobDaily||{},this.worldSettings=t.worldSettings||null;const a=Array.isArray(t.discoveredFauna)?t.discoveredFauna:Object.entries(t.discoveredFauna||{});this.discoveredFauna=new Map(a.map(l=>{const[c,f]=l||[];return[c,new Set(f||[])]}));const d=Array.isArray(t.discoveredFlora)?t.discoveredFlora:Object.entries(t.discoveredFlora||{});this.discoveredFlora=new Map(d.map(l=>{const[c,f]=l||[];return[c,new Set(f||[])]}))}}const lu="WORLD_CONFIG_CHANGED",jt={biome:null,season:null,seed:null,difficulty:null,worldParameters:null},is=new Set;function bc(e){if(!e||typeof e!="object")return null;const{advanced:t,...n}=e;return{...n,advanced:t&&typeof t=="object"?{...t}:t??null}}function cu(e,t){if(e===t)return!0;if(!e||!t)return!e&&!t;const n=new Set([...Object.keys(e),...Object.keys(t)]);for(const a of n)if(a!=="advanced"&&(e[a]??null)!==(t[a]??null))return!1;const r=e.advanced&&typeof e.advanced=="object"?e.advanced:{},o=t.advanced&&typeof t.advanced=="object"?t.advanced:{},i=new Set([...Object.keys(r),...Object.keys(o)]);for(const a of i)if((r[a]??null)!==(o[a]??null))return!1;return!0}function Mo(){return{biome:jt.biome,season:jt.season,seed:jt.seed,difficulty:jt.difficulty,worldParameters:jt.worldParameters?bc(jt.worldParameters):null}}function du(){const e=Mo();is.forEach(t=>{try{t(e)}catch(n){console.error("Error in world config listener",n)}}),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(new CustomEvent(lu,{detail:e}))}function uu(e,t={}){if(typeof e!="function")return()=>{};if(is.add(e),t!=null&&t.immediate)try{e(Mo())}catch(n){console.error("Error in immediate world config listener",n)}return()=>is.delete(e)}function Yn(e={},t={}){if(!e||typeof e!="object")return Mo();const{silent:n=!1,force:r=!1}=t;let o=!1;if("biome"in e&&e.biome!==jt.biome&&(jt.biome=e.biome??null,o=!0),"season"in e&&e.season!==jt.season&&(jt.season=e.season??null,o=!0),"seed"in e&&e.seed!==jt.seed&&(jt.seed=e.seed??null,o=!0),"difficulty"in e&&e.difficulty!==jt.difficulty&&(jt.difficulty=e.difficulty??null,o=!0),"worldParameters"in e){const i=e.worldParameters?bc(e.worldParameters):null;cu(jt.worldParameters,i)||(jt.worldParameters=i,o=!0)}return(o||r)&&!n&&du(),Mo()}const C=new su,fu={primitive:"Primitive",bronze:"Bronze",iron:"Iron",steel:"Steel"};function sl(e=""){return String(e).split(/[^a-zA-Z0-9]+/).filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function pu(e){return Array.isArray(e)?e.map(t=>{if(!t)return null;if(typeof t=="string")return{item:t,quantity:1};if(typeof t=="object"){const n=t.item||t.id||t.name;if(!n)return null;const r=Number.isFinite(t.quantity)&&t.quantity>0?t.quantity:1;return{item:String(n),quantity:r}}return null}).filter(Boolean):[]}function Pt(e){if(!e||!e.id)throw new Error("Equipment entries must include an id.");const t=e.tier||"primitive",n=e.label||e.name||sl(e.id),r=e.tierLabel||fu[t]||sl(t);return Object.freeze({id:String(e.id),label:n,category:e.category||"tool",role:e.role||e.type||null,tier:t,tierLabel:r,icon:e.icon||"🎒",stats:e.stats||{},materials:pu(e.materials),durability:Number.isFinite(e.durability)?Math.max(1,Math.round(e.durability)):null,requiredTech:e.requiredTech||null})}const Ms=[Pt({id:"stone knife",label:"Stone Knife",category:"weapon",role:"blade",tier:"primitive",icon:"🔪",stats:{damage:3,utility:2},materials:["sharpened stone","cord","straight branch"],durability:25,requiredTech:"basic-tools"}),Pt({id:"wooden hammer",label:"Wooden Hammer",category:"tool",role:"hammer",tier:"primitive",icon:"🔨",stats:{damage:1,utility:3},materials:["seasoned wood","cord"],durability:40,requiredTech:"basic-tools"}),Pt({id:"stone hand axe",label:"Stone Hand Axe",category:"tool",role:"axe",tier:"primitive",icon:"🪓",stats:{damage:4,utility:3},materials:["sturdy haft stick","cord","sharpened stone"],durability:45,requiredTech:"basic-tools"}),Pt({id:"stone pick",label:"Stone Pick",category:"tool",role:"pick",tier:"primitive",icon:"⛏️",stats:{damage:3,utility:4},materials:["sturdy haft stick","cord","sharpened stone"],durability:40,requiredTech:"basic-tools"}),Pt({id:"bow",label:"Self Bow",category:"weapon",role:"bow",tier:"primitive",icon:"🏹",stats:{damage:5},materials:["seasoned wood","cord","plant fibers"],durability:55,requiredTech:"basic-tools"}),Pt({id:"wooden arrow",label:"Wooden Arrows",category:"weapon",role:"ammunition",tier:"primitive",icon:"🪶",stats:{damage:2},materials:["straight branch","stone knife","plant fibers"],durability:5,requiredTech:"basic-tools"}),Pt({id:"leather armor",label:"Leather Armor",category:"armor",role:"light-armor",tier:"primitive",icon:"🥋",stats:{protection:4},materials:["prepared hides","cord"],durability:65,requiredTech:"basic-tools"}),Pt({id:"bronze axe",label:"Bronze Axe",category:"tool",role:"axe",tier:"bronze",icon:"🪓",stats:{damage:6,utility:5},materials:[{item:"bronze ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:70,requiredTech:"bronze-smithing"}),Pt({id:"bronze pick",label:"Bronze Pick",category:"tool",role:"pick",tier:"bronze",icon:"⛏️",stats:{damage:5,utility:6},materials:[{item:"bronze ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:75,requiredTech:"bronze-smithing"}),Pt({id:"bronze scale armor",label:"Bronze Scale Armor",category:"armor",role:"medium-armor",tier:"bronze",icon:"🛡️",stats:{protection:7},materials:[{item:"bronze ingot",quantity:3},{item:"prepared hides",quantity:2},{item:"cord",quantity:1}],durability:90,requiredTech:"bronze-smithing"}),Pt({id:"iron axe",label:"Iron Axe",category:"tool",role:"axe",tier:"iron",icon:"🪓",stats:{damage:7,utility:7},materials:[{item:"iron ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:90,requiredTech:"iron-smithing"}),Pt({id:"iron pick",label:"Iron Pick",category:"tool",role:"pick",tier:"iron",icon:"⛏️",stats:{damage:6,utility:8},materials:[{item:"iron ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:95,requiredTech:"iron-smithing"}),Pt({id:"iron chainmail",label:"Iron Chainmail",category:"armor",role:"medium-armor",tier:"iron",icon:"🛡️",stats:{protection:10},materials:[{item:"iron ingot",quantity:4},{item:"prepared hides",quantity:2}],durability:120,requiredTech:"iron-smithing"}),Pt({id:"steel axe",label:"Steel Axe",category:"tool",role:"axe",tier:"steel",icon:"🪓",stats:{damage:8,utility:9},materials:[{item:"steel ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:110,requiredTech:"steel-smithing"}),Pt({id:"steel pick",label:"Steel Pick",category:"tool",role:"pick",tier:"steel",icon:"⛏️",stats:{damage:7,utility:10},materials:[{item:"steel ingot",quantity:2},{item:"cord",quantity:1},{item:"sturdy haft stick",quantity:1}],durability:115,requiredTech:"steel-smithing"}),Pt({id:"steel plate",label:"Steel Plate Armor",category:"armor",role:"heavy-armor",tier:"steel",icon:"🛡️",stats:{protection:14},materials:[{item:"steel ingot",quantity:5},{item:"leather armor",quantity:1}],durability:160,requiredTech:"steel-smithing"})],mu=new Map(Ms.map(e=>[e.id,e]));function hu(e={}){const{category:t,tier:n}=e||{};return Ms.filter(r=>!(t&&r.category!==t||n&&r.tier!==n))}function Ta(e){return e&&mu.get(String(e))||null}Object.freeze(Array.from(new Set(Ms.map(e=>e.tier))));function as(e=""){return String(e).split(/\s+/).filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function yc(e){const t=String(e);return{id:t,label:as(t),quantity:0,demand:0,supply:0,expectedChange:0,isEquipment:!1,category:"resource",tier:null,tierLabel:null,quality:null,qualityLabel:null,durability:null,stats:null,requiredTech:null}}function ii(e){if(!e)return e;const t=Ta(e.id),n={...e};return t?(n.label=t.label||n.label||as(n.id),n.isEquipment=!0,n.category=t.category||"equipment",n.tier=t.tier||null,n.tierLabel=t.tierLabel||null,n.quality=t.tier||null,n.qualityLabel=t.tierLabel||null,n.durability=t.durability??n.durability??null,n.stats=t.stats||n.stats||null,n.requiredTech=t.requiredTech||n.requiredTech||null):(n.label=n.label||as(n.id),n.isEquipment=!1,n.category="resource",n.tier=null,n.tierLabel=null,n.quality=null,n.qualityLabel=null,n.durability=null,n.stats=null,n.requiredTech=null),n}function wc(e){const t=C.getItem("inventory",e.id);t?C.updateItem("inventory",{...t,...e}):C.addItem("inventory",e)}function xc(e){const t=C.getItem("inventory",e);return ii(t?{...t}:yc(e))}function vc(e){const t=Number.isFinite(e.supply)?e.supply:0,n=Number.isFinite(e.demand)?e.demand:0;e.expectedChange=Math.round((t-n)*100)/100,e.supply=t,e.demand=n}function sa(e,t=0){const n=xc(e);n.quantity=Math.max(0,(n.quantity||0)+t),vc(n),wc(n)}function ci(e){const t=C.getItem("inventory",e);return ii(t?{...t}:yc(e))}function gu(e,{supply:t=0,demand:n=0}={}){const r=xc(e);r.supply=t,r.demand=n,vc(r),wc(r)}function Sc(){return Array.from(C.inventory.values()).map(e=>ii({...e}))}const kc=[{id:"basic-tools",name:"Basic Tools",category:"Woodworking",order:10,description:"Stone and bone implements along with cordage techniques that let settlers work timber and hides reliably.",prerequisites:[],cost:{research:25,materials:{"plant fibers":12,cord:6,"sharpened stone":4}},effects:{description:"Unlocks foundational woodworking structures, recipes, and primitive gear.",unlocks:{buildings:["drying-rack","hunter-blind","workshop","smokehouse","longhouse","watchtower"],recipes:["cord","sharpened-stone","prepared-hides","seasoned-wood","rendered-tallow","grain-flour","hearty-stew","traveler-flatbread","herbal-porridge","smoke-cured-provisions","pickled-vegetables","aromatic-sachets","herbal-poultice","restorative-tonic","soothing-salve","arrow-bundle","stone-hand-axe","stone-pick"],equipment:["stone knife","wooden hammer","stone hand axe","stone pick","bow","wooden arrow","leather armor"],technologies:[]}}},{id:"metalworking-basics",name:"Metalworking Basics",category:"Metalworking",order:20,description:"Clay forges, bellows, and charcoal production that allow smiths to shape soft metals.",prerequisites:["basic-tools"],cost:{research:80,materials:{charcoal:12,clay:10,"crafted goods":4}},effects:{description:"Opens the path toward bronze alloys and improved forging stations.",unlocks:{technologies:["bronze-smithing"],recipes:[],buildings:[],equipment:[]}}},{id:"bronze-smithing",name:"Bronze Smithing",category:"Metalworking",order:30,description:"Copper and tin alloys hammered into resilient edges and scales.",prerequisites:["metalworking-basics"],cost:{research:120,materials:{"bronze ingot":4,charcoal:8}},effects:{description:"Enables bronze tools, armor, and the knowledge required to tackle harder metals.",unlocks:{technologies:["iron-smithing"],recipes:["bronze-ingot","bronze-axe","bronze-pick"],buildings:[],equipment:["bronze axe","bronze pick","bronze scale armor"]}}},{id:"iron-smithing",name:"Iron Smithing",category:"Metalworking",order:40,description:"Bloom refining, quenching, and tempering techniques for wrought iron.",prerequisites:["bronze-smithing"],cost:{research:160,materials:{"iron ingot":4,charcoal:12}},effects:{description:"Unlocks ironwork recipes and arms the settlement with tougher implements.",unlocks:{technologies:["steel-smithing"],recipes:["iron-ingot","iron-axe","iron-pick"],buildings:[],equipment:["iron axe","iron pick","iron chainmail"]}}},{id:"steel-smithing",name:"Steel Smithing",category:"Metalworking",order:50,description:"High-heat furnaces, folding, and oil quenching that create elite steel arms and armor.",prerequisites:["iron-smithing"],cost:{research:220,materials:{"steel ingot":4,charcoal:16}},effects:{description:"Completes the smithing ladder with access to superior weapons and armor.",unlocks:{technologies:[],recipes:["steel-ingot","steel-axe","steel-pick"],buildings:[],equipment:["steel axe","steel pick","steel plate"]}}},{id:"defense-drills",name:"Defense Drills",category:"Fortifications",order:60,description:"Coordinated watches, signal calls, and militia routines to hold the palisade.",prerequisites:["basic-tools"],cost:{research:100,materials:{"crafted goods":6,firewood:40}},effects:{description:"Strengthens vigilance and readies the village for broader alliances.",unlocks:{technologies:["regional-alliance"],recipes:[],buildings:[],equipment:[]}}},{id:"regional-alliance",name:"Regional Alliance",category:"Fortifications",order:70,description:"Treaties, signal braziers, and trade obligations with neighboring strongholds.",prerequisites:["defense-drills"],cost:{research:180,materials:{"crafted goods":8,preservedFood:20}},effects:{description:"Broadens diplomacy, bringing aid and prestige to the settlement.",unlocks:{technologies:[],recipes:[],buildings:[],equipment:[]}}}];function bu(){return kc.map(e=>({...e}))}function yu(e){if(!e&&e!==0)return null;const t=String(e);return kc.find(n=>n.id===t)||null}const Yr=new Map;let ll=!1;function Cc(){const e=C.technologies;return e instanceof Map?e:Array.isArray(e)?(C.technologies=new Map(e),C.technologies):e&&typeof e=="object"?(C.technologies=new Map(Object.entries(e)),C.technologies):(C.technologies=new Map,C.technologies)}function Mc(e){return!Number.isFinite(e)||e<=0?0:e>=1?1:e}function Ec(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;if(e instanceof Date){const t=e.getTime();return Number.isFinite(t)?t:null}if(typeof e=="string"&&e.trim()){const t=Date.parse(e);return Number.isFinite(t)?t:null}return null}function Es(e){var a,d;if(!(e!=null&&e.id))return null;const t=String(e.id);if(Yr.has(t))return Yr.get(t);const n=Array.isArray(e.prerequisites)?e.prerequisites.filter(Boolean).map(l=>String(l)):[],r=e.cost?{research:Number.isFinite(e.cost.research)?Math.max(0,e.cost.research):null,materials:e.cost.materials?{...e.cost.materials}:{}}:null,o=((a=e.effects)==null?void 0:a.unlocks)||{},i={id:t,name:e.name||t,category:e.category||null,description:e.description||"",order:Number.isFinite(e.order)?e.order:0,prerequisites:n,cost:r,effects:{description:((d=e.effects)==null?void 0:d.description)||"",unlocks:{technologies:Array.isArray(o.technologies)?o.technologies.map(l=>String(l)):[],recipes:Array.isArray(o.recipes)?o.recipes.map(l=>String(l)):[],buildings:Array.isArray(o.buildings)?o.buildings.map(l=>String(l)):[],equipment:Array.isArray(o.equipment)?o.equipment.map(l=>String(l)):[]}}};return Yr.set(t,i),i}function Ts(e,t={}){const n=t&&typeof t=="object"?t:{},r=n.unlocked===!0,o=n.discovered===!0||r,i=Mc(Number.isFinite(n.progress)?n.progress:r?1:0),a=typeof n.label=="string"&&n.label.trim()?n.label:typeof n.name=="string"&&n.name.trim()?n.name:e.name,d=Ec(n.unlockedAt),l=typeof n.notes=="string"&&n.notes.trim()?n.notes:null;return{id:e.id,unlocked:r,discovered:o,progress:i,unlockedAt:d,label:a,notes:l}}function As(e,t={}){const n=t&&typeof t=="object"?t:{},r=n.unlocked===!0||!("unlocked"in n)&&!!n.name,o=n.discovered===!0||r,i=Mc(Number.isFinite(n.progress)?n.progress:r?1:0),a=typeof n.label=="string"&&n.label.trim()?n.label:typeof n.name=="string"&&n.name.trim()?n.name:String(e),d=Ec(n.unlockedAt),l=typeof n.notes=="string"&&n.notes.trim()?n.notes:null;return{id:String(e),unlocked:r,discovered:o,progress:i,unlockedAt:d,label:a,notes:l}}function wu(){const e=Cc(),t=new Map;Yr.forEach(n=>{const r=e.get(n.id),o=Ts(n,r||{id:n.id});t.set(n.id,o)}),e.forEach((n,r)=>{if(t.has(r))return;const o=As(r,n||{id:r});t.set(r,o)}),e.clear(),t.forEach((n,r)=>{e.set(r,n)})}function Jr(){ll||(bu().forEach(e=>{Es(e)}),ll=!0),wu()}function Aa(e){if(!e&&e!==0)return null;const t=String(e);if(Yr.has(t))return Yr.get(t);const n=yu(t);return n?Es(n):null}function Na(e){const t=String(e),n=Cc();if(!n.has(t)){const r=Aa(t),o=r?Ts(r,{}):As(t,{id:t});n.set(t,o)}return n.get(t)}function Tc(e,t={}){Jr();const n=typeof e=="string"||typeof e=="number"?e:e==null?void 0:e.id;if(!n&&n!==0)return null;const r=String(n),o=Aa(r)||(typeof e=="object"?Es(e):null),i=Na(r),a=Number.isFinite(t.unlockedAt)?t.unlockedAt:Date.now(),d={...i,...typeof e=="object"?e:{},id:r,unlocked:!0,discovered:!0,progress:1,unlockedAt:(i==null?void 0:i.unlockedAt)??a,label:typeof e=="object"&&(e==null?void 0:e.name)||(i==null?void 0:i.label)||(o==null?void 0:o.name)||r},l=o?Ts(o,d):As(r,d);return l.unlocked=!0,l.discovered=!0,l.progress=1,l.unlockedAt||(l.unlockedAt=a),C.technologies.set(r,l),l}function yn(e){if(!e&&e!==0)return!1;Jr();const t=Na(e);return!!(t!=null&&t.unlocked)}function xu(e){if(!e&&e!==0)return null;Jr();const t=String(e),n=Aa(t),r=Na(t),o=(n==null?void 0:n.prerequisites)||[],i=o.filter(a=>!yn(a));return{id:t,definition:n||null,state:r,unlocked:!!(r!=null&&r.unlocked),discovered:!!(r!=null&&r.discovered),prerequisites:o,missingPrerequisites:i,available:!!(r&&!r.unlocked&&i.length===0)}}function vu(){Jr();const e=[];return Yr.forEach(t=>{const n=Na(t.id),r=t.prerequisites.filter(o=>!yn(o));e.push({id:t.id,definition:t,state:n,unlocked:!!(n!=null&&n.unlocked),discovered:!!(n!=null&&n.discovered),available:!(n!=null&&n.unlocked)&&r.length===0,prerequisites:[...t.prerequisites],missingPrerequisites:r})}),e.sort((t,n)=>{const r=Number.isFinite(t.definition.order)?t.definition.order:0,o=Number.isFinite(n.definition.order)?n.definition.order:0;return r!==o?r-o:t.definition.name.localeCompare(n.definition.name)})}function la(e){if(!e&&e!==0)return"";const t=String(e),n=Aa(t);if(n!=null&&n.name)return n.name;const r=C.technologies instanceof Map?C.technologies.get(t):null;return r!=null&&r.label?r.label:t.split(/[-_]/).filter(Boolean).map(o=>o.charAt(0).toUpperCase()+o.slice(1)).join(" ")}Jr();const Ac=Object.freeze(["open","grassland","plains","savanna","tundra","taiga","desert","sand","wetland","coast","temperate","tropical","rainforest","jungle","alpine"]),Su=new Set(Ac);function wr(e){return e?Su.has(String(e).toLowerCase()):!1}function Nc(e){if(!e)return"open";const t=typeof e.openTerrainId=="string"?e.openTerrainId.toLowerCase():"";return t&&wr(t)?t:"open"}function ku(e=[]){if(!Array.isArray(e)||!e.length)return e;const t=e.map(o=>String(o||"").toLowerCase());if(!t.includes("open"))return e;const n=Ac.filter(o=>o!=="open"),r=new Set;return t.forEach(o=>{o&&o!=="open"&&r.add(o)}),n.forEach(o=>r.add(o)),r.add("open"),Array.from(r)}const Cu=[{id:"lean-to",name:"Lean-to Shelter",icon:"⛺",category:"Shelter",description:"A quick shelter made from flexible saplings and a sloped roof. Offers basic protection from the elements.",allowMultiple:!0,unlock:{always:!0},requirements:{minBuilders:1,locationTags:["forest","grove"],site:{category:"forest",dimensions:{width:3.6,depth:2.1},accessClearance:{front:2.4,back:.6,left:.6,right:.6}},craftedGoods:{cord:8}},effects:{occupancy:2,comfort:1,survivability:1,demand:{firewood:-.1}},components:[{id:"foundation",name:"Ground Preparation",description:"Clear debris and level the sleeping surface, laying a base of small stones for drainage.",laborHours:4,minBuilders:1,resources:{"small stones":12,pebbles:20}},{id:"main-supports",name:"Ridge Frame & Lashings",description:"Raise forked poles and lash the ridge beam that anchors the shelter.",laborHours:6,minBuilders:1,isCore:!0,resources:{firewood:28,"plant fibers":12,cord:4}},{id:"roof",name:"Weather Shed Cover",description:"Lay overlapping boughs down the leeward slope and extend a front overhang for access.",laborHours:5,minBuilders:1,resources:{firewood:18,"plant fibers":16,cord:4}}],addons:[{id:"windbreak",name:"Windbreak Walls",description:"Add woven branch walls to shield against prevailing winds.",effects:{comfort:1,demand:{firewood:-.05}},laborHours:3,minBuilders:1,resources:{firewood:12,"plant fibers":8,cord:2}},{id:"raised-bed",name:"Raised Sleeping Platform",description:"Lift sleepers off damp ground using a lashed frame.",effects:{comfort:1},laborHours:4,minBuilders:1,resources:{firewood:10,"plant fibers":6,cord:2,"crafted goods":1}}]},{id:"crop-field",name:"Tended Crop Field",icon:"🌾",category:"Agriculture",description:"Tilled plots bordered by windbreaks and irrigation furrows that turn open ground into dependable harvests.",allowMultiple:!0,unlock:{buildings:[{id:"fire-pit",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["meadow","grassland","open"],site:{category:"cleared",dimensions:{width:12,depth:18},accessClearance:{front:3,back:2,left:2,right:2}},craftedGoods:{cord:18,"crafted goods":4}},effects:{supply:{grain:6,"root vegetables":4,herbs:1},demand:{"crafted goods":.6},jobs:{farm:3}},components:[{id:"clearing",name:"Brush Clearing & Stumping",description:"Pull stones, roots, and brush then mound field borders against erosion.",laborHours:10,minBuilders:3,isCore:!0,resources:{firewood:80,"small stones":40,pebbles:60,"plant fibers":24,cord:8}},{id:"furrows",name:"Tilling & Furrows",description:"Turn the topsoil, lay drainage trenches, and stake crop rows.",laborHours:9,minBuilders:2,resources:{firewood:36,pebbles:30,"plant fibers":20,cord:6,"crafted goods":2}},{id:"irrigation",name:"Irrigation Channels",description:"Line feeder ditches with stone and wattle spillways for steady watering.",laborHours:8,minBuilders:2,resources:{"small stones":50,pebbles:70,firewood:24,"plant fibers":18,cord:4}},{id:"windbreaks",name:"Windbreak Fencing",description:"Plant woven hurdles and saplings along the prevailing wind edge.",laborHours:6,minBuilders:2,resources:{firewood:48,"plant fibers":22,cord:6}}],addons:[{id:"seed-house",name:"Seed Shelter",description:"Add a small covered bin to keep seed stores dry and pest free.",effects:{storage:{grain:80,seeds:40}},laborHours:4,minBuilders:1,resources:{firewood:24,"small stones":20,"plant fibers":12,cord:4,"crafted goods":1}}]},{id:"animal-pen",name:"Timber Animal Pen",icon:"🐑",category:"Agriculture",description:"Fenced paddock with troughs and lean-tos for managing herds or work beasts.",allowMultiple:!0,unlock:{buildings:[{id:"crop-field",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["meadow","grassland","open"],site:{category:"cleared",dimensions:{width:10,depth:14},accessClearance:{front:3,back:2,left:2,right:2}},craftedGoods:{cord:22,"crafted goods":3}},effects:{supply:{food:3,hides:.8,"animal fat":.4},demand:{grain:1.5,water:2},jobs:{herd:2}},components:[{id:"postholes",name:"Postholes & Stone Footings",description:"Auger postholes and tamp stone collars to keep the fence upright.",laborHours:8,minBuilders:3,isCore:!0,resources:{"small stones":60,pebbles:70,firewood:40,"plant fibers":16,cord:6}},{id:"fencing",name:"Woven Fencing",description:"Weave rails and saplings into tight hurdles and double gates.",laborHours:9,minBuilders:2,resources:{firewood:96,"plant fibers":40,cord:12}},{id:"shelters",name:"Lean-to Shelters",description:"Raise timber sheds with thatched roofs for sick bays and shade.",laborHours:7,minBuilders:2,resources:{firewood:84,"plant fibers":32,cord:10,"crafted goods":2}},{id:"watering",name:"Troughs & Drainage",description:"Carve log troughs, stone the muddiest ground, and drain wallows.",laborHours:5,minBuilders:1,resources:{firewood:24,"small stones":30,pebbles:40,"crafted goods":1}}],addons:[{id:"milking-bay",name:"Milking Bay",description:"Build a narrow chute and stanchions for safer milking.",effects:{supply:{food:1,milk:1}},laborHours:4,minBuilders:1,resources:{firewood:28,"plant fibers":14,cord:4,"crafted goods":1}}]},{id:"granary",name:"Raised Granary",icon:"🏚️",category:"Storage",description:"Elevated grain house with ventilation floors that guards stores from damp and vermin.",allowMultiple:!0,unlock:{buildings:[{id:"crop-field",count:2}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["meadow","hill","open"],site:{category:"cleared",dimensions:{width:6,depth:8},accessClearance:{front:2.5,back:2,left:2,right:2}},craftedGoods:{cord:20,"crafted goods":5}},effects:{survivability:2,demand:{"crafted goods":.3},storage:{grain:400,food:120,seeds:80}},components:[{id:"footings",name:"Stone Piers",description:"Set squat stone pillars and pad stones to lift the floor clear of pests.",laborHours:7,minBuilders:3,isCore:!0,resources:{"small stones":90,pebbles:100,"crafted goods":1}},{id:"floor",name:"Slatted Subfloor",description:"Lay tight slats and woven reed mats that breathe without spilling grain.",laborHours:6,minBuilders:2,resources:{firewood:70,"plant fibers":34,cord:10,"crafted goods":2}},{id:"walls",name:"Boarded Walls",description:"Raise plank walls with rat guards and shingled ventilation shutters.",laborHours:7,minBuilders:2,resources:{firewood:90,"plant fibers":28,cord:8,"crafted goods":1}},{id:"roof",name:"Steep Thatch Roof",description:"Build a steep pitch roof and ridge vent to shed rain and heat.",laborHours:6,minBuilders:2,resources:{firewood:60,"plant fibers":40,cord:8}}],addons:[{id:"drying-floor",name:"Drying Loft",description:"Suspend removable lattice floors for drying herbs and seed heads.",effects:{supply:{preservedFood:1},storage:{herbs:60}},laborHours:4,minBuilders:1,resources:{firewood:32,"plant fibers":18,cord:4}}]},{id:"fire-pit",name:"Stone Fire Pit",icon:"🔥",category:"Utility",description:"Central hearth used for cooking and warmth. Concentrates heat and reduces smoke drift.",allowMultiple:!1,unlock:{always:!0},requirements:{minBuilders:1,locationTags:["forest","grove","meadow","open"],site:{categories:["forest","cleared"],dimensions:{width:1.8,depth:1.8},accessClearance:{front:1.8,back:1.8,left:1.8,right:1.8}},craftedGoods:{"crafted goods":2}},effects:{comfort:1,supply:{cookedMeals:1.5,"hearty meal":1,"bone broth":.5,"comfort meal":.5},demand:{food:-.5,grain:-.2,"root vegetables":-.2,salt:-.1,spices:-.05},survivability:1},components:[{id:"foundation",name:"Fire Ring Base",description:"Excavate a shallow basin and line it with gravel for drainage.",laborHours:3,minBuilders:1,isCore:!0,resources:{pebbles:30}},{id:"walls",name:"Stone Ring",description:"Stack fist-sized stones to contain the fire.",laborHours:4,minBuilders:1,resources:{"small stones":40}},{id:"fireplace",name:"Cooking Grate",description:"Fashion a simple grate for pots and skewers.",laborHours:2,minBuilders:1,resources:{"crafted goods":2}}],addons:[{id:"smoke-hood",name:"Smoke Hood",description:"Channel smoke upward using lashed poles and hides.",effects:{comfort:1},laborHours:3,minBuilders:1,resources:{firewood:12,"plant fibers":6,cord:2,hides:1}},{id:"stone-benches",name:"Stone Benches",description:"Arrange stone seats around the fire for gathering.",effects:{appeal:1},laborHours:2,minBuilders:1,resources:{"small stones":16}}]},{id:"drying-rack",name:"Drying Rack",icon:"🪵",category:"Production",description:"Elevated framework to dry hides, herbs, and meat, reducing spoilage.",allowMultiple:!0,unlock:{technologies:["basic-tools"]},requirements:{minBuilders:1,locationTags:["meadow","shore","open"],site:{category:"cleared",dimensions:{width:3,depth:1.8},accessClearance:{front:1.2,back:1.2,left:1,right:1}},craftedGoods:{cord:9,"crafted goods":1}},effects:{supply:{preservedFood:1,hides:.5,"smoked provisions":1,"preserved vegetables":.5,"herbal poultice":.3,"aromatic sachet":.2},demand:{food:-.2,salt:-.2,spices:-.1,herbs:-.1},capacity:{storage:40}},components:[{id:"stilts",name:"Support Stilts",description:"Set four sturdy posts to lift the rack clear of pests.",laborHours:4,minBuilders:1,isCore:!0,resources:{firewood:22,"plant fibers":8,cord:3}},{id:"crossbeams",name:"Crossbeams & Lashings",description:"Lash horizontal beams and lattice for hanging materials.",laborHours:5,minBuilders:1,resources:{firewood:16,"plant fibers":12,cord:4,"crafted goods":1}},{id:"roof",name:"Rain Cover",description:"Stretch hides or woven mats as a simple roof.",laborHours:3,minBuilders:1,resources:{hides:1,firewood:6,"plant fibers":10,cord:2}}],addons:[{id:"smoke-channel",name:"Smoke Channel",description:"Direct smoke from a nearby fire to improve preservation.",effects:{supply:{preservedFood:.5}},laborHours:2,minBuilders:1,resources:{firewood:8,"plant fibers":6,cord:2,"crafted goods":1}}]},{id:"hunter-blind",name:"Hunter's Blind",icon:"🏹",category:"Production",description:"Concealed elevated post to improve hunting success and safety.",allowMultiple:!0,unlock:{technologies:["basic-tools"],buildings:[{id:"lean-to",count:1}]},requirements:{minBuilders:2,locationTags:["forest"],site:{category:"forest",dimensions:{width:2.4,depth:2.4},accessClearance:{front:1.8,back:1.2,left:1.5,right:1.5}},craftedGoods:{cord:14,"crafted goods":2}},effects:{supply:{food:1.5,hides:.5},survivability:1,appeal:1},components:[{id:"foundation",name:"Footings & Bracing",description:"Drive support poles deep and brace against sway.",laborHours:6,minBuilders:2,isCore:!0,resources:{firewood:36,"small stones":12,"plant fibers":10,cord:4}},{id:"floor",name:"Platform Floor",description:"Lay planks and lashings to create a stable perch.",laborHours:5,minBuilders:2,resources:{firewood:24,"plant fibers":12,cord:4,"crafted goods":2}},{id:"walls",name:"Camouflaged Walls",description:"Weave brush and hides for concealment.",laborHours:4,minBuilders:1,resources:{hides:1,firewood:12,"plant fibers":14,cord:4}},{id:"roof",name:"Weatherproof Roof",description:"Slope the roof to shed rain and snow.",laborHours:3,minBuilders:1,resources:{firewood:10,"plant fibers":8,cord:2}}],addons:[{id:"ladder",name:"Reinforced Ladder",description:"Add a safer, sturdier ladder for quick access.",effects:{safety:1},laborHours:2,minBuilders:1,resources:{firewood:10,"plant fibers":6,cord:2}}]},{id:"workshop",name:"Crafter's Workshop",icon:"🛠️",category:"Production",description:"Covered workspace with benches and tool storage that boosts crafting output.",allowMultiple:!0,unlock:{buildings:[{id:"fire-pit",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["meadow","open"],site:{category:"cleared",dimensions:{width:6,depth:8},accessClearance:{front:2.5,back:2,left:1.5,right:1.5}},craftedGoods:{cord:16,"crafted goods":7}},effects:{supply:{"crafted goods":2},comfort:1,maxWorkers:2},components:[{id:"foundation",name:"Leveled Pad",description:"Lay compacted earth and stone to level the workspace.",laborHours:6,minBuilders:2,isCore:!0,resources:{"small stones":30,pebbles:40}},{id:"main-supports",name:"Timber Frame",description:"Raise sturdy posts and beams to support the roof.",laborHours:8,minBuilders:3,resources:{firewood:70,"plant fibers":24,cord:6,"crafted goods":4}},{id:"walls",name:"Half Walls & Storage",description:"Add waist-high walls with shelving and tool pegs.",laborHours:6,minBuilders:2,resources:{firewood:48,"plant fibers":20,cord:6,"crafted goods":3}},{id:"roof",name:"Shingled Roof",description:"Install a plank and bark roof to keep workers dry.",laborHours:7,minBuilders:2,resources:{firewood:36,"plant fibers":16,cord:4}}],addons:[{id:"forge",name:"Charcoal Forge",description:"Adds a clay-lined forge for metalworking research.",effects:{unlocks:["metalworking-basics"],supply:{"crafted goods":1}},laborHours:6,minBuilders:2,resources:{"small stones":24,firewood:36,"plant fibers":10,cord:4,"crafted goods":3}}]},{id:"cookhouse",name:"Communal Cookhouse",icon:"🍲",category:"Food Production",description:"Ventilated kitchen with racks, smoke flues, and work tables for preserving harvests at scale.",allowMultiple:!0,unlock:{buildings:[{id:"fire-pit",count:1},{id:"drying-rack",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["river","lake","shore","meadow","open"],site:{category:"cleared",dimensions:{width:6,depth:10},accessClearance:{front:3,back:2,left:2,right:2}},craftedGoods:{cord:26,"crafted goods":6}},effects:{supply:{cookedMeals:4,"hearty meal":2,"comfort meal":1,preservedFood:1},demand:{food:6,firewood:3,herbs:1,salt:.6,spices:.3},jobs:{cook:2}},components:[{id:"foundation",name:"Stone Hearth Floor",description:"Lay a mortared stone pad with drainage trenches to contain spills.",laborHours:8,minBuilders:3,isCore:!0,resources:{"small stones":120,pebbles:120,clay:30}},{id:"smokehall",name:"Smoke Hall Framing",description:"Raise stout posts and beams with smoke baffles and storage lofts.",laborHours:9,minBuilders:3,resources:{firewood:140,"plant fibers":48,cord:12,"crafted goods":3}},{id:"prep-benches",name:"Prep Benches & Racks",description:"Install butcher blocks, hanging hooks, and sloped drying racks.",laborHours:7,minBuilders:2,resources:{firewood:80,"plant fibers":26,cord:6,"crafted goods":2}},{id:"chimney",name:"Chimney & Ventilation",description:"Build a clay flue, smoke hoods, and shutters to control draft.",laborHours:6,minBuilders:2,resources:{clay:24,"small stones":60,pebbles:80,"crafted goods":2}}],addons:[{id:"cellar",name:"Cold Cellar",description:"Dig a root cellar with plank shelving beneath the cookhouse.",effects:{storage:{food:160,preservedFood:120},survivability:1},laborHours:6,minBuilders:2,resources:{"small stones":90,pebbles:100,firewood:40,"crafted goods":2}}]},{id:"smithy",name:"Charcoal Smithy",icon:"⚒️",category:"Production",description:"Forge house with bellows, anvils, and quenching troughs for shaping bronze and iron.",allowMultiple:!0,unlock:{buildings:[{id:"workshop",count:1}],technologies:["metalworking-basics"]},requirements:{minBuilders:4,locationTags:["stone","ore","cliff","ridge"],site:{category:"cleared",dimensions:{width:7,depth:9},accessClearance:{front:3,back:2.5,left:2,right:2}},craftedGoods:{cord:28,"crafted goods":8}},effects:{supply:{"crafted goods":3,"bronze ingot":1},demand:{"raw ore":2,charcoal:2,firewood:1},jobs:{smith:2},storage:{"raw ore":160,charcoal:120}},components:[{id:"foundation",name:"Stone Forge Pad",description:"Excavate and lay a heatproof stone slab with drainage and slag pit.",laborHours:9,minBuilders:4,isCore:!0,resources:{"small stones":140,pebbles:160,clay:40}},{id:"forge",name:"Forge & Chimney",description:"Brick a double forge, install tuyères, and build a high draft chimney.",laborHours:10,minBuilders:3,resources:{clay:60,"small stones":80,pebbles:120,charcoal:40,"crafted goods":4}},{id:"workbay",name:"Work Bays & Anvils",description:"Set heavy timbers, hanging racks, quench troughs, and tool chests.",laborHours:8,minBuilders:3,resources:{firewood:120,"plant fibers":36,cord:10,"crafted goods":4}},{id:"roof",name:"Ventilated Roof",description:"Raise a steep roof with smoke shutters and weatherproof shakes.",laborHours:7,minBuilders:2,resources:{firewood:90,"plant fibers":30,cord:8}}],addons:[{id:"bellows",name:"Twin Bellows",description:"Install counterweighted bellows and crank shafts for constant airflow.",effects:{supply:{"crafted goods":1}},laborHours:5,minBuilders:2,resources:{firewood:36,"plant fibers":18,cord:6,"crafted goods":2}}]},{id:"smokehouse",name:"Smokehouse",icon:"🍖",category:"Production",description:"Enclosed smoking hut that preserves large batches of meat and fish.",allowMultiple:!0,unlock:{buildings:[{id:"drying-rack",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["river","lake","shore","open"],site:{category:"cleared",dimensions:{width:4.2,depth:4.2},accessClearance:{front:3,back:1.5,left:1.5,right:1.5}},craftedGoods:{cord:15,"crafted goods":4}},effects:{supply:{preservedFood:4},demand:{food:-1,firewood:.5},comfort:1},components:[{id:"foundation",name:"Stone Footing",description:"Create a sealed stone base to contain smoke.",laborHours:8,minBuilders:3,isCore:!0,resources:{"small stones":60,pebbles:60}},{id:"walls",name:"Log Walls",description:"Stack logs and seal gaps with mud and moss.",laborHours:9,minBuilders:3,resources:{firewood:140,"plant fibers":30,cord:8}},{id:"roof",name:"Conical Vent Roof",description:"Construct a vented roof to draw smoke upward.",laborHours:7,minBuilders:2,resources:{firewood:46,"plant fibers":20,cord:4}},{id:"fireplace",name:"Fire Chamber & Racks",description:"Build a separate fire chamber and install hanging racks.",laborHours:6,minBuilders:2,resources:{firewood:24,"plant fibers":10,cord:3,"crafted goods":4}}],addons:[{id:"salt-bins",name:"Salt Storage Bins",description:"Add sealed bins for brining meats before smoking.",effects:{supply:{preservedFood:1},storage:{salt:50}},laborHours:4,minBuilders:1,resources:{firewood:16,"plant fibers":8,cord:2,"crafted goods":1}}]},{id:"longhouse",name:"Longhouse",icon:"🏠",category:"Shelter",description:"Large communal dwelling with raised bunks, central hearth, and smoke vents.",allowMultiple:!0,unlock:{buildings:[{id:"lean-to",count:2},{id:"fire-pit",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:4,locationTags:["meadow","open"],site:{category:"cleared",dimensions:{width:8,depth:24},accessClearance:{front:3,back:3,left:2.5,right:2.5}},craftedGoods:{cord:66,"crafted goods":13}},effects:{occupancy:12,comfort:3,survivability:2,demand:{firewood:-.5},maxWorkers:2},components:[{id:"foundation",name:"Raised Timber Floor",description:"Set heavy sills on stone footings to lift the structure.",laborHours:12,minBuilders:4,isCore:!0,resources:{firewood:200,"small stones":40,"plant fibers":40,cord:12}},{id:"main-supports",name:"Central Beams & Arches",description:"Erect tall arches and ridge poles for the expansive roof.",laborHours:14,minBuilders:4,resources:{firewood:240,"plant fibers":60,cord:16,"crafted goods":6}},{id:"walls",name:"Planked Walls & Doors",description:"Install plank walls, smoke shutters, and wide doors.",laborHours:12,minBuilders:3,resources:{firewood:180,"plant fibers":55,cord:14,"crafted goods":4}},{id:"roof",name:"Thatch & Beam Roof",description:"Layer thatch over beams with adjustable smoke vents.",laborHours:11,minBuilders:3,resources:{firewood:120,"plant fibers":80,cord:20,"crafted goods":3}},{id:"fireplace",name:"Central Hearths",description:"Construct two large hearths with stone surrounds.",laborHours:8,minBuilders:2,resources:{"small stones":80,pebbles:120,firewood:40,"plant fibers":10,cord:4}}],addons:[{id:"privacy-screens",name:"Privacy Screens",description:"Hang woven partitions for family spaces.",effects:{comfort:1,appeal:1},laborHours:4,minBuilders:1,resources:{firewood:24,"plant fibers":36,cord:10,"crafted goods":2}},{id:"insulated-roof",name:"Insulated Roof Layer",description:"Add moss and hides above the rafters to retain heat.",effects:{survivability:1,demand:{firewood:-.5}},laborHours:6,minBuilders:2,resources:{firewood:40,hides:3,"plant fibers":20,cord:6}}]},{id:"watchtower",name:"Watchtower",icon:"🛡️",category:"Defense",description:"Tall lookout tower providing advance warning of threats.",allowMultiple:!0,unlock:{buildings:[{id:"workshop",count:1}],technologies:["basic-tools"]},requirements:{minBuilders:3,locationTags:["cliff","ridge","hill","high"],site:{category:"cleared",dimensions:{width:4,depth:4},accessClearance:{front:3,back:3,left:3,right:3}},craftedGoods:{cord:38,"crafted goods":8}},effects:{survivability:3,appeal:1,unlocks:["defense-drills"]},components:[{id:"foundation",name:"Anchored Footings",description:"Dig deep footings and backfill with stone for stability.",laborHours:10,minBuilders:3,isCore:!0,resources:{"small stones":70,pebbles:80,firewood:60,"plant fibers":20,cord:6}},{id:"main-supports",name:"Tapered Supports",description:"Raise heavy supports braced with diagonal timbers.",laborHours:12,minBuilders:3,resources:{firewood:180,"plant fibers":50,cord:14,"crafted goods":4}},{id:"floor",name:"Observation Deck",description:"Lay planked flooring with railing.",laborHours:6,minBuilders:2,resources:{firewood:80,"plant fibers":24,cord:6,"crafted goods":2}},{id:"roof",name:"Lookout Roof",description:"Add a small roof and signal brazier platform.",laborHours:5,minBuilders:2,resources:{firewood:45,"plant fibers":18,cord:4}},{id:"access",name:"Spiral Stairs",description:"Construct a spiral stair for rapid ascent.",laborHours:7,minBuilders:2,resources:{firewood:90,"plant fibers":26,cord:8,"crafted goods":2}}],addons:[{id:"signal-braziers",name:"Signal Braziers",description:"Install braziers for signaling neighboring settlements.",effects:{unlocks:["regional-alliance"]},laborHours:3,minBuilders:1,resources:{"small stones":20,firewood:24,"plant fibers":8,cord:2}}]},{id:"palisade",name:"Perimeter Palisade",icon:"🪵",category:"Defense",description:"Encircling wall of sharpened logs with fighting walkways and a reinforced gate.",allowMultiple:!1,unlock:{buildings:[{id:"watchtower",count:1}],technologies:["defense-drills"]},requirements:{minBuilders:5,locationTags:["meadow","forest","open"],site:{category:"cleared",dimensions:{width:24,depth:24},accessClearance:{front:4,back:4,left:4,right:4}},craftedGoods:{cord:60,"crafted goods":10}},effects:{survivability:4,safety:3,demand:{firewood:2,"crafted goods":1}},components:[{id:"ditch",name:"Ditch & Berm",description:"Excavate an outer ditch and throw up an inner berm for the log curtain.",laborHours:16,minBuilders:5,isCore:!0,resources:{pebbles:260,"small stones":160,firewood:120}},{id:"walls",name:"Log Curtain",description:"Set sharpened trunks shoulder to shoulder and bind them with heavy wales.",laborHours:18,minBuilders:4,resources:{firewood:420,"plant fibers":120,cord:36,"crafted goods":6}},{id:"walkway",name:"Fighting Walkway",description:"Lay interior catwalks with railing and ladder access for sentries.",laborHours:12,minBuilders:3,resources:{firewood:180,"plant fibers":48,cord:12,"crafted goods":4}},{id:"gate",name:"Reinforced Gatehouse",description:"Build a double-door gate with drop bar, murder holes, and flanking platforms.",laborHours:14,minBuilders:3,resources:{firewood:220,"plant fibers":60,cord:18,"small stones":80,"crafted goods":6}}],addons:[{id:"chevaux-de-frise",name:"Chevaux-de-frise",description:"Deploy portable spiked barriers outside the gate to break charges.",effects:{safety:1},laborHours:6,minBuilders:2,resources:{firewood:120,"plant fibers":40,cord:12}}]}],Mu=Cu.map(e=>{var n;if(!((n=e==null?void 0:e.requirements)!=null&&n.locationTags))return e;const t=ku(e.requirements.locationTags);return t===e.requirements.locationTags?e:{...e,requirements:{...e.requirements,locationTags:t}}}),no=[{id:"easy",name:"Easy"},{id:"normal",name:"Medium"},{id:"hard",name:"Hard"}],ai={oreDensity:55,waterTable:50,temperature:50,rainfall:50,mountains:50,rivers100:45,lakes100:35,advanced:{elevationBase:50,elevationVariance:50,elevationScale:50,vegetationScale:50,oreNoiseScale:50,oreThresholdOffset:50,waterGuaranteeRadius:50,waterFlowMultiplier:50}};function fr(e){const t=Number.isFinite(e)?e:0;return t<0?0:t>100?100:Math.round(t)}function Eu(e={}){const t={...ai.advanced,...e};return Object.fromEntries(Object.entries(t).map(([n,r])=>[n,fr(r)]))}function xr(e={}){const t={...ai,...e,advanced:Eu(e.advanced)};return{...t,oreDensity:fr(t.oreDensity),waterTable:fr(t.waterTable),temperature:fr(t.temperature),rainfall:fr(t.rainfall),mountains:fr(t.mountains),rivers100:fr(t.rivers100),lakes100:fr(t.lakes100)}}const cl={easy:{people:9,foodDays:7,firewoodDays:7,tools:{"stone hand axe":1,"stone knife":1,bow:1,"wooden arrow":10,"wooden shovel":1,"wooden hammer":1}},normal:{people:7,foodDays:3,firewoodDays:3,tools:{"stone hand axe":1,"stone knife":1}},hard:{people:5,foodDays:0,firewoodDays:0,tools:{}}},cr={oreDensity:-8,waterTable:-6,temperature:-5,rainfall:-4,mountains:7,rivers100:-3,lakes100:-2,advanced:{elevationVariance:3,elevationScale:2,vegetationScale:-1,oreNoiseScale:2,oreThresholdOffset:-3,waterGuaranteeRadius:-2,waterFlowMultiplier:-2}};function Tu(e={}){const t=xr(e);let n=50;const r=(i,a)=>{const d=(i-50)/50;n+=d*a};r(t.oreDensity,cr.oreDensity),r(t.waterTable,cr.waterTable),r(t.temperature,cr.temperature),r(t.rainfall,cr.rainfall),r(t.mountains,cr.mountains),r(t.rivers100,cr.rivers100),r(t.lakes100,cr.lakes100);const o=cr.advanced;return Object.entries(o).forEach(([i,a])=>{i in t.advanced&&r(t.advanced[i],a)}),Math.round(Math.min(100,Math.max(1,n)))}function Ci(e,t={}){const n=cl[e]||cl.normal;return{start:{...n,tools:{...n.tools}},world:xr(t)}}const Eo={easy:Ci("easy",{oreDensity:78,waterTable:70,temperature:65,rainfall:62,mountains:35,rivers100:72,lakes100:68,advanced:{vegetationScale:62,oreThresholdOffset:68,waterGuaranteeRadius:70,waterFlowMultiplier:45}}),normal:Ci("normal",{oreDensity:55,waterTable:50,temperature:50,rainfall:50,mountains:50,rivers100:45,lakes100:35}),hard:Ci("hard",{oreDensity:38,waterTable:40,temperature:42,rainfall:38,mountains:68,rivers100:32,lakes100:28,advanced:{elevationVariance:68,elevationScale:64,oreNoiseScale:62,oreThresholdOffset:38,waterGuaranteeRadius:32,waterFlowMultiplier:62}}),custom:Ci("normal")};function Mi(e="normal"){return Eo[e]||Eo.normal}function Au(e=[]){C.people instanceof Map?C.people.clear():C.people=new Map,e.forEach(t=>{t!=null&&t.id&&C.people.set(t.id,{...t})}),Lc()}function Lc(){const e=[...C.people.values()],t=e.length,n=e.filter(l=>(l.age??0)>=16).length,r=t-n,o=e.filter(l=>l.job).length,i=t-o,a=e.filter(l=>l.home).length,d=t-a;C.peopleStats={total:t,adults:n,children:r,employed:o,unemployed:i,housed:a,homeless:d}}function Bc(){Lc()}function Rc(){return C.peopleStats||{total:0,adults:0,children:0,employed:0,unemployed:0,housed:0,homeless:0}}const Or=new Map;let ss=!1,Qo=null,ei=!1,dl=!1;function Wi(e){dl||(console.warn("Local storage is unavailable; using in-memory storage instead.",e),dl=!0)}function Nu(){if(typeof window<"u"&&window&&"localStorage"in window)try{return window.localStorage}catch(e){return Wi(e),null}if(typeof globalThis<"u"&&"localStorage"in globalThis)try{return globalThis.localStorage}catch(e){return Wi(e),null}try{if(typeof localStorage<"u")return localStorage}catch(e){Wi(e)}return null}function La(e){e&&Wi(e),Qo=null,ei=!1,ss=!0}function Ns(){if(ss)return ei?Qo:null;ss=!0,ei=!1,Qo=null;const e=Nu();if(!e)return null;try{const t="__fantasy-survival-storage-test__";e.setItem(t,t),e.removeItem(t),Qo=e,ei=!0}catch(t){La(t)}return ei?Qo:null}function Ls(e){const t=Ns();if(t)try{const n=t.getItem(e);return n==null?(Or.delete(e),null):(Or.set(e,n),n)}catch(n){La(n)}return Or.has(e)?Or.get(e):null}function ca(e,t){const n=Ns();if(n)try{return n.setItem(e,t),Or.set(e,t),!0}catch(r){La(r)}return Or.set(e,t),!1}function Lu(e){const t=Ns();if(t)try{t.removeItem(e)}catch(n){La(n)}Or.delete(e)}const Bs="fantasy-survival-save";function Er(){try{const e=C.serialize();ca(Bs,JSON.stringify(e))}catch(e){console.error("Failed to save game",e)}}function Bu(){var e,t,n,r,o,i;try{const a=Ls(Bs);if(!a)return!1;C.deserialize(JSON.parse(a)),Jr();for(const d of C.locations.values()){let l=d.worldSettings;if(!l&&((e=d.map)!=null&&e.worldSettings)&&(l=d.map.worldSettings),!d.map||!d.map.tiles){d.map=Cr(d.biome,void 0,void 0,void 0,void 0,void 0,C.time.season,void 0,void 0,l,!1),(t=d.map)!=null&&t.worldSettings&&!d.worldSettings&&(d.worldSettings=d.map.worldSettings);continue}d.map.seed||(d.map.seed=Date.now());const c=((r=(n=d.map.tiles)==null?void 0:n[0])==null?void 0:r.length)||Zr,f=((o=d.map.tiles)==null?void 0:o.length)||$a,{xStart:u,yStart:p}=Ha(c,f);Number.isFinite(d.map.xStart)||(d.map.xStart=u),Number.isFinite(d.map.yStart)||(d.map.yStart=p);const h=d.map.xStart===0&&d.map.yStart===0;(!d.map.types||h)&&(d.map=Cr(d.biome,d.map.seed,h?u:d.map.xStart,h?p:d.map.yStart,c,f,d.map.season??C.time.season,d.map.waterLevel,d.map.viewport,l,!1)),!d.worldSettings&&((i=d.map)!=null&&i.worldSettings)&&(d.worldSettings=d.map.worldSettings),!C.worldSettings&&l&&(C.worldSettings=l)}return Bc(),Ia(),!0}catch(a){return console.error("Failed to load game",a),!1}}function Ru(){try{Lu(Bs)}catch(e){console.warn("Failed to clear saved game data.",e)}}const di=[{id:"hunting",name:"Hunting",description:"Tracking, stalking, and harvesting wild game.",baseRate:1.1,defaultComplexity:45,diminishing:.9,startLevel:5},{id:"tracking",name:"Tracking",description:"Reading prints, scat, and disturbances to follow prey or intruders.",baseRate:1,defaultComplexity:40,diminishing:.85,startLevel:5},{id:"foraging",name:"Foraging",description:"Identifying edible and medicinal plants in the wild.",baseRate:.95,defaultComplexity:32,diminishing:.75,startLevel:5},{id:"gathering",name:"Gathering",description:"Collecting loose resources such as branches, stone, and salvage.",baseRate:.9,defaultComplexity:24,diminishing:.7,startLevel:5},{id:"fishing",name:"Fishing",description:"Casting nets, setting lines, and harvesting aquatic life.",baseRate:.96,defaultComplexity:34,diminishing:.82,startLevel:5},{id:"agriculture",name:"Agriculture",description:"Cultivating crops, tending soil, and rotating fields for food security.",baseRate:.94,defaultComplexity:42,diminishing:.8,startLevel:5},{id:"herbalism",name:"Herbalism",description:"Harvesting, preparing, and preserving medicinal plants.",baseRate:.92,defaultComplexity:36,diminishing:.78,startLevel:5},{id:"woodcutting",name:"Tree Felling",description:"Cutting timber, pruning, and shaping wood.",baseRate:1,defaultComplexity:40,diminishing:.95,startLevel:5},{id:"carpentry",name:"Carpentry",description:"Working seasoned lumber into beams, furniture, and fittings.",baseRate:.98,defaultComplexity:44,diminishing:.9,startLevel:5},{id:"masonry",name:"Stone Masonry",description:"Shaping, laying, and mortaring stone for durable structures.",baseRate:.92,defaultComplexity:50,diminishing:.88,startLevel:5},{id:"mining",name:"Mining",description:"Extracting ore, stone, and minerals safely from the earth.",baseRate:.9,defaultComplexity:52,diminishing:.95,startLevel:5},{id:"smelting",name:"Smelting",description:"Refining ore in a furnace to produce workable metals.",baseRate:.88,defaultComplexity:56,diminishing:.9,startLevel:5},{id:"smithing",name:"Smithing",description:"Forging, shaping, and tempering metal tools and weapons.",baseRate:.9,defaultComplexity:58,diminishing:.92,startLevel:5},{id:"leatherworking",name:"Leatherworking",description:"Tanning hides and sewing them into garments, armor, and goods.",baseRate:.9,defaultComplexity:40,diminishing:.82,startLevel:5},{id:"weaving",name:"Weaving",description:"Spinning fibers and weaving textiles for clothing and trade.",baseRate:.92,defaultComplexity:42,diminishing:.8,startLevel:5},{id:"pottery",name:"Pottery",description:"Forming clay vessels and firing them for storage and trade.",baseRate:.88,defaultComplexity:46,diminishing:.85,startLevel:5},{id:"crafting",name:"General Crafting",description:"Hand crafting tools, garments, and trade goods.",baseRate:.92,defaultComplexity:36,diminishing:.85,startLevel:5},{id:"cooking",name:"Cooking",description:"Preparing meals, preserving food, and balancing flavours.",baseRate:.94,defaultComplexity:30,diminishing:.76,startLevel:5},{id:"swimming",name:"Swimming",description:"Crossing rivers, lakes, and flooded ground without aid.",baseRate:.8,defaultComplexity:38,diminishing:1.2,startLevel:1},{id:"construction",name:"Construction",description:"Coordinating and executing building projects.",baseRate:.9,defaultComplexity:44,diminishing:1,startLevel:5},{id:"combat",name:"Combat Readiness",description:"Armed drills, patrol discipline, and tactical awareness.",baseRate:1.05,defaultComplexity:55,diminishing:1.1,startLevel:5}],Fu=new Map(di.map(e=>[e.id,e])),$u={hunting:"hunting",gathering:"gathering",farming:"agriculture",herding:"agriculture",crafting:"crafting",cooking:"cooking",smithing:"smithing",building:"construction",combat:"combat"};function Fc(){return C.proficiencies instanceof Map||(C.proficiencies=new Map),di.forEach(e=>{C.proficiencies.has(e.id)||C.proficiencies.set(e.id,{id:e.id,level:e.startLevel??1,lastComplexity:e.defaultComplexity,lastUpdated:Date.now()})}),C.proficiencies}function $c(e){const t=Fc(),n=Fu.get(e),r=t.get(e);return n?{id:n.id,name:n.name,description:n.description,level:(r==null?void 0:r.level)??n.startLevel??1,lastComplexity:(r==null?void 0:r.lastComplexity)??n.defaultComplexity}:{id:e,name:e,level:(r==null?void 0:r.level)??1,lastComplexity:(r==null?void 0:r.lastComplexity)??0}}function Hc(e){return $c(e).level}function Hu(){return Fc(),di.map(e=>$c(e.id))}function Iu(e){return $u[e]||null}const Du=new Map(di.map(e=>[e.id,e])),da=["Alden","Bram","Cedric","Doran","Eamon","Gareth","Hadrian","Ivor","Lysander","Marek","Niall","Oren","Percival","Quentin","Rowan","Silas","Theron","Ulric","Varek","Wystan"],ua=["Aislin","Bria","Celes","Daphne","Elowen","Fiora","Gwyn","Helena","Isolde","Junia","Kaela","Lira","Mira","Nerine","Odette","Petra","Quilla","Rhosyn","Selene","Thalia","Vessa","Wren"],ul=["Amberfall","Blackbriar","Coppervein","Dawnbreak","Eldercrest","Frostmere","Galehart","Hawthorne","Ironwood","Lakeshore","Moonridge","Nightbloom","Oakenshield","Riversong","Stormwatch","Thornfield","Umberlyn","Valewind","Wilderose","Yarwick"],Ou={hunting:"spent adolescence shadowing veteran hunters through the border woods",tracking:"learned to read faint trails while running long scouting patrols",foraging:"studied plant lore from a kindly travelling herbalist",gathering:"knows how to comb the wilds for every loose branch or stone",fishing:"worked the riverboats casting nets since childhood",agriculture:"tended terraced fields with extended kin back home",herbalism:"apprenticed under a village apothecary drying roots and leaves",woodcutting:"was raised among timber camps and swung an axe before dawn each day",carpentry:"served as a carpenter’s apprentice crafting beams and joints",masonry:"helped raise keep walls from painstakingly cut stone",mining:"hauled carts through narrow mines for many seasons",smelting:"kept smoky bloomery furnaces stoked for a merchant caravan",smithing:"apprenticed under a travelling blacksmith at a roaring forge",leatherworking:"kept tannery vats bubbling and pliable back in town",weaving:"learned the rhythm of the loom from a patient aunt",pottery:"spent years at the wheel shaping clay for market stalls",crafting:"keeps nimble hands busy fashioning useful trinkets",cooking:"ran a crowded cookfire for a mercenary band",swimming:"ferried messages by swimming swift rivers unassisted",construction:"coordinated work crews to raise palisades and scaffolds",combat:"trained relentlessly with the militia in formation drills"},zu={hunting:"has an aversion to gore and drawn-out chases",tracking:"struggles to focus on faint signs in the underbrush",foraging:"mixes up similar herbs unless closely guided",gathering:"tires quickly hauling loose salvage",fishing:"gets seasick even on placid waters",agriculture:"suffers from pollen that blankets the spring fields",herbalism:"sneezes constantly around drying herbs",woodcutting:"worries about misjudging a tree’s fall",carpentry:"fumbles with precise joinery and measurements",masonry:"finds hefting stone exhausting after a short while",mining:"feels uneasy deep underground",smelting:"coughs in the heavy furnace smoke",smithing:"wilts in the forge heat",leatherworking:"never got used to the tannery stench",weaving:"grows impatient at the loom",pottery:"dislikes the feel of wet clay under their nails",crafting:"prefers not to fuss with fine details",cooking:"second-guesses seasoning and timing",swimming:"still remembers nearly drowning as a child",construction:"struggles with heights and scaffolding",combat:"hesitates when blades are drawn"},Pu={hunting:"keeps a journal of animal movements around camp",tracking:"enjoys mapping the prints discovered near the settlement",foraging:"collects unusual berries and edible roots for fun",fishing:"mends nets and whittles floats during downtime",agriculture:"experiments with seed rows in spare plots",herbalism:"presses herbs into journals to study them later",carpentry:"carves small keepsakes from leftover lumber",masonry:"sketches arch designs on scrap parchment",smithing:"tinkers with broken tools to see how they are made",cooking:"tries new spice blends at the communal hearth",weaving:"braids cordage into intricate patterns",pottery:"shapes clay charms and beads to trade with others",leatherworking:"crafts small pouches for friends and family",combat:"keeps weapon drills sharp even after duties end"},ju={male:{subject:"He",object:"him",possessive:"his"},female:{subject:"She",object:"her",possessive:"her"}};let Ic=1;function _u(e){if(e==null)return Math.random;let t=typeof e=="number"?e:0;if(Number.isNaN(t)&&(t=0),typeof e=="string")for(let n=0;n<e.length;n++)t=t+e.charCodeAt(n)*13>>>0;return t=(t||Date.now())>>>0,function(){t+=1831565813;let r=t;return r=Math.imul(r^r>>>15,r|1),r^=r+Math.imul(r^r>>>7,r|61),((r^r>>>14)>>>0)/4294967296}}function Ei(e,t,n){const r=Math.ceil(t),o=Math.floor(n);return Math.floor(e()*(o-r+1))+r}function qu(e,t,n){const r=e==="female"?n.female:n.male;r.available.length===0&&(r.available=[...r.source]);const o=Math.floor(t()*r.available.length),[i]=r.available.splice(o,1);return i}function Wu(e=[]){const t=e.filter(Boolean);if(!t.length)return"";if(t.length===1)return t[0];if(t.length===2)return`${t[0]} and ${t[1]}`;const n=t.slice(0,-1).join(", "),r=t[t.length-1];return`${n}, and ${r}`}function Sr(e){var t;return((t=Du.get(e))==null?void 0:t.name)||e}function Uu(e){return Ou[e]||`has a knack for ${Sr(e).toLowerCase()}`}function Yu(e){return zu[e]||`struggles with ${Sr(e).toLowerCase()}`}function Gu(e){return Pu[e]||`enjoys practising ${Sr(e).toLowerCase()} during quiet moments`}function Xu(e){const t={},n=di.map(p=>p.id);n.forEach(p=>{t[p]=30+Math.round(e()*20)});const r=[...n],o=(p,h=new Set)=>{const g=r.filter(S=>!h.has(S)),b=[];for(let S=0;S<p&&g.length;S++){const v=Math.floor(e()*g.length),[k]=g.splice(v,1);h.add(k),b.push(k)}return b},i=new Set,a=o(2,i),d=o(1,i);a.forEach(p=>{t[p]=70+Math.round(e()*20)}),d.forEach(p=>{t[p]=10+Math.round(e()*12)});const l=new Set(a);e()>.4&&o(1,new Set([...i,...l])).forEach(h=>l.add(h));const c=a.map(p=>({id:p,name:Sr(p),level:t[p],reason:Uu(p)})),f=d.map(p=>({id:p,name:Sr(p),level:t[p],reason:Yu(p)})),u=Array.from(l).filter(p=>!d.includes(p)).map(p=>({id:p,label:Sr(p),reason:Gu(p)}));return{skillRatings:t,talents:c,deficiencies:f,interests:u}}function zr({sex:e,age:t,surname:n,householdId:r,rng:o}){const i=zr.namePools||{male:{available:[...da],source:da},female:{available:[...ua],source:ua}};zr.namePools=i;const a=qu(e,o,i),d=`pop-${String(Ic++).padStart(3,"0")}`,{skillRatings:l,talents:c,deficiencies:f,interests:u}=Xu(o);return{id:d,givenName:a,surname:n,name:`${a} ${n}`,age:t,sex:e,householdId:r,relationships:[],family:[],interests:u,talents:c,deficiencies:f,skillRatings:l,backstory:"",job:null,assignment:null}}function fl(e,t,n,r){e.relationships.some(o=>o.id===t.id&&o.relation===n)||e.relationships.push({id:t.id,relation:n}),t.relationships.some(o=>o.id===e.id&&o.relation===r)||t.relationships.push({id:e.id,relation:r})}function Vu(e,t){if(!e.length)return"";const n=e.map(r=>{var o,i;return((o=t.get(r.id))==null?void 0:o.givenName)||((i=t.get(r.id))==null?void 0:i.name)}).filter(Boolean);return n.length?n.length===1?n[0]:`${n.length} children (${n.join(", ")})`:""}function Ku(e){const t=new Map(e.map(n=>[n.id,n]));e.forEach(n=>{var k,E;const r=ju[n.sex]||{subject:"They",possessive:"their"},o=n.relationships.find(A=>A.relation==="spouse"),i=n.relationships.filter(A=>A.relation==="parent"),a=n.relationships.filter(A=>A.relation==="child"),d=o?((k=t.get(o.id))==null?void 0:k.givenName)||((E=t.get(o.id))==null?void 0:E.name):null,l=i.map(A=>{var L,F;return((L=t.get(A.id))==null?void 0:L.givenName)||((F=t.get(A.id))==null?void 0:F.name)}).filter(Boolean),c=Vu(a,t),f=n.talents[0],u=n.deficiencies[0],p=n.interests[0],h=[];l.length&&h.push(`grew up learning from ${Wu(l)}`),d&&h.push(`now shares a home with ${d}`),c&&h.push(`looks after ${c}`),h.length||h.push("carved out a life on the frontier with little help");const g=f?`${r.subject} ${f.reason}, honing ${r.possessive} ${f.name.toLowerCase()} talents.`:`${r.subject} applies a steady hand to any task at hand.`,b=u?`However, ${r.subject.toLowerCase()} ${u.reason}, so ${r.subject.toLowerCase()} prefers others handle ${u.name.toLowerCase()} when possible.`:"",S=p?`In quieter moments, ${r.subject.toLowerCase()} ${p.reason}.`:"",v=`${n.name} ${h.join(" and ")}. ${g} ${b} ${S}`.replace(/\s+/g," ").trim();n.backstory=v,n.family=n.relationships.map(A=>({...A}))})}function Zu(e,t){const n=[],r=[],o=[...ul],i=()=>{o.length||o.push(...ul);const l=Math.floor(t()*o.length);return o.splice(l,1)[0]},a=Math.max(1,Math.min(Math.floor(e/3),Math.floor(e/2)));for(let l=0;l<a&&n.length+2<=e;l++){const c=i(),f=`household-${l+1}`,u=zr({sex:"male",age:Ei(t,20,45),surname:c,householdId:f,rng:t}),p=zr({sex:"female",age:Ei(t,18,42),surname:c,householdId:f,rng:t});r.push({id:f,surname:c,adults:[u,p],children:[]}),n.push(u,p)}let d=r.length;for(;n.length<e;)if(r.length&&t()<.7){const c=r[Math.floor(t()*r.length)],f=t()<.5?"male":"female",u=Ei(t,14,Math.min(22,45)),p=zr({sex:f,age:u,surname:c.surname,householdId:c.id,rng:t});c.children.push(p),n.push(p)}else{const c=i(),f=`household-${++d}`,u=t()<.5?"male":"female",p=Ei(t,18,45),h=zr({sex:u,age:p,surname:c,householdId:f,rng:t});r.push({id:f,surname:c,adults:[h],children:[]}),n.push(h)}return r.forEach(l=>{if(l.adults.length>=2){const[c,f]=l.adults;fl(c,f,"spouse","spouse")}l.children.forEach(c=>{l.adults.forEach(f=>{fl(f,c,"parent","child")})})}),n}function Ju(e,t={}){const n=Math.max(1,Math.trunc(Number(e)||0)),r=_u(t.seed);Ic=1,zr.namePools={male:{available:[...da],source:da},female:{available:[...ua],source:ua}};const o=Zu(n,r);return Ku(o),Au(o),o}function Qu(e,t={}){var f;const n=Array.isArray(t.preferredSkills)&&t.preferredSkills.length?t.preferredSkills:[t.id];let r=n[0],o=Number.MIN_SAFE_INTEGER;n.forEach(u=>{var h;const p=Number((h=e.skillRatings)==null?void 0:h[u]);Number.isFinite(p)&&p>o&&(r=u,o=p)}),Number.isFinite(o)||(o=Number((f=e.skillRatings)==null?void 0:f[r])||0);let i=o;const a=(e.talents||[]).some(u=>u.id===r),d=(e.interests||[]).some(u=>u.id===r),l=(e.deficiencies||[]).some(u=>u.id===r);a&&(i+=7),d&&(i+=5),l&&(i-=12);const c=Math.min(6,Math.max(0,(e.age||0)-20)*.3);return i=Math.max(0,i+c),{score:i,focusSkill:r}}function Dc(e={},t=[]){C.people instanceof Map||(C.people=new Map);const n=Array.isArray(t)?t:[],r={},o=[],i=new Set;return C.people.forEach(a=>{a&&(a.job=null,a.assignment&&delete a.assignment,!Array.isArray(a.relationships)&&Array.isArray(a.family)&&(a.relationships=[...a.family]),(a.age||0)>=16&&o.push(a))}),n.forEach(a=>{const d=Math.max(0,Math.trunc(Number((e==null?void 0:e[a.id])??0)));if(!d){r[a.id]=[],e&&(e[a.id]=0);return}const c=o.filter(f=>!i.has(f.id)).map(f=>({person:f,...Qu(f,a)})).sort((f,u)=>u.score!==f.score?u.score-f.score:u.person.age!==f.person.age?u.person.age-f.person.age:f.person.name.localeCompare(u.person.name)).slice(0,d);r[a.id]=[],c.forEach(f=>{const{person:u,score:p,focusSkill:h}=f;u.job=a.id,u.assignment={jobId:a.id,score:p,focusSkill:h},i.add(u.id),r[a.id].push({id:u.id,name:u.name,age:u.age,sex:u.sex,score:Math.round(p*10)/10,focusSkill:h,focusSkillName:Sr(h)})}),e&&(e[a.id]=r[a.id].length)}),C.people.forEach((a,d)=>{const l=Array.isArray(a.relationships)?a.relationships:Array.isArray(a.family)?[...a.family]:[];C.people.set(d,{...a,relationships:l,family:l,assignment:a.job?a.assignment:null})}),Bc(),r}function ef(){if(!(C.people instanceof Map))return{};const e={};return C.people.forEach(t=>{if(!(t!=null&&t.job))return;e[t.job]||(e[t.job]=[]);const n=t.assignment||{};e[t.job].push({id:t.id,name:t.name,age:t.age,sex:t.sex,score:n.score!=null?Math.round(n.score*10)/10:null,focusSkill:n.focusSkill||null,focusSkillName:n.focusSkill?Sr(n.focusSkill):null})}),Object.values(e).forEach(t=>{t.sort((n,r)=>{const o=n.score??0,i=r.score??0;return i!==o?i-o:n.name.localeCompare(r.name)})}),e}const Kr=[{id:"gather",label:"Gatherers",description:"Collect forage, firewood, and loose materials from the surrounding area.",preferredSkills:["foraging","gathering","herbalism","agriculture","woodcutting","mining"]},{id:"hunt",label:"Hunters",description:"Track game to keep the settlement supplied with meat and hides.",preferredSkills:["hunting","tracking","fishing","swimming"]},{id:"farm",label:"Farmers",description:"Tend crop fields, manage irrigation, and rotate plantings for steady harvests.",preferredSkills:["agriculture","herbalism","gathering"]},{id:"herd",label:"Herders",description:"Raise livestock, muck pens, and keep breeding stock healthy.",preferredSkills:["agriculture","hunting","herbalism"]},{id:"craft",label:"Crafters",description:"Maintain tools, weave cordage, and assemble needed goods.",preferredSkills:["crafting","carpentry","smithing","weaving","pottery","leatherworking","cooking","smelting"]},{id:"cook",label:"Cooks",description:"Prepare meals, smoke provisions, and keep communal kitchens stocked.",preferredSkills:["cooking","herbalism","crafting"]},{id:"smith",label:"Smiths",description:"Work the forge to shape metal fittings, tools, and weapons.",preferredSkills:["smithing","smelting","crafting"]},{id:"build",label:"Builders",description:"Raise new structures and shore up existing shelters.",preferredSkills:["construction","carpentry","masonry","smithing"]},{id:"guard",label:"Guards",description:"Keep watch for danger and respond to hostile threats.",preferredSkills:["combat","hunting","tracking"]}];function tf(){if((!C.jobs||typeof C.jobs!="object")&&(C.jobs={}),Object.prototype.hasOwnProperty.call(C.jobs,"scavenge")){const e=Math.max(0,Number(C.jobs.scavenge)||0);C.jobs.gather=Math.max(0,(C.jobs.gather||0)+e),delete C.jobs.scavenge}}function Rs(){(!C.jobSettings||typeof C.jobSettings!="object")&&(C.jobSettings={}),Kr.forEach(e=>{const t=C.jobSettings[e.id],n=Number.isFinite(t==null?void 0:t.workdayHours)?t.workdayHours:10;C.jobSettings[e.id]={workdayHours:Math.max(1,Math.round(n))}})}function Oc(){tf(),Rs(),Kr.forEach(e=>{const t=Number(C.jobs[e.id]);C.jobs[e.id]=Number.isFinite(t)&&t>0?Math.trunc(t):0})}function zc(){return Kr.map(e=>({...e}))}function Ba(){Oc();const e=Dc(C.jobs,Kr)||{},t=Rc().adults||0,n=Kr.map(i=>({...i,assigned:C.jobs[i.id]||0,workdayHours:Fs(i.id),roster:e[i.id]||[]})),r=n.reduce((i,a)=>i+a.assigned,0),o=Math.max(0,t-r);return{assignments:n,adults:t,assigned:r,laborer:o}}function nf(){const e=Ba(),t={};return e.assignments.forEach(n=>{t[n.id]=n.assigned}),t.laborer=e.laborer,t}function rf(e,t){if(Oc(),e==="laborer")return;const n=Rc().adults||0,r=Object.entries(C.jobs).filter(([a])=>a!==e).reduce((a,[,d])=>a+d,0),o=Math.max(0,n-r),i=Math.max(0,Math.trunc(Number.isFinite(t)?t:0));C.jobs[e]=Math.max(0,Math.min(i,o)),Dc(C.jobs,Kr),Er()}function Fs(e){var r;Rs();const t=(r=C.jobSettings)==null?void 0:r[e],n=Number.isFinite(t==null?void 0:t.workdayHours)?t.workdayHours:10;return Math.max(1,Math.round(n))}function of(e,t){if(Rs(),!Kr.find(r=>r.id===e))return;const n=Math.max(4,Math.min(16,Math.round(Number.isFinite(t)?t:10)));C.jobSettings[e]={workdayHours:n},Er()}const af={"stone-hand-axe":300,"bronze-axe":800,"iron-axe":1500};function sf(e=0,t="temperate-deciduous"){var i;let n="stone-hand-axe";yn("bronze-tools")&&(n="bronze-axe"),yn("iron-tools")&&(n="iron-axe");const r=af[n]||0,o=((i=Mr(t))==null?void 0:i.woodMod)??1;return e*r*o}const lf=50,cf=.8,df=lf*cf,uf=[{name:"firewood",weight:5},{name:"food",weight:1},{name:"small stones",weight:2},{name:"pebbles",weight:1}],ff={firewood:.25,food:.4,"small stones":.2,pebbles:.15},pf=.95,mf=3,hf=.35,gf=.5,bf=.5,yf=.3;function wf(e){const t=uf.find(n=>n.name===e);return t?t.weight:1}function xf(e,t){const n={};return Object.entries(e).forEach(([r,o])=>{n[r]=o*t}),n}function vf(e,t){return e[t]||(e[t]={supply:0,demand:0}),e[t]}function Pc(e,t,n){if(!Number.isFinite(n)||n===0)return;const r=vf(e,t);n>0?r.supply+=n:r.demand+=Math.abs(n)}const Sf={gather:"gathering",hunt:"hunting",farm:"farming",herd:"herding",craft:"crafting",cook:"cooking",smith:"smithing"},kf={gather:"gathering",hunt:"hunting",farm:"agriculture",herd:"agriculture",craft:"crafting",cook:"cooking",smith:"smithing"};function ls(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,e)):t}function Cf(e){const n=Number.isFinite(e)?Math.max(0,e):50;if(n>=50){const o=(n-50)/50;return 1+ls(o,0,1.6)*.6}const r=(50-n)/50;return ls(1-r*.6,.4,1)}function Mf(e){if(!e)return 1;const t=Hc(e);return Number.isFinite(t)?.55+ls(t,1,100)/90:1}function Ef(e,t,n){if(t!=null&&t.focusSkill)return t.focusSkill;if(n){const r=Iu(n);if(r)return r}return kf[e]||n||null}function Tf(e){const t=ef();Object.entries(t).forEach(([n,r])=>{if(!Array.isArray(r)||r.length===0)return;const o=Sf[n];if(!o)return;const i=Fs(n);if(!Number.isFinite(i)||i<=0)return;let a=0;if(r.forEach(c=>{const f=Ef(n,c,o),u=Cf(c==null?void 0:c.score)*Mf(f);Number.isFinite(u)&&u>0&&(a+=u)}),!Number.isFinite(a)||a<=0)return;const d=$s({type:o,workers:a,assigned:r.length}),l=Object.entries(d||{}).filter(([,c])=>Number.isFinite(c)&&c!==0);l.length&&l.forEach(([c,f])=>{const u=f*i;Pc(e,c,u)})})}function Af(e){const t=rr({statuses:["completed"]});let n=0;return t.forEach(r=>{var d,l;const o=ln(r.typeId),i=(l=(d=o==null?void 0:o.effects)==null?void 0:d.jobs)==null?void 0:l[e],a=Number(i)||0;a>0&&(n+=a)}),n}const Nf={grain:.2,"root vegetables":.1333,herbs:.0333},Lf={"crafted goods":.02},Bf={food:.15,hides:.04,"animal fat":.02},Rf={grain:.075,water:.1},Ff={cookedMeals:.2,"hearty meal":.1,"comfort meal":.05,preservedFood:.05},$f={food:.3,firewood:.15,herbs:.05,salt:.03,spices:.015},Hf={"crafted goods":.15,"bronze ingot":.05},If={"raw ore":.1,charcoal:.1,firewood:.05};function Ra(e,t=0,n=0){if(!Number.isFinite(t)||t<=0)return 0;const r=Af(e);if(r<=0)return 0;const o=Math.min(Math.max(0,n),r);return o<=0?0:Math.min(t,o)}function Df(e=0){const t=df*pf/8,n={};return Object.entries(ff).forEach(([r,o])=>{const i=t*o;n[r]=i/wf(r)*e}),n}function Of(e={}){const{people:t=0,foodDays:n=0,firewoodDays:r=0,tools:o={}}=e,i={},a=1;return t>0&&n>0&&(i.food=t*n*a),t>0&&r>0&&(i.firewood=t*r),Object.entries(o).forEach(([d,l])=>{l&&(i[d]=(i[d]||0)+l)}),i}function zf(e){const t=(e==null?void 0:e.workers)||0;return{food:t*mf,hides:t*hf}}function Pf(e){const t=(e==null?void 0:e.workers)||0;return{"crafted goods":t*gf,firewood:-t*bf}}function jf(e){const t=Ra("farm",(e==null?void 0:e.workers)||0,(e==null?void 0:e.assigned)||0);if(!t)return{};const n={};return Object.entries(Nf).forEach(([r,o])=>{n[r]=(n[r]||0)+o*t}),Object.entries(Lf).forEach(([r,o])=>{n[r]=(n[r]||0)-o*t}),n}function _f(e){const t=Ra("herd",(e==null?void 0:e.workers)||0,(e==null?void 0:e.assigned)||0);if(!t)return{};const n={};return Object.entries(Bf).forEach(([r,o])=>{n[r]=(n[r]||0)+o*t}),Object.entries(Rf).forEach(([r,o])=>{n[r]=(n[r]||0)-o*t}),n}function qf(e){const t=Ra("cook",(e==null?void 0:e.workers)||0,(e==null?void 0:e.assigned)||0);if(!t)return{};const n={};return Object.entries(Ff).forEach(([r,o])=>{n[r]=(n[r]||0)+o*t}),Object.entries($f).forEach(([r,o])=>{n[r]=(n[r]||0)-o*t}),n}function Wf(e){const t=Ra("smith",(e==null?void 0:e.workers)||0,(e==null?void 0:e.assigned)||0);if(!t)return{};const n={};return Object.entries(Hf).forEach(([r,o])=>{n[r]=(n[r]||0)+o*t}),Object.entries(If).forEach(([r,o])=>{n[r]=(n[r]||0)-o*t}),n}function Uf(e){var i,a;const t=(e==null?void 0:e.workers)||0,n={},r=((i=e==null?void 0:e.metadata)==null?void 0:i.perWorkerHourResources)||{};Object.entries(r).forEach(([d,l])=>{l&&(n[d]=-l*t)});const o=((a=e==null?void 0:e.metadata)==null?void 0:a.progressPerWorkerHour)??yf;return n["construction progress"]=t*o,n}function $s(e){if(!e)return{};switch(e.type){case"gathering":return Df(e.workers);case"hunting":return zf(e);case"farming":return jf(e);case"herding":return _f(e);case"crafting":return Pf(e);case"cooking":return qf(e);case"smithing":return Wf(e);case"building":return Uf(e);case"combat":default:return{}}}function Yf(e,t=1){if(!e||t<=0)return{};const n=$s(e);return xf(n,t)}function Gf(e=[]){const t={};return e.filter(n=>n.status==="pending"||n.status==="active").forEach(n=>{const r=n.status==="pending"?n.durationHours:n.remainingHours,o=Yf(n,r);Object.entries(o).forEach(([i,a])=>{Pc(t,i,a)})}),Tf(t),t}const Xf={gather:"gathering",hunt:"hunting",craft:"crafting"};function Vf(e,t){(!C.jobDaily||typeof C.jobDaily!="object")&&(C.jobDaily={});const n=C.jobDaily[e];return(!n||n.dayStamp!==t)&&(C.jobDaily[e]={dayStamp:t,workedHours:0,idleHours:0}),C.jobDaily[e]}function Kf(e,t){Object.entries(e||{}).forEach(([n,r])=>{if(!r)return;const o=r*t;o&&sa(n,o)})}function Zf(e,t,n){var a;const r=Xf[e];if(!r||t<=0||n<=0)return 0;const o=$s({type:r,workers:t});if(!o)return 0;let i=n;if(r==="crafting"){const d=Math.abs(o.firewood||0);if(d>0){const l=Math.max(0,((a=ci("firewood"))==null?void 0:a.quantity)||0),c=l>0?l/d:0;i=Math.min(n,c)}}return i<=0?0:(Kf(o,i),i)}function Jf(e,t,n){if(!e||t<=0)return 0;const r=Math.max(1,e.totalLaborHours||1),o=e.requiredResources||{},i=e.consumedResources||{};let a=t;return Object.entries(o).forEach(([d,l])=>{var S;if(!Number.isFinite(l)||l<=0)return;const c=l/r;if(c<=0)return;const f=c*n;if(f<=0)return;const u=i[d]||0,p=Math.max(0,l-u);if(p<=0){a=Math.min(a,0);return}const h=Math.max(0,((S=ci(d))==null?void 0:S.quantity)||0),b=Math.min(p,h)/f;a=Math.min(a,b)}),Math.max(0,a)}function Qf(e,t){if(t<=0)return;const n=Math.max(1,e.totalLaborHours||1),r=e.requiredResources||{};if(!Object.keys(r).length)return;const o={};Object.entries(r).forEach(([i,a])=>{if(!Number.isFinite(a)||a<=0)return;const d=a/n;if(d<=0)return;const l=d*t;l&&(o[i]=l,sa(i,-l))}),Object.keys(o).length&&Mm(e.id,o)}function ep(e,t){if(e<=0||t<=0)return 0;const n=rr({statuses:["under-construction"]});if(!n.length)return 0;let r=e*t,o=0;return n.some(i=>{if(r<=0)return!0;const a=Math.max(1,i.assignedWorkers||1),d=Math.max(1,i.totalLaborHours||1),l=Math.ceil(d/a),c=Math.max(a*l,d),f=d/c,u=Math.max(0,d-(i.progressHours||0));if(u<=0)return!1;const p=u/f;if(p<=0)return!1;const h=Math.min(r,p);if(h<=0)return!1;const g=Jf(i,h,f);if(g<=0)return!1;const b=g*f;return b<=0||(Qf(i,b),Cm(i.id,b),r-=g,o+=g,Math.min(d,(i.progressHours||0)+b)>=d&&Em(i.id)),!1}),o}function tp(e,{dayStamp:t}={}){if(!Number.isFinite(e)||e<=0)return;const n=nf();Object.entries(n).forEach(([r,o])=>{if(r==="laborer")return;const i=Math.max(0,Number(o)||0);if(i<=0)return;const a=Vf(r,t),d=Fs(r),l=Math.max(0,d-a.workedHours);if(l<=0)return;const c=Math.min(e,l);if(c<=0)return;let f=0;r==="build"?(f=ep(i,c),f>0&&(f/=Math.max(1,i))):f=Zf(r,i,c),f>0?(a.workedHours+=f,f<c&&(a.idleHours+=c-f)):a.idleHours+=c})}function pl(e){if(!C.jobDaily||typeof C.jobDaily!="object"){C.jobDaily={};return}Object.entries(C.jobDaily).forEach(([t,n])=>{!n||n.dayStamp===e||(C.jobDaily[t]={dayStamp:e,workedHours:0,idleHours:0})})}const cs=28,So=24,jc=6,ni={min:410,max:987};function np(){const e=ni.max-ni.min+1;return ni.min+Math.floor(Math.random()*e)}const ui=[{name:"Frostmelt",season:"Thawbound"},{name:"Dawnforge",season:"Thawbound"},{name:"Seedwane",season:"Thawbound"},{name:"Raincall",season:"Sunheight"},{name:"Suncrest",season:"Sunheight"},{name:"Highember",season:"Sunheight"},{name:"Harvestgale",season:"Emberwane"},{name:"Emberfall",season:"Emberwane"},{name:"Gloamreach",season:"Emberwane"},{name:"Stormwrack",season:"Frostshroud"},{name:"Nightveil",season:"Frostshroud"},{name:"Deepfrost",season:"Frostshroud"},{name:"Ghostmoon",season:"Frostshroud"}],sn=ui.length,rp=ui.map(e=>e.name),Fa={Thawbound:{icon:"🌿",months:[]},Sunheight:{icon:"🔥",months:[]},Emberwane:{icon:"🍂",months:[]},Frostshroud:{icon:"❄️",months:[]}};ui.forEach((e,t)=>{const n=Fa[e.season];n&&n.months.push(t+1)});Object.values(Fa).forEach(e=>{e.months.sort((t,n)=>t-n)});const _c=[{name:"Clear",icon:"☀️",weights:{Thawbound:3,Sunheight:4,Emberwane:3,Frostshroud:2}},{name:"Cloudy",icon:"☁️",weights:{Thawbound:2,Sunheight:2,Emberwane:3,Frostshroud:3}},{name:"Rain",icon:"🌧️",weights:{Thawbound:3,Sunheight:3,Emberwane:2,Frostshroud:1}},{name:"Storm",icon:"⛈️",weights:{Thawbound:1,Sunheight:2,Emberwane:1,Frostshroud:1}},{name:"Snow",icon:"❄️",weights:{Thawbound:0,Sunheight:0,Emberwane:1,Frostshroud:4}},{name:"Fog",icon:"🌫️",weights:{Thawbound:1,Sunheight:1,Emberwane:2,Frostshroud:2}}],ml=[{key:"night",label:"Night",icon:"🌙",start:0,end:4},{key:"dawn",label:"Dawn",icon:"🌅",start:4,end:7},{key:"day",label:"Day",icon:"☀️",start:7,end:18},{key:"dusk",label:"Dusk",icon:"🌇",start:18,end:21},{key:"night",label:"Night",icon:"🌙",start:21,end:24}];function op(e=0){return((Number.isFinite(e)?e:0)%So+So)%So}function fi(){return C.time||(C.time={}),(!Number.isFinite(C.time.day)||C.time.day<1)&&(C.time.day=1),Number.isFinite(C.time.month)?C.time.month<1?C.time.month=1:C.time.month>sn&&(C.time.month=(Math.floor(C.time.month)-1)%sn+1):C.time.month=1,!Number.isFinite(C.time.year)||C.time.year<ni.min?C.time.year=ni.min:C.time.year=Math.floor(C.time.year),Number.isFinite(C.time.hour)||(C.time.hour=jc),C.time.season=Hs(C.time.month),C.time.weather||(C.time.weather="Clear"),C.time}function Ua(e=fi()){const t=Number.isFinite(e.year)?Math.floor(e.year):0,n=Number.isFinite(e.month)?Math.floor(e.month):1,r=Number.isFinite(e.day)?Math.floor(e.day):1,o=((n-1)%sn+sn)%sn;return t*sn*cs+o*cs+(r-1)}function Hs(e=1){var r;const n=(((Number.isFinite(e)?Math.floor(e):1)-1)%sn+sn)%sn;return((r=ui[n])==null?void 0:r.season)||Object.keys(Fa)[0]}function Is(e=1){var r;const n=(((Number.isFinite(e)?Math.floor(e):1)-1)%sn+sn)%sn;return((r=ui[n])==null?void 0:r.name)||rp[0]}function ip(e,t){const n=_c.map(i=>{var a;return{name:i.name,icon:i.icon,weight:((a=i.weights)==null?void 0:a[e])??0}}).filter(i=>i.weight>0);if(!n.length)return t||"Clear";if(t){const i=n.find(a=>a.name===t);i&&(i.weight+=1.5)}const r=n.reduce((i,a)=>i+a.weight,0);if(r<=0)return t||n[0].name;let o=Math.random()*r;for(const i of n)if(o-=i.weight,o<=0)return i.name;return n[n.length-1].name}function qc(e){const t=e||"Unknown",n=Fa[t];return n?{name:t,icon:n.icon,months:[...n.months]}:{name:t,icon:"❔",months:[]}}function ap(e){const t=_c.find(n=>n.name===e);return t?{name:t.name,icon:t.icon}:{name:e||"Unknown",icon:"❔"}}function sp(e=(t=>(t=C.time)==null?void 0:t.hour)()){const n=op(e),r=ml.find(o=>n>=o.start&&n<o.end)||ml[0];return{key:r.key,label:r.label,icon:r.icon,start:r.start,end:r.end}}function Wc(){const e=fi();e.day+=1,e.day>cs&&(e.day=1,e.month+=1,e.month>sn&&(e.month=1,e.year+=1)),e.season=Hs(e.month),e.weather=ip(e.season,e.weather)}function Uc(e=1){const t=fi(),n=Math.max(0,Number.isFinite(e)?e:0);if(n<=0)return;pl(Ua(t));let r=n;for(;r>0;){const o=Ua(t),i=So-t.hour,a=Math.min(r,i);a>0?(tp(a,{dayStamp:o}),t.hour+=a,r-=a):(t.hour+=r,r=0),t.hour>=So-1e-9&&(t.hour-=So,Wc(),pl(Ua(t)))}}function cn(){const e=fi();return{...e,monthName:Is(e.month)}}function Yc(){const e=fi();e.hour=jc}const ds="sanity-check-notification";let Ti=null;const lp=5e3;let hl=null;function cp(){return Array.isArray(C.eventLog)||(C.eventLog=[]),C.eventLog}function dp(e){const t=typeof cn=="function"?cn():null;return{id:`sanity-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,message:e,day:(t==null?void 0:t.day)??null,month:(t==null?void 0:t.month)??null,year:(t==null?void 0:t.year)??null,hour:(t==null?void 0:t.hour)??null,season:(t==null?void 0:t.season)??null,weather:(t==null?void 0:t.weather)??null}}function up(){if(Ti||typeof document>"u")return Ti;const e=document.createElement("div");return e.className="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","false"),document.body.appendChild(e),Ti=e,Ti}function fp(e,t={}){if(typeof document>"u")return;const n=up();if(!n)return;const r=document.createElement("div");r.className="toast",t!=null&&t.type&&r.classList.add(`toast--${t.type}`),r.textContent=typeof e=="string"?e:"",n.appendChild(r),requestAnimationFrame(()=>{r.classList.add("is-visible")});const o=Number.isFinite(t==null?void 0:t.duration)?Math.max(0,t.duration):lp;window.setTimeout(()=>{r.classList.remove("is-visible"),window.setTimeout(()=>{r.parentElement===n&&n.removeChild(r)},300)},o)}function pp(e,t={}){const n=typeof e=="string"&&e.trim()?e.trim():"Sanity check adjustment applied.",r=n.startsWith("[sanity-check]")?n:`[sanity-check] ${n}`,o=cp();if(o.unshift(dp(r)),o.length>30&&(o.length=30),typeof document<"u"&&typeof document.dispatchEvent=="function")try{document.dispatchEvent(new CustomEvent(ds,{detail:{message:r,...t}}))}catch(i){console.error("Failed to dispatch sanity check notification",i)}return r}function mp(e){if(typeof e!="function")return()=>{};if(typeof document>"u"||typeof document.addEventListener!="function")return()=>{};const t=n=>{try{e(n.detail||{})}catch(r){console.error("Error in sanity check listener",r)}};return document.addEventListener(ds,t),()=>document.removeEventListener(ds,t)}function Gc(){hl||typeof document>"u"||(hl=mp(e=>{!e||typeof e.message!="string"||fp(e.message,{type:e.type??"info"})}))}class hp{constructor({parameters:t={},evaluate:n,regenerate:r,maxIterations:o=5,chunkSize:i=16,chunkRows:a=1,chunkColumns:d=1,gridWidth:l=0,gridHeight:c=0}={}){this.parameters={...t},this.evaluate=typeof n=="function"?n:()=>null,this.regenerate=typeof r=="function"?r:()=>null,this.maxIterations=Math.max(1,Math.trunc(o)),this.chunkSize=Math.max(1,Math.trunc(i)),this.chunkRows=Math.max(1,Math.trunc(a)),this.chunkColumns=Math.max(1,Math.trunc(d)),this.gridWidth=Math.max(0,Math.trunc(l)),this.gridHeight=Math.max(0,Math.trunc(c)),this.metricsHistory=[],this.messages=[],this.fullRerender=!1,this.dirtyChunks=new Set,this.bestSolution=null}markAllDirty(){this.fullRerender=!0,this.dirtyChunks.clear()}markChunkDirty(t,n){if(this.fullRerender)return;const r=Math.trunc(t),o=Math.trunc(n);Number.isNaN(r)||Number.isNaN(o)||r<0||o<0||r>=this.chunkRows||o>=this.chunkColumns||this.dirtyChunks.add(`${r}:${o}`)}markTileDirty(t,n){if(this.fullRerender)return;const r=Math.trunc(t),o=Math.trunc(n);if(Number.isNaN(r)||Number.isNaN(o)||r<0||o<0||r>=this.gridWidth||o>=this.gridHeight)return;const i=Math.floor(o/this.chunkSize),a=Math.floor(r/this.chunkSize);this.markChunkDirty(i,a)}addMessage(t){if(!t||typeof t!="string")return;const n=t.trim();n&&this.messages.push(n)}computeScore(t){var i;if(!t)return Number.NEGATIVE_INFINITY;if(Number.isFinite(t.score))return t.score;const n=Number.isFinite(t.landRatio)?t.landRatio:0,r=Number.isFinite(t.oreRatio)?t.oreRatio:0,o=(i=t.origin)!=null&&i.isWater?.25:0;return n-r*.2-o}getDirtyChunks(){if(this.fullRerender)return[];const t=[];for(const n of this.dirtyChunks){const[r,o]=n.split(":").map(i=>Number.parseInt(i,10));Number.isFinite(r)&&Number.isFinite(o)&&t.push({row:r,column:o})}return t}solve(t={}){var l,c,f;const n={...t,solver:this};let r=null,o=0,i={...this.parameters},a=null;for(;o<this.maxIterations;o++){const u={...this.parameters};if(r=this.evaluate({parameters:u,iteration:o,context:n}),!r)break;const p=this.computeScore(r);r.score=p,this.metricsHistory.push(r);const h=this.bestSolution,g=r.satisfied===!0;if(!h||g&&((l=h.metrics)==null?void 0:l.satisfied)!==!0||g===(((c=h.metrics)==null?void 0:c.satisfied)===!0)&&p>h.score){const v={...r,origin:r.origin?{...r.origin}:r.origin,stats:r.stats?{...r.stats}:r.stats};this.bestSolution={score:p,metrics:v,parameters:u}}if(i=u,a=r,r.satisfied===!0)break;const S=this.regenerate({parameters:{...this.parameters},metrics:r,iteration:o,context:n});if(!S||(S.parameters&&typeof S.parameters=="object"&&(this.parameters={...this.parameters,...S.parameters}),Array.isArray(S.messages)&&S.messages.forEach(v=>this.addMessage(v)),S.message&&this.addMessage(S.message),S.markAllDirty&&this.markAllDirty(),Array.isArray(S.markTiles)&&S.markTiles.forEach(v=>{v&&Number.isFinite(v.x)&&Number.isFinite(v.y)&&this.markTileDirty(v.x,v.y)}),Array.isArray(S.markChunks)&&S.markChunks.forEach(v=>{v&&Number.isFinite(v.row)&&Number.isFinite(v.column)&&this.markChunkDirty(v.row,v.column)}),S.stop===!0))break}let d=!1;if(this.bestSolution){const u=this.computeScore(a),p=this.bestSolution;if(!a||!a.satisfied||((f=p.metrics)==null?void 0:f.satisfied)===!0||p.score>u){i={...p.parameters},a=p.metrics;const g=this.parameters;(!g||g.xStart!==i.xStart||g.yStart!==i.yStart||(g.originShiftX||0)!==(i.originShiftX||0)||(g.originShiftY||0)!==(i.originShiftY||0))&&(this.markAllDirty(),d=!0)}}return this.parameters={...i},{parameters:{...this.parameters},metrics:a,history:this.metricsHistory.slice(),messages:this.messages.slice(),iterations:this.metricsHistory.length,dirty:{full:this.fullRerender||d,chunks:this.getDirtyChunks()}}}}function gp(e){const t=typeof e=="string"?e:String(e??"");let n=1779033703^t.length;for(let r=0;r<t.length;r+=1)n=Math.imul(n^t.charCodeAt(r),3432918353),n=n<<13|n>>>19;return n=Math.imul(n^n>>>16,2246822507),n=Math.imul(n^n>>>13,3266489909),(n^=n>>>16)>>>0}function bp(e){let t=e>>>0;return()=>{t+=1831565813;let n=Math.imul(t^t>>>15,t|1);return n^=n+Math.imul(n^n>>>7,n|61),((n^n>>>14)>>>0)/4294967296}}const yp=.5*(Math.sqrt(3)-1),Go=(3-Math.sqrt(3))/6;function zn(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}const Ya=[[1,1],[-1,1],[1,-1],[-1,-1],[1,0],[-1,0],[1,0],[-1,0],[0,1],[0,-1],[0,1],[0,-1]];class gl{constructor(t){const n=bp(gp(t)),r=new Uint8Array(256);for(let o=0;o<256;o+=1)r[o]=o;for(let o=255;o>0;o-=1){const i=Math.floor(n()*(o+1)),a=r[o];r[o]=r[i],r[i]=a}this.perm=new Uint8Array(512);for(let o=0;o<512;o+=1)this.perm[o]=r[o&255]}noise2D(t,n){let r=0,o=0,i=0;const a=(t+n)*yp,d=Math.floor(t+a),l=Math.floor(n+a),c=(d+l)*Go,f=d-c,u=l-c,p=t-f,h=n-u;let g=0,b=0;p>h?g=1:b=1;const S=p-g+Go,v=h-b+Go,k=p-1+2*Go,E=h-1+2*Go,A=d&255,L=l&255,F=this.perm[A+this.perm[L]]%12,O=this.perm[A+g+this.perm[L+b]]%12,H=this.perm[A+1+this.perm[L+1]]%12;let _=.5-p*p-h*h;if(_>=0){_*=_;const R=Ya[F];r=_*_*(R[0]*p+R[1]*h)}let $=.5-S*S-v*v;if($>=0){$*=$;const R=Ya[O];o=$*$*(R[0]*S+R[1]*v)}let s=.5-k*k-E*E;if(s>=0){s*=s;const R=Ya[H];i=s*s*(R[0]*k+R[1]*E)}return 70*(r+o+i)}}function wp(e,t,n,r,o,i){const a=Math.max(24,r),d=t/a,l=n/a,c=zn(1-Math.hypot(d,l),0,1),f=e.noise2D(d*.7+11.3,l*.7-7.1)*.5+.5,u=e.noise2D(d*1.8-3.7,l*1.8+5.9)*.5+.5,p=c*(.65+.35*f)+u*.12,h=p*(1-o)+Math.pow(p,1.5)*o;return zn(h+i,0,1)}function xp(e,t={}){const n=new gl(`${e}:elev`),r=new gl(`${e}:mask`),o=zn(t.base??.5,.01,.99),i=zn(t.variance??.5,.01,2),a=Math.max(4,t.scale??64),d=Math.max(a,t.worldScale??a*4),l=Math.max(1,Math.trunc(t.octaves??5)),c=zn(t.persistence??.5,.25,.85),f=zn(t.lacunarity??2.1,1.2,3.6),u=zn(t.maskStrength??.55,0,1),p=zn(t.maskBias??0,-.3,.3),h=1/a,g=Math.sqrt(d/64);return{sample(b,S){let v=1,k=1,E=0,A=0;for(let _=0;_<l;_+=1){const $=(b+_*17.31)*h*k/g,s=(S-_*11.17)*h*k/g,R=n.noise2D($,s)*.5+.5;E+=R*v,A+=v,v*=c,k*=f}const L=A>0?E/A:.5,F=wp(r,b,S,d,u,p),O=zn(L*(.6+.4*F)+F*.18,0,1),H=o+(O-.5)*2*i;return zn(H,0,1)}}}function Xt(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function Xo(e,t){return Number.isFinite(e)?Xt(Math.round(e),0,100):t}function vp(e){return .25+Xt(Number.isFinite(e)?e:50,0,100)/100*1.5}function Sp(e){var n;const t=((n=e==null?void 0:e.features)==null?void 0:n.join(" ").toLowerCase())??"";return/marsh|bog|swamp|delta|mangrove|wetland|flood/i.test(t)}function kp(e,t,n,r){var Ge,Ve;const o=Xo(t==null?void 0:t.rainfall,50),i=Xo(t==null?void 0:t.waterTable,50),a=Xo(t==null?void 0:t.mountains,50),d=Xo(t==null?void 0:t.rivers100,45),l=Xo(t==null?void 0:t.lakes100,35),c=(o-50)/100,f=(i-50)/100,u=(a-50)/100,p=(d-50)/100,h=(l-50)/100,g=((Ge=e==null?void 0:e.elevation)==null?void 0:Ge.waterLevel)??.28,b=Xt(g+f*.1+c*.06-u*.08,.04,.8),S=vp((Ve=t==null?void 0:t.advanced)==null?void 0:Ve.waterFlowMultiplier),v=Math.max(16,n*r),k=Xt(p*.45+c*.35+f*.25,-.6,.9),E=v*Xt(.0025+k*.0018,.0012,.0075),A=Math.max(12,E/S),L=Math.max(6,A*.45),F=A*1.35,O=Sp(e)?.4:0,H=Xt(c*.5+h*.35+O,0,1),_=H>.35?2:1,s=Xt(.03+c*.03+h*.02,.01,.16)/Math.max(.75,S*.85),R=Xt(h+c*.4,-.5,1.2),W=Math.max(4,Math.round(6+R*8)),K=Xt(5e-4+h*15e-5,2e-4,.001),ne=Xt(Math.round(4+(f+c)*6),3,12),ye=Xt(Math.round(2+p*1.2+c*.8),2,4),me=Xt(ye+1+Math.round(O*2),ye,6),Oe=Xt(.04+c*.03+f*.04,.02,.12),Ye=Xt(Math.round(ne*.6+p*2),2,ne);return{seaLevel:b,flowMultiplier:S,riverFlowThreshold:A,tributaryThreshold:L,mouthExpansionThreshold:F,lakeMinDepth:s,lakeMinArea:W,marshRingWidth:_,marshiness:H,maxSingletonFraction:K,estuaryRadius:ne,distributaryMin:ye,distributaryMax:me,estuaryWideningDepth:Oe,confluenceRadius:Ye}}class Xc{constructor(){this.heap=[]}push(t){this.heap.push(t),this.bubbleUp(this.heap.length-1)}pop(){if(!this.heap.length)return null;const t=this.heap[0],n=this.heap.pop();return this.heap.length&&(this.heap[0]=n,this.bubbleDown(0)),t}bubbleUp(t){let n=t;for(;n>0;){const r=Math.floor((n-1)/2);if(this.heap[r].value<=this.heap[n].value)break;[this.heap[r],this.heap[n]]=[this.heap[n],this.heap[r]],n=r}}bubbleDown(t){let n=t;const r=this.heap.length;for(;n<r;){const o=n*2+1,i=n*2+2;let a=n;if(o<r&&this.heap[o].value<this.heap[a].value&&(a=o),i<r&&this.heap[i].value<this.heap[a].value&&(a=i),a===n)break;[this.heap[n],this.heap[a]]=[this.heap[a],this.heap[n]],n=a}}}const _e=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];function Cp(e,t){for(let n=0;n<_e.length;n+=1)if(_e[n][0]===e&&_e[n][1]===t)return n;return-1}function Hn(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function us(e,t){const n=`${e}:${t}`;let r=1779033703^n.length;for(let o=0;o<n.length;o+=1)r=Math.imul(r^n.charCodeAt(o),3432918353),r=r<<13|r>>>19;return r=Math.imul(r^r>>>16,2246822507),r=Math.imul(r^r>>>13,3266489909),(r^=r>>>16)>>>0}function Mp(e,t,n,r){const o=e*t,i=new Float64Array(o);i.fill(Number.POSITIVE_INFINITY);const a=new Uint8Array(o),d=new Xc;for(let l=0;l<t;l+=1)for(let c=0;c<e;c+=1)if(l===0||c===0||l===t-1||c===e-1){const f=l*e+c,u=Math.max(n[f],r);i[f]=u,a[f]=1,d.push({index:f,value:u})}for(let l=d.pop();l;l=d.pop()){const{index:c,value:f}=l,u=c%e,p=Math.floor(c/e);for(let h=0;h<_e.length;h+=1){const g=_e[h][0],b=_e[h][1],S=u+g,v=p+b;if(S<0||v<0||S>=e||v>=t)continue;const k=v*e+S;if(a[k])continue;a[k]=1;const E=Math.max(n[k],f);i[k]=E,d.push({index:k,value:E})}}return i}function Ga(e,t,n){const r=[];for(let o=0;o<t;o+=1){const i=[];for(let a=0;a<e;a+=1)i.push(n[o*e+a]);r.push(i)}return r}function Ep(e,t,n,r,o,i){const a=e*t,d=new Array(a).fill("land"),l=new Float64Array(a);l.set(r);const c=new Uint8Array(a),f=1e-5,u=[],p=i.lakeMinDepth,h=i.lakeMinArea,g=Math.max(p*.6,.006);for(let v=0;v<a;v+=1){if(c[v])continue;const k=r[v]-n[v];if(r[v]<=o+f||k<g)continue;const E=[v],A=[];let L=k,F=0;const O=r[v];for(;E.length;){const H=E.pop();if(c[H])continue;c[H]=1;const _=r[H]-n[H];if(r[H]-O>f||_<g)continue;A.push(H),F+=1,_>L&&(L=_);const $=H%e,s=Math.floor(H/e);for(let R=0;R<_e.length;R+=1){const W=$+_e[R][0],K=s+_e[R][1];if(W<0||K<0||W>=e||K>=t)continue;const ne=K*e+W;c[ne]||E.push(ne)}}if(A.length&&(F>=h||L>=p*1.35)){for(const H of A)d[H]="lake";u.push(...A)}}const b=new Uint8Array(a),S=[];for(let v=0;v<e;v+=1){const k=v,E=(t-1)*e+v;r[k]<=o+f&&(S.push(k),b[k]=1,d[k]="ocean"),r[E]<=o+f&&(S.push(E),b[E]=1,d[E]="ocean")}for(let v=0;v<t;v+=1){const k=v*e,E=k+e-1;r[k]<=o+f&&!b[k]&&(S.push(k),b[k]=1,d[k]="ocean"),r[E]<=o+f&&!b[E]&&(S.push(E),b[E]=1,d[E]="ocean")}for(;S.length;){const v=S.shift(),k=v%e,E=Math.floor(v/e);for(let A=0;A<_e.length;A+=1){const L=k+_e[A][0],F=E+_e[A][1];if(L<0||F<0||L>=e||F>=t)continue;const O=F*e+L;b[O]||r[O]<=o+f&&d[O]!=="lake"&&(d[O]="ocean",b[O]=1,S.push(O))}}return{types:d,spill:l}}function Tp(e,t,n,r,o,i){const a=e*t,d=new Int8Array(a);d.fill(-1);const l=1e-6;for(let c=0;c<a;c+=1){if(o[c]==="ocean")continue;const f=c%e,u=Math.floor(c/e);let p=-1,h=-1/0,g=n[c];for(let b=0;b<_e.length;b+=1){const S=f+_e[b][0],v=u+_e[b][1];if(S<0||v<0||S>=e||v>=t)continue;const k=v*e+S,E=r[c]-r[k];E>h+l?(h=E,p=b,g=n[k]):Math.abs(E-h)<=l&&E>-l&&(n[k]<g-l?(p=b,g=n[k]):Math.abs(n[k]-g)<=l&&(us(i,c*31+b)&1||(p=b,g=n[k])))}if(p===-1){let b=r[c];for(let S=0;S<_e.length;S+=1){const v=f+_e[S][0],k=u+_e[S][1];if(v<0||k<0||v>=e||k>=t)continue;const E=k*e+v,A=r[E];A<b-l&&(b=A,p=S)}}d[c]=p}return d}function Ap(e,t,n,r,o){const i=e*t,a=Array.from({length:i},(l,c)=>c);a.sort((l,c)=>o[l]-o[c]);const d=new Float64Array(i);d.fill(1);for(const l of a){const c=n[l];if(c<0)continue;const f=l%e,u=Math.floor(l/e),p=f+_e[c][0],h=u+_e[c][1];if(p<0||h<0||p>=e||h>=t)continue;const g=h*e+p;d[g]+=d[l]}return d}function Np(e,t,n){const r=e*t,o=Array.from({length:r},()=>[]);for(let i=0;i<r;i+=1){const a=n[i];if(a<0)continue;const d=i%e,l=Math.floor(i/e),c=d+_e[a][0],f=l+_e[a][1];if(c<0||f<0||c>=e||f>=t)continue;const u=f*e+c;o[u].push(i)}return o}function Lp(e,t,n,r,o,i,a){const d=e*t,l=a.riverFlowThreshold*a.flowMultiplier,c=a.tributaryThreshold*a.flowMultiplier,f=a.mouthExpansionThreshold*a.flowMultiplier,u=[];for(let b=0;b<d;b+=1)n[b]==="land"&&r[b]>=l&&(n[b]="river",u.push(b));for(;u.length;){const b=u.pop(),S=o[b];if(S>=0){const v=b%e,k=Math.floor(b/e),E=v+_e[S][0],A=k+_e[S][1];if(E>=0&&A>=0&&E<e&&A<t){const L=A*e+E;n[L]==="land"&&r[L]>=c&&(n[L]="river",u.push(L))}}for(const v of i[b])n[v]==="land"&&r[v]>=c&&(n[v]="river",u.push(v))}const p=[];for(let b=0;b<d;b+=1){if(n[b]!=="river")continue;const S=o[b];if(S<0)continue;const v=b%e,k=Math.floor(b/e),E=v+_e[S][0],A=k+_e[S][1];if(E<0||A<0||E>=e||A>=t)continue;const L=A*e+E;(n[L]==="ocean"||n[L]==="lake")&&p.push(b)}const h=new Uint8Array(d),g=4;for(;p.length;){const S=[{idx:p.shift(),depth:0}];for(;S.length;){const{idx:v,depth:k}=S.shift();if(!h[v]&&(h[v]=1,r[v]>=f*Math.max(.25,1-k*.2))){n[v]="river";const E=v%e,A=Math.floor(v/e);for(let L=0;L<4;L+=1){const[F,O]=_e[L*2],H=E+F,_=A+O;if(H<0||_<0||H>=e||_>=t)continue;const $=_*e+H;n[$]==="land"&&r[$]>=c*.6&&(n[$]="river",S.push({idx:$,depth:k+1}))}if(k<g)for(const L of i[v])!h[L]&&n[L]==="land"&&S.push({idx:L,depth:k+1})}}}}function Bp(e,t,n,r,o,i,a,d){const l=e*t;let c=-1,f=-1/0;const u=a+Math.max(.03,d.estuaryWideningDepth??.05);for(let p=0;p<l;p+=1){const h=n[p];if(h!=="land"&&h!=="river"&&h!=="marsh")continue;const g=p%e,b=Math.floor(p/e);let S=!1;for(const[H,_]of _e){const $=g+H,s=b+_;if(!($<0||s<0||$>=e||s>=t)&&n[s*e+$]==="ocean"){S=!0;break}}if(!S)continue;const v=r[p],k=o[p],E=Math.max(0,u-v),A=Math.max(0,a+.08-k),L=i[p],F=(h==="river"?1.15:1)+(h==="marsh"?.1:0),O=L*(1+E*5)*F+A*150;O>f&&(f=O,c=p)}return c}function Rp(e,t,n,r,o){if(e<0)return[];const i=new Uint8Array(t.length),a=[{idx:e,depth:0}];i[e]=1;const d=Math.max(r.riverFlowThreshold,r.tributaryThreshold)*r.flowMultiplier*.8,l=[];for(;a.length;){const f=a.shift();for(const u of t[f.idx]){if(i[u])continue;i[u]=1;const p=f.depth+1,h=n[u];h>=d&&l.push({idx:u,acc:h,depth:p}),a.push({idx:u,depth:p})}}l.sort((f,u)=>u.acc!==f.acc?u.acc-f.acc:u.depth-f.depth);const c=[];for(const f of l)if(c.push(f.idx),c.length>=o)break;return c}function Vc(e,t,n,r,o,i,a){var _,$;if(n===r)return[n];const d=e*t,l=new Xc,c=new Float64Array(d),f=new Uint8Array(d),u=new Int32Array(d);c.fill(Number.POSITIVE_INFINITY),u.fill(-1);const p=a.slopeWeight??35,h=a.heuristicWeight??1,g=a.radiusWeight??1.5,b=a.elevationWeight??40,S=a.avoidOcean??!1,v=r%e,k=Math.floor(r/e),E=((_=a.confluenceCenter)==null?void 0:_.x)??v,A=(($=a.confluenceCenter)==null?void 0:$.y)??k,L=Math.max(0,a.confluenceRadius??0),F=a.maxElevation??Number.POSITIVE_INFINITY;c[n]=0,l.push({index:n,value:0});for(let s=l.pop();s;s=l.pop()){const{index:R,value:W}=s;if(W>c[R])continue;if(R===r)break;if(f[R])continue;f[R]=1;const K=R%e,ne=Math.floor(R/e);for(let ye=0;ye<_e.length;ye+=1){const me=_e[ye][0],Oe=_e[ye][1],Ye=K+me,Ge=ne+Oe;if(Ye<0||Ge<0||Ye>=e||Ge>=t)continue;const Ve=Ge*e+Ye;if(S&&i[Ve]==="ocean"&&Ve!==r)continue;const Se=ye%2===0?1:Math.SQRT2,Xe=Math.max(0,o[Ve]-o[R])*p,ht=Math.hypot(Ye-E,Ge-A),_t=ht>L?(ht-L)*g:0,Je=o[Ve]>F?(o[Ve]-F)*b:0,Tt=Xe+_t+Je,rt=c[R]+Se+Tt;if(rt>=c[Ve])continue;c[Ve]=rt,u[Ve]=R;const pt=Math.hypot(Ye-v,Ge-k)*h;l.push({index:Ve,value:rt+pt})}}if(u[r]===-1)return null;const O=[r];let H=r;for(;H!==n;){if(H=u[H],H===-1)return null;O.push(H)}return O.reverse(),O}function Kc(e,t,n,r,o,i={}){if(!e||e.length===0)return 0;const d=i.skipLast??!1?e.length-1:e.length;for(let l=0;l<d;l+=1){const c=e[l];t[c]!=="ocean"&&t[c]!=="lake"&&(t[c]="river")}for(let l=0;l<e.length-1;l+=1){const c=e[l],f=e[l+1],u=c%r,p=Math.floor(c/r),h=f%r,g=Math.floor(f/r),b=Cp(h-u,g-p);b>=0&&(n[c]=b)}return d}function Fp(e,t,n,r,o,i,a){if(!n||!n.length)return;const d=Math.max(.01,a??.05);for(const l of n){const c=o[l];if(c>i+d)continue;const f=i+d-c,u=Math.min(3,Math.max(1,Math.round(1+f/d))),p=l%e,h=Math.floor(l/e);for(let g=-u;g<=u;g+=1)for(let b=-u;b<=u;b+=1){const S=p+b,v=h+g;if(S<0||v<0||S>=e||v>=t||Math.hypot(b,g)>u+.25)continue;const k=v*e+S;r[k]==="ocean"||r[k]==="lake"||(r[k]="river")}}}function $p(e,t,n,r,o,i,a,d,l){if(n<0)return 0;const c=Math.max(1,d.distributaryMin??2),f=Math.max(c,d.distributaryMax??c),u=f-c+1,p=n%e,h=Math.floor(n/e),g=Math.max(2,d.estuaryRadius??4),b=g*g,S=[];for(let H=Math.max(0,h-g);H<=Math.min(t-1,h+g);H+=1)for(let _=Math.max(0,p-g);_<=Math.min(e-1,p+g);_+=1){const $=_-p,s=H-h;if($*$+s*s>b)continue;const R=H*e+_;r[R]==="ocean"&&S.push(R)}if(!S.length)return 0;const v=us(l??0,n),k=c+(u>0?v%u:0),E=Math.min(f,Math.max(c,k));let A=0;const L=new Set;let F=0;const O=S.length*4;for(;A<E&&F<O;){const H=us(l??0,n*131+A*17+F+1),_=S[H%S.length];if(F+=1,L.has(_))continue;const $=Vc(e,t,n,_,i,r,{slopeWeight:30,heuristicWeight:.9,radiusWeight:1.2,confluenceCenter:{x:p,y:h},confluenceRadius:g,maxElevation:a+(d.estuaryWideningDepth??.06)*1.4,elevationWeight:90,avoidOcean:!1});!$||$.length<2||(Kc($,r,o,e,t,{skipLast:r[$[$.length-1]]==="ocean"}),L.add(_),A+=1)}return A}function Hp(e,t,n,r,o){if(n<0||o<=0)return;const i=n%e,a=Math.floor(n/e),d=o*o,l=[],c=[];for(let f=Math.max(0,a-o);f<=Math.min(t-1,a+o);f+=1)for(let u=Math.max(0,i-o);u<=Math.min(e-1,i+o);u+=1){const p=u-i,h=f-a;if(p*p+h*h>d)continue;const g=f*e+u;if(r[g]!=="land")continue;let b=0,S=0;for(const[v,k]of _e){const E=u+v,A=f+k;if(E<0||A<0||E>=e||A>=t)continue;const L=r[A*e+E];L!=="land"&&(b+=1,L==="ocean"&&(S+=1))}S>=3||b>=5?l.push(g):b>=3&&c.push(g)}for(const f of l)r[f]="ocean";for(const f of c)r[f]==="land"&&(r[f]="marsh")}function Ip({width:e,height:t,types:n,flow:r,accumulation:o,upstream:i,filled:a,rules:d,seed:l,seaLevel:c,elevations:f}){const u={mainChannels:0,tributaries:0,distributaries:0},p=Bp(e,t,n,f,a,o,c,d);if(p<0)return u;const h=Math.max(2,d.distributaryMax??3),g=Rp(p,i,o,d,h);if(!g.length)return u;const b={x:p%e,y:Math.floor(p/e)},S=Math.max(2,d.confluenceRadius??Math.round((d.estuaryRadius??4)*.75));let v=[];for(let E=0;E<g.length;E+=1){const A=g[E],L=Vc(e,t,A,p,a,n,{slopeWeight:45,heuristicWeight:1,radiusWeight:2,confluenceCenter:b,confluenceRadius:S,maxElevation:c+(d.estuaryWideningDepth??.06)*1.25,elevationWeight:70,avoidOcean:!0});!L||L.length<2||(Kc(L,n,r,e,t,{skipLast:!1}),L.length>v.length&&(v=L))}if(!v.length)return n[p]==="land"&&(n[p]="river"),u;u.mainChannels=v.length,u.tributaries=Math.max(0,g.length-1),Fp(e,t,v,n,a,c,d.estuaryWideningDepth);const k=$p(e,t,p,n,r,a,c,d,l);return u.distributaries=k,Hp(e,t,p,n,Math.round(d.estuaryRadius??4)),u}function Dp(e,t,n,r){if(r.marshiness<=0)return;const o=e*t,i=r.marshiness,a=Math.max(1,Math.trunc(r.marshRingWidth)),d=new Uint8Array(o);for(let l=0;l<o;l+=1){if(n[l]!=="lake"&&n[l]!=="river"&&n[l]!=="ocean")continue;const c=l%e,f=Math.floor(l/e);for(let u=-a;u<=a;u+=1)for(let p=-a;p<=a;p+=1){if(p===0&&u===0)continue;const h=c+p,g=f+u;if(h<0||g<0||h>=e||g>=t)continue;const b=g*e+h;if(n[b]!=="land")continue;const S=Math.hypot(p,u);Math.max(0,1-S/(a+.5))*i>=.4&&(d[b]=1)}}for(let l=0;l<o;l+=1)d[l]&&(n[l]="marsh")}function Op(e,t,n){const r=e*t,o=i=>i!=="land";for(let i=0;i<r;i+=1){if(n[i]!=="land")continue;const a=i%e,d=Math.floor(i/e),l=[[[-1,-1],[1,1]],[[-1,1],[1,-1]]];for(const c of l){const[f,u]=c,p=a+f[0],h=d+f[1],g=a+u[0],b=d+u[1];if(p<0||h<0||p>=e||h>=t||g<0||b<0||g>=e||b>=t)continue;const S=h*e+p,v=b*e+g;if(o(n[S])&&o(n[v])){n[i]="marsh";break}}}}function zp(e,t,n){const r=e*t,o=[];for(let p=0;p<r;p+=1){if(n[p]!=="land")continue;const h=p%e,g=Math.floor(p/e);_e.some(([S,v])=>{const k=h+S,E=g+v;return k<0||E<0||k>=e||E>=t?!1:n[E*e+k]==="ocean"})&&o.push(p)}if(!o.length)return;const i=new Uint8Array(r);let a=0;const d=new Set,l=[],c=[];for(const p of o){if(i[p])continue;l.length=0,l.push(p),i[p]=1;const h=[];for(;l.length;){const g=l.shift();h.push(g);const b=g%e,S=Math.floor(g/e);for(const[v,k]of _e){const E=b+v,A=S+k;if(E<0||A<0||E>=e||A>=t)continue;const L=A*e+E;i[L]||n[L]!=="land"||!_e.some(([O,H])=>{const _=E+O,$=A+H;return _<0||$<0||_>=e||$>=t?!1:n[$*e+_]==="ocean"})||(i[L]=1,l.push(L))}}h.length>a&&(a=h.length,d.clear(),h.forEach(g=>d.add(g))),c.push(h)}if(!d.size||d.size===o.length)return;const f=new Set,u=[];c.forEach(p=>{if(!(!p.length||d.has(p[0])))for(p.forEach(h=>{f.has(h)||(u.push(h),f.add(h))});u.length;){const h=u.pop();n[h]="ocean";const g=h%e,b=Math.floor(h/e);for(const[S,v]of _e){const k=g+S,E=b+v;if(k<0||E<0||k>=e||E>=t)continue;const A=E*e+k;n[A]==="land"&&(d.has(A)||f.has(A)||(f.add(A),u.push(A)))}}})}function Pp(e,t,n,r,o){const i=e*t,a=[],d=_e;for(let c=0;c<i;c+=1){if(n[c]==="land")continue;const f=c%e,u=Math.floor(c/e);let p=0;for(let h=0;h<d.length;h+=1){const g=f+d[h][0],b=u+d[h][1];if(g<0||b<0||g>=e||b>=t)continue;const S=b*e+g;if(n[S]!=="land"&&(p+=1,p>0))break}p===0&&a.push({idx:c,priority:r[c]})}const l=Math.max(0,Math.floor(i*o));if(!(a.length<=l)){a.sort((c,f)=>c.priority-f.priority);for(let c=0;c<a.length-l;c+=1)n[a[c].idx]="land"}}const jp=new Set(["water","ocean","lake","river","marsh","mangrove"]);function bl(e,t,n,r,o,i){const a=e*t,d=1e-4,l=1e-6;let c=0;for(let f=0;f<a;f+=1){const u=n[f],p=r[f]-o[f];if(o[f]<=i+l||jp.has(u)){c+=1;continue}p>d&&u==="lake"&&(c+=1)}return c/a}function yl(e,t){let n=0;for(let r=0;r<e.length;r+=1)e[r]<=t&&(n+=1);return n/Math.max(1,e.length)}function wl({width:e,height:t,elevationGrid:n,rules:r,seed:o,seaLevel:i}){const a=Mp(e,t,n,i),{types:d,spill:l}=Ep(e,t,n,a,i,r),c=Tp(e,t,n,a,d,o),f=Ap(e,t,c,d,a),u=Np(e,t,c);Lp(e,t,d,f,c,u,r);const p=Ip({width:e,height:t,types:d,flow:c,accumulation:f,upstream:u,filled:a,rules:r,seed:o,seaLevel:i,elevations:n});return _p(e,t,d,c),Dp(e,t,d,r),Op(e,t,d),zp(e,t,d),Pp(e,t,d,l,r.maxSingletonFraction),{filled:a,types:d,spill:l,flow:c,accumulation:f,riverStats:p}}function _p(e,t,n,r){const o=e*t,i=_e,a=new Uint8Array(o);for(let d=0;d<o;d+=1){if(n[d]!=="river"||a[d])continue;const l=[d],c=[];let f=!1;for(;l.length;){const u=l.pop();if(a[u])continue;a[u]=1,c.push(u);const p=u%e,h=Math.floor(u/e);if(n[u]==="lake"||n[u]==="ocean"){f=!0;continue}const g=r[u];if(g>=0){const b=p+i[g][0],S=h+i[g][1];if(b>=0&&S>=0&&b<e&&S<t){const v=S*e+b;a[v]||l.push(v)}}for(let b=0;b<i.length;b+=1){const S=p+i[b][0],v=h+i[b][1];if(S<0||v<0||S>=e||v>=t)continue;const k=v*e+S;(n[k]==="lake"||n[k]==="ocean")&&(f=!0),n[k]==="river"&&!a[k]&&l.push(k)}}if(!f)for(const u of c)n[u]="land",r[u]=-1}}function qp(e){const{width:t,height:n,elevations:r,seed:o,biome:i,world:a}=e,d=kp(i,a,t,n),l=t*n,c=new Float64Array(l);for(let Se=0;Se<n;Se+=1){const at=r[Se]||[];for(let Xe=0;Xe<t;Xe+=1)c[Se*t+Xe]=Hn(at[Xe]??0,0,1)}const f=.32,u=.05,p=6,h=.012;let g=Hn(d.seaLevel,.02,.95),b=null;const S=[];let v=null,k=null,E=null,A=null,L=g;const F=.02;for(let Se=0;Se<p;Se+=1){const at=wl({width:t,height:n,elevationGrid:c,rules:d,seed:o,seaLevel:g}),Xe=yl(c,g),ht=bl(t,n,at.types,at.filled,c,g),_t=Math.abs(Xe-f);let Je=0;for(let rt=0;rt<at.types.length;rt+=1)at.types[rt]==="ocean"&&(Je+=1);const Tt=Je/l;if(S.push({iteration:Se+1,seaLevel:g,coverage:Xe,surfaceCoverage:ht}),(!b||_t<b.delta)&&(Tt>=F||!b)&&(b={...at,coverage:Xe,surfaceCoverage:ht,delta:_t,seaLevel:g,iterations:Se+1,oceanFraction:Tt}),_t<=u&&Tt>=F)break;if(Xe>f)if(k=g,A=Xe,v!==null){const rt=A-E;if(rt>1e-6){const pt=v+(f-E)/rt*(k-v),qt=Hn(pt,.02,.98);Math.abs(qt-g)>1e-5?g=qt:g=Hn((v+k)/2,.02,.98)}else g=Hn((v+k)/2,.02,.98)}else g=Hn(g-h,.02,.98);else if(v=g,E=Xe,k!==null){const rt=A-E;if(rt>1e-6){const pt=v+(f-E)/rt*(k-v),qt=Hn(pt,.02,.98);Math.abs(qt-g)>1e-5?g=qt:g=Hn((v+k)/2,.02,.98)}else g=Hn((v+k)/2,.02,.98)}else g=Hn(g+h,.02,.98);if(Math.abs(g-L)<1e-5&&v!==null&&k!==null)break;L=g}const O=b??wl({width:t,height:n,elevationGrid:c,rules:d,seed:o,seaLevel:g}),H=O.seaLevel??g,_=O.coverage??yl(c,H),$=O.surfaceCoverage??bl(t,n,O.types,O.filled,c,H),s=O.iterations??p,R=Ga(t,n,O.filled),W=Ga(t,n,O.types),K=[],ne=Ga(t,n,O.accumulation);for(let Se=0;Se<n;Se+=1){const at=[];for(let Xe=0;Xe<t;Xe+=1){const ht=O.flow[Se*t+Xe];ht<0?at.push(null):at.push({dx:_e[ht][0],dy:_e[ht][1]})}K.push(at)}const ye=R,me={...d,seaLevel:H},Oe=O.riverStats??{mainChannels:0,tributaries:0,distributaries:0},Ye=(_*100).toFixed(2),Ge=($*100).toFixed(2),Ve=H.toFixed(3);return typeof console<"u"&&typeof console.debug=="function"&&console.debug(`[hydrology] water coverage ${Ye}% (surface ${Ge}%) after ${s} pass(es) (seaLevel=${Ve}) | rivers main=${Oe.mainChannels} trib=${Oe.tributaries} dist=${Oe.distributaries}`),{types:W,flowDirections:K,flowAccumulation:ne,filledElevation:ye,waterTable:ye,rules:me,seaLevel:H,waterCoverage:_,surfaceWaterCoverage:$,waterAdjustmentHistory:S,riverStats:Oe}}const tr=[[1,0],[-1,0],[0,1],[0,-1]],fa=new Set(["water","ocean","lake","river","marsh","mangrove"]);function Xa(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function Wp(e="mangrove"){let t=1779033703^String(e).length;for(let n=0;n<String(e).length;n+=1)t=Math.imul(t^String(e).charCodeAt(n),3432918353),t=t<<13|t>>>19;return(n,r,o="")=>{let i=t;const a=`${e}:${n}:${r}:${o}`;for(let d=0;d<a.length;d+=1)i=Math.imul(i^a.charCodeAt(d),3432918353),i=i<<13|i>>>19;return i=Math.imul(i^i>>>16,2246822507),i=Math.imul(i^i>>>13,3266489909),i=(i^=i>>>16)>>>0,(i>>>0)/4294967295}}function Up(e){var a;const t=Array.isArray(e)?e.length:0,n=t&&((a=e[0])==null?void 0:a.length)||0,r=Array.from({length:t},()=>new Array(n).fill(1/0));if(!t||!n)return r;const o=[];let i=0;for(let d=0;d<t;d+=1){const l=e[d];if(l)for(let c=0;c<n;c+=1){const f=l[c];fa.has(f)||(r[d][c]=0,o.push({x:c,y:d}))}}for(;i<o.length;){const d=o[i++],{x:l,y:c}=d,f=r[c][l];for(let u=0;u<tr.length;u+=1){const p=tr[u][0],h=tr[u][1],g=l+p,b=c+h;g<0||b<0||g>=n||b>=t||r[b][g]<=f+1||(r[b][g]=f+1,o.push({x:g,y:b}))}}return r}function Va(e,t,n){var d,l;const r=e.length,o=((d=e[0])==null?void 0:d.length)||0;let i=!1,a=!1;for(let c=0;c<tr.length;c+=1){const f=tr[c][0],u=tr[c][1],p=t+f,h=n+u;if(p<0||h<0||p>=o||h>=r)continue;const g=(l=e[h])==null?void 0:l[p];fa.has(g)?g==="river"&&(a=!0):i=!0}return{touchesLand:i,touchesRiver:a}}function Yp({hydrology:e,elevations:t,random:n,seed:r,maxDistance:o=3,maxDepth:i=.12,surfaceAllowance:a=.05}={}){var E,A,L,F,O,H,_,$;if(!((E=e==null?void 0:e.types)!=null&&E.length))return{placed:0,expanded:0,invalidNeighbors:0};const d=e.types,l=d.length,c=((A=d[0])==null?void 0:A.length)||0;if(!c)return{placed:0,expanded:0,invalidNeighbors:0};const f=typeof n=="function"?n:Wp(r??e.seed??"mangrove"),u=Up(d),p=Number.isFinite(e==null?void 0:e.seaLevel)?e.seaLevel:0,h=(e==null?void 0:e.waterTable)||(e==null?void 0:e.filledElevation)||null,g=[],b=Array.from({length:l},()=>new Array(c).fill(0));for(let s=0;s<l;s+=1){const R=d[s];if(R)for(let W=0;W<c;W+=1){const K=R[W];if(!K||K==="river"||!fa.has(K)||K==="mangrove")continue;const ne=(L=u[s])==null?void 0:L[W];if(!Number.isFinite(ne)||ne>o)continue;const{touchesLand:ye,touchesRiver:me}=Va(d,W,s);if(!ye&&!me)continue;const Oe=(F=t==null?void 0:t[s])==null?void 0:F[W],Ye=(O=h==null?void 0:h[s])==null?void 0:O[W],Ge=Number.isFinite(Ye)?Ye:p;if(!Number.isFinite(Ge))continue;const Ve=Math.max(0,Ge-(Number.isFinite(Oe)?Oe:Ge));if(Ve>i||Ge>p+a)continue;const Se=Xa(1-Ve/Math.max(i,1e-6),0,1),at=Xa(1-ne/(o+.5),0,1),Xe=me?.15:0,ht=ye?.05:0,_t=Xa(.3+at*.35+Se*.3+Xe+ht,.12,.85);f(W,s,"mangrove-base")<=_t&&(g.push({x:W,y:s}),b[s][W]=1)}}let S=0;for(let s=0;s<l;s+=1)for(let R=0;R<c;R+=1){if(b[s][R])continue;const W=(H=d[s])==null?void 0:H[R];if(!W||W==="river"||!fa.has(W))continue;const K=(_=u[s])==null?void 0:_[R];if(!Number.isFinite(K)||K>o+1)continue;const{touchesLand:ne,touchesRiver:ye}=Va(d,R,s);if(!ne&&!ye)continue;let me=0;for(let Oe=0;Oe<tr.length;Oe+=1){const Ye=tr[Oe][0],Ge=tr[Oe][1],Ve=R+Ye,Se=s+Ge;Ve<0||Se<0||Ve>=c||Se>=l||($=b[Se])!=null&&$[Ve]&&(me+=1)}me>=2&&f(R,s,"mangrove-growth")<.55&&(b[s][R]=1,g.push({x:R,y:s}),S+=1)}let v=0,k=0;for(let s=0;s<g.length;s+=1){const{x:R,y:W}=g[s],{touchesLand:K,touchesRiver:ne}=Va(d,R,W);if(!K&&!ne){v+=1;continue}d[W][R]="mangrove",k+=1}return typeof console<"u"&&typeof console.debug=="function"&&console.debug(`[mangrove] placed ${k} tile(s) with ${S} expansion pass placements; invalid neighbors: ${v}`),{placed:k,expanded:S,invalidNeighbors:v}}const To=100,Zc=64,Zr=Zc,$a=Zc,Ui={water:"water",ocean:"ocean",lake:"lake",river:"river",marsh:"marsh",mangrove:"mangrove",open:"open",grassland:"grassland",plains:"plains",savanna:"savanna",tundra:"tundra",taiga:"taiga",desert:"desert",sand:"sand",wetland:"wetland",coast:"coast",temperate:"temperate",tropical:"tropical",rainforest:"rainforest",jungle:"jungle",alpine:"alpine",swamp:"swamp",island:"island",mountain:"mountain",volcanic:"volcanic",forest:"forest",ore:"ore",stone:"stone"},co=Object.freeze({water:"#2d7ff9",ocean:"#2563eb",lake:"#38bdf8",river:"#0ea5e9",marsh:"#4ade80",mangrove:"#065f46",open:"#facc15",grassland:"#a3e635",forest:"#16a34a",ore:"#f97316",stone:"#94a3b8",desert:"#f4b76b",tundra:"#9ac5ff",taiga:"#2f6b2a",savanna:"#f59e0b",rainforest:"#047857",jungle:"#0f766e",swamp:"#14532d",wetland:"#22c55e",sand:"#fcd34d",coast:"#0ea5e9",island:"#38bdf8",mountain:"#64748b",alpine:"#60a5fa",volcanic:"#ea580c",temperate:"#4ade80",tropical:"#10b981",plains:"#facc15"}),Gp=Object.freeze({water:"--legend-water",ocean:"--legend-ocean",lake:"--legend-lake",river:"--legend-river",marsh:"--legend-marsh",mangrove:"--legend-mangrove",open:"--legend-open",grassland:"--legend-grassland",forest:"--legend-forest",ore:"--legend-ore",stone:"--legend-stone",desert:"--legend-desert",tundra:"--legend-tundra",taiga:"--legend-taiga",savanna:"--legend-savanna",rainforest:"--legend-rainforest",jungle:"--legend-jungle",swamp:"--legend-swamp",wetland:"--legend-wetland",sand:"--legend-sand",coast:"--legend-coast",island:"--legend-island",mountain:"--legend-mountain",alpine:"--legend-alpine",volcanic:"--legend-volcanic",temperate:"--legend-temperate",tropical:"--legend-tropical",plains:"--legend-plains"});let Ai=null;function Xp(e,t){if(!e||typeof e.getPropertyValue!="function")return"";try{return e.getPropertyValue(t)||""}catch{return""}}function Vp(){let e=null;if(typeof document<"u"&&document.documentElement)try{e=getComputedStyle(document.documentElement)}catch{e=null}const t={};for(const[n,r]of Object.entries(Gp)){const o=co[n],i=Xp(e,r).trim();t[n]=i||o}return t}function xl({forceRefresh:e=!1}={}){if(e&&(Ai=null),Ai)return{...Ai};const t=Vp();return Ai=t,{...t}}new Proxy({},{get(e,t){if(typeof t=="string"){const n=xl();if(Object.prototype.hasOwnProperty.call(n,t))return n[t];if(Object.prototype.hasOwnProperty.call(co,t))return co[t]}},has(e,t){return Object.prototype.hasOwnProperty.call(co,t)},ownKeys(){return Reflect.ownKeys(co)},getOwnPropertyDescriptor(e,t){if(Object.prototype.hasOwnProperty.call(co,t))return{configurable:!0,enumerable:!0,value:xl()[t],writable:!1}}});const Jc=new Set(["water","ocean","lake","river","marsh","mangrove"]);function Tn(e){return e?Jc.has(e):!1}function Ha(e=Zr,t=$a,n=0,r=0){const o=Math.max(1,Math.trunc(e)),i=Math.max(1,Math.trunc(t)),a=Math.floor(o/2),d=Math.floor(i/2);return{xStart:Math.round(n)-a,yStart:Math.round(r)-d}}function Kp(e){let t=1779033703^e.length;for(let n=0;n<e.length;n++)t=Math.imul(t^e.charCodeAt(n),3432918353),t=t<<13|t>>>19;return function(){return t=Math.imul(t^t>>>16,2246822507),t=Math.imul(t^t>>>13,3266489909),(t^=t>>>16)>>>0}}function Zp(e){return function(){let t=e+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function ti(e,t,n,r=""){return Zp(Kp(`${e}:${t}:${n}:${r}`)())()}function Ao(e,t,n,r=""){return ti(e,t,n,r)}function Et(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function Ka(e,t,n){return e+(t-e)*n}function Jp(e,t,n,r=0,o=0,i=100){if(!Array.isArray(e)||e.length===0)return{total:0,land:0,water:0,ore:0,usable:0};const a=i*i,d={total:0,land:0,water:0,ore:0,usable:0};for(let l=0;l<e.length;l++){const c=e[l];if(!c)continue;const u=n+l-o;if(!(u*u>a))for(let p=0;p<c.length;p++){const h=c[p];if(!h)continue;const b=t+p-r;if(!(b*b+u*u>a)){if(d.total++,Tn(h)){d.water++;continue}d.land++,h==="ore"?d.ore++:d.usable++}}}return d}function fs(e,t,n,r=0,o=0,i=100,a={minLand:.5,maxOre:.4}){const d=Jp(e,t,n,r,o,i),l=Math.max(1,d.total),c=Math.max(1,d.usable),f=Et(d.land/l,0,1),u=Et(d.ore/c,0,1),p=Number.isFinite(a==null?void 0:a.minLand)?a.minLand:.5,h=Number.isFinite(a==null?void 0:a.maxOre)?a.maxOre:.4;return{stats:d,landRatio:f,oreRatio:u,meetsLand:f>=p,meetsOre:u<=h}}function Qp(e,t){return Math.round(Math.hypot(e,t))}const Qc=16;function em({width:e,height:t,tiles:n,terrainTypes:r,chunkSize:o=Qc}){const i=Math.max(1,Math.trunc(o)),a=Math.ceil(Math.max(1,Math.trunc(e))/i),d=Math.ceil(Math.max(1,Math.trunc(t))/i);function l(u,p){const h=u*i,g=p*i;for(let b=0;b<i;b++){const S=h+b;if(S>=t)break;const v=r[S],k=n[S];if(!(!v||!k))for(let E=0;E<i;E++){const A=g+E;if(A>=e)break;const L=v[A],F=typeof L=="string"&&L?Ui[L]||L:Ui.open;k[A]=F||Ui.open}}}function c(){for(let u=0;u<d;u++)for(let p=0;p<a;p++)l(u,p)}function f({full:u=!1,chunks:p=[]}={}){if(u){c();return}!Array.isArray(p)||p.length===0||p.forEach(h=>{if(!h)return;const g=Math.trunc(h.row),b=Math.trunc(h.column);Number.isNaN(g)||Number.isNaN(b)||g<0||b<0||g>=d||b>=a||l(g,b)})}return{chunkSize:i,chunkRows:d,chunkColumns:a,renderAll:c,renderDirty:f,renderChunk:l}}function tm(e,t,n,r=100,o={minLand:.5,maxOre:.4},i={}){if(!Array.isArray(e)||e.length===0)return null;const a=(i==null?void 0:i.centerX)??0,d=(i==null?void 0:i.centerY)??0,l=Et(Math.trunc((i==null?void 0:i.limit)??200),1,2e3),c=[];for(let p=0;p<e.length;p++){const h=e[p];if(h)for(let g=0;g<h.length;g++){const b=h[g];if(!b||Tn(b))continue;const S=t+g,v=n+p,k=Math.hypot(S-a,v-d);c.push({row:p,col:g,worldX:S,worldY:v,distance:k})}}c.sort((p,h)=>p.distance!==h.distance?p.distance-h.distance:p.worldY!==h.worldY?p.worldY-h.worldY:p.worldX-h.worldX);let f=null;const u=Math.min(l,c.length);for(let p=0;p<u;p++){const h=c[p],g=fs(e,t,n,h.worldX,h.worldY,r,o),b=g.landRatio-g.oreRatio*.2,S={...h,validation:g,score:b};if(g.meetsLand&&g.meetsOre)return S;(!f||S.score>f.score)&&(f=S)}return f}function ed(e,t,n,r,o){const i=t/r,a=n/r,d=Math.floor(i),l=Math.floor(a),c=d+1,f=l+1,u=i-d,p=a-l,h=ti(e,d,l,o),g=ti(e,c,l,o),b=ti(e,d,f,o),S=ti(e,c,f,o),v=Ka(h,g,u),k=Ka(b,S,u);return Ka(v,k,p)}function nm(e,t,n,r){return ed(e,t,n,r,"veg")}function rm(e,t,n,r){return ed(e,t,n,r,"ore")}function Cr(e,t=Date.now(),n=null,r=null,o=Zr,i=o,a=C.time.season,d,l=null,c=null,f=!1){var lt,tt,Ie,Ct;const u=Math.max(1,Math.trunc(o)),p=Math.max(1,Math.trunc(i??o??Zr)),{xStart:h,yStart:g}=Ha(u,p);let b=Number.isFinite(n)?Math.trunc(n):h,S=Number.isFinite(r)?Math.trunc(r):g;const v=b,k=S,E=Mr(e),A=Nc(E),L=xr(c||{}),F=L.advanced||{},O=(L.rainfall-50)/100,H=(L.temperature-50)/100,_=(L.mountains-50)/100,$=(L.waterTable-50)/100;(L.rivers100-50)/100,(L.lakes100-50)/100;let s=(E==null?void 0:E.openLand)??.5;s+=H*.18,s-=O*.22,s-=Math.max(0,_)*.12,s=Et(s,.1,.9);const R=Et(20+s*80,10,140),W=Et(R+((F.vegetationScale??50)-50)/50*25,8,160),K=((lt=E==null?void 0:E.elevation)==null?void 0:lt.base)??.5,ne=((tt=E==null?void 0:E.elevation)==null?void 0:tt.variance)??.5,ye=((Ie=E==null?void 0:E.elevation)==null?void 0:Ie.scale)??50,me={base:Et(K+$*-.12+O*-.08+_*.05+((F.elevationBase??50)-50)/100*.3,.05,.95),variance:Et(ne+_*.45+((F.elevationVariance??50)-50)/100*.5,.05,1.5),scale:Et(ye+_*40+((F.elevationScale??50)-50)/100*70,12,200)},Oe=Et(.95-L.oreDensity/100*.35,.55,.98),Ye=Et(Oe-((F.oreThresholdOffset??50)-50)/100*.2,.5,.98),Ge=Et(10+(F.oreNoiseScale??50)/100*24,6,40),Ve=Array.from({length:p},()=>Array(u).fill("?")),Se=Array.from({length:p},()=>new Array(u)),at=Array.from({length:p},()=>new Array(u)),Xe=[],ht=Math.max(u,p)*1.2,_t=xp(t,{base:me.base,variance:me.variance,scale:me.scale,worldScale:ht,maskStrength:Et(.5+_*.2-$*.1,.25,.85),maskBias:Et(($+O)*-.08,-.25,.2)});for(let Ae=0;Ae<p;Ae++){const fe=[];for(let Z=0;Z<u;Z++){const Pe=v+Z,$e=k+Ae,Re=_t.sample(Pe,$e);fe.push(Re)}Xe.push(fe)}const Je=qp({seed:t,width:u,height:p,elevations:Xe,biome:E?{id:E.id,features:E.features,elevation:E.elevation}:null,world:L}),Tt=Yp({hydrology:Je,elevations:Xe,seed:t,random:(Ae,fe,Z="")=>Ao(t,v+Ae,k+fe,`mangrove:${Z}`)});Tt&&(Je.mangroveStats=Tt);const rt=Je.waterTable??Je.filledElevation;let pt=0;const qt=Je.types.map(Ae=>Ae.slice());function gt(Ae){var re,we,ae,Q,Fe,he;const fe=Et(Ae,0,1);Je.seaLevel=fe,Je.rules&&(Je.rules.seaLevel=fe);const Z=Array.from({length:p},()=>new Array(u).fill(0)),Pe=Et(Ye-.08,.3,.92),$e=[],Re=Array.from({length:p},()=>new Array(u));for(let U=0;U<p;U++)for(let oe=0;oe<u;oe++){const Ne=Xe[U][oe];let ee=((re=qt[U])==null?void 0:re[oe])??"land"??"land";ee==="ocean"||ee==="lake"?Ne>=fe&&(ee="land"):(ee==="land"||ee==="coast"||ee==="marsh")&&Ne<fe&&(ee="ocean"),Re[U][oe]=ee}const Ze=[[-1,0],[1,0],[0,-1],[0,1]],st=(U,oe,Ne)=>{var Ce;let J=!1,ee=!1;for(let ke=0;ke<Ze.length;ke+=1){const de=Ze[ke][0],ge=Ze[ke][1],le=oe+de,it=Ne+ge;if(le<0||it<0||le>=u||it>=p)continue;const en=(Ce=U[it])==null?void 0:Ce[le];if(Jc.has(en)?en==="river"&&(ee=!0):J=!0,J&&ee)break}return{touchesLand:J,touchesRiver:ee}};for(let U=0;U<p;U++)for(let oe=0;oe<u;oe++){if(((we=qt[U])==null?void 0:we[oe])!=="mangrove")continue;if(Xe[U][oe]<fe){Re[U][oe]="ocean";continue}const{touchesLand:J,touchesRiver:ee}=st(Re,oe,U);!J&&!ee&&(Re[U][oe]="ocean")}for(let U=0;U<p;U++){const oe=Se[U],Ne=at[U],J=Z[U];for(let ee=0;ee<u;ee++){const Ce=v+ee,ke=k+U,de=((ae=Re[U])==null?void 0:ae[ee])??"land";Je.types[U][ee]=de;let ge,le=0;de&&de!=="land"?ge=de:(ge=nm(t,Ce,ke,W)<s?A:"forest",le=rm(t,Ce,ke,Ge)),Ne[ee]=ge,oe[ee]=ge,J[ee]=le}}for(let U=0;U<p;U++){const oe=Se[U],Ne=at[U];for(let J=0;J<u;J++)Je.types[U][J]==="land"&&(Xe[U][J]<fe||Z[U][J]<=Pe||(Ne[J]="stone",oe[J]!=="ore"&&(oe[J]="stone")))}for(let U=0;U<p;U++){const oe=Se[U],Ne=at[U];for(let J=0;J<u;J++)Je.types[U][J]==="land"&&(Xe[U][J]<fe||Z[U][J]<=Ye||(Ne[J]="stone",oe[J]="ore",$e.push([J,U])))}if($e.length){const U=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(const[oe,Ne]of $e)if(((Q=Se[Ne])==null?void 0:Q[oe])==="ore")for(const[J,ee]of U){const Ce=oe+J,ke=Ne+ee;if(Ce<0||ke<0||Ce>=u||ke>=p)continue;const de=Se[ke],ge=at[ke];!de||!ge||de[Ce]!=="ore"&&(Tn(de[Ce])||(ge[Ce]="stone",de[Ce]="stone"))}for(const[oe,Ne]of $e){if(((Fe=Se[Ne])==null?void 0:Fe[oe])!=="ore"||U.some(([ke,de])=>{var it;const ge=oe+ke,le=Ne+de;return ge<0||le<0||ge>=u||le>=p?!1:((it=Se[le])==null?void 0:it[ge])==="stone"}))continue;let ee=null,Ce=1/0;for(const[ke,de]of U){const ge=oe+ke,le=Ne+de;if(ge<0||le<0||ge>=u||le>=p)continue;const it=Se[le],en=at[le];if(!it||!en)continue;const sr=it[ge];if(Tn(sr))continue;if(sr!=="ore"){ee={nx:ge,ny:le},Ce=-1;break}const _n=(he=Z[le])==null?void 0:he[ge];Number.isFinite(_n)&&_n<Ce&&(Ce=_n,ee={nx:ge,ny:le})}if(ee){const{nx:ke,ny:de}=ee,ge=Se[de],le=at[de];ge&&le&&(le[ke]="stone",ge[ke]="stone")}}}}gt(Je.seaLevel);const Le=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];function bt({includeClusters:Ae=!1}={}){var re;const fe=[];for(let we=0;we<p;we++)for(let ae=0;ae<u;ae++){const Q=(re=Se[we])==null?void 0:re[ae];if(!Q||Tn(Q))continue;Le.some(([he,U])=>{var J;const oe=ae+he,Ne=we+U;return oe<0||Ne<0||oe>=u||Ne>=p?!1:((J=Je.types[Ne])==null?void 0:J[oe])==="ocean"})&&fe.push([ae,we])}if(!fe.length)return{length:0,largest:0,ratio:1,clusters:[],largestIndex:-1};const Z=new Set,Pe=new Set(fe.map(([we,ae])=>ae*u+we));let $e=0,Re=-1;const Ze=Ae?[]:null;let st=0;for(const[we,ae]of fe){const Q=ae*u+we;if(Z.has(Q))continue;const Fe=[[we,ae]];Z.add(Q);let he=0;const U=Ae?[]:null;for(;Fe.length;){const[oe,Ne]=Fe.shift();he+=1,U&&U.push([oe,Ne]);for(const[J,ee]of Le){const Ce=oe+J,ke=Ne+ee;if(Ce<0||ke<0||Ce>=u||ke>=p)continue;const de=ke*u+Ce;!Pe.has(de)||Z.has(de)||(Z.add(de),Fe.push([Ce,ke]))}}he>$e&&($e=he,Re=st),U&&(Ze.push({size:he,tiles:U}),st+=1)}return{length:fe.length,largest:$e,ratio:$e/fe.length,clusters:Ze??[],largestIndex:Re}}const G=em({width:u,height:p,tiles:Ve,terrainTypes:Se,chunkSize:Qc});G.renderAll();const Qe=Je.seaLevel;function St(Ae){const fe=Et(Ae,-.2,.2);return Math.abs(fe-pt)<1e-6?!1:(pt=fe,gt(Qe+pt),G.renderAll(),!0)}function xn(){var st;const Ae=bt({includeClusters:!0});if(!Ae.clusters.length||Ae.largestIndex<0)return!1;const fe=Ae.clusters[Ae.largestIndex];if(!fe||!((st=fe.tiles)!=null&&st.length))return!1;const Z=new Set,Pe=(re,we)=>{if(re<0||we<0||re>=u||we>=p)return;const ae=Math.floor(we/G.chunkSize),Q=Math.floor(re/G.chunkSize);ae<0||Q<0||ae>=G.chunkRows||Q>=G.chunkColumns||Z.add(`${ae}:${Q}`)},$e=(re,we)=>{if(re<0||we<0||re>=u||we>=p)return!1;const ae=Se[we],Q=Je.types[we];if(!ae||!Q)return!1;let Fe=!1;const he=ae[re];return(!he||Tn(he))&&(ae[re]=A,Fe=!0),Q[re]!=="land"&&(Q[re]="land",Fe=!0),Fe&&Pe(re,we),Fe},Re=(re,we,ae,Q)=>{const Fe=[];let he=Math.trunc(re),U=Math.trunc(we);const oe=Math.trunc(ae),Ne=Math.trunc(Q);let J=Math.abs(oe-he),ee=Math.abs(Ne-U);const Ce=he<oe?1:-1,ke=U<Ne?1:-1;let de=J-ee;for(;he!==oe||U!==Ne;){Fe.push([he,U]);const ge=de*2;ge>-ee&&(de-=ee,he+=Ce),ge<J&&(de+=J,U+=ke)}return Fe.push([he,U]),Fe};let Ze=!1;if(Ae.clusters.forEach((re,we)=>{var U;if(!((U=re==null?void 0:re.tiles)!=null&&U.length)||we===Ae.largestIndex)return;let ae=null,Q=1/0;for(const[oe,Ne]of re.tiles)for(const[J,ee]of fe.tiles){const Ce=oe-J,ke=Ne-ee,de=Ce*Ce+ke*ke;de<Q&&(Q=de,ae={from:[oe,Ne],to:[J,ee]})}if(!ae)return;const Fe=Re(ae.from[0],ae.from[1],ae.to[0],ae.to[1]);let he=!1;for(let oe=1;oe<Fe.length-1;oe++){const[Ne,J]=Fe[oe];he=$e(Ne,J)||he}he&&(Ze=!0)}),Ze){const re=Array.from(Z).map(we=>{const[ae,Q]=we.split(":").map(Fe=>Number.parseInt(Fe,10));return{row:ae,column:Q}});G.renderDirty({chunks:re,full:!1})}return Ze}const Ut=()=>Je.seaLevel+1e-5,Yt=(Ae,fe)=>{var Re;const Z=(Re=Se[Ae])==null?void 0:Re[fe];if(Z&&Tn(Z))return!0;const Pe=rt==null?void 0:rt[Ae];if(!Pe)return!1;const $e=Pe[fe];return Number.isFinite($e)&&$e<=Ut()};function be(Ae,fe){let Z=null;for(let Pe=0;Pe<p;Pe++)if(Se[Pe])for(let Re=0;Re<u;Re++){if(Yt(Pe,Re))continue;const Ze=Ae+Re,st=fe+Pe,re=Math.hypot(Ze,st);(!Z||re<Z.distance||re===Z.distance&&(Math.abs(st)<Math.abs(Z.worldY)||Math.abs(st)===Math.abs(Z.worldY)&&Math.abs(Ze)<Math.abs(Z.worldX)))&&(Z={worldX:Ze,worldY:st,distance:re})}return Z}let kt=Number.isFinite(d)?Et(d,0,1):Je.seaLevel,Ke=0,ct=0;const mt={minLand:.5,maxOre:.4},ot=100,dn=(c==null?void 0:c.seed)??t;let ue=null,Qt=[];if(!f){ue=new hp({parameters:{xStart:b,yStart:S,originShiftX:Ke,originShiftY:ct,seaLevelAdjustment:pt},maxIterations:6,chunkSize:G.chunkSize,chunkRows:G.chunkRows,chunkColumns:G.chunkColumns,gridWidth:u,gridHeight:p,evaluate:({parameters:Z})=>{const Pe=Z.originShiftX||0,$e=Z.originShiftY||0,Re=Z.xStart-Pe,Ze=Z.yStart-$e,st=fs(Se,Re,Ze,0,0,ot,mt),re=bt(),we=-Re,ae=-Ze,Q=we>=0&&we<u&&ae>=0&&ae<p,Fe=Q&&Yt(ae,we),he=re.ratio>=.95,U=st.landRatio-st.oreRatio*.2-(Fe?.25:0);return{...st,satisfied:st.meetsLand&&st.meetsOre&&!Fe&&he,xStart:Re,yStart:Ze,originShiftX:Z.originShiftX,originShiftY:Z.originShiftY,seaLevelAdjustment:Z.seaLevelAdjustment||0,coastline:re,coastlineSatisfied:he,coastlineRatio:re.ratio,origin:{col:we,row:ae,inBounds:Q,isWater:Fe},thresholds:mt,radius:ot,seed:dn,baseXStart:Z.xStart,baseYStart:Z.yStart,score:U}},regenerate:({parameters:Z,metrics:Pe,context:$e})=>{var Q,Fe,he,U,oe,Ne;if(!Pe)return null;const Re=$e==null?void 0:$e.solver,Ze=(J,ee)=>{Re&&(!Number.isFinite(J)||!Number.isFinite(ee)||Re.markTileDirty(J,ee))},st=Z.originShiftX||0,re=Z.originShiftY||0,we=Z.xStart-st,ae=Z.yStart-re;if((Q=Pe.origin)!=null&&Q.isWater){const J=be(we,ae);if(J){Ze(Pe.origin.col,Pe.origin.row);const ee={originShiftX:st+J.worldX,originShiftY:re+J.worldY,seaLevelAdjustment:Z.seaLevelAdjustment||0},Ce=Z.xStart-ee.originShiftX,ke=Z.yStart-ee.originShiftY;Ze(-Ce,-ke);const de=Qp(J.worldX,J.worldY),ge=de>0?`Shifted the landing ${de} tiles to escape flooded ground.`:"Shifted the landing away from flooded ground.";return{parameters:ee,message:ge}}}if(!Pe.meetsLand){const J=Z.seaLevelAdjustment||0,ee=Et(J-.02,-.3,.2);if(ee!==J&&((Fe=$e.applySeaLevelAdjustment)==null?void 0:Fe.call($e,ee)))return{parameters:{xStart:Z.xStart,yStart:Z.yStart,originShiftX:st,originShiftY:re,seaLevelAdjustment:ee},message:"Lowered the sea level to reveal additional shoreline.",markAllDirty:!0}}if(!Pe.meetsLand||!Pe.meetsOre){const J=tm(Se,we,ae,ot,mt,{limit:400}),ee=J==null?void 0:J.validation;if(J&&(ee!=null&&ee.meetsLand)&&(ee!=null&&ee.meetsOre)&&!((he=ee.origin)!=null&&he.isWater)&&(J.worldX!==0||J.worldY!==0)){Ze((U=Pe.origin)==null?void 0:U.col,(oe=Pe.origin)==null?void 0:oe.row);const Ce={originShiftX:st+J.worldX,originShiftY:re+J.worldY,seaLevelAdjustment:Z.seaLevelAdjustment||0},ke=Z.xStart-Ce.originShiftX,de=Z.yStart-Ce.originShiftY;Ze(-ke,-de);const ge=J.distance>0?`Relocated the landing ${J.distance} tiles for better terrain.`:"Relocated the landing for improved terrain.";return{parameters:Ce,message:ge}}}if(!Pe.meetsOre)return{parameters:{originShiftX:st,originShiftY:re,seaLevelAdjustment:Z.seaLevelAdjustment||0},message:"Expanded the survey radius to balance nearby resources."};if(Number.isFinite(Pe.coastlineRatio)&&Pe.coastlineRatio<.95){const J=Z.seaLevelAdjustment||0,ee=Et(J+.02,-.3,.3);if(ee!==J&&((Ne=$e.applySeaLevelAdjustment)==null?void 0:Ne.call($e,ee)))return{parameters:{xStart:Z.xStart,yStart:Z.yStart,originShiftX:st,originShiftY:re,seaLevelAdjustment:ee},message:"Raised the sea level to smooth the coastline.",markAllDirty:!0}}return{stop:!0}}}).solve({applySeaLevelAdjustment:St}),Qt=ue!=null&&ue.messages?[...ue.messages]:[],ue!=null&&ue.dirty&&G.renderDirty(ue.dirty);let fe=!1;for(let Z=0;Z<6&&!(!xn()||(fe=!0,bt().ratio>=.95));Z+=1);fe&&Qt.push("Smoothed minor coastline fragments for continuity."),ue!=null&&ue.parameters&&(Ke=ue.parameters.originShiftX||0,ct=ue.parameters.originShiftY||0,b=ue.parameters.xStart-Ke,S=ue.parameters.yStart-ct)}Number.isFinite(d)||(kt=Je.seaLevel);const vn=bt(),Sn=fs(Se,b,S,0,0,ot,mt),ir=-b,ar=-S,Dt=ir>=0&&ir<u&&ar>=0&&ar<p,pe=Dt&&Yt(ar,ir),qe={...Sn,xStart:b,yStart:S,originShiftX:Ke,originShiftY:ct,seaLevelAdjustment:((Ct=ue==null?void 0:ue.parameters)==null?void 0:Ct.seaLevelAdjustment)||0,coastline:vn,coastlineRatio:vn.ratio,coastlineSatisfied:vn.ratio>=.95,origin:{col:ir,row:ar,inBounds:Dt,isWater:pe},satisfied:Sn.meetsLand&&Sn.meetsOre&&!pe&&vn.ratio>=.95};if(!f&&Qt.length){const Ae=qe?` (land ${Math.round(qe.landRatio*100)}% • ore ${Math.round(qe.oreRatio*100)}% of usable land)`:"",fe=Qt.join(" ");pp(`Adjusted landing zone for fairness: ${fe}${Ae}`,{metrics:qe,history:ue.history,iterations:ue.iterations})}const yt=l?{xStart:Number.isFinite(l.xStart)?Math.trunc(l.xStart-Ke):b,yStart:Number.isFinite(l.yStart)?Math.trunc(l.yStart-ct):S,width:Math.max(1,Math.trunc(l.width??u)),height:Math.max(1,Math.trunc(l.height??p))}:{xStart:b,yStart:S,width:u,height:p};return{scale:100,seed:t,xStart:b,yStart:S,width:u,height:p,tiles:Ve,types:Se,substrateTypes:at,elevations:Xe,season:a,waterLevel:kt,hydrology:Je,solver:{metrics:qe,history:(ue==null?void 0:ue.history)??[],iterations:(ue==null?void 0:ue.iterations)??0,messages:Qt},worldSettings:L,viewport:yt,openTerrainType:A}}const om=new Set(["ore","stone"]);function im(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}function td(e){if(!e||!Array.isArray(e.types))return{forest:0,cleared:0};const t=im(To)**2||0;let n=0,r=0;return e.types.forEach(o=>{o.forEach(i=>{i==="forest"?n+=1:(om.has(i)||wr(i))&&(r+=1)})}),{forest:n*t,cleared:r*t}}function ps(e){if(!e||e.siteCapacities&&typeof e.siteCapacities=="object")return e;const t=td(e.map);return e.siteCapacities=t,e.id&&C.updateItem("locations",{id:e.id,siteCapacities:t}),e}function vl(e,t,n=C.time.season,r=Date.now(),o=null){var g;const i=((g=Mr(t))==null?void 0:g.features)||[],a=ou(t),d=Zr,l=$a,{xStart:c,yStart:f}=Ha(d,l),u=Cr(t,r,c,f,d,l,n,void 0,void 0,o,!1),p=td(u),h={id:e,biome:t,features:i,pointsOfInterest:a,map:u,siteCapacities:p,worldSettings:u.worldSettings};return C.addItem("locations",h),h}function Bo(){return[...C.locations.values()].map(e=>ps(e))}function am(e){if(!e){const n=Bo()[0];return n&&ps(n).siteCapacities||{forest:0,cleared:0}}const t=C.getItem("locations",e);return t?ps(t).siteCapacities||{forest:0,cleared:0}:{forest:0,cleared:0}}const nr=new Map;function pi(){if(!(C.unlockedBuildings instanceof Set)){const e=Array.isArray(C.unlockedBuildings)?C.unlockedBuildings:[];C.unlockedBuildings=new Set(e)}if(!(C.research instanceof Set)){const e=Array.isArray(C.research)?C.research:[];C.research=new Set(e)}typeof C.buildingSeq!="number"&&(C.buildingSeq=0)}function sm(e,t={}){return Object.entries(t).forEach(([n,r])=>{!Number.isFinite(r)||r===0||(e[n]=(e[n]||0)+r)}),e}function Ir(e={}){return Object.fromEntries(Object.entries(e).map(([t,n])=>[t,n]))}function dr(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}function lm(e={}){if(!e)return null;const t=[];if(Array.isArray(e.categories)&&e.categories.forEach(f=>{if(!f&&f!==0)return;const u=String(f).trim().toLowerCase();u&&t.push(u)}),e.category){const f=String(e.category).trim().toLowerCase();f&&t.push(f)}const n=[...new Set(t)];if(!n.length)return null;const r=e.dimensions||{},o=dr(r.width),i=dr(r.depth),a=e.accessClearance||{},d=dr(a.side),l={front:dr(a.front),back:dr(a.back),left:dr(a.left)||d,right:dr(a.right)||d};let c=dr(e.surfaceArea);if(!c){const f=o+l.left+l.right,u=i+l.front+l.back;f>0&&u>0&&(c=f*u)}return{categories:n,primaryCategory:n[0],surfaceArea:c,dimensions:{width:o,depth:i},accessClearance:l,raw:{...e}}}function cm(){return Bo()[0]||null}function dm(e,t){if(!e||!t)return 0;Tr();const n=String(t).toLowerCase();let r=0;return C.buildings.forEach(o=>{var l;if(o.locationId!==e)return;const i=nr.get(o.typeId),a=(l=i==null?void 0:i.stats)==null?void 0:l.site;!a||!a.surfaceArea||String(o.siteCategory||a.primaryCategory||"").toLowerCase()!==n||(r+=a.surfaceArea||0)}),r}function um(e,t){var l,c;const n=(l=e==null?void 0:e.stats)==null?void 0:l.site;if(!n||!n.surfaceArea||!((c=n.categories)!=null&&c.length))return{siteOk:!0,status:null};if(!t){const f=n.categories.map(u=>({category:u,capacity:0,usage:0,remaining:0}));return{siteOk:!1,status:{categories:f,selected:f[0]||null}}}const r=am(t.id),o=n.categories.map(f=>{const u=(r==null?void 0:r[f])??0,p=dm(t.id,f),h=u-p;return{category:f,capacity:u,usage:p,remaining:h}}),i=n.surfaceArea||0;let a=o.find(f=>f.remaining>=i-1e-6);return!a&&o.length&&(a=o[0]),{siteOk:!!(a&&a.remaining>=i-1e-6),status:{categories:o,selected:a||null}}}function fm(e={}){var r,o;const t=lm((r=e.requirements)==null?void 0:r.site),n={totalLaborHours:0,minBuilders:Math.max(1,((o=e.requirements)==null?void 0:o.minBuilders)||1),totalResources:{},components:[],addons:[],site:t,coreComponent:null,coreResources:{},coreLaborHours:0};if((e.components||[]).forEach((i,a)=>{const d=Math.max(0,i.laborHours||0),l=Math.max(1,i.minBuilders||1);n.totalLaborHours+=d,n.minBuilders=Math.max(n.minBuilders,l);const c=Ir(i.resources||{});sm(n.totalResources,c);const f=!!i.isCore||!n.coreComponent&&a===0,u={...i,isCore:f,laborHours:d,minBuilders:l,resources:c};n.components.push(u),f&&!n.coreComponent&&(n.coreComponent=u,n.coreResources=Ir(c),n.coreLaborHours=d)}),!n.coreComponent&&n.components.length){const i=n.components[0];i.isCore=!0,n.coreComponent=i,n.coreResources=Ir(i.resources||{}),n.coreLaborHours=i.laborHours||0}return(e.addons||[]).forEach(i=>{const a=Math.max(0,i.laborHours||0),d=Math.max(1,i.minBuilders||1),l=Ir(i.resources||{});n.addons.push({...i,laborHours:a,minBuilders:d,resources:l,totals:{laborHours:a,resources:Ir(l)}})}),n.totalLaborHours<=0&&(n.totalLaborHours=n.minBuilders),n}function pm(e){if(!(e!=null&&e.id)||nr.has(e.id))return;const t=fm(e);nr.set(e.id,{...e,stats:t})}function mm(e=[],t=""){if(!t)return!0;const n=t.toLowerCase();return e.some(r=>r.toLowerCase().includes(n))}function hm(e,t=null){var a,d;const n=((a=e.requirements)==null?void 0:a.locationTags)||[];if(!n.length)return!0;const r=n.map(l=>String(l||"").toLowerCase());if(r.some(l=>l==="open"||l==="any"))return!0;const o=t?[t]:Bo();if(!o.length)return!1;const i=(((d=o[0])==null?void 0:d.features)||[]).map(l=>l.toLowerCase());return r.some(l=>mm(i,l))}function Sl(e){return pi(),C.research.has(e)}function ro(e){return!e&&e!==0?[]:Array.isArray(e)?e:[e]}function kl(e){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number")return{id:String(e),count:1};if(e&&typeof e=="object"){const t=e.id??e.building??e.type;if(!t&&t!==0)return null;const n=Number.isFinite(e.count)?Math.max(1,e.count):Number.isFinite(e.required)?Math.max(1,e.required):1;return{id:String(t),count:n}}return null}function nd(e={}){if(!e)return{ok:!1,missing:null};if(e.always)return{ok:!0,missing:null};let t=!0;const n={technologies:[],anyTechnology:[],research:[],anyResearch:[],buildings:[],anyBuilding:[],resources:[],custom:!1};if(e.custom&&typeof e.custom=="function")try{e.custom(C)||(t=!1,n.custom=!0)}catch(c){console.warn("Building unlock custom check failed",c),t=!1,n.custom=!0}const r=ro(e.technologies).map(c=>c||c===0?String(c):null).filter(Boolean);if(r.length){const c=r.filter(f=>!yn(f));c.length&&(t=!1,n.technologies=[...new Set(c)])}const o=ro(e.anyTechnology).map(c=>c||c===0?String(c):null).filter(Boolean);o.length&&(o.some(f=>yn(f))||(t=!1,n.anyTechnology=[...new Set(o)]));const i=ro(e.research).map(c=>c||c===0?String(c):null).filter(Boolean);if(i.length){const c=i.filter(f=>!Sl(f));c.length&&(t=!1,n.research=[...new Set(c)])}const a=ro(e.anyResearch).map(c=>c||c===0?String(c):null).filter(Boolean);a.length&&(a.some(f=>Sl(f))||(t=!1,n.anyResearch=[...new Set(a)]));const d=ro(e.buildings).map(kl).filter(Boolean);if(d.length){const c=[];d.forEach(f=>{const u=Yi(f.id,{statuses:["completed"]});u<f.count&&c.push({id:f.id,required:f.count,current:u})}),c.length&&(t=!1,n.buildings=c)}const l=ro(e.anyBuilding).map(kl).filter(Boolean);if(l.length&&(l.some(f=>Yi(f.id,{statuses:["completed"]})>=f.count)||(t=!1,n.anyBuilding=l.map(f=>({id:f.id,required:f.count,current:Yi(f.id,{statuses:["completed"]})})))),e.resources){const c=Gi(e.resources);c.missing.length&&(t=!1,n.resources=c.missing.map(f=>({name:f.name,required:f.required,available:f.available})))}return Object.keys(n).forEach(c=>{const f=n[c];Array.isArray(f)&&!f.length&&delete n[c],(f===!1||f===null)&&delete n[c]}),{ok:t,missing:Object.keys(n).length?n:null}}function rd(e={}){return!!nd(e).ok}function Cl(e){if(!e&&e!==0)return;const t=xu(e);t!=null&&t.definition?Tc(e):(pi(),C.research.add(String(e)))}function gm(e){var r;const t=(r=e==null?void 0:e.effects)==null?void 0:r.unlocks;if(!t)return;(Array.isArray(t)?t:[t]).forEach(o=>{if(!(!o&&o!==0)){if(typeof o=="string"||typeof o=="number"){Cl(o);return}if(o&&typeof o=="object"){const i=o.technology??o.tech??o.id;(i||i===0)&&Cl(i)}}})}function bm(e){return pi(),C.unlockedBuildings.has(e.id)?!0:rd(e.unlock)?(C.unlockedBuildings.add(e.id),!0):!1}function ym(e){return Number.isFinite(e.maxCount)?e.maxCount:e.allowMultiple?1/0:1}function Tr(){C.buildings instanceof Map||(C.buildings=new Map(C.buildings||[]))}function Yi(e,{statuses:t=null}={}){Tr();const n=t?new Set(t):null;let r=0;return C.buildings.forEach(o=>{o.typeId===e&&(n&&!n.has(o.status)||(r+=1))}),r}function No(e){if(!e&&e!==0)return!1;Tr();const t=String(e).toLowerCase();let n=!1;return C.buildings.forEach(r=>{n||r.status==="completed"&&String(r.typeId).toLowerCase()===t&&(n=!0)}),n}function Gi(e={}){const t=[],n={};return Object.entries(e).forEach(([r,o])=>{if(!o||o<=0)return;const i=ci(r).quantity||0;n[r]={required:o,available:i,deficit:Math.max(0,o-i)},i<o&&t.push({name:r,required:o,available:i})}),{missing:t,totals:n}}function wm(e={}){const t={wood:0,stone:0,metal:0};return Object.entries(e).forEach(([n,r])=>{const o=Math.max(0,Number(r)||0);if(!o)return;const i=String(n).toLowerCase();/(wood|log|timber|lumber|beam|board|plank|sapling|pole|stave|branch)/.test(i)&&(t.wood+=o),/(stone|rock|clay|brick|adobe|mortar|slate|granite|cobbl|marble)/.test(i)&&(t.stone+=o),/(metal|ingot|iron|copper|bronze|steel|nail|spike|ore)/.test(i)&&(t.metal+=o)}),t}function xm(e={}){const t=wm(e),n=Object.entries(t).filter(([,a])=>a>0);if(!n.length)return{primary:"construction",extras:[]};const[r]=n.reduce((a,d)=>d[1]>a[1]?d:a,n[0]),o=[],i=(a,d)=>{!a||d<=0||o.some(l=>l.id===a)||o.push({id:a,effortScale:d})};switch(r){case"stone":i("masonry",.7);break;case"wood":i("carpentry",.7);break;case"metal":i("smelting",.55);break}return n.forEach(([a])=>{a!==r&&(a==="stone"&&i("masonry",.45),a==="wood"&&i("carpentry",.45),a==="metal"&&i("smelting",.35))}),{primary:"construction",extras:o}}function od(e){var b;const t=nr.get(e);if(!t)return null;const n=bm(t),r=ym(t),o=Yi(e),i=o<r,a=cm(),d=hm(t,a),{siteOk:l,status:c}=um(t,a),f=d&&l,u=Gi(t.stats.coreResources),p=Gi(t.stats.totalResources),h=Gi(((b=t.requirements)==null?void 0:b.craftedGoods)||{}),g=nd(t.unlock);return{type:t,unlocked:n,canBuildMore:i,terrainOk:d,siteOk:l,locationOk:f,hasResources:u.missing.length===0,resourceStatus:u,craftedStatus:h,totalResourceStatus:p,siteStatus:c,existing:o,maxCount:r,unlockStatus:g}}function vm(){return[...nr.values()]}function Sm(){return pi(),C.buildingSeq+=1,`bld-${C.buildingSeq}`}function km(e,{workers:t,locationId:n,x:r=null,y:o=null}={}){var $,s,R,W,K,ne;const i=nr.get(e);if(!i)throw new Error(`Unknown building type ${e}`);const a=od(e);if(!(a!=null&&a.unlocked))throw new Error(`Building ${i.name} is not unlocked`);if(!a.canBuildMore)throw new Error(`No additional ${i.name} can be constructed right now`);if(!a.locationOk)throw new Error(`${i.name} cannot be built at this location`);if(!a.hasResources)throw new Error(`Insufficient resources to begin ${i.name}`);Tr();const d=Math.max(i.stats.minBuilders,t||i.stats.minBuilders||1),l=Math.max(1,i.stats.totalLaborHours),c=Ir(i.stats.totalResources),f=Ir(i.stats.coreResources),u=xm(c),p=((s=($=a==null?void 0:a.siteStatus)==null?void 0:$.selected)==null?void 0:s.category)||((R=i.stats.site)==null?void 0:R.primaryCategory)||null,h=p?String(p).toLowerCase():null,g=((W=i.stats.site)==null?void 0:W.surfaceArea)||0,b=((K=i.stats.coreComponent)==null?void 0:K.id)||null,v=Number.isFinite(r)&&Number.isFinite(o)?{x:Math.trunc(r),y:Math.trunc(o)}:null,k=Sm(),E={id:k,typeId:e,status:"under-construction",locationId:n||((ne=Bo()[0])==null?void 0:ne.id)||null,progressHours:0,totalLaborHours:l,assignedWorkers:d,requiredResources:c,consumedResources:{},addons:[],coreResources:f,coreComponentId:b,siteCategory:h,siteSurfaceArea:g,tile:v};C.addItem("buildings",E);const A=Math.max(1,Math.ceil(l/d)),L=d*A,F={};Object.entries(c).forEach(([ye,me])=>{!me||me<=0||(F[ye]=me/L)});const O=l/L,H=Object.values(c).reduce((ye,me)=>ye+me,0),_=Math.min(100,28+Math.log10(l+1)*18+Math.log10(H+1)*6);return{project:{...E},order:{type:"building",workers:d,hours:A,notes:`${i.name} construction`,metadata:{buildingTypeId:e,projectId:k,typeName:i.name,totalLaborHours:l,perWorkerHourResources:F,progressPerWorkerHour:O,baseComplexity:_,taskComplexity:_,effortHours:l,proficiencyId:u.primary,additionalProficiencies:u.extras.length?u.extras:void 0,taskId:`construction:${e}`,tile:v}}}}function Cm(e,t=0){if(!t)return;Tr();const n=C.getItem("buildings",e);if(!n)return;const r=Math.min(n.totalLaborHours,(n.progressHours||0)+t);C.updateItem("buildings",{id:e,progressHours:r})}function Mm(e,t={}){const n=Object.keys(t||{});if(!n.length)return;Tr();const r=C.getItem("buildings",e);if(!r)return;const o={...r.consumedResources||{}};n.forEach(i=>{const a=t[i];!Number.isFinite(a)||a<=0||(o[i]=(o[i]||0)+a)}),C.updateItem("buildings",{id:e,consumedResources:o})}function Em(e){Tr();const t=C.getItem("buildings",e);if(!t)return null;const n=ln(t.typeId),r=cn?cn():null,o={id:e,status:"completed",progressHours:t.totalLaborHours,completedAt:r};return C.updateItem("buildings",o),n&&gm(n),Ia(),{...t,...o}}function rr({statuses:e=null}={}){Tr();const t=e?new Set(e):null;return[...C.buildings.values()].filter(n=>t?t.has(n.status):!0)}function Ia(){pi(),nr.forEach(e=>{rd(e.unlock)&&C.unlockedBuildings.add(e.id)})}function ln(e){return nr.get(e)||null}function Tm(){nr.size>0||(Mu.forEach(pm),Ia())}Tm();const Ml={open:"--tile-open",forest:"--tile-forest",stone:"--tile-stone",ore:"--tile-ore",water:"--tile-water",ocean:"--legend-ocean",lake:"--legend-lake",river:"--legend-river",marsh:"--legend-marsh",mangrove:"--legend-mangrove",grassland:"--legend-grassland",desert:"--legend-desert",tundra:"--legend-tundra",taiga:"--legend-taiga",savanna:"--legend-savanna",rainforest:"--legend-rainforest",jungle:"--legend-jungle",swamp:"--legend-swamp",wetland:"--legend-wetland",sand:"--legend-sand",coast:"--legend-coast",island:"--legend-island",mountain:"--legend-mountain",alpine:"--legend-alpine",volcanic:"--legend-volcanic",temperate:"--legend-temperate",tropical:"--legend-tropical",plains:"--legend-plains"},si={open:"#facc15",forest:"#16a34a",stone:"#94a3b8",ore:"#f97316",water:"#2d7ff9",ocean:"#2563eb",lake:"#38bdf8",river:"#0ea5e9",marsh:"#4ade80",mangrove:"#065f46",grassland:"#a3e635",desert:"#f4b76b",tundra:"#9ac5ff",taiga:"#2f6b2a",savanna:"#f59e0b",rainforest:"#047857",jungle:"#0f766e",swamp:"#14532d",wetland:"#22c55e",sand:"#fcd34d",coast:"#0ea5e9",island:"#38bdf8",mountain:"#64748b",alpine:"#60a5fa",volcanic:"#ea580c",temperate:"#4ade80",tropical:"#10b981",plains:"#facc15"},El=Object.freeze(Object.fromEntries(Object.keys(si).map(e=>[e,{start:`--tile-${e}-gradient-start`,end:`--tile-${e}-gradient-end`}]))),Am=.22,Nm=.18,Tl="#6b7280";let ri=null,Xi=null;function ko(e){return Number.isFinite(e)?Math.min(255,Math.max(0,Math.round(e))):0}function Al(e){if(!e)return null;const t=String(e).trim();if(!t)return null;const n=t.match(/^#?([0-9a-f]{3}|[0-9a-f]{6})$/i);if(n){let r=n[1];r.length===3&&(r=r.split("").map(i=>i+i).join(""));const o=Number.parseInt(r,16);return Number.isNaN(o)?null:{r:o>>16&255,g:o>>8&255,b:o&255}}if(/^rgba?\(/i.test(t)){const r=t.replace(/rgba?\(/i,"").replace(/\)/g,"").replace(/\//g," ").split(/[\s,]+/).filter(Boolean).slice(0,3).map(o=>Number.parseFloat(o));return r.length<3||r.some(o=>Number.isNaN(o))?null:{r:ko(r[0]),g:ko(r[1]),b:ko(r[2])}}return null}function Nl({r:e,g:t,b:n}){return`#${[ko(e),ko(t),ko(n)].map(r=>r.toString(16).padStart(2,"0")).join("")}`}function Ll(e,t,n=.5){const r=Math.min(1,Math.max(0,n));return{r:e.r*(1-r)+t.r*r,g:e.g*(1-r)+t.g*r,b:e.b*(1-r)+t.b*r}}function id(e){const t=Al(e)||Al(Tl);if(!t)return{start:Tl,end:"#1f2937"};const n=Ll(t,{r:255,g:255,b:255},Am),r=Ll(t,{r:0,g:0,b:0},Nm);return{start:Nl(n),end:Nl(r)}}function ms(e,t){if(!e)return"";try{return e.getPropertyValue(t)||""}catch{return""}}function Lm(){let e=null;if(typeof document<"u"&&document.documentElement)try{e=getComputedStyle(document.documentElement)}catch{e=null}const t={...si};return Object.keys(Ml).forEach(n=>{const r=n,o=Ml[r],i=ms(e,o).trim();t[r]=i||si[r]}),t}function mi(e={}){const{forceRefresh:t=!1}=e;return(!ri||t)&&(ri=Lm()),{...ri}}mi();function Bm(){let e=null;if(typeof document<"u"&&document.documentElement)try{e=getComputedStyle(document.documentElement)}catch{e=null}const t=ri??mi(),n={};return Object.keys(El).forEach(r=>{const o=r,i=El[o],a=ms(e,i.start).trim(),d=ms(e,i.end).trim(),l=t[o]||si[o],c=id(l);n[o]={start:a||c.start,end:d||c.end}}),n}function Rm(e={}){const{forceRefresh:t=!1}=e;(!Xi||t)&&(t&&mi({forceRefresh:!0}),Xi=Bm());const n={};return Object.entries(Xi).forEach(([r,o])=>{n[r]={...o}}),n}function Fm(e){const t=Xi??Rm(),n=typeof e=="string"&&e?e.toLowerCase():"open";return Object.prototype.hasOwnProperty.call(t,n)?{...t[n]}:{...t.open}}function $m(e){const t=ri??mi(),n=typeof e=="string"&&e?e.toLowerCase():"open";return Object.prototype.hasOwnProperty.call(si,n)?t[n]:t.open}function Bl(e,t,n){return Number.isNaN(e)?t:t>n?e:e<t?t:e>n?n:e}function Ni(e,t){return Number.isFinite(e)?e:t}function Hm(e){var H,_;const t=e.minZoom&&Number.isFinite(e.minZoom)?Math.max(.05,e.minZoom):.1,n=e.maxZoom&&Number.isFinite(e.maxZoom)?Math.max(t,e.maxZoom):Math.max(t,8);let r=Math.max(0,Math.trunc(e.viewportWidth||0)),o=Math.max(0,Math.trunc(e.viewportHeight||0)),i=Ni((H=e.centerTile)==null?void 0:H.x,0),a=Ni((_=e.centerTile)==null?void 0:_.y,0),d=Bl(Number.isFinite(e.initialZoom)?e.initialZoom:1,t,n),l=null,c=null,f=0,u=i,p=a,h=i,g=a,b=null,S=null,v=null;const k=$=>typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame($):setTimeout(()=>$(Date.now()),16),E=$=>{if($!=null){if(typeof window<"u"&&typeof window.cancelAnimationFrame=="function"&&typeof $=="number"){window.cancelAnimationFrame($);return}clearTimeout($)}};function A($=!1){l!==null&&(E(l),l=null),c=null,$&&(i=h,a=g),S=null,v=null,b=null}function L($){const R=1-($<0?0:$>1?1:$);return 1-R*R*R}function F($,s){f=$,u=i,p=a,c=null,b=s;const R=W=>{c===null&&(c=W);const K=W-c,ne=f>0?Math.min(1,K/f):1,ye=b?b(ne):ne,me=u+(h-u)*ye,Oe=p+(g-p)*ye;if(i=Number.isFinite(me)?me:h,a=Number.isFinite(Oe)?Oe:g,S&&S({x:i,y:a}),ne>=1-1e-6){i=h,a=g,l=null,c=null;const Ye=S,Ge=v;S=null,v=null,b=null,Ye&&Ye({x:i,y:a}),Ge&&Ge({x:i,y:a});return}l=k(R)};l=k(R)}const O={get centerTile(){return{x:i,y:a}},get zoom(){return d},get minZoom(){return t},get maxZoom(){return n},get viewportWidth(){return r},get viewportHeight(){return o},setViewportSize($,s){Number.isFinite($)&&(r=Math.max(0,Math.trunc($))),Number.isFinite(s)&&(o=Math.max(0,Math.trunc(s)))},setCenterTile($,s={}){l!==null&&A(!1);const R=Ni($==null?void 0:$.x,i),W=Ni($==null?void 0:$.y,a);i=Number.isFinite(R)?R:i,a=Number.isFinite(W)?W:a,s.snap&&(i=Math.round(i),a=Math.round(a))},setZoom($,s="viewport"){const R=d;return d=Bl(Number.isFinite($)?$:R,t,n),d},panBy($,s,R={}){l!==null&&A(!1),Number.isFinite($)&&(i+=$),Number.isFinite(s)&&(a+=s),R.snap&&O.commitSnap()},commitSnap($={}){const s=Math.round(i),R=Math.round(a),W=Math.abs(s-i)>1e-6||Math.abs(R-a)>1e-6,K=typeof $.onUpdate=="function"?$.onUpdate:null,ne=typeof $.onComplete=="function"?$.onComplete:null;if(A(!1),!W)return K&&K({x:i,y:a}),ne&&ne({x:i,y:a}),{targetX:s,targetY:R,changed:!1};if(!($.animate!==!1))return i=s,a=R,K&&K({x:i,y:a}),ne&&ne({x:i,y:a}),{targetX:s,targetY:R,changed:!0};const me=Math.max(Math.abs(s-i),Math.abs(R-a)),Oe=150,Ye=250,Ge=Number.isFinite($.duration)?$.duration:Oe+Math.min(Ye-Oe,me*40),Ve=Math.max(Oe,Math.min(Ye,Ge)),Se=typeof $.easing=="function"?$.easing:L;return h=s,g=R,S=K,v=ne,F(Ve,Se),{targetX:s,targetY:R,changed:!0}},worldToScreen($,s,R){const W=O.getScaledTileSize(R),K=r/2+($-i-.5)*W,ne=o/2+(s-a-.5)*W;return{x:K,y:ne}},worldToScreenCenter($,s,R){const W=O.getScaledTileSize(R),K=r/2+($-i)*W,ne=o/2+(s-a)*W;return{x:K,y:ne}},screenToTile($,s,R){const W=O.getScaledTileSize(R)||1,K=i+($-r/2)/W+.5,ne=a+(s-o/2)/W+.5;return{x:K,y:ne}},getVisibleWorldBounds($){const s=O.getScaledTileSize($)||1,R=r/(2*s),W=o/(2*s);return{minX:i-R-1,maxX:i+R+1,minY:a-W-1,maxY:a+W+1}},getScaledTileSize($){return(Number.isFinite($)&&$>0?$:1)*d}};return O}const Im=16,Rl=.24;function Li(e,t,n,r,o,i){const a=Math.max(0,Math.min(i,Math.min(r,o)/2));if(typeof e.roundRect=="function"){e.beginPath(),e.roundRect(t,n,r,o,a);return}e.beginPath(),e.moveTo(t+a,n),e.lineTo(t+r-a,n),e.quadraticCurveTo(t+r,n,t+r,n+a),e.lineTo(t+r,n+o-a),e.quadraticCurveTo(t+r,n+o,t+r-a,n+o),e.lineTo(t+a,n+o),e.quadraticCurveTo(t,n+o,t,n+o-a),e.lineTo(t,n+a),e.quadraticCurveTo(t,n,t+a,n),e.closePath()}function uo(e,t){if(typeof window>"u"||typeof document>"u")return t;try{return getComputedStyle(document.documentElement).getPropertyValue(e).trim()||t}catch{return t}}function Dm(e){const t=uo("--accent","#f7c948"),n=uo("--accent-strong","#d4a72c"),r=uo("--warn","#ff9f47"),o=uo("--accent-stronger","#f59e0b");switch((e==null?void 0:e.toLowerCase())||""){case"completed":case"complete":return n||t;case"under-construction":case"under construction":case"construction":case"in-progress":return r;case"planned":case"queued":return o||r;case"mixed":return uo("--accent",r);default:return t}}class Om{constructor(t,n){this.canvas=t;let r=null;try{r=t.getContext("2d")}catch{r=null}this.ctx=r,this.camera=n.camera;const o=Number.isFinite(n.tileBaseSize)?n.tileBaseSize:Im;this.tileBaseSize=Math.max(2,o),this.useTerrainColors=n.useTerrainColors??!1,this.getTerrainColor=n.getTerrainColor||(()=>null),this.getTerrainGradient=n.getTerrainGradient||(()=>null),this.devicePixelRatio=typeof window<"u"&&window.devicePixelRatio||1,this.viewportWidth=Math.max(1,this.camera.viewportWidth||this.canvas.clientWidth||1),this.viewportHeight=Math.max(1,this.camera.viewportHeight||this.canvas.clientHeight||1),this.map=null,this.developments=new Map,this.scale=this.camera.zoom,this.configureCanvasSize(this.viewportWidth,this.viewportHeight)}setTileBaseSize(t){!Number.isFinite(t)||t<=0||(this.tileBaseSize=Math.max(2,t))}setUseTerrainColors(t){this.useTerrainColors=!!t}setTerrainColorResolver(t){this.getTerrainColor=t}setTerrainGradientResolver(t){this.getTerrainGradient=t}setScale(t){!Number.isFinite(t)||t<=0||(this.scale=t)}setMap(t){this.map=t}setDevelopments(t){this.developments=t}resize(t,n){const r=Math.max(1,Math.round(t)),o=Math.max(1,Math.round(n));this.viewportWidth=r,this.viewportHeight=o,this.camera.setViewportSize(r,o),this.configureCanvasSize(r,o)}render(){var p,h,g,b;if(!this.ctx)return;const t=this.ctx;if(t.save(),t.setTransform(this.devicePixelRatio,0,0,this.devicePixelRatio,0,0),t.clearRect(0,0,this.viewportWidth,this.viewportHeight),!this.map||!((p=this.map.tiles)!=null&&p.length)){t.restore();return}const n=Math.max(2,this.tileBaseSize*(this.scale||1)),r=this.map.tiles.length,o=((h=this.map.tiles[0])==null?void 0:h.length)||0,i=this.map.xStart,a=this.map.yStart,l=uo("--accent","#f7c948")||"#f7c948",c=.35,f=Math.max(1,Math.round(n*.09)),u=Math.max(1.5,n*Rl);for(let S=0;S<r;S++)if(this.map.tiles[S])for(let k=0;k<o;k++){const E=i+k,A=a+S,{x:L,y:F}=this.camera.worldToScreen(E,A,this.tileBaseSize),O=Math.round(L),H=Math.round(F),_=((b=(g=this.map.types)==null?void 0:g[S])==null?void 0:b[k])??null,$=this.useTerrainColors?this.getTerrainGradient(_):null,s=this.useTerrainColors?this.getTerrainColor(_):"rgba(148, 163, 184, 0.25)",R=Math.ceil(n),W=Math.ceil(n);if(Li(t,O,H,R,W,u),$&&($.start||$.end)){const ye=$.start||s||l,me=$.end||ye,Oe=t.createLinearGradient(O,H,O,H+W);Oe.addColorStop(0,ye),Oe.addColorStop(1,me),t.fillStyle=Oe}else t.fillStyle=s||l;t.fill(),t.save(),t.lineWidth=f,t.lineJoin="round",t.lineCap="round",t.strokeStyle=l,t.globalAlpha=c,Li(t,O,H,R,W,u),t.stroke(),t.restore();const K=`${E}:${A}`,ne=this.developments.get(K)||null;ne&&this.drawDevelopmentOverlay(t,O,H,n,ne)}t.restore()}hitTest(t,n){var h,g,b;if(!this.map||!((h=this.map.tiles)!=null&&h.length))return null;const r=this.camera.screenToTile(t,n,this.tileBaseSize),o=Math.floor(r.x),i=Math.floor(r.y),a=o-this.map.xStart,d=i-this.map.yStart;if(d<0||a<0||d>=this.map.height||a>=this.map.width)return null;const l=this.map.tiles[d];if(!l)return null;const c=l[a]??"",f=((b=(g=this.map.types)==null?void 0:g[d])==null?void 0:b[a])??null,u=`${o}:${i}`,p=this.developments.get(u)||null;return{x:o,y:i,col:a,row:d,symbol:c??"",type:f??null,development:p}}configureCanvasSize(t,n){this.devicePixelRatio=typeof window<"u"&&window.devicePixelRatio||1;const r=Math.max(1,Math.round(t*this.devicePixelRatio)),o=Math.max(1,Math.round(n*this.devicePixelRatio));this.canvas.width!==r&&(this.canvas.width=r),this.canvas.height!==o&&(this.canvas.height=o),this.canvas.style.width=`${t}px`,this.canvas.style.height=`${n}px`}drawDevelopmentOverlay(t,n,r,o,i){const a=Dm(i.status),d=Math.max(1,Math.round(o*.08)),l=Math.max(2,Math.round(o*.18)),c=Math.max(1,Math.ceil(o)),f=Math.max(1,Math.ceil(o)),u=Math.max(1,o*Rl);t.save(),t.lineWidth=d,t.strokeStyle=a,t.globalAlpha=.85;const p=Math.max(1,u-l*.6);if(Li(t,n+l,r+l,Math.max(1,c-l*2),Math.max(1,f-l*2),p),t.stroke(),i.emphasis||i.highlight){t.lineWidth=Math.max(d*.6,1),t.globalAlpha=.45;const h=Math.max(1,l-d*1.2),g=Math.max(1,u-h*.5);Li(t,n+h,r+h,Math.max(1,c-h*2),Math.max(1,f-h*2),g),t.stroke()}t.restore()}}function zm(e,t){return new Om(e,t)}const Fl=(e,t,n)=>Number.isNaN(e)||e<t?t:e>n?n:e;function Pm(e,t={}){const n=typeof t.size=="number"&&Number.isFinite(t.size)?`${t.size}px`:typeof t.size=="string"?t.size:"48px",r=t.variant||"square",o=t.fontSize||(r==="chip"?"16px":"18px"),i=r==="chip"||r==="stacked";e.style.width=i?"auto":n,e.style.minWidth=n,e.style.height=r==="stacked"?"auto":n,e.style.minHeight=n,e.style.padding=i?"0 12px":"0",e.style.fontSize=o,e.style.display="inline-flex",e.style.flexDirection=r==="stacked"?"column":"row",e.style.gap=r==="stacked"?"2px":"0",e.style.alignItems="center",e.style.justifyContent="center",e.style.borderRadius="12px",e.style.border="1px solid var(--map-control-border, var(--map-border, #ccc))",e.style.background="var(--map-control-bg, var(--bg-color, #fff))",e.style.color="var(--map-control-fg, inherit)",e.style.lineHeight="1.1",e.style.whiteSpace="nowrap",e.style.cursor="pointer",e.style.transition="background 0.2s ease, transform 0.1s ease",e.style.boxShadow="var(--map-control-shadow, 0 1px 2px rgba(0, 0, 0, 0.08))",e.style.fontWeight="600"}function jm(e){const t=e.styleButton||Pm,n=document.createElement("div");n.className="map-zoom-controls",n.style.display="flex",n.style.flexDirection="row",n.style.flexWrap="wrap",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.alignSelf="center",n.style.marginTop="12px",n.style.pointerEvents="auto";const r=(l,c,f)=>{const u=document.createElement("button");return u.type="button",u.textContent=l,u.setAttribute("aria-label",c),t(u,f),u},o=r("−","Zoom out",{fontSize:"22px",variant:"chip"}),i=r("+","Zoom in",{fontSize:"22px",variant:"chip"}),a=r("100%","Reset zoom to 100%",{fontSize:"15px",variant:"chip",size:64});return a.classList.add("map-zoom-reset"),o.addEventListener("click",l=>{l.preventDefault(),e.onZoomOut()}),i.addEventListener("click",l=>{l.preventDefault(),e.onZoomIn()}),a.addEventListener("click",l=>{l.preventDefault(),e.onZoomReset()}),n.appendChild(o),n.appendChild(i),n.appendChild(a),{element:n,update(l){var k,E,A;const c=((k=l.camera)==null?void 0:k.zoom)??l.zoom,f=((E=l.camera)==null?void 0:E.minZoom)??l.minZoom,u=((A=l.camera)==null?void 0:A.maxZoom)??l.maxZoom,p=Number.isFinite(l.baselineZoom)?l.baselineZoom:1,h=Fl(c,0,Number.isFinite(u)?u:8),g=Fl(f,0,h),b=u>0?u:Math.max(h,1),S=Math.round(h*100),v=Math.round(p*100);a.textContent=`${S}%`,a.setAttribute("aria-label",`Reset zoom to ${v}% (current ${S}%)`),o.disabled=h<=g+.001,i.disabled=h>=b-.001}}}class ad{constructor(t,n){this.maxSize=Math.max(0,Math.trunc(t)),this.onEvict=typeof n=="function"?n:null,this.map=new Map}get size(){return this.map.size}get capacity(){return this.maxSize}setCapacity(t){const n=Math.max(0,Math.trunc(t));if(n!==this.maxSize){if(this.maxSize=n,this.maxSize===0){this.clear();return}this.evictIfNeeded()}}get(t){if(!this.map.has(t))return;const n=this.map.get(t);return this.map.delete(t),this.map.set(t,n),n}peek(t){return this.map.get(t)}set(t,n){if(this.maxSize<=0){this.handleEviction(t,n);return}if(this.map.has(t)){const r=this.map.get(t);this.map.delete(t),r!==void 0&&this.handleEviction(t,r)}this.map.set(t,n),this.evictIfNeeded()}has(t){return this.map.has(t)}delete(t){if(!this.map.has(t))return!1;const n=this.map.get(t);return this.map.delete(t),n!==void 0&&this.handleEviction(t,n),!0}clear(){if(this.map.size===0)return;const t=this.map.entries();for(const[n,r]of t)this.handleEviction(n,r);this.map.clear()}keys(){return this.map.keys()}values(){return this.map.values()}entries(){return this.map.entries()}evictIfNeeded(){if(this.maxSize<=0){this.clear();return}for(;this.map.size>this.maxSize;){const t=this.map.keys().next();if(t.done)break;const n=t.value,r=this.map.get(n);this.map.delete(n),r!==void 0&&this.handleEviction(n,r)}}handleEviction(t,n){if(this.onEvict)try{this.onEvict(t,n)}catch{}}}function _m(e){if(typeof OffscreenCanvas<"u")return new OffscreenCanvas(e,e);if(typeof document<"u"&&typeof document.createElement=="function"){const t=document.createElement("canvas");return t.width=e,t.height=e,t}return{width:e,height:e,getContext:()=>null}}function qm(e,t){Number.isFinite(e.width)&&(e.width=t),Number.isFinite(e.height)&&(e.height=t)}function Za(e){if(Number.isFinite(e.width)&&(e.width=0),Number.isFinite(e.height)&&(e.height=0),typeof e.transferToImageBitmap=="function")try{e.transferToImageBitmap()}catch{}}class Wm{constructor(t={}){this.maxPoolSize=Math.max(0,Math.trunc(t.maxPoolSize??48)),this.createCanvas=typeof t.createCanvas=="function"?t.createCanvas:_m,this.pool=[]}get size(){return this.pool.length}acquire(t){const n=Math.max(1,Math.trunc(t)),r=this.pool.pop()??this.createCanvas(n);return qm(r,n),r}release(t){if(t){if(this.pool.length>=this.maxPoolSize){Za(t);return}Za(t),this.pool.push(t)}}clear(){if(this.pool.length)for(;this.pool.length;){const t=this.pool.pop();t&&Za(t)}}}const Vi=new Wm,Um=256,Ym=96,oo=new ad(Um),io=new ad(Ym,(e,t)=>{t&&Vi.release(t)}),Gm=new Map([["complete","completed"],["completed","completed"],["built","completed"],["finished","completed"],["constructed","completed"],["constructing","under-construction"],["building","under-construction"],["under construction","under-construction"],["under-construction","under-construction"],["in-progress","under-construction"],["progress","under-construction"],["queued","planned"],["pending","planned"],["planned","planned"],["noted","noted"],["mixed","mixed"]].map(([e,t])=>[e,t])),Xm=Object.freeze({ArrowUp:{dx:0,dy:-1},ArrowDown:{dx:0,dy:1},ArrowLeft:{dx:-1,dy:0},ArrowRight:{dx:1,dy:0}}),Vm=220,Km="debug",Zm="1";function Jm(){if(typeof window>"u"||typeof URLSearchParams>"u")return!1;try{return new URLSearchParams(window.location.search).get(Km)===Zm}catch{return!1}}function pa(e){return Number.isFinite(e)?Math.trunc(e):null}function ao(e,t,n){return!Number.isFinite(e)||t>n?e:Math.min(n,Math.max(t,e))}function sd(e,t="noted"){if(!e)return t;const n=String(e).trim().toLowerCase();return Gm.get(n)||t}function ld(e){return e?typeof e=="string"?e:e.name||e.label||e.title||e.typeName||e.typeId||(typeof e.toString=="function"?e.toString():"")||"":""}function $l(e,t=0){var u,p;if(!e)return null;const n=typeof e=="object"?e:{structures:[e]},r=pa(n.x??n.col??n.column??n.tileX??((u=n.tile)==null?void 0:u.x)),o=pa(n.y??n.row??n.tileY??((p=n.tile)==null?void 0:p.y));if(r===null||o===null)return null;const a=(Array.isArray(n.structures)?n.structures:Array.isArray(n.projects)?n.projects:n.structure?[n.structure]:n.name?[n.name]:[]).map(h=>ld(h)).map(h=>String(h||"").trim()).filter(Boolean),d=sd(n.status||n.state||n.progress||null),l=[];n.tooltip&&l.push(String(n.tooltip)),n.details&&l.push(String(n.details)),n.description&&l.push(String(n.description)),l.length===0&&a.length&&l.push(a.join(", "));const c=n.label||(a.length?a[0]:"")||n.name||n.title||`Development ${t+1}`,f=Number.isFinite(n.count)?Math.max(0,Math.trunc(n.count)):a.length;return{x:r,y:o,status:d,structures:a,label:c,tooltip:l.join(" • "),count:f,emphasis:n.emphasis===!0,highlight:n.highlight===!0}}function Hl(e){if(!e||typeof e!="object")return null;const t={};for(const[n,r]of Object.entries(e)){if(!n&&n!==0)continue;const o=String(n).trim().toLowerCase();if(!o||r==null)continue;const i=String(r).trim();i&&(t[o]=i)}return Object.keys(t).length?t:null}function Qm(e){const t=[],n=[],r=[],o=[];e.items.forEach(c=>{const f=ld(c),u=String(f||"").trim()||"Structure",p=sd(c.status||c.state||c.progress||null,"planned");p==="completed"?t.push(u):p==="under-construction"?n.push(u):r.push(u),c.details?o.push(String(c.details)):c.description&&o.push(String(c.description))});const i=[];t.length&&i.push(`${t.length>1?"Completed structures":"Completed structure"}: ${t.join(", ")}`),n.length&&i.push(`${n.length>1,"Under construction"}: ${n.join(", ")}`),r.length&&i.push(`Planned: ${r.join(", ")}`),o.length&&i.push(o.join(" • "));let a="noted";n.length?a=t.length?"mixed":"under-construction":t.length?a="completed":r.length&&(a="planned");const d=[...t,...n,...r],l=e.label||d[0]||"Development";return{x:e.x,y:e.y,status:a,structures:d,label:l,tooltip:i.join(" • "),count:d.length,emphasis:!!e.emphasis,highlight:!!e.highlight}}function eh(e={},t={}){const n=[],r=new Set,o=t.developments??e.developments??e.development??e.developmentTiles??null;Array.isArray(o)?o.forEach((a,d)=>{const l=$l(a,d);if(!l)return;const c=`${l.x}:${l.y}`;r.add(c),n.push(l)}):o&&typeof o=="object"&&Object.values(o).forEach((a,d)=>{const l=$l(a,d);if(!l)return;const c=`${l.x}:${l.y}`;r.add(c),n.push(l)});const i=Array.isArray(t.structures)?t.structures:Array.isArray(e.structures)?e.structures:[];if(i.length){const a=new Map;i.forEach(d=>{if(!d)return;const l=d.tile||d.location||d.coords||{},c=pa(d.x??l.x??d.col),f=pa(d.y??l.y??d.row);if(c===null||f===null)return;const u=`${c}:${f}`;a.has(u)||a.set(u,{x:c,y:f,items:[],label:d.label||d.name||null,emphasis:d.emphasis,highlight:d.highlight}),a.get(u).items.push(d)}),a.forEach((d,l)=>{if(r.has(l))return;const c=Qm(d);c&&(r.add(l),n.push(c))})}return n}const th={water:"Water",ocean:"Ocean",lake:"Lake",river:"River",marsh:"Marsh",mangrove:"Mangrove Forest",open:"Open Land",forest:"Forest",ore:"Ore Deposits",stone:"Stone Outcrop"},Il=12,Dl=16;function nh(e,t,n){const r=Math.max(0,(e==null?void 0:e.cols)??0),o=Math.max(0,(e==null?void 0:e.rows)??0),i=Math.max(0,t||0),a=Math.max(0,n||0);return{x:Math.max(0,Math.floor((r-i)/2)),y:Math.max(0,Math.floor((o-a)/2))}}const Vt=Zr;function rh(e=0,t=0,n=null){if(typeof window>"u"){const c=Math.max(220,320);return{width:c,height:c}}const o=Math.max(220,Number.isFinite(n)&&n>0?n:window.innerWidth-80),i=Math.max(220,window.innerHeight-260),a=Math.max(220,Math.round(o)),d=Math.max(220,Math.min(a,Math.round(i))),l=Math.max(220,d);return{width:l,height:l}}function ur(e){typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(e):setTimeout(e,0)}function Mt(e,t=0){return Number.isFinite(e)?Math.trunc(e):t}function ho(e=[]){var r;const t=Array.isArray(e)?e.length:0;return{cols:t&&((r=e[0])==null?void 0:r.length)||0,rows:t}}function Ja(e=[],t=0,n=0,r=0,o=0){if(!Array.isArray(e)||!e.length||r<=0||o<=0)return[];const i=[];for(let a=0;a<o;a++){const d=e[n+a];if(!Array.isArray(d))break;i.push(d.slice(t,t+r))}return i}function Ol(e){var a,d,l,c,f;if(!e)return null;const t=(d=(a=e.buffer)==null?void 0:a.tiles)!=null&&d.length?e.buffer:e;if(!((l=t==null?void 0:t.tiles)!=null&&l.length))return null;const{cols:n,rows:r}=ho(t.tiles),o=(c=t.types)!=null&&c.length?t.types:null,i=(f=t.elevations)!=null&&f.length?t.elevations:null;return{...t,tiles:t.tiles,types:o,elevations:i,width:t.width??n,height:t.height??r,xStart:Mt(t.xStart,0),yStart:Mt(t.yStart,0)}}function oh(e,t=0,n=0){if(t&&n)return{width:t,height:n};const{cols:r,rows:o}=ho(e==null?void 0:e.tiles);if(r||o){const i=Math.max(r,o);return{width:i,height:i}}return{width:Vt,height:Vt}}function cd(e,{legendLabels:t=th,showControls:n=!0,showLegend:r=!0,allowDrag:o=!0,idPrefix:i="map",fetchMap:a=null,onMapUpdate:d=null,onTileClick:l=null,navMode:c="viewport",onNavigate:f=null,actions:u={},jobSelector:p=null,useTerrainColors:h=!1,terrainColors:g=null,bufferMargin:b=Il,minZoom:S=.5,maxZoom:v=3,initialZoom:k=1}={}){if(!e)throw new Error("Container is required for map view");const E=Hl(g),A=Number.isFinite(b)?Math.max(0,Math.trunc(b)):Il,L=Number.isFinite(S)?Math.max(.1,S):.5,F=Number.isFinite(v)?Math.max(L,v):3,O=Number.isFinite(k)?k:1,H=Math.min(F,Math.max(L,O)),_=(m,{size:y=48,fontSize:M="18px",variant:x="square"}={})=>{const N=typeof y=="number"&&Number.isFinite(y)?`${y}px`:`${y}`,P=x==="chip"||x==="stacked";m.style.width=P?"auto":N,m.style.minWidth=N,m.style.height=x==="stacked"?"auto":N,m.style.minHeight=N,m.style.padding=P?"0 12px":"0",m.style.fontSize=M,m.style.display="inline-flex",m.style.flexDirection=x==="stacked"?"column":"row",m.style.gap=x==="stacked"?"2px":"0",m.style.alignItems="center",m.style.justifyContent="center",m.style.borderRadius="12px",m.style.border="1px solid var(--map-control-border, var(--map-border, #ccc))",m.style.background="var(--map-control-bg, var(--bg-color, #fff))",m.style.color="var(--map-control-fg, inherit)",m.style.lineHeight="1.1",m.style.whiteSpace="nowrap",m.style.cursor="pointer",m.style.transition="background 0.2s ease, transform 0.1s ease",m.style.boxShadow="var(--map-control-shadow, 0 1px 2px rgba(0, 0, 0, 0.08))",m.style.fontWeight="600"},$=Jm(),s={map:null,buffer:null,context:{},home:{xStart:0,yStart:0},focus:{x:0,y:0},viewport:{width:0,height:0,xStart:0,yStart:0},drag:{active:!1,lastX:0,lastY:0,pendingX:0,pendingY:0,fractionalX:0,fractionalY:0},keyboardPan:{timer:null},resizeHandler:null,fetchMap:a,onMapUpdate:d,onTileClick:typeof l=="function"?l:null,navMode:c==="player"?"player":"viewport",onNavigate:typeof f=="function"?f:null,bufferMargin:A,bufferPadding:{x:A,y:A},expectedBufferPadding:{x:A,y:A},zoom:H,minZoom:L,maxZoom:F,initialZoom:H,zoomBase:{width:0,height:0},zoomDisplayFactor:1,tileBaseSize:Dl,camera:null,renderer:null,renderScheduled:!1,markerLayer:null,dataLayer:null,markerElements:new Map,markerDefs:[],useTerrainColors:!!h,terrainColorOverrides:E,pendingZoomSync:!1,developmentTiles:new Map,hasInitializedBaseChunk:!1,debug:{enabled:$,overlay:null,fps:0,lastRenderTimestamp:0,pointerTile:null}},R=()=>s.camera?s.camera.zoom:s.zoom,W=()=>{var M,x,N;const m=((x=(M=s.map)==null?void 0:M.tiles)==null?void 0:x.length)||0;return{cols:m&&((N=s.map.tiles[0])==null?void 0:N.length)||0,rows:m}};function K(m){const y=oh(m,s.viewport.width,s.viewport.height);s.viewport.width=Math.max(1,Mt(y.width,Vt)),s.viewport.height=Math.max(1,Mt(y.height,Vt))}function ne(m){var Ee;if(!((Ee=m==null?void 0:m.tiles)!=null&&Ee.length))return null;const y=ho(m.tiles);if(!y.cols||!y.rows)return null;const M=Math.min(Math.max(1,s.viewport.width||Vt),y.cols),x=Math.min(Math.max(1,s.viewport.height||Vt),y.rows);s.viewport.width=M,s.viewport.height=x;const N=m.xStart??0,P=m.yStart??0,Y=Math.max(0,y.cols-M),q=Math.max(0,y.rows-x);let j=Mt(s.viewport.xStart,N)-N,ce=Mt(s.viewport.yStart,P)-P;return j=Math.max(0,Math.min(Y,j)),ce=Math.max(0,Math.min(q,ce)),s.viewport.xStart=N+j,s.viewport.yStart=P+ce,{offsetX:j,offsetY:ce,originX:N,originY:P,width:M,height:x}}function ye(){var j,ce,Ee,ie,Me,Be,je;if(!((ce=(j=s.buffer)==null?void 0:j.tiles)!=null&&ce.length))return!1;const m=ne(s.buffer);if(!m)return!1;const{offsetX:y,offsetY:M,width:x,height:N}=m,P=Ja(s.buffer.tiles,y,M,x,N);if(!P.length)return!1;const Y=(Ee=s.buffer.types)!=null&&Ee.length?Ja(s.buffer.types,y,M,x,N):null,q=(ie=s.buffer.elevations)!=null&&ie.length?Ja(s.buffer.elevations,y,M,x,N):null;return s.map={...s.map,seed:s.buffer.seed??((Me=s.map)==null?void 0:Me.seed),season:s.buffer.season??((Be=s.map)==null?void 0:Be.season),waterLevel:s.buffer.waterLevel??((je=s.map)==null?void 0:je.waterLevel),tiles:P,types:Y,elevations:q,xStart:s.viewport.xStart,yStart:s.viewport.yStart,width:x,height:N,viewport:{...s.viewport}},!0}function me(){var y,M;if(!s.map)return null;const m={seed:s.map.seed,season:s.map.season,waterLevel:s.map.waterLevel,tiles:s.map.tiles,types:s.map.types,elevations:s.map.elevations,xStart:s.map.xStart,yStart:s.map.yStart,width:s.map.width,height:s.map.height,viewport:{...s.viewport}};if((M=(y=s.buffer)==null?void 0:y.tiles)!=null&&M.length){const x=ho(s.buffer.tiles);m.buffer={seed:s.buffer.seed,season:s.buffer.season,waterLevel:s.buffer.waterLevel,tiles:s.buffer.tiles,types:s.buffer.types,elevations:s.buffer.elevations,xStart:s.buffer.xStart,yStart:s.buffer.yStart,width:s.buffer.width??x.cols,height:s.buffer.height??x.rows}}return m}function Oe(){var P,Y;const m=Math.max(.001,R()),y=Math.max(1,Math.trunc(s.zoomBase.width||s.viewport.width||((P=s.map)==null?void 0:P.width)||Vt)),M=Math.max(1,Math.trunc(s.zoomBase.height||s.viewport.height||((Y=s.map)==null?void 0:Y.height)||Vt)),x=Math.max(1,Math.round(y/m)),N=Math.max(1,Math.round(M/m));return{width:x,height:N}}function Ye(){var Y,q,j;if(!s.map){s.zoomDisplayFactor=1;return}const m=R();if(Math.abs(m-1)<.001){s.zoomDisplayFactor=1;return}const y=Oe(),M=((q=(Y=s.map.tiles)==null?void 0:Y[0])==null?void 0:q.length)||s.map.width||y.width,x=((j=s.map.tiles)==null?void 0:j.length)||s.map.height||y.height,N=Math.abs(M-y.width)<=1,P=Math.abs(x-y.height)<=1;s.zoomDisplayFactor=N&&P?1:m}function Ge({forceFetch:m=!1}={}){const y=R();if(!s.map){s.zoomDisplayFactor=Math.abs(y-1)<.001?1:y;return}const M=Oe(),x=Math.max(1,s.viewport.width||s.map.width||M.width),N=Math.max(1,s.viewport.height||s.map.height||M.height),P=Math.max(1,M.width),Y=Math.max(1,M.height),q=P!==x,j=Y!==N,ce=s.viewport.xStart+Math.floor(x/2),Ee=s.viewport.yStart+Math.floor(N/2);if(s.viewport.width=P,s.viewport.height=Y,s.home=se(s.focus),!q&&!j){m?gt(s.viewport.xStart,s.viewport.yStart,{forceFetch:!0}):(Ye(),ur(Fn),ur(Ue));return}const ie=ce-Math.floor(P/2),Me=Ee-Math.floor(Y/2);gt(ie,Me)}function Ve(m){if(!s.useTerrainColors)return null;const y=typeof m=="string"&&m?m.trim().toLowerCase():"open",M=s.terrainColorOverrides||null;return M&&M[y]?M[y]:$m(y)}function Se(m){if(!s.useTerrainColors)return null;const y=typeof m=="string"&&m?m.trim().toLowerCase():"open",M=s.terrainColorOverrides||null;return M&&M[y]?id(M[y]):Fm(y)}const at=["map-tile--developed","map-tile--developed-pending","map-tile--developed-complete","map-tile--developed-mixed","map-tile--developed-planned","map-tile--developed-emphasis"];function Xe(m,y){return`${Math.trunc(m??0)}:${Math.trunc(y??0)}`}function ht(m,y){return!Number.isFinite(m)||!Number.isFinite(y)?null:s.developmentTiles.get(Xe(m,y))||null}function _t(m,y=0){if(!m&&m!==0)return null;const M=Number(m.x),x=Number(m.y);if(!Number.isFinite(M)||!Number.isFinite(x))return null;const N=Math.trunc(M),P=Math.trunc(x),Y=typeof m.status=="string"?m.status.trim().toLowerCase():"";let q="";switch(Y){case"completed":case"complete":case"built":q="completed";break;case"under-construction":case"construction":case"in-progress":case"building":q="under-construction";break;case"mixed":q="mixed";break;case"planned":case"planning":case"queued":q="planned";break;default:q=Y||""}const j=Array.isArray(m.structures)?m.structures.map(Te=>String(Te||"").trim()).filter(Boolean):[],ce=Number.isFinite(m.count)?Math.max(0,Math.trunc(m.count)):j.length,Ee=typeof m.label=="string"&&m.label.trim()?m.label.trim():j[0]||"Development",ie=[],Me=Te=>{typeof Te=="string"&&Te.trim()&&ie.push(Te.trim())};Me(m.tooltip),Me(m.details),Me(m.description),Me(m.summary),Me(m.note),!ie.length&&j.length>1&&ie.push(`Structures: ${j.join(", ")}`);const Be=ie.join(" • "),je=q||(j.length?"completed":ce>0?"planned":"noted");return{key:Xe(N,P),x:N,y:P,status:je,label:Ee,tooltip:Be,structures:j,count:ce,emphasis:m.emphasis===!0,highlight:m.highlight===!0}}function Je(m=[]){const y=Array.isArray(m)?m.map((x,N)=>_t(x,N)).filter(Boolean):[],M=new Map;y.forEach(x=>{M.set(x.key,x)}),s.developmentTiles=M,s.renderer&&s.renderer.setDevelopments(s.developmentTiles),Wn(),rn()}function Tt(){var M,x,N,P;if(!s.map)return;if(!s.hasInitializedBaseChunk&&((M=s.map.tiles)!=null&&M.length)&&(s.hasInitializedBaseChunk=!0),s.context={...s.context,focus:{...s.focus},viewport:{...s.viewport}},typeof s.onMapUpdate=="function"){const Y=me();Y&&s.onMapUpdate(Y,s.context)}const m=((N=(x=s.map.tiles)==null?void 0:x[0])==null?void 0:N.length)||s.viewport.width||s.map.width||0,y=((P=s.map.tiles)==null?void 0:P.length)||s.viewport.height||s.map.height||0;if((!s.zoomBase.width||!s.zoomBase.height||Math.abs(s.zoom-1)<.001)&&(s.zoomBase.width=Math.max(1,m),s.zoomBase.height=Math.max(1,y)),Ye(),qn(),un({snap:!0}),He(),Wn(),s.pendingZoomSync){const Y=Math.abs(s.zoomDisplayFactor-1)>=.001;s.pendingZoomSync=!1,Y&&ur(()=>ut(s.zoom,{force:!0}))}}function rt(){var Te,et;if(!((et=(Te=s.buffer)==null?void 0:Te.tiles)!=null&&et.length))return!0;const m=ho(s.buffer.tiles),y=s.viewport.width||m.cols,M=s.viewport.height||m.rows;if(m.cols<y||m.rows<M)return!0;const x=s.buffer.xStart??0,N=s.buffer.yStart??0,P=s.viewport.xStart-x,Y=s.viewport.yStart-N;if(P<0||Y<0)return!0;const q=s.bufferPadding||s.expectedBufferPadding||{x:0,y:0},j=Math.max(0,s.bufferMargin??0),ce=Math.max(q.x||0,j),Ee=Math.max(q.y||0,j),ie=ce>0?Math.max(1,Math.floor(ce/2)):0,Me=Ee>0?Math.max(1,Math.floor(Ee/2)):0,Be=m.cols-(P+y),je=m.rows-(Y+M);return P<ie||Y<Me||Be<ie||je<Me}function pt(m,y,M={}){var Ft,Un,on,Mn,Uo,Yo;if(typeof s.fetchMap!="function")return;const x=Math.max(1,s.viewport.width||Vt),N=Math.max(1,s.viewport.height||Vt),P=Math.max(0,s.bufferMargin??0),Y=Math.max(P,x),q=Math.max(P,N),j=x+Y*2,ce=N+q*2,Ee=Mt(m,0),ie=Mt(y,0),Me=Ee-Y,Be=ie-q,je=M.overrideSeed??((Ft=s.map)==null?void 0:Ft.seed)??((Un=s.buffer)==null?void 0:Un.seed)??((on=s.context)==null?void 0:on.seed),Te=M.overrideSeason??((Mn=s.map)==null?void 0:Mn.season)??((Uo=s.buffer)==null?void 0:Uo.season)??((Yo=s.context)==null?void 0:Yo.season),et=M.skipSanityChecks??s.hasInitializedBaseChunk===!0;s.expectedBufferPadding={x:Y,y:q};const zt={map:s.map,context:s.context,seed:je,season:Te,xStart:Me,yStart:Be,width:j,height:ce,skipSanityChecks:et,viewport:{xStart:Ee,yStart:ie,width:x,height:N}},At=s.fetchMap(zt);At&&typeof At.then=="function"?At.then(ki=>qt(ki,{targetX:Ee,targetY:ie})):qt(At,{targetX:Ee,targetY:ie})}function qt(m,{targetX:y,targetY:M}={}){const x=Ol(m);if(!x)return;const N=ho(x.tiles);if(x.width=x.width??N.cols,x.height=x.height??N.rows,s.buffer=x,Number.isFinite(y)&&(s.viewport.xStart=Mt(y,x.xStart)),Number.isFinite(M)&&(s.viewport.yStart=Mt(M,x.yStart)),K(x),!ye()){const q=Math.min(s.viewport.width,x.width),j=Math.min(s.viewport.height,x.height);if(s.viewport.width=Math.max(1,q),s.viewport.height=Math.max(1,j),!ye())return}const P=Math.max(1,Math.min(s.viewport.width,x.width||N.cols)),Y=Math.max(1,Math.min(s.viewport.height,x.height||N.rows));s.bufferPadding=nh(N,P,Y),s.expectedBufferPadding={...s.bufferPadding},Tt()}function gt(m,y,M={}){if(s.viewport.xStart=Mt(m,s.viewport.xStart),s.viewport.yStart=Mt(y,s.viewport.yStart),M.forceFetch||rt()){pt(s.viewport.xStart,s.viewport.yStart,M);return}ye()?Tt():pt(s.viewport.xStart,s.viewport.yStart,M)}const Le=document.createElement("div");Le.className=`${i}-wrapper map-wrapper`,Le.style.position="relative",Le.style.border="1px solid var(--map-border, #ccc)",Le.style.background="var(--map-bg, #f4f4f4)",Le.style.overflow="hidden",Le.style.cursor=o?"grab":"default",Le.style.userSelect="none",Le.style.touchAction=o?"none":"auto",Le.style.boxSizing="border-box",Le.style.aspectRatio="auto",Le.style.flexShrink="0",Le.style.margin="0 auto",Le.hasAttribute("tabindex")||Le.setAttribute("tabindex","0");const bt=document.createElement("div");bt.className=`${i}-canvas map-canvas`,bt.style.position="absolute",bt.style.inset="0",bt.style.display="block",bt.style.overflow="hidden",bt.style.boxSizing="border-box",Le.appendChild(bt);const G=document.createElement("canvas");if(G.className=`${i}-display map-display`,G.style.position="absolute",G.style.inset="0",G.style.width="100%",G.style.height="100%",G.style.display="block",G.style.boxSizing="border-box",G.style.touchAction="none",bt.appendChild(G),s.debug.enabled){const m=document.createElement("pre");m.className=`${i}-debug-overlay map-debug-overlay`,Object.assign(m.style,{position:"absolute",top:"8px",left:"8px",margin:"0",padding:"8px 10px",borderRadius:"10px",background:"rgba(15, 23, 42, 0.78)",color:"#f8fafc",fontFamily:'SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',fontSize:"12px",lineHeight:"1.4",pointerEvents:"none",whiteSpace:"pre",minWidth:"180px",zIndex:"20",boxShadow:"0 8px 24px rgba(15, 23, 42, 0.45)",border:"1px solid rgba(148, 163, 184, 0.35)"}),Le.appendChild(m),s.debug.overlay=m,Ut()}const Qe=document.createElement("div");Qe.className=`${i}-data map-display-data`,Qe.style.display="none",Qe.style.visibility="hidden",Qe.style.pointerEvents="none",Qe.setAttribute("aria-hidden","true"),bt.appendChild(Qe),s.camera=Hm({viewportWidth:Le.clientWidth||0,viewportHeight:Le.clientHeight||0,minZoom:s.minZoom,maxZoom:s.maxZoom,initialZoom:s.zoom,centerTile:{x:s.focus.x,y:s.focus.y}}),s.renderer=zm(G,{camera:s.camera,tileBaseSize:s.tileBaseSize,useTerrainColors:s.useTerrainColors,getTerrainColor:m=>Ve(m),getTerrainGradient:m=>Se(m)}),s.renderer.setDevelopments(s.developmentTiles),s.dataLayer=Qe;const St=document.createElement("div");St.className=`${i}-marker-layer map-marker-layer`,St.style.position="absolute",St.style.left="0",St.style.top="0",St.style.pointerEvents="none",St.style.zIndex="3",St.style.display="block",St.style.transformOrigin="top left",St.style.width="100%",St.style.height="100%",St.style.transform="none",bt.appendChild(St),s.markerLayer=St,Ue();const xn=m=>{if(!s.renderer||!s.map)return null;const y=G.getBoundingClientRect(),M=m.clientX-y.left,x=m.clientY-y.top;return M<0||x<0||M>y.width||x>y.height?null:s.renderer.hitTest(M,x)};function Ut(m={}){var je,Te;if(!((je=s.debug)!=null&&je.enabled)||!s.debug.overlay)return;const y=typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now();if(m.fromRender){const et=s.debug.lastRenderTimestamp;if(Number.isFinite(et)&&et>0){const zt=y-et;if(zt>0){const At=1e3/zt,Ft=.85;s.debug.fps=s.debug.fps?s.debug.fps*Ft+At*(1-Ft):At}}s.debug.lastRenderTimestamp=y}const M=((Te=s.camera)==null?void 0:Te.centerTile)||s.focus||{x:0,y:0},x=s.debug.pointerTile,N=R(),P=et=>Number.isFinite(et)?`${Math.round(et*100)/100}`:"—",Y=Number.isFinite(N)?`${Math.round(N*100)/100}×`:"—",q=s.debug.fps?`${s.debug.fps.toFixed(1)} fps`:"n/a",j=(oo==null?void 0:oo.capacity)??null,ce=(oo==null?void 0:oo.size)??null,Ee=(io==null?void 0:io.capacity)??null,ie=(io==null?void 0:io.size)??null,Me=Vi&&typeof Vi.size=="number"?Vi.size:null,Be=[x?`Current tile: (${P(x.x)}, ${P(x.y)})`:"Current tile: —",`Center tile: (${P(M.x)}, ${P(M.y)})`,`Zoom: ${Y}`,`Frame rate: ${q}`,`Chunk cache: ${ce!==null&&j!==null?`${ce}/${j}`:"n/a"}`,`Tile canvases: ${ie!==null&&Ee!==null?`${ie}/${Ee}`:"n/a"}${Me!==null?` (pool ${Me})`:""}`];s.debug.overlay.textContent=Be.join(`
`)}G.addEventListener("click",m=>{if(typeof s.onTileClick!="function")return;const y=xn(m);if(!y)return;const M={x:y.x,y:y.y,col:y.col,row:y.row,terrain:y.type||null,event:m,map:s.map,context:{...s.context}};s.onTileClick(M)}),s.debug.enabled&&(G.addEventListener("pointermove",m=>{const y=xn(m);s.debug.pointerTile=y?{x:y.x,y:y.y}:null,Ut()}),G.addEventListener("pointerleave",()=>{s.debug.pointerTile=null,Ut()}));const Yt=document.createElement("div");Yt.className="map-tile-tooltip",Object.assign(Yt.style,{position:"absolute",display:"none",pointerEvents:"none",padding:"6px 10px",borderRadius:"10px",background:"rgba(26, 32, 44, 0.85)",color:"#fff",fontSize:"13px",lineHeight:"1.2",boxShadow:"0 8px 18px rgba(0, 0, 0, 0.35)",transform:"translate(-50%, calc(-100% - 12px))",zIndex:"12",whiteSpace:"nowrap",letterSpacing:"0.02em"}),Le.appendChild(Yt);const be={visible:!1,tile:null,pointerId:null,pointerType:null,holdTimer:null,holdTarget:null,holdOriginX:0,holdOriginY:0},kt=()=>{be.visible=!1,be.tile=null,be.pointerId=null,be.pointerType=null,Yt.style.display="none"},Ke=(m,y,M)=>{if(!be.visible)return;const x=Le.getBoundingClientRect();let N,P;if(Number.isFinite(m)&&Number.isFinite(y))N=m-x.left,P=y-x.top;else if(M&&s.camera){const j=s.camera.worldToScreenCenter(M.x,M.y,s.tileBaseSize);N=j.x,P=j.y}else N=x.width/2,P=x.height/2;const Y=Math.min(x.width-12,Math.max(12,N)),q=Math.min(x.height-12,Math.max(12,P));Yt.style.left=`${Y}px`,Yt.style.top=`${q}px`},ct=m=>{var j,ce,Ee,ie,Me,Be;if(!m)return"Unknown terrain";const y=m.type||"",M=t[y]||y||"Unknown terrain",x=((j=m.symbol)==null?void 0:j.trim())||"",N=x&&x.toLowerCase()!==y.toLowerCase()&&x.toLowerCase()!==String(M).toLowerCase(),P=` (${m.x}, ${m.y})`,Y=((ce=m.development)==null?void 0:ce.tooltip)||((ie=(Ee=m.development)==null?void 0:Ee.structures)==null?void 0:ie.join(", "));let q="";if((Me=m.development)!=null&&Me.tooltip)q=` — ${m.development.tooltip}`;else if(Y)q=` — ${Y}`;else{const je=ht(m.x,m.y),Te=(je==null?void 0:je.tooltip)||((Be=je==null?void 0:je.structures)!=null&&Be.length?je.structures.join(", "):"");Te&&(q=` — ${Te}`)}return`${N?`${x} `:""}${M}${P}${q}`},mt=(m,y=null)=>{m&&(Yt.textContent=ct(m),Yt.style.display="block",be.visible=!0,be.tile=m,be.pointerId=(y==null?void 0:y.pointerId)??null,be.pointerType=(y==null?void 0:y.pointerType)??null,Ke(y==null?void 0:y.clientX,y==null?void 0:y.clientY,m))},ot=()=>{be.holdTimer&&(clearTimeout(be.holdTimer),be.holdTimer=null),be.holdTarget=null,be.pointerId=null,be.pointerType=null},dn=(m,y)=>{ot(),be.holdTarget=y,be.pointerId=m.pointerId,be.pointerType=m.pointerType,be.holdOriginX=m.clientX,be.holdOriginY=m.clientY,be.holdTimer=setTimeout(()=>{be.holdTimer=null,mt(y,m)},450)},ue=m=>{const y=xn(m);y&&m.pointerType==="mouse"&&mt(y,m)},Qt=m=>{const y=xn(m);if(be.holdTimer&&be.pointerId===m.pointerId){const M=m.clientX-be.holdOriginX,x=m.clientY-be.holdOriginY;Math.hypot(M,x)>12&&ot()}be.visible&&be.pointerId===m.pointerId?Ke(m.clientX,m.clientY,be.tile):m.pointerType==="mouse"&&y&&mt(y,m)},vn=m=>{m.pointerType==="mouse"&&kt()},Sn=m=>{const y=xn(m);if(y){if(m.pointerType==="mouse"){kt();return}dn(m,y)}},ir=m=>{be.holdTimer&&be.pointerId===m.pointerId&&ot(),be.visible&&be.pointerId===m.pointerId&&m.pointerType!=="mouse"&&kt()},ar=m=>{be.holdTimer&&be.pointerId===m.pointerId&&ot(),be.pointerId===m.pointerId&&kt()};G.addEventListener("pointerover",ue),G.addEventListener("pointermove",Qt),G.addEventListener("pointerout",vn),G.addEventListener("pointerdown",Sn),G.addEventListener("pointerup",ir),G.addEventListener("pointercancel",ar),Le.addEventListener("mouseleave",kt);const Dt=document.createElement("div");Dt.setAttribute("aria-hidden","true"),Dt.style.position="absolute",Dt.style.opacity="0",Dt.style.pointerEvents="none",Dt.style.fontSize="1px",Dt.style.lineHeight="1",Dt.style.whiteSpace="nowrap",Dt.style.height="0",Dt.style.overflow="hidden",Dt.textContent=Object.values(Ui).join(""),Le.appendChild(Dt);const pe=document.createElement("div");pe.className=`${i}-layout map-layout`,pe.style.display="flex",pe.style.flexDirection="column",pe.style.alignItems="stretch",pe.style.flexWrap="nowrap",pe.style.gap="16px",pe.style.width="100%",pe.style.maxWidth="100%";const qe=document.createElement("div");qe.className=`${i}-map-container map-container`,qe.style.display="flex",qe.style.flexDirection="column",qe.style.alignItems="flex-start",qe.style.gap="12px",qe.style.width="100%",qe.style.maxWidth="100%";const yt=document.createElement("div");yt.className=`${i}-primary map-primary-stack`,yt.style.display="flex",yt.style.flexDirection="column",yt.style.alignItems="center",yt.style.gap="8px",yt.style.width="100%",yt.style.maxWidth="100%",yt.style.flex="1 1 auto",yt.style.minWidth="0";const lt=document.createElement("div");lt.className=`${i}-stage map-stage`,lt.style.position="relative",lt.style.display="flex",lt.style.flexDirection="column",lt.style.alignItems="center",lt.style.width="100%",lt.style.maxWidth="100%",lt.appendChild(Le),yt.appendChild(lt),qe.appendChild(yt);const tt=document.createElement("div");tt.className=`${i}-control-stack map-control-stack`,tt.style.display="flex",tt.style.flexDirection="column",tt.style.alignItems="stretch",tt.style.gap="12px",pe.appendChild(qe),e.appendChild(pe);const Ie=document.createElement("div");let Ct=null,Ae=null,fe=null,Z=null,Pe=!1,$e=null,Re=null,Ze=null;if(n){Ie.className=`${i}-controls map-controls`,Ie.style.display="flex",Ie.style.flexDirection="column",Ie.style.alignItems="flex-start",Ie.style.gap="8px",Ie.style.justifyContent="flex-start",Ie.style.alignSelf="flex-start",$e=document.createElement("div"),$e.style.display="flex",$e.style.flexDirection="column",$e.style.alignItems="stretch",$e.style.gap="10px",Ie.appendChild($e);const m="calc(3 * 48px + 2 * 6px)";Ct=document.createElement("div"),Ct.className=`${i}-nav map-nav-grid`,Ct.style.display="grid",Ct.style.gridTemplateColumns="repeat(3, 48px)",Ct.style.gridAutoRows="48px",Ct.style.gap="6px",Ct.style.width=m,Z=document.createElement("div"),Z.className=`${i}-nav-panel map-nav-panel`,Z.setAttribute("role","group"),Z.setAttribute("aria-label","Map navigation controls"),Z.hidden=!0,Z.setAttribute("aria-hidden","true"),Z.appendChild(Ct);const y=`${i}-nav-panel`;Z.id=y,fe=document.createElement("button"),fe.type="button",fe.className="map-nav-toggle",fe.setAttribute("aria-controls",y),fe.setAttribute("aria-expanded","false"),fe.setAttribute("aria-label","Toggle navigation controls");const M=document.createElement("span");M.className="map-nav-toggle__icon",M.textContent="🧭",fe.appendChild(M);const x=(N=!1)=>{const P=!!N;Pe=P,Z.hidden=!P,Z.setAttribute("aria-hidden",P?"false":"true"),fe.setAttribute("aria-expanded",P?"true":"false"),fe.classList.toggle("is-active",P),P?ur(()=>{const Y=Ct.querySelector("button");Y&&Y.focus()}):document.activeElement&&Z.contains(document.activeElement)&&fe.focus()};fe.addEventListener("click",()=>{x(!Pe)}),Z.addEventListener("keydown",N=>{!N||typeof N.key!="string"||N.key==="Escape"&&(N.preventDefault(),x(!1))}),Ae=document.createElement("div"),Ae.className=`${i}-nav-overlay map-nav-overlay`,Ae.style.display="flex",Ae.style.flexDirection="column",Ae.style.alignItems="stretch",Ae.style.gap="10px",Ae.style.width=m,Ae.style.alignSelf="center",Ae.appendChild(fe),Ae.appendChild(Z),$e.appendChild(Ae),Re=document.createElement("div"),Re.className=`${i}-control-details map-control-details`,Re.style.display="flex",Re.style.flexDirection="column",Re.style.gap="12px",Re.style.width=m,Re.style.alignSelf="center",Re.style.boxSizing="border-box",$e.appendChild(Re),Ze=jm({onZoomIn:()=>{Ot(.1)},onZoomOut:()=>{Ot(-.1)},onZoomReset:()=>{tn()},styleButton:(N,P)=>{_(N,P)}}),Ze.element.classList.add(`${i}-zoom`),Ze.element.style.alignSelf="center",yt.appendChild(Ze.element),wt()}u.build,u.craft,u.gather;const st=new Map;let re=null,we=null;const ae=p&&typeof p=="object"?p:{};let Q=null,Fe=null,he=null,U=null,oe=!1;const Ne=new Map;let J=null,ee=null,Ce=null,ke=null,de=null,ge=null,le=null,it=null,en=null,sr=null,_n=!1;const De={options:[],selectedId:null,laborers:null};function Fo(m){if(typeof m!="string")return"";const y=m.trim();return y?y.length>1&&/s$/i.test(y)&&!/ss$/i.test(y)?y.replace(/s$/i,""):y:""}function $o(m={}){const y=typeof m.id=="string"&&m.id.trim()?m.id.trim():null;if(!y)return null;const M=typeof m.label=="string"&&m.label.trim()?m.label.trim():y,x=Fo(M),N=Number.isFinite(m.assigned)?Math.max(0,Math.trunc(m.assigned)):0,P=Number.isFinite(m.capacity)?Math.max(0,Math.trunc(m.capacity)):null,Y=m.description||"",q=Number.isFinite(m.workdayHours)?Math.max(1,Math.trunc(m.workdayHours)):null;return{id:y,label:M,displayLabel:x,assigned:N,capacity:P,description:Y,workdayHours:q}}function Ln(){return Ce?Ce.dataset.hasContent==="true":!1}function Bn(m){it&&(_n=!!(m&&Ln()),_n?(it.style.opacity="1",it.style.visibility="visible",it.style.transform="translateY(0)",it.style.pointerEvents="auto",le&&le.setAttribute("aria-expanded","true")):(it.style.opacity="0",it.style.visibility="hidden",it.style.transform="translateY(-4px)",it.style.pointerEvents="none",le&&le.setAttribute("aria-expanded","false")))}function Ho(m=140){if(clearTimeout(en),!Ln()){Bn(!1);return}en=setTimeout(()=>{Bn(!1)},Math.max(0,m))}function Ar(){clearTimeout(en),clearTimeout(sr),en=null,sr=null}function Io(m){return m?typeof m.displayLabel=="string"&&m.displayLabel?m.displayLabel:m.label:""}function Do(){if(!Q)return;const m=De.options.find(y=>y.id===De.selectedId)||null;if(m)Q.textContent=Io(m),Q.dataset.placeholder="false";else if(!De.options.length)Q.textContent=ae.emptyOptionLabel||"No jobs available",Q.dataset.placeholder="true";else{const y=De.options[0];Q.textContent=Io(y),Q.dataset.placeholder="false"}}function Oo(){const m=De.selectedId;Ne.forEach((y,M)=>{const x=M===m;y.dataset.selected=x?"true":"false",y.setAttribute("aria-selected",x?"true":"false"),y.setAttribute("tabindex",x?"0":"-1"),x?(y.style.background="var(--map-select-selected, linear-gradient(135deg, rgba(40, 72, 140, 0.92), rgba(28, 52, 108, 0.88)))",y.style.boxShadow="inset 0 0 0 1px rgba(150, 182, 246, 0.35)",y.style.opacity="1"):(y.style.background="transparent",y.style.boxShadow="none",y.style.opacity="0.9")})}function bi(){J||(J=m=>{oe&&(!he||!Fe||he.contains(m.target)||Fe.contains(m.target)||Gt(!1))}),ee||(ee=m=>{oe&&m.key==="Escape"&&(m.preventDefault(),Gt(!1,{focusButton:!0}))})}function Gt(m,{focusButton:y=!1}={}){if(!Q||!he)return;De.options.length||(m=!1);const M=!!m;if(oe===M){!M&&y&&requestAnimationFrame(()=>{Q.focus({preventScroll:!0})});return}if(oe=M,Q.setAttribute("aria-expanded",oe?"true":"false"),he.setAttribute("aria-hidden",oe?"false":"true"),oe){bi(),Q.dataset.open="true",Q.style.boxShadow="0 0 0 2px rgba(154, 196, 255, 0.55), 0 8px 18px rgba(0, 0, 0, 0.4)",he.style.display="flex",he.style.opacity="1",he.style.pointerEvents="auto",document.addEventListener("pointerdown",J,!0),document.addEventListener("keydown",ee,!0);const N=Ne.get(De.selectedId)||(U==null?void 0:U.querySelector("button[data-option-id]"));N&&requestAnimationFrame(()=>{N.focus({preventScroll:!0})})}else Q.dataset.open="false",Q.style.boxShadow="0 6px 16px rgba(0, 0, 0, 0.35)",he.style.display="none",he.style.opacity="0",he.style.pointerEvents="none",document.removeEventListener("pointerdown",J,!0),document.removeEventListener("keydown",ee,!0),y&&requestAnimationFrame(()=>{Q.focus({preventScroll:!0})})}function Nr(){return U?Array.from(U.querySelectorAll("button[data-option-id]")):[]}function zo(m){const y=Nr();if(!y.length)return;const M=Math.min(Math.max(m,0),y.length-1),x=y[M];x&&x.focus({preventScroll:!0})}function Rn(m){const y=Nr();if(!y.length)return;const M=typeof document<"u"?document.activeElement:null;let x=y.indexOf(M);if(x===-1){const P=Ne.get(De.selectedId);P&&(x=y.indexOf(P))}x===-1&&(x=0);const N=(x+m+y.length)%y.length;zo(N)}function Po(){if(!Ce)return;Ce.dataset.hasContent="false",Bn(!1);const m=De.options.find(M=>M.id===De.selectedId);if(!m){le&&(le.style.display="none",le.disabled=!0),ke&&(ke.textContent="",ke.style.display="none"),de&&(de.textContent="",de.style.display="none"),ge&&(ge.textContent=ae.emptyMessage||"No jobs are available right now.",ge.style.display=De.options.length?"none":"block");return}if(le&&(le.style.display="inline-flex"),ge&&(ge.style.display="none"),ke){const M=[];Number.isFinite(m.capacity)?M.push(`Assigned ${m.assigned}/${m.capacity}`):M.push(`Assigned ${m.assigned}`),Number.isFinite(m.workdayHours)&&M.push(`${m.workdayHours}h`),Number.isFinite(De.laborers)&&M.push(`${De.laborers} laborers free`),ke.textContent=M.join(" · "),ke.style.display=M.length?"block":"none"}de&&(m.description?(de.textContent=m.description,de.style.display="block"):ae.defaultDescription?(de.textContent=ae.defaultDescription,de.style.display="block"):(de.textContent="",de.style.display="none"));const y=!!(ke!=null&&ke.textContent||de!=null&&de.textContent);Ce.dataset.hasContent=y?"true":"false",le&&(le.disabled=!y,le.style.display=y?"inline-flex":"none",y||Bn(!1))}function jo(m,{fromUser:y=!1}={}){if(!De.options.length){De.selectedId=null,Do(),Oo(),Po();return}const M=De.options.find(x=>x.id===m)||De.options[0]||null;if(De.selectedId=M?M.id:null,Do(),Oo(),y&&Gt(!1,{focusButton:!0}),Po(),y&&typeof ae.onSelect=="function")try{ae.onSelect(De.selectedId,{options:De.options.slice()})}catch(x){console.warn("Job selector onSelect failed",x)}}function _o(){var m;if(!(!Q||!U||!he)){if(Gt(!1),Ne.clear(),U.innerHTML="",!De.options.length){Q.disabled=!0,Q.textContent=ae.emptyOptionLabel||"No jobs available",Q.dataset.placeholder="true",ge&&(ge.textContent=ae.emptyMessage||"No jobs are available right now.",ge.style.display="block");return}Q.disabled=!1,De.options.forEach(y=>{const M=document.createElement("li");M.style.listStyle="none",M.style.margin="0",M.style.padding="0";const x=document.createElement("button");x.type="button",x.dataset.optionId=y.id,x.textContent=Io(y),x.setAttribute("role","option"),x.setAttribute("aria-selected","false"),x.style.width="100%",x.style.border="none",x.style.background="transparent",x.style.color="inherit",x.style.padding="10px 16px",x.style.fontWeight="600",x.style.fontSize="15px",x.style.letterSpacing="0.03em",x.style.textTransform="uppercase",x.style.textAlign="left",x.style.cursor="pointer",x.style.transition="background 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease",x.style.opacity="0.9",x.style.borderRadius="0",x.addEventListener("click",()=>{jo(y.id,{fromUser:!0})}),x.addEventListener("keydown",N=>{if(N.key==="ArrowDown")N.preventDefault(),Rn(1);else if(N.key==="ArrowUp")N.preventDefault(),Rn(-1);else if(N.key==="Home")N.preventDefault(),zo(0);else if(N.key==="End"){N.preventDefault();const P=Nr();zo(Math.max(0,P.length-1))}else N.key==="Enter"||N.key===" "?(N.preventDefault(),jo(y.id,{fromUser:!0})):N.key==="Tab"&&Gt(!1)}),x.addEventListener("mouseenter",()=>{x.dataset.selected!=="true"&&(x.style.background="var(--map-select-hover, rgba(42, 70, 128, 0.82))",x.style.boxShadow="inset 0 0 0 1px rgba(146, 176, 238, 0.18)",x.style.opacity="1")}),x.addEventListener("mouseleave",()=>{x.dataset.selected!=="true"&&(x.style.background="transparent",x.style.boxShadow="none",x.style.opacity="0.9")}),x.addEventListener("focus",()=>{x.dataset.selected!=="true"&&(x.style.background="var(--map-select-hover, rgba(42, 70, 128, 0.82))",x.style.boxShadow="inset 0 0 0 1px rgba(146, 176, 238, 0.22)",x.style.opacity="1")}),x.addEventListener("blur",()=>{x.dataset.selected!=="true"&&(x.style.background="transparent",x.style.boxShadow="none",x.style.opacity="0.9")}),M.appendChild(x),U.appendChild(M),Ne.set(y.id,x)}),De.options.some(y=>y.id===De.selectedId)||(De.selectedId=((m=De.options[0])==null?void 0:m.id)||null),Do(),Oo(),ge&&(ge.style.display="none"),Po()}}function w(m=[],{selectedId:y=null,laborers:M=null}={}){var x;De.options=Array.isArray(m)?m.map($o).filter(Boolean):[],De.laborers=Number.isFinite(M)?Math.max(0,Math.trunc(M)):null,y&&De.options.some(N=>N.id===y)?De.selectedId=y:De.options.some(N=>N.id===De.selectedId)||(De.selectedId=((x=De.options[0])==null?void 0:x.id)||null),_o()}const T=(m,y)=>{m&&(y?(m.style.background="var(--action-button-bg-active, linear-gradient(135deg, rgba(45, 108, 223, 0.95), rgba(88, 173, 255, 0.95)))",m.style.color="var(--action-button-text-active, #fff)",m.style.boxShadow="var(--action-button-shadow-active, 0 6px 16px rgba(45, 108, 223, 0.35))"):(m.style.background="var(--action-button-bg, linear-gradient(135deg, rgba(255, 255, 255, 0.96), rgba(235, 235, 235, 0.92)))",m.style.color="var(--action-button-text, inherit)",m.style.boxShadow="var(--action-button-shadow, 0 2px 6px rgba(0, 0, 0, 0.08))"))},I=m=>{st.forEach((y,M)=>{const x=m===M;y.dataset.active=x?"true":"false",y.setAttribute("aria-pressed",x?"true":"false"),T(y,x)})},D=m=>{m.key==="Escape"&&(m.preventDefault(),B())},B=()=>{if(!we){I(null);return}we.style.display="none",we.setAttribute("aria-hidden","true"),document.removeEventListener("keydown",D),I(null)};if(r){if(re=document.createElement("div"),re.className=`${i}-action-panel map-action-panel`,re.style.display="flex",re.style.flexDirection="column",re.style.alignItems="stretch",re.style.gap="12px",re.style.padding="12px",re.style.borderRadius="16px",re.style.border="1px solid var(--map-border, #ccc)",re.style.background="var(--action-panel-bg, linear-gradient(135deg, rgba(250, 250, 255, 0.94), rgba(232, 236, 252, 0.9)))",re.style.boxShadow="0 18px 42px rgba(4, 10, 28, 0.25)",re.style.alignSelf="flex-start",ae.title){const q=document.createElement("h4");q.textContent=ae.title,q.style.margin="0",q.style.fontSize="18px",q.style.letterSpacing="0.04em",re.appendChild(q)}const m=Re||re,y=document.createElement("div");y.className=`${i}-job-selector map-job-selector`,Object.assign(y.style,{display:"flex",flexDirection:"column",gap:"8px",padding:"12px 14px",borderRadius:"14px",border:"1px solid var(--map-border, rgba(104, 132, 194, 0.75))",background:"var(--map-control-surface, linear-gradient(135deg, rgba(16, 28, 62, 0.95), rgba(12, 22, 46, 0.92)))",boxShadow:"0 10px 24px rgba(0, 0, 0, 0.35)",color:"var(--map-control-text, #f4f7ff)",width:"100%",boxSizing:"border-box"}),m.appendChild(y);const M=document.createElement("div");Object.assign(M.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"8px",position:"relative"}),y.appendChild(M);const x=document.createElement("label");x.textContent=ae.label||"Jobs",x.id=`${i}-job-label`,x.htmlFor=`${i}-job-select`,x.style.fontSize="15px",x.style.fontWeight="600",x.style.letterSpacing="0.04em",x.style.textTransform="uppercase",x.style.color="inherit",M.appendChild(x),le=document.createElement("button"),le.type="button",le.textContent="i",le.setAttribute("aria-label",`${ae.label||"Job"} details`),le.setAttribute("aria-haspopup","true"),le.setAttribute("aria-expanded","false"),Object.assign(le.style,{width:"22px",height:"22px",display:"none",alignItems:"center",justifyContent:"center",borderRadius:"50%",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.75))",background:"transparent",color:"inherit",fontWeight:"700",fontSize:"13px",cursor:"pointer",lineHeight:"1",padding:"0"}),M.appendChild(le),it=document.createElement("div"),it.id=`${i}-job-tooltip`,it.setAttribute("role","tooltip"),Object.assign(it.style,{position:"absolute",right:"0",top:"calc(100% + 8px)",maxWidth:"260px",minWidth:"220px",padding:"12px 14px",borderRadius:"12px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.85))",background:"var(--map-tooltip-bg, rgba(10, 18, 38, 0.96))",boxShadow:"0 12px 28px rgba(0, 0, 0, 0.45)",color:"inherit",opacity:"0",visibility:"hidden",transform:"translateY(-4px)",transition:"opacity 0.12s ease, transform 0.12s ease",pointerEvents:"none",zIndex:"30"}),M.appendChild(it),le.setAttribute("aria-controls",it.id),Fe=document.createElement("div"),Fe.style.position="relative",Fe.style.display="flex",Fe.style.alignItems="center",Fe.style.width="100%",y.appendChild(Fe),Q=document.createElement("button"),Q.type="button",Q.id=`${i}-job-select`,Q.textContent=ae.placeholderLabel||ae.label||"Select",Q.dataset.placeholder="true",Q.dataset.open="false",Q.disabled=!0,Q.setAttribute("aria-haspopup","listbox"),Q.setAttribute("aria-expanded","false"),Q.setAttribute("aria-labelledby",`${x.id} ${Q.id}`),Q.setAttribute("aria-label",ae.ariaLabel||ae.label||"Jobs"),Object.assign(Q.style,{width:"100%",borderRadius:"12px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.8))",padding:"12px 42px 12px 16px",fontWeight:"600",fontSize:"15px",letterSpacing:"0.03em",textTransform:"uppercase",background:"var(--map-select-bg, linear-gradient(135deg, rgba(20, 38, 78, 0.98), rgba(16, 28, 56, 0.95)))",color:"var(--map-select-text, #f5f8ff)",boxShadow:"0 6px 16px rgba(0, 0, 0, 0.35)",cursor:"pointer",textAlign:"left",lineHeight:"1.2",transition:"box-shadow 0.12s ease, transform 0.12s ease",outline:"none"}),Fe.appendChild(Q);const N=document.createElement("span");N.textContent="▾",N.setAttribute("aria-hidden","true"),Object.assign(N.style,{position:"absolute",right:"16px",top:"50%",transform:"translateY(-50%)",pointerEvents:"none",fontSize:"14px",color:"var(--map-select-caret, #d8e2ff)",opacity:"0.85"}),Fe.appendChild(N),he=document.createElement("div"),he.setAttribute("aria-hidden","true"),Object.assign(he.style,{position:"absolute",left:"0",right:"0",top:"calc(100% + 8px)",borderRadius:"14px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.9))",background:"var(--map-select-popup-bg, linear-gradient(135deg, rgba(18, 32, 66, 0.94), rgba(8, 20, 40, 0.9)))",boxShadow:"0 18px 42px rgba(4, 10, 26, 0.55)",padding:"8px 0",display:"none",flexDirection:"column",gap:"0",zIndex:"40",maxHeight:"280px",overflowY:"auto"}),Fe.appendChild(he),U=document.createElement("ul"),U.id=`${i}-job-options`,U.setAttribute("role","listbox"),U.setAttribute("aria-labelledby",x.id),Object.assign(U.style,{display:"flex",flexDirection:"column",margin:"0",padding:"0",gap:"0",listStyle:"none"}),he.appendChild(U),Q.setAttribute("aria-controls",U.id),Q.addEventListener("click",()=>{Gt(!oe)}),Q.addEventListener("keydown",q=>{q.key==="ArrowDown"?(q.preventDefault(),oe?Rn(1):Gt(!0)):q.key==="ArrowUp"?(q.preventDefault(),oe?Rn(-1):Gt(!0)):q.key==="Enter"||q.key===" "?(q.preventDefault(),Gt(!oe)):q.key==="Escape"&&oe&&(q.preventDefault(),Gt(!1,{focusButton:!0}))}),Q.addEventListener("focus",()=>{Q.style.boxShadow="0 0 0 2px rgba(154, 196, 255, 0.55), 0 6px 16px rgba(0, 0, 0, 0.35)"}),Q.addEventListener("blur",()=>{oe||(Q.style.boxShadow="0 6px 16px rgba(0, 0, 0, 0.35)")}),Ce=document.createElement("div"),Ce.dataset.hasContent="false",Object.assign(Ce.style,{display:"flex",flexDirection:"column",gap:"6px",fontSize:"13px",opacity:"0.92"}),it.appendChild(Ce),ke=document.createElement("span"),ke.style.color="inherit",ke.style.display="none",Ce.appendChild(ke),de=document.createElement("span"),de.style.opacity="0.78",de.style.lineHeight="1.35",de.style.display="none",Ce.appendChild(de),ge=document.createElement("span"),ge.style.fontSize="13px",ge.style.opacity="0.8",ge.style.display="none",y.appendChild(ge);const P=()=>{Ar(),Bn(!0)},Y=q=>{Ho(typeof q=="number"?q:void 0)};le.addEventListener("mouseenter",()=>{Ln()&&P()}),le.addEventListener("mouseleave",()=>{Y(120)}),le.addEventListener("focus",()=>{Ln()&&P()}),le.addEventListener("blur",()=>{Y(100)}),le.addEventListener("keydown",q=>{if(q.key==="Enter"||q.key===" "){if(q.preventDefault(),!Ln())return;Bn(!_n)}}),le.addEventListener("pointerdown",q=>{(q.pointerType==="touch"||q.pointerType==="pen")&&(Ar(),sr=setTimeout(()=>{Ln()&&Bn(!0)},420))}),le.addEventListener("pointerup",q=>{(q.pointerType==="touch"||q.pointerType==="pen")&&(Ar(),Y(200))}),le.addEventListener("pointerleave",q=>{(q.pointerType==="touch"||q.pointerType==="pen")&&(Ar(),Y(200))}),De.options.length?_o():w(Array.isArray(ae.options)?ae.options:[],{selectedId:ae.initialId||null,laborers:ae.laborers})}function X(){if(typeof window>"u")return!0;if(typeof window.matchMedia=="function"){const m=window.matchMedia("(orientation: portrait)");if(m&&typeof m.matches=="boolean")return!m.matches}return window.innerWidth>=window.innerHeight}function z(){const m=X(),y=n&&Ie,M=!!re;pe.style.flexDirection="column",pe.style.alignItems="stretch",pe.style.flexWrap="nowrap",yt.parentElement!==qe&&qe.insertBefore(yt,qe.firstChild),yt.style.alignSelf=m&&y?"flex-start":"stretch",yt.style.width="100%",yt.style.maxWidth="100%",m&&y?(qe.style.flexDirection="row",qe.style.flexWrap="nowrap",qe.style.gap="16px",qe.style.justifyContent="flex-start",qe.style.alignItems="flex-start",tt.parentElement||qe.appendChild(tt),tt.style.alignItems="flex-start",tt.style.justifyContent="flex-start",Ie.parentElement!==tt&&(Ie.parentElement&&Ie.parentElement.removeChild(Ie),tt.appendChild(Ie)),Ie.style.margin="0",Ie.style.alignItems="flex-start",Ie.style.alignSelf="flex-start",Ie.style.justifyContent="flex-start"):(qe.style.flexDirection="column",qe.style.flexWrap="nowrap",qe.style.gap="12px",qe.style.justifyContent="flex-start",qe.style.alignItems="flex-start",tt.parentElement&&tt.parentElement.removeChild(tt),y?(Ie.parentElement&&Ie.parentElement!==qe&&Ie.parentElement.removeChild(Ie),Ie.parentElement!==qe&&qe.appendChild(Ie),Ie.style.margin="16px 0 0",Ie.style.alignItems="flex-start",Ie.style.alignSelf="flex-start",Ie.style.justifyContent="flex-start"):Ie!=null&&Ie.parentElement&&Ie.parentElement.removeChild(Ie)),!y&&tt.parentElement&&tt.parentElement.removeChild(tt),M&&re&&(re.parentElement&&re.parentElement!==pe&&re.parentElement.removeChild(re),pe.appendChild(re),re.style.alignSelf="stretch"),ur(Fn),ur(V)}function V(){if(typeof document>"u"||!(pe!=null&&pe.isConnected))return;const m=typeof pe.getBoundingClientRect=="function"?pe.getBoundingClientRect():null,y=m!=null&&m.width?Math.round(m.width):0;y&&document.documentElement.style.setProperty("--map-layout-width",`${y}px`)}function xe(m={}){const y=Number.isFinite(m.x)?m.x:0,M=Number.isFinite(m.y)?m.y:0;return{x:y,y:M}}function se(m={}){const y=W(),M=s.viewport.width||y.cols||Vt,x=s.viewport.height||y.rows||Vt,N=xe(m),P=Math.floor(M/2),Y=Math.floor(x/2);return{xStart:Math.round(N.x)-P,yStart:Math.round(N.y)-Y}}function We(m={},y=0){const M=Number.isFinite(m.x)?Math.trunc(m.x):null,x=Number.isFinite(m.y)?Math.trunc(m.y):null;if(M===null||x===null)return null;const N=m.id||`marker-${y}`,P=m.icon===void 0||m.icon===null?"":String(m.icon),Y=m.className||"",q=!!m.emphasis,j=m.label||"";return{id:N,x:M,y:x,icon:P,className:Y,emphasis:q,label:j}}function Ue(){var x,N,P,Y,q;if(!s.markerLayer)return;if(!((N=(x=s.map)==null?void 0:x.tiles)!=null&&N.length)){s.markerElements.forEach(j=>{j&&(j.style.display="none")});return}const m=s.map.width||((Y=(P=s.map.tiles)==null?void 0:P[0])==null?void 0:Y.length)||0,y=s.map.height||((q=s.map.tiles)==null?void 0:q.length)||0;if(!m||!y||!s.camera){s.markerElements.forEach(j=>{j&&(j.style.display="none")});return}const M=new Set;s.markerDefs.forEach(j=>{const ce=j.x-s.map.xStart,Ee=j.y-s.map.yStart;if(!Number.isFinite(ce)||!Number.isFinite(Ee))return;if(ce<0||Ee<0||ce>=m||Ee>=y){const Te=s.markerElements.get(j.id);Te&&(Te.style.display="none");return}let ie=s.markerElements.get(j.id);ie||(ie=document.createElement("span"),ie.className="map-marker",ie.style.position="absolute",ie.style.transform="translate(-50%, -50%)",ie.style.pointerEvents="none",ie.style.lineHeight="1",ie.style.textShadow="0 0 4px rgba(0, 0, 0, 0.35)",s.markerLayer.appendChild(ie),s.markerElements.set(j.id,ie)),ie.textContent=j.icon,ie.style.fontSize=j.emphasis?"1.6em":"1.4em",j.label?(ie.title=j.label,ie.setAttribute("aria-label",j.label)):(ie.removeAttribute("title"),ie.removeAttribute("aria-label"));const Me=["map-marker"];j.className&&Me.push(j.className),j.emphasis&&Me.push("map-marker--emphasis"),ie.className=Me.join(" ");const Be=s.camera.worldToScreenCenter(j.x,j.y,s.tileBaseSize);if(!(Number.isFinite(Be.x)&&Number.isFinite(Be.y)&&Be.x>=0&&Be.y>=0&&Be.x<=s.camera.viewportWidth&&Be.y<=s.camera.viewportHeight)){ie.style.display="none";return}ie.style.left=`${Be.x}px`,ie.style.top=`${Be.y}px`,ie.style.display="block",M.add(j.id)}),s.markerElements.forEach((j,ce)=>{!M.has(ce)&&j&&(j.style.display="none")})}function Lt(m=[]){const y=Array.isArray(m)?m.map((M,x)=>We(M,x)).filter(Boolean):[];s.markerDefs=y,Ue()}function wt(){if(!Ze)return;const m=Number.isFinite(s.initialZoom)?s.initialZoom:1,y=R();Ze.update({zoom:y,minZoom:s.minZoom,maxZoom:s.maxZoom,baselineZoom:m,camera:s.camera})}function He(){const m=Number.isFinite(s.zoomDisplayFactor)?s.zoomDisplayFactor:1,y=R();if(s.renderer){const M=s.camera?y:m||1;s.renderer.setScale(M)}rn(),wt()}function ut(m,y={}){let M=m;if(s.camera){const x=s.camera.zoom;if(M=s.camera.setZoom(m,y.pivot==="viewport"?"viewport":"centerTile"),!y.force&&Math.abs(M-x)<.001){s.zoom=M,Ye(),He();return}s.zoom=M}else{if(M=Math.min(s.maxZoom,Math.max(s.minZoom,m)),!y.force&&Math.abs(M-s.zoom)<.001){Ye(),He();return}s.zoom=M}Ge({forceFetch:!!y.force}),Ye(),He()}function Ot(m){ut(R()+m)}function tn(){ut(s.initialZoom||1)}function Fn(){var ce,Ee,ie,Me,Be,je,Te,et,zt,At,Ft;if(!s.renderer)return;const m=Number.isFinite((ce=s.camera)==null?void 0:ce.viewportWidth)?s.camera.viewportWidth:(Le==null?void 0:Le.clientWidth)||((Ee=s.renderer.canvas)==null?void 0:Ee.clientWidth)||0,y=Number.isFinite((ie=s.camera)==null?void 0:ie.viewportHeight)?s.camera.viewportHeight:(Le==null?void 0:Le.clientHeight)||((Me=s.renderer.canvas)==null?void 0:Me.clientHeight)||0,M=Number.isFinite(s.viewport.width)&&s.viewport.width>0?s.viewport.width:Number.isFinite((Be=s.map)==null?void 0:Be.width)&&s.map.width>0?s.map.width:((et=(Te=(je=s.map)==null?void 0:je.tiles)==null?void 0:Te[0])==null?void 0:et.length)||0,x=Number.isFinite(s.viewport.height)&&s.viewport.height>0?s.viewport.height:Number.isFinite((zt=s.map)==null?void 0:zt.height)&&s.map.height>0?s.map.height:((Ft=(At=s.map)==null?void 0:At.tiles)==null?void 0:Ft.length)||0,N=Math.max(1,Math.trunc(Number.isFinite(s.zoomBase.width)&&s.zoomBase.width>0?s.zoomBase.width:Number.isFinite(M)&&M>0?M:0)),P=Math.max(1,Math.trunc(Number.isFinite(s.zoomBase.height)&&s.zoomBase.height>0?s.zoomBase.height:Number.isFinite(x)&&x>0?x:0));let Y=Number.isFinite(s.tileBaseSize)&&s.tileBaseSize>0?s.tileBaseSize:Dl;if(m>0&&y>0&&N>0&&P>0){const Un=m/N,on=y/P,Mn=Math.max(2,Math.min(Un,on));Number.isFinite(Mn)&&Mn>0&&(Y=Mn)}s.tileBaseSize=Y,s.renderer.setTileBaseSize(Y),s.renderer.setUseTerrainColors(s.useTerrainColors);const q=R(),j=s.camera?q:s.zoomDisplayFactor||1;s.renderer.setScale(j),rn()}function qn(){var P,Y,q;if(!s.map)return;const m=((Y=(P=s.map.tiles)==null?void 0:P[0])==null?void 0:Y.length)||0,y=((q=s.map.tiles)==null?void 0:q.length)||0;let M=null;if(typeof(pe==null?void 0:pe.getBoundingClientRect)=="function"){const j=pe.getBoundingClientRect();M=(j==null?void 0:j.width)||null}if(tt.parentElement===qe&&typeof tt.getBoundingClientRect=="function"){const j=tt.getBoundingClientRect(),ce=(j==null?void 0:j.width)||0;M=Math.max(0,(M||0)-ce-16)}if(!M&&typeof(e==null?void 0:e.getBoundingClientRect)=="function"){const j=e.getBoundingClientRect();M=(j==null?void 0:j.width)||null}const{width:x,height:N}=rh(m,y,M);Le.style.width=`${x}px`,Le.style.height=`${N}px`,s.renderer&&s.renderer.resize(x,N),s.camera&&s.camera.setViewportSize(x,N),Fn(),ur(()=>{V(),Ue()})}function ze(m={}){s.home=se(s.focus),gt(s.home.xStart,s.home.yStart,m)}function Rt(m={},y={}){s.focus=xe(m),s.context={...s.context,focus:{...s.focus}},s.home=se(s.focus),y.recenter!==!1&&ze(y)}function un({snap:m=!1}={}){var P,Y,q,j,ce,Ee,ie;if(!s.camera)return;const y=Number.isFinite(s.viewport.width)?s.viewport.width:((P=s.map)==null?void 0:P.width)||((j=(q=(Y=s.map)==null?void 0:Y.tiles)==null?void 0:q[0])==null?void 0:j.length)||0,M=Number.isFinite(s.viewport.height)?s.viewport.height:((ce=s.map)==null?void 0:ce.height)||((ie=(Ee=s.map)==null?void 0:Ee.tiles)==null?void 0:ie.length)||0;if(!y||!M)return;const x=s.viewport.xStart+y/2,N=s.viewport.yStart+M/2;s.camera.setCenterTile({x,y:N},{snap:m})}function nn(m={}){var Ee,ie,Me,Be,je,Te,et,zt,At;if(!s.camera)return;const y=m.center||null,M=m.forceFetch===!0,x=Number.isFinite(s.viewport.width)?s.viewport.width:((Ee=s.map)==null?void 0:Ee.width)||((Be=(Me=(ie=s.map)==null?void 0:ie.tiles)==null?void 0:Me[0])==null?void 0:Be.length)||0,N=Number.isFinite(s.viewport.height)?s.viewport.height:((je=s.map)==null?void 0:je.height)||((et=(Te=s.map)==null?void 0:Te.tiles)==null?void 0:et.length)||0;if(!x||!N)return;const P=y||s.camera.centerTile,Y=Math.round(P.x-x/2),q=Math.round(P.y-N/2),j=Number.isFinite(s.viewport.xStart)?s.viewport.xStart:((zt=s.map)==null?void 0:zt.xStart)||0,ce=Number.isFinite(s.viewport.yStart)?s.viewport.yStart:((At=s.map)==null?void 0:At.yStart)||0;Y===j&&q===ce||gt(Y,q,{forceFetch:M})}function kn(){var m;(m=s.keyboardPan)!=null&&m.timer&&(clearTimeout(s.keyboardPan.timer),s.keyboardPan.timer=null)}function yi(){kn(),s.keyboardPan.timer=setTimeout(()=>{s.keyboardPan.timer=null,Qr()},Vm)}function Qr(m={}){if(!s.camera)return null;kn();let y=!1;const M=s.camera.commitSnap({animate:m.animate!==!1,duration:m.duration,onUpdate:()=>{rn()},onComplete:x=>{y=!0,rn(),nn({center:x,forceFetch:!!m.forceFetch})}});return!y&&!(M!=null&&M.changed)&&nn({forceFetch:!!m.forceFetch}),M}function wi(m,y,M){var P;if(!m)return;at.forEach(Y=>m.classList.remove(Y)),delete m.dataset.development,delete m.dataset.developmentLabel,delete m.dataset.developmentStatus,delete m.dataset.developmentDetails,delete m.dataset.developmentCount;const x=ht(y,M);if(!x)return;m.classList.add("map-tile--developed"),x.status==="under-construction"?m.classList.add("map-tile--developed-pending"):x.status==="completed"?m.classList.add("map-tile--developed-complete"):x.status==="planned"?m.classList.add("map-tile--developed-planned"):m.classList.add("map-tile--developed-mixed"),(x.emphasis||x.highlight)&&m.classList.add("map-tile--developed-emphasis"),m.dataset.development="true",x.label&&(m.dataset.developmentLabel=x.label),x.status&&(m.dataset.developmentStatus=x.status);const N=x.tooltip||((P=x.structures)!=null&&P.length?x.structures.join(", "):"");N&&(m.dataset.developmentDetails=N),Number.isFinite(x.count)&&x.count>0&&(m.dataset.developmentCount=`${x.count}`)}function Wn(){var Y,q,j,ce,Ee,ie;const m=s.dataLayer;if(!m)return;if(!((q=(Y=s.map)==null?void 0:Y.tiles)!=null&&q.length)){m.replaceChildren();return}const y=s.map.tiles.length,M=((j=s.map.tiles[0])==null?void 0:j.length)||0;if(!y||!M){m.replaceChildren();return}const x=y*M;if(m.children.length!==x){const Me=document.createDocumentFragment();for(let Be=0;Be<x;Be++){const je=document.createElement("span");je.className="map-tile";const Te=document.createElement("span");Te.className="map-tile-symbol",je.appendChild(Te),Me.appendChild(je)}m.replaceChildren(Me)}const N=m.children;let P=0;for(let Me=0;Me<y;Me++)for(let Be=0;Be<M;Be++){const je=N[P++];if(!(je instanceof HTMLElement))continue;const Te=je;let et=Te.firstElementChild;et instanceof HTMLElement||(et=document.createElement("span"),et.className="map-tile-symbol",Te.appendChild(et));const zt=s.map.xStart+Be,At=s.map.yStart+Me;Te.dataset.col=`${Be}`,Te.dataset.row=`${Me}`,Te.dataset.worldX=`${zt}`,Te.dataset.worldY=`${At}`;const Ft=((Ee=(ce=s.map.types)==null?void 0:ce[Me])==null?void 0:Ee[Be])??null;Ft?Te.dataset.terrain=Ft:delete Te.dataset.terrain;const Un=((ie=s.map.tiles[Me])==null?void 0:ie[Be])??"",on=Ve(Ft),Mn=t[Ft]||Un||Ft||"";et&&(et.textContent=Mn,et.style.backgroundColor=on||"transparent",et.style.borderRadius=on?"6px":"",et.style.boxShadow=on?"inset 0 0 0 1px rgba(0, 0, 0, 0.18)":""),on?Te.classList.add("map-tile--fill"):Te.classList.remove("map-tile--fill"),wi(Te,zt,At)}}function rn(){!s.renderer||s.renderScheduled||(s.renderScheduled=!0,ur(()=>{s.renderScheduled=!1,xi()}))}function xi(){var m,y;if(s.renderer){if(!((y=(m=s.map)==null?void 0:m.tiles)!=null&&y.length)){s.renderer.setMap(null),s.renderer.render(),Ue(),Wn(),Ut({fromRender:!0});return}s.renderer.setMap({...s.map}),s.renderer.render(),Wn(),Ue(),Ut({fromRender:!0})}}function eo(){var M,x,N,P,Y;const m=Number.isFinite(s.viewport.width)?s.viewport.width:((N=(x=(M=s.map)==null?void 0:M.tiles)==null?void 0:x[0])==null?void 0:N.length)||0,y=Number.isFinite(s.viewport.height)?s.viewport.height:((Y=(P=s.map)==null?void 0:P.tiles)==null?void 0:Y.length)||0;return{maxX:Math.max(0,Math.trunc(m)-1),maxY:Math.max(0,Math.trunc(y)-1)}}function vi(){var M,x,N,P,Y;const m=s.viewport.width||((N=(x=(M=s.map)==null?void 0:M.tiles)==null?void 0:x[0])==null?void 0:N.length)||0,y=s.viewport.height||((Y=(P=s.map)==null?void 0:P.tiles)==null?void 0:Y.length)||0;return!m||!y?null:{stepX:Math.max(1,Math.floor(m*.5)),stepY:Math.max(1,Math.floor(y*.5))}}function $n(m,y,M={}){if(!m&&!y)return;const x=vi();if(!x)return;const N=x.stepX*m,P=x.stepY*y;if(!(!N&&!P)){if(s.camera){Cn(N,P,M);return}Cn(N,P,M)}}function Cn(m,y,M={}){var ie,Me;if(!m&&!y)return;const{maxX:x,maxY:N}=eo(),P=ao(m,-x,x),Y=ao(y,-N,N);if(!P&&!Y)return;if(s.camera){s.camera.panBy(P,Y);const Be=s.camera.centerTile;nn({center:Be,forceFetch:M.forceFetch});const je=s.camera.centerTile,Te=Be.x-je.x,et=Be.y-je.y;(Math.abs(Te)>1e-6||Math.abs(et)>1e-6)&&s.camera&&s.camera.panBy(Te,et),rn(),M.deferCommit?yi():M.commit!==!1&&Qr({animate:M.animate!==!1,forceFetch:M.forceFetch});return}const q=Number.isFinite(s.viewport.xStart)?s.viewport.xStart:((ie=s.map)==null?void 0:ie.xStart)||0,j=Number.isFinite(s.viewport.yStart)?s.viewport.yStart:((Me=s.map)==null?void 0:Me.yStart)||0,ce=q+P,Ee=j+Y;gt(ce,Ee,M)}function qo(m,y){$n(m,y)}function Lr(){if(!n||!Ct)return;const m=s.navMode==="player"?"Travel":"Pan",y=s.navMode==="player"?"Center on explorer":"Recenter map";[{label:"↖",dx:-1,dy:-1,aria:`${m} northwest`},{label:"↑",dx:0,dy:-1,aria:`${m} north`},{label:"↗",dx:1,dy:-1,aria:`${m} northeast`},{label:"←",dx:-1,dy:0,aria:`${m} west`},{label:"⌂",recenter:!0,aria:y},{label:"→",dx:1,dy:0,aria:`${m} east`},{label:"↙",dx:-1,dy:1,aria:`${m} southwest`},{label:"↓",dx:0,dy:1,aria:`${m} south`},{label:"↘",dx:1,dy:1,aria:`${m} southeast`}].forEach(x=>{const N=document.createElement("button");N.type="button",N.textContent=x.label,N.setAttribute("aria-label",x.aria),_(N,{variant:"chip",fontSize:"22px"}),N.addEventListener("click",()=>{x.recenter?s.navMode==="player"&&typeof s.onNavigate=="function"?s.onNavigate({dx:0,dy:0,recenter:!0}):ze():s.navMode==="player"&&typeof s.onNavigate=="function"?s.onNavigate({dx:x.dx??0,dy:x.dy??0,recenter:!1}):qo(x.dx,x.dy)}),Ct.appendChild(N)})}function lr(m){if(!m||typeof m.key!="string")return;const y=Xm[m.key];if(y){if(s.navMode==="player"&&typeof s.onNavigate=="function"){m.preventDefault(),s.onNavigate({dx:y.dx,dy:y.dy,recenter:!1});return}m.preventDefault(),$n(y.dx,y.dy,{deferCommit:!0})}}function Si(m,y){o&&(ot(),kt(),s.drag.active=!0,s.drag.lastX=m,s.drag.lastY=y,s.drag.pendingX=0,s.drag.pendingY=0,s.drag.fractionalX=0,s.drag.fractionalY=0,kn(),Le.style.cursor="grabbing")}function Wo(m,y){var et,zt,At,Ft,Un;if(!s.drag.active)return;const M=m-s.drag.lastX,x=y-s.drag.lastY;s.drag.lastX=m,s.drag.lastY=y,s.drag.pendingX-=M,s.drag.pendingY-=x;const N=((At=(zt=(et=s.map)==null?void 0:et.tiles)==null?void 0:zt[0])==null?void 0:At.length)||s.viewport.width||0,P=((Un=(Ft=s.map)==null?void 0:Ft.tiles)==null?void 0:Un.length)||s.viewport.height||0;if(!N||!P)return;const q=(s.dataLayer||bt).getBoundingClientRect(),j=q.width/N,ce=q.height/P;if(!j||!ce)return;if(s.camera){let on=!1;const Mn=Math.trunc(s.drag.pendingX/j),Uo=Math.trunc(s.drag.pendingY/ce);if(Mn||Uo){const{maxX:ol,maxY:il}=eo(),ja=ao(Mn,-ol,ol),_a=ao(Uo,-il,il);ja||_a?(s.drag.pendingX-=ja*j,s.drag.pendingY-=_a*ce,Cn(ja,_a,{commit:!1}),on=!0):(s.drag.pendingX=Math.sign(s.drag.pendingX)*Math.min(Math.abs(s.drag.pendingX),j),s.drag.pendingY=Math.sign(s.drag.pendingY)*Math.min(Math.abs(s.drag.pendingY),ce))}const Yo=j?s.drag.pendingX/j:0,ki=ce?s.drag.pendingY/ce:0,nl=Yo-s.drag.fractionalX,rl=ki-s.drag.fractionalY;(nl||rl)&&(s.camera.panBy(nl,rl),on=!0),on&&rn(),s.drag.fractionalX=Yo,s.drag.fractionalY=ki;return}const Ee=Math.trunc(s.drag.pendingX/j),ie=Math.trunc(s.drag.pendingY/ce);if(!Ee&&!ie)return;const{maxX:Me,maxY:Be}=eo(),je=ao(Ee,-Me,Me),Te=ao(ie,-Be,Be);!je&&!Te||(s.drag.pendingX-=je*j,s.drag.pendingY-=Te*ce,Cn(je,Te))}function to(){s.drag.active&&(s.drag.active=!1,Le.style.cursor=o?"grab":"default",s.drag.pendingX=0,s.drag.pendingY=0,s.drag.fractionalX=0,s.drag.fractionalY=0,s.camera&&Qr())}function ru(){if(!o)return null;const m=M=>{s.drag.active&&(M.preventDefault(),Wo(M.clientX,M.clientY))},y=M=>{var N;if(!s.drag.active||!((N=M.touches)!=null&&N.length))return;const x=M.touches[0];Wo(x.clientX,x.clientY),M.preventDefault()};return Le.addEventListener("mousedown",M=>{M.preventDefault(),Si(M.clientX,M.clientY)}),Le.addEventListener("touchstart",M=>{var N;if(!((N=M.touches)!=null&&N.length))return;const x=M.touches[0];Si(x.clientX,x.clientY),M.preventDefault()},{passive:!1}),window.addEventListener("mousemove",m),window.addEventListener("mouseup",to),window.addEventListener("touchmove",y,{passive:!1}),window.addEventListener("touchend",to),window.addEventListener("touchcancel",to),()=>{window.removeEventListener("mousemove",m),window.removeEventListener("mouseup",to),window.removeEventListener("touchmove",y),window.removeEventListener("touchend",to),window.removeEventListener("touchcancel",to)}}Le.addEventListener("keydown",lr);const tl=ru();return He(),Lr(),z(),typeof window<"u"&&(s.resizeHandler=()=>{qn(),z()},window.addEventListener("resize",s.resizeHandler)),{setMap(m,y={}){var Y,q,j,ce,Ee,ie;s.hasInitializedBaseChunk=!1,s.context={...s.context,...y};const M=(y==null?void 0:y.focus)??(y==null?void 0:y.center)??(y==null?void 0:y.current)??(y==null?void 0:y.currentCoords)??(y==null?void 0:y.homeCoords)??s.focus;if(s.focus=xe(M),!m){s.map=null,s.buffer=null,s.context={...s.context,focus:{...s.focus}},s.zoomBase={width:0,height:0},s.zoomDisplayFactor=1,s.zoom=1,s.pendingZoomSync=!1,Je([]),s.camera&&s.camera.setCenterTile({x:s.focus.x,y:s.focus.y},{snap:!0}),ut(1,{force:!0}),s.renderer&&(s.renderer.setMap(null),s.renderer.setScale(1)),rn(),He(),Wn();return}const x=Ol(m);(Y=x==null?void 0:x.tiles)!=null&&Y.length&&(s.hasInitializedBaseChunk=!0),s.buffer=x,K(x);const N=m.viewport??(x==null?void 0:x.viewport)??null;N?(s.viewport.width=Math.max(1,Mt(N.width,s.viewport.width)),s.viewport.height=Math.max(1,Mt(N.height,s.viewport.height)),s.viewport.xStart=Mt(N.xStart,(x==null?void 0:x.xStart)??s.viewport.xStart??0),s.viewport.yStart=Mt(N.yStart,(x==null?void 0:x.yStart)??s.viewport.yStart??0)):x?(s.viewport.xStart=Mt(m.xStart??x.xStart,x.xStart),s.viewport.yStart=Mt(m.yStart??x.yStart,x.yStart)):(s.viewport.xStart=Mt(m.xStart,s.viewport.xStart??0),s.viewport.yStart=Mt(m.yStart,s.viewport.yStart??0)),K(x),s.map={seed:m.seed??(x==null?void 0:x.seed)??((q=s.map)==null?void 0:q.seed),season:m.season??(x==null?void 0:x.season)??((j=s.map)==null?void 0:j.season),waterLevel:m.waterLevel??(x==null?void 0:x.waterLevel)??((ce=s.map)==null?void 0:ce.waterLevel),tiles:[],types:null,elevations:null,xStart:s.viewport.xStart,yStart:s.viewport.yStart,width:s.viewport.width,height:s.viewport.height},(!s.zoomBase.width||!s.zoomBase.height)&&(s.zoomBase.width=Math.max(1,s.viewport.width||((Ee=s.map)==null?void 0:Ee.width)||Vt),s.zoomBase.height=Math.max(1,s.viewport.height||((ie=s.map)==null?void 0:ie.height)||Vt)),s.pendingZoomSync=Math.abs(s.zoom-1)>.001,s.context={...s.context,focus:{...s.focus},seed:s.map.seed,season:s.map.season},s.home=se(s.focus);const P=eh(m);if(Je(P),(!Number.isFinite(s.viewport.xStart)||!Number.isFinite(s.viewport.yStart))&&(s.viewport.xStart=s.home.xStart,s.viewport.yStart=s.home.yStart),un({snap:!0}),x){if(!ye()){gt(s.viewport.xStart,s.viewport.yStart,{forceFetch:!0});return}s.viewport.xStart!==s.home.xStart||s.viewport.yStart!==s.home.yStart?gt(s.home.xStart,s.home.yStart):Tt();return}rn(),gt(s.viewport.xStart,s.viewport.yStart,{forceFetch:!0})},refresh(){qn(),Fn(),z()},setTerrainColors(m=null,y={}){var x,N;const{forceRefresh:M=!1}=y||{};m===!1?s.terrainColorOverrides=null:m&&typeof m=="object"&&(s.terrainColorOverrides=Hl(m)),M&&mi({forceRefresh:!0}),s.useTerrainColors&&((N=(x=s.map)==null?void 0:x.tiles)!=null&&N.length)&&(Wn(),rn())},setJobOptions(m=[],y={}){w(m,y)},getSelectedJob(){return De.selectedId},center:ze,setFocus:Rt,setMarkers:Lt,setDevelopments:Je,destroy(){kn(),typeof window<"u"&&(s.resizeHandler&&window.removeEventListener("resize",s.resizeHandler),tl&&tl()),s.markerElements.forEach(m=>{m!=null&&m.parentElement&&m.parentElement.removeChild(m)}),s.markerElements.clear(),s.markerDefs=[],s.markerLayer=null,pe.parentElement&&pe.parentElement.removeChild(pe),Gt(!1),s.developmentTiles=new Map,Ne.clear(),B(),we!=null&&we.parentElement&&we.parentElement.removeChild(we),we=null,Q=null,he=null,U=null,Fe=null,typeof document<"u"&&document.documentElement.style.removeProperty("--map-layout-width"),Le.removeEventListener("keydown",lr)},elements:{layout:pe,mapContainer:qe,wrapper:Le,stage:lt,display:Qe,canvas:G,markers:St,controls:Ie,nav:Ct,controlDetails:Re,actionPanel:re,actionButtons:st,jobSelect:Q,zoom:Ze?Ze.element:null,navOverlay:Ae}}}const dd="theme:selected",ud="theme:appearance",Ds=["theme"],ih=new Map([["lunar-surface-dawn","lunar-surface"]]),fd=new Set(["light","dark"]),ah=["red","orange","yellow","green","blue","pink","purple","brown"];function Gr(e,t=0,n=1){return typeof e!="number"||Number.isNaN(e)?t:Math.min(Math.max(e,t),n)}function Nt(e){if(!e)return null;const t=String(e).trim();if(!t)return null;const n=t.startsWith("#")?t.slice(1):t;if(/^([0-9a-f]{6})$/i.test(n))return`#${n.toLowerCase()}`;if(/^([0-9a-f]{3})$/i.test(n)){const[r,o,i]=n.split("");return`#${r}${r}${o}${o}${i}${i}`.toLowerCase()}return null}function hs(e){const t=Nt(e);if(!t)return null;const n=t.slice(1),r=parseInt(n.slice(0,2),16),o=parseInt(n.slice(2,4),16),i=parseInt(n.slice(4,6),16);return[r,o,i].some(a=>Number.isNaN(a))?null:{r,g:o,b:i}}function sh({r:e,g:t,b:n}){const r=Gr(Math.round(e),0,255),o=Gr(Math.round(t),0,255),i=Gr(Math.round(n),0,255);return`#${[r,o,i].map(a=>a.toString(16).padStart(2,"0")).join("")}`}function mr(e,t,n=.5){const r=hs(e),o=hs(t);if(!r||!o)return Nt(e)||Nt(t);const i=Gr(n,0,1);return sh({r:r.r*(1-i)+o.r*i,g:r.g*(1-i)+o.g*i,b:r.b*(1-i)+o.b*i})}function Ki(e,t=.15){return mr(e,"#ffffff",Gr(t,0,1))}function Zi(e,t=.15){return mr(e,"#000000",Gr(t,0,1))}function gs(e){const t=hs(e);if(!t)return 0;const n=[t.r,t.g,t.b].map(r=>{const o=r/255;return o<=.03928?o/12.92:Math.pow((o+.055)/1.055,2.4)});return .2126*n[0]+.7152*n[1]+.0722*n[2]}function Bi(e,t){const n=Nt(e),r=Nt(t);if(!n||!r)return 1;const o=gs(n),i=gs(r),a=Math.max(o,i),d=Math.min(o,i);return(a+.05)/(d+.05)}function Rr(e,t,n=4.5){const r=Nt(t);if(!r)return Nt(e)||"#ffffff";const o=Nt(e),i=gs(r),a=i>.5?"#111827":"#f9fafb",d=i>.5?"#f9fafb":"#111827",l=[];o&&l.push({color:o,ratio:Bi(o,r)}),l.push({color:Nt(a),ratio:Bi(a,r)}),l.push({color:Nt(d),ratio:Bi(d,r)});let c=l.filter(h=>h.color).sort((h,g)=>g.ratio-h.ratio)[0];if(!c)return"#ffffff";if(c.ratio>=n)return c.color;const f=i>.5?"#000000":"#ffffff";let u=c.color,p=c.ratio;for(let h=0;h<6&&p<n;h+=1)u=mr(u,f,.35),p=Bi(u,r);return p>=n?u:c.color}function Vo(e={}){const t=Nt(e.base)||Nt(e.light)||Nt(e.dark)||"#6b7280",n=Nt(e.light)||Ki(t,.18),r=Nt(e.dark)||Zi(t,.22);return{light:n,base:Nt(e.base)||t,dark:r}}const kr=[{id:"lunar-surface",meta:{label:"Lunar Surface",emoji:"🌕",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Full%20Moon/3D/full_moon_3d.png"},appearance:"dark",colors:{background:{light:"#2d3036",base:"#1f2228",dark:"#111419"},neutral:{light:"#dfe3eb",base:"#c7cbd3",dark:"#5f646f"},primary:{light:"#d6dae2",base:"#c3c8d0",dark:"#7b808a"},secondary:{light:"#d8dce4",base:"#c3c7cf",dark:"#757a84"},accent:{light:"#dfe3eb",base:"#ccd1d9",dark:"#8b9098"}},standardColors:{red:{light:"#d7dadd",dark:"#6b6e74"},orange:{light:"#cfd1d6",dark:"#686b71"},yellow:{light:"#c7cacf",dark:"#5f6268"},green:{light:"#c1c4c9",dark:"#585b60"},blue:{light:"#bbbfc5",dark:"#51555c"},pink:{light:"#d2d5da",dark:"#6a6d73"},purple:{light:"#c6c9d0",dark:"#5d6168"},brown:{light:"#bfc2c7",dark:"#55585e"}},text:{primary:"#f0f2f7",muted:"#dde1e8"},appearances:{light:{colors:{background:{light:"#f5f6f8",base:"#e5e7eb",dark:"#c2c5cc"},neutral:{light:"#4f5359",base:"#383c42",dark:"#202329"},primary:{light:"#6d7178",base:"#555960",dark:"#3a3e44"},secondary:{light:"#90949c",base:"#757981",dark:"#4f535a"},accent:{light:"#a4a8b0",base:"#878b93",dark:"#5d6168"}},standardColors:{red:{light:"#a6a9af",dark:"#4a4d53"},orange:{light:"#b0b3b9",dark:"#505359"},yellow:{light:"#bbbfc6",dark:"#555960"},green:{light:"#aeb1b8",dark:"#4c5056"},blue:{light:"#a1a5ac",dark:"#45494f"},pink:{light:"#b7bac1",dark:"#53565d"},purple:{light:"#bfc2ca",dark:"#595d63"},brown:{light:"#a7abb2",dark:"#4a4e54"}},text:{primary:"#1c1f23",muted:"#4f535a"}}}},{id:"apple-orchard",meta:{label:"Apple Orchard",emoji:"🍎",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Red%20Apple/3D/red_apple_3d.png"},appearance:"dark",colors:{background:{light:"#3a181b",base:"#271012",dark:"#120708"},neutral:{light:"#e4cfc9",base:"#b68f84",dark:"#7d6257"},primary:{light:"#ff6b6f",base:"#d9393e",dark:"#941c20"},secondary:{light:"#8ed97a",base:"#5faa4c",dark:"#3a6f2b"},accent:{light:"#f0b36a",base:"#c87f2f",dark:"#8a4f12"}},standardColors:{red:{light:"#ff6b6f",dark:"#941c20"},orange:{light:"#ff9b4f",dark:"#a85318"},yellow:{light:"#ffe38a",dark:"#b38a1b"},green:{light:"#8ed97a",dark:"#2f6b2a"},blue:{light:"#7fc1f7",dark:"#215b8e"},pink:{light:"#f7a1b5",dark:"#9a4963"},purple:{light:"#c29aff",dark:"#6c3ab8"},brown:{light:"#d7a47d",dark:"#7b4a2d"}},text:{primary:"#fbeae7",muted:"#c7a8a0"}},{id:"heartbeat-glow",meta:{label:"Heartbeat Glow",emoji:"❤️",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Red%20Heart/3D/red_heart_3d.png"},appearance:"dark",colors:{background:{light:"#431a2a",base:"#301320",dark:"#14060d"},neutral:{light:"#efd1da",base:"#c79aa9",dark:"#8a6976"},primary:{light:"#ff6b8f",base:"#ff3366",dark:"#b1123d"},secondary:{light:"#ffa4d9",base:"#ff6fbf",dark:"#c13f8a"},accent:{light:"#ffd27f",base:"#ffb347",dark:"#b47618"}},standardColors:{red:{light:"#ff6b8f",dark:"#b1123d"},orange:{light:"#ff9354",dark:"#b5541c"},yellow:{light:"#ffe382",dark:"#b88a20"},green:{light:"#9de2c0",dark:"#2f7a52"},blue:{light:"#7fbbff",dark:"#245a9d"},pink:{light:"#ff9ed1",dark:"#aa4d83"},purple:{light:"#c69dff",dark:"#6f3fab"},brown:{light:"#d7a691",dark:"#7a4937"}},text:{primary:"#ffeef3",muted:"#d7a3b7"}},{id:"evergreen-grove",meta:{label:"Evergreen Grove",emoji:"🌳",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Evergreen%20Tree/3D/evergreen_tree_3d.png"},appearance:"light",colors:{background:{light:"#f7fbf5",base:"#edf5eb",dark:"#c7d5c4"},neutral:{light:"#88977f",base:"#5b6a54",dark:"#394637"},primary:{light:"#63b36a",base:"#3d8543",dark:"#24562a"},secondary:{light:"#9dc98a",base:"#7aa66a",dark:"#4c7341"},accent:{light:"#f2c78d",base:"#c9985b",dark:"#8f6330"}},standardColors:{red:{light:"#f07f6f",dark:"#9c3b2c"},orange:{light:"#f6a85f",dark:"#b16019"},yellow:{light:"#fbe183",dark:"#b39829"},green:{light:"#7dd687",dark:"#2d6a35"},blue:{light:"#7fb5d9",dark:"#285c7d"},pink:{light:"#f2adc5",dark:"#9b4f74"},purple:{light:"#bfa6ec",dark:"#62479f"},brown:{light:"#cba581",dark:"#6c4b2e"}},text:{primary:"#263322",muted:"#546250"}},{id:"ember-forge",meta:{label:"Ember Forge",emoji:"🔥",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Fire/3D/fire_3d.png"},appearance:"dark",colors:{background:{light:"#401812",base:"#2a0f0a",dark:"#120503"},neutral:{light:"#f1d0c2",base:"#d0a89b",dark:"#946f63"},primary:{light:"#ff8a52",base:"#ff6b2d",dark:"#b73c07"},secondary:{light:"#ffc075",base:"#ff9f43",dark:"#c36a15"},accent:{light:"#ffe28a",base:"#ffd166",dark:"#b99229"}},standardColors:{red:{light:"#ff7053",dark:"#b12f1a"},orange:{light:"#ff9f43",dark:"#b55311"},yellow:{light:"#ffd76a",dark:"#b48b16"},green:{light:"#a4d67a",dark:"#436a1f"},blue:{light:"#77b4e8",dark:"#1f5387"},pink:{light:"#f293b3",dark:"#9d4363"},purple:{light:"#c79ae8",dark:"#69399c"},brown:{light:"#d49c71",dark:"#7c451b"}},text:{primary:"#fff2ea",muted:"#ddb09e"}},{id:"fireworks-festival",meta:{label:"Fireworks Festival",emoji:"🎆",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Fireworks/3D/fireworks_3d.png"},appearance:"light",colors:{background:{light:"#fbfdff",base:"#f4f7ff",dark:"#d0d9f5"},neutral:{light:"#6f7691",base:"#4e5470",dark:"#313752"},primary:{light:"#6d81ff",base:"#3d5af1",dark:"#2235a3"},secondary:{light:"#ff83da",base:"#ff4ecd",dark:"#c11c92"},accent:{light:"#ffe67a",base:"#ffd74f",dark:"#b89711"}},standardColors:{red:{light:"#ff6a86",dark:"#b31e3d"},orange:{light:"#ff9a4a",dark:"#b35d0d"},yellow:{light:"#ffe67a",dark:"#b5971a"},green:{light:"#94e6c3",dark:"#2c7d4f"},blue:{light:"#6fb6ff",dark:"#205ea2"},pink:{light:"#ffa0de",dark:"#b94b91"},purple:{light:"#b79aff",dark:"#5b38b4"},brown:{light:"#c8a37a",dark:"#704c22"}},text:{primary:"#202544",muted:"#535a79"}},{id:"rose-garden",meta:{label:"Rose Garden",emoji:"🌹",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Rose/3D/rose_3d.png"},appearance:"light",colors:{background:{light:"#fff9fb",base:"#fff4f6",dark:"#e7c7d0"},neutral:{light:"#9c6b7b",base:"#6f4a57",dark:"#402730"},primary:{light:"#ff7a9b",base:"#d03a59",dark:"#911932"},secondary:{light:"#ff98b8",base:"#ff7899",dark:"#c5476b"},accent:{light:"#b6daa1",base:"#8fbf72",dark:"#55773d"}},standardColors:{red:{light:"#ff7a9b",dark:"#911932"},orange:{light:"#ffad71",dark:"#b55e22"},yellow:{light:"#ffe6a3",dark:"#b59135"},green:{light:"#9fdda7",dark:"#3d7b43"},blue:{light:"#7fbef0",dark:"#2a6190"},pink:{light:"#ff9ec6",dark:"#b14a7e"},purple:{light:"#c8a1e8",dark:"#6a347f"},brown:{light:"#d2a28a",dark:"#744434"}},text:{primary:"#2c1a22",muted:"#5c3d47"}},{id:"melody-waves",meta:{label:"Melody Waves",emoji:"🎵",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Musical%20Notes/3D/musical_notes_3d.png"},appearance:"dark",colors:{background:{light:"#272b50",base:"#1a1d3b",dark:"#0a0b1b"},neutral:{light:"#d6d8f0",base:"#b5b8d8",dark:"#7c80a3"},primary:{light:"#7a8aff",base:"#5b6dff",dark:"#2c38b8"},secondary:{light:"#b68aff",base:"#9b58ff",dark:"#6221c1"},accent:{light:"#58e2d6",base:"#33d1c6",dark:"#17887e"}},standardColors:{red:{light:"#ff6c87",dark:"#a9203a"},orange:{light:"#ff9a55",dark:"#b1581a"},yellow:{light:"#ffdf73",dark:"#af8b18"},green:{light:"#7ce8c3",dark:"#1f7a54"},blue:{light:"#7fb6ff",dark:"#244ea2"},pink:{light:"#f99ade",dark:"#a7438a"},purple:{light:"#c49dff",dark:"#5f33b6"},brown:{light:"#c6a48a",dark:"#704b34"}},text:{primary:"#eef0ff",muted:"#bfc2df"}},{id:"ocean-tide",meta:{label:"Ocean Tide",emoji:"🌊",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Water%20Wave/3D/water_wave_3d.png"},appearance:"light",colors:{background:{light:"#f4fbfd",base:"#e7f4f9",dark:"#bfd6e1"},neutral:{light:"#73929e",base:"#4d6773",dark:"#2c3f46"},primary:{light:"#3b92c7",base:"#0f6fa4",dark:"#0a4a6e"},secondary:{light:"#55c0e6",base:"#2ba5d6",dark:"#176a8d"},accent:{light:"#f5c98a",base:"#f2b866",dark:"#af7a24"}},standardColors:{red:{light:"#f57c7d",dark:"#9c2d2f"},orange:{light:"#f7a65d",dark:"#b05919"},yellow:{light:"#ffe38a",dark:"#b59128"},green:{light:"#87dcb3",dark:"#2f7850"},blue:{light:"#68c3ff",dark:"#1e5d9a"},pink:{light:"#f4a7c8",dark:"#9e4a73"},purple:{light:"#b8a0f0",dark:"#5d3f9c"},brown:{light:"#c49a76",dark:"#6d4426"}},text:{primary:"#1f2f38",muted:"#4a5e69"}},{id:"sunburst-plains",meta:{label:"Sunburst Plains",emoji:"☀️",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Sun/3D/sun_3d.png"},appearance:"light",colors:{background:{light:"#fffdf5",base:"#fff8e6",dark:"#e9d5a5"},neutral:{light:"#9d8458",base:"#755f36",dark:"#4a3819"},primary:{light:"#ffbe4a",base:"#f4a11a",dark:"#b56a06"},secondary:{light:"#ffe066",base:"#ffcc33",dark:"#c1900b"},accent:{light:"#7cd3dc",base:"#5dbec8",dark:"#2d8087"}},standardColors:{red:{light:"#ff8360",dark:"#b33e1a"},orange:{light:"#ffb347",dark:"#b86612"},yellow:{light:"#ffe066",dark:"#b6910a"},green:{light:"#a7e37c",dark:"#4a8b20"},blue:{light:"#7fc4f5",dark:"#2a6aa6"},pink:{light:"#f9a4c2",dark:"#a64d6f"},purple:{light:"#c9a6ef",dark:"#6d459d"},brown:{light:"#d2a877",dark:"#704819"}},text:{primary:"#2c220e",muted:"#605235"}},{id:"lunar-serenity",meta:{label:"Lunar Serenity",emoji:"🌙",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Crescent%20Moon/3D/crescent_moon_3d.png"},appearance:"dark",colors:{background:{light:"#272a42",base:"#1a1c2e",dark:"#0c0d18"},neutral:{light:"#e0e3f0",base:"#c6c9dd",dark:"#8b8fa8"},primary:{light:"#9aa5ff",base:"#7c89ff",dark:"#3d48b8"},secondary:{light:"#daa9ff",base:"#c98bff",dark:"#8640c9"},accent:{light:"#ffe7a4",base:"#f6d87d",dark:"#b79a33"}},standardColors:{red:{light:"#ff7083",dark:"#ac2538"},orange:{light:"#ff9e55",dark:"#b35a1b"},yellow:{light:"#ffe18a",dark:"#b49028"},green:{light:"#8edcc2",dark:"#2f7860"},blue:{light:"#80c0ff",dark:"#245ca2"},pink:{light:"#f5a7da",dark:"#a55a92"},purple:{light:"#c3a2ff",dark:"#5e3ab2"},brown:{light:"#cdb196",dark:"#755a3b"}},text:{primary:"#f4f5ff",muted:"#c2c5da"}},{id:"frostfall-glade",meta:{label:"Frostfall Glade",emoji:"❄️",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Snowflake/3D/snowflake_3d.png"},appearance:"light",colors:{background:{light:"#ffffff",base:"#f2f8ff",dark:"#c7d8ea"},neutral:{light:"#6d7f93",base:"#4f6175",dark:"#2b3746"},primary:{light:"#6bc1f2",base:"#4aa4e0",dark:"#1f6498"},secondary:{light:"#b2e1ff",base:"#8fd0ff",dark:"#4d8ec7"},accent:{light:"#8ee4d8",base:"#6bd4c4",dark:"#2d8a7d"}},standardColors:{red:{light:"#f27f8e",dark:"#a23744"},orange:{light:"#f8ad6a",dark:"#b3621f"},yellow:{light:"#ffea95",dark:"#b59a24"},green:{light:"#7fdcc0",dark:"#2c7955"},blue:{light:"#6fc3ff",dark:"#1f5da0"},pink:{light:"#f4a6d5",dark:"#9d4f87"},purple:{light:"#bfa4f2",dark:"#5f419f"},brown:{light:"#c6a584",dark:"#6e4c2e"}},text:{primary:"#24364b",muted:"#54677f"}},{id:"granite-peaks",meta:{label:"Granite Peaks",emoji:"⛰️",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Mountain/3D/mountain_3d.png"},appearance:"dark",colors:{background:{light:"#2b2f32",base:"#1f2224",dark:"#0f1112"},neutral:{light:"#e0e3e7",base:"#c2c6cb",dark:"#8a8f95"},primary:{light:"#8a98a7",base:"#6d7e8f",dark:"#425260"},secondary:{light:"#c69b6c",base:"#a57e54",dark:"#6b4b26"},accent:{light:"#7fc2b5",base:"#57a999",dark:"#276f60"}},standardColors:{red:{light:"#f07672",dark:"#a32e2c"},orange:{light:"#f29a5a",dark:"#ae5c19"},yellow:{light:"#f5d877",dark:"#b08a1f"},green:{light:"#9dd2a7",dark:"#316a3a"},blue:{light:"#7fb1d4",dark:"#264d6c"},pink:{light:"#f0a6c5",dark:"#9a4f74"},purple:{light:"#b7a0d9",dark:"#5a417f"},brown:{light:"#c7a47f",dark:"#6d4a28"}},text:{primary:"#edf0f3",muted:"#b7bcc3"}},{id:"hearthside-brew",meta:{label:"Hearthside Brew",emoji:"☕",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Hot%20Beverage/3D/hot_beverage_3d.png"},appearance:"dark",colors:{background:{light:"#3f2720",base:"#2e1b13",dark:"#170c08"},neutral:{light:"#ecd8c9",base:"#d0b5a1",dark:"#9a7f6b"},primary:{light:"#d99260",base:"#c47a3d",dark:"#8a4614"},secondary:{light:"#ad6c45",base:"#8d4f2c",dark:"#5b2f14"},accent:{light:"#f6dba0",base:"#e5c27c",dark:"#b38a38"}},standardColors:{red:{light:"#f07262",dark:"#a32b1c"},orange:{light:"#f89c54",dark:"#ae5614"},yellow:{light:"#f8d072",dark:"#b1871a"},green:{light:"#97d28c",dark:"#3a6c30"},blue:{light:"#76b7df",dark:"#1f547a"},pink:{light:"#f09ebc",dark:"#94415f"},purple:{light:"#c59be1",dark:"#66358d"},brown:{light:"#d8aa7c",dark:"#6d3e1b"}},text:{primary:"#fef4ec",muted:"#d8b89d"}},{id:"zephyr-leaf",meta:{label:"Zephyr Leaf",emoji:"🍃",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Leaf%20Fluttering%20In%20Wind/3D/leaf_fluttering_in_wind_3d.png"},appearance:"light",colors:{background:{light:"#fafffc",base:"#f2fbf4",dark:"#c8e1cd"},neutral:{light:"#789883",base:"#56715c",dark:"#334537"},primary:{light:"#73c08b",base:"#4fa26d",dark:"#2f7047"},secondary:{light:"#a9d8a8",base:"#8ac78a",dark:"#577f57"},accent:{light:"#f6d895",base:"#f2c86b",dark:"#b58b2b"}},standardColors:{red:{light:"#f37d78",dark:"#a33a32"},orange:{light:"#f7aa63",dark:"#b3621c"},yellow:{light:"#ffe08c",dark:"#b19227"},green:{light:"#7fd89a",dark:"#2f6d42"},blue:{light:"#7ebfde",dark:"#266180"},pink:{light:"#f2a9c7",dark:"#964469"},purple:{light:"#bea5e6",dark:"#5f3e93"},brown:{light:"#c7a378",dark:"#6b4726"}},text:{primary:"#233027",muted:"#4f6355"}},{id:"stormspark",meta:{label:"Stormspark",emoji:"⚡",image:"https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Cloud%20With%20Lightning/3D/cloud_with_lightning_3d.png"},appearance:"dark",colors:{background:{light:"#202633",base:"#141923",dark:"#07090d"},neutral:{light:"#d5d9e4",base:"#b7bdc9",dark:"#7f8591"},primary:{light:"#ffe06a",base:"#ffd13b",dark:"#b99105"},secondary:{light:"#86c7ff",base:"#5aa9ff",dark:"#1f69b1"},accent:{light:"#ff8c5c",base:"#ff6f3c",dark:"#b33a11"}},standardColors:{red:{light:"#ff6e63",dark:"#b22c22"},orange:{light:"#ff9945",dark:"#b55612"},yellow:{light:"#ffe06a",dark:"#b89316"},green:{light:"#8bd9a3",dark:"#2f7341"},blue:{light:"#7dbaff",dark:"#1f5ca7"},pink:{light:"#f79cd0",dark:"#a24677"},purple:{light:"#c7a3ff",dark:"#6138a2"},brown:{light:"#c9a281",dark:"#6f4b2a"}},text:{primary:"#f5f6ff",muted:"#c3c8d4"}}];function pd(e,t){if(!e)return{colors:{},standardColors:void 0,text:void 0,legendColors:void 0};const n=e.colors?{...e.colors}:{},r=e.standardColors?{...e.standardColors}:void 0,o=e.text?{...e.text}:void 0,i=e.legendColors?{...e.legendColors}:void 0,a=e.appearances||null,d=(a==null?void 0:a[t])||e.appearance&&(a==null?void 0:a[e.appearance])||null;if(!d)return{colors:n,standardColors:r,text:o,legendColors:i};const l=d.colors?{...n,...d.colors}:n,c=d.standardColors||r,f=d.text||o,u=d.legendColors?{...i||{},...d.legendColors}:i;return{colors:l,standardColors:c,text:f,legendColors:u}}const Da=new Map(kr.map(e=>[e.id,e])),ma=new Set(kr.map(e=>e.id)),lh=kr.map(e=>`theme-${e.id}`);function Oa(e,t=dt){if(!e)return null;const n=e.meta?{...e.meta}:{label:"",emoji:"",image:null},r=pd(e,t);return{...e,meta:n,colors:r.colors,standardColors:r.standardColors,text:r.text,name:n.emoji||"",label:n.label||"",activeAppearance:t}}const bs=new Set;let ha=!1,Os=!1,Ko=null,Zo=null;function md(){if(Ko||typeof window>"u"||typeof window.matchMedia!="function")return Ko;try{Ko=window.matchMedia("(prefers-color-scheme: dark)")}catch(e){console.warn("Unable to access system color scheme.",e),Ko=null}return Ko}function ch(){const e=[ud,...Ds];for(const r of e){const o=Ls(r);if(o&&fd.has(o))return Os=!0,o}const t=md();return(t&&typeof t.matches=="boolean"?t.matches:!0)?"dark":"light"}function dh(e){var r;const t=e||dt||"dark",n=kr.find(o=>o.appearance===t)||kr[0];return(n==null?void 0:n.id)||((r=kr[0])==null?void 0:r.id)}function uh(){const e=[dd,...Ds];for(const t of e){const n=Ls(t);if(n){if(ma.has(n))return n;const r=ih.get(n);if(r&&ma.has(r))return r}}return null}let dt=ch(),wn=(()=>{const e=uh();return e?(ha=!0,e):dh(dt)})();function te(e,t,n){var r;!e||typeof((r=e.style)==null?void 0:r.setProperty)!="function"||!t||e.style.setProperty(t,n)}function fh(e,t){ah.forEach(n=>{const r=t==null?void 0:t[n];if(!r){te(e,`--color-${n}-light`,""),te(e,`--color-${n}-dark`,"");return}const o=Nt(r.light),i=Nt(r.dark);te(e,`--color-${n}-light`,o||""),te(e,`--color-${n}-dark`,i||"")})}function zl(e,t){return!e||!t?"":`linear-gradient(135deg, ${e}, ${t})`}function Fr(e,t=1){const n=Nt(e);if(!n)return"";const r=parseInt(n.slice(1,3),16),o=parseInt(n.slice(3,5),16),i=parseInt(n.slice(5,7),16);if([r,o,i].some(d=>Number.isNaN(d)))return"";const a=Math.round(Gr(t,0,1)*1e3)/1e3;return`rgba(${r}, ${o}, ${i}, ${a})`}function zs(){if(typeof document>"u")return;const e=document.documentElement,t=document.body;if(!e||!t)return;const n=Da.get(wn);if(!n)return;const{colors:r,standardColors:o,text:i,legendColors:a}=pd(n,dt),d=r||{},l=Vo(d.background||{}),c=Vo(d.neutral||{}),f=Vo(d.primary||{}),u=Vo(d.secondary||{}),p=Vo(d.accent||{});let h,g,b,S,v,k,E,A,L;dt==="light"?(h=l.light,g=Ki(h,.12),b=l.base,S=Zi(l.base,.22),v=c.light,k=Ki(v,.12),E=c.base,A=c.dark,L=[h,g,Ki(g,.14),v,k]):(h=l.base,g=l.light,b=l.dark,S=Zi(b,.28),v=c.base,k=c.light,E=c.dark,A=Zi(E,.24),L=[S,h,g,E,v]),te(e,"--color-background",h),te(e,"--color-background-light",g),te(e,"--color-background-dark",b),te(e,"--color-neutral",v),te(e,"--color-neutral-light",k),te(e,"--color-neutral-dark",E),te(e,"--color-primary",f.base),te(e,"--color-primary-light",f.light),te(e,"--color-primary-dark",f.dark),te(e,"--color-secondary",u.base),te(e,"--color-secondary-light",u.light),te(e,"--color-secondary-dark",u.dark),te(e,"--color-accent",p.base),te(e,"--color-accent-light",p.light),te(e,"--color-accent-dark",p.dark),te(e,"--accent",p.base),te(e,"--accent-500",p.base),te(e,"--accent-bright",p.light),te(e,"--accent-strong",p.dark),te(e,"--layer-background-0",L[0]),te(e,"--layer-background-1",L[1]),te(e,"--layer-background-2",L[2]),te(e,"--layer-background-3",L[3]),te(e,"--layer-background-4",L[4]);const F=L[1]||h,O=L[2]||F,H=L[3]||O,_=L[4]||H,$=L[0]||h;te(e,"--bg",$),te(e,"--surface",F),te(e,"--surface-1",F),te(e,"--surface-2",O),te(e,"--surface-3",H),te(e,"--surface-4",_),te(e,"--bg-color",$),te(e,"--surface-color",F),te(e,"--surface-alt-color",O),te(e,"--surface-strong-color",H),te(e,"--menu-bg",L[1]),te(e,"--map-bg",L[1]);const s=dt==="light"?.32:.45,R=dt==="light"?.4:.55;te(e,"--map-border",Fr(f.dark,s)),te(e,"--map-border-strong",Fr(u.dark,R)),te(e,"--action-panel-bg",L[2]),te(e,"--action-option-bg",L[3]),te(e,"--card-bg",L[3]),te(e,"--card-bg-alt",L[4]);const W=F,K=H,ne=Rr(i==null?void 0:i.primary,W,4.6),ye=Rr(i==null?void 0:i.muted,W,3.2),me=Rr(i==null?void 0:i.primary,K,4.6);te(e,"--text-color",ne),te(e,"--text",ne),te(e,"--text-strong",me),te(e,"--text-muted",ye),te(e,"--card-text",Rr(i==null?void 0:i.primary,K,4.6)),te(e,"--heading-color",me);const Oe=Rr(i==null?void 0:i.primary,p.base,4.6);te(e,"--accent-contrast",Oe);const Ye=zl(f.dark,f.light),Ge=zl(u.dark,u.light);te(e,"--action-button-bg",Ye),te(e,"--action-button-text",Rr(ne,f.dark,4.6));const Ve=dt==="light"?.25:.4,Se=dt==="light"?.3:.5,at=dt==="light"?.3:.45;te(e,"--action-button-shadow",`0 3px 12px ${Fr(f.dark,Ve)}`),te(e,"--action-button-shadow-hover",`0 10px 24px ${Fr(f.dark,Se)}`),te(e,"--action-button-bg-active",Ge),te(e,"--action-button-text-active",Rr(ne,u.dark,4.6)),te(e,"--action-button-shadow-active",`0 12px 26px ${Fr(u.dark,at)}`);const Xe=mr(E,W,dt==="light"?.6:.35),ht=mr(E,W,dt==="light"?.5:.28),_t=mr(E,W,dt==="light"?.42:.22);te(e,"--chip-bg",Xe),te(e,"--chip-bg-hover",ht),te(e,"--chip-bg-active",_t),te(e,"--outline-strong",f.light);const Je=mr(A,W,dt==="light"?.35:.6),Tt=mr(A,W,dt==="light"?.65:.35);te(e,"--border-strong",Je),te(e,"--border-soft",Tt),te(e,"--backdrop-shadow",`0 24px 60px ${Fr(S,dt==="light"?.28:.55)}`),te(e,"--accent-glow-soft",Fr(p.light,dt==="light"?.35:.4)),fh(e,o),t.dataset.themeAppearance=dt}function hd(e,{persist:t=!0}={}){ma.has(e)&&(t&&(ha=!0,ca(dd,e),ca(Ds[0],e)),wn=e,bd(),zs(),Ps())}function gd(e,{persist:t=!0,notify:n=!0}={}){fd.has(e)&&e!==dt&&(t&&(Os=!0,ca(ud,e)),dt=e,zs(),n&&Ps())}function ph(){const e=md();if(!e||Zo)return;const t=n=>{var d;if(Os)return;const o=(typeof(n==null?void 0:n.matches)=="boolean"?n.matches:!!e.matches)?"dark":"light",i=((d=kr.find(l=>l.appearance===o))==null?void 0:d.id)||wn,a=!ha&&i!==wn;gd(o,{persist:!1,notify:!a}),!ha&&a&&hd(i,{persist:!1})};typeof e.addEventListener=="function"?(e.addEventListener("change",t),Zo=()=>{e.removeEventListener("change",t),Zo=null}):typeof e.addListener=="function"&&(e.addListener(t),Zo=()=>{e.removeListener(t),Zo=null})}function bd(){if(typeof document>"u"||!document.body)return;const{body:e}=document;e.classList.remove(...lh),wn&&e.classList.add(`theme-${wn}`)}function Ps(){const e=Da.get(wn),t=Oa(e,dt);bs.forEach(n=>{try{n(wn,t)}catch(r){console.error("Theme listener error",r)}})}function mh(){bd(),zs(),Ps(),ph()}function js(){return wn}function Pl(e=wn){return Oa(Da.get(e),dt)}function yd(){return kr.map(e=>Oa(e,dt))}function wd(e){ma.has(e)&&hd(e,{persist:!0})}function ga(){return dt}function ba(e){gd(e,{persist:!0,notify:!0})}function ys(e,{immediate:t=!1}={}){if(typeof e!="function")return()=>{};if(bs.add(e),t)try{e(wn,Oa(Da.get(wn),dt))}catch(n){console.error("Theme listener error",n)}return()=>{bs.delete(e)}}const jl=[{id:"Thawbound",label:"Spring",icon:"🌱"},{id:"Sunheight",label:"Summer",icon:"☀️"},{id:"Emberwane",label:"Autumn",icon:"🍂"},{id:"Frostshroud",label:"Winter",icon:"❄️"}],hh={easy:"forgiving",normal:"balanced",hard:"brutal",custom:"tailored"},_l=128,ql="#7d7f81",gh=.08,Qa="#f2f4ff",bh=.08,yh=[{id:"oreDensity",path:["oreDensity"],label:"Ore Density",hint:"Likelihood of exposed ore veins.",min:0,max:100,step:1},{id:"waterTable",path:["waterTable"],label:"Water Table",hint:"Baseline access to groundwater and springs.",min:0,max:100,step:1},{id:"temperature",path:["temperature"],label:"Temperature",hint:"Relative warmth influencing open ground.",min:0,max:100,step:1},{id:"rainfall",path:["rainfall"],label:"Rainfall",hint:"Moisture levels that drive vegetation density.",min:0,max:100,step:1},{id:"mountains",path:["mountains"],label:"Mountains",hint:"Terrain ruggedness and elevation swings.",min:0,max:100,step:1},{id:"rivers100",path:["rivers100"],label:"Rivers (100 tiles)",hint:"Presence of flowing water near the start.",min:0,max:100,step:1},{id:"lakes100",path:["lakes100"],label:"Lakes (100 tiles)",hint:"Probability of still water nearby.",min:0,max:100,step:1}],wh=[{id:"advanced.elevationBase",path:["advanced","elevationBase"],label:"Elevation Base",hint:"Adjusts the average terrain height.",min:0,max:100,step:1},{id:"advanced.elevationVariance",path:["advanced","elevationVariance"],label:"Elevation Variance",hint:"Controls how steep or flat the landscape feels.",min:0,max:100,step:1},{id:"advanced.elevationScale",path:["advanced","elevationScale"],label:"Elevation Scale",hint:"Sets the scale of elevation noise patterns.",min:0,max:100,step:1},{id:"advanced.vegetationScale",path:["advanced","vegetationScale"],label:"Vegetation Scale",hint:"How clustered forests and clearings appear.",min:0,max:100,step:1},{id:"advanced.oreNoiseScale",path:["advanced","oreNoiseScale"],label:"Ore Noise Scale",hint:"Controls size of ore-rich pockets.",min:0,max:100,step:1},{id:"advanced.oreThresholdOffset",path:["advanced","oreThresholdOffset"],label:"Ore Threshold Offset",hint:"Bias for how easily ore tiles appear.",min:0,max:100,step:1},{id:"advanced.waterGuaranteeRadius",path:["advanced","waterGuaranteeRadius"],label:"Water Guarantee Radius",hint:"Radius checked to ensure starter water.",min:0,max:100,step:1},{id:"advanced.waterFlowMultiplier",path:["advanced","waterFlowMultiplier"],label:"Water Flow Multiplier",hint:"Scales river strength and drainage (50 is balanced).",min:0,max:100,step:1}],Wl=[...yh,...wh],Ul=[{id:"water",label:"Water",parameters:["waterTable","rivers100","lakes100","advanced.waterGuaranteeRadius","advanced.waterFlowMultiplier"]},{id:"ore",label:"Ore",parameters:["oreDensity","advanced.oreNoiseScale","advanced.oreThresholdOffset"]},{id:"fauna",label:"Fauna",parameters:["advanced.elevationVariance"]},{id:"flora",label:"Flora",parameters:["rainfall","advanced.vegetationScale"]},{id:"climate",label:"Climate",parameters:["temperature","advanced.elevationBase"]},{id:"events",label:"Events",parameters:["mountains"]},{id:"misc",label:"Misc",parameters:["advanced.elevationScale"]}];function Ri(e,t=0,n=100){const r=Number(e);return!Number.isFinite(r)||r<t?t:r>n?n:Math.round(r)}function En(e=ai){const t=xr(e);return{...t,advanced:{...t.advanced}}}function Yl(e,t=[]){return t.reduce((n,r)=>{if(!(!n||typeof n!="object"))return n[r]},e)}function Gl(e,t=[],n){if(!t.length)return;let r=e;for(let o=0;o<t.length-1;o+=1){const i=t[o];(!r[i]||typeof r[i]!="object")&&(r[i]={}),r=r[i]}r[t[t.length-1]]=n}function Xl(e=[]){return e.join(".")}function Vl(e){if(!e)return[];const t=["a[href]","button:not([disabled])",'input:not([disabled]):not([type="hidden"])',"select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(",");return Array.from(e.querySelectorAll(t)).filter(n=>!(n instanceof HTMLElement)||n.hidden?!1:n.getAttribute("aria-hidden")!=="true")}function xh(e,t=""){return!e||typeof e!="string"?t:e.split("-").filter(Boolean).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")}function Fi(){return typeof crypto<"u"&&(crypto!=null&&crypto.getRandomValues)?crypto.getRandomValues(new Uint32Array(1))[0].toString(36):Math.trunc(Date.now()*Math.random()).toString(36)}function vh(e){var jo,_o;Gc();const t=document.getElementById("content"),n=document.getElementById("setup"),r=t||n||document.body;n&&r!==n&&n.parentElement?n.parentElement.removeChild(n):n&&(n.innerHTML="");const o=r.querySelector(".create-steps");(o==null?void 0:o.parentElement)===r&&o.parentElement.removeChild(o);const i=r.querySelector("#create-step-content");(i==null?void 0:i.parentElement)===r&&i.parentElement.removeChild(i),document.body.classList.add("landing-active");const a=r.querySelector("#game"),d=a&&r.contains(a)?a:null,l=document.createElement("template");l.innerHTML=`
    <header class="setup-appbar" role="banner">
      <label class="setup-appbar__title" for="seed-input">World Seed</label>
      <div class="setup-appbar__seed">
        <div class="seed-row">
          <input id="seed-input" class="input" placeholder="Enter seed or leave blank for random" autocomplete="off">
          <button id="seed-rand" type="button" class="icon-ghost" aria-label="Randomize seed">
            <svg
              aria-hidden="true"
              viewBox="0 0 24 24"
              focusable="false"
              class="icon-ghost__glyph"
            >
              <rect
                x="5"
                y="5"
                width="14"
                height="14"
                rx="3"
                ry="3"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              ></rect>
              <circle cx="9" cy="9" r="1.5" fill="currentColor"></circle>
              <circle cx="15" cy="9" r="1.5" fill="currentColor"></circle>
              <circle cx="9" cy="15" r="1.5" fill="currentColor"></circle>
              <circle cx="15" cy="15" r="1.5" fill="currentColor"></circle>
              <circle cx="12" cy="12" r="1.5" fill="currentColor"></circle>
            </svg>
          </button>
        </div>
      </div>
      <button
        id="difficulty-toggle"
        type="button"
        class="icon-ghost"
        aria-haspopup="dialog"
        aria-expanded="false"
        aria-controls="difficulty-modal"
        aria-label="Adjust difficulty"
      >
        <svg
          aria-hidden="true"
          viewBox="0 0 24 24"
          focusable="false"
          class="icon-ghost__glyph"
        >
          <path
            d="M4 6h16M4 12h16M4 18h16"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
          ></path>
          <circle cx="9" cy="6" r="2" fill="currentColor"></circle>
          <circle cx="15" cy="12" r="2" fill="currentColor"></circle>
          <circle cx="12" cy="18" r="2" fill="currentColor"></circle>
        </svg>
      </button>
    </header>
    <dialog
      id="difficulty-modal"
      class="modal"
      aria-labelledby="difficulty-modal-title"
    >
      <div class="modal__card difficulty-modal">
        <header class="modal__header">
          <div class="modal__title">
            <h2 class="difficulty-modal__title" id="difficulty-modal-title">Difficulty</h2>
            <div class="difficulty-modal__meta">
              <div class="difficulty-score" id="difficulty-score" role="status" aria-live="polite"></div>
              <div class="difficulty-tip" id="difficulty-tip"></div>
            </div>
          </div>
          <button
            id="difficulty-close"
            type="button"
            class="modal__close"
            aria-label="Close difficulty settings"
          >
            ✕
          </button>
        </header>
        <div class="modal__body">
          <div class="difficulty-modal__preset-field">
            <label class="difficulty-modal__preset-label" for="difficulty-preset">Preset</label>
            <select id="difficulty-preset" class="difficulty-modal__preset"></select>
          </div>
          <div
            class="difficulty-modal__tabs"
            role="tablist"
            aria-label="Difficulty parameter categories"
            data-role="difficulty-tabs"
          ></div>
          <div class="difficulty-modal__panels" data-role="difficulty-panels"></div>
        </div>
        <footer class="modal__footer">
          <button id="difficulty-reset" type="button" class="btn btn--ghost">Reset</button>
          <div class="spacer" aria-hidden="true"></div>
          <button id="difficulty-apply" type="button" class="btn btn--primary">Apply</button>
        </footer>
      </div>
    </dialog>
    <section id="create-step-content" aria-live="polite">
      <div class="setup">
        <div class="setup__column setup__column--primary">
          <div class="card section" id="biome-card">
            <div class="season-row">
              <div class="season-label section__title">Starting Season</div>
              <div class="season-switch" id="season-seg"></div>
            </div>
            <div class="section__title">Biome</div>
            <div class="grid" id="biome-grid"></div>
            <div class="sub" id="biome-details"></div>
          </div>
        </div>
        <div class="setup__column setup__column--preview">
          <div class="card section map-section">
            <div id="map-preview" class="map-preview" aria-label="World map preview"></div>
            <p class="sub" id="spawn-info"></p>
          </div>
          <div class="card cta-row">
            <button id="randomize-all" type="button" class="btn">Randomize All</button>
            <div class="spacer" aria-hidden="true"></div>
            <button id="start-btn" type="button" class="btn btn--primary">Start Game</button>
          </div>
        </div>
      </div>
    </section>
  `;const c=l.content;r.insertBefore(c,d);const f=r.querySelector("#create-step-content"),u=f==null?void 0:f.querySelector(".setup"),p=r.querySelector(".setup-appbar"),h=r.querySelector("#difficulty-modal"),g=r.querySelector("#difficulty-toggle"),b=h==null?void 0:h.querySelector("#difficulty-close"),S=h==null?void 0:h.querySelector("#difficulty-reset"),v=h==null?void 0:h.querySelector("#difficulty-apply"),k=h==null?void 0:h.querySelector('[data-role="difficulty-tabs"]'),E=h==null?void 0:h.querySelector('[data-role="difficulty-panels"]'),A=h==null?void 0:h.querySelector("#difficulty-tip"),L=h==null?void 0:h.querySelector("#difficulty-score"),F=h==null?void 0:h.querySelector("#difficulty-preset");if(!f||!u||!p||!h||!g||!k||!E)throw new Error("Unable to initialize setup UI layout.");f.hidden=!1,f.style.display="";const O=document.querySelector(".settings-float");O!=null&&O.parentElement&&O.parentElement.removeChild(O);const H=document.createElement("div");H.className="settings-float";const _=document.createElement("button");_.id="landing-settings-btn",_.type="button",_.className="icon-gear",_.setAttribute("aria-haspopup","true"),_.setAttribute("aria-expanded","false"),_.setAttribute("aria-controls","landing-settings-panel"),_.setAttribute("aria-label","Settings"),_.title="Settings";const $=document.createElement("span");$.setAttribute("aria-hidden","true"),$.textContent="⚙️",_.appendChild($);const s=document.createElement("div");s.id="landing-settings-panel",s.className="hero-settings__panel",s.setAttribute("role","dialog"),s.setAttribute("aria-hidden","true"),s.setAttribute("aria-labelledby","landing-settings-title"),s.innerHTML=`
    <div class="hero-settings__header">
      <div class="badge badge--ok">Alpha</div>
      <div class="hero-settings__title" id="landing-settings-title">Settings</div>
    </div>
    <div class="hero-settings__section">
      <div class="hero-settings__section-title">Theme</div>
      <div class="hero-settings__theme-row" id="landing-theme-grid"></div>
    </div>
  `,H.append(_,s),(document.body||r).appendChild(H);const W=s.querySelector("#landing-theme-grid"),K=u.querySelector("#biome-grid"),ne=u.querySelector("#biome-details"),ye=u.querySelector("#season-seg"),me=r.querySelector("#seed-input"),Oe=r.querySelector("#seed-rand"),Ye=u.querySelector("#map-preview"),Ge=u.querySelector("#spawn-info"),Ve=u.querySelector("#randomize-all"),Se=u.querySelector("#start-btn");if(!K||!ne||!ye||!me||!Oe||!Ye||!Ge||!Ve||!Se)throw new Error("Missing setup UI elements.");let at=()=>{};const Xe=yd(),ht=new Map;if(W){W.innerHTML="";const w=document.createElement("div");w.className="hero-settings__theme-contrast";const T=document.createElement("span");T.className="hero-settings__theme-contrast-label",T.textContent="Preview contrast";const I=document.createElement("div");I.className="hero-settings__theme-contrast-controls";const D=document.createElement("button");D.type="button",D.className="hero-settings__theme-contrast-btn",D.textContent="Light",D.setAttribute("aria-pressed","false");const B=document.createElement("button");B.type="button",B.className="hero-settings__theme-contrast-btn",B.textContent="Dark",B.setAttribute("aria-pressed","false"),I.append(D,B),w.append(T,I);const X=document.createElement("div");X.className="hero-settings__theme-grid",W.append(w,X),at=z=>{const V=z==="light"?"light":"dark";X.dataset.contrast=V,D.classList.toggle("is-active",V==="light"),B.classList.toggle("is-active",V==="dark"),D.setAttribute("aria-pressed",String(V==="light")),B.setAttribute("aria-pressed",String(V==="dark"))},D.addEventListener("click",()=>{ba("light")}),B.addEventListener("click",()=>{ba("dark")}),Xe.forEach(z=>{var He,ut,Ot;const V=document.createElement("button");V.type="button",V.className="hero-settings__theme-btn",V.dataset.themeId=z.id,V.dataset.themeAppearance=z.appearance,V.setAttribute("aria-pressed","false");const xe=((He=z.meta)==null?void 0:He.label)||xh(z.id),se=xe||((ut=z.meta)==null?void 0:ut.emoji)||z.id;V.setAttribute("aria-label",`Switch to ${se}`),V.title=se;const We=document.createElement("span");We.className="hero-settings__theme-icon",We.textContent=((Ot=z.meta)==null?void 0:Ot.emoji)||"",We.setAttribute("aria-hidden","true");const Ue=document.createElement("span");Ue.className="hero-settings__theme-label",Ue.textContent=xe;const Lt=`linear-gradient(145deg, ${z.colors.primary.light}, ${z.colors.secondary.light})`,wt=`linear-gradient(145deg, ${z.colors.primary.dark}, ${z.colors.secondary.dark})`;V.style.setProperty("--preview-bg-light",Lt),V.style.setProperty("--preview-bg-dark",wt),V.style.setProperty("--preview-border-light",z.colors.primary.light),V.style.setProperty("--preview-border-dark",z.colors.primary.dark),V.style.setProperty("--preview-fg-light","#18202b"),V.style.setProperty("--preview-fg-dark","#f6f8ff"),V.style.setProperty("--preview-shadow-light","0 1px 1px rgba(255, 255, 255, 0.55)"),V.style.setProperty("--preview-shadow-dark","0 2px 8px rgba(0, 0, 0, 0.55)"),V.append(We,Ue),V.addEventListener("click",()=>{wd(z.id),Tt({returnFocus:!0})}),X.appendChild(V),ht.set(z.id,V)}),at(ga())}function _t(w=js()){ht.forEach((T,I)=>{const D=I===w;T.classList.toggle("is-active",D),T.setAttribute("aria-pressed",String(D))})}function Je(){!s||!_||(s.classList.add("is-open"),s.setAttribute("aria-hidden","false"),_.setAttribute("aria-expanded","true"))}function Tt(w={}){!s||!_||(s.classList.remove("is-open"),s.setAttribute("aria-hidden","true"),_.setAttribute("aria-expanded","false"),w.returnFocus&&_.focus())}_&&s&&H&&(_.addEventListener("click",w=>{w.stopPropagation(),s.classList.contains("is-open")?Tt({returnFocus:!0}):Je()}),s.addEventListener("click",w=>{w.stopPropagation()}),document.addEventListener("click",w=>{H.contains(w.target)||Tt()}),document.addEventListener("keydown",w=>{w.key==="Escape"&&Tt({returnFocus:!0})}));const rt=[],pt=[],qt=new Map,gt=new Map,Le=new Map;let bt=((jo=Ul[0])==null?void 0:jo.id)||null,G=Pl(),Qe=null;ys((w,T)=>{G=T||Pl(w),at((G==null?void 0:G.activeAppearance)||ga()),_t(w),rt.forEach($e),Qe!=null&&Qe.setTerrainColors&&Qe.setTerrainColors(null,{forceRefresh:!0})},{immediate:!0});const St=qa.find(w=>w.id==="temperate-deciduous")||qa[0],xn=jl[0],Ut=no.find(w=>w.id==="normal")||no[0],Yt=new Map(Wl.map(w=>[w.id,w]));let be=(St==null?void 0:St.id)||"",kt=(xn==null?void 0:xn.id)||"",Ke=(Ut==null?void 0:Ut.id)||"",ct=En(((_o=Mi(Ke))==null?void 0:_o.world)||ai),mt=Fi(),ot=null,dn=null,ue=null,Qt=null,vn=null,Sn=null;const ir="setup-spawn-marker",ar=180,Dt=200,pe=Mo();pe!=null&&pe.biome&&(be=pe.biome),pe!=null&&pe.season&&(kt=pe.season),pe!=null&&pe.difficulty&&(Ke=no.some(w=>w.id===pe.difficulty)?pe.difficulty:"custom"),pe!=null&&pe.worldParameters&&(ct=En(pe.worldParameters)),pe!=null&&pe.seed&&(mt=String(pe.seed));const qe=[{type:"open",label:"Open Land"},{type:"forest",label:"Forest"},{type:"stone",label:"Stone Outcrop"},{type:"ore",label:"Ore Deposits"},{type:"water",label:"Water"}],yt=qe.reduce((w,T)=>(w[T.type]=T.label,w),{});me.value=mt;function lt(w){if(!w)return null;const T=w.trim().toLowerCase();if(!T||T==="transparent")return{r:0,g:0,b:0,a:0};const I=T.match(/^rgba?\(\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)(?:\s*,\s*([\d.]+))?\s*\)$/);if(I){const[,B,X,z,V]=I;return{r:Number(B),g:Number(X),b:Number(z),a:V!==void 0?Number(V):1}}const D=T.match(/^#([0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/);if(D){const B=D[1];if(B.length===3||B.length===4){const[X,z,V,xe]=B.split("").map(se=>parseInt(se+se,16));return{r:X,g:z,b:V,a:B.length===4?xe/255:1}}if(B.length===6||B.length===8){const X=parseInt(B.slice(0,2),16),z=parseInt(B.slice(2,4),16),V=parseInt(B.slice(4,6),16),xe=B.length===8?parseInt(B.slice(6,8),16)/255:1;return{r:X,g:z,b:V,a:xe}}}return null}function tt(w){if(!w)return"";const T=Math.round(Math.max(0,Math.min(255,w.r))),I=Math.round(Math.max(0,Math.min(255,w.g))),D=Math.round(Math.max(0,Math.min(255,w.b))),B=typeof w.a=="number"?Math.max(0,Math.min(1,w.a)):1;return B>=1?`rgb(${T}, ${I}, ${D})`:`rgba(${T}, ${I}, ${D}, ${Number(B.toFixed(3))})`}function Ie(w,T,I){if(!w)return null;const D=Math.max(0,Math.min(1,I??0)),B=1-D,X=typeof w.a=="number"?w.a:1,z=typeof(T==null?void 0:T.a)=="number"?T.a:X;return{r:w.r*B+((T==null?void 0:T.r)??w.r)*D,g:w.g*B+((T==null?void 0:T.g)??w.g)*D,b:w.b*B+((T==null?void 0:T.b)??w.b)*D,a:X*B+z*D}}function Ct(w,T=.08){const I={r:255,g:255,b:255,a:typeof(w==null?void 0:w.a)=="number"?w.a:1};return Ie(w,I,T)}function Ae(w){if(!w)return 0;const[T,I,D]=[w.r??0,w.g??0,w.b??0].map(B=>{const X=B/255;return X<=.03928?X/12.92:Math.pow((X+.055)/1.055,2.4)});return .2126*T+.7152*I+.0722*D}function fe(w,T){if(!w||!T)return 1;const I=Ae(w),D=Ae(T),B=Math.max(I,D),X=Math.min(I,D);return(B+.05)/(X+.05)}function Z(w,T,I=4.5){if(!T)return w||lt("#ffffff");const D=Ae(T),B=lt(D>.5?"#111827":"#f9fafb"),X=lt(D>.5?"#f9fafb":"#111827"),z=[];w&&z.push({color:w,ratio:fe(w,T)}),B&&z.push({color:B,ratio:fe(B,T)}),X&&z.push({color:X,ratio:fe(X,T)});let V=z.sort((Ue,Lt)=>Lt.ratio-Ue.ratio)[0];if(!V)return lt("#ffffff");if(V.ratio>=I)return V.color;const xe=lt(D>.5?"#000000":"#ffffff");let se=V.color,We=V.ratio;for(let Ue=0;Ue<6&&We<I;Ue+=1)se=Ie(se,xe,.35),We=fe(se,T);return We>=I?se:V.color}function Pe(w,T){w.forEach(I=>{I.classList.toggle("is-active",I===T)})}function $e(w){var se,We,Ue,Lt,wt,He,ut,Ot,tn,Fn,qn,ze,Rt,un,nn,kn,yi,Qr,wi,Wn,rn,xi,eo,vi;if(!w)return;if(((G==null?void 0:G.activeAppearance)||(G==null?void 0:G.appearance))==="dark"){const $n=((We=(se=G==null?void 0:G.colors)==null?void 0:se.neutral)==null?void 0:We.dark)||((Lt=(Ue=G==null?void 0:G.colors)==null?void 0:Ue.background)==null?void 0:Lt.light)||ql,Cn=lt($n||ql);if(Cn){const lr=Ct(Cn,gh);w.style.setProperty("--tile-base-bg",tt(Cn)),lr&&w.style.setProperty("--tile-hover-bg",tt(lr))}const qo=((He=(wt=G==null?void 0:G.colors)==null?void 0:wt.accent)==null?void 0:He.base)||((Ot=(ut=G==null?void 0:G.colors)==null?void 0:ut.accent)==null?void 0:Ot.light)||null,Lr=lt(qo);if(Lr){const lr=Ct(Lr,.22);w.style.setProperty("--tile-active-bg",tt(lr));const Si=lt((tn=G==null?void 0:G.text)==null?void 0:tn.primary),Wo=Z(Si,lr);Wo?w.style.setProperty("--tile-active-text",tt(Wo)):w.style.removeProperty("--tile-active-text")}else w.style.removeProperty("--tile-active-bg"),w.style.removeProperty("--tile-active-text");return}const I=((qn=(Fn=G==null?void 0:G.colors)==null?void 0:Fn.background)==null?void 0:qn.light)||((Rt=(ze=G==null?void 0:G.colors)==null?void 0:ze.background)==null?void 0:Rt.base)||((nn=(un=G==null?void 0:G.colors)==null?void 0:un.neutral)==null?void 0:nn.light)||Qa,D=((yi=(kn=G==null?void 0:G.colors)==null?void 0:kn.neutral)==null?void 0:yi.base)||((wi=(Qr=G==null?void 0:G.colors)==null?void 0:Qr.background)==null?void 0:wi.base)||Qa,B=lt(I)||lt(Qa),X=lt(D);let z=B;if(z&&X&&(z=Ie(z,X,.28)),z){w.style.setProperty("--tile-base-bg",tt(z));const $n=Ct(z,bh);$n&&w.style.setProperty("--tile-hover-bg",tt($n))}const V=((rn=(Wn=G==null?void 0:G.colors)==null?void 0:Wn.accent)==null?void 0:rn.light)||((eo=(xi=G==null?void 0:G.colors)==null?void 0:xi.accent)==null?void 0:eo.base)||null,xe=lt(V);if(xe){const $n=Ct(xe,.25),Cn=$n?Ie(xe,$n,.4):xe;w.style.setProperty("--tile-active-bg",tt(Cn));const qo=lt((vi=G==null?void 0:G.text)==null?void 0:vi.primary),Lr=Z(qo,Cn);Lr?w.style.setProperty("--tile-active-text",tt(Lr)):w.style.removeProperty("--tile-active-text")}else w.style.removeProperty("--tile-active-bg"),w.style.removeProperty("--tile-active-text")}function Re(){ue&&(ue.style.display="none",ue.setAttribute("aria-hidden","true")),Qt=null}function Ze(){var T,I;const w=(T=Qe==null?void 0:Qe.elements)==null?void 0:T.wrapper;if(!w)return null;if(!ue){ue=document.createElement("div"),ue.className="spawn-confirm",ue.setAttribute("role","dialog"),ue.setAttribute("aria-modal","false"),ue.setAttribute("aria-hidden","true"),ue.style.position="absolute",ue.style.display="none",ue.style.flexDirection="column",ue.style.gap="8px",ue.style.padding="12px 16px",ue.style.borderRadius="12px",ue.style.boxShadow="0 12px 24px rgba(0, 0, 0, 0.45)",ue.style.minWidth="150px";const D=document.createElement("p");D.dataset.role="spawn-question",D.style.margin="0",D.style.fontWeight="600",ue.appendChild(D);const B=document.createElement("div");B.style.display="flex",B.style.justifyContent="flex-end",B.style.gap="8px";const X=document.createElement("button");X.type="button",X.textContent="No",X.dataset.role="spawn-no";const z=document.createElement("button");z.type="button",z.textContent="Yes",z.dataset.role="spawn-yes",B.appendChild(X),B.appendChild(z),ue.appendChild(B),z.addEventListener("click",()=>{Qt&&Fe({x:Qt.x,y:Qt.y}),Re()}),X.addEventListener("click",()=>{Re()})}return ue.parentElement!==w&&((I=ue.parentElement)==null||I.removeChild(ue),w.appendChild(ue)),ue}function st(w){var V;const T=Ze();if(!T)return;const I=Q(w||{});if(!I)return;Qt={x:I.x,y:I.y};const D=T.querySelector('[data-role="spawn-question"]');D&&(D.textContent=I.relocated?`Water tile unavailable. Spawn at nearest land (${I.x}, ${I.y})?`:`Spawn here at (${I.x}, ${I.y})?`);const B=(V=Qe==null?void 0:Qe.elements)==null?void 0:V.wrapper;let X=(w==null?void 0:w.element)||null;if(I.relocated&&B){const xe=`[data-world-x="${I.x}"][data-world-y="${I.y}"]`,se=B.querySelector(xe);se&&(X=se)}if(B&&(X!=null&&X.getBoundingClientRect)){const xe=B.getBoundingClientRect(),se=X.getBoundingClientRect(),We=se.left-xe.left+se.width/2,Ue=se.top-xe.top+se.height/2;T.style.left=`${We}px`,T.style.top=`${Ue}px`}else T.style.left="50%",T.style.top="50%";T.style.transform="translate(-50%, -120%)",T.style.display="flex",T.setAttribute("aria-hidden","false");const z=T.querySelector('[data-role="spawn-yes"]');z&&(typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(()=>z.focus()):setTimeout(()=>z.focus(),0))}function re(w){if(!w)return null;const T=w.viewport||w,I=Math.max(1,Math.trunc((T==null?void 0:T.width)??Zr)),D=Math.max(1,Math.trunc((T==null?void 0:T.height)??$a)),B=Number.isFinite(T==null?void 0:T.xStart)?Math.trunc(T.xStart):Number.isFinite(w==null?void 0:w.xStart)?Math.trunc(w.xStart):0,X=Number.isFinite(T==null?void 0:T.yStart)?Math.trunc(T.yStart):Number.isFinite(w==null?void 0:w.yStart)?Math.trunc(w.yStart):0;return{x:B+Math.floor(I/2),y:X+Math.floor(D/2)}}function we(w,T={}){var V;if(!((V=w==null?void 0:w.types)!=null&&V.length))return null;const I=Number.isFinite(w.xStart)?Math.trunc(w.xStart):0,D=Number.isFinite(w.yStart)?Math.trunc(w.yStart):0,B=Math.trunc(T.x)-I,X=Math.trunc(T.y)-D;if(X<0||B<0)return null;const z=w.types[X];return!z||B>=z.length?null:z[B]}function ae(w,T={}){var xe;if(!((xe=w==null?void 0:w.types)!=null&&xe.length))return null;const I=Number.isFinite(w.xStart)?Math.trunc(w.xStart):0,D=Number.isFinite(w.yStart)?Math.trunc(w.yStart):0,B=w.types.length;if(!B)return null;const X=Number.isFinite(T==null?void 0:T.x)?Math.trunc(T.x):null,z=Number.isFinite(T==null?void 0:T.y)?Math.trunc(T.y):null;let V=null;for(let se=0;se<B;se+=1){const We=w.types[se];if(We)for(let Ue=0;Ue<We.length;Ue+=1){const Lt=We[Ue];if(Tn(Lt))continue;const wt=I+Ue,He=D+se,ut=X!==null?wt-X:wt,Ot=z!==null?He-z:He,tn=Math.hypot(ut,Ot);(!V||tn<V.distance||tn===V.distance&&(Math.abs(He)<Math.abs(V.y)||Math.abs(He)===Math.abs(V.y)&&Math.abs(wt)<Math.abs(V.x)))&&(V={x:wt,y:He,type:Lt,distance:tn})}}return V}function Q(w={}){var z;const T=Number.isFinite(w.x)?Math.trunc(w.x):null,I=Number.isFinite(w.y)?Math.trunc(w.y):null;if(T===null||I===null)return null;if(!((z=ot==null?void 0:ot.types)!=null&&z.length))return{x:T,y:I,terrain:null,relocated:!1};const D=we(ot,{x:T,y:I});if(D&&!Tn(D))return{x:T,y:I,terrain:D,relocated:!1};const B=ae(ot,{x:T,y:I});if(!B)return null;const X=B.type||we(ot,B);return{x:B.x,y:B.y,terrain:X||null,relocated:!0}}function Fe(w={},T={}){if(!w)return;const I=Q(w);I&&(dn={x:I.x,y:I.y},T.silent||Re(),he(),U())}function he(){if(!Qe||typeof Qe.setMarkers!="function")return;const w=dn?[{id:ir,x:dn.x,y:dn.y,icon:"",label:"Chosen spawn location",emphasis:!0}]:[];Qe.setMarkers(w)}function U(){if(Ge){if(!dn){Ge.hidden=!1,Ge.textContent="Click the map to choose your starting position.";return}Ge.textContent="",Ge.hidden=!0}}function oe(){!ot||!Qe||(Re(),Qe.setMap(ot,{biomeId:be,seed:(ot==null?void 0:ot.seed)??mt,season:(ot==null?void 0:ot.season)??kt}),he(),U())}function Ne(){if(!be||!Ye)return;const w=_l,T=_l,{xStart:I,yStart:D}=Ha(w,T);ot=Cr(be,mt,I,D,w,T,kt,void 0,void 0,ct,!1);const B=re(ot);B?Fe(B,{silent:!0}):(dn=null,he(),U()),oe()}function J(){var Fn,qn;const w=((Fn=Qe==null?void 0:Qe.elements)==null?void 0:Fn.stage)||((qn=Qe==null?void 0:Qe.elements)==null?void 0:qn.wrapper);if(!w)return;const T=w.querySelector('[data-role="legend-toggle"]');T!=null&&T.parentElement&&T.parentElement.removeChild(T);const I=w.querySelector('[data-role="map-legend-overlay"]');I!=null&&I.parentElement&&I.parentElement.removeChild(I);const D="setup-map-legend",B=document.createElement("div");B.className="map-legend-overlay",B.dataset.role="map-legend-overlay",B.id=D,B.hidden=!0,B.setAttribute("role","dialog"),B.setAttribute("aria-modal","true"),B.setAttribute("aria-label","Terrain legend"),B.setAttribute("aria-hidden","true"),B.tabIndex=-1;const X=document.createElement("div");X.className="map-legend-overlay__panel";const z=document.createElement("div");z.className="map-legend",z.dataset.role="map-legend",z.setAttribute("role","document"),z.tabIndex=-1;const V=document.createElement("button");V.type="button",V.className="map-legend__close",V.setAttribute("aria-label","Close terrain legend"),V.innerHTML='<span aria-hidden="true">×</span>',z.appendChild(V);const xe=document.createElement("div");xe.className="map-legend__list",xe.setAttribute("role","list"),qe.forEach(ze=>{const Rt=document.createElement("div");Rt.className="map-legend__item",Rt.setAttribute("role","listitem");const un=document.createElement("span");un.className="map-legend__swatch",ze.type&&(un.dataset.type=ze.type),Rt.appendChild(un);const nn=document.createElement("span");nn.className="map-legend__label",nn.textContent=ze.label,Rt.appendChild(nn),xe.appendChild(Rt)}),z.appendChild(xe),X.appendChild(z),B.appendChild(X);const se=document.createElement("button");se.type="button",se.className="map-legend-toggle",se.dataset.role="legend-toggle",se.setAttribute("aria-label","Show terrain legend"),se.setAttribute("aria-controls",D),se.setAttribute("aria-expanded","false"),se.setAttribute("aria-haspopup","dialog");const We=document.createElement("span");We.className="map-legend-toggle__icon",We.setAttribute("aria-hidden","true"),We.textContent="?",se.appendChild(We);const Ue=ze=>{se.setAttribute("aria-expanded",String(ze)),se.setAttribute("aria-label",ze?"Hide terrain legend":"Show terrain legend"),se.classList.toggle("is-active",ze),B.setAttribute("aria-hidden",String(!ze))},Lt=["button:not([disabled])","[href]","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(","),wt=()=>Array.from(B.querySelectorAll(Lt)).filter(ze=>ze.offsetParent!==null||ze.getClientRects().length>0||ze===document.activeElement),He=()=>{const ze=wt(),Rt=ze.length?ze[0]:B;requestAnimationFrame(()=>{Rt.focus()})},ut=()=>{B.hidden||(B.hidden=!0,Ue(!1),se.focus())},Ot=()=>{B.hidden&&(B.hidden=!1,Ue(!0),He())},tn=ze=>{ze&&ze.preventDefault(),B.hidden?Ot():ut()};se.addEventListener("click",tn),se.addEventListener("keydown",ze=>{(ze.key===" "||ze.key==="Enter")&&(ze.preventDefault(),tn(ze))}),V.addEventListener("click",()=>{ut()}),B.addEventListener("pointerdown",ze=>{ze.target===B&&(ze.preventDefault(),ut())}),B.addEventListener("keydown",ze=>{if(ze.key==="Escape"){ze.preventDefault(),ut();return}if(ze.key==="Tab"){const Rt=wt();if(!Rt.length){ze.preventDefault(),B.focus();return}const un=Rt[0],nn=Rt[Rt.length-1],kn=document.activeElement;ze.shiftKey?(kn===un||!B.contains(kn))&&(ze.preventDefault(),nn.focus()):kn===nn&&(ze.preventDefault(),un.focus())}}),w.appendChild(se),w.appendChild(B)}function ee(w){!w||!gt.has(w)||(gt.forEach((T,I)=>{const D=I===w;T.classList.toggle("is-active",D),T.setAttribute("aria-selected",String(D)),T.tabIndex=D?0:-1}),Le.forEach((T,I)=>{const D=I===w;T.hidden=!D,T.setAttribute("aria-hidden",String(!D))}),bt=w)}function Ce(){var I;if(!k||!E)return;const w=Ul.filter(D=>Array.isArray(D.parameters)&&D.parameters.length);gt.clear(),Le.clear(),qt.clear(),k.innerHTML="",E.innerHTML="",F&&(F.innerHTML="",[...no,{id:"custom",name:"Custom"}].forEach(B=>{const X=document.createElement("option");X.value=B.id;const z=hh[B.id];X.textContent=z?`${B.name} — ${z}`:B.name,F.appendChild(X)}),F.addEventListener("change",()=>{Ar(F.value)})),w.forEach(D=>{const B=`difficulty-tab-${D.id}`,X=`difficulty-panel-${D.id}`,z=document.createElement("button");z.type="button",z.className="difficulty-modal__tab",z.id=B,z.dataset.categoryId=D.id,z.setAttribute("role","tab"),z.setAttribute("aria-controls",X),z.setAttribute("aria-selected","false"),z.tabIndex=-1,z.textContent=D.label,z.addEventListener("click",()=>{ee(D.id),z.focus()}),z.addEventListener("keydown",xe=>{var We,Ue,Lt,wt;if(!w.length)return;const se=w.findIndex(He=>He.id===D.id);if(!(se<0)){if(xe.key==="ArrowRight"||xe.key==="ArrowDown"){xe.preventDefault();const He=w[(se+1)%w.length];ee(He.id),(We=gt.get(He.id))==null||We.focus()}else if(xe.key==="ArrowLeft"||xe.key==="ArrowUp"){xe.preventDefault();const He=w[(se-1+w.length)%w.length];ee(He.id),(Ue=gt.get(He.id))==null||Ue.focus()}else if(xe.key==="Home"){xe.preventDefault();const He=w[0];ee(He.id),(Lt=gt.get(He.id))==null||Lt.focus()}else if(xe.key==="End"){xe.preventDefault();const He=w[w.length-1];ee(He.id),(wt=gt.get(He.id))==null||wt.focus()}}});const V=document.createElement("div");V.id=X,V.className="difficulty-modal__panel",V.dataset.categoryId=D.id,V.setAttribute("role","tabpanel"),V.setAttribute("aria-labelledby",B),V.setAttribute("aria-hidden","true"),V.hidden=!0,D.parameters.forEach(xe=>{const se=Yt.get(xe);if(!se)return;const We=Do(se);We!=null&&We.element&&V.appendChild(We.element)}),k.appendChild(z),E.appendChild(V),gt.set(D.id,z),Le.set(D.id,V)});const T=bt&&gt.has(bt)&&bt||((I=w[0])==null?void 0:I.id)||null;T&&ee(T),F&&Ke&&(F.value=Ke)}function ke(){ye&&(ye.innerHTML="",pt.length=0,jl.forEach(w=>{const T=document.createElement("button");T.type="button",T.className="season-switch__button season-switch__button--icon",T.dataset.season=w.id;const I=w.label||w.id;I&&(T.setAttribute("aria-label",I),T.title=I),T.textContent=w.icon||I,T.addEventListener("click",()=>{Yn({season:w.id})}),pt.push(T),ye.appendChild(T)}))}function de(){K&&(K.innerHTML="",rt.length=0,qa.forEach(w=>{const T=document.createElement("button");T.type="button",T.className="tile col-4",T.dataset.biome=w.id,T.innerHTML=`
        <div class="tile__name">${w.name}</div>
        <div class="tile__desc">${w.description||""}</div>
      `,T.addEventListener("click",()=>{Yn({biome:w.id})}),rt.push(T),K.appendChild(T),$e(T)}))}ke(),de(),Ce(),Qe=cd(Ye,{legendLabels:yt,showControls:!0,showLegend:!1,idPrefix:"setup-map",useTerrainColors:!0,bufferMargin:8,minZoom:.4,fetchMap:({xStart:w,yStart:T,width:I,height:D,seed:B,season:X,viewport:z,skipSanityChecks:V})=>Cr(be,B??mt,w,T,I,D,X??kt,ot==null?void 0:ot.waterLevel,z,ct,!!V),onMapUpdate:w=>{ot={...w,worldSettings:w.worldSettings||ct},he(),U()},onTileClick:w=>{st(w)}}),J();let ge=null,le=null;const it=()=>h?typeof h.open=="boolean"?h.open:h.hasAttribute("open"):!1,en=()=>{ge==null||ge(),ge=null,g==null||g.setAttribute("aria-expanded","false");const w=le&&"focus"in le?le:g;w&&typeof w.focus=="function"&&w.focus(),le=null},sr=w=>{const T=I=>{if(I.key!=="Tab")return;const D=Vl(w);if(!D.length){I.preventDefault();return}const B=D[0],X=D[D.length-1],z=document.activeElement;I.shiftKey?(!w.contains(z)||z===B)&&(I.preventDefault(),X.focus()):(!w.contains(z)||z===X)&&(I.preventDefault(),B.focus())};return w.addEventListener("keydown",T),()=>{w.removeEventListener("keydown",T)}},_n=()=>{if(!h||!g||it())return;if(le=document.activeElement instanceof HTMLElement?document.activeElement:g,typeof h.showModal=="function")try{h.showModal()}catch{h.setAttribute("open","")}else h.setAttribute("open","");g.setAttribute("aria-expanded","true"),ge=sr(h),(Vl(h)[0]||b||h).focus()},De=()=>{if(!(!h||!it()))if(typeof h.close=="function")try{h.close()}catch{h.removeAttribute("open"),en()}else h.removeAttribute("open"),en()};g.addEventListener("click",()=>{it()?De():_n()}),b==null||b.addEventListener("click",()=>{De()}),h==null||h.addEventListener("cancel",w=>{w.preventDefault(),De()}),h==null||h.addEventListener("click",w=>{w.target===h&&De()}),h==null||h.addEventListener("close",en),S==null||S.addEventListener("click",()=>{const w=(F==null?void 0:F.value)||Ke||"custom";Ar(w),Ho(),Ln(),$o(),Bn()}),v==null||v.addEventListener("click",()=>{Yn({difficulty:Ke,worldParameters:En(ct)}),De()}),bi(be),Gt(kt),Nr(Ke),Fo(),$o(),Ln();function Fo(){var I;if(!ne)return;const w=Mr(be);if(!w){ne.textContent="";return}const T=(I=w.features)!=null&&I.length?`Features: ${w.features.join(", ")}.`:"";ne.textContent=`${w.name}${w.description?` – ${w.description}`:""} ${T}`.trim()}function $o(){var I;if(!A)return;if(!Ke){A.textContent="",g==null||g.setAttribute("aria-label","Difficulty");return}const w=Mi(Ke),T=((I=no.find(D=>D.id===Ke))==null?void 0:I.name)||(Ke==="custom"?"Custom":Ke);if(w!=null&&w.start){const{people:D=0,foodDays:B=0,firewoodDays:X=0}=w.start;A.textContent=`${T}: ${D} settlers, ${B} days of food, ${X} days of firewood.`}else A.textContent=T;g==null||g.setAttribute("aria-label",`Adjust difficulty (current: ${T})`)}function Ln(){if(!L)return;const w=Tu(ct);L.textContent=`Score: ${w}`,L.dataset.score=String(w)}function Bn(){vn&&clearTimeout(vn),vn=setTimeout(()=>{vn=null,Ne()},ar)}function Ho(){qt.forEach(w=>{const T=Yl(ct,w.path);w.update(T)})}function Ar(w,T={}){const{preserveWorld:I=!1,world:D}=T,B=Eo[w]?w:"custom";let X;D?X=En(D):B==="custom"&&I?X=En(ct):X=En(Mi(B).world);const z=xr(X);Ke=B,ct=z,F&&F.value!==B&&(F.value=B),Yn({difficulty:B,worldParameters:z})}function Io(w,T){const{def:I}=w,D=Ri(T,I.min,I.max),B=En(ct);Gl(B,I.path,D);const X=xr(B);ct=X,Ke="custom",F&&F.value!=="custom"&&(F.value="custom"),w.update(D),Yn({difficulty:"custom",worldParameters:X})}function Do(w){const T=Xl(w.path),I=document.createElement("div");I.className="difficulty-param";const D=document.createElement("div");D.className="difficulty-param__header";const B=document.createElement("label");B.className="difficulty-param__label";const X=`difficulty-slider-${T}`;B.setAttribute("for",X),B.textContent=w.label,w.hint&&(B.title=w.hint);const z=document.createElement("input");z.type="range",z.id=X,z.min=String(w.min),z.max=String(w.max),z.step=String(w.step??1),z.className="difficulty-param__slider range range__input";const V=document.createElement("div");V.className="difficulty-param__range",V.appendChild(z);const xe=document.createElement("output");xe.className="range__value",xe.setAttribute("for",X),xe.setAttribute("aria-live","polite");const se=document.createElement("div");se.className="difficulty-param__range-group",se.appendChild(V),se.appendChild(xe);let We=!1;const Ue={def:w,path:w.path,element:I,update(He){const ut=Ri(He,w.min,w.max),Ot=String(ut);We=!0,z.value=Ot,wt(ut),We=!1}},Lt=He=>{We||Io(Ue,He)},wt=He=>{const ut=Ri(He,w.min,w.max),Ot=w.max-w.min||1,tn=(ut-w.min)/Ot*100;z.style.setProperty("--range-progress",`${tn}%`),xe.textContent=String(ut)};return z.addEventListener("input",()=>{const He=Number(z.value);wt(He),Lt(He)}),D.appendChild(B),I.appendChild(D),I.appendChild(se),Ue.update(Yl(ct,w.path)),qt.set(Xl(w.path),Ue),Ue}function Oo(){const w=En(ai);return Wl.forEach(T=>{const I=T.max-T.min,D=T.min+Math.round(Math.random()*I);Gl(w,T.path,Ri(D,T.min,T.max))}),xr(w)}Ke||(Ke=(Ut==null?void 0:Ut.id)||"custom"),F&&(F.value=Ke),ys(()=>{rt.forEach($e)});function bi(w){const T=rt.find(I=>I.dataset.biome===w);T&&Pe(rt,T)}function Gt(w){const T=pt.find(I=>I.dataset.season===w);T&&Pe(pt,T)}function Nr(w){!F||!w||F.value!==w&&(F.value=w)}function zo(w){typeof w=="string"&&me.value!==w&&(me.value=w)}function Rn(w,T={}){const{immediate:I=!1}=T;Sn&&(clearTimeout(Sn),Sn=null);const D=typeof w=="string"?w.trim():String(w??"");if(I){const B=D||Fi();mt=B,me.value=B,Yn({seed:B});return}D&&(Sn=setTimeout(()=>{Sn=null,mt=D,Yn({seed:D})},Dt))}function Po(w={}){const{biome:T,season:I,difficulty:D,seed:B,worldParameters:X}=w;T&&(be=T,bi(T),Fo()),I&&(kt=I,Gt(I)),D&&(Ke=D,Nr(D)),typeof B=="string"&&B&&B!==mt&&(mt=B,zo(B)),X&&(ct=En(X),Ho()),$o(),Ln(),Bn()}uu(Po,{immediate:!0}),Yn({biome:be,season:kt,difficulty:Ke,seed:mt,worldParameters:ct},{force:!0}),me.addEventListener("input",()=>{const w=me.value;w.trim()&&Rn(w)}),me.addEventListener("change",()=>{Rn(me.value,{immediate:!0})}),me.addEventListener("keydown",w=>{w.key==="Enter"&&(w.preventDefault(),Rn(me.value,{immediate:!0}))}),Oe.addEventListener("click",()=>{Rn(Fi(),{immediate:!0})}),Ve.addEventListener("click",()=>{if(rt.length){const B=rt[Math.floor(Math.random()*rt.length)];be=B.dataset.biome,Pe(rt,B),Fo()}if(pt.length){const B=pt[Math.floor(Math.random()*pt.length)];kt=B.dataset.season,Pe(pt,B)}const w=[...no.map(B=>B.id),"custom"],T=w[Math.floor(Math.random()*w.length)];Ke=Eo[T]?T:"custom",Nr(Ke);let I;Ke==="custom"?I=Oo():I=En(Mi(Ke).world),ct=xr(I),Ho();const D=Fi();me.value=D,mt=D,Yn({biome:be,season:kt,difficulty:Ke,seed:D,worldParameters:ct})}),Se.addEventListener("click",()=>{const w=me.value.trim();w&&w!==mt&&Rn(w,{immediate:!0});const T=Mo();e({biome:T.biome||be,season:T.season||kt,difficulty:T.difficulty||Ke,seed:T.seed||mt,world:En(T.worldParameters||ct),spawn:dn?{...dn}:null})})}let Dr=1,pr=null,$i=null,Hi=null,gn=null,vt=null,Jn=null,Qn=null,ws=new Map,Co=null,ya=null,wa=null,Kl=!1,Ii=null;function Sh(e,t=""){return!e||typeof e!="string"?t:e.split("-").filter(Boolean).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")}function Ji(){const e=document.getElementById("content");e&&(e.style.transform=`scale(${Dr})`,e.style.transformOrigin="top left"),vd()}function xd(e=js()){ws.forEach((t,n)=>{const r=n===e;t.classList.toggle("active",r),t.setAttribute("aria-pressed",String(r))})}function kh(){mh(),xd()}function vd(){if(!Co)return;const e=Math.round(Dr*100);Co.textContent=`${e}%`,Co.setAttribute("aria-label",`Reset zoom to 100% (current ${e}%)`)}function Zl(e,t){const n=document.createElement("button");return n.type="button",n.textContent=e,n.setAttribute("aria-label",t),n.title=t,n.className="menu-trigger",n}function In(e,t,n){const r=document.createElement("button");r.type="button";const o=document.createElement("span");o.className="panel-icon",o.textContent=e;const i=document.createElement("span");return i.className="panel-label",i.textContent=t,r.append(o,i),typeof n=="function"&&r.addEventListener("click",n),{button:r,iconSpan:o,labelSpan:i}}function es(e,t,n){const r=document.createElement("button");return r.type="button",r.textContent=e,r.setAttribute("aria-label",t),r.title=t,r.classList.add("menu-icon-button"),typeof n=="function"&&r.addEventListener("click",n),r}function Kt(){gn&&(gn.classList.remove("open"),gn.setAttribute("aria-hidden","true")),vt&&(vt.classList.remove("open"),vt.setAttribute("aria-hidden","true")),Jn&&Jn.setAttribute("aria-expanded","false"),Qn&&Qn.setAttribute("aria-expanded","false")}function Jl(e,t){if(!e||!t)return;const n=e.classList.contains("open");Kt(),n||(e.classList.add("open"),e.setAttribute("aria-hidden","false"),t.setAttribute("aria-expanded","true"))}function Ch(e){pr&&(pr.contains(e.target)||Kt())}function Mh(e){e.key==="Escape"&&Kt()}function Sd(){return pr||(pr=document.createElement("div"),pr.className="menu-action-group",$i=document.createElement("div"),$i.className="menu-action",Jn=Zl("⚙️","Settings"),Jn.id="settings-btn",Jn.setAttribute("aria-expanded","false"),Jn.setAttribute("aria-haspopup","true"),Jn.addEventListener("click",e=>{e.stopPropagation(),Jl(gn,Jn)}),gn=document.createElement("div"),gn.className="menu-panel settings-panel",gn.setAttribute("aria-hidden","true"),$i.append(Jn,gn),Hi=document.createElement("div"),Hi.className="menu-action",Qn=Zl("☰","Game menu"),Qn.id="menu-btn",Qn.setAttribute("aria-expanded","false"),Qn.setAttribute("aria-haspopup","true"),Qn.addEventListener("click",e=>{e.stopPropagation(),Jl(vt,Qn)}),vt=document.createElement("div"),vt.id="dropdown-menu",vt.className="menu-panel menu-panel-list",vt.setAttribute("aria-hidden","true"),Hi.append(Qn,vt),pr.append($i,Hi),Kl||(document.addEventListener("click",Ch),document.addEventListener("keydown",Mh),Kl=!0),pr)}function Eh(){if(!gn)return;gn.innerHTML="",ws=new Map,Ii&&(Ii(),Ii=null);const e=document.createElement("div");e.className="theme-settings-section";const t=document.createElement("div");t.className="theme-contrast-toggle";const n=document.createElement("span");n.className="theme-contrast-toggle__label",n.textContent="Preview contrast";const r=document.createElement("div");r.className="theme-contrast-toggle__controls";const o=document.createElement("button");o.type="button",o.className="theme-contrast-toggle__btn",o.textContent="Light",o.setAttribute("aria-pressed","false");const i=document.createElement("button");i.type="button",i.className="theme-contrast-toggle__btn",i.textContent="Dark",i.setAttribute("aria-pressed","false"),r.append(o,i),t.append(n,r);const a=document.createElement("div");a.className="theme-toggle-grid",e.append(t,a),gn.appendChild(e),yd().forEach(p=>{var A,L,F;const h=document.createElement("button");h.type="button",h.className="theme-toggle-button",h.dataset.themeId=p.id,h.dataset.themeAppearance=p.appearance,h.setAttribute("aria-pressed","false");const g=((A=p.meta)==null?void 0:A.label)||Sh(p.id),b=g||((L=p.meta)==null?void 0:L.emoji)||p.id;h.setAttribute("aria-label",`Switch to ${b}`),h.title=b;const S=document.createElement("span");S.className="theme-toggle-button__icon",S.textContent=((F=p.meta)==null?void 0:F.emoji)||"",S.setAttribute("aria-hidden","true");const v=document.createElement("span");v.className="theme-toggle-button__label",v.textContent=g;const k=`linear-gradient(145deg, ${p.colors.primary.light}, ${p.colors.secondary.light})`,E=`linear-gradient(145deg, ${p.colors.primary.dark}, ${p.colors.secondary.dark})`;h.style.setProperty("--preview-bg-light",k),h.style.setProperty("--preview-bg-dark",E),h.style.setProperty("--preview-border-light",p.colors.primary.light),h.style.setProperty("--preview-border-dark",p.colors.primary.dark),h.style.setProperty("--preview-fg-light","#18202b"),h.style.setProperty("--preview-fg-dark","#f6f8ff"),h.style.setProperty("--preview-shadow-light","0 1px 1px rgba(255, 255, 255, 0.55)"),h.style.setProperty("--preview-shadow-dark","0 2px 8px rgba(0, 0, 0, 0.55)"),h.append(S,v),h.addEventListener("click",()=>{wd(p.id),Kt()}),a.appendChild(h),ws.set(p.id,h)});function l(p){const h=p==="light"?"light":"dark";a.dataset.contrast=h,o.classList.toggle("is-active",h==="light"),i.classList.toggle("is-active",h==="dark"),o.setAttribute("aria-pressed",String(h==="light")),i.setAttribute("aria-pressed",String(h==="dark"))}o.addEventListener("click",()=>{ba("light")}),i.addEventListener("click",()=>{ba("dark")}),l(ga()),Ii=ys((p=js(),h)=>{xd(p);const g=(h==null?void 0:h.activeAppearance)||ga();l(g)},{immediate:!0});const c=document.createElement("div");c.className="icon-row";const f=es("➖","Zoom out",()=>{Dr=Math.max(.5,Math.round((Dr-.1)*10)/10),Ji()});f.classList.add("zoom-button"),Co=es("100%","Reset zoom to 100%",()=>{Dr=1,Ji()}),Co.classList.add("zoom-display-button");const u=es("➕","Zoom in",()=>{Dr=Math.min(2,Math.round((Dr+.1)*10)/10),Ji()});u.classList.add("zoom-button"),c.append(f,Co,u),gn.appendChild(c),vd()}function Th(e,t,n,r,o,i,a,d,l,c){if(!vt)return;if(vt.innerHTML="",ya=null,wa=null,typeof t=="function"){const u=In("↩","Back",()=>{Kt(),t(),_s()});u.button.id="back-btn",u.button.style.display="none",vt.appendChild(u.button),ya=u.button}if(typeof e=="function"){const u=In("👷","Jobs",()=>{Kt(),e()});u.button.id="jobs-btn",vt.appendChild(u.button)}if(typeof d=="function"){const u=In("🧰","Craft Planner",()=>{Kt(),d()});u.button.id="craft-planner-btn",vt.appendChild(u.button)}if(typeof r=="function"){const u=In("🏗️","Construction",()=>{Kt(),r()});u.button.id="construction-btn",vt.appendChild(u.button),wa=u.button}if(typeof o=="function"){const u=In("🎒","Inventory",()=>{Kt(),o()});u.button.id="inventory-btn",vt.appendChild(u.button)}if(typeof l=="function"){const u=In("🌿","Herbarium",()=>{Kt(),l()});u.button.id="herbarium-btn",vt.appendChild(u.button)}if(typeof c=="function"){const u=In("🐾","Bestiary",()=>{Kt(),c()});u.button.id="bestiary-btn",vt.appendChild(u.button)}if(typeof i=="function"){const u=In("👤","Profile",()=>{Kt(),i()});u.button.id="profile-btn",vt.appendChild(u.button)}if(typeof a=="function"){const u=In("📜","Log",()=>{Kt(),a()});u.button.id="log-btn",vt.appendChild(u.button)}const f=In("🔄","New Game",()=>{Kt(),typeof n=="function"&&n()});f.button.id="reset-btn",vt.appendChild(f.button)}function Ah(e){if(!e)return;const t=Sd();t.parentElement!==e&&(t.parentElement&&t.parentElement.removeChild(t),e.appendChild(t))}function _s(e){ya&&(ya.style.display="none"),wa&&(wa.style.display="flex")}function Nh(e,t,n,r,o,i,a,d,l,c){const f=document.getElementById("top-menu");f&&(kh(),Sd(),Eh(),Th(e,t,n,r,o,i,a,d,l,c),f.innerHTML="",f.style.display="none",Ji())}function Lh(e){const t=document.getElementById("bottom-menu");t&&(t.innerHTML="",Object.assign(t.style,{position:"fixed",bottom:"0",left:"0",right:"0",background:"var(--menu-bg)",padding:"4px",display:"flex",justifyContent:"center",zIndex:"1000"}))}const ts=[{type:"iron ore",hardness:2},{type:"copper ore",hardness:2},{type:"tin ore",hardness:1},{type:"coal",hardness:1},{type:"silver ore",hardness:3}];function Bh(e){return e&&C.locations.get(e)||null}function Rh(e,t,n){var c;const r=e==null?void 0:e.map;if(!((c=r==null?void 0:r.types)!=null&&c.length))return null;const o=Number.isFinite(r.xStart)?Math.trunc(r.xStart):0,i=Number.isFinite(r.yStart)?Math.trunc(r.yStart):0,a=Math.trunc(t)-o,d=Math.trunc(n)-i;if(d<0||a<0)return null;const l=r.types[d];return!l||a>=l.length?null:l[a]}function Fh(e){var r;if(!e)return"open";const t=typeof((r=e.map)==null?void 0:r.openTerrainType)=="string"?e.map.openTerrainType:"";if(t)return t.toLowerCase();const n=Mr(e.biome)||null;return Nc(n)}function $h(e){return e.map||(e.map={}),(!e.map.resourceNodes||typeof e.map.resourceNodes!="object")&&(e.map.resourceNodes={}),e.map.resourceNodes}function Hh(e,t){return`${Math.trunc(e)}:${Math.trunc(t)}`}function Ih(e,t,n){const o=(e.map||{}).seed??`${e.id}`,i=Mr(e.biome)||{},a=Ao(o,t,n,"forest-density"),d=Ao(o,t,n,"forest-sizes"),l=Number.isFinite(i.woodMod)?i.woodMod:1,c=3+Math.round(a*5),f=Math.max(1,Math.round(c*l)),u=Math.min(.4,d*.4),p=Math.min(.5,.3+d*.3),h=Math.max(0,Math.round(f*u)),g=Math.max(0,Math.round(f*p));return{type:"forest",trees:{small:Math.max(0,f-h-g),medium:g,large:h},stockpiles:{"small logs":0,"medium logs":0,"large logs":0,firewood:0,planks:0,"building lumber":0}}}function Dh(e,t,n,r=0){const o=Ao(e,t+r,n-r,`ore-type-${r}`),i=Math.floor(o*ts.length)%ts.length;return ts[Math.max(0,i)]}function Oh(e,t,n){const o=(e.map||{}).seed??`${e.id}`,i=Ao(o,t,n,"ore-richness"),a=i>.8?3:i>.55?2:1,d=[];for(let c=0;c<a;c+=1){const f=Dh(o,t,n,c+1),u=Ao(o,t-c,n+c,`ore-qty-${c}`),p=Math.max(1,Math.round(3+u*5));d.push({type:f.type,quantity:p,hardness:f.hardness})}const l=Math.max(2,Math.round(4+i*6));return{type:"ore",deposits:d,stone:l,stockpiles:{stone:0}}}function zh(e,t,n,r){const o=$h(e),i=Hh(t,n);if(o[i])r==="forest"&&(o[i].trees||(o[i].trees={small:0,medium:0,large:0}));else if(r==="forest")o[i]=Ih(e,t,n);else if(r==="ore")o[i]=Oh(e,t,n);else{const a=r&&r!=="open"?r:Fh(e);o[i]={type:a}}return(!o[i].stockpiles||typeof o[i].stockpiles!="object")&&(o[i].stockpiles={}),o[i]}function Ph(e,t,n){const r=Bh(e);if(!r)return null;const o=Rh(r,t,n),i=zh(r,t,n,o);return i?{...i,trees:{...i.trees||{}},stockpiles:{...i.stockpiles||{}}}:null}function qs(){Array.isArray(C.orders)||(C.orders=[]),typeof C.orderSeq!="number"&&(C.orderSeq=0)}function jh(){return qs(),C.orderSeq+=1,`ord-${C.orderSeq}`}function _h(){return qs(),C.orders.map(e=>({...e}))}function qh({type:e,workers:t=1,hours:n=4,notes:r="",metadata:o=null}){qs();const a={id:jh(),type:e,workers:Math.max(1,Math.floor(t)),durationHours:Math.max(1,Math.ceil(n)),remainingHours:Math.max(1,Math.ceil(n)),notes:r,status:"pending",metadata:o||null};return C.orders.push(a),{...a}}function Wh(){C.orders=[],C.orderSeq=0}const xs={wood:{icon:"🪵",label:"Wood"},firewood:{icon:"🪵",label:"Firewood"},food:{icon:"🍲",label:"Food Rations"},hides:{icon:"🦬",label:"Animal Hides"},"small stones":{icon:"🪨",label:"Small Stones"},pebbles:{icon:"⚪",label:"Pebbles"},"crafted goods":{icon:"🧰",label:"Crafted Goods"},"construction progress":{icon:"🏗️",label:"Construction Progress"},preservedFood:{icon:"🥫",label:"Preserved Food"},cookedMeals:{icon:"🍖",label:"Cooked Meals"},hidesPrepared:{icon:"🧵",label:"Prepared Hides"},mushrooms:{icon:"🍄",label:"Mushrooms"},herbs:{icon:"🌿",label:"Wild Herbs"},berries:{icon:"🍓",label:"Wild Berries"},pinecones:{icon:"🌰",label:"Pinecones"},"plant fibers":{icon:"🌾",label:"Plant Fibers"},water:{icon:"💧",label:"Water"},grain:{icon:"🌾",label:"Grain"},"root vegetables":{icon:"🥕",label:"Root Vegetables"},salt:{icon:"🧂",label:"Salt"},spices:{icon:"🧄",label:"Spices"},feathers:{icon:"🪶",label:"Feathers"},"animal fat":{icon:"🧈",label:"Animal Fat"},milk:{icon:"🥛",label:"Milk"},cord:{icon:"🪢",label:"Cord"},"sharpened stone":{icon:"🗡️",label:"Sharpened Stone"},"straight branch":{icon:"🌿",label:"Straight Branch"},"sturdy haft stick":{icon:"🥢",label:"Sturdy Haft Stick"},"seasoned wood":{icon:"🪑",label:"Seasoned Wood"},"prepared hides":{icon:"🧵",label:"Prepared Hides"},"raw ore":{icon:"⛏️",label:"Raw Ore"},"bronze ingot":{icon:"🔶",label:"Bronze Ingot"},"iron ingot":{icon:"⛓️",label:"Iron Ingot"},"steel ingot":{icon:"⚙️",label:"Steel Ingot"},charcoal:{icon:"⬛",label:"Charcoal"},clay:{icon:"🧱",label:"Clay"},"rendered tallow":{icon:"🕯️",label:"Rendered Tallow"},"ground flour":{icon:"🥣",label:"Ground Flour"},"hearty meal":{icon:"🍲",label:"Hearty Meal"},"bone broth":{icon:"🍜",label:"Bone Broth"},"traveler's bread":{icon:"🥖",label:"Traveler's Bread"},"comfort meal":{icon:"🥣",label:"Comfort Meal"},"smoked provisions":{icon:"🥩",label:"Smoked Provisions"},"preserved vegetables":{icon:"🥬",label:"Preserved Vegetables"},seeds:{icon:"🌱",label:"Seeds"},"aromatic sachet":{icon:"🪷",label:"Aromatic Sachet"},"herbal poultice":{icon:"🩹",label:"Herbal Poultice"},"restorative tonic":{icon:"🧪",label:"Restorative Tonic"},"soothing salve":{icon:"💧",label:"Soothing Salve"}};hu().forEach(e=>{const t=xs[e.id]||{};xs[e.id]={icon:e.icon||t.icon||"🎒",label:e.label||t.label||e.id}});function hi(e){if(!e)return null;const t=xs[e];if(t)return t;const n=Ta(e);return n?{icon:n.icon,label:n.label}:null}function za(e){if(!e)return"";const t=hi(e);return t!=null&&t.label?t.label:typeof e=="string"&&e.trim()?e.split(/\s+/).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" "):""}const Uh=4200,Di={open:1,forest:1.7,ore:1.3,stone:1.4,water:4,ocean:4.2,lake:4,river:3.8,marsh:2.8,mangrove:3.1,default:1.25};function Ql(e){if(!e)return Di.default;const t=typeof e=="string"?e.toLowerCase():"";return wr(t)?Di.open:Di[t]??Di.default}function ec(e,t,n){return Number.isFinite(e)?Math.max(t,Math.min(n,e)):t}function Yh({fromTerrain:e="open",toTerrain:t="open",distance:n=To,swimmingLevel:r=1}={}){const o=Math.max(1,Number.isFinite(n)?n:To),i=Ql(e),a=Ql(t);let d=(i+a)/2,l=!1,c="";if(Tn(t)||Tn(e)){const u=ec(r,1,100);if(u<8)l=!0,c="The current is too strong to cross without better swimming skill.";else{const p=ec(3.5-u/25,1.5,3.5);d*=p,u<25&&(c="Crossing the water is slow and exhausting.")}}return{hours:o/Uh*d,blocked:l,reason:c,distance:o,multiplier:d}}function tc(e){const t=typeof e=="string"?e.toLowerCase():"";if(wr(t))return"Gentle terrain allows steady progress.";switch(t){case"forest":return"Dense canopy and underbrush slow travel.";case"ore":return"Rocky outcrops require careful footing.";case"stone":return"Jagged stone forces a cautious pace.";case"water":case"lake":case"ocean":return"Requires swimming or a boat to cross safely.";case"river":return"Swift currents complicate fording attempts.";case"marsh":return"Slogging through wetlands is slow and exhausting.";case"mangrove":return"Dense roots and tidal pools demand careful, time-consuming steps.";default:return"Gentle terrain allows steady progress."}}function kd(e="",{fallback:t=""}={}){const n=String(e??"").trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");return n||t}function Cd(e,t=""){return typeof e!="string"?t:e.trim().toLowerCase()||t}function Gh(e,t){const n=Cd(e);return!n||!t?!1:n===t?!0:n==="open"||n==="meadow"?wr(t):wr(n)&&wr(t)?n===t:!1}const Xh={Thawbound:2,Sunheight:3,Emberwane:3,Frostshroud:2},Qi=["water","river","lake","marsh","ocean","mangrove"],Vh=[{name:"Rowan",habitats:["forest"],encounterName:"storm-felled rowan limb",successSuffix:"from a storm-felled rowan branch ideal for hafting tools."},{name:"Buttonwood",habitats:Qi,encounterName:"salt-hardened buttonwood branch",successSuffix:"from the tide-smoothed buttonwood branch, tough enough for sturdy grips."},{name:"Carob",habitats:["forest","open"],encounterName:"fallen carob limb",successSuffix:"after trimming a dense carob branch suited for tool hafts."}],Md=Vh.map(e=>{const t=kd(e.name,{fallback:"tree"}),n=e.name.toLowerCase(),r=`sturdy ${n} stick`;return{id:`sturdy-stick-${t}`,resource:r,singularName:r,encounterName:e.encounterName||`fallen ${n} branch`,type:"loose",habitats:Array.isArray(e.habitats)&&e.habitats.length?[...e.habitats]:["forest"],baseWeight:Number.isFinite(e.baseWeight)?e.baseWeight:2,seasonWeights:{...Xh,...e.seasonWeights||{}},minQuantity:Number.isFinite(e.minQuantity)?e.minQuantity:1,maxQuantity:Number.isFinite(e.maxQuantity)?e.maxQuantity:2,timePerUnit:Number.isFinite(e.timePerUnit)?e.timePerUnit:.35,respawnHours:Number.isFinite(e.respawnHours)?e.respawnHours:16,successSuffix:typeof e.successSuffix=="string"?e.successSuffix:`from a resilient ${n} branch ready to be carved into handles.`,blockedVerb:"gather"}}),Kh=[{id:"forest-mushrooms",resource:"mushrooms",singularName:"mushroom",encounterName:"cluster of mushrooms",type:"loose",habitats:["forest"],baseWeight:3,seasonWeights:{Thawbound:4,Sunheight:2,Emberwane:5,Frostshroud:1},minQuantity:1,maxQuantity:4,timePerUnit:.15,respawnHours:20,successSuffix:"from the forest floor."},{id:"forest-firewood",resource:"firewood",singularName:"bundle of firewood",encounterName:"fallen branches",type:"loose",habitats:["forest"],baseWeight:3,seasonWeights:{Thawbound:3,Sunheight:3,Emberwane:3,Frostshroud:2},minQuantity:1,maxQuantity:3,timePerUnit:.25,respawnHours:12,successSuffix:"from the surrounding forest."},{id:"forest-pinecones",resource:"pinecones",singularName:"pinecone",encounterName:"scatter of pinecones",type:"loose",habitats:["forest"],baseWeight:2,seasonWeights:{Thawbound:2,Sunheight:3,Emberwane:3,Frostshroud:1},minQuantity:2,maxQuantity:6,timePerUnit:.05,respawnHours:10,successSuffix:"from beneath the conifers."},{id:"forest-herbs",resource:"herbs",singularName:"bundle of herbs",encounterName:"patch of herbs",type:"loose",habitats:["forest"],baseWeight:2,seasonWeights:{Thawbound:2,Sunheight:3,Emberwane:4,Frostshroud:1},minQuantity:1,maxQuantity:3,timePerUnit:.2,respawnHours:18,successSuffix:"from a shaded glade."},{id:"forest-spices",resource:"spices",singularName:"handful of aromatic bark",encounterName:"clump of spice bark",type:"loose",habitats:["forest"],baseWeight:1.5,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:3,Frostshroud:1},minQuantity:1,maxQuantity:2,timePerUnit:.22,respawnHours:36,successSuffix:"by shaving fragrant bark and seed pods."},{id:"open-fibers",resource:"plant fibers",singularName:"bundle of plant fibers",encounterName:"tough meadow grasses",type:"loose",habitats:["open"],baseWeight:3,seasonWeights:{Thawbound:2,Sunheight:4,Emberwane:3,Frostshroud:1},minQuantity:1,maxQuantity:4,timePerUnit:.2,respawnHours:16,successSuffix:"by stripping tough grasses."},{id:"straight-saplings",resource:"straight branch",singularName:"straight branch",encounterName:"stand of straight saplings",type:"loose",habitats:["open","forest"],baseWeight:2.5,seasonWeights:{Thawbound:2,Sunheight:3,Emberwane:3,Frostshroud:2},minQuantity:1,maxQuantity:3,timePerUnit:.18,respawnHours:18,successSuffix:"after trimming a straight sapling for tool shafts."},{id:"open-berries",resource:"berries",singularName:"handful of berries",encounterName:"tangle of blackberries",type:"harvest",habitats:["open","forest"],baseWeight:2,seasonWeights:{Thawbound:0,Sunheight:4,Emberwane:5,Frostshroud:1},minQuantity:3,maxQuantity:8,timePerUnit:.18,respawnHours:48,successSuffix:"from a tangled bramble.",blockedVerb:"harvest"},{id:"meadow-grain",resource:"grain",singularName:"sheaf of grain",encounterName:"patch of wild grain",type:"harvest",habitats:["meadow","open"],baseWeight:2,seasonWeights:{Thawbound:0,Sunheight:3,Emberwane:4,Frostshroud:1},minQuantity:2,maxQuantity:5,timePerUnit:.25,respawnHours:36,successSuffix:"from the ripened heads of wild grain.",blockedVerb:"harvest"},{id:"meadow-root-vegetables",resource:"root vegetables",singularName:"bundle of root vegetables",encounterName:"cluster of wild tubers",type:"harvest",habitats:["meadow","open"],baseWeight:2,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:3,Frostshroud:1},minQuantity:2,maxQuantity:4,timePerUnit:.28,respawnHours:40,successSuffix:"after digging up hearty tubers.",blockedVerb:"dig"},{id:"open-stones",resource:"small stones",singularName:"small stone",encounterName:"scatter of stones",type:"loose",habitats:["open","ore"],baseWeight:3,seasonWeights:{Thawbound:3,Sunheight:3,Emberwane:3,Frostshroud:2},minQuantity:2,maxQuantity:5,timePerUnit:.08,respawnHours:8,successSuffix:"from the ground."},{id:"shore-driftwood",resource:"firewood",singularName:"driftwood log",encounterName:"driftwood",type:"loose",habitats:Qi,baseWeight:2,seasonWeights:{Thawbound:2,Sunheight:2,Emberwane:3,Frostshroud:2},minQuantity:1,maxQuantity:3,timePerUnit:.22,respawnHours:14,successSuffix:"washed up along the shore."},{id:"shore-herbs",resource:"herbs",singularName:"bundle of shoreline herbs",encounterName:"stand of shoreline herbs",type:"loose",habitats:Qi,baseWeight:1,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:3,Frostshroud:1},minQuantity:1,maxQuantity:2,timePerUnit:.18,respawnHours:20,successSuffix:"from the marshy banks."},{id:"shore-salt-crust",resource:"salt",singularName:"chunk of salt crust",encounterName:"salt-encrusted tide pool",type:"harvest",habitats:Qi,baseWeight:1,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:2,Frostshroud:1},minQuantity:1,maxQuantity:3,timePerUnit:.3,respawnHours:30,successSuffix:"by scraping salt crust from a receding tide pool.",blockedVerb:"scrape"},{id:"forest-log",resource:"firewood",singularName:"length of timber",encounterName:"fallen log",type:"harvest",habitats:["forest"],baseWeight:1.5,seasonWeights:{Thawbound:2,Sunheight:2,Emberwane:2,Frostshroud:1},minQuantity:3,maxQuantity:6,timePerUnit:.35,respawnHours:72,toolsRequired:["stone hand axe"],successSuffix:"after chopping apart a fallen log.",blockedVerb:"fell"},{id:"forest-carcass",resource:"animal fat",singularName:"lump of animal fat",encounterName:"fresh carcass scraps",type:"harvest",habitats:["forest"],baseWeight:1,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:2,Frostshroud:1},minQuantity:1,maxQuantity:2,timePerUnit:.35,respawnHours:42,toolsRequired:["stone knife"],successSuffix:"after carefully trimming usable fats from a carcass.",blockedVerb:"render"},{id:"meadow-feathers",resource:"feathers",singularName:"bundle of feathers",encounterName:"scatter of molted feathers",type:"loose",habitats:["meadow","open"],baseWeight:2,seasonWeights:{Thawbound:1,Sunheight:2,Emberwane:3,Frostshroud:1},minQuantity:2,maxQuantity:6,timePerUnit:.12,respawnHours:18,successSuffix:"gathered from nesting grounds."},{id:"ore-vein",resource:"raw ore",singularName:"chunk of raw ore",encounterName:"vein of ore",type:"harvest",habitats:["ore"],baseWeight:1.2,seasonWeights:{Thawbound:2,Sunheight:2,Emberwane:2,Frostshroud:2},minQuantity:1,maxQuantity:2,timePerUnit:1.5,respawnHours:0,toolsRequired:["stone hand axe","wooden hammer"],successSuffix:"from the exposed vein.",blockedVerb:"mine"}],Zh=[...Kh,...Md],nc=new Map;function Jh(e,t){const n=Cd(e,t);if(!n)return[];const r=nc.get(n);if(r)return r;const o=Zh.filter(i=>Array.isArray(i.habitats)&&i.habitats.some(a=>Gh(a,n)));return nc.set(n,o),o}function Qh(e){const t=Jh(e);return t.length?t.map(n=>({id:n.id,resource:n.resource,encounterName:n.encounterName||n.resource,type:n.type,toolsRequired:Array.isArray(n.toolsRequired)?[...n.toolsRequired]:[]})):[]}const eg=Md.map(e=>e.resource);function Gn(e,t={}){const{effect:n={},...r}=t||{},o=e.effect||{},i={inputMultiplier:n.inputMultiplier??o.inputMultiplier??1,outputMultiplier:n.outputMultiplier??o.outputMultiplier??1,laborMultiplier:n.laborMultiplier??o.laborMultiplier??1,timeMultiplier:n.timeMultiplier??o.timeMultiplier??1,batchBonus:n.batchBonus??o.batchBonus??0};return{...e,...r,effect:i}}const ve={handCraft:e=>Gn({id:"manual",label:"Hand Crafting",type:"manual",priority:0,effect:{inputMultiplier:1,outputMultiplier:.75,laborMultiplier:1.25,timeMultiplier:1.15,batchBonus:0}},e),handCook:e=>Gn({id:"manual-cook",label:"Improvised Cooking",type:"manual",priority:0,effect:{inputMultiplier:1,outputMultiplier:.65,laborMultiplier:1.3,timeMultiplier:1.25,batchBonus:0}},e),workshopBench:e=>Gn({id:"workshop-bench",label:"Workshop Benches",type:"building",building:"workshop",priority:18,effect:{inputMultiplier:1,outputMultiplier:1.15,laborMultiplier:.85,timeMultiplier:.9,batchBonus:0}},e),workshopForge:e=>Gn({id:"workshop-forge",label:"Workshop Forge",type:"building",building:"workshop",priority:22,effect:{inputMultiplier:1,outputMultiplier:1.2,laborMultiplier:.8,timeMultiplier:.85,batchBonus:0}},e),steelForge:e=>Gn({id:"steel-forge",label:"Refined Forge",type:"building",building:"workshop",priority:24,effect:{inputMultiplier:1,outputMultiplier:1.25,laborMultiplier:.75,timeMultiplier:.85,batchBonus:0}},e),firePit:e=>Gn({id:"fire-pit",label:"Fire Pit Hearth",type:"building",building:"fire-pit",priority:20,effect:{inputMultiplier:1,outputMultiplier:1.25,laborMultiplier:.9,timeMultiplier:.8,batchBonus:0}},e),longhouseHearth:e=>Gn({id:"longhouse-hearth",label:"Longhouse Hearth",type:"building",building:"longhouse",priority:16,effect:{inputMultiplier:1,outputMultiplier:1.18,laborMultiplier:.9,timeMultiplier:.85,batchBonus:0}},e),dryingRack:e=>Gn({id:"drying-rack",label:"Drying Rack",type:"building",building:"drying-rack",priority:14,effect:{inputMultiplier:.95,outputMultiplier:1.1,laborMultiplier:.95,timeMultiplier:.85,batchBonus:0}},e),smokehouse:e=>Gn({id:"smokehouse",label:"Smokehouse",type:"building",building:"smokehouse",priority:22,effect:{inputMultiplier:.9,outputMultiplier:1.35,laborMultiplier:.85,timeMultiplier:.9,batchBonus:0}},e)},Ed=[{id:"intermediate",label:"Intermediate Materials",recipes:[{id:"cord",name:"Cord",icon:"🪢",description:"Twist pliable fibers into sturdy cord for lashings and traps.",category:"intermediate",inputs:{"plant fibers":3},outputs:{cord:1},laborHours:.5,timeHours:.5,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:5,label:"lengths"},production:[ve.handCraft(),ve.workshopBench()]},{id:"sharpened-stone",name:"Sharpened Stone",icon:"🗡️",description:"Shape a keen stone edge for scraping hides or cutting cords.",category:"intermediate",inputs:{"small stones":1},outputs:{"sharpened stone":1},laborHours:.25,timeHours:.25,tools:["wooden hammer"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:6,label:"blanks"},production:[ve.handCraft(),ve.workshopBench()]},{id:"prepared-hides",name:"Prepared Hides",icon:"🧵",description:"Scrape, cure, and soften hides for armor and advanced crafting.",category:"intermediate",inputs:{hides:1,herbs:1,"plant fibers":1},outputs:{"prepared hides":1},laborHours:2.5,timeHours:6,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:2,label:"hides"},production:[ve.handCraft(),ve.dryingRack()]},{id:"seasoned-wood",name:"Seasoned Wood",icon:"🪑",description:"Air-dry select timber into balanced hafts and bow staves.",category:"intermediate",inputs:{firewood:3},outputs:{"seasoned wood":1},laborHours:1,timeHours:24,tools:["stone hand axe"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"bundles"},production:[ve.handCraft({label:"Open-Air Seasoning",effect:{outputMultiplier:.7,laborMultiplier:1.3}}),ve.workshopBench({label:"Workshop Racks"})]},{id:"rendered-tallow",name:"Rendered Tallow",icon:"🕯️",description:"Slowly clarify animal fats into clean-burning tallow cakes.",category:"intermediate",inputs:{"animal fat":3,firewood:1,salt:1},outputs:{"rendered tallow":2},laborHours:1.5,timeHours:4,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"batches"},production:[ve.handCook({label:"Camp Rendering",effect:{outputMultiplier:.7,laborMultiplier:1.25,timeMultiplier:1.2}}),ve.firePit()]},{id:"grain-flour",name:"Ground Flour",icon:"🥣",description:"Crush grains into coarse flour suitable for breads and porridges.",category:"intermediate",inputs:{grain:3,"small stones":1},outputs:{"ground flour":3},laborHours:1,timeHours:1,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:4,label:"sacks"},production:[ve.handCraft({label:"Hand Milling",effect:{outputMultiplier:.8,laborMultiplier:1.2}}),ve.workshopBench({label:"Quern Bench"})]},{id:"bronze-ingot",name:"Smelt Bronze Ingot",icon:"🔶",description:"Smelt raw ore in clay crucibles to pour balanced bronze ingots.",category:"intermediate",inputs:{"raw ore":3,firewood:2},outputs:{"bronze ingot":1},laborHours:6,timeHours:8,tools:["wooden hammer"],unlock:{technologies:["bronze-smithing"]},batch:{defaultSize:1,maxSize:2,label:"ingots"},production:[ve.workshopForge()]},{id:"iron-ingot",name:"Smelt Iron Ingot",icon:"⛓️",description:"Roast ore and hammer blooms into workable iron ingots.",category:"intermediate",inputs:{"raw ore":4,firewood:3},outputs:{"iron ingot":1},laborHours:8,timeHours:12,tools:["wooden hammer"],unlock:{technologies:["iron-smithing"]},batch:{defaultSize:1,maxSize:2,label:"ingots"},production:[ve.workshopForge({label:"Bloomery Forge",effect:{outputMultiplier:1.22,laborMultiplier:.78}})]},{id:"steel-ingot",name:"Forge Steel Ingot",icon:"⚙️",description:"Carburize iron with additional ore to forge high-grade steel.",category:"intermediate",inputs:{"iron ingot":1,"raw ore":3,"seasoned wood":1},outputs:{"steel ingot":1},laborHours:10,timeHours:16,tools:["wooden hammer"],unlock:{technologies:["steel-smithing"]},batch:{defaultSize:1,maxSize:2,label:"ingots"},production:[ve.steelForge()]}]},{id:"meals",label:"Cooked Meals",recipes:[{id:"hearty-stew",name:"Hearty Stew",icon:"🍲",description:"Simmer grains, vegetables, and meat into a filling communal stew.",category:"meals",inputs:{grain:2,"root vegetables":3,food:2,herbs:1,salt:1},outputs:{"hearty meal":3,"bone broth":1},laborHours:2.5,timeHours:3,tools:["stone knife","wooden hammer"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"pots"},production:[ve.handCook({effect:{outputMultiplier:.6,laborMultiplier:1.35}}),ve.firePit(),ve.longhouseHearth({label:"Longhouse Cauldrons",effect:{outputMultiplier:1.35,laborMultiplier:.8,timeMultiplier:.75}})]},{id:"traveler-flatbread",name:"Traveler Flatbread",icon:"🥖",description:"Bake dense flatbreads that travel well for scouting parties.",category:"meals",inputs:{"ground flour":3,salt:1,"rendered tallow":1},outputs:{"traveler's bread":4},laborHours:1.5,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"rounds"},production:[ve.handCook({label:"Hearthstones",effect:{outputMultiplier:.7,laborMultiplier:1.25}}),ve.firePit()]},{id:"herbal-porridge",name:"Herbal Porridge",icon:"🥣",description:"Blend grains, berries, and herbs into a soothing morning porridge.",category:"meals",inputs:{grain:2,berries:2,herbs:1,spices:1},outputs:{"comfort meal":3},laborHours:1,timeHours:1.5,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"bowls"},production:[ve.handCook({effect:{outputMultiplier:.7}}),ve.firePit()]}]},{id:"preserves",label:"Preserves & Stores",recipes:[{id:"smoke-cured-provisions",name:"Smoke-cured Provisions",icon:"🥩",description:"Salt and smoke cuts of meat for durable expedition rations.",category:"preserves",inputs:{food:4,salt:2,spices:1,firewood:2},outputs:{"smoked provisions":3},laborHours:3,timeHours:6,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"hooks"},production:[ve.handCook({label:"Makeshift Smoke",effect:{outputMultiplier:.6,laborMultiplier:1.4}}),ve.dryingRack(),ve.smokehouse()]},{id:"pickled-vegetables",name:"Pickled Vegetables",icon:"🥬",description:"Pack roots with herbs and salt into lasting pickled stores.",category:"preserves",inputs:{"root vegetables":4,salt:1,herbs:1,"crafted goods":1},outputs:{"preserved vegetables":4},laborHours:2,timeHours:4,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:2,maxSize:4,label:"jars"},production:[ve.handCraft({label:"Earthen Crocks",effect:{outputMultiplier:.8,laborMultiplier:1.2}}),ve.workshopBench({label:"Workshop Brining"})]},{id:"aromatic-sachets",name:"Aromatic Sachets",icon:"🪷",description:"Dry herbs and spices into sachets that deter pests from stores.",category:"preserves",inputs:{herbs:3,spices:2,"plant fibers":2},outputs:{"aromatic sachet":3},laborHours:1,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:4,label:"sachets"},production:[ve.handCraft({label:"Sun-dried Bundles"}),ve.dryingRack(),ve.workshopBench({label:"Workshop Infusers",effect:{outputMultiplier:1.2,laborMultiplier:.8}})]}]},{id:"remedies",label:"Herbal Remedies",recipes:[{id:"herbal-poultice",name:"Herbal Poultice",icon:"🩹",description:"Mash herbs into soothing poultices that speed recovery.",category:"remedies",inputs:{herbs:3,"plant fibers":2,"animal fat":1},outputs:{"herbal poultice":2},laborHours:1.5,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"wraps"},production:[ve.handCraft({label:"Field Dressing"}),ve.dryingRack(),ve.workshopBench({label:"Workshop Apothecary",effect:{outputMultiplier:1.25,laborMultiplier:.85}})]},{id:"restorative-tonic",name:"Restorative Tonic",icon:"🧪",description:"Brew concentrated herbal tonics to bolster the infirm.",category:"remedies",inputs:{herbs:2,berries:2,spices:1,salt:1},outputs:{"restorative tonic":2},laborHours:2,timeHours:3,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"bottles"},production:[ve.handCook({label:"Camp Brew",effect:{outputMultiplier:.7}}),ve.firePit({label:"Hearth Decoction"}),ve.workshopBench({label:"Workshop Still",effect:{outputMultiplier:1.25,laborMultiplier:.85}})]},{id:"soothing-salve",name:"Soothing Salve",icon:"💧",description:"Blend tallow and herbs into salves that stave off infection.",category:"remedies",inputs:{"rendered tallow":2,herbs:2,spices:1},outputs:{"soothing salve":3},laborHours:1.5,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"pots"},production:[ve.handCraft({label:"Palm Mixing"}),ve.workshopBench({label:"Workshop Mortars",effect:{outputMultiplier:1.2,laborMultiplier:.85}})]}]},{id:"ammunition",label:"Ammunition & Weaponry",recipes:[{id:"arrow-bundle",name:"Arrow Bundle",icon:"🏹",description:"Carve, fletch, and bundle arrows for ranged hunters.",category:"ammunition",inputs:{"seasoned wood":1,"plant fibers":2,"sharpened stone":2,feathers:4},outputs:{"wooden arrow":6},laborHours:2,timeHours:2,tools:["stone knife"],unlock:{technologies:["basic-tools"]},batch:{defaultSize:1,maxSize:3,label:"bundles"},production:[ve.handCraft({label:"Trail Fletching",effect:{outputMultiplier:.8,laborMultiplier:1.2}}),ve.workshopBench({label:"Workshop Fletching Table",effect:{outputMultiplier:1.2,laborMultiplier:.85}})]}]},{id:"equipment",label:"Crafted Equipment",recipes:[{id:"stone-hand-axe",name:"Stone Hand Axe",icon:"🪓",description:"Haft a sharpened stone blade onto a seasoned branch for chopping timber.",category:"equipment",inputs:{cord:1,"sharpened stone":1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"stone hand axe":1},laborHours:2,timeHours:2,tools:["stone knife","wooden hammer"],unlock:{technologies:["basic-tools"]},production:[ve.handCraft({label:"Camp Assembly",effect:{outputMultiplier:.85,laborMultiplier:1.15}}),ve.workshopBench({label:"Workshop Assembly"})]},{id:"stone-pick",name:"Stone Pick",icon:"⛏️",description:"Chip a pointed stone and lash it to a haft for prying ore from seams.",category:"equipment",inputs:{cord:1,"sharpened stone":2,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"stone pick":1},laborHours:2.5,timeHours:2.5,tools:["stone knife","wooden hammer"],unlock:{technologies:["basic-tools"]},production:[ve.handCraft({label:"Trail Forging",effect:{outputMultiplier:.85,laborMultiplier:1.2}}),ve.workshopBench({label:"Workshop Toolbench"})]},{id:"bronze-axe",name:"Bronze Axe",icon:"🪓",description:"Forge a bronze axe head and bind it to a resilient haft for advanced lumbering.",category:"equipment",inputs:{"bronze ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"bronze axe":1},laborHours:6,timeHours:6,tools:["wooden hammer"],unlock:{technologies:["bronze-smithing"]},production:[ve.workshopForge({label:"Bronze Forge Bay"})]},{id:"bronze-pick",name:"Bronze Pick",icon:"⛏️",description:"Cast and temper a bronze pick for sturdier mining expeditions.",category:"equipment",inputs:{"bronze ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"bronze pick":1},laborHours:6,timeHours:6,tools:["wooden hammer"],unlock:{technologies:["bronze-smithing"]},production:[ve.workshopForge({label:"Bronze Forge Bay"})]},{id:"iron-axe",name:"Iron Axe",icon:"🪓",description:"Shape wrought iron into a balanced axe capable of felling great trees.",category:"equipment",inputs:{"iron ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"iron axe":1},laborHours:8,timeHours:8,tools:["wooden hammer"],unlock:{technologies:["iron-smithing"]},production:[ve.workshopForge({label:"Iron Forge Bay",effect:{outputMultiplier:1.25,laborMultiplier:.78}})]},{id:"iron-pick",name:"Iron Pick",icon:"⛏️",description:"Forge an iron pickaxe able to bite through dense stone and ore.",category:"equipment",inputs:{"iron ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"iron pick":1},laborHours:8,timeHours:8,tools:["wooden hammer"],unlock:{technologies:["iron-smithing"]},production:[ve.workshopForge({label:"Iron Forge Bay",effect:{outputMultiplier:1.25,laborMultiplier:.78}})]},{id:"steel-axe",name:"Steel Axe",icon:"🪓",description:"Quench a steel axe head and mount it for master-level forestry.",category:"equipment",inputs:{"steel ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"steel axe":1},laborHours:12,timeHours:12,tools:["wooden hammer"],unlock:{technologies:["steel-smithing"]},production:[ve.steelForge({label:"Steel Forge Bay"})]},{id:"steel-pick",name:"Steel Pick",icon:"⛏️",description:"Temper a steel pick to shatter the hardest stone without dulling.",category:"equipment",inputs:{"steel ingot":2,cord:1,"sturdy haft stick":{label:"sturdy haft stick",dynamicOptions:"sturdy-stick",quantity:1}},outputs:{"steel pick":1},laborHours:12,timeHours:12,tools:["wooden hammer"],unlock:{technologies:["steel-smithing"]},production:[ve.steelForge({label:"Steel Forge Bay"})]}]}];function tg(e){const t=Ta(e);if(!t)throw new Error(`Missing equipment definition for ${e}`);return t}const rc=Array.from(new Set(eg||[])).filter(Boolean);function Xr(e){return Array.isArray(e)?e.map(t=>Xr(t)):e&&typeof e=="object"?Object.fromEntries(Object.entries(e).map(([t,n])=>[t,Xr(n)])):e}function xa(e){if(Array.isArray(e))return e.map(t=>xa(t));if(e&&typeof e=="object"){const t={};if(Object.entries(e).forEach(([n,r])=>{t[n]=xa(r)}),t.dynamicOptions==="sturdy-stick"){const n=rc.length?[...rc]:["sturdy haft stick"];t.options=n,delete t.dynamicOptions,t.label||(t.label="sturdy haft stick"),["quantity","amount","count","required","qty","value"].some(i=>t[i]!==void 0)||(t.quantity=1)}return t}return e}function ng(e){if(!e)return{};if(Array.isArray(e))return e.map(n=>xa(n));if(typeof e!="object")return e;const t={};return Object.entries(e).forEach(([n,r])=>{t[n]=xa(r)}),t}function rg(e){if(!e||typeof e!="object")return{defaultSize:1,maxSize:1,label:"batches"};const t=Math.max(1,Math.floor(e.defaultSize??e.size??1)),n=Math.max(t,Math.floor(e.maxSize??e.maximum??t)),r=e.label||e.unit||"batches";return{defaultSize:t,maxSize:n,label:r}}function Td(e){if(!e)return null;if(e==="always")return{always:!0};if(typeof e=="string")return{technologies:[e]};const t={};e.always&&(t.always=!0);const n=new Set,r=new Set,o=new Set,i=new Set;function a(d,l){if(!l)return;(Array.isArray(l)?l:[l]).forEach(f=>{!f&&f!==0||d.add(String(f))})}return a(n,e.technology),a(n,e.technologies),a(n,e.tech),a(n,e.requiredTech),a(r,e.anyTechnology),a(r,e.anyTechnologies),a(r,e.anyTech),a(o,e.building),a(o,e.buildings),a(o,e.structures),a(i,e.anyBuilding),a(i,e.anyBuildings),n.size&&(t.technologies=[...n]),r.size&&(t.anyTechnology=[...r]),o.size&&(t.buildings=[...o]),i.size&&(t.anyBuilding=[...i]),Object.keys(t).length?t:null}function og(e){return Array.isArray(e)?e.map(t=>{if(!t)return null;const n=t.type||t.kind,r=t.id||t.building||t.technology;if(!n||!r)return null;const o=t.effect||{},i=Number.isFinite(o.inputMultiplier??t.inputMultiplier)?o.inputMultiplier??t.inputMultiplier:1,a=Number.isFinite(o.outputMultiplier??t.outputMultiplier)?o.outputMultiplier??t.outputMultiplier:1,d=Number.isFinite(o.laborMultiplier??t.laborMultiplier)?o.laborMultiplier??t.laborMultiplier:1,l=Number.isFinite(o.timeMultiplier??t.timeMultiplier)?o.timeMultiplier??t.timeMultiplier:1,c=Number.isFinite(o.batchBonus??t.batchBonus)?o.batchBonus??t.batchBonus:0;return{type:String(n),id:String(r),effect:{inputMultiplier:i,outputMultiplier:a,laborMultiplier:d,timeMultiplier:l,batchBonus:c}}}).filter(Boolean):[]}function ig(e={}){const t=e.effect||{},n=Number.isFinite(t.inputMultiplier??e.inputMultiplier)?t.inputMultiplier??e.inputMultiplier:1,r=Number.isFinite(t.outputMultiplier??e.outputMultiplier)?t.outputMultiplier??e.outputMultiplier:1,o=Number.isFinite(t.laborMultiplier??e.laborMultiplier)?t.laborMultiplier??e.laborMultiplier:1,i=Number.isFinite(t.timeMultiplier??e.timeMultiplier)?t.timeMultiplier??e.timeMultiplier:1,a=Number.isFinite(t.batchBonus??e.batchBonus)?t.batchBonus??e.batchBonus:0;return{inputMultiplier:n,outputMultiplier:r,laborMultiplier:o,timeMultiplier:i,batchBonus:a}}function oc(e,t=0){if(!e)return null;const n=e.id||e.mode||e.name||e.building||`mode-${t}`,r=e.type||e.kind||(e.building?"building":"manual"),o=String(r).toLowerCase()==="hand"?"manual":String(r),i=e.label||e.name||(e.building?`${e.building} station`:"Manual Work"),a=Number.isFinite(e.priority)?Number(e.priority):o==="manual"?0:10+t,d=e.description||"",l=e.requires||e.requirement||e.unlock||null;let c=Td(l);const f=e.building||e.structure||e.station||null;if(f){const p=String(f),h=c?{...c}:{},g=new Set(h.buildings||[]);g.add(p),h.buildings=[...g],c=Object.keys(h).length?h:null}const u=ig(e);return{id:String(n),label:i,type:o,buildingId:f?String(f):null,effect:u,requirements:c,priority:a,description:d}}function ag(e){return!Array.isArray(e)||!e.length?[oc({id:"manual",label:"Hand Crafting",type:"manual",effect:{inputMultiplier:1,outputMultiplier:1,laborMultiplier:1,timeMultiplier:1,batchBonus:0},priority:0},0)]:e.map((t,n)=>oc(t,n)).filter(Boolean)}function sg(e){if(!e)return{available:!0,missing:null};if(e.always)return{available:!0,missing:null};const t={technologies:[],anyTechnology:[],buildings:[],anyBuilding:[]};let n=!0;const r=[];if(Array.isArray(e.technologies)&&r.push(...e.technologies),r.length){const d=r.filter(l=>!yn(l));d.length&&(n=!1,t.technologies=[...new Set(d.map(l=>String(l)))])}const o=Array.isArray(e.anyTechnology)?e.anyTechnology:[];o.length&&(o.some(l=>yn(l))||(n=!1,t.anyTechnology=[...new Set(o.map(l=>String(l)))]));const i=[];if(Array.isArray(e.buildings)&&i.push(...e.buildings),i.length){const d=i.filter(l=>!No(l));d.length&&(n=!1,t.buildings=[...new Set(d.map(l=>String(l)))])}const a=Array.isArray(e.anyBuilding)?e.anyBuilding:[];return a.length&&(a.some(l=>No(l))||(n=!1,t.anyBuilding=[...new Set(a.map(l=>String(l)))])),Object.keys(t).forEach(d=>{Array.isArray(t[d])&&!t[d].length&&delete t[d]}),{available:n,missing:Object.keys(t).length?t:null}}function lg(e,t=null){const n=((e==null?void 0:e.productionModes)||[]).map((d,l)=>{const c=sg(d.requirements);return{...d,index:l,status:c}}),r=n.filter(d=>d.status.available);let o=null;if(t){const d=String(t);o=n.find(l=>l.id===d&&l.status.available)||null}!o&&r.length&&(o=[...r].sort((d,l)=>l.priority===d.priority?d.index-l.index:l.priority-d.priority)[0]);const i=t&&n.find(d=>d.id===String(t))||null,a=o||i||(n.length?n[0]:null);return{modes:n,selected:o,fallback:a}}function cg(e,t,n){const r=String(e.id),o=(e.tools||[]).map(c=>tg(c)),i=ng(e.inputs||{}),a=Xr(e.outputs||{}),d=Number.isFinite(e.laborHours)?e.laborHours:Number.isFinite(e.timeHours)?e.timeHours:0,l=Number.isFinite(e.timeHours)?e.timeHours:Number.isFinite(e.laborHours)?e.laborHours:0;return{id:r,name:e.name||r,icon:e.icon||"🛠️",description:e.description||"",category:e.category||t,groupId:t,groupLabel:n,baseInputs:i,baseOutputs:a,inputs:Xr(i),outputs:Xr(a),laborHours:d,timeHours:l,baseLaborHours:d,baseTimeHours:l,toolsRequired:o.map(c=>c.id),toolDetails:o,unlock:Td(e.unlock),batch:rg(e.batch),efficiencyBonuses:og(e.efficiency),productionModes:ag(e.production||e.workstations||e.stations)}}function dg(e){const t=[];return(e||[]).forEach(n=>{const r=(n==null?void 0:n.id)||"general",o=(n==null?void 0:n.label)||r;((n==null?void 0:n.recipes)||[]).forEach(i=>{t.push(cg(i,r,o))})}),t}const Ad=dg(Ed);function ug(e){return Ad.find(t=>t.id===e)||null}function fg(e){const t=e==null?void 0:e.unlock;if(!t)return{unlocked:!1,gated:!1,missing:null};if(t.always)return{unlocked:!0,gated:!1,missing:null};let n=!1,r=!0;const o={technologies:[],anyTechnology:[],buildings:[],anyBuilding:[]},i=Array.isArray(t.technologies)?[...t.technologies]:[];if(i.length){n=!0;const c=i.filter(f=>!yn(f));c.length&&(r=!1,o.technologies=[...new Set(c.map(f=>String(f)))])}const a=Array.isArray(t.anyTechnology)?[...t.anyTechnology]:[];a.length&&(n=!0,a.some(f=>yn(f))||(r=!1,o.anyTechnology=[...new Set(a.map(f=>String(f)))]));const d=Array.isArray(t.buildings)?[...t.buildings]:[];if(d.length){n=!0;const c=d.filter(f=>!No(f));c.length&&(r=!1,o.buildings=[...new Set(c.map(f=>String(f)))])}const l=Array.isArray(t.anyBuilding)?[...t.anyBuilding]:[];return l.length&&(n=!0,l.some(f=>No(f))||(r=!1,o.anyBuilding=[...new Set(l.map(f=>String(f)))])),Object.keys(o).forEach(c=>{Array.isArray(o[c])&&!o[c].length&&delete o[c]}),n?{unlocked:r,gated:!0,missing:Object.keys(o).length?o:null}:{unlocked:!1,gated:!1,missing:null}}function ic(e,t=0){const n=Number(e);return Number.isFinite(n)?n<=0?0:Math.max(0,Math.trunc(n)):t}const ac=["quantity","amount","count","required","qty","value"];function ea(e,t){const n=Xr(e);if(typeof n=="number"){if(n<=0)return 0;const r=n*t;return!Number.isFinite(r)||r<=0?0:Math.ceil(r-1e-9)}if(typeof n=="string")return n;if(Array.isArray(n))return n.map(r=>ea(r,t));if(n&&typeof n=="object"){const r={...n};let o=null;if(ac.forEach(i=>{o===null&&Number.isFinite(n[i])&&(o=Number(n[i]))}),o!==null){const i=o,a=i*t;let d=0;Number.isFinite(a)&&a>0&&(d=Math.ceil(a-1e-9),d<=0&&i>0&&(d=1)),ac.forEach(l=>{n[l]!==void 0&&(r[l]=d)})}return r}return n}function pg(e,t){if(!e)return{};if(Array.isArray(e))return e.map(r=>ea(r,t));if(typeof e!="object")return ea(e,t);const n={};return Object.entries(e).forEach(([r,o])=>{n[r]=ea(o,t)}),n}const sc=["quantity","amount","count","qty","value"];function ta(e,t){const n=Xr(e);if(typeof n=="number"){if(n<=0)return 0;const r=n*t;if(!Number.isFinite(r)||r<=0)return 0;const o=Math.round(r);return o<=0?1:o}if(typeof n=="string")return n;if(Array.isArray(n))return n.map(r=>ta(r,t));if(n&&typeof n=="object"){const r={...n};let o=null;if(sc.forEach(i=>{o===null&&Number.isFinite(n[i])&&(o=Number(n[i]))}),o!==null){const a=o*t;let d=0;Number.isFinite(a)&&a>0&&(d=Math.round(a),d<=0&&a>0&&(d=1)),sc.forEach(l=>{n[l]!==void 0&&(r[l]=d)})}return r}return n}function mg(e,t){if(!e)return{};if(Array.isArray(e))return e.map(r=>ta(r,t));if(typeof e!="object")return ta(e,t);const n={};return Object.entries(e).forEach(([r,o])=>{n[r]=ta(o,t)}),n}function hg(e){const t=[];return((e==null?void 0:e.efficiencyBonuses)||[]).forEach(n=>{if(!n)return;const r=String(n.type||"").toLowerCase();r==="technology"?yn(n.id)&&t.push(n):r==="building"?No(n.id)&&t.push(n):(yn(n.id)||No(n.id))&&t.push(n)}),t}function gg(e,{batchSize:t=null,productionMode:n=null}={}){const r=(e==null?void 0:e.batch)||{defaultSize:1,maxSize:1},o=Math.max(1,Math.floor(r.defaultSize||1)),i=Math.max(o,Math.floor(r.maxSize||o)),a=Number.isFinite(t)?Math.max(1,Math.floor(t)):o,d=hg(e);n!=null&&n.effect&&d.push({type:"production",id:n.id,label:n.label,effect:{...n.effect}});const l=d.reduce((k,E)=>{const A=E.effect||{};return Number.isFinite(A.inputMultiplier)&&(k.inputMultiplier*=A.inputMultiplier),Number.isFinite(A.outputMultiplier)&&(k.outputMultiplier*=A.outputMultiplier),Number.isFinite(A.laborMultiplier)&&(k.laborMultiplier*=A.laborMultiplier),Number.isFinite(A.timeMultiplier)&&(k.timeMultiplier*=A.timeMultiplier),Number.isFinite(A.batchBonus)&&(k.batchBonus+=A.batchBonus),k},{inputMultiplier:1,outputMultiplier:1,laborMultiplier:1,timeMultiplier:1,batchBonus:0});let c=Number.isFinite(a+l.batchBonus)?Math.floor(a+l.batchBonus):a;c<=0&&(c=a),c=Math.max(1,Math.min(i,c));const f=c*l.inputMultiplier,u=c*l.outputMultiplier,p=Number.isFinite(e.baseLaborHours)?e.baseLaborHours:e.laborHours||0,h=Number.isFinite(e.baseTimeHours)?e.baseTimeHours:e.timeHours||p,g=p*c*l.laborMultiplier,b=h*c*l.timeMultiplier,S=pg(e.baseInputs,f),v=mg(e.baseOutputs,u);return{instance:{...e,inputs:S,outputs:v,laborHours:g,timeHours:b,batchSize:c,appliedBonuses:d,productionMode:n?{id:n.id,label:n.label,type:n.type,buildingId:n.buildingId||null}:null},batchSize:c,requestedBatchSize:a,appliedBonuses:d}}function Oi(e,t){if(t==null)return null;const n=e?String(e):"";if(typeof t=="number"){const r=ic(t,0);if(!r)return null;const o=n||"",i=o?[o]:[];return i.length?{label:n||o,options:i,quantity:r}:null}if(typeof t=="string"){const r=String(t);return{label:n||r,options:[r],quantity:1}}if(Array.isArray(t)){const r=t.map(i=>String(i)).filter(Boolean);return r.length?{label:n||r[0],options:r,quantity:1}:null}if(typeof t=="object"){const r=[];Array.isArray(t.options)&&r.push(t.options),Array.isArray(t.anyOf)&&r.push(t.anyOf),Array.isArray(t.choices)&&r.push(t.choices),Array.isArray(t.items)&&r.push(t.items);let o=r.flat().map(d=>String(d)).filter(Boolean);!o.length&&typeof t.name=="string"&&(o=[t.name]),!o.length&&n&&(o=[n]);const i=ic(t.quantity??t.amount??t.count??t.required??t.qty??t.value,1)||1,a=t.label||n||o[0]||"";return o.length?{label:a,options:o,quantity:i}:null}return null}function bg(e){const t=[],n=e==null?void 0:e.inputs;return n?Array.isArray(n)?(n.forEach(r=>{if(r){if(typeof r=="string"){const o=Oi(r,r);o&&t.push(o)}else if(Array.isArray(r)){const o=Oi("",r);o&&t.push(o)}else if(typeof r=="object"){const o=r.label||r.name||r.id||"",i=Oi(o,r);i&&t.push(i)}}}),t):(typeof n=="object"&&Object.entries(n).forEach(([r,o])=>{const i=Oi(r,o);i&&t.push(i)}),t):t}function yg(e){const t=bg(e),n=[],r=[];return t.forEach(o=>{const{label:i,options:a,quantity:d}=o,l=a.map(h=>{const g=ci(h),b=Number.isFinite(g==null?void 0:g.quantity)?g.quantity:0;return{item:h,available:b}}),c=l.reduce((h,g)=>h+g.available,0);let u=Math.min(d,c);const p=[];l.forEach(h=>{if(u<=0||h.available<=0)return;const g=Math.min(h.available,u);g>0&&(p.push({item:h.item,amount:g}),u-=g)}),c<d&&n.push({name:i,required:d,available:c}),r.push({label:i,quantity:d,options:l.map(h=>h.item),usage:p})}),{requirements:t,missingMaterials:n,materialPlan:r}}function wg(e,{availableTools:t=[],batchSize:n=null,productionModeId:r=null}={}){const o=ug(e);if(!o)return null;const i=fg(o),{modes:a,selected:d,fallback:l}=lg(o,r),c=a.some(H=>H.status.available),f=d||l||null,{instance:u,batchSize:p,appliedBonuses:h}=gg(o,{batchSize:n,productionMode:f}),g=!!(i.unlocked&&c),b=Math.max(0,Number.isFinite(u.laborHours)?u.laborHours:u.timeHours||0),S=new Set((t||[]).map(H=>String(H).toLowerCase())),k=(u.toolsRequired||[]).filter(H=>!S.has(String(H).toLowerCase())),{missingMaterials:E,materialPlan:A,requirements:L}=yg(u),F=a.map(H=>({id:H.id,label:H.label,type:H.type,buildingId:H.buildingId,effect:H.effect,priority:H.priority,available:H.status.available,missing:H.status.missing})),O=F.filter(H=>!H.available);return{recipe:u,baseRecipe:o,unlocked:g,unlockStatus:i,hasProductionAccess:c,productionMode:u.productionMode,productionModeAvailable:!!d,productionModes:F,missingProduction:O,hasTools:k.length===0,hasMaterials:E.length===0,missingTools:k,missingMaterials:E,materialPlan:A,materialRequirements:L,laborHours:b,batchSize:p,appliedBonuses:h}}function xg({availableTools:e=[],batchSize:t=null}={}){return Ad.map(n=>wg(n.id,{availableTools:e,batchSize:t})).filter(n=>n&&n.unlocked)}function Ws(){C.craftTargets instanceof Map||(Array.isArray(C.craftTargets)?C.craftTargets=new Map(C.craftTargets):C.craftTargets=new Map)}function fo(e){return String(e||"").trim().toLowerCase()}function na(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.max(0,Math.trunc(t))}function hr(e,t){if(!e||!t)return 0;const n=fo(t);if(!n)return 0;if(typeof e=="string")return fo(e)===n?1:0;if(Array.isArray(e))return e.reduce((r,o)=>r+hr(o,n),0);if(e instanceof Map){let r=0;return e.forEach((o,i)=>{fo(i)===n?r+=na(o)||0:r+=hr(o,n)}),r}if(typeof e=="object"){const r=e.id??e.name??e.item??e.type??e.slug;if(r&&fo(r)===n){const o=e.quantity??e.qty??e.count??e.amount??e.number??1,i=na(o);return i>0?i:1}return Object.keys(e).reduce((o,i)=>{const a=e[i];return fo(i)===n&&typeof a!="object"?o+na(a):o+hr(a,n)},0)}return 0}function vg(e){if(Ws(),!e)return 0;const t=String(e);return C.craftTargets.get(t)||0}function lc(e,t){if(!e)return;Ws();const n=String(e),r=na(t);r?C.craftTargets.set(n,r):C.craftTargets.delete(n),Er()}function Sg(){return Ws(),Array.from(C.craftTargets.entries()).map(([e,t])=>({id:e,target:t}))}function kg(e){if(!e)return 0;const t=fo(e);if(!t)return 0;let n=0;return C.people.forEach(r=>{n+=hr(r==null?void 0:r.equipment,t),n+=hr(r==null?void 0:r.equipped,t),n+=hr(r==null?void 0:r.heldItems,t),n+=hr(r==null?void 0:r.held,t),n+=hr(r==null?void 0:r.holding,t)}),n}const Pa={fauna:{mapKey:"discoveredFauna",collection:"animals",unknownLabel:"Unidentified creature"},flora:{mapKey:"discoveredFlora",collection:"plants",unknownLabel:"Uncatalogued specimen"}};function Cg(e,t,n){return`${e}:${t}:${kd(n,{fallback:"entry"})}`}function Mg(e){const t=Pa[e];if(!t)return new Map;const n=C[t.mapKey];if(n instanceof Map)return n;const r=new Map;return Array.isArray(n)?n.forEach(o=>{if(!o)return;const[i,a]=o;r.set(i,new Set(a||[]))}):n&&typeof n=="object"&&Object.entries(n).forEach(([o,i])=>{r.set(o,new Set(i||[]))}),C[t.mapKey]=r,r}function Eg(e,t){if(!Pa[e])return new Set;const r=Mg(e);r.has(t)||r.set(t,new Set);const o=r.get(t);if(o instanceof Set)return o;const i=new Set(Array.isArray(o)?o:[]);return r.set(t,i),i}function Nd(e){const t=Pa[e];if(!t)return{sections:[],discovered:0,total:0};const n=Object.entries(iu).map(([o,i])=>{var f;const a=(i==null?void 0:i[t.collection])||[];if(!a.length)return null;const d=Eg(e,o),l=a.map(u=>{const p=Cg(e,o,u.name),h=d.has(p);return{id:p,biomeId:o,discovered:h,item:u}}),c=l.filter(u=>u.discovered).length;return{biomeId:o,biomeName:((f=Mr(o))==null?void 0:f.name)||o,entries:l,discoveredCount:c,total:l.length}}).filter(Boolean).sort((o,i)=>o.biomeName.localeCompare(i.biomeName)),r=n.reduce((o,i)=>(o.discovered+=i.discoveredCount,o.total+=i.total,o),{discovered:0,total:0});return{sections:n,discovered:r.discovered,total:r.total}}function Tg(){return Nd("fauna")}function Ag(){return Nd("flora")}function Ld(e){var t;return((t=Pa[e])==null?void 0:t.unknownLabel)||"Unknown entry"}const Bd={water:"Water",open:"Open Land",forest:"Forest",ore:"Ore Deposits",stone:"Stone Outcrop"},Ng="🧍",Lg="player-marker",Bg=4,Vr="survey",Rg=[{id:Vr,label:"Surveyor",description:"Scout the surrounding wilderness and chart safe paths for settlers."}],Rd=22,va=.1,Fd=.1,Us=[{id:"15m",label:"15 min",minutes:15},{id:"30m",label:"30 min",minutes:30},{id:"60m",label:"60 min",minutes:60},{id:"180m",label:"3 hr",minutes:180},{id:"all-day",label:"All Day",minutes:null}];let nt=null,ra=null,er=null,fn=null,vr=null,Wt=null,$t=null,Zn=null,Xn=null,jn=null,Pn=null,go="all",Pr=null,jr=null,_r=null,pn=null,Vn=null,$d=()=>{},bo=()=>{},zi=null,On=null,Pi=null,ns=null,an=null,yo=null,qr=null,Wr=null,wo=null,It=null,hn=null;const Sa=new Map;let oa=null,cc=null,xt=null,$r=null,xo=null,Ys=!1,vo=null,po=null,ji=null,mo=null,_i=null,gr=null,qi=null,br=null,Dn=null,Ht=null,mn=null,Ur=null;const Fg=new Set(["wood","firewood","food","water"]);function $g(e=""){const t=String(e||"").trim().toLowerCase();if(!t)return"a";if(t.startsWith("hour"))return"an";const n=t[0];return["a","e","i","o","u"].includes(n)?"an":"a"}function Hg(e=""){return e&&(/[^aeiou]ies$/i.test(e)?e.replace(/ies$/i,"y"):/(xes|ses|zes|ches|shes)$/i.test(e)?e.replace(/es$/i,""):/s$/i.test(e)&&!/ss$/i.test(e)?e.replace(/s$/i,""):e)}function Ig(e=""){const t=String(e||"").trim();if(!t)return"";const n=t.split(/\s+/),r=n.pop(),o=Hg(r);return n.push(o),n.join(" ")}function rs(e,t){const n=Math.max(0,Math.ceil(t||0));if(!n)return null;const r=String(e||"").trim()||"resource";if(n===1){const o=r.toLowerCase();if(Fg.has(o))return`1 more ${r}`;const i=Ig(r);return`${$g(i)} ${i}`}return`${n} more ${r}`}function bn(e=[]){const t=e.filter(Boolean);if(!t.length)return"";if(t.length===1)return t[0];if(t.length===2)return`${t[0]} and ${t[1]}`;const n=t.slice(0,-1).join(", "),r=t[t.length-1];return`${n}, and ${r}`}function yr(e){const t=Number(e);return Number.isFinite(t)?Math.round(t*10)/10:0}function Dg(e,t){const n=Number(t);if(!Number.isFinite(n)||n<=0)return null;const r=yr(n),o=hi(e),i=o!=null&&o.icon?`${o.icon} ${e}`:e;return`${r} ${i}`}function Og(e={}){const t=[{key:"large",label:"large"},{key:"medium",label:"medium"},{key:"small",label:"small"}],n=[];let r=0;return t.forEach(({key:o,label:i})=>{const a=Number(e==null?void 0:e[o])||0;if(!a)return;r+=a;const d=a===1?"tree":"trees";n.push(`${a} ${i} ${d}`)}),r?`Standing timber includes ${bn(n)}.`:"Only stumps and brush remain; the grove has been cleared."}function zg(e={}){const t=Array.isArray(e.deposits)?e.deposits.filter(r=>((r==null?void 0:r.quantity)||0)>0):[];if(t.length){const r=t.map(o=>`${o.quantity} ${o.type}`);return`Veins promise ${bn(r)}.`}const n=Number(e.stone)||0;return n>0?`Loose stone remains in workable supply (${yr(n)} blocks).`:"The exposed rock has already been stripped of useful ore."}function Pg(e={}){const t=Object.entries(e).filter(([,o])=>Number(o)>0);if(!t.length)return"";const n=t.map(([o,i])=>Dg(o,i)).filter(Boolean),r=bn(n);return r?`Set aside nearby: ${r}.`:""}function jg(e,t){const n=String(e).toLowerCase(),r={lead:"",extras:[]};switch(n){case"forest":r.lead="is a patch of forest canopy",r.extras.push(Og(t==null?void 0:t.trees));break;case"ore":r.lead="sits atop an exposed ore seam",r.extras.push(zg(t));break;case"stone":r.lead="is a bare stone outcrop",Number(t==null?void 0:t.stone)>0&&r.extras.push(`Chiseled rubble amounts to ${yr(t.stone)} blocks.`);break;case"water":case"lake":r.lead="rests beside a still lake with fresh water.";break;case"ocean":r.lead="opens onto a tidal shoreline with crashing surf.";break;case"river":r.lead="is cut by a flowing river ripe for fishing and power.";break;case"marsh":r.lead="is saturated marshland thick with reeds.";break;case"mangrove":r.lead="winds through tangled mangrove roots and tidal pools.";break;default:r.lead="is mostly open ground ready for work";break}return r.extras=r.extras.filter(Boolean),r}function Hd(e){var t;return e?(Dn||(Dn=document.createElement("section"),Dn.id="tile-info-panel",Object.assign(Dn.style,{display:"flex",flexDirection:"column",gap:"8px",border:"1px solid var(--map-border, #ccc)",borderRadius:"12px",padding:"16px",background:"var(--bg-color, #fff)",gridColumn:"1 / -1",minWidth:"0"}),Ht=document.createElement("div"),Ht.className="tile-info-content",Object.assign(Ht.style,{display:"flex",flexDirection:"column",gap:"8px"}),Dn.appendChild(Ht)),Dn.parentElement!==e&&((t=Dn.parentElement)==null||t.removeChild(Dn),e.appendChild(Dn)),Dn):null}function _g(e){var t;if(!e)return null;if(!mn){mn=document.createElement("section"),mn.id="research-panel",Object.assign(mn.style,{display:"flex",flexDirection:"column",gap:"10px",border:"1px solid var(--map-border, #ccc)",borderRadius:"12px",padding:"16px",background:"var(--bg-color, #fff)",minWidth:"0"});const n=document.createElement("h3");n.textContent="Research & Technologies",n.style.margin="0",mn.appendChild(n);const r=document.createElement("p");r.textContent="Monitor discoveries, required prerequisites, and the benefits unlocked for your settlement.",r.style.margin="0",r.style.fontSize="13px",r.style.opacity="0.85",mn.appendChild(r),Ur=document.createElement("div"),Object.assign(Ur.style,{display:"flex",flexDirection:"column",gap:"10px"}),mn.appendChild(Ur)}return mn.parentElement!==e&&((t=mn.parentElement)==null||t.removeChild(mn),e.appendChild(mn)),mn}function qg(){if(!Ur)return;Ur.innerHTML="";const e=vu();if(!e.length){const t=document.createElement("p");t.textContent="No technologies have been catalogued yet. Advance your settlement to discover new research.",t.style.margin="0",Ur.appendChild(t);return}e.forEach(t=>{var S,v,k,E,A,L;const{definition:n,state:r,unlocked:o,available:i,missingPrerequisites:a}=t,d=document.createElement("article");Object.assign(d.style,{border:"1px solid var(--map-border, #ccc)",borderRadius:"10px",padding:"12px",background:"var(--menu-bg)",color:"var(--text-color)",display:"flex",flexDirection:"column",gap:"6px"});const l=document.createElement("div");Object.assign(l.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"8px",flexWrap:"wrap"});const c=document.createElement("h4");if(c.textContent=(n==null?void 0:n.name)||ft(t.id),c.style.margin="0",l.appendChild(c),n!=null&&n.category){const F=document.createElement("span");F.textContent=n.category,Object.assign(F.style,{fontSize:"12px",padding:"2px 6px",borderRadius:"999px",background:"rgba(128, 128, 128, 0.15)"}),l.appendChild(F)}let f="Locked",u="rgba(160, 40, 40, 0.85)";o?(f="Researched",u="rgba(36, 115, 72, 0.85)"):i?(f="Available to research",u="rgba(196, 132, 16, 0.85)"):a.length&&(f="Locked — prerequisites missing",u="rgba(160, 40, 40, 0.85)");const p=document.createElement("span");if(p.textContent=f,Object.assign(p.style,{fontSize:"12px",padding:"2px 8px",borderRadius:"999px",color:"#fff",background:u}),l.appendChild(p),d.appendChild(l),n!=null&&n.description){const F=document.createElement("p");F.textContent=n.description,F.style.margin="0",d.appendChild(F)}const h=t.prerequisites.length?t.prerequisites.map(F=>{const O=la(F);return a.includes(F)?`${O} (missing)`:`${O}`}):["None"];if(d.appendChild(Bt("Prerequisites",h.join(", "))),!o&&a.length&&d.appendChild(Bt("Missing",Lo(a))),n!=null&&n.cost){const F=[];Number.isFinite(n.cost.research)&&n.cost.research>0&&F.push(`${n.cost.research} research points`);const O=Object.entries(n.cost.materials||{}).filter(([,H])=>Number.isFinite(H)&&H>0).map(([H,_])=>`${_} ${za(H)||ft(H)}`);O.length&&F.push(`Materials: ${O.join(", ")}`),F.length&&d.appendChild(Bt("Cost",F.join(" • ")))}const g=[],b=((S=n==null?void 0:n.effects)==null?void 0:S.unlocks)||{};if((v=b.technologies)!=null&&v.length&&g.push(`Technologies: ${Lo(b.technologies)}`),(k=b.buildings)!=null&&k.length){const F=b.buildings.map(O=>{var H;return((H=ln(O))==null?void 0:H.name)||ft(O)});g.push(`Buildings: ${An(F)}`)}if((E=b.recipes)!=null&&E.length){const F=b.recipes.map(O=>hb(O));g.push(`Recipes: ${An(F)}`)}if((A=b.equipment)!=null&&A.length){const F=b.equipment.map(O=>{var H;return((H=Ta(O))==null?void 0:H.label)||ft(O)});g.push(`Equipment: ${An(F)}`)}if((L=n==null?void 0:n.effects)!=null&&L.description&&g.unshift(n.effects.description),g.length&&d.appendChild(Bt("Unlocks",g.join("; "))),r!=null&&r.unlockedAt){const F=new Date(r.unlockedAt),O=Number.isFinite(F.getTime())?F.toLocaleString():r.unlockedAt;d.appendChild(Bt("Unlocked",o?O:"Not yet researched"))}Ur.appendChild(d)})}function Wg(e,t,n){if(!e)return!1;const r=e.tile;return r&&Number.isFinite(r.x)&&Number.isFinite(r.y)?Math.trunc(r.x)===Math.trunc(t)&&Math.trunc(r.y)===Math.trunc(n):!r&&Math.trunc(t)===0&&Math.trunc(n)===0}function Ug(e){var S,v;const t=ln(e.typeId),n=document.createElement("details");n.style.borderTop="1px solid rgba(128, 128, 128, 0.25)",n.style.paddingTop="6px";const r=document.createElement("summary");r.style.fontWeight="600";const o=t!=null&&t.icon?`${t.icon} `:"",i=(t==null?void 0:t.name)||e.typeId,a=Number(e.totalLaborHours)||0,d=Math.min(a,Number(e.progressHours)||0),l=a?Math.round(d/a*100):0;r.textContent=`${o}${i} — ${l}% complete`,n.appendChild(r);const c=document.createElement("div");Object.assign(c.style,{display:"flex",flexDirection:"column",gap:"6px",marginTop:"6px"});const f=e.assignedWorkers===1?"builder":"builders",u=document.createElement("p");u.style.margin="0",u.textContent=`Labor recorded: ${yr(d)} / ${yr(a)} worker-hours with ${e.assignedWorkers} ${f} assigned.`,c.appendChild(u);const p=e.requiredResources||{},h=e.consumedResources||{},g=Object.keys(p);if(g.length){const k=document.createElement("p");k.style.margin="0",k.textContent="Materials drawn so far:",c.appendChild(k);const E=document.createElement("ul");E.style.margin="0",E.style.paddingLeft="20px",g.forEach(A=>{const L=Number(p[A])||0,F=Math.min(L,Number(h[A])||0),O=Math.max(0,L-F),H=hi(A),_=H!=null&&H.icon?`${H.icon} `:"",$=document.createElement("li");$.textContent=`${_}${A}: ${yr(F)} / ${yr(L)}${O>0?` (${yr(O)} remaining)`:""}`,E.appendChild($)}),c.appendChild(E)}else{const k=document.createElement("p");k.style.margin="0",k.textContent="No material stockpiles are required for this project.",c.appendChild(k)}const b=e.siteCategory||((v=(S=t==null?void 0:t.stats)==null?void 0:S.site)==null?void 0:v.primaryCategory);if(b||e.siteSurfaceArea){const k=document.createElement("p");k.style.margin="0";const E=b?Gs(b):"Site",A=e.siteSurfaceArea?`${li(e.siteSurfaceArea)} footprint`:"Flexible footprint";k.textContent=`${E}: ${A}.`,c.appendChild(k)}return n.appendChild(c),n}function Id(e){if(!e)return"";const t=ln(e.typeId),n=t!=null&&t.icon?`${t.icon} `:"",r=(t==null?void 0:t.name)||ft(e.typeId);return`${n}${r}`.trim()}function Yg(e){if(!e)return[];const t=new Map;return rr().forEach(n=>{if(!n||n.locationId!==e)return;const r=n.tile;if(!r||!Number.isFinite(r.x)||!Number.isFinite(r.y))return;const o=Math.trunc(r.x),i=Math.trunc(r.y),a=`${o}:${i}`;t.has(a)||t.set(a,{x:o,y:i,completed:[],underway:[],planned:[]});const d=t.get(a),l=Id(n),c=(n.status||"").toLowerCase();c==="completed"?d.completed.push(l):c==="under-construction"?d.underway.push(l):d.planned.push({name:l,status:c})}),[...t.values()].map(n=>{const r=[];if(n.completed.length){const l=n.completed.length>1?"Completed structures":"Completed structure";r.push(`${l}: ${bn(n.completed)}`)}if(n.underway.length){const l=(n.underway.length>1,"Under construction");r.push(`${l}: ${bn(n.underway)}`)}if(n.planned.length){const l=n.planned.map(c=>c.status&&c.status!=="planned"?`${c.name} (${ft(c.status)})`:c.name);r.push(`Planned: ${bn(l)}`)}const o=n.underway.length?n.completed.length?"mixed":"under-construction":n.completed.length?"completed":n.planned.length?"planned":"noted",i=[...n.completed,...n.underway,...n.planned.map(l=>l.name)],a=i[0]||"Development",d=r.join(" • ")||a;return{x:n.x,y:n.y,status:o,structures:i,label:a,details:d,count:i.length}})}function Dd(){if(!nt||typeof nt.setDevelopments!="function")return;const e=Jt();if(!e){nt.setDevelopments([]);return}nt.setDevelopments(Yg(e.id))}function ia(){var g;if(!Ht){const b=document.getElementById("game");b&&Hd(b)}if(!Ht)return;Ht.replaceChildren();const e=Jt();if(!e){const b=document.createElement("p");b.textContent="No survey site is currently active.",Ht.appendChild(b);return}const t=Zt(e.id),n=Math.trunc(t.x||0),r=Math.trunc(t.y||0),o=Ph(e.id,n,r)||{},i=ka(e,n,r)||o.type||"open",a=jg(i,o),d=document.createElement("p");let l=`The survey tile at (${n}, ${r}) ${a.lead}.`;(g=a.extras)!=null&&g.length&&(l+=` ${a.extras.join(" ")}`),d.textContent=l,Ht.appendChild(d);const c=Pg(o.stockpiles);if(c){const b=document.createElement("p");b.textContent=c,Ht.appendChild(b)}const f=Qh(i);if(f.length){const b=[...new Set(f.map(v=>v.encounterName||v.resource).filter(Boolean))];if(b.length){const v=document.createElement("p");v.textContent=`Foragers expect to find ${bn(b)} here.`,Ht.appendChild(v)}const S=new Set;if(f.forEach(v=>{Array.isArray(v.toolsRequired)&&v.toolsRequired.forEach(k=>S.add(k))}),S.size){const v=document.createElement("p");v.style.margin="0",v.style.fontStyle="italic",v.textContent=`Some finds will require ${bn([...S])}.`,Ht.appendChild(v)}}else{const b=document.createElement("p");b.textContent="Little of value grows here to gather right now.",Ht.appendChild(b)}const u=rr().filter(b=>b.locationId===e.id&&Wg(b,n,r)),p=u.filter(b=>b.status==="completed"),h=u.filter(b=>b.status==="under-construction");if(!u.length){const b=document.createElement("p");b.textContent="No structures have been recorded on this tile yet.",Ht.appendChild(b);return}if(p.length){const b=p.map(v=>Id(v)),S=document.createElement("p");S.textContent=`Completed structures: ${bn(b)}.`,Ht.appendChild(S)}if(h.length){const b=document.createElement("p");b.textContent="Construction underway:",Ht.appendChild(b),h.forEach(S=>{Ht.appendChild(Ug(S))})}}function so(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0":t>=10?`${Math.round(t)}`:`${Math.round(t*10)/10}`}function li(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0 m²":t>=100?`${Math.round(t)} m²`:`${Math.round(t*10)/10} m²`}function Gs(e){const t=String(e||"").toLowerCase();switch(t){case"forest":return"Forest understory";case"cleared":return"Cleared ground";default:return t?Qd(t):"Site"}}function Gg(e={},t=null){var u,p,h,g;const n=document.createElement("span");if(!e||!((u=e.categories)!=null&&u.length))return n.textContent="Flexible site",n;const r=(t==null?void 0:t.selected)||((p=t==null?void 0:t.categories)==null?void 0:p.find(b=>b.category===e.primaryCategory))||{category:e.primaryCategory,remaining:0},o=Gs((r==null?void 0:r.category)||e.primaryCategory),i=li(e.surfaceArea),a=document.createElement("span");let d=`${o} site – needs ${i}`;if(r&&Number.isFinite(r.remaining)){const b=Math.max(0,r.remaining);d+=` (approx. ${li(b)} open)`}a.textContent=d,n.appendChild(a);const l=[];(h=e.dimensions)!=null&&h.width&&((g=e.dimensions)!=null&&g.depth)&&l.push(`Structure ${so(e.dimensions.width)}×${so(e.dimensions.depth)} m`);const c=e.accessClearance||{},f=[];if(c.front&&f.push(`front ${so(c.front)} m`),c.back&&f.push(`rear ${so(c.back)} m`),c.left&&f.push(`left ${so(c.left)} m`),c.right&&f.push(`right ${so(c.right)} m`),f.length&&l.push(`Access clearance: ${f.join(", ")}`),l.length){n.appendChild(document.createElement("br"));const b=document.createElement("span");b.textContent=l.join(" • "),b.style.display="block",b.style.marginTop="2px",n.appendChild(b)}return n}function Od(e){e&&(e.style.width="100%",e.style.borderCollapse="collapse",e.style.marginTop="6px",e.style.fontSize="13px",e.querySelectorAll("th").forEach(t=>{t.style.textAlign="left",t.style.padding="6px 8px",t.style.borderBottom="1px solid var(--map-border, #ccc)",t.style.position="sticky",t.style.top="0",t.style.background="var(--menu-bg)",t.style.zIndex="1"}),e.querySelectorAll("td").forEach(t=>{t.style.padding="6px 8px",t.style.borderBottom="1px solid rgba(128, 128, 128, 0.25)",t.style.verticalAlign="top"}))}function Xg(){$d()}function Vg(){bo()}function Jt(){return Bo()[0]||null}function vs(e){return e?Bd[e]||e:"Uncharted ground"}function Kg(e=""){const t=String(e||"").trim();return t?/ies$/i.test(t)?t.replace(/ies$/i,"y"):/ers$/i.test(t)?t.replace(/ers$/i,"er"):/s$/i.test(t)&&!/ss$/i.test(t)?t.replace(/s$/i,""):t:"Generalist"}function zd(){const e=[],t=new Set;return Rg.forEach(n=>{if(!n)return;const r=n.id||Vr;t.has(r)||(t.add(r),e.push({id:r,label:n.label,description:n.description||""}))}),zc().filter(Boolean).forEach(n=>{const r=n.id||"";!r||t.has(r)||(t.add(r),e.push({id:r,label:Kg(n.label||r),description:n.description||""}))}),e.length||e.push({id:Vr,label:"Surveyor",description:"Scout the surroundings."}),e}function Zg(e){const t=zd();return t.find(n=>n.id===e)||t[0]||null}function Pd(e){var n;if(!e||typeof e!="object")return Vr;(typeof e.jobId!="string"||!e.jobId)&&(e.jobId=Vr);const t=zd();return t.some(r=>r.id===e.jobId)||(e.jobId=((n=t[0])==null?void 0:n.id)||Vr),e.jobId}function Zt(e=null){return(!C.player||typeof C.player!="object")&&(C.player={locationId:e??null,x:0,y:0,jobId:Vr}),(e&&C.player.locationId!==e||!C.player.locationId&&e)&&(C.player.locationId=e),Number.isFinite(C.player.x)||(C.player.x=0),Number.isFinite(C.player.y)||(C.player.y=0),C.player.x=Math.trunc(C.player.x),C.player.y=Math.trunc(C.player.y),Pd(C.player),C.player}function Xs(e,t={}){var g,b,S;const n=e||Jt(),r=n==null?void 0:n.map,o=Number.isFinite(r==null?void 0:r.xStart)?Math.trunc(r.xStart):0,i=Number.isFinite(r==null?void 0:r.yStart)?Math.trunc(r.yStart):0,a=Math.max(1,Math.trunc((r==null?void 0:r.width)||((b=(g=r==null?void 0:r.tiles)==null?void 0:g[0])==null?void 0:b.length)||1)),d=Math.max(1,Math.trunc((r==null?void 0:r.height)||((S=r==null?void 0:r.tiles)==null?void 0:S.length)||1)),l=o,c=i,f=l+a-1,u=c+d-1,p=Number.isFinite(t.x)?Math.trunc(t.x):l,h=Number.isFinite(t.y)?Math.trunc(t.y):c;return{x:Math.min(f,Math.max(l,p)),y:Math.min(u,Math.max(c,h))}}function ka(e,t,n){var l;if(!((l=e==null?void 0:e.map)!=null&&l.types))return null;const r=Number.isFinite(e.map.xStart)?Math.trunc(e.map.xStart):0,o=Number.isFinite(e.map.yStart)?Math.trunc(e.map.yStart):0,i=Math.trunc(t)-r,a=Math.trunc(n)-o;if(a<0||i<0)return null;const d=e.map.types[a];return!d||i>=d.length?null:d[i]}function Jg(){const e=Jt();if(!e)return null;const t=Zt(e.id);return ka(e,t.x,t.y)}function Ss(e){var t;if(!e)return null;if(!an){an=document.createElement("section"),an.id="player-panel",Object.assign(an.style,{display:"flex",flexDirection:"column",gap:"6px",border:"1px solid var(--map-border, #ccc)",borderRadius:"12px",padding:"12px",background:"var(--bg-color, #fff)"});const n=document.createElement("h4");n.textContent="Explorer Position",n.style.margin="0",an.appendChild(n),qr=document.createElement("p"),qr.style.margin="0",an.appendChild(qr),Wr=document.createElement("p"),Wr.style.margin="0",an.appendChild(Wr)}return an.parentElement!==e&&((t=an.parentElement)==null||t.removeChild(an),e.appendChild(an)),an}function dc(){It!=null&&It.parentElement&&It.parentElement.removeChild(It),It=null,wo=null,hn=null,Sa.clear()}function jd(){var t,n,r;const e=((t=nt==null?void 0:nt.elements)==null?void 0:t.controlDetails)||((n=nt==null?void 0:nt.elements)==null?void 0:n.actionPanel)||((r=nt==null?void 0:nt.elements)==null?void 0:r.controls)||null;if(!e){It&&dc();return}if(It&&!It.isConnected&&dc(),!It){It=document.createElement("div"),Object.assign(It.style,{display:"flex",flexDirection:"column",gap:"10px",padding:"12px 14px",borderRadius:"14px",border:"1px solid var(--map-border, rgba(104, 132, 194, 0.75))",background:"var(--map-control-surface, linear-gradient(135deg, rgba(16, 28, 62, 0.95), rgba(12, 22, 46, 0.92)))",boxShadow:"0 10px 24px rgba(0, 0, 0, 0.35)",alignItems:"stretch",width:"100%",boxSizing:"border-box"});const o=document.createElement("h5");o.textContent="Time lapse",o.style.margin="0",o.style.fontSize="0.95rem",o.style.fontWeight="600",o.style.letterSpacing="0.08em",o.style.textTransform="uppercase",o.style.color="var(--map-control-text, #f4f7ff)",It.appendChild(o),wo=document.createElement("div"),Object.assign(wo.style,{display:"flex",flexDirection:"column",gap:"8px"}),It.appendChild(wo),Sa.clear(),Us.forEach(i=>{const a=document.createElement("button");a.type="button",a.textContent=i.label,a.dataset.timeOptionId=i.id,Object.assign(a.style,{borderRadius:"12px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.8))",padding:"10px 14px",background:"var(--map-select-bg, linear-gradient(135deg, rgba(22, 40, 82, 0.98), rgba(17, 31, 60, 0.95)))",color:"var(--map-select-text, #f5f8ff)",cursor:"pointer",boxShadow:"0 6px 16px rgba(0, 0, 0, 0.35)",fontSize:"0.95rem",fontWeight:"600",letterSpacing:"0.04em",textTransform:"uppercase",width:"100%"}),a.addEventListener("click",()=>{tb(i.id)}),wo.appendChild(a),Sa.set(i.id,a)}),hn=document.createElement("button"),hn.type="button",hn.textContent="Sleep",Object.assign(hn.style,{borderRadius:"12px",border:"1px solid var(--map-border, rgba(126, 152, 212, 0.8))",padding:"10px 14px",background:"var(--map-select-bg, linear-gradient(135deg, rgba(22, 40, 82, 0.98), rgba(17, 31, 60, 0.95)))",color:"var(--map-select-text, #f5f8ff)",cursor:"pointer",fontWeight:"600",letterSpacing:"0.04em",textTransform:"uppercase",boxShadow:"0 6px 16px rgba(0, 0, 0, 0.35)",fontSize:"0.95rem",alignSelf:"stretch",width:"100%"}),hn.addEventListener("click",nb),It.appendChild(hn)}It.parentElement!==e&&e.appendChild(It)}function Qg(){const e=Ba();return{options:e.assignments.map(n=>({id:n.id,label:n.label,assigned:n.assigned,capacity:Math.max(0,e.adults-(e.assigned-n.assigned)),description:n.description,workdayHours:n.workdayHours})),laborers:e.laborer}}function Vs(){if(!nt||typeof nt.setJobOptions!="function")return;const{options:e,laborers:t}=Qg(),n=typeof nt.getSelectedJob=="function"?nt.getSelectedJob():null;nt.setJobOptions(e,{selectedId:n,laborers:t})}function eb(e){e&&(oa=e)}function Ca(){if(!nt||typeof nt.setMarkers!="function")return;const e=Jt();if(!e){nt.setMarkers([]);return}const t=Zt(e.id),n=Xs(e,t);t.x=n.x,t.y=n.y,t.locationId!==e.id&&(t.locationId=e.id),nt.setMarkers([{id:Lg,x:t.x,y:t.y,icon:Ng,className:"map-marker--player",label:"Explorer position",emphasis:!1}])}function aa(){if(yo&&Ss(yo),jd(),Vs(),!an)return;const e=Jt(),t=e?Zt(e.id):Zt(),n=cn();if(!e){qr&&(qr.textContent="No active expedition."),Wr&&(Wr.textContent=""),uc(n,{hasLocation:!1});return}const r=Xs(e,t);t.x=r.x,t.y=r.y,qr&&(qr.textContent=`Position: (${t.x}, ${t.y})`);const o=Jg(),i=vs(o);Wr&&(Wr.textContent=`Terrain: ${i} — ${n.season}, ${n.weather}`),Pd(t),uc(n,{hasLocation:!0})}function uc(e,{hasLocation:t=!0}={}){if(jd(),!wo)return;const n=Number.isFinite(e==null?void 0:e.hour)?Number(e.hour):0,r=Math.max(0,n*60),o=Rd*60,i=Math.max(0,o-r),a=Math.round(Fd*100),d=n>=20;if(Us.forEach(l=>{const c=Sa.get(l.id);if(!c)return;const f=l.minutes??i,u=l.minutes!=null?l.minutes*(1-va):i*(1-va),p=t&&i>=u&&f>.5;if(c.disabled=!p,p)if(l.id==="all-day"){const h=(r+f)/60;c.title=`Work until around ${or(h)} with ±${a}% variance.`}else c.title=`Advance roughly ${Ma(f/60)} (±${a}%).`;else t?c.title="Not enough daylight remains.":c.title="Time lapse unavailable without an active expedition."}),hn){const l=t&&(d||i<=0);hn.disabled=!l,t?l?hn.title="Turn in for the night and wake at dawn.":hn.title="Night has not yet fallen.":hn.title="Sleep is unavailable without an active expedition."}}function tb(e){const t=Us.find(L=>L.id===e);if(!t)return;const n=Jt();if(!n){Nn("An active expedition is required before committing time.");return}const r=Zt(n.id),o=Zg(r.jobId),i=cn(),a=Number.isFinite(i==null?void 0:i.hour)?Number(i.hour):0,d=Math.max(0,a*60),l=Rd*60,c=Math.max(0,l-d),f=t.minutes??c;if(f<=0){Nn("No daylight remains to act upon.");return}const u=t.minutes!=null?t.minutes*(1-va):c*(1-va);if(c<u){Nn("Not enough daylight remains for that plan.");return}const p=1+(Math.random()*2-1)*Fd,h=Math.max(1,f*p),g=i.hour;Uc(h/60);const b=cn();Er();const S=Ma(h/60),v=Ma(f/60),k=or(g),E=or(b.hour),A=o!=null&&o.label?`${o.label.toLowerCase()} duties`:"daily tasks";Nn(`Worked on ${A} from ${k} for about ${S} (planned ${v}). Wrapped near ${E}.`),gi()}function nb(){if(!Jt()){Nn("An active expedition is required before settling in to sleep.");return}const t=cn(),n=Number.isFinite(t==null?void 0:t.hour)?Number(t.hour):0;if(n<20){Nn("It is too early to sleep; daylight remains to be spent.");return}const r=or(n);Wc(),Yc(),Er();const o=cn(),i=or(o.hour);Nn(`The settlement rests from ${r} and greets the dawn at ${i}.`),gi()}function oi(e={}){if(!nt||typeof nt.setFocus!="function")return;const t=Jt(),n=t?Zt(t.id):Zt();nt.setFocus({x:n.x,y:n.y},e)}function rb({dx:e=0,dy:t=0,recenter:n=!1}={}){const r=Jt();if(!r)return;const o=Zt(r.id);if(n){oi();return}if(!e&&!t)return;const i=Xs(r,{x:o.x+e,y:o.y+t});if(i.x===o.x&&i.y===o.y){Nn("The survey does not extend further in that direction."),oi();return}const a=ka(r,o.x,o.y)||"open",d=ka(r,i.x,i.y)||a,l=Math.hypot(i.x-o.x,i.y-o.y)*To,c=Hc("swimming"),f=Yh({fromTerrain:a,toTerrain:d,distance:l,swimmingLevel:c});if(f.blocked){const S=f.reason||tc(d);Nn(`Unable to cross the ${vs(d).toLowerCase()}. ${S}`);return}o.x=i.x,o.y=i.y,o.locationId=r.id;const u=Math.max(f.hours,.02),p=lb(l),h=Ma(u),g=vs(d),b=f.reason||tc(d);Uc(u),oi(),Ca(),Er(),gi(),Nn(`Traveled ${p} into the ${g.toLowerCase()} in ${h}. ${b}`.trim())}function _d(){if($t||($t=document.createElement("div"),$t.id="time-banner",$t.setAttribute("role","status"),$t.setAttribute("aria-live","polite")),!$t.parentElement){const e=document.getElementById("content");if(e){const t=document.getElementById("game");t&&e.contains(t)?e.insertBefore($t,t):e.appendChild($t)}}return Zn||(Zn=document.createElement("div"),Zn.className="time-chip-group"),Zn.parentElement!==$t&&(Zn.parentElement&&Zn.parentElement.removeChild(Zn),$t.insertBefore(Zn,$t.firstChild)),Xn||(Xn=document.createElement("div"),Xn.className="time-actions"),Xn.parentElement!==$t&&(Xn.parentElement&&Xn.parentElement.removeChild(Xn),$t.appendChild(Xn)),Ah(Xn),$t}function qd(){if(!fn){fn=document.createElement("section"),fn.id="event-log-panel",fn.setAttribute("aria-live","polite"),Object.assign(fn.style,{display:"flex",flexDirection:"column",gap:"8px",padding:"12px 16px",background:"var(--menu-bg)",border:"1px solid var(--map-border)",borderRadius:"12px",gridColumn:"1 / -1",minWidth:"0"});const t=document.createElement("div");Object.assign(t.style,{display:"flex",justifyContent:"flex-end",marginBottom:"8px"}),Wt=document.createElement("button"),Wt.type="button",Wt.textContent="Open Full Log",Object.assign(Wt.style,{borderRadius:"8px",border:"1px solid var(--map-border)",background:"var(--action-button-bg)",color:"var(--action-button-text)",padding:"6px 12px",cursor:"pointer",boxShadow:"var(--action-button-shadow)",alignSelf:"flex-start"}),Wt.disabled=!0,Wt.addEventListener("click",()=>{eu()}),t.appendChild(Wt),fn.appendChild(t),vr=document.createElement("ul"),vr.id="event-log-summary-list",Object.assign(vr.style,{listStyle:"none",padding:"0",margin:"0",display:"flex",flexDirection:"column",gap:"6px"}),fn.appendChild(vr)}const e=document.getElementById("content");if(e){const t=document.getElementById("game");let n=null;$t&&$t.parentElement===e?n=$t:t&&e.contains(t)&&(n=t),n?e.insertBefore(fn,n):(fn.parentElement!==e||e.firstChild!==fn)&&e.insertBefore(fn,e.firstChild)}return fn}function Ro(e,t){const n=document.createElement("div");n.id=e,n.setAttribute("role","dialog"),n.setAttribute("aria-modal","true"),n.setAttribute("aria-labelledby",`${e}-title`),Object.assign(n.style,{position:"fixed",inset:"0",display:"none",alignItems:"center",justifyContent:"center",padding:"24px",background:"rgba(0, 0, 0, 0.65)",zIndex:"2000"});const r=document.createElement("div");r.tabIndex=-1,Object.assign(r.style,{background:"var(--bg-color)",color:"var(--text-color)",borderRadius:"12px",padding:"20px",maxWidth:"min(600px, 92vw)",width:"100%",maxHeight:"min(640px, 90vh)",overflow:"hidden",boxShadow:"0 24px 48px rgba(0, 0, 0, 0.35)"});const o=document.createElement("div");Object.assign(o.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"16px"});const i=document.createElement("h3");i.id=`${e}-title`,i.textContent=t,i.style.margin="0",o.appendChild(i);const a=document.createElement("button");a.type="button",a.textContent="Close",a.style.alignSelf="flex-start",o.appendChild(a),r.appendChild(o);const d=document.createElement("div");Object.assign(d.style,{marginTop:"12px",overflowY:"auto",maxHeight:"calc(90vh - 160px)"}),r.appendChild(d);const l=()=>{n.style.display="none",n.setAttribute("aria-hidden","true"),document.removeEventListener("keydown",f)},c=()=>{n.style.display="flex",n.setAttribute("aria-hidden","false"),document.addEventListener("keydown",f),typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(()=>r.focus()):setTimeout(()=>r.focus(),0)},f=u=>{u.key==="Escape"&&(u.preventDefault(),l())};return a.addEventListener("click",()=>{l()}),n.addEventListener("click",u=>{u.target===n&&l()}),n.appendChild(r),document.body.appendChild(n),{overlay:n,panel:r,content:d,openDialog:c,closeDialog:l}}function Wd(){return vo||(vo=Ro("jobs-dialog","Assign Jobs"),po=vo.content),vo}function ks(){const e=Wd();if(!po||!e)return;const t=Ba();po.innerHTML="";const n=document.createElement("p");n.textContent=`Adults ready to work: ${t.adults}. Unassigned laborers: ${t.laborer}.`,po.appendChild(n);const r=document.createElement("p");r.textContent="Assign settlers to focused duties. Laborers without assignments will handle general chores. Hover or long-press a job to view details.",r.style.fontSize="13px",r.style.opacity="0.82",r.style.marginTop="4px",po.appendChild(r);const o=document.createElement("div");if(Object.assign(o.style,{display:"flex",flexDirection:"column",gap:"6px",marginTop:"12px"}),o.setAttribute("role","list"),po.appendChild(o),t.assignments.forEach(i=>{const a=Math.max(0,t.adults-(t.assigned-i.assigned)),d=document.createElement("div");d.dataset.jobId=i.id,d.setAttribute("role","listitem"),Object.assign(d.style,{display:"grid",gridTemplateColumns:"1fr auto auto auto",alignItems:"center",gap:"8px",padding:"8px 12px",borderRadius:"10px",border:"1px solid var(--map-border, #ccc)",background:"var(--menu-bg)",color:"var(--text-color)"});const l=[];if(i.description&&l.push(i.description),l.push(`Assigned ${i.assigned} of ${a}`),Array.isArray(i.roster)&&i.roster.length){const s=i.roster.map(R=>R.name).join(", ");l.push(`Assigned settlers: ${s}`)}l.push(`Unassigned laborers: ${t.laborer}`),l.push(`Workday: ${i.workdayHours} hours`);const c=l.join(`
`);d.title=c,d.setAttribute("aria-label",`${i.label}. ${l.join(". ")}`);const f=document.createElement("span");f.textContent=i.label,f.style.fontWeight="600",f.style.whiteSpace="nowrap",f.style.overflow="hidden",f.style.textOverflow="ellipsis",d.appendChild(f);const u=document.createElement("div");Object.assign(u.style,{display:"flex",alignItems:"center",gap:"4px",justifySelf:"center"});const p=document.createElement("span");p.textContent="⏰",p.setAttribute("aria-hidden","true"),u.appendChild(p);const h=document.createElement("span");h.textContent=`${i.workdayHours}h`,h.style.fontVariantNumeric="tabular-nums",h.style.minWidth="38px",h.style.textAlign="center",u.appendChild(h);const g=document.createElement("div");Object.assign(g.style,{display:"flex",flexDirection:"column",gap:"2px"});const b=4,S=16,v=(s,R,W)=>{const K=document.createElement("button");return K.type="button",K.textContent=s,K.setAttribute("aria-label",W),Object.assign(K.style,{width:"22px",height:"18px",borderRadius:"4px",border:"1px solid var(--map-border, #999)",background:"var(--menu-bg)",cursor:"pointer",lineHeight:"1"}),K.addEventListener("click",ne=>{ne.preventDefault();const ye=Math.max(b,Math.min(S,(i.workdayHours||10)+R));of(i.id,ye),ks()}),K},k=v("▼",-1,`Reduce ${i.label} workday`),E=v("▲",1,`Increase ${i.label} workday`);k.disabled=i.workdayHours<=b,E.disabled=i.workdayHours>=S,k.disabled&&(k.style.cursor="not-allowed",k.style.opacity="0.5"),E.disabled&&(E.style.cursor="not-allowed",E.style.opacity="0.5"),g.appendChild(E),g.appendChild(k),u.appendChild(g),d.appendChild(u);const A=document.createElement("span");A.textContent=String(i.assigned||0),A.style.fontVariantNumeric="tabular-nums",A.style.justifySelf="center",d.appendChild(A);const L=document.createElement("div");Object.assign(L.style,{display:"flex",gap:"4px"});const F=(s,R,W)=>{const K=document.createElement("button");return K.type="button",K.textContent=s,K.setAttribute("aria-label",W),Object.assign(K.style,{width:"28px",height:"28px",borderRadius:"6px",border:"1px solid var(--map-border, #999)",background:"var(--menu-bg)",cursor:"pointer"}),K.addEventListener("click",ne=>{ne.preventDefault(),rf(i.id,i.assigned+R),ks()}),K},O=F("▼",-1,`Reduce ${i.label} assignments`),H=F("▲",1,`Increase ${i.label} assignments`);O.disabled=i.assigned<=0,H.disabled=i.assigned>=a,O.disabled&&(O.style.cursor="not-allowed",O.style.opacity="0.5"),H.disabled&&(H.style.cursor="not-allowed",H.style.opacity="0.5"),L.appendChild(O),L.appendChild(H),d.appendChild(L);const _=document.createElement("div");_.style.gridColumn="1 / -1",_.style.fontSize="12px",_.style.opacity="0.82",_.style.paddingTop="4px";const $=Array.isArray(i.roster)?i.roster.map(s=>{const R=[s.name];return s.focusSkillName&&R.push(`specialises in ${s.focusSkillName.toLowerCase()}`),Number.isFinite(s.score)&&R.push(`score ${s.score}`),R.join(" • ")}):[];_.textContent=$.length?`Assigned: ${$.join(", ")}`:"Assigned: None — laborers will rotate through as needed.",d.appendChild(_),o.appendChild(d)}),Vs(),oa){const i=oa;oa=null;const a=o.querySelector(`[data-job-id="${i}"]`);if(a){const d=a.style.boxShadow;a.style.boxShadow="0 0 0 3px rgba(74, 144, 226, 0.45)",a.scrollIntoView({block:"center",behavior:"smooth"}),clearTimeout(cc),cc=setTimeout(()=>{a.style.boxShadow=d||""},1600)}}}function Ud(){return ji||(ji=Ro("craft-planner-dialog","Craft Planner"),mo=ji.content),ji}function Cs(){const e=Ud();if(!mo||!e)return;const t=cb(),n=xg({availableTools:t}),r=new Map;n.forEach(l=>{Object.entries(l.recipe.outputs||{}).forEach(([c])=>{r.has(c)||r.set(c,{recipes:new Set}),r.get(c).recipes.add(l.recipe.name||c)})});const o=Sg(),i=new Set([...r.keys(),...o.map(l=>l.id)]);if(mo.innerHTML="",!i.size){const l=document.createElement("p");l.textContent="No craftable goods are available yet.",mo.appendChild(l);return}const a=document.createElement("p");a.textContent="Set the desired stock for crafted goods. Equipped or held items are ignored automatically.",a.style.fontSize="13px",a.style.opacity="0.82",mo.appendChild(a);const d=document.createElement("div");Object.assign(d.style,{display:"flex",flexDirection:"column",gap:"12px",marginTop:"12px"}),mo.appendChild(d),Array.from(i).sort((l,c)=>l.localeCompare(c)).forEach(l=>{const c=r.get(l)||{recipes:new Set},f=vg(l),u=ci(l),p=Number(u.quantity)||0,h=kg(l),g=Math.max(0,Math.round((p-h)*10)/10),b=Math.max(0,Math.round(h*10)/10),S=document.createElement("div");Object.assign(S.style,{border:"1px solid var(--map-border, #ccc)",borderRadius:"12px",padding:"12px",background:"var(--menu-bg)",color:"var(--text-color)",display:"flex",flexDirection:"column",gap:"8px"});const v=document.createElement("div");Object.assign(v.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"12px",flexWrap:"wrap"});const k=document.createElement("h4");k.textContent=l.charAt(0).toUpperCase()+l.slice(1),k.style.margin="0",v.appendChild(k);const E=document.createElement("div");Object.assign(E.style,{display:"flex",alignItems:"center",gap:"8px"});const A=document.createElement("span");A.textContent="Target",A.style.fontWeight="600",E.appendChild(A);const L=document.createElement("input");L.type="number",L.min="0",L.step="1",L.value=String(f||0),L.style.width="80px",L.setAttribute("aria-label",`Desired stock for ${l}`),L.addEventListener("change",()=>{const H=Number.parseInt(L.value,10);lc(l,Number.isFinite(H)?H:0),Cs()}),E.appendChild(L);const F=document.createElement("button");F.type="button",F.textContent="Clear",F.addEventListener("click",()=>{lc(l,0),Cs()}),E.appendChild(F),v.appendChild(E),S.appendChild(v);const O=document.createElement("span");if(O.style.fontSize="13px",O.style.opacity="0.85",O.textContent=`Usable on hand: ${g} (Reserved: ${b}).`,S.appendChild(O),c.recipes.size){const H=document.createElement("span");H.style.fontSize="12px",H.style.opacity="0.75",H.textContent=`Produced by: ${Array.from(c.recipes).join(", ")}.`,S.appendChild(H)}d.appendChild(S)})}function ob(){return zi||(zi=Ro("profile-dialog","Settlement Profile"),On=zi.content),zi}function ib(){if(!Pi){Pi=Ro("log-dialog","Event Log"),ns=Pi.content;const e=document.createElement("p");e.textContent="A chronological account of notable happenings within your settlement.",ns.appendChild(e),er=document.createElement("ul"),er.style.listStyle="none",er.style.padding="0",er.style.margin="0",ns.appendChild(er)}return Pi}function Yd(){if(!_i&&(_i=Ro("herbarium-dialog","Herbarium"),gr=_i.content,gr)){const e=document.createElement("p");e.textContent="Catalogue of flora identified throughout your travels. Forage to reveal new entries.",e.style.marginBottom="8px",gr.appendChild(e)}return _i}function ab(){const e=Yd();if(!gr||!e)return;gr.innerHTML="";const t=Ag();if(!t.total){const r=document.createElement("p");r.textContent="No flora specimens have been catalogued yet. Forage successfully to add discoveries to your herbarium.",gr.appendChild(r);return}const n=document.createElement("p");n.textContent=`Specimens catalogued: ${t.discovered} of ${t.total}.`,n.style.marginBottom="6px",gr.appendChild(n),t.sections.forEach(r=>{const o=document.createElement("section");o.style.marginTop="12px";const i=document.createElement("h4");i.textContent=`${r.biomeName} (${r.discoveredCount}/${r.total})`,i.style.margin="0 0 4px 0",o.appendChild(i);const a=document.createElement("table"),d=document.createElement("thead"),l=document.createElement("tr");["Specimen","Edible Parts","Caution","Uses"].forEach(f=>{const u=document.createElement("th");u.textContent=f,l.appendChild(u)}),d.appendChild(l),a.appendChild(d);const c=document.createElement("tbody");r.entries.forEach(f=>{const u=document.createElement("tr");f.discovered||(u.style.opacity="0.65");const p=document.createElement("td");f.discovered?(p.textContent=f.item.name,p.style.fontWeight="600"):(p.textContent=Ld("flora"),p.style.fontStyle="italic"),u.appendChild(p);const h=document.createElement("td");h.textContent=f.discovered?f.item.edibleParts||"None noted":"Unknown",u.appendChild(h);const g=document.createElement("td");g.textContent=f.discovered?f.item.poisonousParts||"None noted":"Unknown",u.appendChild(g);const b=document.createElement("td");b.textContent=f.discovered?f.item.usefulParts||"No recorded uses":"Unknown",u.appendChild(b),c.appendChild(u)}),a.appendChild(c),Od(a),o.appendChild(a),gr.appendChild(o)})}function Gd(){if(!qi&&(qi=Ro("bestiary-dialog","Bestiary"),br=qi.content,br)){const e=document.createElement("p");e.textContent="Records of wildlife encountered in each biome. Successful hunts reveal new creatures.",e.style.marginBottom="8px",br.appendChild(e)}return qi}function sb(){const e=Gd();if(!br||!e)return;br.innerHTML="";const t=Tg();if(!t.total){const r=document.createElement("p");r.textContent="No wildlife has been documented yet. Complete hunting expeditions to populate the bestiary.",br.appendChild(r);return}const n=document.createElement("p");n.textContent=`Creatures documented: ${t.discovered} of ${t.total}.`,n.style.marginBottom="6px",br.appendChild(n),t.sections.forEach(r=>{const o=document.createElement("section");o.style.marginTop="12px";const i=document.createElement("h4");i.textContent=`${r.biomeName} (${r.discoveredCount}/${r.total})`,i.style.margin="0 0 4px 0",o.appendChild(i);const a=document.createElement("table"),d=document.createElement("thead"),l=document.createElement("tr");["Creature","Difficulty","Aggression","Diet","Recommended Tools","Notes"].forEach(f=>{const u=document.createElement("th");u.textContent=f,l.appendChild(u)}),d.appendChild(l),a.appendChild(d);const c=document.createElement("tbody");r.entries.forEach(f=>{const u=document.createElement("tr");f.discovered||(u.style.opacity="0.65");const p=document.createElement("td");f.discovered?(p.textContent=f.item.name,p.style.fontWeight="600"):(p.textContent=Ld("fauna"),p.style.fontStyle="italic"),u.appendChild(p);const h=document.createElement("td");h.textContent=f.discovered?f.item.difficulty:"Unknown",u.appendChild(h);const g=document.createElement("td");g.textContent=f.discovered?f.item.aggressive?"Yes":"No":"Unknown",u.appendChild(g);const b=document.createElement("td");b.textContent=f.discovered?f.item.diet:"Unknown",u.appendChild(b);const S=document.createElement("td");S.textContent=f.discovered?f.item.tools&&f.item.tools.length?f.item.tools.join(", "):"None":"Unknown",u.appendChild(S);const v=document.createElement("td");v.textContent=f.discovered?f.item.notes||"No notes recorded.":"Unknown",u.appendChild(v),c.appendChild(u)}),a.appendChild(c),Od(a),o.appendChild(a),br.appendChild(o)})}function Ks(){var n,r;const e=Jt();if(!e||!nt)return;const t=Zt(e.id);nt.setMap(e.map,{biomeId:e.biome,seed:(n=e.map)==null?void 0:n.seed,season:(r=e.map)==null?void 0:r.season,focus:{x:t.x,y:t.y}}),oi({recenter:!0}),Ca(),Dd()}function or(e=0,t={}){const{separator:n=":"}=t,o=((Number.isFinite(e)?Number(e):0)%24+24)%24;let i=Math.floor(o),a=Math.round((o-i)*60);a>=60&&(a-=60,i=(i+1)%24);const d=fc(i),l=fc(a);return n?`${d}${n}${l}`:`${d}${l}`}function Ma(e=0){const t=Number.isFinite(e)?Math.max(0,e):0,n=Math.round(t*60);if(n<=0)return"<1m";const r=Math.floor(n/60),o=n%60;return r&&o?`${r}h ${o}m`:r?`${r}h`:`${o}m`}function lb(e=To){const t=Number.isFinite(e)?Math.max(0,e):To;return t>=1e3?`${Math.round(t/1e3*10)/10} km`:`${Math.round(t)} m`}function fc(e,t=2){const n=Number.isFinite(e)?Math.trunc(e):0,r=n<0?0:n;return String(r).padStart(t,"0")}function cb(){return Sc().filter(e=>Number.isFinite(e.quantity)&&e.quantity>0).map(e=>e.id)}function Xd(){return Array.isArray(C.eventLog)||(C.eventLog=[]),C.eventLog}function Vd(e={}){const t=Number.isFinite(e.day)?Math.max(1,Math.floor(e.day)):1,n=Is(e.month??1),r=Number.isFinite(e.year)?Math.floor(e.year):0,o=[e.season,e.weather].filter(Boolean),i=o.length?` (${o.join(" • ")})`:"",a=or(e.hour);return{dayNumber:t,monthName:n,yearNumber:r,descriptor:i,timeText:a}}function Nn(e){const t=cn(),n=Xd();n.unshift({id:`${Date.now()}-${Math.random()}`,message:e,day:t.day,month:t.month,year:t.year,hour:t.hour,season:t.season,weather:t.weather}),n.length>30&&(n.length=30),Zs()}function db(e){if(qd(),!!vr){if(vr.innerHTML="",!e.length){const t=document.createElement("li");t.textContent="No recent events yet. Venture out to gather supplies or assign work orders.",t.style.fontStyle="italic",vr.appendChild(t),Wt&&(Wt.disabled=!0,Wt.style.opacity="0.6",Wt.style.cursor="default");return}Wt&&(Wt.disabled=!1,Wt.style.opacity="1",Wt.style.cursor="pointer"),e.slice(0,Bg).forEach(t=>{var d,l;const n=Vd(t),r=document.createElement("li");Object.assign(r.style,{display:"flex",flexDirection:"column",gap:"2px"});const o=document.createElement("div");Object.assign(o.style,{display:"flex",alignItems:"center",gap:"8px"});const i=document.createElement("span");Object.assign(i.style,{fontFamily:'"Fira Mono", "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',fontSize:"12px",padding:"2px 6px",borderRadius:"6px",color:"inherit"}),(l=(d=document.body)==null?void 0:d.classList)!=null&&l.contains("dark")?(i.style.background="rgba(255, 255, 255, 0.12)",i.style.border="1px solid rgba(255, 255, 255, 0.18)"):(i.style.background="rgba(0, 0, 0, 0.06)",i.style.border="1px solid rgba(0, 0, 0, 0.08)"),i.textContent=n.timeText,o.appendChild(i);const a=document.createElement("span");a.textContent=t.message,a.style.fontWeight="600",o.appendChild(a),r.appendChild(o),vr.appendChild(r)})}}function ub(e){if(er){if(er.innerHTML="",!e.length){const t=document.createElement("li");t.textContent="No recent events yet.",er.appendChild(t);return}e.forEach(t=>{const n=Vd(t),r=document.createElement("li");r.textContent=`${n.timeText} – ${t.message}`,er.appendChild(r)})}}function Zs(){const e=Xd();db(e),ub(e)}function os(e,t,n){!Number.isFinite(n)||n===0||(e[t]||(e[t]={supply:0,demand:0}),n>0?e[t].supply+=n:e[t].demand+=Math.abs(n))}function fb(){var i;const e={},t=rr({statuses:["completed"]}),n=Ba(),r=new Map;(i=n==null?void 0:n.assignments)==null||i.forEach(a=>{r.set(a.id,a.assigned||0)});const o=new Map;return t.forEach(a=>{var c;const d=ln(a.typeId),l=(c=d==null?void 0:d.effects)==null?void 0:c.jobs;l&&Object.entries(l).forEach(([f,u])=>{const p=Number(u)||0;p>0&&o.set(f,(o.get(f)||0)+p)})}),t.forEach(a=>{const d=ln(a.typeId);if(!d)return;const l=d.effects||{};let c=1;const f=l.jobs;if(f&&Object.keys(f).length){let u=1;Object.entries(f).forEach(([p])=>{const h=o.get(p)||0,g=r.get(p)||0,b=h>0?Math.min(1,g/h):0;u=Math.min(u,b)}),c=u}Object.entries(l.supply||{}).forEach(([u,p])=>{os(e,u,(p||0)*c)}),Object.entries(l.demand||{}).forEach(([u,p])=>{if(!Number.isFinite(p)||p===0)return;const h=p*c;h>0?os(e,u,-h):os(e,u,Math.abs(h))})}),e}function Kd(){const e=Gf(_h()),t=fb();Object.entries(t).forEach(([r,o])=>{e[r]||(e[r]={supply:0,demand:0}),e[r].supply+=o.supply||0,e[r].demand+=o.demand||0});const n=new Set(Array.from(C.inventory.keys()));Object.keys(e).forEach(r=>n.add(r)),n.forEach(r=>{const o=e[r]||{supply:0,demand:0},i=Math.round((o.supply||0)*10)/10,a=Math.round((o.demand||0)*10)/10;gu(r,{supply:i,demand:a})})}function pc(e=0,t=""){const n=Math.round((e||0)*10)/10;return n?`${t}${Math.abs(n)}`:"0"}function Zd(){if(Qs(),!xo)return;xo.innerHTML="";const e=Sc().sort((t,n)=>{if(t.isEquipment!==n.isEquipment)return t.isEquipment?-1:1;const r=(t.label||t.id||"").toLowerCase(),o=(n.label||n.id||"").toLowerCase();return r.localeCompare(o)});if(!e.length){const t=document.createElement("tr");t.innerHTML='<td colspan="5">No supplies on hand.</td>',xo.appendChild(t);return}e.forEach(t=>{const n=document.createElement("tr"),r=document.createElement("td");r.style.display="flex",r.style.alignItems="center",r.style.gap="6px";const o=hi(t.id);if(o){const f=document.createElement("span");f.textContent=o.icon,f.title=o.label,f.setAttribute("role","img"),f.setAttribute("aria-label",o.label),r.appendChild(f)}const i=document.createElement("span");i.textContent=t.label||za(t.id)||t.id,r.appendChild(i);const a=document.createElement("td");a.textContent=t.tierLabel||t.qualityLabel||"—";const d=document.createElement("td");d.textContent=Math.round((t.quantity||0)*10)/10,d.style.textAlign="right";const l=document.createElement("td");l.textContent=pc(t.supply,"+"),l.style.textAlign="right";const c=document.createElement("td");c.textContent=pc(t.demand,"-"),c.style.textAlign="right",n.appendChild(r),n.appendChild(a),n.appendChild(d),n.appendChild(l),n.appendChild(c),xo.appendChild(n)})}function Js(){Kd(),Ys&&Zd()}function Qs(){if(xt)return xt.parentElement||document.body.appendChild(xt),xt;xt=document.createElement("div"),xt.id="inventory-popup",xt.setAttribute("role","dialog"),xt.setAttribute("aria-modal","true"),xt.setAttribute("aria-hidden","true"),xt.setAttribute("aria-labelledby","inventory-popup-title"),Object.assign(xt.style,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",display:"none",alignItems:"center",justifyContent:"center",background:"rgba(0, 0, 0, 0.45)",zIndex:"2100"}),xt.addEventListener("click",l=>{l.target===xt&&mc()}),$r=document.createElement("div"),$r.classList.add("inventory-dialog"),Object.assign($r.style,{background:"var(--menu-bg)",color:"var(--text-color)",borderRadius:"10px",boxShadow:"0 10px 24px rgba(0, 0, 0, 0.35)",padding:"20px",maxWidth:"520px",width:"90vw",maxHeight:"80vh",overflowY:"auto"});const e=document.createElement("div");e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="space-between",e.style.gap="12px";const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.gap="12px";const n=document.createElement("h3");n.id="inventory-popup-title",n.textContent="Inventory Overview",n.style.margin="0",t.appendChild(n),e.appendChild(t);const r=document.createElement("button");r.type="button",r.textContent="Close",r.addEventListener("click",()=>{mc()}),e.appendChild(r),$r.appendChild(e);const o=document.createElement("p");o.textContent="Track on-hand quantities alongside projected supply and demand from queued orders.",o.style.marginTop="12px",o.style.marginBottom="12px",$r.appendChild(o);const i=document.createElement("table");i.style.width="100%",i.style.borderCollapse="collapse";const a=document.createElement("tr");a.innerHTML='<th style="text-align:left;">Item</th><th style="text-align:left;">Tier</th><th style="text-align:right;">#</th><th style="text-align:right;">Supply (+)</th><th style="text-align:right;">Demand (-)</th>';const d=document.createElement("thead");return d.appendChild(a),i.appendChild(d),xo=document.createElement("tbody"),i.appendChild(xo),$r.appendChild(i),xt.appendChild($r),document.body.appendChild(xt),xt}function pb(){Qs(),Kd(),Zd(),xt.style.display="flex",xt.setAttribute("aria-hidden","false"),Ys=!0}function mc(){xt&&(xt.style.display="none",xt.setAttribute("aria-hidden","true"),Ys=!1)}function Kn(e=0){const t=Math.round(e*10)/10;return t>0?`+${t}`:`${t}`}function An(e=[]){const t=(Array.isArray(e)?e:[e]).filter(n=>n!=null&&`${n}`.trim()!=="");return t.length?t.length===1?`${t[0]}`:t.length===2?`${t[0]} and ${t[1]}`:`${t.slice(0,-1).join(", ")}, and ${t[t.length-1]}`:""}function ft(e=""){return String(e||"").split(/[-_]/).filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function Ea(e){if(!e&&e!==0)return null;if(typeof e=="string"||typeof e=="number")return{id:String(e),count:1};if(e&&typeof e=="object"){const t=e.id??e.building??e.type;if(!t&&t!==0)return null;const n=Number.isFinite(e.count)?Math.max(1,e.count):Number.isFinite(e.required)?Math.max(1,e.required):1;return{id:String(t),count:n}}return null}function lo(e){return!e&&e!==0?[]:Array.isArray(e)?e:[e]}function Lo(e=[]){const t=(Array.isArray(e)?e:[e]).filter(n=>n||n===0).map(n=>la(n));return An(t)}function mb(e={}){if(!e)return[];const t=[],n=lo(e.technologies||[]).filter(l=>l||l===0);n.length&&t.push(`Research ${Lo(n)}`);const r=lo(e.anyTechnology||[]).filter(l=>l||l===0);r.length&&t.push(`Research one of ${Lo(r)}`);const o=lo(e.research||[]).filter(l=>l||l===0);if(o.length){const l=o.map(c=>ft(c));t.push(`Complete research: ${An(l)}`)}const i=lo(e.anyResearch||[]).filter(l=>l||l===0);if(i.length){const l=i.map(c=>ft(c));t.push(`Complete one of: ${An(l)}`)}const a=lo(e.buildings||[]).map(Ea).filter(Boolean).map(l=>{var f;const c=((f=ln(l.id))==null?void 0:f.name)||ft(l.id);return l.count>1?`${l.count}× ${c}`:c});a.length&&t.push(`Construct ${An(a)}`);const d=lo(e.anyBuilding||[]).map(Ea).filter(Boolean).map(l=>{var f;const c=((f=ln(l.id))==null?void 0:f.name)||ft(l.id);return l.count>1?`${l.count}× ${c}`:c});if(d.length&&t.push(`Construct one of: ${An(d)}`),e.resources&&typeof e.resources=="object"){const l=Object.entries(e.resources).filter(([,c])=>Number.isFinite(c)&&c>0).map(([c,f])=>`${f} ${za(c)||ft(c)}`);l.length&&t.push(`Stockpile ${An(l)}`)}return t}const Jo=new Map;function hb(e){if(!e&&e!==0)return"";const t=String(e);return Jo.size||Ed.forEach(n=>{(n.recipes||[]).forEach(r=>{const o=String(r.id);Jo.set(o,r.name||ft(o))})}),Jo.has(t)||Jo.set(t,ft(t)),Jo.get(t)}function Bt(e,t){const n=document.createElement("p"),r=document.createElement("strong");return r.textContent=`${e}: `,n.appendChild(r),t instanceof Node?n.appendChild(t):n.appendChild(document.createTextNode(t)),n}function Hr(e={}){const t=Object.entries(e).filter(([,r])=>r&&r!==0),n=document.createElement("span");return t.length?(t.forEach(([r,o],i)=>{const a=document.createElement("span");a.style.display="inline-flex",a.style.alignItems="center",a.style.gap="4px",a.style.marginRight="8px";const d=Math.round(o*10)/10,l=hi(r);if(l){const c=document.createElement("span");c.textContent=l.icon,c.title=l.label,c.setAttribute("role","img"),c.setAttribute("aria-label",l.label),a.appendChild(c);const f=document.createElement("span");f.textContent=`×${d}`,a.appendChild(f)}else a.textContent=`${d} ${r}`;n.appendChild(a),i===t.length-1&&(a.style.marginRight="0")}),n):(n.textContent="None",n)}function hc(e={}){const t=[];if([["occupancy",r=>`Occupancy ${Kn(r)}`],["comfort",r=>`Comfort ${Kn(r)}`],["survivability",r=>`Survivability ${Kn(r)}`],["appeal",r=>`Appeal ${Kn(r)}`],["safety",r=>`Safety ${Kn(r)}`],["maxWorkers",r=>`Supports ${r} workers`]].forEach(([r,o])=>{e[r]&&t.push(o(e[r]))}),e.jobs){const r=new Map(zc().map(o=>[o.id,o.label||ft(o.id)]));Object.entries(e.jobs).forEach(([o,i])=>{if(!Number.isFinite(i)||i<=0)return;const a=r.get(o)||ft(o);t.push(`Supports ${i} ${a}`)})}if(e.supply&&Object.entries(e.supply).forEach(([r,o])=>{t.push(`Supply ${r} ${Kn(o)}`)}),e.demand&&Object.entries(e.demand).forEach(([r,o])=>{t.push(`Demand ${r} ${Kn(o)}`)}),e.capacity&&Object.entries(e.capacity).forEach(([r,o])=>{t.push(`Capacity ${r} ${Kn(o)}`)}),e.storage&&Object.entries(e.storage).forEach(([r,o])=>{t.push(`Storage ${r} ${Kn(o)}`)}),e.unlocks){const o=(Array.isArray(e.unlocks)?e.unlocks:[e.unlocks]).map(i=>{if(!i&&i!==0)return null;if(typeof i=="string"||typeof i=="number")return la(i)||ft(i);if(i&&typeof i=="object"){const a=i.technology??i.tech??i.id;if(a||a===0)return la(a)||ft(a)}return null}).filter(Boolean);o.length&&t.push(`Unlocks: ${o.join(", ")}`)}return t}function gb(e,t){var c,f,u,p,h;const n=document.createElement("article");n.className="build-card",e!=null&&e.id&&(n.dataset.typeId=e.id),n.style.border="1px solid var(--map-border)",n.style.padding="8px",n.style.borderRadius="6px",n.style.background="var(--card-bg, var(--map-bg))",n.style.color="var(--card-text, var(--text-color))";const r=document.createElement("h4");if(r.textContent=`${e.icon?`${e.icon} `:""}${e.name}`,n.appendChild(r),e.description){const g=document.createElement("p");g.textContent=e.description,n.appendChild(g)}n.appendChild(Bt("Labor",`${e.stats.totalLaborHours} worker-hours`)),n.appendChild(Bt("Minimum Builders",e.stats.minBuilders)),e.stats.site&&n.appendChild(Bt("Site",Gg(e.stats.site,t.siteStatus))),n.appendChild(Bt("Core Structure",Hr(e.stats.coreResources))),n.appendChild(Bt("Full Build",Hr(e.stats.totalResources))),(c=e.requirements)!=null&&c.craftedGoods&&n.appendChild(Bt("Crafted Goods",Hr(e.requirements.craftedGoods)));const o=mb(e.unlock);o.length&&n.appendChild(Bt("Prerequisites",o.join("; ")));const i=hc(e.effects);if(i.length){const g=document.createElement("p");g.innerHTML="<strong>Effects:</strong>",n.appendChild(g);const b=document.createElement("ul");i.forEach(S=>{const v=document.createElement("li");v.textContent=S,b.appendChild(v)}),n.appendChild(b)}if((f=e.stats.components)!=null&&f.length){const g=document.createElement("details"),b=document.createElement("summary");b.textContent="Construction segments",g.appendChild(b),e.stats.components.forEach(S=>{const v=document.createElement("div");v.style.marginBottom="6px";const k=document.createElement("p"),E=document.createElement("strong");if(E.textContent=S.name,k.appendChild(E),S.isCore){const A=document.createElement("em");A.textContent=" (Core structure)",A.style.marginLeft="4px",k.appendChild(A)}S.description&&k.appendChild(document.createTextNode(` – ${S.description}`)),v.appendChild(k),v.appendChild(Bt("Labor",`${S.laborHours} hrs @ ≥${S.minBuilders} builders`)),v.appendChild(Bt("Resources",Hr(S.resources))),g.appendChild(v)}),n.appendChild(g)}if((u=e.stats.addons)!=null&&u.length){const g=document.createElement("details"),b=document.createElement("summary");b.textContent="Optional upgrades",g.appendChild(b),e.stats.addons.forEach(S=>{const v=document.createElement("div");v.style.marginBottom="6px";const k=document.createElement("p");if(k.innerHTML=`<strong>${S.name}:</strong> ${S.description}`,v.appendChild(k),v.appendChild(Bt("Labor",`${S.laborHours} hrs @ ≥${S.minBuilders} builders`)),S.effects){const E=hc(S.effects);if(E.length){const A=document.createElement("ul");E.forEach(L=>{const F=document.createElement("li");F.textContent=L,A.appendChild(F)}),v.appendChild(A)}}v.appendChild(Bt("Resources",Hr(S.resources))),g.appendChild(v)}),n.appendChild(g)}const a=((p=t.resourceStatus)==null?void 0:p.missing)||[];if(a.length){const g=Object.fromEntries(a.map(v=>[v.name,Math.max(0,(v.required||0)-(v.available||0))])),b=Bt("Core Shortfall",Hr(g));n.appendChild(b);const S=a.map(v=>rs(v.name,(v.required||0)-(v.available||0))).filter(Boolean);if(S.length){const v=document.createElement("p");v.textContent=`Core structure requires ${bn(S)}.`,n.appendChild(v)}}const d=((h=t.craftedStatus)==null?void 0:h.missing)||[];if(d.length){const g=Object.fromEntries(d.map(v=>[v.name,Math.max(0,(v.required||0)-(v.available||0))])),b=Bt("Later Crafted Needs",Hr(g));n.appendChild(b);const S=d.map(v=>rs(v.name,(v.required||0)-(v.available||0))).filter(Boolean);if(S.length){const v=document.createElement("p");v.style.fontStyle="italic",v.textContent=`Later phases will also need ${bn(S)}.`,n.appendChild(v)}}const l=document.createElement("button");if(l.textContent=`Build ${e.name}`,l.disabled=!t.hasResources,!t.hasResources){const g=a.map(b=>rs(b.name,(b.required||0)-(b.available||0))).filter(Boolean);l.title=g.length?`Core structure requires ${bn(g)}.`:"Gather more resources to begin construction."}return l.addEventListener("click",()=>{try{const g=Jt(),b=g?Zt(g.id):Zt(),{order:S}=km(e.id,{workers:e.stats.minBuilders,locationId:g==null?void 0:g.id,x:b==null?void 0:b.x,y:b==null?void 0:b.y});qh(S),Nn(`Construction started on the ${e.name}.`),Js(),gi()}catch(g){console.warn(g),alert(g.message)}}),n.appendChild(l),n}function Jd(){if(pn)return;pn=document.createElement("div"),pn.id="construction-dashboard",Object.assign(pn.style,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0, 0, 0, 0.5)",display:"none",alignItems:"flex-start",justifyContent:"center",overflowY:"auto",padding:"40px 16px",zIndex:"2000"}),pn.addEventListener("click",l=>{l.target===pn&&bo()}),Vn=document.createElement("div"),Object.assign(Vn.style,{background:"var(--menu-bg)",color:"var(--text-color)",borderRadius:"8px",boxShadow:"0 6px 20px rgba(0, 0, 0, 0.3)",maxWidth:"960px",width:"100%",padding:"24px",boxSizing:"border-box"});const e=document.createElement("div");e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center";const t=document.createElement("h3");t.textContent="Construction Planner",e.appendChild(t);const n=document.createElement("button");n.type="button",n.textContent="Close",n.addEventListener("click",()=>{bo()}),e.appendChild(n),Vn.appendChild(e);const r=document.createElement("p");r.textContent="Plan, upgrade, and review settlement structures. Projects consume materials over time and unlock more sophisticated buildings as the village advances.",Vn.appendChild(r);const o=document.createElement("section");o.id="build-menu",Pn=document.createElement("div"),Pn.id="build-category-filters",Pn.style.display="flex",Pn.style.flexWrap="wrap",Pn.style.gap="8px",Pn.style.margin="12px 0",o.appendChild(Pn),jn=document.createElement("div"),jn.id="build-options",jn.style.display="grid",jn.style.gridTemplateColumns="repeat(auto-fit, minmax(260px, 1fr))",jn.style.gap="12px",o.appendChild(jn);const i=document.createElement("h4");i.textContent="Active Projects",o.appendChild(i),Pr=document.createElement("div"),Pr.id="build-projects",o.appendChild(Pr);const a=document.createElement("h4");a.textContent="Completed Structures",o.appendChild(a),jr=document.createElement("div"),jr.id="completed-buildings",o.appendChild(jr);const d=document.createElement("h4");d.textContent="Locked or Unavailable",o.appendChild(d),_r=document.createElement("div"),_r.id="locked-buildings",o.appendChild(_r),Vn.appendChild(o),pn.appendChild(Vn),document.body.appendChild(pn),bo=()=>{pn&&(pn.style.display="none")},$d=()=>{Jd(),el(),pn&&(pn.style.display="flex",Vn==null||Vn.scrollTo({top:0}))},bo()}function bb(e){if(!Pn)return;const t=new Set;e.forEach(r=>{var i;const o=(i=r.type)==null?void 0:i.category;o&&t.add(o)});const n=["All",...Array.from(t).sort((r,o)=>r.localeCompare(o))];n.some(r=>r.toLowerCase()===go)||(go="all"),Pn.innerHTML="",n.forEach(r=>{const o=r.toLowerCase(),i=document.createElement("button");i.type="button",i.textContent=r,i.style.padding="4px 12px",i.style.borderRadius="999px",i.style.border="1px solid var(--map-border)",i.style.background="rgba(0, 0, 0, 0.04)",i.style.color="inherit",i.style.cursor="pointer",i.style.fontWeight="600",o===go&&(i.disabled=!0,i.style.background="var(--accent-color, #3b82f6)",i.style.color="#fff",i.style.cursor="default"),i.addEventListener("click",()=>{go=o,el()}),Pn.appendChild(i)})}function el(){const e=rr({statuses:["under-construction"]});if(!jn||!Pr||!jr||!_r)return;const t=vm().map(c=>({type:c,info:od(c.id)})).filter(c=>c.info);bb(t);const n=typeof go=="string"?go:"all",r=c=>{var u;return n==="all"?!0:(((u=c.type)==null?void 0:u.category)||"").toLowerCase()===n};jn.innerHTML="";const o=t.filter(c=>c.info.unlocked&&c.info.locationOk&&c.info.canBuildMore),i=o.filter(r);if(i.length)i.forEach(c=>{const f=gb(c.type,c.info);jn.appendChild(f)});else{const c=document.createElement("p");o.length&&n!=="all"?c.textContent="No structures in this category are ready to build yet.":c.textContent="No structures are currently available to build.",jn.appendChild(c)}if(Pr.innerHTML="",e.length){const c=document.createElement("ul");e.forEach(f=>{const u=ln(f.typeId),p=document.createElement("li"),h=f.totalLaborHours?Math.round(f.progressHours/f.totalLaborHours*100):0,g=Math.round(f.progressHours*10)/10,b=Math.round(f.totalLaborHours*10)/10,S=f.tile,v=S&&Number.isFinite(S.x)&&Number.isFinite(S.y)?` @ (${Math.trunc(S.x)}, ${Math.trunc(S.y)})`:"";p.textContent=`${u!=null&&u.icon?`${u.icon} `:""}${(u==null?void 0:u.name)||f.typeId}${v} – ${h}% complete (${g}/${b} worker-hours, ${f.assignedWorkers} builders)`,c.appendChild(p)}),Pr.appendChild(c)}else{const c=document.createElement("p");c.textContent="No projects are currently underway.",Pr.appendChild(c)}jr.innerHTML="";const a=rr({statuses:["completed"]});if(a.length){const c=document.createElement("ul");a.forEach(f=>{const u=ln(f.typeId),p=document.createElement("li"),h=(u==null?void 0:u.name)||f.typeId,g=f.tile,b=g&&Number.isFinite(g.x)&&Number.isFinite(g.y)?` @ (${Math.trunc(g.x)}, ${Math.trunc(g.y)})`:"";p.textContent=`${u!=null&&u.icon?`${u.icon} `:""}${h}${b}`,c.appendChild(p)}),jr.appendChild(c)}else{const c=document.createElement("p");c.textContent="No completed structures yet.",jr.appendChild(c)}_r.innerHTML="";const d=t.filter(c=>!c.info.unlocked||!c.info.locationOk||!c.info.canBuildMore),l=d.filter(r);if(l.length){const c=document.createElement("ul");l.forEach(({type:f,info:u})=>{var b,S,v,k,E,A,L,F,O,H,_,$;const p=document.createElement("li"),h=`${f.icon?`${f.icon} `:""}${f.name}`,g=[];if(!u.unlocked){const s=(b=u.unlockStatus)==null?void 0:b.missing;if(s){if((S=s.technologies)!=null&&S.length&&g.push(`Research ${Lo(s.technologies)}`),(v=s.anyTechnology)!=null&&v.length&&g.push(`Research one of ${Lo(s.anyTechnology)}`),(k=s.research)!=null&&k.length&&g.push(`Complete research: ${An(s.research.map(R=>ft(R)))}`),(E=s.anyResearch)!=null&&E.length&&g.push(`Complete one of: ${An(s.anyResearch.map(R=>ft(R)))}`),(A=s.buildings)!=null&&A.length&&s.buildings.forEach(R=>{var me;const W=Ea({id:R.id,count:R.required}),K=W?((me=ln(W.id))==null?void 0:me.name)||ft(W.id):ft(R.id),ne=W?W.count:R.required||1,ye=Number.isFinite(R.current)?R.current:0;g.push(`Construct ${ne>1?`${ne}× ${K}`:K} (${ye}/${ne})`)}),(L=s.anyBuilding)!=null&&L.length){const R=s.anyBuilding.map(W=>{var Oe;const K=Ea(W);if(!K)return null;const ne=((Oe=ln(K.id))==null?void 0:Oe.name)||ft(K.id),ye=K.count,me=Number.isFinite(W.current)?W.current:0;return`${ye>1?`${ye}× ${ne}`:ne} (${me}/${ye})`}).filter(Boolean);R.length&&g.push(`Construct one of: ${R.join(" or ")}`)}(F=s.resources)!=null&&F.length&&s.resources.forEach(R=>{const W=za(R.name)||ft(R.name),K=Number.isFinite(R.required)?R.required:0,ne=Number.isFinite(R.available)?R.available:0;g.push(`Stockpile ${W} (${ne}/${K})`)}),s.custom&&g.push("Fulfil special conditions")}g.length||g.push("Prerequisites not yet met")}if(u.unlocked&&!u.terrainOk){const s=((H=(O=f.requirements)==null?void 0:O.locationTags)==null?void 0:H.join(", "))||"suitable terrain";g.push(`Requires terrain with: ${s}`)}if(u.unlocked&&u.terrainOk&&!u.siteOk){const s=(_=f.stats)==null?void 0:_.site;if(s!=null&&s.surfaceArea){const R=(($=u.siteStatus)==null?void 0:$.selected)||null,W=R&&Number.isFinite(R.remaining)?Math.max(0,R.remaining):null;let K=`Needs ${li(s.surfaceArea)} of ${Gs((R==null?void 0:R.category)||s.primaryCategory).toLowerCase()} space`;W!==null&&(K+=` (only ${li(W)} free)`),g.push(K)}else g.push("Insufficient buildable surface area")}u.unlocked&&!u.canBuildMore&&g.push("Maximum built for now"),p.textContent=`${h} – ${g.join("; ")}`,c.appendChild(p)}),_r.appendChild(c)}else{const c=document.createElement("p");d.length&&n!=="all"?c.textContent="Nothing in this category is ready—check prerequisites or staffing.":c.textContent="All known structures are available.",_r.appendChild(c)}}function Qd(e=""){return e.charAt(0).toUpperCase()+e.slice(1)}function yb(){var i;const e=Jt();if(!(e!=null&&e.map))return;const t=cn();if(ra&&ra===t.season)return;const n=e.map,r=e.worldSettings||n.worldSettings,o=Cr(e.biome,n.seed,n.xStart,n.yStart,n.tiles[0].length,n.tiles.length,t.season,n.waterLevel,n.viewport,r,!1);e.map={...n,...o},!e.worldSettings&&((i=e.map)!=null&&i.worldSettings)&&(e.worldSettings=e.map.worldSettings),ra=t.season,Ks()}function wb(){const e=_d();if(!e)return;const t=Zn||e;t.replaceChildren();const n=cn(),r=qc(n.season),o=ap(n.weather),i=sp(n.hour),a=n.monthName||Is(n.month),d=Number.isFinite(n.day)?Math.max(1,Math.floor(n.day)):1,l=Number.isFinite(n.year)?Math.floor(n.year):0,c=or(n.hour,{separator:""}),f=or(n.hour),u=a||"Unknown Month",p=[c,d,u,l].filter(g=>g!=null&&`${g}`.trim()!=="").join(" ");[{icon:i.icon,text:p,title:`${i.label} at ${f} on ${d} ${u}, Year ${l}`,showText:!0},{icon:r.icon,text:r.name,title:`${r.name} season`,showText:!1},{icon:o.icon,text:o.name,title:`Weather: ${o.name}`,showText:!1}].forEach(g=>{const b=document.createElement("span");b.className="time-chip",g.title&&(b.title=g.title),(g.title||g.text)&&b.setAttribute("aria-label",g.title||g.text);const S=document.createElement("span");if(S.textContent=g.icon,b.appendChild(S),g.showText!==!1&&g.text!==void 0&&g.text!==null&&g.text!==""){const k=document.createElement("span");k.textContent=g.text,b.appendChild(k)}t.appendChild(b)})}function gi(){yb(),wb(),Ks(),aa(),ia(),qg(),el(),Js(),Zs()}function xb(){vo&&vo.closeDialog(),_s()}function vb(){Vg(),ks(),Wd().openDialog(),_s()}function Sb(){Cs(),Ud().openDialog()}function kb(){var u,p,h,g,b,S;const e=ob();if(!On)return;On.innerHTML="";const t=document.createElement("p");t.textContent="Key facts about your settlement and its surroundings.",On.appendChild(t);const n=document.createElement("dl");Object.assign(n.style,{display:"grid",gridTemplateColumns:"max-content 1fr",columnGap:"12px",rowGap:"6px",margin:"0"});const r=(v,k)=>{if(k==null||k==="")return;const E=document.createElement("dt");E.textContent=v,E.style.fontWeight="600",E.style.margin="0";const A=document.createElement("dd");A.textContent=k,A.style.margin="0",n.appendChild(E),n.appendChild(A)},o=Bo()[0],i=o!=null&&o.biome?((u=Mr(o.biome))==null?void 0:u.name)||o.biome:"Uncharted Region";if(r("Biome",i),o!=null&&o.map){const v=((h=(p=o.map.tiles)==null?void 0:p[0])==null?void 0:h.length)||0,k=((g=o.map.tiles)==null?void 0:g.length)||0;v&&k&&r("Survey Window",`${v} × ${k} tiles`),o.map.seed&&r("Map Seed",o.map.seed);const E=o.map.xStart??0,A=o.map.yStart??0;r("Survey Origin",`${E}, ${A}`)}const a=cn();r("Season",`${a.season} (Day ${a.day})`),r("Local Time",or(a.hour)),r("Difficulty",Qd(C.difficulty||"normal"));const d=((b=C.people)==null?void 0:b.size)??0;r("Population",`${d} settlers`);const l=rr({statuses:["completed"]}).length,c=rr({statuses:["under-construction"]}).length;r("Completed Structures",l),r("Projects Underway",c),On.appendChild(n);const f=Hu();if(f.length){const v=document.createElement("h4");v.textContent="Proficiencies",v.style.marginTop="16px",v.style.marginBottom="8px",On.appendChild(v);const k=document.createElement("ul");k.style.margin="0",k.style.paddingLeft="20px",f.forEach(E=>{const A=document.createElement("li"),L=Math.round((E.level||0)*10)/10;A.textContent=`${E.name}: ${L}/100`,k.appendChild(A)}),On.appendChild(k)}if((S=o==null?void 0:o.features)!=null&&S.length){const v=document.createElement("h4");v.textContent="Notable Features",v.style.marginBottom="8px",v.style.marginTop="16px",On.appendChild(v);const k=document.createElement("ul");k.style.margin="0",k.style.paddingLeft="20px",o.features.forEach(E=>{const A=document.createElement("li");A.textContent=E,k.appendChild(A)}),On.appendChild(k)}else{const v=document.createElement("p");v.textContent="No notable features have been catalogued yet.",v.style.marginTop="16px",On.appendChild(v)}e.openDialog()}function Cb(){ab(),Yd().openDialog()}function Mb(){sb(),Gd().openDialog()}function eu(){const e=ib();Zs(),e.openDialog()}function tu(){var r,o,i,a,d;Gc();const e=document.getElementById("game");if(!e)return;document.getElementById("content"),e.innerHTML="",Object.assign(e.style,{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(300px, 1fr))",gap:"16px",alignItems:"flex-start"}),_d(),qd();const t=Jt(),n=t?Zt(t.id):Zt();if((r=t==null?void 0:t.map)!=null&&r.tiles){if(t.map.season!==C.time.season){const c=t.worldSettings||((o=t.map)==null?void 0:o.worldSettings),f=Cr(t.biome,t.map.seed,t.map.xStart,t.map.yStart,t.map.tiles[0].length,t.map.tiles.length,C.time.season,t.map.waterLevel,t.map.viewport,c,!1);t.map={...t.map,...f},!t.worldSettings&&((i=t.map)!=null&&i.worldSettings)&&(t.worldSettings=t.map.worldSettings)}const l=document.createElement("section");l.id="map-section",Object.assign(l.style,{display:"flex",flexDirection:"column",gap:"12px",gridColumn:"1 / -1",minWidth:"0"}),e.appendChild(l),nt=cd(l,{legendLabels:Bd,showControls:!0,showLegend:!0,idPrefix:"game-map",navMode:"player",onNavigate:rb,jobSelector:{label:"Role",emptyMessage:"No jobs are available yet.",defaultDescription:"Open the Jobs panel to adjust staffing and work schedules.",onSelect:eb},fetchMap:({xStart:c,yStart:f,width:u,height:p,seed:h,season:g,viewport:b,skipSanityChecks:S})=>{var A,L,F;const v=h??((A=t.map)==null?void 0:A.seed)??Date.now(),k=g??C.time.season,E=t.worldSettings||((L=t.map)==null?void 0:L.worldSettings);return Cr(t.biome,v,c,f,u,p,k,(F=t.map)==null?void 0:F.waterLevel,b,E,!!S)},onMapUpdate:c=>{t.map={...t.map,...c},Ca(),aa(),ia(),Dd()}}),nt.setMap(t.map,{biomeId:t.biome,seed:(a=t.map)==null?void 0:a.seed,season:(d=t.map)==null?void 0:d.season,focus:{x:n.x,y:n.y}}),Vs(),yo=l,Ss(yo),Ca(),aa(),ia(),oi({recenter:!0}),ra=C.time.season,Ks()}else yo=e,Ss(yo),aa(),ia();Hd(e),_g(e),Jd(),bo(),e.style.display="grid",Qs(),Js(),gi(),nt&&typeof nt.refresh=="function"&&nt.refresh()}function nu(){document.body.classList.remove("landing-active");const e=document.getElementById("landing-theme");e&&e.parentElement&&e.parentElement.removeChild(e)}function Eb(e={}){var g;const t=e.difficulty||"normal",n=Eo[t]||Eo.normal,r=n.start,o=e.world||n.world;C.jobs={gather:0,hunt:0,craft:0,build:0,guard:0},C.technologies=new Map,Jr(),Ju(r.people,{seed:e.seed});const i=Of(r);if(Object.entries(i).forEach(([b,S])=>sa(b,S)),C.time.day=1,C.time.month=1,C.time.year=np(),C.time.weather="Clear",e.season){C.time.season=e.season;const b=qc(e.season);(g=b.months)!=null&&g.length&&(C.time.month=b.months[0])}else C.time.season=Hs(C.time.month);Yc(),e.biome?vl("loc1",e.biome,C.time.season,e.seed,o):C.locations.size===0&&vl("loc1","temperate-deciduous",C.time.season,e.seed,o);const a=e.spawn||{},d=Number.isFinite(a.x)?Math.trunc(a.x):0,l=Number.isFinite(a.y)?Math.trunc(a.y):0;C.player={locationId:"loc1",x:d,y:l,jobId:"survey"},Tc({id:"basic-tools",name:"Basic Tools"}),Ia(),C.difficulty=t,C.worldSettings=o,C.craftTargets=new Map,C.buildQueue=0,C.haulQueue=0,Wh(),C.eventLog=[];const c=[...C.locations.values()][0],f=sf(1,(c==null?void 0:c.biome)||"temperate-deciduous");sa("wood",f),Er();const u=document.getElementById("setup");u&&(u.style.display="none");const p=document.querySelector(".create-steps"),h=document.getElementById("create-step-content");p instanceof HTMLElement&&(p.style.display="none"),h instanceof HTMLElement&&(h.style.display="none"),nu(),tu()}function gc(){if(Nh(vb,xb,()=>{Ru(),window.location.reload()},Xg,pb,kb,eu,Sb,Cb,Mb),document.getElementById("content"),Lh(),!Bu())vh(Eb);else{const e=document.getElementById("setup");e&&(e.style.display="none");const t=document.querySelector(".create-steps"),n=document.getElementById("create-step-content");t instanceof HTMLElement&&(t.style.display="none"),n instanceof HTMLElement&&(n.style.display="none"),nu(),tu()}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",gc):gc();window.Game={store:C,saveGame:Er};
